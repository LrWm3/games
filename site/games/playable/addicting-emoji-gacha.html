<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Emoji Saga: 151 Emojis</title>
    
    <meta name="game-description" content="Emoji Saga. 151 unique emojis to collect on an epic journey.">
    <meta name="game-tags" content="gacha, rpg, emoji, card-game, strategy, auto-battle, ascension, collection">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        
        :root {
            --trash: #78350f;
            --common: #64748b;
            --rare: #3b82f6;
            --epic: #a855f7;
            --legendary: #f59e0b;
            --divine: #ef4444;
            --eternal-start: #ff0000;
            --fire: #ef4444;
            --water: #3b82f6;
            --nature: #22c55e;
            --light: #fde047;
            --dark: #a855f7;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background: #020617;
            color: white;
            overflow-x: hidden;
            user-select: none;
            touch-action: manipulation;
        }

        /* --- RARITY CARD STYLES --- */
        .card-base { transition: all 0.2s ease; position: relative; overflow: hidden; border-width: 2px; }
        .rarity-card-trash { background: linear-gradient(135deg, #2d1a12, #1a0f0a); border-color: #442b1d; color: #78716c; }
        .rarity-card-common { background: linear-gradient(135deg, #1e293b, #0f172a); border-color: #475569; }
        .rarity-card-uncommon { background: linear-gradient(135deg, #0f3d3a, #0a2827); border-color: #14b8a6; box-shadow: inset 0 0 10px rgba(20, 184, 166, 0.3); }
        .rarity-card-rare { background: linear-gradient(135deg, #172554, #1e3a8a); border-color: #3b82f6; box-shadow: inset 0 0 10px rgba(59, 130, 246, 0.3); }
        .rarity-card-epic { background: linear-gradient(135deg, #4c1d95, #581c87); border-color: #a855f7; box-shadow: 0 0 15px rgba(168, 85, 247, 0.2); }
        .rarity-card-legendary { background: linear-gradient(135deg, #78350f, #451a03); border-color: #f59e0b; box-shadow: 0 0 20px rgba(245, 158, 11, 0.4); }
        .rarity-card-false_divine { background: linear-gradient(135deg, #3f2f0a, #2b1c06); border-color: #f59e0b; box-shadow: inset 0 0 12px rgba(245, 158, 11, 0.35); }
        
        @keyframes divine-pulse { 0%, 100% { box-shadow: 0 0 10px #ef4444; } 50% { box-shadow: 0 0 25px #ef4444; } }
        .rarity-card-divine { background: linear-gradient(135deg, #7f1d1d, #450a0a); border-color: #ef4444; animation: divine-pulse 2s infinite; }

        @keyframes eternal-bg { 0% { border-color: #ff0000; box-shadow: 0 0 20px #ff0000; } 33% { border-color: #00ff00; box-shadow: 0 0 20px #00ff00; } 66% { border-color: #0000ff; box-shadow: 0 0 20px #0000ff; } 100% { border-color: #ff0000; box-shadow: 0 0 20px #ff0000; } }
        .rarity-card-eternal { background: linear-gradient(45deg, #0f172a, #334155); border-width: 3px; animation: eternal-bg 4s linear infinite; }

        .tab-active { background: #4f46e5 !important; color: white !important; box-shadow: 0 0 15px rgba(79, 70, 229, 0.4); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .card-reveal { animation: card-reveal 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes card-reveal { 0% { transform: scale(0.5) rotateY(90deg); opacity: 0; } 100% { transform: scale(1) rotateY(0); opacity: 1; } }

        .element-fire { color: var(--fire); }
        .element-water { color: var(--water); }
        .element-nature { color: var(--nature); }
        .element-light { color: var(--light); }
        .element-dark { color: var(--dark); }
        
        .type-badge { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; padding: 2px 8px; border-radius: 999px; background: rgba(0,0,0,0.3); border: 1px border-white/10; }
        .tutorial-highlight { position: relative; z-index: 6; box-shadow: 0 0 0 3px rgba(255,255,255,0.85), 0 0 22px rgba(59,130,246,0.8); border-color: rgba(59,130,246,0.9) !important; }
        #view-summon.tutorial-dim { position: relative; }
        #view-summon.tutorial-dim::after { content: ''; position: absolute; inset: 0; background: rgba(2,6,23,0.72); border-radius: 24px; pointer-events: none; }
        #view-summon.tutorial-dim > * { position: relative; }
        #view-summon.tutorial-dim #btn-single-summon { position: relative; z-index: 5; }
        .starter-wiggle { animation: starter-wiggle 0.6s ease-in-out; }
        @keyframes starter-wiggle {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(-2px, -1px) rotate(-2deg); }
            50% { transform: translate(2px, 1px) rotate(2deg); }
            75% { transform: translate(-1px, 2px) rotate(-1deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        .move-card { border-radius: 18px; border: 1px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.35); padding: 10px 12px; }
        .move-chip { font-size: 0.8rem; letter-spacing: 0.18em; text-transform: uppercase; padding: 2px 6px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.35); }
        .move-card.rare { border-color: rgba(59,130,246,0.5); box-shadow: 0 0 0 1px rgba(59,130,246,0.15) inset; }
        .move-card.epic { border-color: rgba(16,185,129,0.5); box-shadow: 0 0 0 1px rgba(16,185,129,0.15) inset; }
        .move-card.legendary { border-color: rgba(245,158,11,0.55); box-shadow: 0 0 0 1px rgba(245,158,11,0.18) inset; }
        .move-card.divine { border-color: rgba(56,189,248,0.6); box-shadow: 0 0 0 1px rgba(56,189,248,0.2) inset; }
        .move-card.eternal { border-color: rgba(255,255,255,0.7); box-shadow: 0 0 0 1px rgba(255,255,255,0.25) inset; }
        .move-card.fire { background: linear-gradient(120deg, rgba(244,63,94,0.15), rgba(0,0,0,0.45)); }
        .move-card.water { background: linear-gradient(120deg, rgba(56,189,248,0.15), rgba(0,0,0,0.45)); }
        .move-card.nature { background: linear-gradient(120deg, rgba(34,197,94,0.15), rgba(0,0,0,0.45)); }
        .move-card.light { background: linear-gradient(120deg, rgba(250,204,21,0.12), rgba(0,0,0,0.45)); }
        .move-card.dark { background: linear-gradient(120deg, rgba(148,163,184,0.15), rgba(0,0,0,0.5)); }
        .move-card.physical { border-left: 3px solid rgba(239,68,68,0.7); }
        .move-card.special { border-left: 3px solid rgba(59,130,246,0.7); }
        .move-card.status { border-left: 3px solid rgba(148,163,184,0.7); }
        .text-\[7px\], .text-\[8px\], .text-\[9px\], .text-\[10px\], .text-\[11px\], .text-\[12px\], .text-\[13px\], .text-xs { font-size: 14px !important; }
        .text-sm { font-size: 16px !important; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-slate-900/95 backdrop-blur-md border-b border-white/10 p-2 sm:p-3 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto flex flex-wrap justify-between items-center gap-2">
            <div class="flex items-center gap-2 min-w-0">
                <span class="text-2xl">ğŸŒ</span>
                <div class="leading-none">
                    <h1 class="text-lg font-bold uppercase tracking-tight">Emoji Saga</h1>
                    <div class="text-[8px] text-slate-400 font-black uppercase tracking-[0.2em] mt-1">
                        <span id="player-name">Traveler</span> â€¢ <span id="player-region">No Region</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center flex-wrap gap-2">
                <div class="flex flex-wrap gap-2">
                <div class="bg-black/40 px-2.5 py-1.5 rounded-full border border-yellow-500/30 flex items-center gap-2 text-xs">
                    <i class="fas fa-coins text-yellow-500"></i>
                    <span id="stat-gold" class="font-bold">0</span>
                </div>
                <div class="bg-black/40 px-2.5 py-1.5 rounded-full border border-indigo-500/30 flex items-center gap-2 text-xs">
                    <i class="fas fa-ticket text-indigo-400"></i>
                    <span id="stat-tickets" class="font-bold">0</span>
                </div>
                <div id="header-rare-tickets" class="bg-black/40 px-2.5 py-1.5 rounded-full border border-blue-400/30 flex items-center gap-2 text-xs">
                    <i class="fas fa-ticket text-blue-300"></i>
                    <span id="stat-rare-tickets" class="font-bold">0</span>
                </div>
                <div id="header-legendary-tickets" class="bg-black/40 px-2.5 py-1.5 rounded-full border border-amber-400/30 flex items-center gap-2 text-xs">
                    <i class="fas fa-ticket text-amber-300"></i>
                    <span id="stat-legendary-tickets" class="font-bold">0</span>
                </div>
                </div>
                <button onclick="openDataDialog()" class="px-3 py-1.5 rounded-full bg-slate-800 border border-white/10 text-[9px] font-black uppercase tracking-[0.2em] text-slate-300 hover:bg-slate-700">Data</button>
            </div>
        </div>
    </header>

    <nav class="bg-slate-900 border-b border-white/5 p-2 flex flex-wrap justify-center gap-2 sticky top-[56px] sm:top-[61px] z-40">
        <button onclick="switchTab('summon')" id="btn-tab-summon" class="flex-1 min-w-[120px] max-w-[160px] px-4 py-2 rounded-xl text-[10px] font-bold uppercase bg-slate-800 text-slate-400">Portal</button>
        <button onclick="switchTab('team')" id="btn-tab-team" class="flex-1 min-w-[120px] max-w-[160px] px-4 py-2 rounded-xl text-[10px] font-bold uppercase bg-slate-800 text-slate-400">Squad</button>
        <button onclick="switchTab('arena')" id="btn-tab-arena" class="flex-1 min-w-[120px] max-w-[160px] px-4 py-2 rounded-xl text-[10px] font-bold uppercase bg-slate-800 text-slate-400">Arena</button>
        <button onclick="switchTab('adventure')" id="btn-tab-adventure" class="flex-1 min-w-[120px] max-w-[160px] px-4 py-2 rounded-xl text-[10px] font-bold uppercase bg-slate-800 text-slate-400">Adventure</button>
        <button onclick="switchTab('shop')" id="btn-tab-shop" class="flex-1 min-w-[120px] max-w-[160px] px-4 py-2 rounded-xl text-[10px] font-bold uppercase bg-slate-800 text-slate-400">Market</button>
        <button onclick="switchTab('emojidex')" id="btn-tab-emojidex" class="flex-1 min-w-[120px] max-w-[160px] px-4 py-2 rounded-xl text-[10px] font-bold uppercase bg-slate-800 text-slate-400">Emojidex</button>
        <button onclick="switchTab('tutor')" id="btn-tab-tutor" class="flex-1 min-w-[120px] max-w-[160px] px-4 py-2 rounded-xl text-[10px] font-bold uppercase bg-slate-800 text-slate-400">Move Tutor</button>
    </nav>
    <div id="arena-info-bar" class="hidden bg-slate-900/90 border-b border-white/5 text-center text-[9px] font-black uppercase tracking-[0.3em] text-red-300 py-2">
        Arena Live â€¢ Stage <span id="arena-info-stage" class="text-white">1</span>
    </div>

    <main class="flex-grow container mx-auto max-w-5xl p-4 mb-20">
        
        <!-- Portal -->
        <section id="view-summon" class="tab-content py-4 text-center">
            <div class="relative max-w-xs mx-auto aspect-square flex flex-col items-center justify-center mb-10 overflow-hidden rounded-full border border-white/5 shadow-2xl">
                <div class="absolute inset-0 bg-gradient-to-b from-indigo-500/10 to-transparent"></div>
                <div class="text-[100px] opacity-10 absolute animate-pulse">ğŸ‘‘</div>
                <div class="relative z-10">
                    <h2 class="text-2xl font-black mb-1 italic">THE WORLD GATE</h2>
                    <p class="text-[9px] text-indigo-400 font-bold mb-4 tracking-[0.4em]">DISCOVER 152 HEROES</p>
                </div>
            </div>
            <div class="flex flex-col gap-4 max-w-xs mx-auto">
                <div class="text-[9px] font-black uppercase tracking-[0.35em] text-slate-400">Standard Tickets</div>
                <button id="btn-single-summon" onclick="startSummonSequence(1, 'standard')" class="bg-white text-black py-4 rounded-2xl font-black text-xs hover:scale-105 active:scale-95 transition-all">SINGLE SUMMON</button>
                <button onclick="startSummonSequence(10, 'standard')" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-2xl font-black text-xs shadow-xl active:scale-95 border-b-4 border-indigo-900 transition-all">MULTI SUMMON (10x)</button>
                <div id="rare-summon-block" class="space-y-4">
                    <div class="text-[9px] font-black uppercase tracking-[0.35em] text-blue-300 mt-2">Rare Tickets</div>
                    <button onclick="startSummonSequence(1, 'rare')" class="w-full bg-blue-500 text-white py-4 rounded-2xl font-black text-xs shadow-xl active:scale-95 border-b-4 border-blue-900 transition-all">RARE SUMMON</button>
                    <button onclick="startSummonSequence(10, 'rare')" class="w-full bg-gradient-to-r from-sky-500 to-blue-600 text-white py-4 rounded-2xl font-black text-xs shadow-xl active:scale-95 border-b-4 border-blue-900 transition-all">RARE MULTI (10x)</button>
                </div>
                <div id="legendary-summon-block">
                    <div class="text-[9px] font-black uppercase tracking-[0.35em] text-amber-300 mt-2">Legendary Tickets</div>
                    <button onclick="startSummonSequence(1, 'legendary')" class="w-full bg-amber-400 text-black py-4 rounded-2xl font-black text-xs hover:scale-105 active:scale-95 transition-all">LEGEND SUMMON</button>
                    <button onclick="startSummonSequence(10, 'legendary')" class="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white py-4 rounded-2xl font-black text-xs shadow-xl active:scale-95 border-b-4 border-amber-900 transition-all">LEGEND MULTI (10x)</button>
                </div>
            </div>
        </section>

        <!-- Squad -->
        <section id="view-team" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 space-y-4">
                    <div id="team-slots" class="grid grid-cols-3 gap-3 h-28"></div>
                    <div class="flex flex-col gap-2">
                        <button id="btn-add-team" onclick="toggleSelectedTeam()" class="w-full bg-indigo-600 hover:bg-indigo-700 py-3.5 rounded-2xl font-black text-xs transition-all disabled:opacity-20">DEPLOY</button>
                        <button id="btn-lvl-up" onclick="levelUpSelected()" class="w-full bg-green-600 hover:bg-green-700 py-3.5 rounded-2xl font-black text-xs transition-all disabled:opacity-20">UPGRADE</button>
                        <button id="btn-promote" onclick="promoteSelected()" class="w-full bg-amber-500 hover:bg-amber-600 py-3.5 rounded-2xl font-black text-xs hidden transition-all">ASCEND</button>
                    </div>
                    <div class="flex justify-between items-center border-b border-white/10 pb-2">
                        <h3 class="text-xs font-black uppercase tracking-widest">Collection</h3>
                        <div class="text-[9px] bg-slate-800 px-3 py-1 rounded-full" id="collection-count">0/151</div>
                    </div>
                    <div id="roster-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-2 max-h-[450px] overflow-y-auto custom-scrollbar p-1"></div>
                </div>

                <!-- Inspect Panel -->
                <div id="inspect-panel" class="bg-slate-900 border border-white/10 rounded-[2.5rem] p-5 md:p-6 h-fit md:sticky md:top-40 shadow-2xl">
                    <div id="inspect-content" class="text-left">
                        <div class="flex items-center gap-4 mb-4">
                            <div id="inspect-emoji" class="text-6xl md:text-7xl drop-shadow-2xl">â“</div>
                            <div class="text-left">
                                <h4 id="inspect-name" class="text-lg md:text-xl font-black leading-tight">Hero Name</h4>
                                <div class="flex gap-2 mt-2">
                                     <div id="inspect-type-badge" class="type-badge text-white">TYPE</div>
                                     <div id="inspect-element-badge" class="type-badge">ELEMENT</div>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center justify-between mb-4">
                            <div id="inspect-rarity-badge" class="inline-block px-3 py-1 rounded-full text-[7px] font-black uppercase tracking-[0.2em] border">RARITY</div>
                            <div class="bg-black/40 px-3 py-2 rounded-2xl border border-white/5 text-right">
                                <div class="text-[7px] text-slate-500 uppercase">LV</div>
                                <span class="font-bold text-sm" id="inspect-lvl">0</span>
                            </div>
                        </div>
                        <p id="inspect-desc" class="text-[10px] text-slate-300 leading-relaxed mb-4">A short description.</p>
                        <div id="inspect-dupe-count" class="text-[9px] font-black uppercase tracking-[0.2em] text-slate-500 mb-5">Duplicates: 0</div>
                        <div class="text-[9px] font-black uppercase tracking-[0.2em] text-slate-400 mb-2">Moves</div>
                        <div id="inspect-moves" class="text-[9px] text-slate-300 space-y-2 mb-5"></div>
                        
                        <div class="grid grid-cols-3 gap-2 text-left mb-5">
                            <div class="bg-black/40 p-2.5 rounded-2xl border border-white/5"><p class="text-[7px] text-green-500 uppercase">HP</p><span class="font-bold text-sm" id="inspect-hp">0</span></div>
                            <div class="bg-black/40 p-2.5 rounded-2xl border border-white/5"><p class="text-[7px] text-red-500 uppercase">ATK</p><span class="font-bold text-sm" id="inspect-atk">0</span></div>
                            <div class="bg-black/40 p-2.5 rounded-2xl border border-white/5"><p class="text-[7px] text-blue-500 uppercase">SPD</p><span class="font-bold text-sm" id="inspect-spd">0</span></div>
                            <div class="bg-black/40 p-2.5 rounded-2xl border border-white/5"><p class="text-[7px] text-amber-400 uppercase">DEF</p><span class="font-bold text-sm" id="inspect-def">0</span></div>
                            <div class="bg-black/40 p-2.5 rounded-2xl border border-white/5"><p class="text-[7px] text-pink-400 uppercase">SP. ATK</p><span class="font-bold text-sm" id="inspect-spatk">0</span></div>
                            <div class="bg-black/40 p-2.5 rounded-2xl border border-white/5"><p class="text-[7px] text-cyan-300 uppercase">SP. DEF</p><span class="font-bold text-sm" id="inspect-spdef">0</span></div>
                        </div>

                        <div class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Arena -->
        <section id="view-arena" class="tab-content hidden">
            <div id="arena-lobby" class="text-center py-10">
                <div class="text-[100px] mb-4">ğŸ†</div>
                <h2 class="text-3xl font-black mb-2 uppercase">Infinite Arena</h2>
                <div class="bg-slate-900 border border-indigo-500/30 p-6 rounded-[2rem] max-w-xs mx-auto mb-8 shadow-2xl">
                    <p class="text-[10px] text-indigo-400 font-black uppercase mb-1">Current Stage</p>
                    <p id="arena-stage-title" class="text-6xl font-black italic">1</p>
                </div>
                <button id="btn-arena-start" onclick="toggleAutoBattle()" class="bg-red-600 hover:bg-red-500 text-white px-16 py-5 rounded-3xl font-black text-xl shadow-2xl active:scale-95 transition-all">AUTO BATTLE</button>
            </div>

            <div id="arena-combat" class="hidden max-w-lg mx-auto bg-slate-900/50 p-6 rounded-[2.5rem] border border-white/5 relative">
                <div id="combat-flash-layer" class="absolute inset-0 pointer-events-none rounded-[2.5rem] z-10"></div>
                <div class="flex justify-between items-center mb-6">
                    <span class="text-xs font-black text-red-400 uppercase tracking-widest">Stage <span id="combat-stage-num">1</span></span>
                    <span class="text-xs font-black text-slate-300 uppercase tracking-widest">Round <span id="combat-round-num">1</span></span>
                    <button onclick="stopAutoBattle()" class="text-[9px] font-black text-slate-500 underline uppercase">Abort</button>
                </div>
                <div class="flex flex-wrap items-center gap-2 mb-4">
                    <div class="flex items-center gap-2">
                        <button data-combat-mode="auto" onclick="setCombatMode('auto')" class="px-3 py-1.5 rounded-full bg-slate-800 border border-white/10 text-[9px] font-black uppercase tracking-[0.2em] text-slate-300">Auto</button>
                        <button data-combat-mode="manual" onclick="setCombatMode('manual')" class="px-3 py-1.5 rounded-full bg-slate-800 border border-white/10 text-[9px] font-black uppercase tracking-[0.2em] text-slate-300">Manual</button>
                    </div>
                    <div class="flex items-center gap-2 combat-speed-group">
                        <button data-combat-speed="1" onclick="setCombatSpeed(1)" class="px-3 py-1.5 rounded-full bg-slate-800 border border-white/10 text-[9px] font-black uppercase tracking-[0.2em] text-slate-300">1x</button>
                        <button data-combat-speed="2" onclick="setCombatSpeed(2)" class="px-3 py-1.5 rounded-full bg-slate-800 border border-white/10 text-[9px] font-black uppercase tracking-[0.2em] text-slate-300">2x</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div id="battle-player-team" class="space-y-3"></div>
                    <div id="battle-enemy-team" class="space-y-3"></div>
                </div>
                <div class="manual-move-preview hidden mt-4"></div>
                <div id="battle-log" class="mt-6 bg-black h-44 rounded-2xl p-4 overflow-y-auto custom-scrollbar text-[9px] font-mono border border-white/5"></div>
            </div>
        </section>

        <!-- Adventure -->
        <section id="view-adventure" class="tab-content hidden py-6">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-black uppercase">Adventure</h2>
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-[0.25em]">Regions & Boss Rush</p>
                <p class="text-[10px] text-slate-500 font-black uppercase tracking-[0.2em] mt-2">Gain tickets to summon more emojis by beating new challengers and regions... Or at the market.</p>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-slate-900/60 border border-white/5 rounded-[2rem] p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-black uppercase tracking-widest">Regions</h3>
                        <div class="text-[9px] bg-slate-800 px-3 py-1 rounded-full" id="adventure-progress">0/0 Cleared</div>
                    </div>
                    <div id="adventure-region-list" class="space-y-2 max-h-[440px] overflow-y-auto custom-scrollbar pr-1"></div>
                </div>
                <div class="bg-slate-900/60 border border-white/5 rounded-[2rem] p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-black uppercase tracking-widest">Region Battle</h3>
                        <div class="text-[9px] bg-slate-800 px-3 py-1 rounded-full" id="adventure-region-title">No Region</div>
                    </div>
                    <div id="adventure-lobby" class="text-center py-6">
                        <div class="text-[80px] mb-3">ğŸ§­</div>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-[0.3em]">Select a Region</p>
                    </div>
                    <div id="adventure-combat" class="hidden">
                        <div class="text-[9px] font-black uppercase tracking-[0.2em] text-slate-300 mb-3">
                            Stage <span id="adventure-stage-num">1</span> â€¢ <span id="adventure-stage-type">Skirmish</span> â€¢ Round <span id="adventure-round-num">1</span>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mb-3">
                            <div class="flex items-center gap-2">
                                <button data-combat-mode="auto" onclick="setCombatMode('auto')" class="px-3 py-1.5 rounded-full bg-slate-800 border border-white/10 text-[9px] font-black uppercase tracking-[0.2em] text-slate-300">Auto</button>
                                <button data-combat-mode="manual" onclick="setCombatMode('manual')" class="px-3 py-1.5 rounded-full bg-slate-800 border border-white/10 text-[9px] font-black uppercase tracking-[0.2em] text-slate-300">Manual</button>
                            </div>
                            <div class="flex items-center gap-2 combat-speed-group">
                                <button data-combat-speed="1" onclick="setCombatSpeed(1)" class="px-3 py-1.5 rounded-full bg-slate-800 border border-white/10 text-[9px] font-black uppercase tracking-[0.2em] text-slate-300">1x</button>
                                <button data-combat-speed="2" onclick="setCombatSpeed(2)" class="px-3 py-1.5 rounded-full bg-slate-800 border border-white/10 text-[9px] font-black uppercase tracking-[0.2em] text-slate-300">2x</button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-[9px] text-slate-500 uppercase tracking-[0.2em]" id="adventure-mode-note"></span>
                            <button id="adventure-leave-training" onclick="leaveAdventureTraining()" class="hidden text-[9px] font-black text-slate-400 underline uppercase">Leave Training</button>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div id="adventure-player-team" class="space-y-3"></div>
                            <div id="adventure-enemy-team" class="space-y-3"></div>
                        </div>
                        <div class="manual-move-preview hidden mb-4"></div>
                        <div id="adventure-log" class="mt-4 bg-black h-44 rounded-2xl p-4 overflow-y-auto custom-scrollbar text-[9px] font-mono border border-white/5"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Shop -->
        <section id="view-shop" class="tab-content hidden py-6">
            <div class="text-center mb-10"><h2 class="text-3xl font-black uppercase">Market</h2></div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 max-w-5xl mx-auto">
                <div class="bg-slate-900 p-8 rounded-3xl border border-white/5 text-center flex flex-col items-center">
                    <h3 class="font-black text-lg mb-4 uppercase">1 Ticket</h3>
                    <button onclick="buyTickets('standard', 1, 1000)" class="w-full bg-indigo-600 py-3 rounded-xl font-black text-xs">1,000 GOLD</button>
                </div>
                <div class="bg-slate-900 p-8 rounded-3xl border border-indigo-500/30 text-center flex flex-col items-center">
                    <h3 class="font-black text-lg mb-4 uppercase">10 Tickets</h3>
                    <button onclick="buyTickets('standard', 10, 8500)" class="w-full bg-indigo-600 py-3 rounded-xl font-black text-xs">8,500 GOLD</button>
                </div>
                <div class="bg-slate-900 p-8 rounded-3xl border border-blue-500/30 text-center flex flex-col items-center">
                    <h3 class="font-black text-lg mb-4 uppercase">1 Rare Ticket</h3>
                    <button onclick="buyTickets('rare', 1, 4000)" class="w-full bg-blue-500 py-3 rounded-xl font-black text-xs">4,000 GOLD</button>
                </div>
                <div class="bg-slate-900 p-8 rounded-3xl border border-blue-500/30 text-center flex flex-col items-center">
                    <h3 class="font-black text-lg mb-4 uppercase">10 Rare Tickets</h3>
                    <button onclick="buyTickets('rare', 10, 36000)" class="w-full bg-blue-500 py-3 rounded-xl font-black text-xs">36,000 GOLD</button>
                </div>
                <div class="bg-slate-900 p-8 rounded-3xl border border-amber-500/30 text-center flex flex-col items-center">
                    <h3 class="font-black text-lg mb-4 uppercase">1 Legendary Ticket</h3>
                    <button onclick="buyTickets('legendary', 1, 16000)" class="w-full bg-amber-500 py-3 rounded-xl font-black text-xs">16,000 GOLD</button>
                </div>
                <div class="bg-slate-900 p-8 rounded-3xl border border-amber-500/30 text-center flex flex-col items-center">
                    <h3 class="font-black text-lg mb-4 uppercase">10 Legendary Tickets</h3>
                    <button onclick="buyTickets('legendary', 10, 144000)" class="w-full bg-amber-500 py-3 rounded-xl font-black text-xs">144,000 GOLD</button>
                </div>
            </div>
        </section>

        <!-- Emojidex -->
        <section id="view-emojidex" class="tab-content hidden py-6">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-black uppercase">Emojidex</h2>
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-[0.25em]">Discoveries So Far</p>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-slate-900/60 border border-white/5 rounded-[2rem] p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-black uppercase tracking-widest">Emojis</h3>
                        <div class="text-[9px] bg-slate-800 px-3 py-1 rounded-full" id="emojidex-emoji-count">0/0</div>
                    </div>
                    <div id="emojidex-emoji-grid" class="grid grid-cols-5 sm:grid-cols-6 gap-2 max-h-[420px] overflow-y-auto custom-scrollbar p-1"></div>
                </div>
                <div class="bg-slate-900/60 border border-white/5 rounded-[2rem] p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-black uppercase tracking-widest">Moves</h3>
                        <div class="text-[9px] bg-slate-800 px-3 py-1 rounded-full" id="emojidex-move-count">0/0</div>
                    </div>
                    <div id="emojidex-move-list" class="space-y-2 max-h-[420px] overflow-y-auto custom-scrollbar pr-1"></div>
                </div>
                <div class="bg-slate-900/60 border border-white/5 rounded-[2rem] p-6 lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-black uppercase tracking-widest">Status Effects</h3>
                        <div class="text-[9px] bg-slate-800 px-3 py-1 rounded-full">Arena Rules</div>
                    </div>
                    <div id="emojidex-status-list" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                </div>
                <div class="bg-slate-900/60 border border-white/5 rounded-[2rem] p-6 lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-black uppercase tracking-widest">Element Chart</h3>
                        <div class="text-[9px] bg-slate-800 px-3 py-1 rounded-full">Effectiveness</div>
                    </div>
                    <div id="emojidex-element-chart" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
                </div>
            </div>
        </section>

        <!-- Move Tutor -->
        <section id="view-tutor" class="tab-content hidden py-6">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-black uppercase">Move Tutor</h2>
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-[0.25em]">Teach Moves Through Arena Wins</p>
                <div class="max-w-xl mx-auto mt-4 text-[10px] text-slate-400 text-left leading-relaxed">
                    Emojis can teach each other their natural special moves.<br>Teach a student emoji a new move of the master emoji.
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <div id="tutor-slot-1" class="bg-slate-900/60 border border-white/5 rounded-[2rem] p-5"></div>
                <div id="tutor-slot-2" class="bg-slate-900/60 border border-white/5 rounded-[2rem] p-5"></div>
                <div id="tutor-slot-3" class="bg-slate-900/60 border border-white/5 rounded-[2rem] p-5"></div>
            </div>
        </section>

    </main>

    <!-- Results Dialog -->
    <div id="summon-result-overlay" class="fixed inset-0 z-[100] bg-black/90 hidden">
        <div class="max-w-2xl mx-auto mt-10 bg-slate-900/95 border border-white/10 rounded-[2rem] p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-black uppercase tracking-[0.2em]">Portal Summons</h2>
                <button onclick="closeSummonResults()" class="text-[9px] font-black uppercase text-slate-400 underline">Close</button>
            </div>
            <div id="summon-grid" class="max-h-[60vh] overflow-y-auto px-2 py-2 flex flex-wrap justify-center content-start gap-4 custom-scrollbar"></div>
            <div class="mt-6 flex justify-center">
                <button onclick="closeSummonResults()" id="btn-summon-close" class="hidden bg-white text-black px-10 py-3 rounded-2xl font-black active:scale-95 transition-all">CONTINUE</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 px-6 py-3 bg-white text-black text-[10px] rounded-full font-black shadow-2xl opacity-0 transition-all duration-500 z-[300] uppercase tracking-widest">NOTIFY</div>

    <!-- Tutorial Overlay -->
    <div id="tutorial-overlay" class="fixed inset-0 z-[250] bg-black/95 hidden">
        <div class="max-w-lg mx-auto mt-16 bg-slate-900/95 border border-white/10 rounded-[2rem] p-6 shadow-2xl">
            <div id="tutorial-content"></div>
        </div>
    </div>

    <!-- Data Dialog -->
    <div id="data-dialog" class="fixed inset-0 z-[240] bg-black/90 hidden">
        <div class="max-w-3xl mx-auto mt-12 bg-slate-900/95 border border-white/10 rounded-[2rem] p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-black uppercase tracking-[0.2em]">Data</h3>
                <button onclick="closeDataDialog()" class="text-[9px] font-black uppercase text-slate-400 underline">Close</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6" id="data-slot-grid"></div>
            <div class="flex flex-wrap gap-2 justify-end">
                <button onclick="manualSave()" class="px-4 py-2 rounded-xl bg-slate-800 border border-white/10 text-[9px] font-black uppercase text-slate-300">Save</button>
                <button onclick="newGameCurrentSlot()" class="px-4 py-2 rounded-xl bg-emerald-500 text-black text-[9px] font-black uppercase">New Game</button>
                <button onclick="deleteCurrentSlot()" class="px-4 py-2 rounded-xl bg-red-600 text-white text-[9px] font-black uppercase">Delete</button>
            </div>
        </div>
    </div>


    <script>
        // --- MASTER DATA (151 TOTAL) ---
        const EMOJIS = [
            // TRASH (8)
            { id: 101, char: 'ğŸ©¹', name: 'Bandaid', rarity: 'trash', element: 'dark', defaultMove: 'gloom_slash', type: 'Trash' },
            { id: 102, char: 'ğŸ’©', name: 'Poo', rarity: 'trash', element: 'nature', defaultMove: 'thorns_pulse', type: 'Striker' },
            { id: 103, char: 'ğŸ¦´', name: 'Old Bone', rarity: 'trash', element: 'dark', defaultMove: 'shade_bolt', type: 'Striker' },
            { id: 104, char: 'ğŸšï¸', name: 'Shack', rarity: 'trash', element: 'nature', defaultMove: 'briar_strike', type: 'Tank' },
            { id: 105, char: 'ğŸ‘', name: 'Worn Boot', rarity: 'trash', element: 'water', defaultMove: 'ice_barbs', type: 'Speedster' },
            { id: 106, char: 'ğŸ§¦', name: 'Stray Sock', rarity: 'trash', element: 'light', defaultMove: 'halo_step', type: 'Speedster' },
            { id: 107, char: 'ğŸŒ', name: 'Peel', rarity: 'trash', element: 'nature', defaultMove: 'sap_strike', type: 'Speedster' },
            { id: 108, char: 'ğŸ”‹', name: 'Dead Cell', rarity: 'trash', element: 'light', defaultMove: 'spark_jab', type: 'Striker' },
            // FIRE (25)
            { id: 1, char: 'ğŸ”¥', name: 'Inferno', rarity: 'rare', element: 'fire', defaultMove: 'ember_wave', type: 'Striker' },
            { id: 2, char: 'ğŸŒ‹', name: 'Magma', rarity: 'epic', element: 'fire', defaultMove: 'overheat', type: 'Guardian' },
            { id: 3, char: 'ğŸ‰', name: 'Drake', rarity: 'legendary', element: 'fire', defaultMove: 'magma_quake', type: 'Brawler' },
            { id: 4, char: 'â˜„ï¸', name: 'Comet', rarity: 'uncommon', element: 'fire', defaultMove: 'scorch_mark', type: 'Speedster' },
            { id: 5, char: 'ğŸ¦', name: 'Leonis', rarity: 'epic', element: 'fire', defaultMove: 'smoldering_guard', type: 'Brawler' },
            { id: 61, char: 'ğŸŒ¶ï¸', name: 'Pepper', rarity: 'uncommon', element: 'fire', defaultMove: 'soak_mark', type: 'Speedster' },
            { id: 62, char: 'ğŸ¥“', name: 'Sizzle', rarity: 'common', element: 'fire', defaultMove: 'cinder_jab', type: 'Tank' },
            { id: 64, char: 'ğŸ‘º', name: 'Oni', rarity: 'legendary', element: 'fire', defaultMove: 'phoenix_dive', type: 'Brawler' },
            { id: 109, char: 'ğŸ§¨', name: 'Dynamo', rarity: 'rare', element: 'fire', defaultMove: 'firebrand', type: 'Striker' },
            { id: 110, char: 'ğŸ£', name: 'Spicy Roll', rarity: 'common', element: 'fire', defaultMove: 'rootbind', type: 'Speedster' },
            { id: 146, char: 'ğŸ•', name: 'Slice', rarity: 'rare', element: 'fire', defaultMove: 'ancient_growth', type: 'Striker' },
            { id: 147, char: 'ğŸŒ®', name: 'Crunch', rarity: 'common', element: 'fire', defaultMove: 'spark_flick', type: 'Striker' },
            { id: 148, char: 'ğŸ¸', name: 'Riff', rarity: 'epic', element: 'fire', defaultMove: 'heat_shield', type: 'Brawler' },
            { id: 149, char: 'ğŸš€', name: 'Apex', rarity: 'legendary', element: 'fire', defaultMove: 'solar_flare', type: 'Speedster' },
            { id: 150, char: 'ğŸ”', name: 'Beef', rarity: 'rare', element: 'fire', defaultMove: 'vine_lock', type: 'Tank' },
            { id: 151, char: 'ğŸº', name: 'Froth', rarity: 'common', element: 'fire', defaultMove: 'flare_step', type: 'Tank' },
            { id: 152, char: 'ğŸŒ', name: 'Solaris', rarity: 'legendary', element: 'fire', defaultMove: 'crimson_pact', type: 'Brawler' },
            { id: 153, char: 'ğŸ©', name: 'Glaze', rarity: 'uncommon', element: 'fire', defaultMove: 'blister_tag', type: 'Speedster' },
            // WATER (26)
            { id: 6, char: 'ğŸ’§', name: 'Aqua', rarity: 'uncommon', element: 'water', defaultMove: 'ripple_cut', type: 'Speedster' },
            { id: 7, char: 'ğŸ¦ˆ', name: 'Meg', rarity: 'rare', element: 'water', defaultMove: 'torrent_edge', type: 'Striker' },
            { id: 8, char: 'ğŸ³', name: 'Levi', rarity: 'legendary', element: 'water', defaultMove: 'maelstrom', type: 'Guardian' },
            { id: 9, char: 'ğŸ§œ', name: 'Siren', rarity: 'divine', element: 'water', defaultMove: 'tidal_veil', type: 'Speedster' },
            { id: 246, char: 'ğŸª¸', name: 'Coralyn', rarity: 'divine', element: 'water', defaultMove: 'grave_bite', type: 'Guardian' },
            { id: 10, char: 'ğŸ™', name: 'Kraken', rarity: 'epic', element: 'water', defaultMove: 'ripple_cut', type: 'Guardian' },
            { id: 66, char: 'ğŸ§Š', name: 'Frost', rarity: 'uncommon', element: 'water', defaultMove: 'drench_mark', type: 'Tank' },
            { id: 111, char: 'ğŸ›¶', name: 'Drift', rarity: 'uncommon', element: 'water', defaultMove: 'flood_mark', type: 'Speedster' },
            { id: 112, char: 'â›²', name: 'Geyser', rarity: 'rare', element: 'water', defaultMove: 'tidal_spear', type: 'Striker' },
            { id: 113, char: 'â›µ', name: 'Skiff', rarity: 'rare', element: 'water', defaultMove: 'undertow', type: 'Tank' },
            { id: 154, char: 'ğŸ¦', name: 'Claw', rarity: 'rare', element: 'water', defaultMove: 'pressure_jet', type: 'Striker' },
            { id: 155, char: 'ğŸ¦€', name: 'Shell', rarity: 'uncommon', element: 'water', defaultMove: 'soak_mark', type: 'Tank' },
            { id: 156, char: 'ğŸ¦', name: 'Prawn', rarity: 'eternal', element: 'water', defaultMove: 'miracle_current', type: 'Speedster' },
            { id: 157, char: 'ğŸ¡', name: 'Puff', rarity: 'rare', element: 'water', defaultMove: 'tidal_spear', type: 'Tank' },
            { id: 158, char: 'ğŸ§', name: 'Waddle', rarity: 'epic', element: 'water', defaultMove: 'frost_shell', type: 'Speedster' },
            { id: 159, char: 'ğŸ¦¢', name: 'Grace', rarity: 'rare', element: 'water', defaultMove: 'torrent_edge', type: 'Speedster' },
            { id: 160, char: 'ğŸ¬', name: 'Echo', rarity: 'legendary', element: 'water', defaultMove: 'gleam_shot', type: 'Speedster' },
            { id: 161, char: 'â˜”', name: 'Shield', rarity: 'common', element: 'water', defaultMove: 'mist_jab', type: 'Tank' },
            // NATURE (33)
            { id: 11, char: 'ğŸŒ¿', name: 'Sprout', rarity: 'uncommon', element: 'nature', defaultMove: 'rootbind', type: 'Tank' },
            { id: 12, char: 'ğŸ¯', name: 'Jungle', rarity: 'rare', element: 'nature', defaultMove: 'seed_bloom', type: 'Striker' },
            { id: 13, char: 'ğŸ¦„', name: 'Mythic', rarity: 'epic', element: 'nature', defaultMove: 'forest_crush', type: 'Speedster' },
            { id: 14, char: 'ğŸŒ³', name: 'Oak', rarity: 'legendary', element: 'nature', defaultMove: 'ancient_growth', type: 'Guardian' },
            { id: 247, char: 'ğŸª·', name: 'Lotus', rarity: 'divine', element: 'nature', defaultMove: 'eden_wrath', type: 'Guardian' },
            { id: 248, char: 'ğŸƒ', name: 'Breeze', rarity: 'divine', element: 'nature', defaultMove: 'gaia_grasp', type: 'Speedster' },
            { id: 15, char: 'ğŸŒ»', name: 'Sunny', rarity: 'uncommon', element: 'nature', defaultMove: 'vine_lock', type: 'Striker' },
            { id: 70, char: 'ğŸ¦‹', name: 'Morpho', rarity: 'epic', element: 'nature', defaultMove: 'lifebloom', type: 'Speedster' },
            { id: 114, char: 'ğŸ„', name: 'Toad', rarity: 'uncommon', element: 'nature', defaultMove: 'snare_bloom', type: 'Tank' },
            { id: 115, char: 'ğŸ¦—', name: 'Chirp', rarity: 'rare', element: 'nature', defaultMove: 'vine_lash', type: 'Speedster' },
            { id: 162, char: 'ğŸ¦', name: 'Kong', rarity: 'legendary', element: 'nature', defaultMove: 'verdant_reckoning', type: 'Brawler' },
            { id: 163, char: 'ğŸ˜', name: 'Pach', rarity: 'legendary', element: 'nature', defaultMove: 'wildroot_lance', type: 'Guardian' },
            { id: 164, char: 'ğŸ¦’', name: 'Tall', rarity: 'rare', element: 'nature', defaultMove: 'quicksand', type: 'Tank' },
            { id: 165, char: 'ğŸ¦“', name: 'Stripe', rarity: 'common', element: 'nature', defaultMove: 'briar_strike', type: 'Speedster' },
            { id: 166, char: 'ğŸ', name: 'Coil', rarity: 'rare', element: 'nature', defaultMove: 'thorn_bind', type: 'Striker' },
            { id: 167, char: 'ğŸ¢', name: 'Shell', rarity: 'common', element: 'nature', defaultMove: 'sap_strike', type: 'Tank' },
            { id: 168, char: 'ğŸŒµ', name: 'Spine', rarity: 'common', element: 'nature', defaultMove: 'moss_spike', type: 'Tank' },
            { id: 169, char: 'ğŸ€', name: 'Luck', rarity: 'epic', element: 'nature', defaultMove: 'bramble_bite', type: 'Speedster' },
            // LIGHT (25)
            { id: 16, char: 'ğŸ•¯ï¸', name: 'Candle', rarity: 'common', element: 'light', defaultMove: 'spark_jab', type: 'Speedster' },
            { id: 17, char: 'ğŸ˜‡', name: 'Aegis', rarity: 'rare', element: 'light', defaultMove: 'radiant_burst', type: 'Tank' },
            { id: 18, char: 'ğŸ‘‘', name: 'Sov', rarity: 'legendary', element: 'light', defaultMove: 'aegis_pulse', type: 'Mystic' },
            { id: 19, char: 'ğŸ’', name: 'Gem', rarity: 'epic', element: 'light', defaultMove: 'blessing_wall', type: 'Guardian' },
            { id: 20, char: 'ğŸ§¿', name: 'Eye', rarity: 'divine', element: 'light', defaultMove: 'seraphic_wave', type: 'Guardian' },
            { id: 117, char: 'ğŸ°', name: 'Fort', rarity: 'legendary', element: 'light', defaultMove: 'judgment_ray', type: 'Guardian' },
            { id: 118, char: 'ğŸ•Šï¸', name: 'Peace', rarity: 'rare', element: 'light', defaultMove: 'sunbeam', type: 'Speedster' },
            { id: 170, char: 'ğŸ¦„', name: 'Aurelia', rarity: 'divine', element: 'light', defaultMove: 'radiant_crown', type: 'Mystic' },
            { id: 171, char: 'ğŸ‘¼', name: 'Seraph', rarity: 'legendary', element: 'light', defaultMove: 'radiant_surge', type: 'Mystic' },
            { id: 172, char: 'ğŸŒˆ', name: 'Prism', rarity: 'legendary', element: 'light', defaultMove: 'aegis_pulse', type: 'Mystic' },
            { id: 173, char: 'ğŸ’', name: 'Wealth', rarity: 'epic', element: 'light', defaultMove: 'holy_barrier', type: 'Guardian' },
            { id: 174, char: 'ğŸ§', name: 'Grant', rarity: 'divine', element: 'light', defaultMove: 'seraphic_wave', type: 'Mystic' },
            { id: 175, char: 'ğŸ’¡', name: 'Volt', rarity: 'uncommon', element: 'light', defaultMove: 'glare', type: 'Mystic' },
            { id: 176, char: 'ğŸ»', name: 'Solo', rarity: 'rare', element: 'light', defaultMove: 'daybreak_lance', type: 'Speedster' },
            // DARK (25)
            { id: 21, char: 'ğŸŒ‘', name: 'Eclip', rarity: 'uncommon', element: 'dark', defaultMove: 'umbra_shot', type: 'Speedster' },
            { id: 22, char: 'ğŸ¦‡', name: 'Vamp', rarity: 'rare', element: 'dark', defaultMove: 'doom_seal', type: 'Mystic' },
            { id: 23, char: 'ğŸ‘ï¸', name: 'Void', rarity: 'divine', element: 'dark', defaultMove: 'eclipse_edge', type: 'Mystic' },
            { id: 24, char: 'ğŸ‘»', name: 'Wraith', rarity: 'epic', element: 'dark', defaultMove: 'gloom_slash', type: 'Mystic' },
            { id: 120, char: 'ğŸ’£', name: 'Blast', rarity: 'epic', element: 'dark', defaultMove: 'gloom_slash', type: 'Mystic' },
            { id: 121, char: 'ğŸ•·ï¸', name: 'Widow', rarity: 'rare', element: 'dark', defaultMove: 'void_chill', type: 'Mystic' },
            { id: 177, char: 'ğŸª', name: 'Abyss', rarity: 'legendary', element: 'dark', defaultMove: 'shadow_slice', type: 'Guardian' },
            { id: 178, char: 'ğŸ›¸', name: 'Visitor', rarity: 'epic', element: 'dark', defaultMove: 'shade_rush', type: 'Mystic' },
            { id: 179, char: 'ğŸ’€', name: 'Reap', rarity: 'legendary', element: 'dark', defaultMove: 'abyssal_cut', type: 'Mystic' },
            { id: 180, char: 'ğŸ•·ï¸', name: 'Fang', rarity: 'rare', element: 'dark', defaultMove: 'dusk_cut', type: 'Mystic' },
            { id: 181, char: 'ğŸ”®', name: 'Oracle', rarity: 'divine', element: 'dark', defaultMove: 'nightfall_pact', type: 'Mystic' },
            { id: 182, char: 'ğŸ‘½', name: 'Zor', rarity: 'epic', element: 'dark', defaultMove: 'gloom_slash', type: 'Mystic' },
            { id: 183, char: 'ğŸ‘¾', name: 'Shadow', rarity: 'eternal', element: 'dark', defaultMove: 'endless_night', type: 'Mystic' },
            { id: 184, char: 'ğŸ•°ï¸', name: 'Dread', rarity: 'rare', element: 'dark', defaultMove: 'shadow_gale', type: 'Tank' },
            // MIXED/ETERNAL (Remaining)
            { id: 58, char: 'ğŸŒ€', name: 'Singu', rarity: 'eternal', element: 'dark', defaultMove: 'endless_night', type: 'Mystic' },
            { id: 59, char: 'â™¾ï¸', name: 'Infin', rarity: 'eternal', element: 'light', defaultMove: 'dawn_eternum', type: 'Guardian' },
            { id: 60, char: 'ğŸ”ï¸', name: 'Zenith', rarity: 'eternal', element: 'nature', defaultMove: 'worldroot', type: 'Speedster' },
            { id: 185, char: 'ğŸ³', name: 'Sizzle', rarity: 'common', element: 'fire', defaultMove: 'cinder_jab', type: 'Tank' },
            { id: 186, char: 'ğŸ¤¡', name: 'Chaos', rarity: 'epic', element: 'dark', defaultMove: 'night_howl', type: 'Mystic' },
            { id: 187, char: 'ğŸ·', name: 'Jazz', rarity: 'rare', element: 'light', defaultMove: 'bright_pulse', type: 'Speedster' },
            { id: 188, char: 'ğŸ¾', name: 'Bounce', rarity: 'common', element: 'nature', defaultMove: 'thorns_pulse', type: 'Speedster' },
            { id: 189, char: 'ğŸ“·', name: 'Snap', rarity: 'common', element: 'light', defaultMove: 'gleam_shot', type: 'Speedster' },
            { id: 190, char: 'ğŸ§Š', name: 'Zero', rarity: 'legendary', element: 'water', defaultMove: 'riptide_fall', type: 'Guardian' },
            // EXPANSION (55)
            { id: 191, char: 'ğŸ§±', name: 'Brick', rarity: 'common', element: 'nature', defaultMove: 'briar_strike', type: 'Tank' },
            { id: 192, char: 'ğŸªµ', name: 'Log', rarity: 'common', element: 'nature', defaultMove: 'sap_strike', type: 'Tank' },
            { id: 193, char: 'ğŸª¨', name: 'Boulder', rarity: 'rare', element: 'nature', defaultMove: 'seed_bloom', type: 'Tank' },
            { id: 194, char: 'ğŸ§¯', name: 'Exting', rarity: 'rare', element: 'fire', defaultMove: 'ember_wave', type: 'Tank' },
            { id: 195, char: 'ğŸª“', name: 'Axe', rarity: 'rare', element: 'nature', defaultMove: 'vine_lash', type: 'Brawler' },
            { id: 196, char: 'ğŸ§²', name: 'Magnet', rarity: 'common', element: 'light', defaultMove: 'spark_jab', type: 'Mystic' },
            { id: 197, char: 'ğŸ§ª', name: 'Elixir', rarity: 'rare', element: 'light', defaultMove: 'spark_jab', type: 'Speedster' },
            { id: 198, char: 'ğŸ›¡ï¸', name: 'Bulwark', rarity: 'epic', element: 'light', defaultMove: 'luminous_recovery', type: 'Guardian' },
            { id: 199, char: 'âš¡', name: 'Bolt', rarity: 'rare', element: 'light', defaultMove: 'spark_jab', type: 'Mystic' },
            { id: 200, char: 'ğŸŒŠ', name: 'Surge', rarity: 'epic', element: 'water', defaultMove: 'ocean_end', type: 'Brawler' },
            { id: 201, char: 'ğŸš', name: 'Pearl', rarity: 'common', element: 'water', defaultMove: 'current_jab', type: 'Guardian' },
            { id: 202, char: 'ğŸŸ', name: 'Fin', rarity: 'common', element: 'water', defaultMove: 'ice_barbs', type: 'Speedster' },
            { id: 203, char: 'ğŸŠ', name: 'Gator', rarity: 'rare', element: 'water', defaultMove: 'pressure_jet', type: 'Guardian' },
            { id: 204, char: 'ğŸ‹', name: 'Coloss', rarity: 'legendary', element: 'water', defaultMove: 'maelstrom', type: 'Guardian' },
            { id: 205, char: 'ğŸ§œâ€â™‚ï¸', name: 'Merman', rarity: 'epic', element: 'water', defaultMove: 'soothing_rain', type: 'Speedster' },
            { id: 206, char: 'ğŸ¦­', name: 'Harbor', rarity: 'common', element: 'water', defaultMove: 'mist_jab', type: 'Guardian' },
            { id: 207, char: 'ğŸ¦…', name: 'Talon', rarity: 'rare', element: 'light', defaultMove: 'spark_jab', type: 'Mystic' },
            { id: 208, char: 'ğŸ¦‰', name: 'Owl', rarity: 'epic', element: 'dark', defaultMove: 'night_howl', type: 'Mystic' },
            { id: 209, char: 'ğŸº', name: 'Howl', rarity: 'legendary', element: 'dark', defaultMove: 'void_requiem', type: 'Mystic' },
            { id: 210, char: 'ğŸ¦‚', name: 'Scorch', rarity: 'rare', element: 'fire', defaultMove: 'firebrand', type: 'Brawler' },
            { id: 211, char: 'ğŸ', name: 'Buzz', rarity: 'common', element: 'nature', defaultMove: 'moss_spike', type: 'Speedster' },
            { id: 212, char: 'ğŸ§„', name: 'Garlic', rarity: 'common', element: 'nature', defaultMove: 'thorns_pulse', type: 'Brawler' },
            { id: 213, char: 'ğŸ¥•', name: 'Carrot', rarity: 'common', element: 'nature', defaultMove: 'briar_strike', type: 'Speedster' },
            { id: 214, char: 'ğŸ¥”', name: 'Spud', rarity: 'common', element: 'nature', defaultMove: 'sap_strike', type: 'Guardian' },
            { id: 215, char: 'ğŸ¥©', name: 'Steak', rarity: 'rare', element: 'fire', defaultMove: 'flame_rush', type: 'Brawler' },
            { id: 216, char: 'ğŸ¥¨', name: 'Twist', rarity: 'common', element: 'fire', defaultMove: 'ash_swipe', type: 'Speedster' },
            { id: 217, char: 'ğŸ¥¯', name: 'Bagel', rarity: 'common', element: 'fire', defaultMove: 'spark_flick', type: 'Guardian' },
            { id: 218, char: 'ğŸœ', name: 'Noodle', rarity: 'rare', element: 'fire', defaultMove: 'blaze_thrust', type: 'Speedster' },
            { id: 219, char: 'ğŸ™', name: 'Onigiri', rarity: 'common', element: 'fire', defaultMove: 'flare_step', type: 'Guardian' },
            { id: 220, char: 'ğŸ§', name: 'Cupcake', rarity: 'rare', element: 'light', defaultMove: 'spark_jab', type: 'Speedster' },
            { id: 221, char: 'ğŸ‡', name: 'Spark', rarity: 'epic', element: 'fire', defaultMove: 'volcanic_reign', type: 'Speedster' },
            { id: 222, char: 'ğŸ†', name: 'Burst', rarity: 'epic', element: 'fire', defaultMove: 'smoldering_guard', type: 'Brawler' },
            { id: 223, char: 'ğŸª¬', name: 'Charm', rarity: 'divine', element: 'light', defaultMove: 'radiant_crown', type: 'Mystic' },
            { id: 224, char: 'ğŸ§Ÿ', name: 'Zombie', rarity: 'epic', element: 'dark', defaultMove: 'grave_bite', type: 'Guardian' },
            { id: 225, char: 'ğŸ§›â€â™‚ï¸', name: 'Lord', rarity: 'legendary', element: 'dark', defaultMove: 'shadow_slice', type: 'Mystic' },
            { id: 226, char: 'ğŸœ', name: 'Ant', rarity: 'trash', element: 'nature', defaultMove: 'moss_spike', type: 'Speedster' },
            { id: 227, char: 'ğŸª³', name: 'Roach', rarity: 'trash', element: 'dark', defaultMove: 'night_prick', type: 'Speedster' },
            { id: 228, char: 'ğŸ§»', name: 'Tissue', rarity: 'trash', element: 'light', defaultMove: 'lumen_guard', type: 'Trash' },
            { id: 229, char: 'ğŸ¥€', name: 'Wilt', rarity: 'trash', element: 'nature', defaultMove: 'thorns_pulse', type: 'Striker' },
            { id: 230, char: 'ğŸª£', name: 'Bucket', rarity: 'trash', element: 'water', defaultMove: 'ripple_cut', type: 'Tank' },
            { id: 231, char: 'ğŸ•¸ï¸', name: 'Web', rarity: 'rare', element: 'dark', defaultMove: 'gloom_slash', type: 'Guardian' },
            { id: 232, char: 'ğŸ•¯ï¸', name: 'Candle', rarity: 'uncommon', element: 'light', defaultMove: 'prism_seal', type: 'Mystic' },
            { id: 233, char: 'ğŸŒ’', name: 'Crescent', rarity: 'uncommon', element: 'dark', defaultMove: 'hex', type: 'Speedster' },
            { id: 234, char: 'ğŸŒŒ', name: 'Cosmos', rarity: 'epic', element: 'dark', defaultMove: 'shade_rush', type: 'Mystic' },
            { id: 235, char: 'ğŸ•', name: 'Tater', rarity: 'eternal', element: 'light', defaultMove: 'judgment_ray', type: 'Striker' },
            { id: 236, char: 'ğŸ²', name: 'Dice', rarity: 'rare', element: 'dark', defaultMove: 'moon_slash', type: 'Speedster' },
            { id: 237, char: 'ğŸ“¿', name: 'Beads', rarity: 'rare', element: 'light', defaultMove: 'spark_jab', type: 'Guardian' },
            { id: 238, char: 'ğŸª™', name: 'Coin', rarity: 'uncommon', element: 'light', defaultMove: 'shine_tag', type: 'Guardian' },
            { id: 239, char: 'ğŸ§µ', name: 'Thread', rarity: 'uncommon', element: 'dark', defaultMove: 'malison', type: 'Speedster' },
            { id: 240, char: 'ğŸª¡', name: 'Needle', rarity: 'rare', element: 'dark', defaultMove: 'void_chill', type: 'Mystic' },
            { id: 241, char: 'ğŸ§­', name: 'Compass', rarity: 'epic', element: 'light', defaultMove: 'blessing_wall', type: 'Mystic' },
            { id: 242, char: 'ğŸ¥¶', name: 'Chill', rarity: 'epic', element: 'water', defaultMove: 'frost_shell', type: 'Guardian' },
            { id: 243, char: 'ğŸ—¡ï¸', name: 'Blade', rarity: 'legendary', element: 'fire', defaultMove: 'worldfire', type: 'Brawler' },
            { id: 244, char: 'ğŸ§‹', name: 'Boba', rarity: 'common', element: 'water', defaultMove: 'current_jab', type: 'Speedster' },
            { id: 245, char: 'ğŸˆ', name: 'Nimby', rarity: 'eternal', element: 'dark', defaultMove: 'nightfall_pact', type: 'Mystic' }
        ];

        const RARITY_ORDER = ['trash', 'common', 'uncommon', 'rare', 'epic', 'legendary', 'false_divine', 'divine', 'eternal'];
        const TYPE_WEIGHTS = {
            Striker: { hp: 1.0, atk: 1.5, spd: 0.9, def: 0.85, spAtk: 1.2, spDef: 0.85 },
            Tank: { hp: 1.3, atk: 0.6, spd: 0.6, def: 1.3, spAtk: 0.8, spDef: 1.3 },
            Speedster: { hp: 0.95, atk: 0.9, spd: 1.5, def: 0.8, spAtk: 1.0, spDef: 0.8 },
            Mystic: { hp: 0.85, atk: 0.7, spd: 1.0, def: 0.8, spAtk: 1.6, spDef: 1.2 },
            Guardian: { hp: 1.4, atk: 0.8, spd: 0.4, def: 1.4, spAtk: 0.7, spDef: 1.6 },
            Brawler: { hp: 1.2, atk: 1.4, spd: 0.85, def: 1.1, spAtk: 0.7, spDef: 0.9 },
            Tater: { hp: 2.0, atk: 2.0, spd: 2.0, def: 2.0, spAtk: 2.0, spDef: 2.0 },
            Trash: { hp: 1.5, atk: 1.5, spd: 1.5, def: 1.5, spAtk: 1.5, spDef: 1.5 }
        };
        const ELEMENT_BONUSES = {
            fire: { hp: 1.0, atk: 1.2, spd: 1.0, def: 0.95, spAtk: 1.2, spDef: 0.95 },
            water: { hp: 1.2, atk: 1.0, spd: 1.0, def: 1.0, spAtk: 1.0, spDef: 1.15 },
            nature: { hp: 1.1, atk: 1.1, spd: 1.0, def: 1.1, spAtk: 1.0, spDef: 1.0 },
            light: { hp: 1.0, atk: 1.0, spd: 1.2, def: 1.0, spAtk: 1.05, spDef: 1.1 },
            dark: { hp: 0.9, atk: 1.3, spd: 1.0, def: 0.95, spAtk: 1.15, spDef: 0.95 }
        };
        const RARITY_MULTIPLIERS = { trash: 0.4, common: 1.0, uncommon: 1.25, rare: 1.5, epic: 2.5, legendary: 4.5, false_divine: 8.0, divine: 8.5, eternal: 20.0 };
        const GROWTH_RATES = { trash: 0.12, common: 0.15, uncommon: 0.165, rare: 0.18, epic: 0.22, legendary: 0.28, false_divine: 0.36, divine: 0.38, eternal: 0.55 };
        const ELEMENTS = { fire: { beats: 'nature' }, water: { beats: 'fire' }, nature: { beats: 'water' }, light: { beats: 'dark' }, dark: { beats: 'light' } };
        const ELEMENT_METADATA = {
            fire: { emoji: 'ğŸ”¥', name: 'Fire' },
            water: { emoji: 'ğŸ’§', name: 'Water' },
            nature: { emoji: 'ğŸŒ¿', name: 'Nature' },
            light: { emoji: 'âœ¨', name: 'Light' },
            dark: { emoji: 'ğŸŒ‘', name: 'Dark' },
            neutral: { emoji: 'â¬œ', name: 'Neutral' }
        };
        const RARITY_METADATA = {
            trash: { emoji: 'ğŸ—‘ï¸', name: 'Trash' },
            common: { emoji: 'âšª', name: 'Common' },
            uncommon: { emoji: 'ğŸŸ¢', name: 'Uncommon' },
            rare: { emoji: 'ğŸ”µ', name: 'Rare' },
            epic: { emoji: 'ğŸŸ£', name: 'Epic' },
            legendary: { emoji: 'ğŸŸ¡', name: 'Legendary' },
            false_divine: { emoji: 'ğŸ”¶', name: 'False Divine' },
            divine: { emoji: 'ğŸ’ ', name: 'Divine' },
            eternal: { emoji: 'â™¾ï¸', name: 'Eternal' }
        };
        const TYPE_METADATA = {
            Striker: { emoji: 'âš”ï¸', name: 'Striker' },
            Tank: { emoji: 'ğŸ›¡ï¸', name: 'Tank' },
            Speedster: { emoji: 'ğŸ’¨', name: 'Speedster' },
            Mystic: { emoji: 'ğŸ§ ', name: 'Mystic' },
            Guardian: { emoji: 'ğŸ°', name: 'Guardian' },
            Brawler: { emoji: 'ğŸ¥Š', name: 'Brawler' },
            Tater: { emoji: 'ğŸ¥”', name: 'Tater?' },
            Trash: { emoji: 'ğŸ—‘ï¸', name: 'Trash' }
        };
        const PROB_TABLES = {
            standard: { trash: 0.08, common: 0.6, uncommon: 0.85, rare: 0.98, epic: 0.999, legendary: 1.0, divine: 1.0, eternal: 1.0 },
            rare: { trash: 0.0, common: 0.0, uncommon: 0.5, rare: 0.82, epic: 0.99, legendary: 0.998, divine: 1.0, eternal: 1.0 },
            legendary: { trash: 0.0, common: 0.0, uncommon: 0.0, rare: 0.6, epic: 0.90, legendary: 0.985, divine: 0.995, eternal: 1.0 }
        };
        const LEVEL_COST_TABLE = { trash: 80, common: 150, uncommon: 200, rare: 300, epic: 500, legendary: 1000, false_divine: 1600, divine: 2000, eternal: 4000 };
        const PROMOTE_COST_TABLE = { trash: 500, common: 800, uncommon: 1200, rare: 2500, epic: 4000, legendary: 10000, false_divine: 16000, divine: 25000 };
        const ELEMENT_STATUS_EFFECTS = {
            fire: { id: 'burn', element: 'fire', name: 'Burn', desc: 'Takes damage each turn and deals reduced physical damage. Fire units are immune.' },
            water: { id: 'soak', element: 'water', name: 'Soak', desc: 'Next damage taken is amplified, then clears. Water units are immune.' },
            nature: { id: 'rooted', element: 'nature', name: 'Rooted', desc: 'Reduces speed and drains a small amount each turn. Nature units are immune.' },
            light: { id: 'dazzle', element: 'light', name: 'Dazzle', desc: 'Cannot gain attack or special attack stages and cooldowns recover slower. Light units are immune.' },
            dark: { id: 'curse', element: 'dark', name: 'Curse', desc: 'Healing received is reduced while active. Dark units are immune.' }
        };
        const STATUS_BY_ID = Object.values(ELEMENT_STATUS_EFFECTS).reduce((acc, status) => {
            acc[status.id] = status;
            return acc;
        }, {});
        const STATUS_RULES = {
            burn: { tickDamagePct: 0.05, physAtkMult: 0.75 },
            soak: { damageAmp: 1.35, consumeOnHit: true },
            rooted: { tickDrainPct: 0.04, spdMult: 0.7 },
            dazzle: { blockAtkStages: true, blockSpAtkStages: true, cooldownSlow: true },
            curse: { healMult: 0.6 }
        };
        const STATUS_APPLY_CHANCE = 0.2;
        const STAT_METADATA = {
            hp: { emoji: 'â¤ï¸', name: 'HP', desc: 'How much damage you can take.' },
            atk: { emoji: 'ğŸ—¡ï¸', name: 'ATK', desc: 'Boosts physical damage.' },
            def: { emoji: 'ğŸ§±', name: 'DEF', desc: 'Reduces physical damage taken.' },
            spAtk: { emoji: 'âœ¨', name: 'SP. ATK', desc: 'Boosts special damage.' },
            spDef: { emoji: 'ğŸ›¡ï¸', name: 'SP. DEF', desc: 'Reduces special damage taken.' },
            spd: { emoji: 'âš¡', name: 'SPD', desc: 'Determines turn order.' }
        };
        const ADVENTURE_REGION_POOLS = [
            { pool: 'trash', name: 'Cinder Wastes', emoji: 'ğŸ§±', rarity: 'trash', element: 'fire', desc: 'ReneÃ©\'s scrapyard frontier full of brittle fighters.' },
            { pool: 'common', name: 'Rusted Crossing', emoji: 'ğŸªµ', rarity: 'common', element: 'nature', desc: 'Mairi\'s outdoor trails.' },
            { pool: 'uncommon', name: 'Arcade Zone', emoji: 'ğŸ•¹ï¸', rarity: 'uncommon', element: 'light', desc: 'Eke\'s game zone and bowling alley.' },
            { pool: 'rare', name: 'Stormreef', emoji: 'ğŸŒŠ', rarity: 'rare', element: 'water', desc: 'Paul\'s backyard stream has become an ocean.' },
            { pool: 'epic', name: 'Totspire', emoji: 'ğŸ°', rarity: 'epic', element: 'light', desc: 'Tater\'s dinner hoard is well protected.' },
            { pool: 'legendary', name: 'Mars', emoji: 'ğŸª', rarity: 'legendary', element: 'dark', desc: 'Will\'s last attempt at padding out the game content.' }
        ];
        const ADVENTURE_BOSS_TRAINERS = {
            trash: { emoji: 'ğŸ§‘â€ğŸ­', name: 'ReneÃ© "Scrapking" Scroby Jr.', line: 'Out here, you either break... or you empty yourself onto the ground.' },
            common: { emoji: 'ğŸ§‘â€ğŸŒ¾', name: 'Mairi "Rangus" Williams', line: 'Lay some eggs.' },
            uncommon: { emoji: 'ğŸ§‘â€ğŸ¨', name: 'Eke Scroby', line: "Let's see you win when I am nude." },
            rare: { emoji: 'ğŸ§‘â€âœˆï¸', name: 'Paul Jollimore', line: 'Hold!!! HOLD!!! When the surge hits, I must HOLD!!!.' },
            epic: { emoji: 'ğŸ•', name: 'Lord Toter Scroby', line: 'Kneel to the king and give me dinner.' },
            legendary: { emoji: 'ğŸ§‘â€ğŸš€', name: 'William Marsman', line: "I didn't expect anyone to make it this far (wets self)" }
        };
        const ADVENTURE_STAGE_BY_RARITY = { trash: 1, common: 4, uncommon: 7, rare: 12, epic: 18, legendary: 24 };
        const ADVENTURE_POOLS = [
            { label: 'Trash', maxRarity: 'trash', weights: { trash: 1.0 } },
            { label: 'Common', maxRarity: 'common', weights: { trash: 0.35, common: 0.65 } },
            { label: 'Uncommon', maxRarity: 'uncommon', weights: { trash: 0.2, common: 0.45, uncommon: 0.35 } },
            { label: 'Rare', maxRarity: 'rare', weights: { common: 0.25, uncommon: 0.45, rare: 0.3 } },
            { label: 'Epic', maxRarity: 'epic', weights: { uncommon: 0.2, rare: 0.45, epic: 0.35 } },
            { label: 'Legendary', maxRarity: 'legendary', weights: { rare: 0.25, epic: 0.4, legendary: 0.35 } }
        ];
        /*
         * Move Identity + Rarity Philosophy (balance rework notes)
         * Elements:
         * - Fire: burst damage, pressure, aggressive tempo, recoil.
         * - Water: control, sustain, and momentum swings, status heavy.
         * - Nature: attrition, drains, and debuff + damage.
         * - Light: protection, support, and tempo stabilization.
         * - Dark: risk-reward power, buffs + damage, and comeback tools.
         *
         * Rarity:
         * - trash/common/uncommon: simple, reliable, low cooldown, modest impact.
         * - rare/epic: clear identity, stronger efficiency or utility, tradeoffs.
         * - legendary/divine/eternal: splashy, high ceiling, longer cooldowns.
         *
         * Move Effects:
         * - damage: direct HP impact, varying power and target.
         * - heal: restore HP to self or allies. Scale less than damage given rarity.
         * - buff: increase own or allies' stats for the match.
         * - debuff: decrease enemy stats for the match.
         * - status: apply status conditions with unique effects.
         * - recoil: damage self as tradeoff for higher power or more effects. Primarily fire and dark.
         * - drain: heal self based on damage dealt. Should have lower base power to compensate. Primarily nature.
         * 
         * Guidelines for new moves:
         * - Always set: power, cooldown, kind, target, element, damageType, rarity.
         * - Use 50 power as baseline; higher power implies higher cooldown or narrower target.
         * - AoE moves should be lower power; single-target damage must be higher power than 45 (as same element attack bonus brings above 50 power effectively), scaled by rarity.
         *   - AoE moves should not apply status unless legendary+.
         * - Moves that combine effects should have lower base power or higher cooldown.
         *   - Example: damage + status chance, damage + debuff, heal + buff.
         * - Moves that have negative tradeoffs can have higher base power, lower cooldown or enemy-all targeting.
         *   - Example: self-debuff, all-team-debuff, recoil, self-status.
         * - Buffs/debuffs are be stage-based. Do not have max HP buffs.
         * - Status application should be rare or gated.
         * - Keep element identity intact; avoid cross-element gimmicks unless rare+.
         */
        const MOVES = [
            /* Basic move */
            { num: 1, id: 'basic_strike', name: 'Basic Strike', power: 40, cooldown: 0, kind: 'damage', target: 'enemy-single', element: 'neutral', damageType: 'physical', rarity: 'common' },

            /* Fire Moves */
            { num: 2, id: 'cinder_jab', name: 'Cinder Jab', power: 48, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'fire', damageType: 'physical', rarity: 'common' },
            { num: 3, id: 'ash_swipe', name: 'Ash Swipe', power: 44, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'fire', damageType: 'physical', rarity: 'common' },
            { num: 4, id: 'spark_flick', name: 'Spark Flick', power: 42, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'fire', damageType: 'special', rarity: 'common' },
            { num: 5, id: 'flare_step', name: 'Flare Step', power: 0, cooldown: 3, kind: 'buff', target: 'self', element: 'fire', damageType: 'status', rarity: 'common', effect: { spd: 1 } },
            { num: 6, id: 'scorch_mark', name: 'Scorch Mark', power: 0, cooldown: 3, kind: 'status', target: 'enemy-single', element: 'fire', damageType: 'status', rarity: 'uncommon', statuses: [{ id: 'burn', chance: 1 }] },
            { num: 7, id: 'brand_seal', name: 'Brand Seal', power: 36, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'fire', damageType: 'special', rarity: 'uncommon', effect: { targetStages: { def: -1 } } },
            { num: 8, id: 'blister_tag', name: 'Blister Tag', power: 40, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'fire', damageType: 'physical', rarity: 'uncommon', statuses: [{ id: 'burn', chance: 0.35 }] },
            { num: 9, id: 'ember_wave', name: 'Ember Wave', power: 32, cooldown: 3, kind: 'damage', target: 'enemy-all', element: 'fire', damageType: 'special', rarity: 'rare' },
            { num: 10, id: 'firebrand', name: 'Firebrand', power: 58, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'fire', damageType: 'special', rarity: 'rare', statuses: [{ id: 'burn', chance: 0.25 }] },
            { num: 11, id: 'flame_rush', name: 'Flame Rush', power: 70, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'fire', damageType: 'special', rarity: 'rare', effect: { recoilPct: 0.2 }, statuses: [{ id: 'burn', chance: 0.3 }] },
            { num: 12, id: 'blaze_thrust', name: 'Blaze Thrust', power: 68, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'fire', damageType: 'physical', rarity: 'rare', effect: { recoilPct: 0.15 } },
            { num: 13, id: 'heat_shield', name: 'Heat Shield', power: 0, cooldown: 4, kind: 'buff', target: 'self', element: 'fire', damageType: 'status', rarity: 'epic', effect: { def: 1, spDef: 1 } },
            { num: 14, id: 'overheat', name: 'Overheat', power: 78, cooldown: 4, kind: 'damage', target: 'enemy-single', element: 'fire', damageType: 'special', rarity: 'epic', effect: { recoilPct: 0.25 } },
            { num: 15, id: 'smoldering_guard', name: 'Smoldering Guard', power: 0, cooldown: 4, kind: 'buff', target: 'self', element: 'fire', damageType: 'status', rarity: 'epic', effect: { atk: 1, spAtk: 1 } },
            { num: 16, id: 'magma_quake', name: 'Magma Quake', power: 72, cooldown: 4, kind: 'damage', target: 'enemy-all', element: 'fire', damageType: 'special', rarity: 'legendary', effect: { recoilPct: 0.25 }, statuses: [{ id: 'burn', chance: 0.35 }] },
            { num: 17, id: 'phoenix_dive', name: 'Phoenix Dive', power: 90, cooldown: 4, kind: 'damage', target: 'enemy-single', element: 'fire', damageType: 'special', rarity: 'legendary', effect: { recoilPct: 0.3 }, statuses: [{ id: 'burn', chance: 0.4 }] },
            { num: 18, id: 'volcanic_reign', name: 'Volcanic Reign', power: 65, cooldown: 4, kind: 'damage', target: 'enemy-all', element: 'fire', damageType: 'special', rarity: 'legendary', statuses: [{ id: 'burn', chance: 0.3 }] },
            { num: 19, id: 'solar_flare', name: 'Solar Flare', power: 75, cooldown: 4, kind: 'damage', target: 'enemy-all', element: 'fire', damageType: 'special', rarity: 'divine', statuses: [{ id: 'burn', chance: 0.5 }] },
            { num: 20, id: 'crimson_pact', name: 'Crimson Pact', power: 95, cooldown: 4, kind: 'damage', target: 'enemy-single', element: 'fire', damageType: 'special', rarity: 'divine', effect: { recoilPct: 0.35, selfStages: { spAtk: 1 } } },
            { num: 21, id: 'worldfire', name: 'Worldfire', power: 100, cooldown: 5, kind: 'damage', target: 'enemy-all', element: 'fire', damageType: 'special', rarity: 'eternal', effect: { recoilPct: 0.4 }, statuses: [{ id: 'burn', chance: 0.6 }] },

            /* Water Moves */
            { num: 22, id: 'ice_barbs', name: 'Ice Barbs', power: 24, cooldown: 3, kind: 'damage', target: 'enemy-all', element: 'water', damageType: 'special', rarity: 'common' },
            { num: 23, id: 'ripple_cut', name: 'Ripple Cut', power: 44, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'water', damageType: 'physical', rarity: 'common' },
            { num: 24, id: 'mist_jab', name: 'Mist Jab', power: 40, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'water', damageType: 'special', rarity: 'common' },
            { num: 25, id: 'current_jab', name: 'Current Jab', power: 42, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'water', damageType: 'physical', rarity: 'common' },
            { num: 26, id: 'soak_mark', name: 'Soak Mark', power: 0, cooldown: 3, kind: 'status', target: 'enemy-single', element: 'water', damageType: 'status', rarity: 'uncommon', statuses: [{ id: 'soak', chance: 1 }] },
            { num: 27, id: 'drench_mark', name: 'Drench Mark', power: 34, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'water', damageType: 'special', rarity: 'uncommon', effect: { targetStages: { spd: -1 } } },
            { num: 28, id: 'flood_mark', name: 'Flood Mark', power: 38, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'water', damageType: 'physical', rarity: 'uncommon', statuses: [{ id: 'soak', chance: 0.35 }] },
            { num: 29, id: 'torrent_edge', name: 'Torrent Edge', power: 56, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'water', damageType: 'physical', rarity: 'rare' },
            { num: 30, id: 'tidal_spear', name: 'Tidal Spear', power: 62, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'water', damageType: 'special', rarity: 'rare', statuses: [{ id: 'soak', chance: 0.3 }] },
            { num: 31, id: 'undertow', name: 'Undertow', power: 54, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'water', damageType: 'special', rarity: 'rare', effect: { targetStages: { spd: -1 } } },
            { num: 32, id: 'pressure_jet', name: 'Pressure Jet', power: 58, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'water', damageType: 'special', rarity: 'rare', statuses: [{ id: 'soak', chance: 0.25 }] },
            { num: 33, id: 'soothing_rain', name: 'Soothing Rain', power: 35, cooldown: 4, kind: 'heal', target: 'ally-all', element: 'water', damageType: 'status', rarity: 'epic' },
            { num: 34, id: 'frost_shell', name: 'Frost Shell', power: 0, cooldown: 4, kind: 'buff', target: 'self', element: 'water', damageType: 'status', rarity: 'epic', effect: { def: 1, spDef: 1 } },
            { num: 35, id: 'tidal_veil', name: 'Tidal Veil', power: 0, cooldown: 4, kind: 'buff', target: 'ally-all', element: 'water', damageType: 'status', rarity: 'epic', effect: { def: 1, spDef: 1 } },
            { num: 36, id: 'maelstrom', name: 'Maelstrom', power: 70, cooldown: 4, kind: 'damage', target: 'enemy-all', element: 'water', damageType: 'special', rarity: 'legendary' },
            { num: 37, id: 'leviathan_bite', name: 'Leviathan Bite', power: 85, cooldown: 4, kind: 'damage', target: 'enemy-single', element: 'water', damageType: 'special', rarity: 'legendary', statuses: [{ id: 'soak', chance: 0.4 }] },
            { num: 38, id: 'riptide_fall', name: 'Riptide Fall', power: 65, cooldown: 4, kind: 'damage', target: 'enemy-all', element: 'water', damageType: 'special', rarity: 'legendary', effect: { targetStages: { spd: -1 } } },
            { num: 39, id: 'abyssal_tide', name: 'Abyssal Tide', power: 78, cooldown: 4, kind: 'damage', target: 'enemy-all', element: 'water', damageType: 'special', rarity: 'divine', statuses: [{ id: 'soak', chance: 0.5 }] },
            { num: 40, id: 'miracle_current', name: 'Miracle Current', power: 0, cooldown: 4, kind: 'buff', target: 'ally-all', element: 'water', damageType: 'status', rarity: 'divine', effect: { def: 1, spDef: 1, spd: 1 } },
            { num: 41, id: 'ocean_end', name: 'Ocean End', power: 105, cooldown: 5, kind: 'damage', target: 'enemy-all', element: 'water', damageType: 'special', rarity: 'eternal', statuses: [{ id: 'soak', chance: 0.6 }] },

            /* Nature Moves */
            { num: 42, id: 'thorns_pulse', name: 'Thorns Pulse', power: 26, cooldown: 3, kind: 'damage', target: 'enemy-all', element: 'nature', damageType: 'special', rarity: 'common', effect: { targetStages: { spd: -1 } } },
            { num: 43, id: 'briar_strike', name: 'Briar Strike', power: 48, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'nature', damageType: 'physical', rarity: 'common', effect: { drainPct: 0.3 } },
            { num: 44, id: 'sap_strike', name: 'Sap Strike', power: 44, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'nature', damageType: 'physical', rarity: 'common', effect: { targetStages: { atk: -1 } } },
            { num: 45, id: 'moss_spike', name: 'Moss Spike', power: 42, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'nature', damageType: 'special', rarity: 'common', effect: { targetStages: { spDef: -1 } } },
            { num: 46, id: 'rootbind', name: 'Rootbind', power: 0, cooldown: 3, kind: 'status', target: 'enemy-single', element: 'nature', damageType: 'status', rarity: 'uncommon', statuses: [{ id: 'rooted', chance: 1 }] },
            { num: 47, id: 'vine_lock', name: 'Vine Lock', power: 36, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'nature', damageType: 'physical', rarity: 'uncommon', effect: { targetStages: { spd: -1 } } },
            { num: 48, id: 'snare_bloom', name: 'Snare Bloom', power: 34, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'nature', damageType: 'special', rarity: 'uncommon', effect: { drainPct: 0.25 } },
            { num: 49, id: 'seed_bloom', name: 'Seed Bloom', power: 52, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'nature', damageType: 'special', rarity: 'rare', effect: { drainPct: 0.3 } },
            { num: 50, id: 'vine_lash', name: 'Vine Lash', power: 55, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'nature', damageType: 'physical', rarity: 'rare', effect: { drainPct: 0.35 } },
            { num: 51, id: 'quicksand', name: 'Quicksand', power: 40, cooldown: 3, kind: 'damage', target: 'enemy-all', element: 'nature', damageType: 'special', rarity: 'rare', effect: { targetStages: { spd: -1 } } },
            { num: 52, id: 'thorn_bind', name: 'Thorn Bind', power: 54, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'nature', damageType: 'physical', rarity: 'rare', effect: { targetStages: { def: -1 } } },
            { num: 53, id: 'forest_crush', name: 'Forest Crush', power: 38, cooldown: 3, kind: 'damage', target: 'enemy-all', element: 'nature', damageType: 'special', rarity: 'epic', effect: { targetStages: { def: -1 } } },
            { num: 54, id: 'lifebloom', name: 'Lifebloom', power: 60, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'nature', damageType: 'special', rarity: 'epic', effect: { drainPct: 0.4 } },
            { num: 55, id: 'bramble_bite', name: 'Bramble Bite', power: 62, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'nature', damageType: 'physical', rarity: 'epic', effect: { targetStages: { spd: -1 } } },
            { num: 56, id: 'ancient_growth', name: 'Ancient Growth', power: 80, cooldown: 4, kind: 'damage', target: 'enemy-single', element: 'nature', damageType: 'physical', rarity: 'legendary', effect: { targetStages: { def: -1 } } },
            { num: 57, id: 'verdant_reckoning', name: 'Verdant Reckoning', power: 50, cooldown: 4, kind: 'damage', target: 'enemy-all', element: 'nature', damageType: 'special', rarity: 'legendary', effect: { drainPct: 0.35 } },
            { num: 58, id: 'wildroot_lance', name: 'Wildroot Lance', power: 78, cooldown: 4, kind: 'damage', target: 'enemy-single', element: 'nature', damageType: 'special', rarity: 'legendary', statuses: [{ id: 'rooted', chance: 0.3 }] },
            { num: 59, id: 'eden_wrath', name: 'Eden Wrath', power: 60, cooldown: 4, kind: 'damage', target: 'enemy-all', element: 'nature', damageType: 'special', rarity: 'divine', effect: { targetStages: { spd: -1 }, drainPct: 0.3 } },
            { num: 60, id: 'gaia_grasp', name: 'Gaia Grasp', power: 90, cooldown: 4, kind: 'damage', target: 'enemy-single', element: 'nature', damageType: 'special', rarity: 'divine', effect: { drainPct: 0.4 }, statuses: [{ id: 'rooted', chance: 0.5 }] },
            { num: 61, id: 'worldroot', name: 'Worldroot', power: 95, cooldown: 5, kind: 'damage', target: 'enemy-all', element: 'nature', damageType: 'special', rarity: 'eternal', effect: { drainPct: 0.4 }, statuses: [{ id: 'rooted', chance: 0.6 }] },

            /* Light Moves */
            { num: 62, id: 'spark_jab', name: 'Spark Jab', power: 45, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'light', damageType: 'physical', rarity: 'common' },
            { num: 63, id: 'gleam_shot', name: 'Gleam Shot', power: 42, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'light', damageType: 'special', rarity: 'common' },
            { num: 64, id: 'lumen_guard', name: 'Lumen Guard', power: 0, cooldown: 3, kind: 'buff', target: 'self', element: 'light', damageType: 'status', rarity: 'common', effect: { def: 1, spDef: 1 } },
            { num: 65, id: 'halo_step', name: 'Halo Step', power: 0, cooldown: 3, kind: 'buff', target: 'self', element: 'light', damageType: 'status', rarity: 'common', effect: { spd: 1 } },
            { num: 66, id: 'glare', name: 'Glare', power: 0, cooldown: 3, kind: 'status', target: 'enemy-single', element: 'light', damageType: 'status', rarity: 'uncommon', statuses: [{ id: 'dazzle', chance: 1 }] },
            { num: 67, id: 'prism_seal', name: 'Prism Seal', power: 34, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'light', damageType: 'special', rarity: 'uncommon', effect: { targetStages: { spAtk: -1 } } },
            { num: 68, id: 'shine_tag', name: 'Shine Tag', power: 38, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'light', damageType: 'physical', rarity: 'uncommon', statuses: [{ id: 'dazzle', chance: 0.35 }] },
            { num: 69, id: 'radiant_burst', name: 'Radiant Burst', power: 30, cooldown: 3, kind: 'damage', target: 'enemy-all', element: 'light', damageType: 'special', rarity: 'rare' },
            { num: 70, id: 'sunbeam', name: 'Sunbeam', power: 68, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'light', damageType: 'special', rarity: 'rare', statuses: [{ id: 'dazzle', chance: 0.25 }] },
            { num: 71, id: 'daybreak_lance', name: 'Daybreak Lance', power: 60, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'light', damageType: 'physical', rarity: 'rare' },
            { num: 72, id: 'bright_pulse', name: 'Bright Pulse', power: 55, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'light', damageType: 'special', rarity: 'rare', effect: { selfStages: { spDef: 1 } } },
            { num: 73, id: 'blessing_wall', name: 'Blessing Wall', power: 0, cooldown: 4, kind: 'buff', target: 'ally-all', element: 'light', damageType: 'status', rarity: 'epic', effect: { def: 1, spDef: 1 } },
            { num: 74, id: 'holy_barrier', name: 'Holy Barrier', power: 0, cooldown: 4, kind: 'buff', target: 'ally-all', element: 'light', damageType: 'status', rarity: 'epic', effect: { def: 1, spDef: 1, spd: 1 } },
            { num: 75, id: 'luminous_recovery', name: 'Luminous Recovery', power: 35, cooldown: 4, kind: 'heal', target: 'ally-all', element: 'light', damageType: 'status', rarity: 'epic' },
            { num: 76, id: 'aegis_pulse', name: 'Aegis Pulse', power: 0, cooldown: 4, kind: 'buff', target: 'ally-all', element: 'light', damageType: 'status', rarity: 'legendary', effect: { def: 1, spDef: 1, spd: 1 } },
            { num: 77, id: 'judgment_ray', name: 'Judgment Ray', power: 80, cooldown: 4, kind: 'damage', target: 'enemy-single', element: 'light', damageType: 'special', rarity: 'legendary', statuses: [{ id: 'dazzle', chance: 0.35 }] },
            { num: 78, id: 'radiant_surge', name: 'Radiant Surge', power: 55, cooldown: 4, kind: 'damage', target: 'enemy-all', element: 'light', damageType: 'special', rarity: 'legendary', statuses: [{ id: 'dazzle', chance: 0.3 }] },
            { num: 79, id: 'seraphic_wave', name: 'Seraphic Wave', power: 45, cooldown: 4, kind: 'heal', target: 'ally-all', element: 'light', damageType: 'status', rarity: 'divine' },
            { num: 80, id: 'radiant_crown', name: 'Radiant Crown', power: 65, cooldown: 4, kind: 'damage', target: 'enemy-all', element: 'light', damageType: 'special', rarity: 'divine', effect: { selfStages: { spAtk: 1 } }, statuses: [{ id: 'dazzle', chance: 0.5 }] },
            { num: 81, id: 'dawn_eternum', name: 'Dawn Eternum', power: 95, cooldown: 5, kind: 'damage', target: 'enemy-all', element: 'light', damageType: 'special', rarity: 'eternal', effect: { selfStages: { spAtk: 1, spd: 1 } }, statuses: [{ id: 'dazzle', chance: 0.6 }] },

            /* Dark Moves */
            { num: 82, id: 'gloom_slash', name: 'Gloom Slash', power: 42, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'physical', rarity: 'common' },
            { num: 83, id: 'shade_bolt', name: 'Shade Bolt', power: 40, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'special', rarity: 'common' },
            { num: 84, id: 'night_prick', name: 'Night Prick', power: 44, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'physical', rarity: 'common' },
            { num: 85, id: 'umbra_shot', name: 'Umbra Shot', power: 42, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'special', rarity: 'common' },
            { num: 86, id: 'hex', name: 'Hex', power: 0, cooldown: 3, kind: 'status', target: 'enemy-single', element: 'dark', damageType: 'status', rarity: 'uncommon', statuses: [{ id: 'curse', chance: 1 }] },
            { num: 87, id: 'malison', name: 'Malison', power: 36, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'special', rarity: 'uncommon', effect: { targetStages: { atk: -1 } } },
            { num: 88, id: 'doom_seal', name: 'Doom Seal', power: 38, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'physical', rarity: 'uncommon', statuses: [{ id: 'curse', chance: 0.35 }] },
            { num: 89, id: 'void_chill', name: 'Void Chill', power: 40, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'physical', rarity: 'rare', effect: { selfStages: { spAtk: 1 } } },
            { num: 90, id: 'dusk_cut', name: 'Dusk Cut', power: 48, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'special', rarity: 'rare', effect: { selfStages: { atk: 1 }, recoilPct: 0.1 } },
            { num: 91, id: 'shadow_gale', name: 'Shadow Gale', power: 58, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'special', rarity: 'rare', effect: { selfStages: { spd: 1 }, recoilPct: 0.1 } },
            { num: 92, id: 'moon_slash', name: 'Moon Slash', power: 65, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'physical', rarity: 'rare', effect: { selfStages: { atk: 1 } } },
            { num: 93, id: 'night_howl', name: 'Night Howl', power: 60, cooldown: 4, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'special', rarity: 'epic', effect: { selfStages: { atk: 1, spd: 1 }, recoilPct: 0.2 } },
            { num: 94, id: 'grave_bite', name: 'Grave Bite', power: 72, cooldown: 4, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'physical', rarity: 'epic', effect: { selfStages: { spAtk: 1 }, recoilPct: 0.2 } },
            { num: 95, id: 'shade_rush', name: 'Shade Rush', power: 62, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'special', rarity: 'epic', effect: { selfStages: { spd: 1 } } },
            { num: 96, id: 'shadow_slice', name: 'Shadow Slice', power: 82, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'special', rarity: 'legendary', effect: { selfStages: { spAtk: 1 }, recoilPct: 0.25 }, statuses: [{ id: 'curse', chance: 0.3 }] },
            { num: 97, id: 'abyssal_cut', name: 'Abyssal Cut', power: 88, cooldown: 4, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'physical', rarity: 'legendary', effect: { selfStages: { atk: 1 }, recoilPct: 0.25 } },
            { num: 98, id: 'void_requiem', name: 'Void Requiem', power: 80, cooldown: 4, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'special', rarity: 'legendary', effect: { selfStages: { spAtk: 1 } }, statuses: [{ id: 'curse', chance: 0.35 }] },
            { num: 99, id: 'eclipse_edge', name: 'Eclipse Edge', power: 92, cooldown: 4, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'special', rarity: 'divine', effect: { selfStages: { atk: 1, spd: 1 }, recoilPct: 0.3 } },
            { num: 100, id: 'nightfall_pact', name: 'Nightfall Pact', power: 85, cooldown: 4, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'special', rarity: 'divine', effect: { selfStages: { spAtk: 1 }, recoilPct: 0.25 }, statuses: [{ id: 'curse', chance: 0.5 }] },
            { num: 101, id: 'endless_night', name: 'Endless Night', power: 100, cooldown: 5, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'special', rarity: 'eternal', effect: { selfStages: { atk: 1, spAtk: 1 }, recoilPct: 0.35 }, statuses: [{ id: 'curse', chance: 0.6 }] }
        ];

        const EMOJI_DESCS = {
            101: 'Found floating in a pool.',
            102: 'It is shit.',
            103: 'Rancid dog bone.',
            104: 'Loves having people over.',
            105: 'You probably have a few of these around.',
            106: 'The matching one is missing.',
            107: 'Trash only because eke doesn\'t like them.',
            108: 'Very expensive form of energy.',
            1: 'Runs a tiny BBQ on weekends.',
            2: 'Slow cooker that loves long naps.',
            3: 'Proud collector of spice blends and grill tools.',
            4: 'Always visiting, never visited.',
            5: 'Roars for attention at karaoke night.',
            61: 'Spicy and impatient, rushes the morning commute.',
            62: 'Grills everything, even marshmallows indoors.',
            64: 'Gruff neighbor who hosts loud cookouts.',
            109: 'Crackling energy, never sits through movies.',
            110: 'Playful spinner who cannot stop fidgeting.',
            146: 'Sharp wit, sharper gardening shears.',
            147: 'Always chomping, never quiet at brunch.',
            148: 'Loud showoff who turns chores into performances.',
            149: 'Rocket confident, leads every road trip.',
            150: 'Stands ground and guards the snack table.',
            151: 'Rowdy host that toasts every small win.',
            152: 'Radiant organizer of the group chat.',
            153: 'Sugary sweet, then suddenly competitive at board games.',
            6: 'Calm skimmer that loves quiet lakes.',
            7: 'Hungry foodie who reviews every soup.',
            8: 'Massive friend who carries everyone\'s bags.',
            9: 'Charmingly tricky, good at surprise parties.',
            10: 'Crushes ice for drinks with steady focus.',
            66: 'Cold and sturdy, keeps the fridge organized.',
            111: 'Lazy current, still moves people along.',
            112: 'Bubbly powerhouse who throws foam parties.',
            113: 'Quick boat that is always on time.',
            154: 'Pinches hard, holds on to coupons.',
            155: 'Loves pinching things at the craft store.',
            156: 'Nimble swimmer, excellent at lap time gossip.',
            157: 'Deflates drama, brings calm tea.',
            158: 'Cute prankster with sudden icy jokes.',
            159: 'Elegant dodger that avoids puddles.',
            160: 'Fast talker, faster texter.',
            161: 'Umbrella helper who blocks every storm.',
            11: 'Earnest helper who volunteers for cleanup.',
            12: 'Wild sprinter who loves forest trails.',
            13: 'Dreamy runner with dazzling art projects.',
            14: 'Stoic host of quiet book clubs.',
            15: 'Cheery flower whose always beaming.',
            70: 'Fluttery artist who drifts through galleries.',
            114: 'Grumpy helper who grumbles but always shows up.',
            115: 'Hyper scout who jogs before breakfast.',
            162: 'Big-hearted pal with thunderous laughs.',
            163: 'Gentle giant who helps move furniture.',
            164: 'Long sight, slow steps, steady handwriting.',
            165: 'Quick zigzag runner who maps every shortcut.',
            166: 'Patient hugger who squeezes just a bit too long.',
            167: 'Slow mover who laughs at traffic.',
            168: 'Prickly pal who still waters your plants.',
            169: 'Charming speedster who always finds parking.',
            16: 'Sparkly sprinter with restless energy.',
            17: 'Calm protector who never panics.',
            18: 'Regal host who demands proper tea.',
            19: 'Glittering keeper with a spotless coat.',
            20: 'Silent watcher who finishes crosswords early.',
            117: 'Immovable soul who waits out long lines.',
            118: 'Gentle scout who ends meetings early.',
            170: 'Graceful dancer who never misses class.',
            171: 'Fearless beacon who lights up night walks.',
            172: 'Colorful runner who paints murals.',
            173: 'Opulent collector who hoards velvet cushions.',
            174: 'Wishmaker who writes kind notes.',
            175: 'Quick thinker who fixes WiFi.',
            176: 'Quiet virtuoso who practices nightly.',
            21: 'Chill shadow who glides through crowds.',
            22: 'Hungry foodie with a smirking bite.',
            23: 'Cold stare, heavy boots, no small talk.',
            24: 'Ghostly runner who haunts late-night streets.',
            120: 'Explosive troublemaker who loves fireworks.',
            121: 'Patient planner who sets clever puzzles.',
            177: 'Deep thinker who swallows pressure.',
            178: 'Curious explorer who collects odd souvenirs.',
            179: 'Silent finisher who cleans the kitchen at midnight.',
            180: 'Bites fast and disappears into naps.',
            181: 'Cryptic sprinter who leaves sticky notes.',
            182: 'Weird genius who builds odd gadgets.',
            183: 'Stage thief who steals the spotlight at open mic.',
            184: 'Slow menace who squeezes stress balls.',
            58: 'Eternal planner who bends schedules.',
            59: 'Endless pal who never tires on hikes.',
            60: 'Peak runner who always chases new trails.',
            185: 'Breakfast buddy, sunny and tough on burnt toast.',
            186: 'Clown of doom who thrives on messy art.',
            187: 'Smooth dodger who improvises every recipe.',
            188: 'Springy prankster who ricochets through hallways.',
            189: 'Quick shot who always gets the photo angle.',
            190: 'Ice-cold host who shuts down spicy rumors.',
            191: 'Plain but solid, holds the umbrella line.',
            192: 'Lazy lunk who rolls through chores.',
            193: 'Heavy lifter who grinds coffee beans.',
            194: 'Douses drama with calm words.',
            195: 'Loud lumberer who chops vegetables first.',
            196: 'Attracts attention, then fires back a joke.',
            197: 'Clever sprinter who packs snacks.',
            198: 'Shining shield that anchors the group photo.',
            199: 'Flash creator with crackling focus.',
            200: 'Tidal cook who overwhelms with portions.',
            201: 'Quiet helper with a hidden shine.',
            202: 'Speedy swimmer, playful but serious about laps.',
            203: 'Ambush napper with a dramatic roll.',
            204: 'Ocean giant who towers over shelves.',
            205: 'Trickster scout who swims in spirals for fun.',
            206: 'Safe refuge that blocks the rain.',
            207: 'Sharp-eyed watcher who spots constellations.',
            208: 'Night scout with silent swoops at midnight snacks.',
            209: 'Pack leader who rallies group hikes.',
            210: 'Hot-tempered cook who stings with chili.',
            211: 'Tiny blur that never stops texting.',
            212: 'Pungent chef that guards leftovers.',
            213: 'Bright sprinter with stubborn grit on runs.',
            214: 'Stout helper with hidden grit in baking.',
            215: 'Always hungry, raids the fridge.',
            216: 'Twisty dancer, hard to pin down.',
            217: 'Dense pal, surprisingly good at puzzles.',
            218: 'Slippery runner, hard to catch at tag.',
            219: 'Comforting pal, steady and stout on hugs.',
            220: 'Sweet-faced baker with a mean bite.',
            221: 'Firework sprinter, all flash at festivals.',
            222: 'Big boom fan who loves bass drops.',
            223: 'Lucky finder who always spots loose change.',
            224: 'Shambling napper, refuses to wake up.',
            225: 'Noble host with velvet manners.',
            226: 'Tireless worker who swarms the garden.',
            227: 'Survivor who never leaves the party early.',
            228: 'Fragile prankster who flutters through rooms.',
            229: 'Sour snacker who guards the candy stash.',
            230: 'Clumsy guard who still catches falling mugs.',
            231: 'Sticky helper that traps dust bunnies.',
            232: 'Quiet flame that watches the sunset.',
            233: 'Night runner who glides under streetlights.',
            234: 'Starfield stargazer, full of awe.',
            235: 'Wants more dinner.',
            236: 'Risky gambler who loves coin flips.',
            237: 'Steady guide, patient and grounded.',
            238: 'Greedy pal, guards the snack stash.',
            239: 'Sly runner, slips through crowds.',
            240: 'Precise baker, hits perfect timings.',
            241: 'Guiding scout, never loses direction.',
            242: 'Frosty host that cools the room.',
            243: 'Relentless slicer, cuts clean sandwiches.',
            244: 'Bubbly speedster, playful and quick.',
            245: 'Meow. You stupid fuck.',
            247: 'Lotus guide, serene and unbreakable.',
            248: 'Breezy mystic, swift and ever-shifting.',
            246: 'Deep reef warden, keeps the tide charts.'
        };

        const DEFAULT_STATE = {
            gold: 1000,
            tickets: 2,
            rareTickets: 0,
            legendaryTickets: 0,
            playerName: '',
            inventory: {},
            team: [],
            stage: 1,
            isAutoBattling: false,
            arenaWinStreak: 0,
            tutorial: {
                step: 0,
                guidedPulls: 0,
                starterId: null,
                allowTeamBuild: false,
                suspended: false,
                completed: false
            },
            tutorPairs: [
                { mentorId: null, studentId: null, progress: 0 },
                { mentorId: null, studentId: null, progress: 0 },
                { mentorId: null, studentId: null, progress: 0 }
            ],
            adventure: {
                regions: [],
                currentRegionId: null,
                progressIndex: 0,
                inBossRush: false,
                bossRushIndex: 0,
                playerTeamState: null,
                awaitingBattle: false,
                inCombat: false,
                activeBattle: null,
                training: false,
                trainingWins: 0
            },
            tutorUnlockedSlots: 1,
            combatMode: 'auto',
            combatSpeed: 2
        };
        let state = { ...DEFAULT_STATE };
        let selectedId = null;
        let currentSlot = 1;
        let manualSelection = null;
        const STARTER_OPTIONS = [4, 155, 15];
        const TUTORIAL_STEPS = { NAME: 0, STARTER: 1, PULL_ONE: 2, PULL_TWO: 3, TEAM: 4, DONE: 5 };

        EMOJIS.forEach(emoji => { emoji.desc = EMOJI_DESCS[emoji.id]; });

        // --- CORE ---
        function init() { loadSlot(resolveInitialSlot()); updateStatsUI(); updateCombatControls(); switchTab('summon'); renderTutorial(); }
        function getSaveKey(slot) { return `emojiSaga_vInfinite_slot${slot}`; }
        function resolveInitialSlot() {
            const stored = parseInt(localStorage.getItem('emojiSaga_vInfinite_slot'), 10);
            const slot = [1, 2, 3].includes(stored) ? stored : 1;
            const legacy = localStorage.getItem('emojiSaga_vInfinite');
            if (legacy && !localStorage.getItem(getSaveKey(1))) {
                localStorage.setItem(getSaveKey(1), legacy);
                localStorage.removeItem('emojiSaga_vInfinite');
            }
            localStorage.setItem('emojiSaga_vInfinite_slot', slot);
            return slot;
        }
        function save() { localStorage.setItem(getSaveKey(currentSlot), JSON.stringify(state)); }
        function loadSlot(slot) {
            currentSlot = slot;
            const saved = localStorage.getItem(getSaveKey(slot));
            const hadSave = !!saved;
            state = { ...DEFAULT_STATE };
            if (saved) {
                state = { ...state, ...JSON.parse(saved) };
                if (state.rareKeys) { state.rareTickets = state.rareKeys; delete state.rareKeys; }
                if (state.legendaryKeys) { state.legendaryTickets = state.legendaryKeys; delete state.legendaryKeys; }
                Object.keys(state.inventory).forEach(id => {
                    if (!state.inventory[id].baseRarity) {
                        const orig = EMOJIS.find(x => x.id == id) || EMOJIS[0];
                        state.inventory[id].baseRarity = orig.rarity;
                        state.inventory[id].currentRarity = orig.rarity;
                    }
                    if (state.inventory[id].dupes === undefined) state.inventory[id].dupes = 0;
                    if (!state.inventory[id].learnedMoves) state.inventory[id].learnedMoves = [];
                });
            }
            if (!state.tutorPairs || !Array.isArray(state.tutorPairs)) {
                state.tutorPairs = DEFAULT_STATE.tutorPairs.map(pair => ({ ...pair }));
            }
            if (state.tutorPairs.length < 3) {
                while (state.tutorPairs.length < 3) state.tutorPairs.push({ mentorId: null, studentId: null, progress: 0 });
            }
            if (!state.adventure || !Array.isArray(state.adventure?.regions)) {
                state.adventure = JSON.parse(JSON.stringify(DEFAULT_STATE.adventure));
            }
            if (!state.adventure.regions.length) {
                state.adventure.regions = generateAdventureRegions();
            }
            state.adventure.regions.forEach(region => {
                if (region.progressIndex === undefined) region.progressIndex = 0;
                if (region.inBossRush === undefined) region.inBossRush = false;
                if (region.bossRushIndex === undefined) region.bossRushIndex = 0;
                if (!region.emoji) {
                    const match = ADVENTURE_REGION_POOLS.find(r => r.pool === region.poolLabel || r.name === region.name);
                    region.emoji = match?.emoji || 'ğŸ§­';
                }
            });
            if (state.adventure.training === undefined) state.adventure.training = false;
            if (state.adventure.trainingWins === undefined) state.adventure.trainingWins = 0;
            if (state.adventure.awaitingBattle === undefined) state.adventure.awaitingBattle = false;
            if (state.adventure.inCombat === undefined) state.adventure.inCombat = false;
            if (state.adventure.activeBattle === undefined) state.adventure.activeBattle = null;
            if (state.adventure.inCombat) {
                state.adventure.inCombat = false;
                state.adventure.activeBattle = null;
                state.adventure.playerTeamState = null;
                state.adventure.awaitingBattle = true;
            }
            if (!state.tutorial) state.tutorial = { ...DEFAULT_STATE.tutorial };
            if (state.tutorial.step === undefined) state.tutorial.step = DEFAULT_STATE.tutorial.step;
            if (state.tutorial.guidedPulls === undefined) state.tutorial.guidedPulls = 0;
            if (state.tutorial.starterId === undefined) state.tutorial.starterId = null;
            if (state.tutorial.allowTeamBuild === undefined) state.tutorial.allowTeamBuild = false;
            if (state.tutorial.suspended === undefined) state.tutorial.suspended = false;
            if (state.tutorial.completed === undefined) state.tutorial.completed = false;
            if (hadSave && Object.keys(state.inventory).length && !state.tutorial.completed && !state.playerName) {
                state.tutorial.completed = true;
                state.tutorial.step = TUTORIAL_STEPS.DONE;
            }
            if (state.tutorUnlockedSlots === undefined) state.tutorUnlockedSlots = 1;
            if (state.arenaWinStreak === undefined) state.arenaWinStreak = 0;
            if (!state.combatMode) state.combatMode = 'auto';
            if (!state.combatSpeed) state.combatSpeed = 2;
            manualSelection = null;
            state.isAutoBattling = false;
            selectedId = null;
            updateSlotUI();
        }

        function updateSlotUI() {}

        function newGameCurrentSlot() {
            if (!confirm(`Start a new game in Slot ${currentSlot}? This will overwrite the current save.`)) return;
            stopAutoBattle();
            localStorage.removeItem(getSaveKey(currentSlot));
            state = { ...DEFAULT_STATE };
            save(); updateStatsUI(); switchTab('summon'); renderTutorial(); closeDataDialog(); toast("NEW GAME");
        }

        function deleteCurrentSlot() {
            if (!confirm(`Delete Slot ${currentSlot}? This cannot be undone.`)) return;
            stopAutoBattle();
            localStorage.removeItem(getSaveKey(currentSlot));
            state = { ...DEFAULT_STATE };
            save(); updateStatsUI(); switchTab('summon'); renderTutorial(); toast("SAVE DELETED");
        }

        function manualSave() {
            save();
            toast('SAVED');
        }

        function updateStatsUI() {
            document.getElementById('stat-gold').innerText = state.gold.toLocaleString();
            document.getElementById('stat-tickets').innerText = state.tickets.toLocaleString();
            document.getElementById('stat-rare-tickets').innerText = state.rareTickets.toLocaleString();
            document.getElementById('stat-legendary-tickets').innerText = state.legendaryTickets.toLocaleString();
            document.getElementById('arena-stage-title').innerText = state.stage;
            document.getElementById('collection-count').innerText = `${Object.keys(state.inventory).length}/${EMOJIS.length}`;
            document.getElementById('player-name').innerText = state.playerName ? state.playerName : 'Traveler';
            document.getElementById('player-region').innerText = getCurrentRegionLabel();
            document.getElementById('header-rare-tickets').classList.toggle('hidden', state.rareTickets <= 0);
            document.getElementById('header-legendary-tickets').classList.toggle('hidden', state.legendaryTickets <= 0);
            document.getElementById('rare-summon-block').classList.toggle('hidden', state.rareTickets <= 0);
            document.getElementById('legendary-summon-block').classList.toggle('hidden', state.legendaryTickets <= 0);
            const arenaBtn = document.getElementById('btn-tab-arena');
            if (arenaBtn) {
                arenaBtn.classList.toggle('hidden', !isArenaUnlocked());
            }
        }

        function getCombatMode() {
            return state.combatMode || 'auto';
        }

        function getCombatSpeed() {
            return state.combatSpeed || 2;
        }

        function cancelManualSelection() {
            if (!manualSelection?.resolve) {
                manualSelection = null;
                return;
            }
            const resolve = manualSelection.resolve;
            manualSelection = null;
            resolve(null);
        }

        function setCombatMode(mode) {
            state.combatMode = mode;
            if (mode === 'auto') cancelManualSelection();
            updateCombatControls();
        }

        function setCombatSpeed(speed) {
            state.combatSpeed = speed;
            updateCombatControls();
        }

        function updateCombatControls() {
            const mode = getCombatMode();
            document.querySelectorAll('[data-combat-mode]').forEach(btn => {
                const isActive = btn.getAttribute('data-combat-mode') === mode;
                btn.classList.toggle('bg-emerald-500/20', isActive);
                btn.classList.toggle('text-emerald-200', isActive);
            });
            document.querySelectorAll('[data-combat-speed]').forEach(btn => {
                const isActive = parseInt(btn.getAttribute('data-combat-speed'), 10) === getCombatSpeed();
                btn.classList.toggle('bg-indigo-500/20', isActive);
                btn.classList.toggle('text-indigo-200', isActive);
            });
            document.querySelectorAll('.combat-speed-group').forEach(group => {
                group.classList.toggle('hidden', mode !== 'auto');
            });
            const arenaStart = document.getElementById('btn-arena-start');
            if (arenaStart) {
                arenaStart.innerText = mode === 'manual' ? 'START BATTLE' : 'AUTO BATTLE';
            }
            renderManualMovePreview(mode);
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`btn-tab-${tab}`).classList.add('tab-active');
            if (tab === 'team') renderTeam();
            if (tab === 'emojidex') renderEmojidex();
            if (tab === 'tutor') renderMoveTutor();
            if (tab === 'adventure') renderAdventure();
            if (tab === 'arena' && !isArenaUnlocked()) {
                switchTab('adventure');
                toast('CLEAR ADVENTURE FIRST');
                return;
            }
            if (state.tutorial?.suspended && tab !== 'summon') {
                state.tutorial.suspended = false;
                save();
            }
            if (isTutorialActive() && state.tutorial.step === TUTORIAL_STEPS.TEAM && tab === 'team') {
                state.tutorial.completed = true;
                state.tutorial.step = TUTORIAL_STEPS.DONE;
                state.tutorial.allowTeamBuild = false;
                save();
            }
            updateCombatControls();
            renderTutorial();
        }

        function getCurrentRegionLabel() {
            const region = state.adventure?.regions?.find(r => r.id === state.adventure.currentRegionId);
            return region ? region.name : 'No Region';
        }

        function isTutorialActive() {
            return state.tutorial && !state.tutorial.completed;
        }

        function isArenaUnlocked() {
            return state.adventure?.regions?.length && state.adventure.regions.every(r => r.cleared);
        }

        function setTutorialHighlights(isActive) {
            const squadBtn = document.getElementById('btn-tab-team');
            const adventureBtn = document.getElementById('btn-tab-adventure');
            const summonBtn = document.getElementById('btn-single-summon');
            const summonView = document.getElementById('view-summon');
            const isPullStep = isActive && (state.tutorial.step === TUTORIAL_STEPS.PULL_ONE || state.tutorial.step === TUTORIAL_STEPS.PULL_TWO);
            const summonVisible = summonView && !summonView.classList.contains('hidden');
            if (squadBtn) squadBtn.classList.toggle('tutorial-highlight', isActive && state.tutorial.step === TUTORIAL_STEPS.TEAM);
            if (adventureBtn) adventureBtn.classList.toggle('tutorial-highlight', isActive && state.tutorial.step === TUTORIAL_STEPS.TEAM);
            if (summonBtn) summonBtn.classList.toggle('tutorial-highlight', isPullStep);
            if (summonView) summonView.classList.toggle('tutorial-dim', isPullStep && summonVisible);
        }

        function renderTutorial() {
            const overlay = document.getElementById('tutorial-overlay');
            const content = document.getElementById('tutorial-content');
            if (!overlay || !content) return;
            if (!isTutorialActive()) {
                overlay.classList.add('hidden');
                setTutorialHighlights(false);
                return;
            }
            if (state.tutorial.suspended) {
                overlay.classList.add('hidden');
                setTutorialHighlights(true);
                return;
            }
            const step = state.tutorial.step;
            if (step === TUTORIAL_STEPS.TEAM && state.tutorial.allowTeamBuild) {
                overlay.classList.add('hidden');
                setTutorialHighlights(true);
                return;
            }
            overlay.classList.remove('hidden');
            setTutorialHighlights(true);
            if (step === TUTORIAL_STEPS.NAME) {
                content.innerHTML = `
                    <div class="text-xs font-black uppercase tracking-[0.2em] text-indigo-300 mb-2">Welcome</div>
                    <h3 class="text-2xl font-black mb-4">What should we call you?</h3>
                    <input id="tutorial-name-input" class="w-full bg-black/60 border border-white/10 rounded-xl px-4 py-3 text-sm text-white mb-4" placeholder="Enter your name" maxlength="20" />
                    <button onclick="submitTutorialName()" class="w-full bg-white text-black py-3 rounded-xl font-black text-xs uppercase">Begin Journey</button>
                `;
                return;
            }
            if (step === TUTORIAL_STEPS.STARTER) {
                const selected = EMOJIS.find(e => e.id === state.tutorial.starterId);
                const preview = selected ? renderStarterPreview(selected) : '<div class="text-[9px] text-slate-500">Select a starter to view details.</div>';
                content.innerHTML = `
                    <div class="flex items-center gap-3 bg-black/40 border border-white/10 rounded-2xl px-3 py-2 mb-4">
                        <div class="text-2xl">ğŸ§™</div>
                        <div class="text-[10px] text-slate-200 font-black uppercase tracking-[0.2em]">Welcome to Emojiland!</div>
                    </div>
                    <div class="text-xs font-black uppercase tracking-[0.2em] text-emerald-300 mb-2">Choose Starter</div>
                    <h3 class="text-xl font-black mb-4">Pick your first ally</h3>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        ${STARTER_OPTIONS.map(id => {
                            const emoji = EMOJIS.find(e => e.id === id);
                            const isSelected = state.tutorial.starterId === id;
                            return `
                                <button onclick="selectStarterChoice(${id})" class="p-3 rounded-2xl border ${isSelected ? 'border-emerald-400 bg-emerald-500/20' : 'border-white/10 bg-black/40 hover:bg-slate-800'} text-center">
                                    <div class="text-3xl ${isSelected ? 'starter-wiggle' : ''}">${emoji.char}</div>
                                    <div class="text-[9px] font-black uppercase mt-1">${emoji.name}</div>
                                </button>
                            `;
                        }).join('')}
                    </div>
                    <div class="bg-black/40 border border-white/10 rounded-2xl p-4 mb-4">${preview}</div>
                    <button onclick="confirmStarterChoice()" class="w-full ${state.tutorial.starterId ? 'bg-emerald-400 text-black' : 'bg-slate-700 text-slate-400'} py-3 rounded-xl font-black text-xs uppercase" ${state.tutorial.starterId ? '' : 'disabled'}>Choose Starter</button>
                `;
                return;
            }
            if (step === TUTORIAL_STEPS.PULL_ONE) {
                content.innerHTML = `
                    <div class="text-xs font-black uppercase tracking-[0.2em] text-indigo-300 mb-2">Portal Basics</div>
                    <h3 class="text-xl font-black mb-3">First Pull</h3>
                    <p class="text-[10px] text-slate-400 mb-4">You have two tickets. Lets pull your first emoji.</p>
                    <button onclick="prepGuidedSummon()" class="w-full bg-white text-black py-3 rounded-xl font-black text-xs uppercase">Go to Portal</button>
                `;
                return;
            }
            if (step === TUTORIAL_STEPS.PULL_TWO) {
                content.innerHTML = `
                    <div class="text-xs font-black uppercase tracking-[0.2em] text-indigo-300 mb-2">Second Pull</div>
                    <h3 class="text-xl font-black mb-3">One More Try</h3>
                    <p class="text-[10px] text-slate-400 mb-4">Aw, bad luck. Lets try pulling again with your remaining ticket.</p>
                    <button onclick="prepGuidedSummon()" class="w-full bg-white text-black py-3 rounded-xl font-black text-xs uppercase">Go to Portal</button>
                `;
                return;
            }
            if (step === TUTORIAL_STEPS.TEAM) {
                content.innerHTML = `
                    <div class="text-xs font-black uppercase tracking-[0.2em] text-amber-300 mb-2">Build Squad</div>
                    <h3 class="text-xl font-black mb-3">Ready for Adventure</h3>
                    <p class="text-[10px] text-slate-400 mb-4">Your team is already assembled. You can manage it later in the 'Squad' tab.</p>
                    <p class="text-[10px] text-slate-400 mb-4">To begin your adventure, head to the 'Adventure' tab.</p>
                    <button onclick="openAdventureForTutorial()" class="w-full bg-amber-400 text-black py-3 rounded-xl font-black text-xs uppercase">Open Adventure</button>
                `;
                return;
            }
            overlay.classList.add('hidden');
        }

        function submitTutorialName() {
            const input = document.getElementById('tutorial-name-input');
            if (!input) return;
            const name = input.value.trim();
            if (!name) { toast('ENTER A NAME'); return; }
            state.playerName = name.slice(0, 20);
            state.tutorial.step = TUTORIAL_STEPS.STARTER;
            save(); updateStatsUI(); renderTutorial();
        }

        function selectStarterChoice(id) {
            state.tutorial.starterId = id;
            save(); renderTutorial();
        }

        function renderStarterPreview(emoji) {
            const previewStats = calcStarterPreviewStats(emoji);
            return `
                <div class="flex items-center gap-3">
                    <div class="text-4xl">${emoji.char}</div>
                    <div>
                        <div class="text-xs font-black uppercase">${emoji.name}</div>
                        <div class="text-[9px] text-slate-400 uppercase tracking-[0.2em]">${emoji.rarity} â€¢ ${emoji.element} â€¢ ${emoji.type}</div>
                        <div class="text-[9px] text-slate-400 mt-2">${emoji.desc}</div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2 text-[9px] text-slate-400 mt-3">
                    <div>HP <span class="text-white">${previewStats.hp}</span></div>
                    <div>ATK <span class="text-white">${previewStats.atk}</span></div>
                    <div>SPD <span class="text-white">${previewStats.spd}</span></div>
                    <div>DEF <span class="text-white">${previewStats.def}</span></div>
                    <div>SP.ATK <span class="text-white">${previewStats.spAtk}</span></div>
                    <div>SP.DEF <span class="text-white">${previewStats.spDef}</span></div>
                </div>
            `;
        }

        function calcStarterPreviewStats(emoji) {
            const baseObj = { hp: 100, atk: 20, spd: 10, def: 15, spAtk: 18, spDef: 15 };
            const weights = TYPE_WEIGHTS[emoji.type];
            let hp = baseObj.hp * weights.hp;
            let atk = baseObj.atk * weights.atk;
            let spd = baseObj.spd * weights.spd;
            let def = baseObj.def * weights.def;
            let spAtk = baseObj.spAtk * weights.spAtk;
            let spDef = baseObj.spDef * weights.spDef;
            const aff = ELEMENT_BONUSES[emoji.element];
            hp *= aff.hp; atk *= aff.atk; spd *= aff.spd; def *= aff.def; spAtk *= aff.spAtk; spDef *= aff.spDef;
            const multCurrent = RARITY_MULTIPLIERS[emoji.rarity];
            hp *= multCurrent; atk *= multCurrent; spd *= multCurrent; def *= multCurrent; spAtk *= multCurrent; spDef *= multCurrent;
            return {
                hp: Math.floor(hp),
                atk: Math.floor(atk),
                spd: Math.floor(spd),
                def: Math.floor(def),
                spAtk: Math.floor(spAtk),
                spDef: Math.floor(spDef)
            };
        }

        function confirmStarterChoice() {
            const id = state.tutorial.starterId;
            if (!id) return;
            if (!state.inventory[id]) {
                const emoji = EMOJIS.find(e => e.id === id);
                state.inventory[id] = { lvl: 1, baseRarity: emoji.rarity, currentRarity: emoji.rarity, dupes: 0, learnedMoves: [] };
            }
            if (!state.team.length) state.team = [id];
            state.tutorial.step = TUTORIAL_STEPS.PULL_ONE;
            save(); updateStatsUI(); renderTeam(); renderTutorial();
        }

        function prepGuidedSummon() {
            if (state.tutorial.step < TUTORIAL_STEPS.PULL_ONE) return;
            state.tutorial.suspended = true;
            document.getElementById('tutorial-overlay').classList.add('hidden');
            switchTab('summon');
            setTutorialHighlights(true);
        }

        function openAdventureForTutorial() {
            state.tutorial.allowTeamBuild = true;
            save();
            document.getElementById('tutorial-overlay').classList.add('hidden');
            switchTab('adventure');
        }

        function finishTutorial() {
            state.tutorial.completed = true;
            state.tutorial.step = TUTORIAL_STEPS.DONE;
            save();
            renderTutorial();
        }

        function openDataDialog() {
            renderDataDialog();
            document.getElementById('data-dialog').classList.remove('hidden');
        }

        function closeDataDialog() {
            document.getElementById('data-dialog').classList.add('hidden');
        }


        function renderDataDialog() {
            const grid = document.getElementById('data-slot-grid');
            if (!grid) return;
            grid.innerHTML = '';
            [1, 2, 3].forEach(slot => {
                const saved = localStorage.getItem(getSaveKey(slot));
                const data = saved ? JSON.parse(saved) : null;
                const name = data?.playerName || (saved ? 'Traveler' : 'Empty');
                const team = (data?.team || []).map(id => (EMOJIS.find(e => e.id === id) || {}).char || 'â”');
                const region = data?.adventure?.regions?.find(r => r.id === data?.adventure?.currentRegionId)?.name || 'No Region';
                const gold = data?.gold ?? 0;
                const tickets = data ? `${data.tickets || 0} / ${data.rareTickets || 0} / ${data.legendaryTickets || 0}` : '-';
                const card = document.createElement('div');
                card.className = `border rounded-2xl p-4 ${slot === currentSlot ? 'border-emerald-400 bg-emerald-500/10' : 'border-white/10 bg-black/30'}`;
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[9px] font-black uppercase tracking-[0.2em]">Slot ${slot}</span>
                        <span class="text-[9px] text-slate-400 uppercase">${saved ? 'Saved' : 'Empty'}</span>
                    </div>
                    <div class="text-sm font-black">${name}</div>
                    <div class="text-[9px] text-slate-400 uppercase tracking-[0.2em] mt-1">Region: ${region}</div>
                    <div class="text-[9px] text-slate-400 uppercase tracking-[0.2em] mt-1">Income: ${gold.toLocaleString()}</div>
                    <div class="text-[9px] text-slate-400 uppercase tracking-[0.2em] mt-1">Tickets: ${tickets}</div>
                    <div class="text-xl mt-2">${team.length ? team.join('') : 'â€”'}</div>
                    <button onclick="confirmLoadSlot(${slot})" class="mt-3 w-full ${slot === currentSlot ? 'bg-slate-700 text-slate-300' : 'bg-indigo-500 text-black'} py-2 rounded-xl text-[9px] font-black uppercase" ${slot === currentSlot ? 'disabled' : ''}>Load</button>
                `;
                grid.appendChild(card);
            });
        }

        function confirmLoadSlot(slot) {
            if (slot === currentSlot) return;
            if (!confirm(`Load Slot ${slot}? Unsaved progress in the current slot will be lost.`)) return;
            stopAutoBattle();
            localStorage.setItem('emojiSaga_vInfinite_slot', slot);
            loadSlot(slot);
            updateStatsUI();
            switchTab('summon');
            renderTutorial();
            renderDataDialog();
        }

        function toast(msg) {
            const t = document.getElementById('toast'); t.innerText = msg; t.classList.replace('opacity-0', 'opacity-100');
            setTimeout(() => t.classList.replace('opacity-100', 'opacity-0'), 2000);
        }

        // --- CALC ---
        function calcStats(id) {
            const e = EMOJIS.find(x => x.id === id) || EMOJIS[0];
            const inv = state.inventory[id];
            const baseObj = { hp: 100, atk: 20, spd: 10, def: 15, spAtk: 18, spDef: 15 };
            const weights = TYPE_WEIGHTS[e.type];
            let hp = baseObj.hp * weights.hp;
            let atk = baseObj.atk * weights.atk;
            let spd = baseObj.spd * weights.spd;
            let def = baseObj.def * weights.def;
            let spAtk = baseObj.spAtk * weights.spAtk;
            let spDef = baseObj.spDef * weights.spDef;
            const aff = ELEMENT_BONUSES[e.element];
            hp *= aff.hp; atk *= aff.atk; spd *= aff.spd; def *= aff.def; spAtk *= aff.spAtk; spDef *= aff.spDef;
            
            const multCurrent = RARITY_MULTIPLIERS[inv.currentRarity];
            const multBase = RARITY_MULTIPLIERS[inv.baseRarity];
            const baseIdx = RARITY_ORDER.indexOf(inv.baseRarity);
            const currentIdx = RARITY_ORDER.indexOf(inv.currentRarity);
            const rarityGap = Math.max(0, currentIdx - baseIdx);
            let rarityModifier = multCurrent * Math.pow(multBase / multCurrent, 0.2);
            if (rarityGap > 2) {
                rarityModifier *= Math.pow(0.8, rarityGap - 2);
            }
            hp *= rarityModifier; atk *= rarityModifier; spd *= rarityModifier; def *= rarityModifier; spAtk *= rarityModifier; spDef *= rarityModifier;
            const growth = 1 + ((inv.lvl - 1) * GROWTH_RATES[inv.currentRarity]);
            return {
                hp: Math.floor(hp * growth),
                atk: Math.floor(atk * growth),
                spd: Math.floor(spd * growth),
                def: Math.floor(def * growth),
                spAtk: Math.floor(spAtk * growth),
                spDef: Math.floor(spDef * growth)
            };
        }

        function calcEnemyStats(emoji, level, rarity) {
            const baseObj = { hp: 100, atk: 20, spd: 10, def: 15, spAtk: 18, spDef: 15 };
            const weights = TYPE_WEIGHTS[emoji.type];
            let hp = baseObj.hp * weights.hp;
            let atk = baseObj.atk * weights.atk;
            let spd = baseObj.spd * weights.spd;
            let def = baseObj.def * weights.def;
            let spAtk = baseObj.spAtk * weights.spAtk;
            let spDef = baseObj.spDef * weights.spDef;
            const aff = ELEMENT_BONUSES[emoji.element];
            hp *= aff.hp; atk *= aff.atk; spd *= aff.spd; def *= aff.def; spAtk *= aff.spAtk; spDef *= aff.spDef;
            const rarityModifier = RARITY_MULTIPLIERS[rarity];
            const growth = 1 + ((level - 1) * GROWTH_RATES[rarity]);
            return {
                hp: Math.floor(hp * rarityModifier * growth),
                atk: Math.floor(atk * rarityModifier * growth),
                spd: Math.floor(spd * rarityModifier * growth),
                def: Math.floor(def * rarityModifier * growth),
                spAtk: Math.floor(spAtk * rarityModifier * growth),
                spDef: Math.floor(spDef * rarityModifier * growth)
            };
        }

        function getMoveById(id) {
            return MOVES.find(move => move.id === id);
        }

        function appendLog(log, html) {
            log.innerHTML += html;
            log.scrollTop = log.scrollHeight;
        }

        function renderCooldowns(unit) {
            if (!unit?.moves?.length) return '';
            return unit.moves.map(id => {
                const move = getMoveById(id);
                if (!move) return '';
                const cd = unit.cooldowns?.[id] ?? 0;
                const status = cd > 0 ? `CD ${cd}` : 'Ready';
                const style = cd > 0 ? 'bg-slate-900/60 text-slate-400' : 'bg-emerald-500/20 text-emerald-200';
                return `<span class="px-2 py-1 rounded-full border border-white/5 ${style}">${move.name} â€¢ ${status}</span>`;
            }).join('');
        }

        function renderManualMoves(unit) {
            if (!unit?.moves?.length) return '';
            const selection = manualSelection?.selections?.[unit.uid];
            const pending = manualSelection?.pending;
            const readyMoves = unit.moves.filter(id => unit.cooldowns?.[id] === 0);
            const canFallbackBasic = !readyMoves.length;
            return unit.moves.map(id => {
                const move = getMoveById(id);
                if (!move) return '';
                const cd = unit.cooldowns?.[id] ?? 0;
                const canSelect = cd === 0 || (id === 'basic_strike' && canFallbackBasic);
                const isSelected = selection?.moveId === id;
                const isPending = pending?.unitUid === unit.uid && pending?.moveId === id;
                const style = !canSelect ? 'bg-slate-900/60 text-slate-500' : isSelected || isPending ? 'bg-emerald-500/30 text-emerald-100' : 'bg-slate-800/60 text-slate-200';
                const status = cd > 0 ? `CD ${cd}` : 'Ready';
                return `<button onclick="selectManualMove('${unit.uid}','${id}')" class="px-2 py-1 rounded-full border border-white/5 ${style}" ${canSelect ? '' : 'disabled'}>${move.name} â€¢ ${status}</button>`;
            }).join('');
        }

        function getManualTargetClass(unit, mode) {
            if (mode !== 'manual') return '';
            const pending = manualSelection?.pending;
            if (!pending) return '';
            const targetTeam = pending.targetTeam;
            if (targetTeam === 'enemy' && unit.isPlayer) return '';
            if (targetTeam === 'ally' && !unit.isPlayer) return '';
            if (unit.hp <= 0) return '';
            return 'cursor-pointer ring-2 ring-emerald-400/60';
        }

        function renderManualTargetButton(unit, mode) {
            if (mode !== 'manual') return '';
            const pending = manualSelection?.pending;
            if (!pending) return '';
            const targetTeam = pending.targetTeam;
            if (targetTeam === 'enemy' && unit.isPlayer) return '';
            if (targetTeam === 'ally' && !unit.isPlayer) return '';
            if (unit.hp <= 0) return '';
            return `<button onclick="selectManualTarget('${unit.uid}')" class="px-2 py-1 rounded-full border border-white/5 bg-emerald-500/30 text-emerald-100">Target</button>`;
        }

        function renderStatusBadge(unit) {
            if (!unit?.status) return '';
            const status = STATUS_BY_ID[unit.status.id];
            const emoji = ELEMENT_METADATA[status?.element]?.emoji || 'âœ¨';
            return `<span class="px-2 py-1 rounded-full border border-white/5 bg-amber-500/20 text-amber-200">${emoji} ${status?.name || unit.status.id}</span>`;
        }

        function renderStatStageBadges(unit) {
            const stages = unit?.statStages || { atk: 0, def: 0, spAtk: 0, spDef: 0, spd: 0 };
            return Object.keys(stages)
                .filter(key => stages[key] && STAT_METADATA[key])
                .map(key => `<span class="px-2 py-1 rounded-full border border-white/5 ${stages[key] > 0 ? 'bg-emerald-500/20 text-emerald-200' : 'bg-rose-500/20 text-rose-200'}">${STAT_METADATA[key].name} ${stages[key] > 0 ? `+${stages[key]}` : stages[key]}</span>`)
                .join('');
        }

        function selectManualMove(unitUid, moveId) {
            const selection = manualSelection;
            if (!selection) return;
            const unit = selection.pUnits.find(u => u.uid === unitUid && u.hp > 0);
            if (!unit) return;
            const move = getMoveById(moveId);
            if (!move) return;
            const readyMoves = unit.moves.filter(id => unit.cooldowns?.[id] === 0);
            const canFallbackBasic = !readyMoves.length;
            const cd = unit.cooldowns?.[moveId] ?? 0;
            const canSelect = cd === 0 || (moveId === 'basic_strike' && canFallbackBasic);
            if (!canSelect) return;
            if (move.target === 'enemy-single' || move.target === 'ally-single') {
                selection.pending = {
                    unitUid,
                    moveId,
                    targetTeam: move.target === 'enemy-single' ? 'enemy' : 'ally'
                };
                selection.selections[unitUid] = { moveId, targetUid: null };
            } else {
                selection.selections[unitUid] = { moveId, targetUid: null };
                selection.pending = null;
            }
            selection.lastMoveId = moveId;
            selection.updateUI?.();
            checkManualSelectionsComplete();
        }

        function selectManualTarget(targetUid) {
            const selection = manualSelection;
            if (!selection?.pending) return;
            const pending = selection.pending;
            const pool = pending.targetTeam === 'enemy' ? selection.eUnits : selection.pUnits;
            const target = pool.find(u => u.uid === targetUid && u.hp > 0);
            if (!target) return;
            selection.selections[pending.unitUid] = { moveId: pending.moveId, targetUid };
            selection.pending = null;
            selection.updateUI?.();
            checkManualSelectionsComplete();
        }

        function checkManualSelectionsComplete() {
            const selection = manualSelection;
            if (!selection) return;
            const alive = selection.pUnits.filter(u => u.hp > 0);
            const allSelected = alive.every(u => selection.selections[u.uid]);
            if (!allSelected || selection.pending) return;
            const resolve = selection.resolve;
            const result = selection.selections;
            manualSelection = null;
            resolve(result);
        }

        function renderManualMovePreview(mode = getCombatMode()) {
            const containers = document.querySelectorAll('.manual-move-preview');
            containers.forEach(container => {
                if (mode !== 'manual') {
                    container.classList.add('hidden');
                    container.innerHTML = '';
                    return;
                }
                container.classList.remove('hidden');
                const moveId = manualSelection?.pending?.moveId || manualSelection?.lastMoveId;
                if (!moveId) {
                    container.innerHTML = `<div class="text-[9px] text-slate-400 uppercase tracking-[0.2em]">Select a move to preview</div>`;
                    return;
                }
                const move = getMoveById(moveId);
                container.innerHTML = move ? renderMoveCardHTML(move) : `<div class="text-[9px] text-slate-400 uppercase tracking-[0.2em]">Move unavailable</div>`;
            });
        }

        function getMoveListForEmoji(emoji, inv = null) {
            const learned = inv?.learnedMoves || [];
            const moveIds = ['basic_strike', getMoveIdForEmoji(emoji), ...learned];
            return [...new Set(moveIds)].map(getMoveById).filter(Boolean);
        }

        function getMoveIdForEmoji(emoji) {
            return emoji.defaultMove || 'basic_strike';
        }

        function attachMoves(unit, learnedMoves = []) {
            const moveId = getMoveIdForEmoji(unit);
            const moveList = ['basic_strike', moveId, ...learnedMoves];
            unit.moves = [...new Set(moveList)];
            unit.cooldowns = {};
            unit.moves.forEach(id => { unit.cooldowns[id] = 0; });
            unit.statStages = { atk: 0, def: 0, spAtk: 0, spDef: 0, spd: 0 };
            unit.status = null;
            unit.cooldownSlowToggle = false;
        }

        function resetBaseStats(unit) {
            unit.baseStats = {
                atk: unit.atk,
                def: unit.def,
                spAtk: unit.spAtk,
                spDef: unit.spDef,
                spd: unit.spd
            };
        }

        function tickCooldowns(unit) {
            if (!unit.cooldowns) return;
            if (unit.status?.id === 'dazzle' && STATUS_RULES.dazzle.cooldownSlow) {
                unit.cooldownSlowToggle = !unit.cooldownSlowToggle;
                if (!unit.cooldownSlowToggle) return;
            }
            Object.keys(unit.cooldowns).forEach(id => {
                if (unit.cooldowns[id] > 0) unit.cooldowns[id] -= 1;
            });
        }

        function pickMove(unit) {
            if (!unit.moves) return null;
            const ready = unit.moves.filter(id => unit.cooldowns[id] === 0);
            if (!ready.length) return null;
            const nonBasic = ready.filter(id => id !== 'basic_strike');
            const pool = nonBasic.length ? nonBasic : ready;
            const pickId = pool[Math.floor(Math.random() * pool.length)];
            return getMoveById(pickId);
        }

        function getEffectivePower(user, move, basePower) {
            if (!move) return basePower;
            if (move.element && move.element === user.element) return Math.floor(basePower * 1.5);
            return basePower;
        }

        function getStageMultiplier(stage) {
            const table = { '-3': 0.34, '-2': 0.5, '-1': 0.67, '0': 1, '1': 1.5, '2': 2.0, '3': 2.5 };
            return table[stage] || 1;
        }

        function getModifiedStat(unit, stat) {
            const base = unit.baseStats?.[stat] ?? unit[stat];
            const stage = unit.statStages?.[stat] ?? 0;
            let value = base * getStageMultiplier(stage);
            if (stat === 'spd' && unit.status?.id === 'rooted') {
                value *= STATUS_RULES.rooted.spdMult;
            }
            return value;
        }

        function calcDamage(attacker, defender, power, move) {
            const effectivePower = getEffectivePower(attacker, move, power);
            const variance = 0.85 + Math.random() * 0.3;
            const isSpecial = move?.damageType === 'special';
            let atkStat = getModifiedStat(attacker, isSpecial ? 'spAtk' : 'atk');
            if (!isSpecial && attacker.status?.id === 'burn') {
                atkStat *= STATUS_RULES.burn.physAtkMult;
            }
            const defStat = Math.max(1, getModifiedStat(defender, isSpecial ? 'spDef' : 'def'));
            const base = atkStat * (effectivePower / 50) * variance;
            const mitigation = 100 / (100 + defStat);
            return Math.max(1, Math.floor(base * mitigation));
        }

        function calcHeal(user, power, move) {
            const effectivePower = getEffectivePower(user, move, power);
            const variance = 0.9 + Math.random() * 0.2;
            return Math.max(1, Math.floor(getModifiedStat(user, 'spAtk') * (effectivePower / 50) * variance));
        }

        function canApplyStatus(target, status, sourceElement) {
            if (!status || target.status) return false;
            if (target.element === sourceElement) return false;
            return true;
        }

        function applyStatuses(user, target, move, log, force = false) {
            const statuses = move?.statuses || [];
            for (const entry of statuses) {
                if (target.status) return;
                const status = STATUS_BY_ID[entry.id];
                if (!status) continue;
                if (!canApplyStatus(target, status, move.element)) continue;
                const chance = force ? 1 : (entry.chance ?? STATUS_APPLY_CHANCE);
                if (!force && Math.random() > chance) continue;
                target.status = { id: status.id, name: status.name, element: move.element };
                if (status.id === 'dazzle') target.cooldownSlowToggle = false;
                appendLog(log, `<div>${target.char} is afflicted with ${status.name}</div>`);
                return;
            }
        }

        function applyStatusTick(unit, log) {
            if (!unit.status) return;
            const rules = STATUS_RULES[unit.status.id];
            if (!rules) return;
            if (rules.tickDamagePct) {
                const dmg = Math.max(1, Math.floor(unit.maxHp * rules.tickDamagePct));
                unit.hp -= dmg;
                appendLog(log, `<div>${unit.char} suffers ${dmg} from ${unit.status.name}</div>`);
            }
            if (rules.tickDrainPct) {
                const dmg = Math.max(1, Math.floor(unit.maxHp * rules.tickDrainPct));
                unit.hp -= dmg;
                appendLog(log, `<div>${unit.char} is drained for ${dmg}</div>`);
            }
        }

        function applyStageChanges(target, stages) {
            if (!stages) return [];
            const changes = [];
            const applyStage = (key, delta, blockPositive) => {
                if (!delta) return;
                if (blockPositive && delta > 0) return;
                const before = target.statStages[key];
                const after = Math.max(-3, Math.min(3, before + delta));
                target.statStages[key] = after;
                const applied = after - before;
                if (applied) changes.push({ key, delta: applied });
            };
            applyStage('atk', stages.atk, target.status?.id === 'dazzle');
            applyStage('def', stages.def, false);
            applyStage('spAtk', stages.spAtk, target.status?.id === 'dazzle');
            applyStage('spDef', stages.spDef, false);
            applyStage('spd', stages.spd, false);
            return changes;
        }

        function applyRecoil(user, dmg, recoilPct, log) {
            if (!recoilPct) return;
            const recoil = Math.max(1, Math.floor(dmg * recoilPct));
            user.hp -= recoil;
            appendLog(log, `<div>${user.char} takes ${recoil} recoil</div>`);
        }

        function applyDrain(user, dmg, drainPct, log) {
            if (!drainPct) return;
            let heal = Math.max(1, Math.floor(dmg * drainPct));
            if (user.status?.id === 'curse') {
                heal = Math.floor(heal * STATUS_RULES.curse.healMult);
            }
            user.hp = Math.min(user.maxHp, user.hp + heal);
            appendLog(log, `<div>${user.char} drains ${heal} HP</div>`);
        }

        function getTargets(move, user, allies, enemies, manualTarget = null) {
            const aliveAllies = allies.filter(u => u.hp > 0);
            const aliveEnemies = enemies.filter(u => u.hp > 0);
            if (move.target === 'self') return [user];
            if (move.target === 'ally-single') {
                if (!aliveAllies.length) return [];
                if (manualTarget && manualTarget.hp > 0) return [manualTarget];
                return [aliveAllies.sort((a, b) => a.hp - b.hp)[0]];
            }
            if (move.target === 'ally-all') return aliveAllies;
            if (move.target === 'enemy-all') return aliveEnemies;
            if (move.target === 'enemy-single') {
                if (!aliveEnemies.length) return [];
                if (manualTarget && manualTarget.hp > 0) return [manualTarget];
                return [aliveEnemies.sort((a, b) => a.hp - b.hp)[0]];
            }
            return [];
        }

        function applyMove(user, move, allies, enemies, log, manualTarget = null) {
            const targets = getTargets(move, user, allies, enemies, manualTarget);
            if (!targets.length) return false;
            if (move.kind === 'status') {
                targets.forEach(target => {
                    applyStatuses(user, target, move, log, true);
                });
                appendLog(log, `<div>${user.char} uses ${move.name}</div>`);
            } else if (move.kind === 'damage') {
                targets.forEach(target => {
                    let dmg = calcDamage(user, target, move.power, move);
                    if (target.status?.id === 'soak') {
                        dmg = Math.floor(dmg * STATUS_RULES.soak.damageAmp);
                        target.status = null;
                        appendLog(log, `<div>${target.char} is soaked!</div>`);
                    }
                    target.hp -= dmg;
                    appendLog(log, `<div>${user.char} uses ${move.name} on ${target.char} for ${Math.floor(dmg)}</div>`);
                    const targetChanges = applyStageChanges(target, move.effect?.targetStages);
                    const selfChanges = applyStageChanges(user, move.effect?.selfStages);
                    if (targetChanges.length) appendLog(log, `<div>${target.char} ${formatStageChangesLog(targetChanges)}</div>`);
                    if (selfChanges.length) appendLog(log, `<div>${user.char} ${formatStageChangesLog(selfChanges)}</div>`);
                    applyRecoil(user, dmg, move.effect?.recoilPct, log);
                    applyDrain(user, dmg, move.effect?.drainPct, log);
                    applyStatuses(user, target, move, log);
                });
            } else if (move.kind === 'heal') {
                targets.forEach(target => {
                    let heal = calcHeal(user, move.power, move);
                    if (target.status?.id === 'curse') {
                        heal = Math.floor(heal * STATUS_RULES.curse.healMult);
                    }
                    target.hp = Math.min(target.maxHp, target.hp + heal);
                    appendLog(log, `<div>${user.char} uses ${move.name} for ${heal} HP</div>`);
                });
            } else if (move.kind === 'buff') {
                targets.forEach(target => {
                    const stages = move.effect?.stages || move.effect?.targetStages || move.effect;
                    const changes = applyStageChanges(target, stages);
                    appendLog(log, `<div>${user.char} uses ${move.name}</div>`);
                    if (changes.length) appendLog(log, `<div>${target.char} ${formatStageChangesLog(changes)}</div>`);
                });
            }
            return true;
        }

        function getArenaPool(stage) {
            const pools = [
                { max: 3, label: 'Trash', weights: { trash: 0.45, common: 0.35, uncommon: 0.15, rare: 0.05 } },
                { max: 7, label: 'Common', weights: { common: 0.38, uncommon: 0.26, rare: 0.22, epic: 0.1, legendary: 0.04 } },
                { max: 14, label: 'Uncommon', weights: { uncommon: 0.3, rare: 0.28, epic: 0.22, legendary: 0.15, divine: 0.05 } },
                { max: 24, label: 'Rare', weights: { rare: 0.35, epic: 0.27, legendary: 0.22, divine: 0.12, eternal: 0.04 } },
                { max: 39, label: 'Epic', weights: { epic: 0.34, legendary: 0.3, divine: 0.22, eternal: 0.14 } },
                { max: 45, label: 'Legendary', weights: { legendary: 0.36, divine: 0.34, eternal: 0.3 } },
                { max: Infinity, label: 'Divine', weights: { divine: 0.55, eternal: 0.45 } }
            ];
            return pools.find(p => stage <= p.max);
        }

        function pickWeightedRarity(stage) {
            const bucket = getArenaPool(stage);
            const roll = Math.random();
            let total = 0;
            for (const [rarity, weight] of Object.entries(bucket.weights)) {
                total += weight;
                if (roll <= total) return rarity;
            }
            return 'common';
        }

        function pickWeightedRarityFromPool(pool) {
            const roll = Math.random();
            let total = 0;
            for (const [rarity, weight] of Object.entries(pool.weights)) {
                total += weight;
                if (roll <= total) return rarity;
            }
            return Object.keys(pool.weights)[0];
        }

        function getAdventurePool(rarity) {
            return ADVENTURE_POOLS.find(pool => pool.maxRarity === rarity) || ADVENTURE_POOLS[0];
        }

        function generateEnemyTeam(stage, poolOverride = null, elementBias = null) {
            let teamSize;
            if (stage < 3) teamSize = 1;
            else if (stage < 6) teamSize = 2;
            else teamSize = 3;

            const baseLevel = Math.min(30, 1 + Math.floor(stage / 3));
            const levelSpread = Math.min(6, Math.floor(stage / 6) + 1);
            const usedIds = new Set();
            const team = [];
            const pool = poolOverride || getArenaPool(stage);

            for (let i = 0; i < teamSize; i++) {
                const rarity = pickWeightedRarityFromPool(pool);
                const rarityPool = EMOJIS.filter(e => e.rarity === rarity && !usedIds.has(e.id));
                const fallbackPool = EMOJIS.filter(e => e.rarity === rarity);
                let choices = rarityPool.length ? rarityPool : fallbackPool;
                if (elementBias) {
                    const biased = choices.filter(e => e.element === elementBias);
                    if (biased.length && Math.random() < 0.65) choices = biased;
                }
                const emoji = choices[Math.floor(Math.random() * choices.length)];
                usedIds.add(emoji.id);
                const level = Math.max(1, baseLevel + Math.floor(Math.random() * levelSpread) - Math.floor(levelSpread / 2));
                const stats = calcEnemyStats(emoji, level, rarity);
                const unit = { ...emoji, ...stats, lvl: level, maxHp: stats.hp, isPlayer: false, currentRarity: rarity };
                attachMoves(unit);
                team.push(unit);
            }
            return team.sort(() => Math.random() - 0.5);
        }

        function getArenaReward(stage) {
            if (stage <= 3) return 80 * stage;
            if (stage <= 7) return 160 * stage;
            if (stage <= 15) return 280 * stage;
            return 400 * stage;
        }

        function generateAdventureRegions() {
            return ADVENTURE_REGION_POOLS.map(region => {
                const poolWeights = getAdventurePool(region.rarity);
                const stage = ADVENTURE_STAGE_BY_RARITY[region.rarity] || 1;
                const opponents = [];
                for (let i = 0; i < 3; i++) {
                    opponents.push(generateEnemyTeam(stage, poolWeights, region.element));
                }
                const bossRush = [];
                for (let i = 0; i < 3; i++) {
                    bossRush.push(generateEnemyTeam(stage, poolWeights, region.element));
                }
                return {
                    id: `region-${region.pool}`,
                    name: region.name,
                    emoji: region.emoji,
                    description: region.desc,
                    poolLabel: region.pool,
                    rarity: region.rarity,
                    element: region.element,
                    cleared: false,
                    progressIndex: 0,
                    inBossRush: false,
                    bossRushIndex: 0,
                    opponents,
                    bossRush
                };
            });
        }

        function getAdventureRegionById(id) {
            return state.adventure.regions.find(region => region.id === id);
        }

        function startAdventureRegion(id) {
            if (!state.team.length) { switchTab('team'); return; }
            if (state.adventure.inCombat) { toast('BATTLE IN PROGRESS'); return; }
            const region = getAdventureRegionById(id);
            if (!region) return;
            state.adventure.currentRegionId = id;
            state.adventure.playerTeamState = null;
            state.adventure.training = region.cleared;
            state.adventure.trainingWins = 0;
            state.adventure.awaitingBattle = !state.adventure.training;
            save();
            updateStatsUI();
            renderAdventure();
            if (state.adventure.training) startAdventureBattle();
        }

        function renderAdventure() {
            const list = document.getElementById('adventure-region-list');
            const clearedCount = state.adventure.regions.filter(r => r.cleared).length;
            document.getElementById('adventure-progress').innerText = `${clearedCount}/${state.adventure.regions.length} Cleared`;
            list.innerHTML = '';
            const nextUnbeaten = state.adventure.regions.find(r => !r.cleared);
            const visibleRegions = state.adventure.regions.filter(region => region.cleared || (nextUnbeaten && region.id === nextUnbeaten.id));
            visibleRegions.forEach(region => {
                const isActive = region.id === state.adventure.currentRegionId;
                let stageLabel = 'Challenger 1';
                if (region.cleared) stageLabel = 'Cleared';
                else if (isActive && region.inBossRush) stageLabel = 'Boss Rush';
                else if (isActive) stageLabel = `Challenger ${region.progressIndex + 1}`;
                const rarityMeta = RARITY_METADATA[region.rarity] || { emoji: 'âšª', name: region.rarity };
                const elementMeta = ELEMENT_METADATA[region.element] || { emoji: 'âœ¨', name: region.element };
                const btn = document.createElement('button');
                btn.className = `w-full text-left px-4 py-3 rounded-2xl border ${region.cleared ? 'bg-black/30 border-white/5 text-slate-400 hover:bg-slate-800/70' : 'bg-slate-800 border-white/10 text-white hover:bg-slate-700'}`;
                btn.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-black uppercase tracking-[0.2em]">${region.emoji} ${region.name}</span>
                        <span class="text-[8px] font-black uppercase ${region.cleared ? 'text-emerald-400' : 'text-amber-300'}">${region.cleared ? 'Cleared â€¢ Train' : region.rarity}</span>
                    </div>
                    <div class="text-[9px] text-slate-400 mt-1">${region.description}</div>
                    <div class="text-[8px] text-slate-500 uppercase tracking-[0.2em] mt-1">${rarityMeta.emoji} ${rarityMeta.name} â€¢ ${elementMeta.emoji} ${elementMeta.name}</div>
                    <div class="text-[8px] text-slate-500 uppercase tracking-[0.2em] mt-1">${stageLabel}</div>
                `;
                if (!state.adventure.inCombat) btn.onclick = () => startAdventureRegion(region.id);
                else {
                    btn.disabled = true;
                    btn.className += ' opacity-40 cursor-not-allowed';
                }
                list.appendChild(btn);
            });
            const active = getAdventureRegionById(state.adventure.currentRegionId);
            document.getElementById('adventure-region-title').innerText = active ? `${active.emoji} ${active.name}` : 'No Region';
            const lobby = document.getElementById('adventure-lobby');
            if (active && !active.cleared && !state.adventure.training) {
                const regionIndex = Math.max(0, state.adventure.regions.findIndex(r => r.id === active.id));
                const baseTable = { trash: 120, common: 180, uncommon: 240, rare: 320, epic: 480, legendary: 650 };
                const baseGold = baseTable[active.rarity] || 200;
                const regionBoost = 1 + (regionIndex * 0.18);
                const scaledGold = Math.floor(baseGold * regionBoost);
                const isEpicPlus = rarityRank(active.rarity) >= rarityRank('epic');
                const regularRewards = isEpicPlus ? '1 Rare Ticket' : '1 Ticket';
                const bossRewards = (() => {
                    if (active.rarity === 'trash') return '2 Tickets';
                    if (active.rarity === 'common') return '3 Tickets';
                    return isEpicPlus ? '1 Legendary Ticket' : '1 Rare Ticket';
                })();
                const trainer = active.inBossRush ? ADVENTURE_BOSS_TRAINERS[active.poolLabel] : null;
                const trainerBlock = trainer ? `
                    <div class="bg-black/40 border border-white/10 rounded-2xl px-4 py-3 mb-4 text-left">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="text-2xl">${trainer.emoji}</div>
                            <div>
                                <div class="text-[8px] text-slate-400 uppercase tracking-[0.2em]">Boss Trainer</div>
                                <div class="text-[10px] font-black uppercase">${trainer.name}</div>
                            </div>
                        </div>
                        <div class="text-[9px] text-slate-300 italic">"${trainer.line}"</div>
                    </div>
                ` : '';
                const rewardBlock = active.inBossRush ? `
                    <div class="bg-black/40 border border-white/10 rounded-2xl px-4 py-3 mb-4 text-left">
                        <div class="text-[8px] text-slate-400 uppercase tracking-[0.2em] mb-2">Boss Rush Completion Rewards</div>
                        <div class="text-[10px] font-black uppercase text-amber-300">${bossRewards}</div>
                        <div class="text-[9px] text-slate-300 mt-1">Gold: ${Math.floor(scaledGold * 3.2).toLocaleString()}</div>
                    </div>
                ` : `
                    <div class="bg-black/40 border border-white/10 rounded-2xl px-4 py-3 mb-4 text-left">
                        <div class="text-[8px] text-slate-400 uppercase tracking-[0.2em] mb-2">Battle Rewards</div>
                        <div class="text-[10px] font-black uppercase text-emerald-300">${regularRewards}</div>
                        <div class="text-[9px] text-slate-300 mt-1">Gold: ${scaledGold.toLocaleString()}</div>
                    </div>
                `;
                lobby.innerHTML = `
                    <div class="text-[70px] mb-3">âš”ï¸</div>
                    <p class="text-[9px] text-slate-400 font-black uppercase tracking-[0.3em] mb-3">${active.inBossRush ? 'Boss Rush - Defeat 3 Teams' : `Challenger ${active.progressIndex + 1}`}</p>
                    ${trainerBlock}
                    ${rewardBlock}
                    <button onclick="startAdventureBattle()" class="bg-emerald-400 text-black px-8 py-3 rounded-2xl font-black text-xs uppercase">Start Battle</button>
                `;
            } else if (!active) {
                lobby.innerHTML = `
                    <div class="text-[80px] mb-3">ğŸ§­</div>
                    <p class="text-[10px] text-slate-400 font-black uppercase tracking-[0.3em]">Select a Region</p>
                `;
            }
        }

        function buildAdventurePlayerTeam() {
            const team = state.team.map(id => {
                const emoji = EMOJIS.find(x => x.id === id);
                const stats = calcStats(id);
                const inv = state.inventory[id];
                const unit = { ...emoji, ...stats, maxHp: stats.hp, isPlayer: true, lvl: inv?.lvl || 1 };
                attachMoves(unit, inv?.learnedMoves || []);
                resetBaseStats(unit);
                return unit;
            });
            return team;
        }

        function startAdventureBattle() {
            const region = getAdventureRegionById(state.adventure.currentRegionId);
            if (!region) return;
            const stageType = state.adventure.training ? 'Training' : (region.inBossRush ? 'Boss Rush' : 'Skirmish');
            document.getElementById('adventure-stage-type').innerText = stageType;
            document.getElementById('adventure-stage-num').innerText = state.adventure.training ? state.adventure.trainingWins + 1 : (region.inBossRush ? region.bossRushIndex + 1 : region.progressIndex + 1);
            state.adventure.awaitingBattle = false;
            state.adventure.inCombat = true;
            state.adventure.activeBattle = { regionId: region.id, training: state.adventure.training };
            const leaveBtn = document.getElementById('adventure-leave-training');
            const modeNote = document.getElementById('adventure-mode-note');
            if (state.adventure.training) {
                leaveBtn.classList.remove('hidden');
                modeNote.innerText = 'Training rewards gold.';
            } else {
                leaveBtn.classList.add('hidden');
                modeNote.innerText = '';
            }
            document.getElementById('adventure-lobby').classList.add('hidden');
            document.getElementById('adventure-combat').classList.remove('hidden');
            if (state.adventure.training) {
                if (!state.adventure.playerTeamState || state.adventure.trainingWins % 3 === 0) {
                    state.adventure.playerTeamState = buildAdventurePlayerTeam();
                }
            } else if (!state.adventure.playerTeamState || !region.inBossRush) {
                state.adventure.playerTeamState = buildAdventurePlayerTeam();
            }
            const enemyTeams = state.adventure.training ? region.opponents : (region.inBossRush ? region.bossRush : region.opponents);
            const enemyTeam = state.adventure.training ? enemyTeams[Math.floor(Math.random() * enemyTeams.length)] : enemyTeams[region.inBossRush ? region.bossRushIndex : region.progressIndex];
            const eUnits = enemyTeam.map(unit => {
                const clone = { ...unit };
                attachMoves(clone, []);
                resetBaseStats(clone);
                return clone;
            });
            runAdventureCombat(state.adventure.playerTeamState, eUnits);
        }

        function leaveAdventureTraining() {
            if (!state.adventure.training) return;
            state.adventure.currentRegionId = null;
            state.adventure.playerTeamState = null;
            state.adventure.training = false;
            state.adventure.trainingWins = 0;
            save();
            updateStatsUI();
            renderAdventure();
            document.getElementById('adventure-lobby').classList.remove('hidden');
            document.getElementById('adventure-combat').classList.add('hidden');
            toast('TRAINING ENDED');
        }

        function renderCombatTeam(units, hpColor, showLevel, mode) {
            return units.map(u => `
                <div class="${u.hp<=0?'opacity-20':''} ${getManualTargetClass(u, mode)}">
                    <div class="flex justify-between items-center font-black uppercase">
                        <span class="flex items-center gap-2">
                            <span class="text-3xl">${u.char}</span>
                            ${showLevel ? `<span class="text-sm text-slate-400">Lv ${u.lvl || 1}</span>` : ''}
                        </span>
                        <span>${Math.max(0,Math.floor(u.hp))}</span>
                    </div>
                    <div class="flex flex-wrap gap-2 mt-1">${renderStatusBadge(u)}${renderStatStageBadges(u)}${renderManualTargetButton(u, mode)}</div>
                    <div class="h-1 bg-black overflow-hidden"><div class="h-full ${hpColor}" style="width:${(u.hp/u.maxHp)*100}%"></div></div>
                    <div class="flex flex-wrap gap-2 mt-2">${mode === 'manual' && u.isPlayer ? renderManualMoves(u) : renderCooldowns(u)}</div>
                </div>
            `).join('');
        }

        function getManualSelections(pUnits, eUnits, updateUI) {
            return new Promise(resolve => {
                manualSelection = {
                    selections: {},
                    pending: null,
                    lastMoveId: null,
                    pUnits,
                    eUnits,
                    resolve,
                    updateUI
                };
                pUnits.forEach(unit => {
                    if (unit.hp <= 0) return;
                    const readyMoves = unit.moves.filter(id => unit.cooldowns?.[id] === 0);
                    if (!readyMoves.length) {
                        manualSelection.selections[unit.uid] = { moveId: 'basic_strike', targetUid: null };
                    }
                });
                updateUI();
                checkManualSelectionsComplete();
            });
        }

        async function runCombat(pUnits, eUnits, options) {
            const {
                logEl,
                roundEl,
                playerEl,
                enemyEl,
                baseDelay = 350,
                isActiveFn = () => true,
                showPlayerLevel = true,
                getMode = getCombatMode
            } = options;
            const battleId = `${Date.now()}-${Math.floor(Math.random() * 10000)}`;
            pUnits.forEach((u, i) => { if (!u.uid) u.uid = `p-${battleId}-${i}`; });
            eUnits.forEach((u, i) => { if (!u.uid) u.uid = `e-${battleId}-${i}`; });
            let round = 1;
            roundEl.innerText = round;
            const updateUI = () => {
                const mode = getMode();
                playerEl.innerHTML = renderCombatTeam(pUnits, 'bg-green-500', showPlayerLevel, mode);
                enemyEl.innerHTML = renderCombatTeam(eUnits, 'bg-red-500', false, mode);
                renderManualMovePreview(mode);
            };
            while (pUnits.some(u => u.hp > 0) && eUnits.some(u => u.hp > 0)) {
                if (!isActiveFn()) return null;
                const mode = getMode();
                const speed = getCombatSpeed();
                const delay = mode === 'auto' && speed === 1 ? baseDelay * 2 : baseDelay;
                updateUI();
                appendLog(logEl, `<div class="text-slate-400">Round ${round}</div>`);
                roundEl.innerText = round;
                let actors = [...pUnits, ...eUnits].filter(u=>u.hp>0).sort((a,b)=>getModifiedStat(b, 'spd') - getModifiedStat(a, 'spd'));
                let manualSelections = null;
                if (mode === 'manual') {
                    manualSelections = await getManualSelections(pUnits, eUnits, updateUI);
                    if (manualSelections === null) continue;
                }
                for (let u of actors) {
                    if (!isActiveFn()) return null;
                    if (u.hp <= 0) continue;
                    applyStatusTick(u, logEl);
                    if (u.hp <= 0) { updateUI(); continue; }
                    tickCooldowns(u);
                    let targets = u.isPlayer ? eUnits.filter(t=>t.hp>0) : pUnits.filter(t=>t.hp>0);
                    if (!targets.length) break;
                    const allies = u.isPlayer ? pUnits : eUnits;
                    const enemies = u.isPlayer ? eUnits : pUnits;
                    let move = null;
                    let manualTarget = null;
                    if (mode === 'manual' && u.isPlayer) {
                        const selection = manualSelections?.[u.uid];
                        move = selection ? getMoveById(selection.moveId) : null;
                        if (selection?.targetUid) {
                            const pool = move?.target === 'ally-single' ? allies : enemies;
                            manualTarget = pool.find(t => t.uid === selection.targetUid) || null;
                        }
                    } else {
                        move = pickMove(u);
                    }
                    if (move) {
                        const used = applyMove(u, move, allies, enemies, logEl, manualTarget);
                        if (used) u.cooldowns[move.id] = move.cooldown;
                    } else {
                        const basic = getMoveById('basic_strike');
                        const dmg = calcDamage(u, targets[0], basic.power, basic);
                        targets[0].hp -= dmg;
                        appendLog(logEl, `<div>${u.char} attacks ${targets[0].char} for ${Math.floor(dmg)}</div>`);
                    }
                    updateUI(); await new Promise(r=>setTimeout(r, delay));
                }
                round += 1;
            }
            return eUnits.every(u => u.hp <= 0);
        }

        async function runAdventureCombat(pUnits, eUnits) {
            const log = document.getElementById('adventure-log');
            log.innerHTML = `<div class="text-white border-b border-white/5 mb-1 pb-1">ADVENTURE</div>`;
            const result = await runCombat(pUnits, eUnits, {
                logEl: log,
                roundEl: document.getElementById('adventure-round-num'),
                playerEl: document.getElementById('adventure-player-team'),
                enemyEl: document.getElementById('adventure-enemy-team'),
                baseDelay: 350,
                getMode: () => state.adventure.training ? 'auto' : getCombatMode()
            });
            if (result === null) return;
            if (result) handleAdventureWin();
            else handleAdventureLoss();
        }

        function handleAdventureWin() {
            const activeBattle = state.adventure.activeBattle || { regionId: state.adventure.currentRegionId, training: state.adventure.training };
            const region = getAdventureRegionById(activeBattle.regionId);
            if (!region) return;
            const isEpicPlus = rarityRank(region.rarity) >= rarityRank('epic');
            const rewardGold = (isBoss) => {
                const table = { trash: 120, common: 180, uncommon: 240, rare: 320, epic: 480, legendary: 650 };
                const base = table[region.rarity] || 200;
                const regionIndex = Math.max(0, state.adventure.regions.findIndex(r => r.id === region.id));
                const regionBoost = 1 + (regionIndex * 0.18);
                const scaled = Math.floor(base * regionBoost);
                return isBoss ? Math.floor(scaled * 3.2) : scaled;
            };
            if (activeBattle.training) {
                const trainingGold = Math.max(1, Math.floor(rewardGold(false) * 0.2));
                state.gold += trainingGold;
                processTutorWin(region.rarity);
                if (state.adventure.training && state.adventure.currentRegionId === region.id) {
                    state.adventure.trainingWins += 1;
                    save();
                    updateStatsUI();
                    startAdventureBattle();
                } else {
                    state.adventure.inCombat = false;
                    state.adventure.activeBattle = null;
                    save();
                    updateStatsUI();
                    renderAdventure();
                    document.getElementById('adventure-lobby').classList.remove('hidden');
                    document.getElementById('adventure-combat').classList.add('hidden');
                }
                return;
            }
            const grantTeamReward = () => {
                const ticketKey = isEpicPlus ? 'rareTickets' : 'tickets';
                state[ticketKey] += 1;
                state.gold += rewardGold(false);
            };
            const grantBossReward = () => {
                if (region.rarity === 'trash') {
                    state.tickets += 2;
                } else if (region.rarity === 'common') {
                    state.tickets += 3;
                } else {
                    const ticketKey = isEpicPlus ? 'legendaryTickets' : 'rareTickets';
                    state[ticketKey] += 1;
                }
                state.gold += rewardGold(true);
            };
            if (region.inBossRush) {
                region.bossRushIndex += 1;
                if (region.bossRushIndex >= region.bossRush.length) {
                    grantBossReward();
                    processTutorWin(region.rarity);
                    region.cleared = true;
                    state.adventure.currentRegionId = null;
                    region.inBossRush = false;
                    region.progressIndex = 0;
                    region.bossRushIndex = 0;
                    state.adventure.playerTeamState = null;
                    state.adventure.awaitingBattle = false;
                    state.adventure.inCombat = false;
                    state.adventure.activeBattle = null;
                    save();
                    updateStatsUI();
                    renderAdventure();
                    document.getElementById('adventure-lobby').classList.remove('hidden');
                    document.getElementById('adventure-combat').classList.add('hidden');
                    toast(`${region.name} CLEARED`);
                    return;
                }
            } else {
                region.progressIndex += 1;
                grantTeamReward();
                processTutorWin(region.rarity);
                if (region.progressIndex >= region.opponents.length) {
                    region.inBossRush = true;
                    region.bossRushIndex = 0;
                }
            }
            state.adventure.inCombat = false;
            state.adventure.activeBattle = null;
            save();
            updateStatsUI();
            if (region.inBossRush && region.bossRushIndex > 0) {
                startAdventureBattle();
            } else {
                state.adventure.awaitingBattle = true;
                renderAdventure();
                document.getElementById('adventure-lobby').classList.remove('hidden');
                document.getElementById('adventure-combat').classList.add('hidden');
            }
        }

        function handleAdventureLoss() {
            const activeBattle = state.adventure.activeBattle || { regionId: state.adventure.currentRegionId, training: state.adventure.training };
            if (activeBattle.training) {
                state.adventure.currentRegionId = null;
                state.adventure.training = false;
                state.adventure.trainingWins = 0;
            }
            const region = getAdventureRegionById(activeBattle.regionId);
            if (region && region.inBossRush) region.bossRushIndex = 0;
            state.adventure.playerTeamState = null;
            state.adventure.awaitingBattle = true;
            state.adventure.inCombat = false;
            state.adventure.activeBattle = null;
            save();
            updateStatsUI();
            renderAdventure();
            document.getElementById('adventure-lobby').classList.remove('hidden');
            document.getElementById('adventure-combat').classList.add('hidden');
            toast('ADVENTURE FAILED');
        }

        function getLevelUpCost(inv) {
            const base = LEVEL_COST_TABLE[inv.currentRarity] || 0;
            const scale = 1 + ((inv.lvl - 1) * (2 / 9));
            return Math.floor(base * scale);
        }

        function getPromoteCost(inv) {
            return PROMOTE_COST_TABLE[inv.currentRarity] || 0;
        }

        function getAscendTarget(inv) {
            const currentIdx = RARITY_ORDER.indexOf(inv.currentRarity);
            const nextRarity = currentIdx > -1 ? RARITY_ORDER[currentIdx + 1] : null;
            if (!nextRarity) return null;
            if (inv.currentRarity === 'false_divine') return null;
            if (nextRarity === 'divine' && !['legendary', 'divine', 'eternal', 'trash'].includes(inv.baseRarity)) {
                return 'false_divine';
            }
            if (nextRarity === 'eternal' && !['divine', 'eternal', 'trash'].includes(inv.baseRarity)) return null;
            return nextRarity;
        }

        function rollRarity(probTable) {
            const rand = Math.random();
            if (rand < probTable.trash) return 'trash';
            if (rand < probTable.common) return 'common';
            if (rand < probTable.uncommon) return 'uncommon';
            if (rand < probTable.rare) return 'rare';
            if (rand < probTable.epic) return 'epic';
            if (rand < probTable.legendary) return 'legendary';
            if (rand < probTable.divine) return 'divine';
            return 'eternal';
        }

        // --- GACHA ---
        async function startSummonSequence(count, summonType = 'standard') {
            const guidedAllowed = isTutorialActive() && state.tutorial.step >= TUTORIAL_STEPS.PULL_ONE;
            const isGuided = guidedAllowed && state.tutorial.guidedPulls < 2;
            if (isGuided && (summonType !== 'standard' || count !== 1)) {
                toast('USE SINGLE SUMMON');
                return;
            }
            if (isTutorialActive() && state.tutorial.step < TUTORIAL_STEPS.PULL_ONE) {
                toast('FINISH SETUP FIRST');
                return;
            }
            if (isGuided) { count = 1; summonType = 'standard'; }
            const typeConfig = {
                standard: { key: 'tickets', probs: PROB_TABLES.standard },
                rare: { key: 'rareTickets', probs: PROB_TABLES.rare },
                legendary: { key: 'legendaryTickets', probs: PROB_TABLES.legendary }
            }[summonType] || { key: 'tickets', probs: PROB_TABLES.standard };
            if (state[typeConfig.key] < count) {
                if (isGuided) state[typeConfig.key] = count;
                else { toast("NO TICKETS!"); return; }
            }
            state[typeConfig.key] -= count; updateStatsUI();
            const results = [];
            for (let i = 0; i < count; i++) {
                let rarity = 'common';
                let emoji = null;
                if (isGuided) {
                    const forcedId = state.tutorial.guidedPulls === 0 ? 101 : 16;
                    emoji = EMOJIS.find(e => e.id === forcedId);
                    rarity = emoji.rarity;
                } else {
                    rarity = rollRarity(typeConfig.probs);
                    const pool = EMOJIS.filter(e => e.rarity === rarity);
                    emoji = pool[Math.floor(Math.random() * pool.length)];
                }
                const isNew = !state.inventory[emoji.id];
                results.push({ emoji, isNew });
                if (isNew) state.inventory[emoji.id] = { lvl: 1, baseRarity: emoji.rarity, currentRarity: emoji.rarity, dupes: 0, learnedMoves: [] };
                else state.inventory[emoji.id].dupes = (state.inventory[emoji.id].dupes || 0) + 1;
                if (isGuided && !state.team.includes(emoji.id)) {
                    if (state.team.length < 3) state.team.push(emoji.id);
                }
            }
            if (isGuided) {
                state.tutorial.guidedPulls += 1;
                state.tutorial.step = state.tutorial.guidedPulls === 1 ? TUTORIAL_STEPS.PULL_TWO : TUTORIAL_STEPS.TEAM;
                state.tutorial.allowTeamBuild = false;
                state.tutorial.suspended = false;
            }
            save(); renderSummonResults(results);
        }

        async function renderSummonResults(results) {
            const overlay = document.getElementById('summon-result-overlay');
            const grid = document.getElementById('summon-grid');
            grid.innerHTML = ''; document.getElementById('btn-summon-close').classList.add('hidden');
            overlay.classList.remove('hidden');
            for (let i = 0; i < results.length; i++) {
                await new Promise(r => setTimeout(r, 100));
                const res = results[i];
                const emoji = res.emoji || res;
                const isNew = !!res.isNew;
                const card = document.createElement('div');
                card.className = `card-base w-28 h-40 rounded-2xl border-2 flex flex-col items-center justify-center p-3 card-reveal rarity-card-${emoji.rarity}`;
                card.innerHTML = `
                    ${isNew ? '<div class="absolute top-2 right-2 bg-emerald-400 text-black text-[7px] font-black px-2 py-1 rounded-full">NEW</div>' : ''}
                    <div class="text-[7px] font-black uppercase mb-1">${emoji.rarity}</div>
                    <div class="text-5xl mb-2">${emoji.char}</div>
                    <div class="text-[9px] font-black text-center uppercase truncate w-full">${emoji.name}</div>
                `;
                grid.appendChild(card);
            }
            document.getElementById('btn-summon-close').classList.remove('hidden');
        }

        function closeSummonResults() {
            document.getElementById('summon-result-overlay').classList.add('hidden');
            if (state.tutorial) state.tutorial.suspended = false;
            renderTutorial();
        }

        // --- TEAM ---
        function renderTeam() {
            const rosterGrid = document.getElementById('roster-grid');
            const teamSlots = document.getElementById('team-slots');
            const lvlBtn = document.getElementById('btn-lvl-up');
            rosterGrid.innerHTML = ''; teamSlots.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const id = state.team[i];
                const slot = document.createElement('div');
                slot.className = "flex-1 rounded-xl border-2 border-dashed border-white/10 bg-white/5 flex items-center justify-center text-3xl";
                if (id) {
                    const inv = state.inventory[id];
                    const e = EMOJIS.find(x => x.id === id) || EMOJIS[0];
                    slot.className = `flex-1 rounded-xl border-2 flex flex-col items-center justify-center gap-1 text-4xl bg-slate-900 cursor-pointer card-base rarity-card-${inv.currentRarity}`;
                    slot.innerHTML = `
                        <div class="text-4xl">${e.char}</div>
                        <div class="text-sm font-black uppercase">Lv ${inv.lvl}</div>
                    `;
                    slot.onclick = () => inspect(id);
                }
                teamSlots.appendChild(slot);
            }
            Object.keys(state.inventory).forEach(idStr => {
                const id = parseInt(idStr);
                const e = EMOJIS.find(x => x.id === id) || EMOJIS[0];
                const inv = state.inventory[id];
                const item = document.createElement('div');
                item.className = `card-base aspect-square rounded-xl border-2 flex flex-col items-center justify-center cursor-pointer transition-transform hover:scale-105 rarity-card-${inv.currentRarity} ${state.team.includes(id) ? 'opacity-30' : ''} ${selectedId === id ? 'ring-2 ring-white' : ''}`;
                item.innerHTML = `<div class="text-2xl">${e.char}</div><div class="text-[7px] font-black">LV.${inv.lvl}</div>`;
                item.onclick = () => inspect(id);
                rosterGrid.appendChild(item);
            });
            if (lvlBtn && !selectedId) {
                lvlBtn.disabled = true;
                lvlBtn.innerText = 'SELECT EMOJI';
            }
        }

        function formatStageChanges(stages) {
            const labels = { atk: 'ATK', def: 'DEF', spAtk: 'SP. ATK', spDef: 'SP. DEF', spd: 'SPD' };
            return Object.entries(stages || {})
                .filter(([key, value]) => labels[key] && value)
                .map(([key, value]) => `${labels[key]} ${value > 0 ? `+${value}` : value}`);
        }

        function formatStageChangesLog(changes) {
            const labels = { atk: 'ATK', def: 'DEF', spAtk: 'SP. ATK', spDef: 'SP. DEF', spd: 'SPD' };
            return `stat changes: ${changes.map(change => `${labels[change.key]} ${change.delta > 0 ? `+${change.delta}` : change.delta}`).join(', ')}`;
        }

        function getEffectTargetLabel(target) {
            const labels = {
                self: 'Self',
                'ally-single': 'Ally',
                'ally-all': 'Allies',
                'enemy-single': 'Target',
                'enemy-all': 'Targets'
            };
            return labels[target] || 'Target';
        }

        function formatMoveEffects(move) {
            const effect = move.effect || {};
            const parts = [];
            if (effect.recoilPct) parts.push(`Recoil for ${Math.round(effect.recoilPct * 100)}% of damage dealt`);
            if (effect.drainPct) parts.push(`Drains ${Math.round(effect.drainPct * 100)}% of damage dealt`);
            if (effect.selfStages) {
                const list = formatStageChanges(effect.selfStages);
                if (list.length) parts.push(`Self ${list.join(', ')}`);
            }
            if (effect.targetStages) {
                const list = formatStageChanges(effect.targetStages);
                if (list.length) parts.push(`Target ${list.join(', ')}`);
            }
            const directStages = effect.stages || Object.fromEntries(
                Object.entries(effect).filter(([key, value]) => ['atk', 'def', 'spAtk', 'spDef', 'spd'].includes(key) && value)
            );
            if (directStages && Object.keys(directStages).length) {
                const list = formatStageChanges(directStages);
                if (list.length) parts.push(`${getEffectTargetLabel(move.target)} ${list.join(', ')}`);
            }
            if (move.statuses?.length) {
                move.statuses.forEach(entry => {
                    const statusMeta = STATUS_BY_ID[entry.id];
                    const name = statusMeta?.name || entry.id;
                    const pct = Math.round((entry.chance ?? 1) * 100);
                    parts.push(`Applies ${name} (${pct}%)`);
                });
            }
            return parts;
        }

        function renderMoveCardHTML(move) {
            const power = (move.kind === 'buff' || move.kind === 'status') ? 'â€”' : move.power;
            const element = move.element ? move.element.toLowerCase() : 'neutral';
            const dmgType = move.damageType ? move.damageType.toLowerCase() : 'status';
            const dmgEmoji = dmgType === 'physical' ? 'ğŸ’¥' : dmgType === 'special' ? 'âœ¨' : 'âšª';
            const targetLabels = {
                'enemy-single': 'Targets one',
                'enemy-all': 'Targets all',
                'ally-single': 'Targets ally',
                'ally-all': 'Targets allies',
                'self': 'Self'
            };
            const target = targetLabels[move.target] || move.target || 'â€”';
            const rarity = (move.rarity || 'common').toLowerCase();
            const rarityEmoji = RARITY_METADATA[rarity]?.emoji || 'âšª';
            const extras = formatMoveEffects(move);
            const elementEmoji = ELEMENT_METADATA[move.element]?.emoji || 'âœ¨';
            return `
                <div class="move-card ${element} ${rarity} ${dmgType}">
                    <div class="flex justify-between items-start gap-2">
                        <div class="font-black uppercase text-[9px] text-slate-100">${rarityEmoji} ${elementEmoji} ${move.name}</div>
                        <div class="text-[8px] text-slate-400 uppercase">CD ${move.cooldown}</div>
                    </div>
                    <div class="flex items-center gap-2 mt-2">
                        <div class="text-[10px] font-black text-white">Power ${power}</div>
                        <div class="move-chip">${dmgEmoji}</div>
                    </div>
                    <div class="flex flex-wrap gap-2 mt-2 text-[7px] text-slate-300 uppercase tracking-[0.2em]">
                        <span class="move-chip">${target}</span>
                    </div>
                    <div class="text-[9px] text-slate-200 mt-2">${extras.length ? extras.join(' â€¢ ') : 'No additional effects'}</div>
                </div>
            `;
        }

        function renderEmojidex() {
            const emojiGrid = document.getElementById('emojidex-emoji-grid');
            const moveList = document.getElementById('emojidex-move-list');
            const statusList = document.getElementById('emojidex-status-list');
            const elementChart = document.getElementById('emojidex-element-chart');
            const ownedIds = new Set(Object.keys(state.inventory).map(id => parseInt(id, 10)));
            const discoveredMoves = new Set(['basic_strike']);
            ownedIds.forEach(id => {
                const moveId = (EMOJIS.find(e => e.id === id) || {}).defaultMove;
                if (moveId) discoveredMoves.add(moveId);
                const learned = state.inventory[id]?.learnedMoves || [];
                learned.forEach(learnedId => discoveredMoves.add(learnedId));
            });

            document.getElementById('emojidex-emoji-count').innerText = `${ownedIds.size}/${EMOJIS.length}`;
            emojiGrid.innerHTML = '';
            EMOJIS.forEach(emoji => {
                const owned = ownedIds.has(emoji.id);
                const card = document.createElement('div');
                card.className = `card-base aspect-square rounded-xl border-2 flex flex-col items-center justify-center text-center ${owned ? `rarity-card-${emoji.rarity}` : 'bg-slate-900/60 border-white/5 text-slate-600'}`;
                card.innerHTML = `
                    <div class="text-xl ${owned ? '' : 'opacity-20'}">${owned ? emoji.char : '?'}</div>
                    <div class="text-[7px] font-black uppercase mt-1">${owned ? emoji.name : '???'}</div>
                `;
                emojiGrid.appendChild(card);
            });

            const discoveredMoveList = MOVES.filter(move => discoveredMoves.has(move.id));
            document.getElementById('emojidex-move-count').innerText = `${discoveredMoveList.length}/${MOVES.length}`;
            moveList.innerHTML = '';
            discoveredMoveList.forEach(move => {
                const row = document.createElement('div');
                row.innerHTML = renderMoveCardHTML(move);
                moveList.appendChild(row);
            });

            if (statusList) {
                statusList.innerHTML = '';
                Object.values(ELEMENT_STATUS_EFFECTS).forEach(status => {
                    const card = document.createElement('div');
                    const elementMeta = ELEMENT_METADATA[status.element] || { emoji: 'âœ¨', name: status.element };
                    card.className = 'bg-black/40 border border-white/10 rounded-2xl p-4';
                    card.innerHTML = `
                        <div class="flex items-center gap-2 mb-2">
                            <div class="text-base">${elementMeta.emoji}</div>
                            <div class="text-[10px] font-black uppercase tracking-widest">${status.name}</div>
                        </div>
                        <div class="text-[9px] text-slate-300 leading-relaxed">${status.desc}</div>
                    `;
                    statusList.appendChild(card);
                });
            }
            if (elementChart) {
                elementChart.innerHTML = '';
                Object.entries(ELEMENTS).forEach(([element, data]) => {
                    const meta = ELEMENT_METADATA[element] || { emoji: 'âœ¨', name: element };
                    const beatsMeta = ELEMENT_METADATA[data.beats] || { emoji: 'âœ¨', name: data.beats };
                    const card = document.createElement('div');
                    card.className = 'bg-black/40 border border-white/10 rounded-2xl p-4';
                    card.innerHTML = `
                        <div class="flex items-center gap-2 mb-2">
                            <div class="text-base">${meta.emoji}</div>
                            <div class="text-[10px] font-black uppercase tracking-widest">${meta.name}</div>
                        </div>
                        <div class="text-[9px] text-slate-300 leading-relaxed">Strong vs ${beatsMeta.emoji} ${beatsMeta.name}</div>
                    `;
                    elementChart.appendChild(card);
                });
            }
        }

        function getTutorRequirement(baseRarity) {
            const table = { trash: 1, common: 2, uncommon: 3, rare: 4, epic: 5, legendary: 6, divine: 7, eternal: 8 };
            return table[baseRarity] || 3;
        }

        function rarityRank(label) {
            return RARITY_ORDER.indexOf(label);
        }

        function processTutorWin(poolLabel) {
            const poolRarity = poolLabel.toLowerCase();
            state.tutorPairs.forEach(pair => {
                if (!pair.mentorId || !pair.studentId) return;
                const mentorMoveId = (EMOJIS.find(e => e.id === pair.mentorId) || {}).defaultMove;
                const mentorMove = getMoveById(mentorMoveId);
                if (!mentorMove) return;
                if (rarityRank(poolRarity) < rarityRank(mentorMove.rarity)) return;
                const studentInv = state.inventory[pair.studentId];
                if (!studentInv) return;
                const studentBase = studentInv.baseRarity || (EMOJIS.find(e => e.id === pair.studentId)?.rarity);
                const requiredWins = getTutorRequirement(studentBase);
                const alreadyKnown = mentorMoveId === getMoveIdForEmoji(EMOJIS.find(e => e.id === pair.studentId) || {}) || (studentInv.learnedMoves || []).includes(mentorMoveId);
                if (alreadyKnown) return;
                if ((studentInv.learnedMoves || []).length >= 2) return;
                pair.progress = Math.min(requiredWins, (pair.progress || 0) + 1);
                if (pair.progress >= requiredWins) {
                    studentInv.learnedMoves = studentInv.learnedMoves || [];
                    studentInv.learnedMoves.push(mentorMoveId);
                    pair.progress = 0;
                    toast(`${EMOJIS.find(e => e.id === pair.studentId)?.name || 'Student'} learned ${mentorMove.name}!`);
                }
            });
        }

        function updateTutorPair(index) {
            const mentorSelect = document.getElementById(`tutor-mentor-${index}`);
            const studentSelect = document.getElementById(`tutor-student-${index}`);
            const mentorId = mentorSelect.value ? parseInt(mentorSelect.value, 10) : null;
            const studentId = studentSelect.value ? parseInt(studentSelect.value, 10) : null;
            state.tutorPairs[index - 1] = { mentorId, studentId, progress: 0 };
            save(); renderMoveTutor();
        }

        function clearTutorPair(index) {
            state.tutorPairs[index - 1] = { mentorId: null, studentId: null, progress: 0 };
            save(); renderMoveTutor();
        }

        function forgetLearnedMove(studentId, moveId) {
            const inv = state.inventory[studentId];
            if (!inv?.learnedMoves) return;
            inv.learnedMoves = inv.learnedMoves.filter(id => id !== moveId);
            save(); renderMoveTutor();
        }

        function renderMoveTutor() {
            const owned = Object.keys(state.inventory).map(id => parseInt(id, 10));
            const options = owned.map(id => {
                const emoji = EMOJIS.find(e => e.id === id);
                return { id, label: `${emoji.char} ${emoji.name}` };
            });
            const slotCosts = [0, 0, 25000, 100000];
            for (let i = 1; i <= 3; i++) {
                const slot = document.getElementById(`tutor-slot-${i}`);
                if (i > state.tutorUnlockedSlots) {
                    const cost = slotCosts[i] || 0;
                    slot.innerHTML = `
                        <div class="text-[9px] font-black uppercase tracking-[0.2em] text-slate-400 mb-3">Pair ${i}</div>
                        <div class="text-[10px] text-slate-500 mb-4">Unlock this mentor slot to train another move at the same time.</div>
                        <button onclick="unlockTutorSlot(${i})" class="w-full bg-amber-400 text-black py-2 rounded-xl text-[9px] font-black uppercase">Unlock â€¢ ${cost.toLocaleString()} Gold</button>
                    `;
                    continue;
                }
                const pair = state.tutorPairs[i - 1] || { mentorId: null, studentId: null, progress: 0 };
                const mentorEmoji = EMOJIS.find(e => e.id === pair.mentorId);
                const studentEmoji = EMOJIS.find(e => e.id === pair.studentId);
                const mentorMoveId = mentorEmoji ? mentorEmoji.defaultMove : null;
                const mentorMove = mentorMoveId ? getMoveById(mentorMoveId) : null;
                const studentInv = studentEmoji ? state.inventory[studentEmoji.id] : null;
                const studentBase = studentInv?.baseRarity || studentEmoji?.rarity;
                const requiredWins = studentBase ? getTutorRequirement(studentBase) : 0;
                const poolNote = mentorMove ? `Need wins vs ${mentorMove.rarity.toUpperCase()}+ pools` : '';
                const learnedMoves = studentInv?.learnedMoves || [];
                const learnedList = learnedMoves.map(id => {
                    const move = getMoveById(id);
                    return `<div class="flex justify-between items-center bg-black/40 rounded-xl px-2 py-1">
                        <span>${move?.name || id}</span>
                        <button onclick="forgetLearnedMove(${studentEmoji.id}, '${id}')" class="text-[8px] uppercase text-red-300">Forget</button>
                    </div>`;
                }).join('');
                const mentorOptions = ['<option value="">Mentor</option>'].concat(options.map(o => `<option value="${o.id}" ${o.id === pair.mentorId ? 'selected' : ''}>${o.label}</option>`)).join('');
                const studentOptions = ['<option value="">Student</option>'].concat(options.map(o => `<option value="${o.id}" ${o.id === pair.studentId ? 'selected' : ''}>${o.label}</option>`)).join('');
                slot.innerHTML = `
                    <div class="text-[9px] font-black uppercase tracking-[0.2em] text-slate-400 mb-3">Pair ${i}</div>
                    <div class="space-y-2 mb-3">
                        <select id="tutor-mentor-${i}" class="w-full bg-slate-900 border border-white/10 rounded-xl px-3 py-2 text-[10px]">${mentorOptions}</select>
                        <select id="tutor-student-${i}" class="w-full bg-slate-900 border border-white/10 rounded-xl px-3 py-2 text-[10px]">${studentOptions}</select>
                    </div>
                    <div class="flex gap-2 mb-3">
                        <button onclick="updateTutorPair(${i})" class="flex-1 bg-emerald-500 text-black py-2 rounded-xl text-[9px] font-black uppercase">Set Pair</button>
                        <button onclick="clearTutorPair(${i})" class="flex-1 bg-slate-700 text-white py-2 rounded-xl text-[9px] font-black uppercase">Clear</button>
                    </div>
                    <div class="text-[9px] text-slate-300 space-y-1">
                        <div><span class="text-slate-500">Mentor Move:</span> ${mentorMove ? `${mentorMove.name} (${mentorMove.rarity.toUpperCase()})` : 'â€”'}</div>
                        <div><span class="text-slate-500">Student Base:</span> ${studentBase ? studentBase.toUpperCase() : 'â€”'}</div>
                        <div><span class="text-slate-500">Progress:</span> ${pair.progress || 0}/${requiredWins} ${poolNote ? `â€¢ ${poolNote}` : ''}</div>
                        <div><span class="text-slate-500">Learned Moves:</span></div>
                        <div class="space-y-1">${learnedList || '<div class="text-slate-500">None</div>'}</div>
                    </div>
                `;
            }
        }

        function unlockTutorSlot(slotIndex) {
            const costTable = { 2: 25000, 3: 100000 };
            const cost = costTable[slotIndex];
            if (!cost) return;
            if (state.gold < cost) { toast('NOT ENOUGH GOLD'); return; }
            if (state.tutorUnlockedSlots >= slotIndex) return;
            state.gold -= cost;
            state.tutorUnlockedSlots = slotIndex;
            save();
            updateStatsUI();
            renderMoveTutor();
        }

        function inspect(id) {
            selectedId = id;
            const e = EMOJIS.find(x => x.id === id) || EMOJIS[0];
            const inv = state.inventory[id];
            const stats = calcStats(id);
            
            document.getElementById('inspect-emoji').innerText = e.char;
            document.getElementById('inspect-name').innerText = e.name;
            document.getElementById('inspect-lvl').innerText = inv.lvl;
            document.getElementById('inspect-hp').innerText = stats.hp.toLocaleString();
            document.getElementById('inspect-atk').innerText = stats.atk.toLocaleString();
            document.getElementById('inspect-spd').innerText = stats.spd.toLocaleString();
            document.getElementById('inspect-def').innerText = stats.def.toLocaleString();
            document.getElementById('inspect-spatk').innerText = stats.spAtk.toLocaleString();
            document.getElementById('inspect-spdef').innerText = stats.spDef.toLocaleString();
            
            // New Badge Logic
            const elBadge = document.getElementById('inspect-element-badge');
            const typeBadge = document.getElementById('inspect-type-badge');
            const elementMeta = ELEMENT_METADATA[e.element] || { emoji: 'â“', name: e.element };
            const typeMeta = TYPE_METADATA[e.type] || { emoji: 'â“', name: e.type };
            elBadge.innerText = `${elementMeta.emoji} ${elementMeta.name}`;
            elBadge.className = `type-badge element-${e.element} font-black`;
            typeBadge.innerText = `${typeMeta.emoji} ${typeMeta.name}`;

            const rarityBadge = document.getElementById('inspect-rarity-badge');
            const currentMeta = RARITY_METADATA[inv.currentRarity] || { emoji: 'âšª', name: inv.currentRarity };
            const baseMeta = RARITY_METADATA[inv.baseRarity] || { emoji: 'âšª', name: inv.baseRarity };
            rarityBadge.innerHTML = `
                <span class="inline-flex items-center gap-2 bg-black/40 px-3 py-1 rounded-full border border-white/10">${currentMeta.emoji} ${currentMeta.name.toUpperCase()}</span>
                <span class="inline-flex items-center gap-2 bg-black/30 px-3 py-1 rounded-full border border-white/10 ml-2">${baseMeta.emoji} NAT ${baseMeta.name.toUpperCase()}</span>
            `;
            rarityBadge.className = `inline-flex flex-wrap items-center gap-2 text-[7px] font-black uppercase mb-4 tracking-widest`;
            document.getElementById('inspect-desc').innerText = e.desc;
            document.getElementById('inspect-dupe-count').innerText = `DUPLICATES: ${inv.dupes || 0}`;
            const moveList = getMoveListForEmoji(e, inv);
            const moveTargetLabels = {
                'enemy-single': 'Targets one',
                'enemy-all': 'Targets all',
                'ally-single': 'Targets ally',
                'ally-all': 'Targets allies',
                'self': 'Self'
            };
            document.getElementById('inspect-moves').innerHTML = moveList.map(move => {
                const power = (move.kind === 'buff' || move.kind === 'status') ? 'â€”' : move.power;
                const element = move.element ? move.element.toLowerCase() : 'neutral';
                const dmgType = move.damageType ? move.damageType.toLowerCase() : 'status';
                const dmgEmoji = dmgType === 'physical' ? 'ğŸ’¥' : dmgType === 'special' ? 'âœ¨' : 'âšª';
                const target = moveTargetLabels[move.target] || move.target;
                const rarity = (move.rarity || 'common').toLowerCase();
                const rarityEmoji = RARITY_METADATA[rarity]?.emoji || 'âšª';
                const extras = formatMoveEffects(move);
                const elementEmoji = ELEMENT_METADATA[move.element]?.emoji || 'âœ¨';
                return `
                    <div class="move-card ${element} ${rarity} ${dmgType}">
                        <div class="flex justify-between items-start gap-2">
                            <div class="font-black uppercase text-[9px] text-slate-100">${rarityEmoji} ${elementEmoji} ${move.name}</div>
                            <div class="text-[8px] text-slate-400 uppercase">CD ${move.cooldown}</div>
                        </div>
                        <div class="flex items-center gap-2 mt-2">
                            <div class="text-[10px] font-black text-white">Power ${power}</div>
                            <div class="move-chip">${dmgEmoji}</div>
                        </div>
                        <div class="flex flex-wrap gap-2 mt-2 text-[7px] text-slate-300 uppercase tracking-[0.2em]">
                            <span class="move-chip">${target}</span>
                        </div>
                        <div class="text-[9px] text-slate-200 mt-2">${extras.length ? extras.join(' â€¢ ') : 'No additional effects'}</div>
                    </div>
                `;
            }).join('');
            
            const lvlCost = getLevelUpCost(inv);
            const lvlBtn = document.getElementById('btn-lvl-up');
            lvlBtn.disabled = (state.gold < lvlCost || inv.lvl >= 10);
            lvlBtn.innerText = inv.lvl >= 10 ? "MAX LEVEL" : `UPGRADE (${lvlCost.toLocaleString()} GOLD)`;
            const targetRarity = getAscendTarget(inv);
            const canPromote = inv.lvl >= 10 && !!targetRarity;
            const promoteBtn = document.getElementById('btn-promote');
            if (canPromote) {
                const promoteCost = getPromoteCost(inv);
                promoteBtn.classList.remove('hidden');
                promoteBtn.disabled = state.gold < promoteCost;
                promoteBtn.innerText = `ASCEND (${promoteCost.toLocaleString()} GOLD)`;
            } else promoteBtn.classList.add('hidden');
            document.getElementById('btn-add-team').innerText = state.team.includes(id) ? "WITHDRAW" : "DEPLOY";
            renderTeam();
        }

        function levelUpSelected() {
            if (!selectedId) return;
            const inv = state.inventory[selectedId];
            const cost = getLevelUpCost(inv);
            if (state.gold >= cost && inv.lvl < 10) { state.gold -= cost; inv.lvl++; save(); inspect(selectedId); updateStatsUI(); }
        }

        function promoteSelected() {
            if (!selectedId) return;
            const inv = state.inventory[selectedId];
            const cost = getPromoteCost(inv);
            const targetRarity = getAscendTarget(inv);
            if (targetRarity) {
                if (state.gold < cost) return;
                state.gold -= cost; inv.currentRarity = targetRarity; inv.lvl = 1;
                save(); inspect(selectedId); updateStatsUI(); toast("ASCENDED!");
            }
        }

        function toggleSelectedTeam() {
            if (!selectedId) return;
            const idx = state.team.indexOf(selectedId);
            state.stage = 1; stopAutoBattle();
            if (idx > -1) state.team.splice(idx, 1);
            else if (state.team.length < 3) state.team.push(selectedId);
            save(); updateStatsUI(); inspect(selectedId);
        }

        // --- ARENA ---
        function toggleAutoBattle() {
            if (!state.team.length) { switchTab('team'); return; }
            if (!isArenaUnlocked()) { switchTab('adventure'); toast('CLEAR ADVENTURE FIRST'); return; }
            state.isAutoBattling = true;
            switchTab('arena');
            startAutoCycle();
        }
        function stopAutoBattle() {
            state.isAutoBattling = false;
            document.getElementById('arena-lobby').classList.remove('hidden');
            document.getElementById('arena-combat').classList.add('hidden');
            document.getElementById('arena-info-bar').classList.add('hidden');
        }

        async function startAutoCycle() {
            if (!state.isAutoBattling) return;
            document.getElementById('arena-lobby').classList.add('hidden');
            document.getElementById('arena-combat').classList.remove('hidden');
            document.getElementById('arena-info-bar').classList.remove('hidden');
            const log = document.getElementById('battle-log');
            document.getElementById('combat-stage-num').innerText = state.stage;
            document.getElementById('arena-info-stage').innerText = state.stage;
            log.innerHTML = `<div class="text-white border-b border-white/5 mb-1 pb-1">STAGE ${state.stage}</div>`;
            document.getElementById('combat-round-num').innerText = 1;
            
            let pUnits = state.team.map(id => {
                const emoji = EMOJIS.find(x => x.id === id);
                const stats = calcStats(id);
                const inv = state.inventory[id];
                const unit = { ...emoji, ...stats, maxHp: stats.hp, isPlayer: true, lvl: inv?.lvl || 1 };
                attachMoves(unit, inv?.learnedMoves || []);
                return unit;
            });
            let eUnits = generateEnemyTeam(state.stage);
            const pool = getArenaPool(state.stage);
            document.getElementById('combat-enemy-title').innerText = `${pool.label.toUpperCase()} POOL â€¢ ${getEnemyTitle(eUnits)}`;
            pUnits.forEach(resetBaseStats);
            eUnits.forEach(resetBaseStats);
            const result = await runCombat(pUnits, eUnits, {
                logEl: log,
                roundEl: document.getElementById('combat-round-num'),
                playerEl: document.getElementById('battle-player-team'),
                enemyEl: document.getElementById('battle-enemy-team'),
                baseDelay: 450,
                isActiveFn: () => state.isAutoBattling
            });
            if (result === null) return;
            if (result) {
                const pool = getArenaPool(state.stage);
                state.gold += getArenaReward(state.stage);
                processTutorWin(pool.label);
                state.stage++;
                state.arenaWinStreak = (state.arenaWinStreak || 0) + 1;
                if (state.arenaWinStreak >= 3) {
                    pUnits.forEach(unit => {
                        unit.hp = unit.maxHp;
                        unit.cooldowns = Object.fromEntries((unit.moves || []).map(id => [id, 0]));
                        unit.status = null;
                        unit.statStages = { atk: 0, def: 0, spAtk: 0, spDef: 0, spd: 0 };
                        resetBaseStats(unit);
                    });
                    state.arenaWinStreak = 0;
                }
                save(); updateStatsUI(); setTimeout(startAutoCycle, 1500);
            } else {
                state.stage = 1; state.arenaWinStreak = 0; save(); updateStatsUI(); setTimeout(startAutoCycle, 800);
            }
        }

        function buyTickets(type, amount, cost) {
            if (state.gold < cost) { toast("NO GOLD!"); return; }
            const ticketType = type === 'rare' ? 'rareTickets' : type === 'legendary' ? 'legendaryTickets' : 'tickets';
            state.gold -= cost; state[ticketType] += amount; save(); updateStatsUI(); toast("BOUGHT!");
        }

        window.onload = init;
    </script>
</body>
</html>
