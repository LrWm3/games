<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Emoji Saga: 150 Heroes</title>
    
    <meta name="game-description" content="Ultimate Emoji Gacha. 150 unique heroes, Trash-to-Eternal ascension, and elemental strategy.">
    <meta name="game-tags" content="gacha, rpg, emoji, card-game, strategy, auto-battle, ascension, collection">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        
        :root {
            --trash: #78350f;
            --common: #64748b;
            --rare: #3b82f6;
            --epic: #a855f7;
            --legendary: #f59e0b;
            --divine: #ef4444;
            --eternal-start: #ff0000;
            --fire: #ef4444;
            --water: #3b82f6;
            --nature: #22c55e;
            --light: #fde047;
            --dark: #a855f7;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background: #020617;
            color: white;
            overflow-x: hidden;
            user-select: none;
            touch-action: manipulation;
        }

        /* --- RARITY CARD STYLES --- */
        .card-base { transition: all 0.2s ease; position: relative; overflow: hidden; border-width: 2px; }
        .rarity-card-trash { background: linear-gradient(135deg, #2d1a12, #1a0f0a); border-color: #442b1d; color: #78716c; }
        .rarity-card-common { background: linear-gradient(135deg, #1e293b, #0f172a); border-color: #475569; }
        .rarity-card-rare { background: linear-gradient(135deg, #172554, #1e3a8a); border-color: #3b82f6; box-shadow: inset 0 0 10px rgba(59, 130, 246, 0.3); }
        .rarity-card-epic { background: linear-gradient(135deg, #4c1d95, #581c87); border-color: #a855f7; box-shadow: 0 0 15px rgba(168, 85, 247, 0.2); }
        .rarity-card-legendary { background: linear-gradient(135deg, #78350f, #451a03); border-color: #f59e0b; box-shadow: 0 0 20px rgba(245, 158, 11, 0.4); }
        
        @keyframes divine-pulse { 0%, 100% { box-shadow: 0 0 10px #ef4444; } 50% { box-shadow: 0 0 25px #ef4444; } }
        .rarity-card-divine { background: linear-gradient(135deg, #7f1d1d, #450a0a); border-color: #ef4444; animation: divine-pulse 2s infinite; }

        @keyframes eternal-bg { 0% { border-color: #ff0000; box-shadow: 0 0 20px #ff0000; } 33% { border-color: #00ff00; box-shadow: 0 0 20px #00ff00; } 66% { border-color: #0000ff; box-shadow: 0 0 20px #0000ff; } 100% { border-color: #ff0000; box-shadow: 0 0 20px #ff0000; } }
        .rarity-card-eternal { background: linear-gradient(45deg, #0f172a, #334155); border-width: 3px; animation: eternal-bg 4s linear infinite; }

        .tab-active { background: #4f46e5 !important; color: white !important; box-shadow: 0 0 15px rgba(79, 70, 229, 0.4); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .card-reveal { animation: card-reveal 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes card-reveal { 0% { transform: scale(0.5) rotateY(90deg); opacity: 0; } 100% { transform: scale(1) rotateY(0); opacity: 1; } }

        .element-fire { color: var(--fire); }
        .element-water { color: var(--water); }
        .element-nature { color: var(--nature); }
        .element-light { color: var(--light); }
        .element-dark { color: var(--dark); }
        
        .type-badge { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; padding: 2px 8px; border-radius: 999px; background: rgba(0,0,0,0.3); border: 1px border-white/10; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-slate-900/95 backdrop-blur-md border-b border-white/10 p-3 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="text-2xl">üåç</span>
                <div class="leading-none">
                    <h1 class="text-lg font-bold uppercase tracking-tight">Emoji Saga</h1>
                    <span class="text-[8px] text-indigo-400 font-black uppercase tracking-[0.2em]">150 Heroes Update</span>
                </div>
            </div>
            <div class="flex gap-2">
                <div class="bg-black/40 px-3 py-1.5 rounded-full border border-yellow-500/30 flex items-center gap-2 text-xs">
                    <i class="fas fa-coins text-yellow-500"></i>
                    <span id="stat-gold" class="font-bold">0</span>
                </div>
                <div class="bg-black/40 px-3 py-1.5 rounded-full border border-indigo-500/30 flex items-center gap-2 text-xs">
                    <i class="fas fa-ticket text-indigo-400"></i>
                    <span id="stat-tickets" class="font-bold">0</span>
                </div>
            </div>
        </div>
    </header>

    <nav class="bg-slate-900 border-b border-white/5 p-1 flex justify-center gap-1 sticky top-[61px] z-40 overflow-x-auto no-scrollbar">
        <button onclick="switchTab('summon')" id="btn-tab-summon" class="flex-shrink-0 px-4 py-2 rounded-xl text-[10px] font-bold uppercase bg-slate-800 text-slate-400">Portal</button>
        <button onclick="switchTab('team')" id="btn-tab-team" class="flex-shrink-0 px-4 py-2 rounded-xl text-[10px] font-bold uppercase bg-slate-800 text-slate-400">Squad</button>
        <button onclick="switchTab('arena')" id="btn-tab-arena" class="flex-shrink-0 px-4 py-2 rounded-xl text-[10px] font-bold uppercase bg-slate-800 text-slate-400">Arena</button>
        <button onclick="switchTab('shop')" id="btn-tab-shop" class="flex-shrink-0 px-4 py-2 rounded-xl text-[10px] font-bold uppercase bg-slate-800 text-slate-400">Market</button>
    </nav>

    <main class="flex-grow container mx-auto max-w-5xl p-4 mb-20">
        
        <!-- Portal -->
        <section id="view-summon" class="tab-content py-4 text-center">
            <div class="relative max-w-xs mx-auto aspect-square flex flex-col items-center justify-center mb-10 overflow-hidden rounded-full border border-white/5 shadow-2xl">
                <div class="absolute inset-0 bg-gradient-to-b from-indigo-500/10 to-transparent"></div>
                <div class="text-[100px] opacity-10 absolute animate-pulse">üëë</div>
                <div class="relative z-10">
                    <h2 class="text-2xl font-black mb-1 italic">THE WORLD GATE</h2>
                    <p class="text-[9px] text-indigo-400 font-bold mb-4 tracking-[0.4em]">DISCOVER 150 HEROES</p>
                    <div class="inline-block bg-black/60 px-4 py-1.5 rounded-full border border-white/10 text-[10px]">
                        Pity: <span id="pity-count" class="text-yellow-400">0/50</span>
                    </div>
                </div>
            </div>
            <div class="flex flex-col gap-4 max-w-xs mx-auto">
                <button onclick="startSummonSequence(1)" class="bg-white text-black py-4 rounded-2xl font-black text-xs hover:scale-105 active:scale-95 transition-all">SINGLE SUMMON</button>
                <button onclick="startSummonSequence(10)" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-2xl font-black text-xs shadow-xl active:scale-95 border-b-4 border-indigo-900 transition-all">MULTI SUMMON (10x)</button>
            </div>
        </section>

        <!-- Squad -->
        <section id="view-team" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 space-y-4">
                    <div id="team-slots" class="grid grid-cols-3 gap-3 h-28 mb-6"></div>
                    <div class="flex justify-between items-center border-b border-white/10 pb-2">
                        <h3 class="text-xs font-black uppercase tracking-widest">Collection</h3>
                        <div class="text-[9px] bg-slate-800 px-3 py-1 rounded-full" id="collection-count">0/150</div>
                    </div>
                    <div id="roster-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-2 max-h-[450px] overflow-y-auto custom-scrollbar p-1"></div>
                </div>

                <!-- Inspect Panel -->
                <div id="inspect-panel" class="bg-slate-900 border border-white/10 rounded-[2.5rem] p-6 h-fit sticky top-40 shadow-2xl">
                    <div id="inspect-content" class="text-center">
                        <div id="inspect-emoji" class="text-7xl mb-4 drop-shadow-2xl">‚ùì</div>
                        <h4 id="inspect-name" class="text-xl font-black mb-1 leading-none">Hero Name</h4>
                        
                        <div class="flex justify-center gap-2 mb-4">
                             <div id="inspect-type-badge" class="type-badge text-white">TYPE</div>
                             <div id="inspect-element-badge" class="type-badge">ELEMENT</div>
                        </div>

                        <div id="inspect-rarity-badge" class="inline-block px-3 py-1 rounded-full text-[7px] font-black uppercase mb-6 tracking-[0.2em] border">RARITY</div>
                        
                        <div class="grid grid-cols-2 gap-2 text-left mb-6">
                            <div class="bg-black/40 p-2.5 rounded-2xl border border-white/5"><p class="text-[7px] text-slate-500 uppercase">LV</p><span class="font-bold text-sm" id="inspect-lvl">0</span></div>
                            <div class="bg-black/40 p-2.5 rounded-2xl border border-white/5"><p class="text-[7px] text-green-500 uppercase">HP</p><span class="font-bold text-sm" id="inspect-hp">0</span></div>
                            <div class="bg-black/40 p-2.5 rounded-2xl border border-white/5"><p class="text-[7px] text-red-500 uppercase">ATK</p><span class="font-bold text-sm" id="inspect-atk">0</span></div>
                            <div class="bg-black/40 p-2.5 rounded-2xl border border-white/5"><p class="text-[7px] text-blue-500 uppercase">SPD</p><span class="font-bold text-sm" id="inspect-spd">0</span></div>
                        </div>

                        <div class="space-y-2">
                            <button id="btn-lvl-up" onclick="levelUpSelected()" class="w-full bg-green-600 hover:bg-green-700 py-3.5 rounded-2xl font-black text-xs transition-all disabled:opacity-20">UPGRADE</button>
                            <button id="btn-promote" onclick="promoteSelected()" class="w-full bg-amber-500 hover:bg-amber-600 py-3.5 rounded-2xl font-black text-xs hidden transition-all">ASCEND</button>
                            <button id="btn-add-team" onclick="toggleSelectedTeam()" class="w-full bg-indigo-600 hover:bg-indigo-700 py-3.5 rounded-2xl font-black text-xs transition-all disabled:opacity-20">DEPLOY</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Arena -->
        <section id="view-arena" class="tab-content hidden">
            <div id="arena-lobby" class="text-center py-10">
                <div class="text-[100px] mb-4">üèÜ</div>
                <h2 class="text-3xl font-black mb-2 uppercase">Infinite Arena</h2>
                <div class="bg-slate-900 border border-indigo-500/30 p-6 rounded-[2rem] max-w-xs mx-auto mb-8 shadow-2xl">
                    <p class="text-[10px] text-indigo-400 font-black uppercase mb-1">Current Stage</p>
                    <p id="arena-stage-title" class="text-6xl font-black italic">1</p>
                </div>
                <button onclick="toggleAutoBattle()" class="bg-red-600 hover:bg-red-500 text-white px-16 py-5 rounded-3xl font-black text-xl shadow-2xl active:scale-95 transition-all">AUTO BATTLE</button>
            </div>

            <div id="arena-combat" class="hidden max-w-lg mx-auto bg-slate-900/50 p-6 rounded-[2.5rem] border border-white/5 relative">
                <div id="combat-flash-layer" class="absolute inset-0 pointer-events-none rounded-[2.5rem] z-10"></div>
                <div class="flex justify-between items-center mb-6">
                    <span class="text-xs font-black text-red-400 uppercase tracking-widest">Stage <span id="combat-stage-num">1</span></span>
                    <button onclick="stopAutoBattle()" class="text-[9px] font-black text-slate-500 underline uppercase">Abort</button>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div id="battle-player-team" class="space-y-3"></div>
                    <div id="battle-enemy-team" class="space-y-3"></div>
                </div>
                <div id="battle-log" class="mt-6 bg-black h-44 rounded-2xl p-4 overflow-y-auto custom-scrollbar flex flex-col-reverse text-[9px] font-mono border border-white/5"></div>
            </div>
        </section>

        <!-- Shop -->
        <section id="view-shop" class="tab-content hidden py-6">
            <div class="text-center mb-10"><h2 class="text-3xl font-black uppercase">Market</h2></div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-xl mx-auto">
                <div class="bg-slate-900 p-8 rounded-3xl border border-white/5 text-center flex flex-col items-center">
                    <h3 class="font-black text-lg mb-4 uppercase">1 Key</h3>
                    <button onclick="buyTickets(1, 1000)" class="w-full bg-indigo-600 py-3 rounded-xl font-black text-xs">1,000 GOLD</button>
                </div>
                <div class="bg-slate-900 p-8 rounded-3xl border border-indigo-500/30 text-center flex flex-col items-center">
                    <h3 class="font-black text-lg mb-4 uppercase">10 Keys</h3>
                    <button onclick="buyTickets(10, 8500)" class="w-full bg-indigo-600 py-3 rounded-xl font-black text-xs">8,500 GOLD</button>
                </div>
            </div>
        </section>

    </main>

    <!-- Results Overlay -->
    <div id="summon-result-overlay" class="fixed inset-0 z-[100] bg-black/98 flex flex-col hidden overflow-hidden">
        <div class="flex-shrink-0 p-8 text-center"><h2 class="text-2xl font-black italic tracking-tighter">PORTAL SUMMONS</h2></div>
        <div id="summon-grid" class="flex-grow overflow-y-auto px-6 py-4 flex flex-wrap justify-center content-start gap-4 custom-scrollbar"></div>
        <div class="flex-shrink-0 p-10 flex justify-center bg-black/80"><button onclick="closeSummonResults()" id="btn-summon-close" class="hidden bg-white text-black px-16 py-5 rounded-2xl font-black active:scale-95 transition-all">CONTINUE</button></div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 px-6 py-3 bg-white text-black text-[10px] rounded-full font-black shadow-2xl opacity-0 transition-all duration-500 z-[300] uppercase tracking-widest">NOTIFY</div>

    <script>
        // --- MASTER DATA (150 TOTAL) ---
        const EMOJIS = [
            // TRASH (8)
            { id: 101, char: 'üóëÔ∏è', name: 'Tin Can', rarity: 'trash', element: 'dark', type: 'Tank' },
            { id: 102, char: 'üí©', name: 'Nugget', rarity: 'trash', element: 'nature', type: 'Striker' },
            { id: 103, char: 'ü¶¥', name: 'Old Bone', rarity: 'trash', element: 'dark', type: 'Striker' },
            { id: 104, char: 'üèöÔ∏è', name: 'Shack', rarity: 'trash', element: 'nature', type: 'Tank' },
            { id: 105, char: 'üëû', name: 'Old Boot', rarity: 'trash', element: 'water', type: 'Speedster' },
            { id: 106, char: 'üß¶', name: 'Stray Sock', rarity: 'trash', element: 'light', type: 'Speedster' },
            { id: 107, char: 'üçå', name: 'Peel', rarity: 'trash', element: 'nature', type: 'Speedster' },
            { id: 108, char: 'üîã', name: 'Dead Cell', rarity: 'trash', element: 'light', type: 'Striker' },
            // FIRE (25)
            { id: 1, char: 'üî•', name: 'Inferno', rarity: 'rare', element: 'fire', type: 'Striker' },
            { id: 2, char: 'üåã', name: 'Magma', rarity: 'epic', element: 'fire', type: 'Tank' },
            { id: 3, char: 'üêâ', name: 'Drake', rarity: 'legendary', element: 'fire', type: 'Striker' },
            { id: 4, char: '‚òÑÔ∏è', name: 'Comet', rarity: 'common', element: 'fire', type: 'Striker' },
            { id: 5, char: 'ü¶Å', name: 'Leonis', rarity: 'epic', element: 'fire', type: 'Striker' },
            { id: 61, char: 'üå∂Ô∏è', name: 'Pepper', rarity: 'common', element: 'fire', type: 'Speedster' },
            { id: 62, char: 'ü•ì', name: 'Sizzle', rarity: 'common', element: 'fire', type: 'Tank' },
            { id: 64, char: 'üë∫', name: 'Oni', rarity: 'legendary', element: 'fire', type: 'Striker' },
            { id: 109, char: 'üß®', name: 'Dynamo', rarity: 'rare', element: 'fire', type: 'Striker' },
            { id: 110, char: 'üç£', name: 'Spicy Roll', rarity: 'common', element: 'fire', type: 'Speedster' },
            { id: 146, char: 'üçï', name: 'Slice', rarity: 'rare', element: 'fire', type: 'Striker' },
            { id: 147, char: 'üåÆ', name: 'Crunch', rarity: 'common', element: 'fire', type: 'Striker' },
            { id: 148, char: 'üé∏', name: 'Riff', rarity: 'epic', element: 'fire', type: 'Striker' },
            { id: 149, char: 'üöÄ', name: 'Apex', rarity: 'legendary', element: 'fire', type: 'Speedster' },
            { id: 150, char: 'üçî', name: 'Beef', rarity: 'rare', element: 'fire', type: 'Tank' },
            { id: 151, char: 'üç∫', name: 'Froth', rarity: 'common', element: 'fire', type: 'Tank' },
            { id: 152, char: 'üåû', name: 'Solaris', rarity: 'legendary', element: 'fire', type: 'Striker' },
            { id: 153, char: 'üç©', name: 'Glaze', rarity: 'common', element: 'fire', type: 'Speedster' },
            // WATER (25)
            { id: 6, char: 'üíß', name: 'Aqua', rarity: 'common', element: 'water', type: 'Speedster' },
            { id: 7, char: 'ü¶à', name: 'Meg', rarity: 'rare', element: 'water', type: 'Striker' },
            { id: 8, char: 'üê≥', name: 'Levi', rarity: 'legendary', element: 'water', type: 'Tank' },
            { id: 9, char: 'üßú', name: 'Siren', rarity: 'divine', element: 'water', type: 'Speedster' },
            { id: 10, char: 'üêô', name: 'Kraken', rarity: 'epic', element: 'water', type: 'Tank' },
            { id: 66, char: 'üßä', name: 'Frost', rarity: 'common', element: 'water', type: 'Tank' },
            { id: 111, char: 'üõ∂', name: 'Drift', rarity: 'common', element: 'water', type: 'Speedster' },
            { id: 112, char: '‚õ≤', name: 'Geyser', rarity: 'rare', element: 'water', type: 'Striker' },
            { id: 113, char: '‚õµ', name: 'Skiff', rarity: 'rare', element: 'water', type: 'Tank' },
            { id: 154, char: 'ü¶û', name: 'Claw', rarity: 'rare', element: 'water', type: 'Striker' },
            { id: 155, char: 'ü¶Ä', name: 'Shell', rarity: 'common', element: 'water', type: 'Tank' },
            { id: 156, char: 'ü¶ê', name: 'Prawn', rarity: 'common', element: 'water', type: 'Speedster' },
            { id: 157, char: 'üê°', name: 'Puff', rarity: 'rare', element: 'water', type: 'Tank' },
            { id: 158, char: 'üêß', name: 'Waddle', rarity: 'epic', element: 'water', type: 'Speedster' },
            { id: 159, char: 'ü¶¢', name: 'Grace', rarity: 'rare', element: 'water', type: 'Speedster' },
            { id: 160, char: 'üê¨', name: 'Echo', rarity: 'legendary', element: 'water', type: 'Speedster' },
            { id: 161, char: '‚òî', name: 'Shield', rarity: 'common', element: 'water', type: 'Tank' },
            // NATURE (25)
            { id: 11, char: 'üåø', name: 'Sprout', rarity: 'common', element: 'nature', type: 'Tank' },
            { id: 12, char: 'üêØ', name: 'Jungle', rarity: 'rare', element: 'nature', type: 'Striker' },
            { id: 13, char: 'ü¶Ñ', name: 'Mythic', rarity: 'epic', element: 'nature', type: 'Speedster' },
            { id: 14, char: 'üå≥', name: 'Oak', rarity: 'legendary', element: 'nature', type: 'Tank' },
            { id: 15, char: 'üåª', name: 'Sunny', rarity: 'common', element: 'nature', type: 'Striker' },
            { id: 70, char: 'ü¶ã', name: 'Morpho', rarity: 'epic', element: 'nature', type: 'Speedster' },
            { id: 114, char: 'üçÑ', name: 'Toad', rarity: 'common', element: 'nature', type: 'Tank' },
            { id: 115, char: 'ü¶ó', name: 'Chirp', rarity: 'rare', element: 'nature', type: 'Speedster' },
            { id: 162, char: 'ü¶ç', name: 'Kong', rarity: 'legendary', element: 'nature', type: 'Striker' },
            { id: 163, char: 'üêò', name: 'Pach', rarity: 'legendary', element: 'nature', type: 'Tank' },
            { id: 164, char: 'ü¶í', name: 'Tall', rarity: 'rare', element: 'nature', type: 'Tank' },
            { id: 165, char: 'ü¶ì', name: 'Stripe', rarity: 'common', element: 'nature', type: 'Speedster' },
            { id: 166, char: 'üêç', name: 'Coil', rarity: 'rare', element: 'nature', type: 'Striker' },
            { id: 167, char: 'üê¢', name: 'Shell', rarity: 'common', element: 'nature', type: 'Tank' },
            { id: 168, char: 'üåµ', name: 'Spine', rarity: 'common', element: 'nature', type: 'Tank' },
            { id: 169, char: 'üçÄ', name: 'Luck', rarity: 'epic', element: 'nature', type: 'Speedster' },
            // LIGHT (25)
            { id: 16, char: '‚ú®', name: 'Star', rarity: 'common', element: 'light', type: 'Speedster' },
            { id: 17, char: 'üòá', name: 'Aegis', rarity: 'rare', element: 'light', type: 'Tank' },
            { id: 18, char: 'üëë', name: 'Sov', rarity: 'legendary', element: 'light', type: 'Striker' },
            { id: 19, char: 'üíé', name: 'Gem', rarity: 'epic', element: 'light', type: 'Tank' },
            { id: 20, char: 'üßø', name: 'Eye', rarity: 'divine', element: 'light', type: 'Tank' },
            { id: 117, char: 'üè∞', name: 'Fort', rarity: 'legendary', element: 'light', type: 'Tank' },
            { id: 118, char: 'üïäÔ∏è', name: 'Peace', rarity: 'rare', element: 'light', type: 'Speedster' },
            { id: 170, char: 'ü¶Ñ', name: 'Aurelia', rarity: 'divine', element: 'light', type: 'Speedster' },
            { id: 171, char: 'üëº', name: 'Seraph', rarity: 'legendary', element: 'light', type: 'Striker' },
            { id: 172, char: 'üåà', name: 'Prism', rarity: 'legendary', element: 'light', type: 'Speedster' },
            { id: 173, char: 'üíç', name: 'Wealth', rarity: 'epic', element: 'light', type: 'Tank' },
            { id: 174, char: 'üßû', name: 'Grant', rarity: 'divine', element: 'light', type: 'Striker' },
            { id: 175, char: 'üí°', name: 'Volt', rarity: 'common', element: 'light', type: 'Striker' },
            { id: 176, char: 'üéª', name: 'Solo', rarity: 'rare', element: 'light', type: 'Speedster' },
            // DARK (25)
            { id: 21, char: 'üåë', name: 'Eclip', rarity: 'common', element: 'dark', type: 'Speedster' },
            { id: 22, char: 'ü¶á', name: 'Vamp', rarity: 'rare', element: 'dark', type: 'Striker' },
            { id: 23, char: 'üëÅÔ∏è', name: 'Void', rarity: 'divine', element: 'dark', type: 'Striker' },
            { id: 24, char: 'üëª', name: 'Wraith', rarity: 'epic', element: 'dark', type: 'Speedster' },
            { id: 120, char: 'üí£', name: 'Blast', rarity: 'epic', element: 'dark', type: 'Striker' },
            { id: 121, char: 'üï∑Ô∏è', name: 'Widow', rarity: 'rare', element: 'dark', type: 'Striker' },
            { id: 177, char: 'ü™ê', name: 'Abyss', rarity: 'legendary', element: 'dark', type: 'Tank' },
            { id: 178, char: 'üõ∏', name: 'Visitor', rarity: 'epic', element: 'dark', type: 'Speedster' },
            { id: 179, char: 'üíÄ', name: 'Reap', rarity: 'legendary', element: 'dark', type: 'Striker' },
            { id: 180, char: 'üï∑Ô∏è', name: 'Fang', rarity: 'rare', element: 'dark', type: 'Striker' },
            { id: 181, char: 'üîÆ', name: 'Oracle', rarity: 'divine', element: 'dark', type: 'Speedster' },
            { id: 182, char: 'üëΩ', name: 'Zor', rarity: 'epic', element: 'dark', type: 'Striker' },
            { id: 183, char: 'üé≠', name: 'Shadow', rarity: 'rare', element: 'dark', type: 'Striker' },
            { id: 184, char: 'üï∞Ô∏è', name: 'Dread', rarity: 'rare', element: 'dark', type: 'Tank' },
            // MIXED/ETERNAL (Remaining)
            { id: 58, char: 'üåÄ', name: 'Singu', rarity: 'eternal', element: 'dark', type: 'Striker' },
            { id: 59, char: '‚ôæÔ∏è', name: 'Infin', rarity: 'eternal', element: 'light', type: 'Tank' },
            { id: 60, char: 'üèîÔ∏è', name: 'Zenith', rarity: 'eternal', element: 'nature', type: 'Speedster' },
            { id: 185, char: 'üç≥', name: 'Sizzle', rarity: 'common', element: 'fire', type: 'Tank' },
            { id: 186, char: 'ü§°', name: 'Chaos', rarity: 'epic', element: 'dark', type: 'Striker' },
            { id: 187, char: 'üé∑', name: 'Jazz', rarity: 'rare', element: 'light', type: 'Speedster' },
            { id: 188, char: 'üéæ', name: 'Bounce', rarity: 'common', element: 'nature', type: 'Speedster' },
            { id: 189, char: 'üì∑', name: 'Snap', rarity: 'common', element: 'light', type: 'Speedster' },
            { id: 190, char: 'üßä', name: 'Zero', rarity: 'legendary', element: 'water', type: 'Tank' }
        ];

        const RARITY_ORDER = ['trash', 'common', 'rare', 'epic', 'legendary', 'divine', 'eternal'];
        const TYPE_WEIGHTS = { Striker: { hp: 0.6, atk: 1.5, spd: 0.9 }, Tank: { hp: 1.8, atk: 0.6, spd: 0.6 }, Speedster: { hp: 0.8, atk: 0.8, spd: 1.4 } };
        const ELEMENT_BONUSES = { fire: { hp: 1.0, atk: 1.2, spd: 1.0 }, water: { hp: 1.2, atk: 1.0, spd: 1.0 }, nature: { hp: 1.1, atk: 1.1, spd: 1.0 }, light: { hp: 1.0, atk: 1.0, spd: 1.2 }, dark: { hp: 0.9, atk: 1.3, spd: 1.0 } };
        const RARITY_MULTIPLIERS = { trash: 0.4, common: 1.0, rare: 1.5, epic: 2.5, legendary: 4.5, divine: 8.5, eternal: 20.0 };
        const GROWTH_RATES = { trash: 0.12, common: 0.15, rare: 0.18, epic: 0.22, legendary: 0.28, divine: 0.38, eternal: 0.55 };
        const ELEMENTS = { fire: { beats: 'nature' }, water: { beats: 'fire' }, nature: { beats: 'water' }, light: { beats: 'dark' }, dark: { beats: 'light' } };
        const PROBS = { trash: 0.05, common: 0.65, rare: 0.85, epic: 0.96, legendary: 0.998, divine: 0.9995, eternal: 1.0 };

        let state = { gold: 5000, tickets: 20, pity: 0, inventory: {}, team: [], stage: 1, isAutoBattling: false };
        let selectedId = null;

        // --- CORE ---
        function init() { load(); updateStatsUI(); switchTab('summon'); }
        function save() { localStorage.setItem('emojiSaga_vInfinite', JSON.stringify(state)); }
        function load() {
            const saved = localStorage.getItem('emojiSaga_vInfinite');
            if (saved) {
                state = { ...state, ...JSON.parse(saved) };
                Object.keys(state.inventory).forEach(id => {
                    if (!state.inventory[id].baseRarity) {
                        const orig = EMOJIS.find(x => x.id == id) || EMOJIS[0];
                        state.inventory[id].baseRarity = orig.rarity;
                        state.inventory[id].currentRarity = orig.rarity;
                    }
                });
            }
            state.isAutoBattling = false;
        }

        function updateStatsUI() {
            document.getElementById('stat-gold').innerText = state.gold.toLocaleString();
            document.getElementById('stat-tickets').innerText = state.tickets.toLocaleString();
            document.getElementById('pity-count').innerText = `${state.pity}/50`;
            document.getElementById('arena-stage-title').innerText = state.stage;
            document.getElementById('collection-count').innerText = `${Object.keys(state.inventory).length}/150`;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`btn-tab-${tab}`).classList.add('tab-active');
            if (tab === 'team') renderTeam();
        }

        function toast(msg) {
            const t = document.getElementById('toast'); t.innerText = msg; t.classList.replace('opacity-0', 'opacity-100');
            setTimeout(() => t.classList.replace('opacity-100', 'opacity-0'), 2000);
        }

        // --- CALC ---
        function calcStats(id) {
            const e = EMOJIS.find(x => x.id === id) || EMOJIS[0];
            const inv = state.inventory[id];
            const baseObj = { hp: 100, atk: 20, spd: 10 };
            const weights = TYPE_WEIGHTS[e.type];
            let hp = baseObj.hp * weights.hp;
            let atk = baseObj.atk * weights.atk;
            let spd = baseObj.spd * weights.spd;
            const aff = ELEMENT_BONUSES[e.element];
            hp *= aff.hp; atk *= aff.atk; spd *= aff.spd;
            
            const multCurrent = RARITY_MULTIPLIERS[inv.currentRarity];
            let rarityModifier;
            if (inv.baseRarity === 'trash') {
                rarityModifier = multCurrent * (1 + (RARITY_ORDER.indexOf(inv.currentRarity) * 0.15));
            } else {
                const multBase = RARITY_MULTIPLIERS[inv.baseRarity];
                rarityModifier = multCurrent * Math.pow(multBase / multCurrent, 0.3);
            }
            hp *= rarityModifier; atk *= rarityModifier; spd *= rarityModifier;
            const growth = 1 + ((inv.lvl - 1) * GROWTH_RATES[inv.currentRarity]);
            return { hp: Math.floor(hp * growth), atk: Math.floor(atk * growth), spd: Math.floor(spd * growth) };
        }

        // --- GACHA ---
        async function startSummonSequence(count) {
            if (state.tickets < count) { toast("NO KEYS!"); return; }
            state.tickets -= count; updateStatsUI();
            const results = [];
            for (let i = 0; i < count; i++) {
                state.pity++;
                let rarity = 'common';
                let rand = Math.random();
                if (state.pity >= 50) { rarity = 'legendary'; state.pity = 0; }
                else {
                    if (rand < 0.05) rarity = 'trash';
                    else if (rand < PROBS.common) rarity = 'common';
                    else if (rand < PROBS.rare) rarity = 'rare';
                    else if (rand < PROBS.epic) rarity = 'epic';
                    else if (rand < PROBS.legendary) rarity = 'legendary';
                    else if (rand < PROBS.divine) rarity = 'divine';
                    else rarity = 'eternal';
                }
                const pool = EMOJIS.filter(e => e.rarity === rarity);
                const emoji = pool[Math.floor(Math.random() * pool.length)];
                results.push(emoji);
                if (!state.inventory[emoji.id]) state.inventory[emoji.id] = { lvl: 1, baseRarity: emoji.rarity, currentRarity: emoji.rarity };
            }
            save(); renderSummonResults(results);
        }

        async function renderSummonResults(results) {
            const overlay = document.getElementById('summon-result-overlay');
            const grid = document.getElementById('summon-grid');
            grid.innerHTML = ''; document.getElementById('btn-summon-close').classList.add('hidden');
            overlay.classList.remove('hidden');
            for (let i = 0; i < results.length; i++) {
                await new Promise(r => setTimeout(r, 100));
                const res = results[i];
                const card = document.createElement('div');
                card.className = `card-base w-28 h-40 rounded-2xl border-2 flex flex-col items-center justify-center p-3 card-reveal rarity-card-${res.rarity}`;
                card.innerHTML = `<div class="text-[7px] font-black uppercase mb-1">${res.rarity}</div><div class="text-5xl mb-2">${res.char}</div><div class="text-[9px] font-black text-center uppercase truncate w-full">${res.name}</div>`;
                grid.appendChild(card);
            }
            document.getElementById('btn-summon-close').classList.remove('hidden');
        }

        function closeSummonResults() { document.getElementById('summon-result-overlay').classList.add('hidden'); }

        // --- TEAM ---
        function renderTeam() {
            const rosterGrid = document.getElementById('roster-grid');
            const teamSlots = document.getElementById('team-slots');
            rosterGrid.innerHTML = ''; teamSlots.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const id = state.team[i];
                const slot = document.createElement('div');
                slot.className = "flex-1 rounded-xl border-2 border-dashed border-white/10 bg-white/5 flex items-center justify-center text-3xl";
                if (id) {
                    const inv = state.inventory[id];
                    const e = EMOJIS.find(x => x.id === id) || EMOJIS[0];
                    slot.className = `flex-1 rounded-xl border-2 flex items-center justify-center text-4xl bg-slate-900 cursor-pointer card-base rarity-card-${inv.currentRarity}`;
                    slot.innerHTML = e.char;
                    slot.onclick = () => inspect(id);
                }
                teamSlots.appendChild(slot);
            }
            Object.keys(state.inventory).forEach(idStr => {
                const id = parseInt(idStr);
                const e = EMOJIS.find(x => x.id === id) || EMOJIS[0];
                const inv = state.inventory[id];
                const item = document.createElement('div');
                item.className = `card-base aspect-square rounded-xl border-2 flex flex-col items-center justify-center cursor-pointer transition-transform hover:scale-105 rarity-card-${inv.currentRarity} ${state.team.includes(id) ? 'opacity-30' : ''} ${selectedId === id ? 'ring-2 ring-white' : ''}`;
                item.innerHTML = `<div class="text-2xl">${e.char}</div><div class="text-[7px] font-black">LV.${inv.lvl}</div>`;
                item.onclick = () => inspect(id);
                rosterGrid.appendChild(item);
            });
        }

        function inspect(id) {
            selectedId = id;
            const e = EMOJIS.find(x => x.id === id) || EMOJIS[0];
            const inv = state.inventory[id];
            const stats = calcStats(id);
            
            document.getElementById('inspect-emoji').innerText = e.char;
            document.getElementById('inspect-name').innerText = e.name;
            document.getElementById('inspect-lvl').innerText = inv.lvl;
            document.getElementById('inspect-hp').innerText = stats.hp.toLocaleString();
            document.getElementById('inspect-atk').innerText = stats.atk.toLocaleString();
            document.getElementById('inspect-spd').innerText = stats.spd.toLocaleString();
            
            // New Badge Logic
            const elBadge = document.getElementById('inspect-element-badge');
            const typeBadge = document.getElementById('inspect-type-badge');
            elBadge.innerText = e.element;
            elBadge.className = `type-badge element-${e.element} font-black`;
            typeBadge.innerText = e.type;

            const rarityBadge = document.getElementById('inspect-rarity-badge');
            rarityBadge.innerText = `${inv.currentRarity.toUpperCase()} (NAT ${inv.baseRarity.toUpperCase()})`;
            rarityBadge.className = `inline-block px-3 py-1 rounded-full text-[7px] font-black uppercase mb-4 tracking-widest border border-white/20 text-${inv.currentRarity}`;
            
            document.getElementById('btn-lvl-up').disabled = (state.gold < inv.lvl * 250 || inv.lvl >= 10);
            const canPromote = inv.lvl >= 10 && inv.currentRarity !== 'eternal';
            const promoteBtn = document.getElementById('btn-promote');
            if (canPromote) {
                promoteBtn.classList.remove('hidden');
                promoteBtn.disabled = state.gold < 5000;
            } else promoteBtn.classList.add('hidden');
            document.getElementById('btn-add-team').innerText = state.team.includes(id) ? "WITHDRAW" : "DEPLOY";
            renderTeam();
        }

        function levelUpSelected() {
            if (!selectedId) return;
            const inv = state.inventory[selectedId];
            const cost = inv.lvl * 250;
            if (state.gold >= cost && inv.lvl < 10) { state.gold -= cost; inv.lvl++; save(); inspect(selectedId); updateStatsUI(); }
        }

        function promoteSelected() {
            if (!selectedId || state.gold < 5000) return;
            const inv = state.inventory[selectedId];
            const nextIdx = RARITY_ORDER.indexOf(inv.currentRarity) + 1;
            if (nextIdx < RARITY_ORDER.length) {
                state.gold -= 5000; inv.currentRarity = RARITY_ORDER[nextIdx]; inv.lvl = 1;
                save(); inspect(selectedId); updateStatsUI(); toast("ASCENDED!");
            }
        }

        function toggleSelectedTeam() {
            if (!selectedId) return;
            const idx = state.team.indexOf(selectedId);
            state.stage = 1; stopAutoBattle();
            if (idx > -1) state.team.splice(idx, 1);
            else if (state.team.length < 3) state.team.push(selectedId);
            save(); updateStatsUI(); inspect(selectedId);
        }

        // --- ARENA ---
        function toggleAutoBattle() { if (!state.team.length) { switchTab('team'); return; } state.isAutoBattling = true; switchTab('arena'); startAutoCycle(); }
        function stopAutoBattle() { state.isAutoBattling = false; document.getElementById('arena-lobby').classList.remove('hidden'); document.getElementById('arena-combat').classList.add('hidden'); }

        async function startAutoCycle() {
            if (!state.isAutoBattling) return;
            document.getElementById('arena-lobby').classList.add('hidden');
            document.getElementById('arena-combat').classList.remove('hidden');
            const log = document.getElementById('battle-log');
            const flash = document.getElementById('combat-flash-layer');
            document.getElementById('combat-stage-num').innerText = state.stage;
            log.innerHTML = `<div class="text-white border-b border-white/5 mb-1 pb-1">STAGE ${state.stage}</div>`;
            
            let pUnits = state.team.map(id => ({ ...EMOJIS.find(x => x.id === id), ...calcStats(id), maxHp: calcStats(id).hp, isPlayer: true }));
            let eUnits = [{ char: 'üëæ', name: 'Shadow', hp: 200 + state.stage * 220, maxHp: 200 + state.stage * 220, atk: 40 + state.stage * 28, spd: 12, isPlayer: false }];

            const updateUI = () => {
                document.getElementById('battle-player-team').innerHTML = pUnits.map(u => `<div class="${u.hp<=0?'opacity-20':''}"><div class="flex justify-between text-[7px] font-black uppercase"><span>${u.char}</span><span>${Math.max(0,Math.floor(u.hp))}</span></div><div class="h-1 bg-black overflow-hidden"><div class="h-full bg-green-500" style="width:${(u.hp/u.maxHp)*100}%"></div></div></div>`).join('');
                document.getElementById('battle-enemy-team').innerHTML = eUnits.map(u => `<div class="${u.hp<=0?'opacity-20':''}"><div class="flex justify-between text-[7px] font-black uppercase"><span>${u.char}</span><span>${Math.max(0,Math.floor(u.hp))}</span></div><div class="h-1 bg-black overflow-hidden"><div class="h-full bg-red-500" style="width:${(u.hp/u.maxHp)*100}%"></div></div></div>`).join('');
            };

            while (pUnits.some(u=>u.hp>0) && eUnits.some(u=>u.hp>0) && state.isAutoBattling) {
                updateUI();
                let actors = [...pUnits, ...eUnits].filter(u=>u.hp>0).sort((a,b)=>b.spd - a.spd);
                for (let u of actors) {
                    if (u.hp <= 0 || !state.isAutoBattling) continue;
                    let targets = u.isPlayer ? eUnits.filter(t=>t.hp>0) : pUnits.filter(t=>t.hp>0);
                    if (!targets.length) break;
                    let dmg = u.atk * (0.8 + Math.random()*0.4);
                    targets[0].hp -= dmg;
                    log.innerHTML += `<div>${u.char} deals ${Math.floor(dmg)}</div>`;
                    updateUI(); await new Promise(r=>setTimeout(r, 450));
                }
            }
            if (!state.isAutoBattling) return;
            if (eUnits.every(u => u.hp <= 0)) { state.gold += state.stage * 400; state.stage++; save(); updateStatsUI(); setTimeout(startAutoCycle, 1500); }
            else { state.stage = 1; stopAutoBattle(); updateStatsUI(); }
        }

        function buyTickets(amount, cost) {
            if (state.gold < cost) { toast("NO GOLD!"); return; }
            state.gold -= cost; state.tickets += amount; save(); updateStatsUI(); toast("BOUGHT!");
        }

        window.onload = init;
    </script>
</body>
</html>
