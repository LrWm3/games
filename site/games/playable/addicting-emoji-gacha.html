<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Emoji Saga: 151 Heroes</title>
    
    <meta name="game-description" content="Ultimate Emoji Gacha. 151 unique heroes, Trash-to-Eternal ascension, and elemental strategy.">
    <meta name="game-tags" content="gacha, rpg, emoji, card-game, strategy, auto-battle, ascension, collection">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        
        :root {
            --trash: #78350f;
            --common: #64748b;
            --rare: #3b82f6;
            --epic: #a855f7;
            --legendary: #f59e0b;
            --divine: #ef4444;
            --eternal-start: #ff0000;
            --fire: #ef4444;
            --water: #3b82f6;
            --nature: #22c55e;
            --light: #fde047;
            --dark: #a855f7;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background: #020617;
            color: white;
            overflow-x: hidden;
            user-select: none;
            touch-action: manipulation;
        }

        /* --- RARITY CARD STYLES --- */
        .card-base { transition: all 0.2s ease; position: relative; overflow: hidden; border-width: 2px; }
        .rarity-card-trash { background: linear-gradient(135deg, #2d1a12, #1a0f0a); border-color: #442b1d; color: #78716c; }
        .rarity-card-common { background: linear-gradient(135deg, #1e293b, #0f172a); border-color: #475569; }
        .rarity-card-uncommon { background: linear-gradient(135deg, #0f3d3a, #0a2827); border-color: #14b8a6; box-shadow: inset 0 0 10px rgba(20, 184, 166, 0.3); }
        .rarity-card-rare { background: linear-gradient(135deg, #172554, #1e3a8a); border-color: #3b82f6; box-shadow: inset 0 0 10px rgba(59, 130, 246, 0.3); }
        .rarity-card-epic { background: linear-gradient(135deg, #4c1d95, #581c87); border-color: #a855f7; box-shadow: 0 0 15px rgba(168, 85, 247, 0.2); }
        .rarity-card-legendary { background: linear-gradient(135deg, #78350f, #451a03); border-color: #f59e0b; box-shadow: 0 0 20px rgba(245, 158, 11, 0.4); }
        
        @keyframes divine-pulse { 0%, 100% { box-shadow: 0 0 10px #ef4444; } 50% { box-shadow: 0 0 25px #ef4444; } }
        .rarity-card-divine { background: linear-gradient(135deg, #7f1d1d, #450a0a); border-color: #ef4444; animation: divine-pulse 2s infinite; }

        @keyframes eternal-bg { 0% { border-color: #ff0000; box-shadow: 0 0 20px #ff0000; } 33% { border-color: #00ff00; box-shadow: 0 0 20px #00ff00; } 66% { border-color: #0000ff; box-shadow: 0 0 20px #0000ff; } 100% { border-color: #ff0000; box-shadow: 0 0 20px #ff0000; } }
        .rarity-card-eternal { background: linear-gradient(45deg, #0f172a, #334155); border-width: 3px; animation: eternal-bg 4s linear infinite; }

        .tab-active { background: #4f46e5 !important; color: white !important; box-shadow: 0 0 15px rgba(79, 70, 229, 0.4); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .card-reveal { animation: card-reveal 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes card-reveal { 0% { transform: scale(0.5) rotateY(90deg); opacity: 0; } 100% { transform: scale(1) rotateY(0); opacity: 1; } }

        .element-fire { color: var(--fire); }
        .element-water { color: var(--water); }
        .element-nature { color: var(--nature); }
        .element-light { color: var(--light); }
        .element-dark { color: var(--dark); }
        
        .type-badge { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; padding: 2px 8px; border-radius: 999px; background: rgba(0,0,0,0.3); border: 1px border-white/10; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-slate-900/95 backdrop-blur-md border-b border-white/10 p-3 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="text-2xl">ğŸŒ</span>
                <div class="leading-none">
                    <h1 class="text-lg font-bold uppercase tracking-tight">Emoji Saga</h1>
                    <span class="text-[8px] text-indigo-400 font-black uppercase tracking-[0.2em]">151 Heroes Update</span>
                </div>
            </div>
            <div class="flex flex-col items-end gap-2">
                <div class="flex flex-wrap gap-2 justify-end">
                <div class="bg-black/40 px-3 py-1.5 rounded-full border border-yellow-500/30 flex items-center gap-2 text-xs">
                    <i class="fas fa-coins text-yellow-500"></i>
                    <span id="stat-gold" class="font-bold">0</span>
                </div>
                <div class="bg-black/40 px-3 py-1.5 rounded-full border border-indigo-500/30 flex items-center gap-2 text-xs">
                    <i class="fas fa-ticket text-indigo-400"></i>
                    <span id="stat-tickets" class="font-bold">0</span>
                </div>
                <div class="bg-black/40 px-3 py-1.5 rounded-full border border-blue-400/30 flex items-center gap-2 text-xs">
                    <i class="fas fa-ticket text-blue-300"></i>
                    <span id="stat-rare-tickets" class="font-bold">0</span>
                </div>
                <div class="bg-black/40 px-3 py-1.5 rounded-full border border-amber-400/30 flex items-center gap-2 text-xs">
                    <i class="fas fa-ticket text-amber-300"></i>
                    <span id="stat-legendary-tickets" class="font-bold">0</span>
                </div>
                </div>
                <div class="flex flex-wrap gap-1 items-center text-[8px] font-black uppercase tracking-[0.2em] text-slate-400">
                    <span class="px-2 py-1 rounded-full bg-black/40 border border-white/10">Save</span>
                    <button id="slot-btn-1" onclick="selectSaveSlot(1)" class="px-2 py-1 rounded-full bg-slate-800 border border-white/10">1</button>
                    <button id="slot-btn-2" onclick="selectSaveSlot(2)" class="px-2 py-1 rounded-full bg-slate-800 border border-white/10">2</button>
                    <button id="slot-btn-3" onclick="selectSaveSlot(3)" class="px-2 py-1 rounded-full bg-slate-800 border border-white/10">3</button>
                    <button onclick="newGameCurrentSlot()" class="px-2 py-1 rounded-full bg-emerald-600 text-black">New Game</button>
                    <button onclick="deleteCurrentSlot()" class="px-2 py-1 rounded-full bg-red-600 text-white">Delete</button>
                </div>
            </div>
        </div>
    </header>

    <nav class="bg-slate-900 border-b border-white/5 p-1 flex justify-center gap-1 sticky top-[61px] z-40 overflow-x-auto no-scrollbar">
        <button onclick="switchTab('summon')" id="btn-tab-summon" class="flex-shrink-0 px-4 py-2 rounded-xl text-[10px] font-bold uppercase bg-slate-800 text-slate-400">Portal</button>
        <button onclick="switchTab('team')" id="btn-tab-team" class="flex-shrink-0 px-4 py-2 rounded-xl text-[10px] font-bold uppercase bg-slate-800 text-slate-400">Squad</button>
        <button onclick="switchTab('arena')" id="btn-tab-arena" class="flex-shrink-0 px-4 py-2 rounded-xl text-[10px] font-bold uppercase bg-slate-800 text-slate-400">Arena</button>
        <button onclick="switchTab('shop')" id="btn-tab-shop" class="flex-shrink-0 px-4 py-2 rounded-xl text-[10px] font-bold uppercase bg-slate-800 text-slate-400">Market</button>
    </nav>
    <div id="arena-info-bar" class="hidden bg-slate-900/90 border-b border-white/5 text-center text-[9px] font-black uppercase tracking-[0.3em] text-red-300 py-2">
        Arena Live â€¢ Stage <span id="arena-info-stage" class="text-white">1</span>
    </div>

    <main class="flex-grow container mx-auto max-w-5xl p-4 mb-20">
        
        <!-- Portal -->
        <section id="view-summon" class="tab-content py-4 text-center">
            <div class="relative max-w-xs mx-auto aspect-square flex flex-col items-center justify-center mb-10 overflow-hidden rounded-full border border-white/5 shadow-2xl">
                <div class="absolute inset-0 bg-gradient-to-b from-indigo-500/10 to-transparent"></div>
                <div class="text-[100px] opacity-10 absolute animate-pulse">ğŸ‘‘</div>
                <div class="relative z-10">
                    <h2 class="text-2xl font-black mb-1 italic">THE WORLD GATE</h2>
                    <p class="text-[9px] text-indigo-400 font-bold mb-4 tracking-[0.4em]">DISCOVER 151 HEROES</p>
                    <div class="inline-block bg-black/60 px-4 py-1.5 rounded-full border border-white/10 text-[10px]">
                        Pity: <span id="pity-count" class="text-yellow-400">0/50</span>
                    </div>
                </div>
            </div>
            <div class="flex flex-col gap-4 max-w-xs mx-auto">
                <div class="text-[9px] font-black uppercase tracking-[0.35em] text-slate-400">Standard Tickets</div>
                <button onclick="startSummonSequence(1, 'standard')" class="bg-white text-black py-4 rounded-2xl font-black text-xs hover:scale-105 active:scale-95 transition-all">SINGLE SUMMON</button>
                <button onclick="startSummonSequence(10, 'standard')" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-2xl font-black text-xs shadow-xl active:scale-95 border-b-4 border-indigo-900 transition-all">MULTI SUMMON (10x)</button>
                <div class="text-[9px] font-black uppercase tracking-[0.35em] text-blue-300 mt-2">Rare Tickets</div>
                <button onclick="startSummonSequence(1, 'rare')" class="bg-blue-400 text-black py-4 rounded-2xl font-black text-xs hover:scale-105 active:scale-95 transition-all">RARE SUMMON</button>
                <button onclick="startSummonSequence(10, 'rare')" class="bg-gradient-to-r from-sky-500 to-blue-600 text-white py-4 rounded-2xl font-black text-xs shadow-xl active:scale-95 border-b-4 border-blue-900 transition-all">RARE MULTI (10x)</button>
                <div class="text-[9px] font-black uppercase tracking-[0.35em] text-amber-300 mt-2">Legendary Tickets</div>
                <button onclick="startSummonSequence(1, 'legendary')" class="bg-amber-400 text-black py-4 rounded-2xl font-black text-xs hover:scale-105 active:scale-95 transition-all">LEGEND SUMMON</button>
                <button onclick="startSummonSequence(10, 'legendary')" class="bg-gradient-to-r from-amber-500 to-orange-500 text-white py-4 rounded-2xl font-black text-xs shadow-xl active:scale-95 border-b-4 border-amber-900 transition-all">LEGEND MULTI (10x)</button>
            </div>
        </section>

        <!-- Squad -->
        <section id="view-team" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 space-y-4">
                    <div id="team-slots" class="grid grid-cols-3 gap-3 h-28 mb-6"></div>
                    <div class="flex justify-between items-center border-b border-white/10 pb-2">
                        <h3 class="text-xs font-black uppercase tracking-widest">Collection</h3>
                        <div class="text-[9px] bg-slate-800 px-3 py-1 rounded-full" id="collection-count">0/151</div>
                    </div>
                    <div id="roster-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-2 max-h-[450px] overflow-y-auto custom-scrollbar p-1"></div>
                </div>

                <!-- Inspect Panel -->
                <div id="inspect-panel" class="bg-slate-900 border border-white/10 rounded-[2.5rem] p-6 h-fit sticky top-40 shadow-2xl">
                    <div id="inspect-content" class="text-center">
                        <div id="inspect-emoji" class="text-7xl mb-4 drop-shadow-2xl">â“</div>
                        <h4 id="inspect-name" class="text-xl font-black mb-1 leading-none">Hero Name</h4>
                        
                        <div class="flex justify-center gap-2 mb-4">
                             <div id="inspect-type-badge" class="type-badge text-white">TYPE</div>
                             <div id="inspect-element-badge" class="type-badge">ELEMENT</div>
                        </div>

                        <div id="inspect-rarity-badge" class="inline-block px-3 py-1 rounded-full text-[7px] font-black uppercase mb-6 tracking-[0.2em] border">RARITY</div>
                        <p id="inspect-desc" class="text-[10px] text-slate-300 leading-relaxed mb-6">A short description.</p>
                        <div id="inspect-type-count" class="text-[9px] font-black uppercase tracking-[0.2em] text-slate-400 mb-6">Type Found: 0</div>
                        <div id="inspect-dupe-count" class="text-[9px] font-black uppercase tracking-[0.2em] text-slate-500 mb-6">Duplicates: 0</div>
                        <div class="text-[9px] font-black uppercase tracking-[0.2em] text-slate-400 mb-2">Moves</div>
                        <div id="inspect-moves" class="text-[9px] text-slate-300 space-y-1 mb-6"></div>
                        
                        <div class="grid grid-cols-3 gap-2 text-left mb-6">
                            <div class="bg-black/40 p-2.5 rounded-2xl border border-white/5"><p class="text-[7px] text-slate-500 uppercase">LV</p><span class="font-bold text-sm" id="inspect-lvl">0</span></div>
                            <div class="bg-black/40 p-2.5 rounded-2xl border border-white/5"><p class="text-[7px] text-green-500 uppercase">HP</p><span class="font-bold text-sm" id="inspect-hp">0</span></div>
                            <div class="bg-black/40 p-2.5 rounded-2xl border border-white/5"><p class="text-[7px] text-red-500 uppercase">ATK</p><span class="font-bold text-sm" id="inspect-atk">0</span></div>
                            <div class="bg-black/40 p-2.5 rounded-2xl border border-white/5"><p class="text-[7px] text-blue-500 uppercase">SPD</p><span class="font-bold text-sm" id="inspect-spd">0</span></div>
                            <div class="bg-black/40 p-2.5 rounded-2xl border border-white/5"><p class="text-[7px] text-amber-400 uppercase">DEF</p><span class="font-bold text-sm" id="inspect-def">0</span></div>
                            <div class="bg-black/40 p-2.5 rounded-2xl border border-white/5"><p class="text-[7px] text-pink-400 uppercase">SP. ATK</p><span class="font-bold text-sm" id="inspect-spatk">0</span></div>
                            <div class="bg-black/40 p-2.5 rounded-2xl border border-white/5"><p class="text-[7px] text-cyan-300 uppercase">SP. DEF</p><span class="font-bold text-sm" id="inspect-spdef">0</span></div>
                        </div>

                        <div class="space-y-2">
                            <button id="btn-lvl-up" onclick="levelUpSelected()" class="w-full bg-green-600 hover:bg-green-700 py-3.5 rounded-2xl font-black text-xs transition-all disabled:opacity-20">UPGRADE</button>
                            <button id="btn-promote" onclick="promoteSelected()" class="w-full bg-amber-500 hover:bg-amber-600 py-3.5 rounded-2xl font-black text-xs hidden transition-all">ASCEND</button>
                            <button id="btn-add-team" onclick="toggleSelectedTeam()" class="w-full bg-indigo-600 hover:bg-indigo-700 py-3.5 rounded-2xl font-black text-xs transition-all disabled:opacity-20">DEPLOY</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Arena -->
        <section id="view-arena" class="tab-content hidden">
            <div id="arena-lobby" class="text-center py-10">
                <div class="text-[100px] mb-4">ğŸ†</div>
                <h2 class="text-3xl font-black mb-2 uppercase">Infinite Arena</h2>
                <div class="bg-slate-900 border border-indigo-500/30 p-6 rounded-[2rem] max-w-xs mx-auto mb-8 shadow-2xl">
                    <p class="text-[10px] text-indigo-400 font-black uppercase mb-1">Current Stage</p>
                    <p id="arena-stage-title" class="text-6xl font-black italic">1</p>
                </div>
                <button onclick="toggleAutoBattle()" class="bg-red-600 hover:bg-red-500 text-white px-16 py-5 rounded-3xl font-black text-xl shadow-2xl active:scale-95 transition-all">AUTO BATTLE</button>
            </div>

            <div id="arena-combat" class="hidden max-w-lg mx-auto bg-slate-900/50 p-6 rounded-[2.5rem] border border-white/5 relative">
                <div id="combat-flash-layer" class="absolute inset-0 pointer-events-none rounded-[2.5rem] z-10"></div>
                <div class="flex justify-between items-center mb-6">
                    <span class="text-xs font-black text-red-400 uppercase tracking-widest">Stage <span id="combat-stage-num">1</span></span>
                    <button onclick="stopAutoBattle()" class="text-[9px] font-black text-slate-500 underline uppercase">Abort</button>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div id="battle-player-team" class="space-y-3"></div>
                    <div id="battle-enemy-team" class="space-y-3"></div>
                </div>
                <div id="battle-log" class="mt-6 bg-black h-44 rounded-2xl p-4 overflow-y-auto custom-scrollbar flex flex-col-reverse text-[9px] font-mono border border-white/5"></div>
            </div>
        </section>

        <!-- Shop -->
        <section id="view-shop" class="tab-content hidden py-6">
            <div class="text-center mb-10"><h2 class="text-3xl font-black uppercase">Market</h2></div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 max-w-5xl mx-auto">
                <div class="bg-slate-900 p-8 rounded-3xl border border-white/5 text-center flex flex-col items-center">
                    <h3 class="font-black text-lg mb-4 uppercase">1 Ticket</h3>
                    <button onclick="buyTickets('standard', 1, 1000)" class="w-full bg-indigo-600 py-3 rounded-xl font-black text-xs">1,000 GOLD</button>
                </div>
                <div class="bg-slate-900 p-8 rounded-3xl border border-indigo-500/30 text-center flex flex-col items-center">
                    <h3 class="font-black text-lg mb-4 uppercase">10 Tickets</h3>
                    <button onclick="buyTickets('standard', 10, 8500)" class="w-full bg-indigo-600 py-3 rounded-xl font-black text-xs">8,500 GOLD</button>
                </div>
                <div class="bg-slate-900 p-8 rounded-3xl border border-blue-500/30 text-center flex flex-col items-center">
                    <h3 class="font-black text-lg mb-4 uppercase">1 Rare Ticket</h3>
                    <button onclick="buyTickets('rare', 1, 2500)" class="w-full bg-blue-500 py-3 rounded-xl font-black text-xs">2,500 GOLD</button>
                </div>
                <div class="bg-slate-900 p-8 rounded-3xl border border-blue-500/30 text-center flex flex-col items-center">
                    <h3 class="font-black text-lg mb-4 uppercase">10 Rare Tickets</h3>
                    <button onclick="buyTickets('rare', 10, 22500)" class="w-full bg-blue-500 py-3 rounded-xl font-black text-xs">22,500 GOLD</button>
                </div>
                <div class="bg-slate-900 p-8 rounded-3xl border border-amber-500/30 text-center flex flex-col items-center">
                    <h3 class="font-black text-lg mb-4 uppercase">1 Legendary Ticket</h3>
                    <button onclick="buyTickets('legendary', 1, 6000)" class="w-full bg-amber-500 py-3 rounded-xl font-black text-xs">6,000 GOLD</button>
                </div>
                <div class="bg-slate-900 p-8 rounded-3xl border border-amber-500/30 text-center flex flex-col items-center">
                    <h3 class="font-black text-lg mb-4 uppercase">10 Legendary Tickets</h3>
                    <button onclick="buyTickets('legendary', 10, 54000)" class="w-full bg-amber-500 py-3 rounded-xl font-black text-xs">54,000 GOLD</button>
                </div>
            </div>
        </section>

    </main>

    <!-- Results Overlay -->
    <div id="summon-result-overlay" class="fixed inset-0 z-[100] bg-black/98 flex flex-col hidden overflow-hidden">
        <div class="flex-shrink-0 p-8 text-center"><h2 class="text-2xl font-black italic tracking-tighter">PORTAL SUMMONS</h2></div>
        <div id="summon-grid" class="flex-grow overflow-y-auto px-6 py-4 flex flex-wrap justify-center content-start gap-4 custom-scrollbar"></div>
        <div class="flex-shrink-0 p-10 flex justify-center bg-black/80"><button onclick="closeSummonResults()" id="btn-summon-close" class="hidden bg-white text-black px-16 py-5 rounded-2xl font-black active:scale-95 transition-all">CONTINUE</button></div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 px-6 py-3 bg-white text-black text-[10px] rounded-full font-black shadow-2xl opacity-0 transition-all duration-500 z-[300] uppercase tracking-widest">NOTIFY</div>

    <script>
        // --- MASTER DATA (151 TOTAL) ---
        const EMOJIS = [
            // TRASH (8)
            { id: 101, char: 'ğŸ—‘ï¸', name: 'Tin Can', rarity: 'trash', element: 'dark', type: 'Tank' },
            { id: 102, char: 'ğŸ’©', name: 'Nugget', rarity: 'trash', element: 'nature', type: 'Striker' },
            { id: 103, char: 'ğŸ¦´', name: 'Old Bone', rarity: 'trash', element: 'dark', type: 'Striker' },
            { id: 104, char: 'ğŸšï¸', name: 'Shack', rarity: 'trash', element: 'nature', type: 'Tank' },
            { id: 105, char: 'ğŸ‘', name: 'Old Boot', rarity: 'trash', element: 'water', type: 'Speedster' },
            { id: 106, char: 'ğŸ§¦', name: 'Stray Sock', rarity: 'trash', element: 'light', type: 'Speedster' },
            { id: 107, char: 'ğŸŒ', name: 'Peel', rarity: 'trash', element: 'nature', type: 'Speedster' },
            { id: 108, char: 'ğŸ”‹', name: 'Dead Cell', rarity: 'trash', element: 'light', type: 'Striker' },
            // FIRE (25)
            { id: 1, char: 'ğŸ”¥', name: 'Inferno', rarity: 'rare', element: 'fire', type: 'Striker' },
            { id: 2, char: 'ğŸŒ‹', name: 'Magma', rarity: 'epic', element: 'fire', type: 'Tank' },
            { id: 3, char: 'ğŸ‰', name: 'Drake', rarity: 'legendary', element: 'fire', type: 'Striker' },
            { id: 4, char: 'â˜„ï¸', name: 'Comet', rarity: 'uncommon', element: 'fire', type: 'Striker' },
            { id: 5, char: 'ğŸ¦', name: 'Leonis', rarity: 'epic', element: 'fire', type: 'Striker' },
            { id: 61, char: 'ğŸŒ¶ï¸', name: 'Pepper', rarity: 'uncommon', element: 'fire', type: 'Speedster' },
            { id: 62, char: 'ğŸ¥“', name: 'Sizzle', rarity: 'common', element: 'fire', type: 'Tank' },
            { id: 64, char: 'ğŸ‘º', name: 'Oni', rarity: 'legendary', element: 'fire', type: 'Striker' },
            { id: 109, char: 'ğŸ§¨', name: 'Dynamo', rarity: 'rare', element: 'fire', type: 'Striker' },
            { id: 110, char: 'ğŸ£', name: 'Spicy Roll', rarity: 'common', element: 'fire', type: 'Speedster' },
            { id: 146, char: 'ğŸ•', name: 'Slice', rarity: 'rare', element: 'fire', type: 'Striker' },
            { id: 147, char: 'ğŸŒ®', name: 'Crunch', rarity: 'common', element: 'fire', type: 'Striker' },
            { id: 148, char: 'ğŸ¸', name: 'Riff', rarity: 'epic', element: 'fire', type: 'Striker' },
            { id: 149, char: 'ğŸš€', name: 'Apex', rarity: 'legendary', element: 'fire', type: 'Speedster' },
            { id: 150, char: 'ğŸ”', name: 'Beef', rarity: 'rare', element: 'fire', type: 'Tank' },
            { id: 151, char: 'ğŸº', name: 'Froth', rarity: 'common', element: 'fire', type: 'Tank' },
            { id: 152, char: 'ğŸŒ', name: 'Solaris', rarity: 'legendary', element: 'fire', type: 'Striker' },
            { id: 153, char: 'ğŸ©', name: 'Glaze', rarity: 'uncommon', element: 'fire', type: 'Speedster' },
            // WATER (25)
            { id: 6, char: 'ğŸ’§', name: 'Aqua', rarity: 'uncommon', element: 'water', type: 'Speedster' },
            { id: 7, char: 'ğŸ¦ˆ', name: 'Meg', rarity: 'rare', element: 'water', type: 'Striker' },
            { id: 8, char: 'ğŸ³', name: 'Levi', rarity: 'legendary', element: 'water', type: 'Tank' },
            { id: 9, char: 'ğŸ§œ', name: 'Siren', rarity: 'divine', element: 'water', type: 'Speedster' },
            { id: 10, char: 'ğŸ™', name: 'Kraken', rarity: 'epic', element: 'water', type: 'Tank' },
            { id: 66, char: 'ğŸ§Š', name: 'Frost', rarity: 'uncommon', element: 'water', type: 'Tank' },
            { id: 111, char: 'ğŸ›¶', name: 'Drift', rarity: 'uncommon', element: 'water', type: 'Speedster' },
            { id: 112, char: 'â›²', name: 'Geyser', rarity: 'rare', element: 'water', type: 'Striker' },
            { id: 113, char: 'â›µ', name: 'Skiff', rarity: 'rare', element: 'water', type: 'Tank' },
            { id: 154, char: 'ğŸ¦', name: 'Claw', rarity: 'rare', element: 'water', type: 'Striker' },
            { id: 155, char: 'ğŸ¦€', name: 'Shell', rarity: 'common', element: 'water', type: 'Tank' },
            { id: 156, char: 'ğŸ¦', name: 'Prawn', rarity: 'common', element: 'water', type: 'Speedster' },
            { id: 157, char: 'ğŸ¡', name: 'Puff', rarity: 'rare', element: 'water', type: 'Tank' },
            { id: 158, char: 'ğŸ§', name: 'Waddle', rarity: 'epic', element: 'water', type: 'Speedster' },
            { id: 159, char: 'ğŸ¦¢', name: 'Grace', rarity: 'rare', element: 'water', type: 'Speedster' },
            { id: 160, char: 'ğŸ¬', name: 'Echo', rarity: 'legendary', element: 'water', type: 'Speedster' },
            { id: 161, char: 'â˜”', name: 'Shield', rarity: 'common', element: 'water', type: 'Tank' },
            // NATURE (25)
            { id: 11, char: 'ğŸŒ¿', name: 'Sprout', rarity: 'uncommon', element: 'nature', type: 'Tank' },
            { id: 12, char: 'ğŸ¯', name: 'Jungle', rarity: 'rare', element: 'nature', type: 'Striker' },
            { id: 13, char: 'ğŸ¦„', name: 'Mythic', rarity: 'epic', element: 'nature', type: 'Speedster' },
            { id: 14, char: 'ğŸŒ³', name: 'Oak', rarity: 'legendary', element: 'nature', type: 'Tank' },
            { id: 15, char: 'ğŸŒ»', name: 'Sunny', rarity: 'uncommon', element: 'nature', type: 'Striker' },
            { id: 70, char: 'ğŸ¦‹', name: 'Morpho', rarity: 'epic', element: 'nature', type: 'Speedster' },
            { id: 114, char: 'ğŸ„', name: 'Toad', rarity: 'uncommon', element: 'nature', type: 'Tank' },
            { id: 115, char: 'ğŸ¦—', name: 'Chirp', rarity: 'rare', element: 'nature', type: 'Speedster' },
            { id: 162, char: 'ğŸ¦', name: 'Kong', rarity: 'legendary', element: 'nature', type: 'Striker' },
            { id: 163, char: 'ğŸ˜', name: 'Pach', rarity: 'legendary', element: 'nature', type: 'Tank' },
            { id: 164, char: 'ğŸ¦’', name: 'Tall', rarity: 'rare', element: 'nature', type: 'Tank' },
            { id: 165, char: 'ğŸ¦“', name: 'Stripe', rarity: 'common', element: 'nature', type: 'Speedster' },
            { id: 166, char: 'ğŸ', name: 'Coil', rarity: 'rare', element: 'nature', type: 'Striker' },
            { id: 167, char: 'ğŸ¢', name: 'Shell', rarity: 'common', element: 'nature', type: 'Tank' },
            { id: 168, char: 'ğŸŒµ', name: 'Spine', rarity: 'common', element: 'nature', type: 'Tank' },
            { id: 169, char: 'ğŸ€', name: 'Luck', rarity: 'epic', element: 'nature', type: 'Speedster' },
            // LIGHT (25)
            { id: 16, char: 'âœ¨', name: 'Star', rarity: 'uncommon', element: 'light', type: 'Speedster' },
            { id: 17, char: 'ğŸ˜‡', name: 'Aegis', rarity: 'rare', element: 'light', type: 'Tank' },
            { id: 18, char: 'ğŸ‘‘', name: 'Sov', rarity: 'legendary', element: 'light', type: 'Striker' },
            { id: 19, char: 'ğŸ’', name: 'Gem', rarity: 'epic', element: 'light', type: 'Tank' },
            { id: 20, char: 'ğŸ§¿', name: 'Eye', rarity: 'divine', element: 'light', type: 'Tank' },
            { id: 117, char: 'ğŸ°', name: 'Fort', rarity: 'legendary', element: 'light', type: 'Tank' },
            { id: 118, char: 'ğŸ•Šï¸', name: 'Peace', rarity: 'rare', element: 'light', type: 'Speedster' },
            { id: 170, char: 'ğŸ¦„', name: 'Aurelia', rarity: 'divine', element: 'light', type: 'Speedster' },
            { id: 171, char: 'ğŸ‘¼', name: 'Seraph', rarity: 'legendary', element: 'light', type: 'Striker' },
            { id: 172, char: 'ğŸŒˆ', name: 'Prism', rarity: 'legendary', element: 'light', type: 'Speedster' },
            { id: 173, char: 'ğŸ’', name: 'Wealth', rarity: 'epic', element: 'light', type: 'Tank' },
            { id: 174, char: 'ğŸ§', name: 'Grant', rarity: 'divine', element: 'light', type: 'Striker' },
            { id: 175, char: 'ğŸ’¡', name: 'Volt', rarity: 'uncommon', element: 'light', type: 'Striker' },
            { id: 176, char: 'ğŸ»', name: 'Solo', rarity: 'rare', element: 'light', type: 'Speedster' },
            // DARK (25)
            { id: 21, char: 'ğŸŒ‘', name: 'Eclip', rarity: 'uncommon', element: 'dark', type: 'Speedster' },
            { id: 22, char: 'ğŸ¦‡', name: 'Vamp', rarity: 'rare', element: 'dark', type: 'Striker' },
            { id: 23, char: 'ğŸ‘ï¸', name: 'Void', rarity: 'divine', element: 'dark', type: 'Striker' },
            { id: 24, char: 'ğŸ‘»', name: 'Wraith', rarity: 'epic', element: 'dark', type: 'Speedster' },
            { id: 120, char: 'ğŸ’£', name: 'Blast', rarity: 'epic', element: 'dark', type: 'Striker' },
            { id: 121, char: 'ğŸ•·ï¸', name: 'Widow', rarity: 'rare', element: 'dark', type: 'Striker' },
            { id: 177, char: 'ğŸª', name: 'Abyss', rarity: 'legendary', element: 'dark', type: 'Tank' },
            { id: 178, char: 'ğŸ›¸', name: 'Visitor', rarity: 'epic', element: 'dark', type: 'Speedster' },
            { id: 179, char: 'ğŸ’€', name: 'Reap', rarity: 'legendary', element: 'dark', type: 'Striker' },
            { id: 180, char: 'ğŸ•·ï¸', name: 'Fang', rarity: 'rare', element: 'dark', type: 'Striker' },
            { id: 181, char: 'ğŸ”®', name: 'Oracle', rarity: 'divine', element: 'dark', type: 'Speedster' },
            { id: 182, char: 'ğŸ‘½', name: 'Zor', rarity: 'epic', element: 'dark', type: 'Striker' },
            { id: 183, char: 'ğŸ‘¾', name: 'Shadow', rarity: 'eternal', element: 'dark', type: 'Striker' },
            { id: 184, char: 'ğŸ•°ï¸', name: 'Dread', rarity: 'rare', element: 'dark', type: 'Tank' },
            // MIXED/ETERNAL (Remaining)
            { id: 58, char: 'ğŸŒ€', name: 'Singu', rarity: 'eternal', element: 'dark', type: 'Striker' },
            { id: 59, char: 'â™¾ï¸', name: 'Infin', rarity: 'eternal', element: 'light', type: 'Tank' },
            { id: 60, char: 'ğŸ”ï¸', name: 'Zenith', rarity: 'eternal', element: 'nature', type: 'Speedster' },
            { id: 185, char: 'ğŸ³', name: 'Sizzle', rarity: 'common', element: 'fire', type: 'Tank' },
            { id: 186, char: 'ğŸ¤¡', name: 'Chaos', rarity: 'epic', element: 'dark', type: 'Striker' },
            { id: 187, char: 'ğŸ·', name: 'Jazz', rarity: 'rare', element: 'light', type: 'Speedster' },
            { id: 188, char: 'ğŸ¾', name: 'Bounce', rarity: 'common', element: 'nature', type: 'Speedster' },
            { id: 189, char: 'ğŸ“·', name: 'Snap', rarity: 'common', element: 'light', type: 'Speedster' },
            { id: 190, char: 'ğŸ§Š', name: 'Zero', rarity: 'legendary', element: 'water', type: 'Tank' },
            // EXPANSION (55)
            { id: 191, char: 'ğŸ§±', name: 'Brick', rarity: 'common', element: 'nature', type: 'Tank' },
            { id: 192, char: 'ğŸªµ', name: 'Log', rarity: 'common', element: 'nature', type: 'Tank' },
            { id: 193, char: 'ğŸª¨', name: 'Boulder', rarity: 'rare', element: 'nature', type: 'Tank' },
            { id: 194, char: 'ğŸ§¯', name: 'Exting', rarity: 'rare', element: 'fire', type: 'Tank' },
            { id: 195, char: 'ğŸª“', name: 'Axe', rarity: 'rare', element: 'nature', type: 'Striker' },
            { id: 196, char: 'ğŸ§²', name: 'Magnet', rarity: 'common', element: 'light', type: 'Striker' },
            { id: 197, char: 'ğŸ§ª', name: 'Elixir', rarity: 'rare', element: 'light', type: 'Speedster' },
            { id: 198, char: 'ğŸ›¡ï¸', name: 'Bulwark', rarity: 'epic', element: 'light', type: 'Tank' },
            { id: 199, char: 'âš¡', name: 'Bolt', rarity: 'rare', element: 'light', type: 'Striker' },
            { id: 200, char: 'ğŸŒŠ', name: 'Surge', rarity: 'epic', element: 'water', type: 'Striker' },
            { id: 201, char: 'ğŸš', name: 'Pearl', rarity: 'common', element: 'water', type: 'Tank' },
            { id: 202, char: 'ğŸŸ', name: 'Fin', rarity: 'common', element: 'water', type: 'Speedster' },
            { id: 203, char: 'ğŸŠ', name: 'Gator', rarity: 'rare', element: 'water', type: 'Tank' },
            { id: 204, char: 'ğŸ‹', name: 'Coloss', rarity: 'legendary', element: 'water', type: 'Tank' },
            { id: 205, char: 'ğŸ§œâ€â™‚ï¸', name: 'Merman', rarity: 'epic', element: 'water', type: 'Speedster' },
            { id: 206, char: 'ğŸ¦­', name: 'Harbor', rarity: 'common', element: 'water', type: 'Tank' },
            { id: 207, char: 'ğŸ¦…', name: 'Talon', rarity: 'rare', element: 'light', type: 'Striker' },
            { id: 208, char: 'ğŸ¦‰', name: 'Owl', rarity: 'epic', element: 'dark', type: 'Speedster' },
            { id: 209, char: 'ğŸº', name: 'Howl', rarity: 'legendary', element: 'dark', type: 'Striker' },
            { id: 210, char: 'ğŸ¦‚', name: 'Scorch', rarity: 'rare', element: 'fire', type: 'Striker' },
            { id: 211, char: 'ğŸ', name: 'Buzz', rarity: 'common', element: 'nature', type: 'Speedster' },
            { id: 212, char: 'ğŸ§„', name: 'Garlic', rarity: 'common', element: 'nature', type: 'Striker' },
            { id: 213, char: 'ğŸ¥•', name: 'Carrot', rarity: 'common', element: 'nature', type: 'Speedster' },
            { id: 214, char: 'ğŸ¥”', name: 'Spud', rarity: 'common', element: 'nature', type: 'Tank' },
            { id: 215, char: 'ğŸ¥©', name: 'Steak', rarity: 'rare', element: 'fire', type: 'Striker' },
            { id: 216, char: 'ğŸ¥¨', name: 'Twist', rarity: 'common', element: 'fire', type: 'Speedster' },
            { id: 217, char: 'ğŸ¥¯', name: 'Bagel', rarity: 'common', element: 'fire', type: 'Tank' },
            { id: 218, char: 'ğŸœ', name: 'Noodle', rarity: 'rare', element: 'fire', type: 'Speedster' },
            { id: 219, char: 'ğŸ™', name: 'Onigiri', rarity: 'common', element: 'fire', type: 'Tank' },
            { id: 220, char: 'ğŸ§', name: 'Cupcake', rarity: 'rare', element: 'light', type: 'Speedster' },
            { id: 221, char: 'ğŸ‡', name: 'Spark', rarity: 'epic', element: 'fire', type: 'Speedster' },
            { id: 222, char: 'ğŸ†', name: 'Burst', rarity: 'epic', element: 'fire', type: 'Striker' },
            { id: 223, char: 'ğŸª¬', name: 'Charm', rarity: 'divine', element: 'light', type: 'Striker' },
            { id: 224, char: 'ğŸ§Ÿ', name: 'Zombie', rarity: 'epic', element: 'dark', type: 'Tank' },
            { id: 225, char: 'ğŸ§›â€â™‚ï¸', name: 'Lord', rarity: 'legendary', element: 'dark', type: 'Striker' },
            { id: 226, char: 'ğŸœ', name: 'Ant', rarity: 'trash', element: 'nature', type: 'Speedster' },
            { id: 227, char: 'ğŸª³', name: 'Roach', rarity: 'trash', element: 'dark', type: 'Speedster' },
            { id: 228, char: 'ğŸ§»', name: 'Tissue', rarity: 'trash', element: 'light', type: 'Speedster' },
            { id: 229, char: 'ğŸ¥€', name: 'Wilt', rarity: 'trash', element: 'nature', type: 'Striker' },
            { id: 230, char: 'ğŸª£', name: 'Bucket', rarity: 'trash', element: 'water', type: 'Tank' },
            { id: 231, char: 'ğŸ•¸ï¸', name: 'Web', rarity: 'rare', element: 'dark', type: 'Tank' },
            { id: 232, char: 'ğŸ•¯ï¸', name: 'Candle', rarity: 'uncommon', element: 'light', type: 'Striker' },
            { id: 233, char: 'ğŸŒ’', name: 'Crescent', rarity: 'uncommon', element: 'dark', type: 'Speedster' },
            { id: 234, char: 'ğŸŒŒ', name: 'Cosmos', rarity: 'epic', element: 'dark', type: 'Striker' },
            { id: 235, char: 'ğŸª„', name: 'Wand', rarity: 'legendary', element: 'light', type: 'Striker' },
            { id: 236, char: 'ğŸ²', name: 'Dice', rarity: 'rare', element: 'dark', type: 'Speedster' },
            { id: 237, char: 'ğŸ“¿', name: 'Beads', rarity: 'rare', element: 'light', type: 'Tank' },
            { id: 238, char: 'ğŸª™', name: 'Coin', rarity: 'uncommon', element: 'light', type: 'Tank' },
            { id: 239, char: 'ğŸ§µ', name: 'Thread', rarity: 'uncommon', element: 'dark', type: 'Speedster' },
            { id: 240, char: 'ğŸª¡', name: 'Needle', rarity: 'rare', element: 'dark', type: 'Striker' },
            { id: 241, char: 'ğŸ§­', name: 'Compass', rarity: 'epic', element: 'light', type: 'Speedster' },
            { id: 242, char: 'ğŸ¥¶', name: 'Chill', rarity: 'epic', element: 'water', type: 'Tank' },
            { id: 243, char: 'ğŸ—¡ï¸', name: 'Blade', rarity: 'legendary', element: 'fire', type: 'Striker' },
            { id: 244, char: 'ğŸ§‹', name: 'Boba', rarity: 'common', element: 'water', type: 'Speedster' },
            { id: 245, char: 'ğŸ§ ', name: 'Mind', rarity: 'eternal', element: 'dark', type: 'Striker' }
        ];

        const RARITY_ORDER = ['trash', 'common', 'uncommon', 'rare', 'epic', 'legendary', 'divine', 'eternal'];
        const TYPE_WEIGHTS = {
            Striker: { hp: 0.6, atk: 1.5, spd: 0.9, def: 0.7, spAtk: 1.3, spDef: 0.7 },
            Tank: { hp: 1.8, atk: 0.6, spd: 0.6, def: 1.6, spAtk: 0.6, spDef: 1.5 },
            Speedster: { hp: 0.8, atk: 0.8, spd: 1.4, def: 0.8, spAtk: 0.9, spDef: 0.8 }
        };
        const ELEMENT_BONUSES = {
            fire: { hp: 1.0, atk: 1.2, spd: 1.0, def: 0.95, spAtk: 1.2, spDef: 0.95 },
            water: { hp: 1.2, atk: 1.0, spd: 1.0, def: 1.0, spAtk: 1.0, spDef: 1.15 },
            nature: { hp: 1.1, atk: 1.1, spd: 1.0, def: 1.1, spAtk: 1.0, spDef: 1.0 },
            light: { hp: 1.0, atk: 1.0, spd: 1.2, def: 1.0, spAtk: 1.05, spDef: 1.1 },
            dark: { hp: 0.9, atk: 1.3, spd: 1.0, def: 0.95, spAtk: 1.15, spDef: 0.95 }
        };
        const RARITY_MULTIPLIERS = { trash: 0.4, common: 1.0, uncommon: 1.25, rare: 1.5, epic: 2.5, legendary: 4.5, divine: 8.5, eternal: 20.0 };
        const GROWTH_RATES = { trash: 0.12, common: 0.15, uncommon: 0.165, rare: 0.18, epic: 0.22, legendary: 0.28, divine: 0.38, eternal: 0.55 };
        const ELEMENTS = { fire: { beats: 'nature' }, water: { beats: 'fire' }, nature: { beats: 'water' }, light: { beats: 'dark' }, dark: { beats: 'light' } };
        const PROB_TABLES = {
            standard: { trash: 0.05, common: 0.55, uncommon: 0.75, rare: 0.88, epic: 0.965, legendary: 0.995, divine: 0.999, eternal: 1.0 },
            rare: { trash: 0.0, common: 0.0, uncommon: 0.5, rare: 0.82, epic: 0.94, legendary: 0.990, divine: 0.997, eternal: 1.0 },
            legendary: { trash: 0.0, common: 0.0, uncommon: 0.0, rare: 0.6, epic: 0.85, legendary: 0.980, divine: 0.995, eternal: 1.0 }
        };
        const RARITY_COST_MULTIPLIERS = { trash: 0.7, common: 1.0, uncommon: 1.3, rare: 1.7, epic: 2.6, legendary: 4.0, divine: 6.5, eternal: 9.0 };
        const PROMOTE_COST_MULTIPLIERS = { trash: 0.8, common: 1.2, uncommon: 1.6, rare: 2.0, epic: 3.2, legendary: 5.0, divine: 8.0 };
        const ELEMENT_STATUS_EFFECTS = {
            fire: { id: 'burn', name: 'Burn', desc: 'Takes damage each turn and deals reduced physical damage. Fire units are immune.' },
            water: { id: 'soak', name: 'Soak', desc: 'Next damage taken is amplified, then clears. Water units are immune.' },
            nature: { id: 'rooted', name: 'Rooted', desc: 'Reduces speed and drains a small amount each turn. Nature units are immune.' },
            light: { id: 'dazzle', name: 'Dazzle', desc: 'Cannot gain attack or special attack stages and cooldowns recover slower. Light units are immune.' },
            dark: { id: 'curse', name: 'Curse', desc: 'Healing received is reduced while active. Dark units are immune.' }
        };
        const STATUS_RULES = {
            burn: { tickDamagePct: 0.05, physAtkMult: 0.75 },
            soak: { damageAmp: 1.35, consumeOnHit: true },
            rooted: { tickDrainPct: 0.04, spdMult: 0.7 },
            dazzle: { blockAtkStages: true, blockSpAtkStages: true, cooldownSlow: true },
            curse: { healMult: 0.6 }
        };
        const STATUS_APPLY_CHANCE = 0.2;
        /*
         * Move Identity + Rarity Philosophy (balance rework notes)
         * Elements:
         * - Fire: burst damage, pressure, aggressive tempo, recoil.
         * - Water: control, sustain, and momentum swings.
         * - Nature: attrition, drains, and debuff + damage.
         * - Light: protection, support, and tempo stabilization.
         * - Dark: risk-reward power, buffs + damage, and comeback tools.
         *
         * Rarity:
         * - trash/common/uncommon: simple, reliable, low cooldown, modest impact.
         * - rare/epic: clear identity, stronger efficiency or utility, tradeoffs.
         * - legendary/divine/eternal: splashy, high ceiling, longer cooldowns.
         *
         * Move Effects:
         * - damage: direct HP impact, varying power and target.
         * - heal: restore HP to self or allies. Scale less than damage given rarity.
         * - buff: increase own or allies' stats for the match.
         * - debuff: decrease enemy stats for the match.
         * - status: apply status conditions with unique effects.
         * - recoil: damage self as tradeoff for higher power or more effects.
         * 
         * Guidelines for new moves:
         * - Always set: power, cooldown, kind, target, element, damageType, rarity.
         * - Use 50 power as baseline; higher power implies higher cooldown or narrower target.
         * - AoE moves should be lower power; single-target damage must be higher power than 45 (as same element attack bonus brings above 50 power effectively), scaled by rarity.
         * - Moves that combine effects should have lower base power or higher cooldown.
         *   - Example: damage + status chance, damage + debuff, heal + buff.
         * - Moves that have negative tradeoffs can have higher base power, lower cooldown or enemy-all targeting.
         *   - Example: self-debuff, all-team-debuff, recoil, self-status.
         * - Buffs/debuffs are be stage-based. Do not have max HP buffs.
         * - Status application should be rare or gated.
         * - Keep element identity intact; avoid cross-element gimmicks unless rare+.
         */
        const MOVES = [
            /* Basic move */
            { id: 'basic_strike', name: 'Basic Strike', power: 50, cooldown: 1, kind: 'damage', target: 'enemy-single', element: 'neutral', damageType: 'physical', rarity: 'common', special: null },

            /* Fire Moves */
            { id: 'cinder_jab', name: 'Cinder Jab', power: 48, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'fire', damageType: 'physical', rarity: 'common', special: null },
            { id: 'flare_step', name: 'Flare Step', power: 0, cooldown: 3, kind: 'buff', target: 'self', element: 'fire', damageType: 'status', rarity: 'common', effect: { spd: 1 }, special: null },
            { id: 'ember_wave', name: 'Ember Wave', power: 30, cooldown: 3, kind: 'damage', target: 'enemy-all', element: 'fire', damageType: 'special', rarity: 'uncommon', special: null },
            { id: 'flame_rush', name: 'Flame Rush', power: 70, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'fire', damageType: 'special', rarity: 'rare', effect: { recoilPct: 0.2 }, special: null },
            { id: 'heat_shield', name: 'Heat Shield', power: 0, cooldown: 4, kind: 'buff', target: 'self', element: 'fire', damageType: 'status', rarity: 'epic', effect: { def: 1, spDef: 1 }, special: null },
            { id: 'magma_quake', name: 'Magma Quake', power: 70, cooldown: 4, kind: 'damage', target: 'enemy-all', element: 'fire', damageType: 'special', rarity: 'legendary', effect: { recoilPct: 0.25 }, special: null },

            /* Water Moves */
            { id: 'ice_barbs', name: 'Ice Barbs', power: 24, cooldown: 3, kind: 'damage', target: 'enemy-all', element: 'water', damageType: 'special', rarity: 'common', special: null },
            { id: 'ripple_cut', name: 'Ripple Cut', power: 44, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'water', damageType: 'physical', rarity: 'common', special: null },
            { id: 'torrent_edge', name: 'Torrent Edge', power: 52, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'water', damageType: 'physical', rarity: 'uncommon', special: null },
            { id: 'tidal_spear', name: 'Tidal Spear', power: 60, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'water', damageType: 'special', rarity: 'rare', special: null },
            { id: 'soothing_rain', name: 'Soothing Rain', power: 35, cooldown: 4, kind: 'heal', target: 'ally-all', element: 'water', damageType: 'status', rarity: 'epic', special: null },
            { id: 'frost_shell', name: 'Frost Shell', power: 0, cooldown: 4, kind: 'buff', target: 'self', element: 'water', damageType: 'status', rarity: 'epic', effect: { def: 1, spDef: 1 }, special: null },

            /* Nature Moves */
            { id: 'thorns_pulse', name: 'Thorns Pulse', power: 26, cooldown: 3, kind: 'damage', target: 'enemy-all', element: 'nature', damageType: 'special', rarity: 'common', effect: { targetStages: { spd: -1 } }, special: null },
            { id: 'briar_strike', name: 'Briar Strike', power: 48, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'nature', damageType: 'physical', rarity: 'common', effect: { targetStages: { def: -1 } }, special: null },
            { id: 'seed_bloom', name: 'Seed Bloom', power: 50, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'nature', damageType: 'special', rarity: 'uncommon', effect: { drainPct: 0.20 }, special: null },
            { id: 'vine_lash', name: 'Vine Lash', power: 55, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'nature', damageType: 'physical', rarity: 'rare', effect: { drainPct: 0.35 }, special: null },
            { id: 'quicksand', name: 'Quicksand', power: 20, cooldown: 3, kind: 'damage', target: 'enemy-all', element: 'nature', damageType: 'special', rarity: 'rare', effect: { targetStages: { spd: -1 } }, special: null },

            /* Light Moves */
            { id: 'spark_jab', name: 'Spark Jab', power: 45, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'light', damageType: 'physical', rarity: 'common', special: null },
            { id: 'lumen_guard', name: 'Lumen Guard', power: 0, cooldown: 3, kind: 'buff', target: 'self', element: 'light', damageType: 'status', rarity: 'common', effect: { def: 1, spDef: 1 }, special: null },
            { id: 'radiant_burst', name: 'Radiant Burst', power: 30, cooldown: 3, kind: 'damage', target: 'enemy-all', element: 'light', damageType: 'special', rarity: 'uncommon', special: null },
            { id: 'sunbeam', name: 'Sunbeam', power: 68, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'light', damageType: 'special', rarity: 'rare', special: null },
            { id: 'blessing_wall', name: 'Blessing Wall', power: 0, cooldown: 4, kind: 'buff', target: 'ally-all', element: 'light', damageType: 'status', rarity: 'epic', effect: { def: 1, spDef: 1 }, special: null },
            { id: 'aegis_pulse', name: 'Aegis Pulse', power: 0, cooldown: 4, kind: 'buff', target: 'ally-all', element: 'light', damageType: 'status', rarity: 'legendary', effect: { def: 1, spDef: 1, spd: 1 }, special: null },

            /* Dark Moves */
            { id: 'void_chill', name: 'Void Chill', power: 40, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'special', rarity: 'common', effect: { selfStages: { spAtk: 1 } }, special: null },
            { id: 'dusk_cut', name: 'Dusk Cut', power: 48, cooldown: 2, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'physical', rarity: 'common', effect: { selfStages: { spd: 1 } }, special: null },
            { id: 'shadow_gale', name: 'Shadow Gale', power: 60, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'special', rarity: 'uncommon', effect: { selfStages: { spd: 1 }, recoilPct: 0.1 }, special: null },
            { id: 'moon_slash', name: 'Moon Slash', power: 65, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'physical', rarity: 'rare', effect: { selfStages: { atk: 1 } }, special: null },
            { id: 'night_howl', name: 'Night Howl', power: 70, cooldown: 4, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'special', rarity: 'epic', effect: { selfStages: { atk: 1, spd: 1 }, recoilPct: 0.2 }, special: null },
            { id: 'shadow_slice', name: 'Shadow Slice', power: 82, cooldown: 3, kind: 'damage', target: 'enemy-single', element: 'dark', damageType: 'special', rarity: 'legendary', effect: { selfStages: { spAtk: 1 }, recoilPct: 0.25 }, special: null }
        ];
        const EMOJI_DESCS = {
            101: 'Rattles around, stubbornly guards scraps.',
            102: 'Smug little lump that never backs down.',
            103: 'Clicks and clacks, chasing any fight.',
            104: 'Creaky but loyal, shelters allies.',
            105: 'Kicks first, asks later.',
            106: 'Sneaky and clingy, loves weird pranks.',
            107: 'Slips foes and laughs at chaos.',
            108: 'Dim but persistent, powers through setbacks.',
            1: 'Blazes in loud bursts and never cools.',
            2: 'Slow, heavy, and patient, then erupts.',
            3: 'Proud hunter who strikes with fiery pride.',
            4: 'Flashes by, leaving scorched trails.',
            5: 'Roars for attention, fights like royalty.',
            61: 'Spicy and impatient, always darting in.',
            62: 'Grills everything, even its own jokes.',
            64: 'Gruff bruiser who loves a good brawl.',
            109: 'Crackling energy, never sits still.',
            110: 'Playful spinner with a hot temper.',
            146: 'Sharp wit, sharper bite.',
            147: 'Always chomping, never quiet.',
            148: 'Loud showoff who fights to a beat.',
            149: 'Rocket confident, aims straight for glory.',
            150: 'Stands ground and dares you to move.',
            151: 'Rowdy tank that toasts every win.',
            152: 'Radiant leader with scorching resolve.',
            153: 'Sugary sweet, then suddenly lethal.',
            6: 'Calm skimmer that dodges in waves.',
            7: 'Hungry challenger that circles its prey.',
            8: 'Massive guardian that refuses to fall.',
            9: 'Charmingly tricky, lures foes off guard.',
            10: 'Grabs and crushes with steady menace.',
            66: 'Cold and sturdy, freezes the pace.',
            111: 'Lazy current, still hits with momentum.',
            112: 'Bubbly powerhouse that erupts on cue.',
            113: 'Quick boat that shields and rams.',
            154: 'Pinches hard, holds on harder.',
            155: 'Hides, then counters with a snap.',
            156: 'Nimble swimmer with a mean jab.',
            157: 'Deflates drama, then strikes back.',
            158: 'Cute feints, sudden icy rush.',
            159: 'Elegant dodger that never gets caught.',
            160: 'Fast talker, faster finisher.',
            161: 'Umbrella guardian, blocks every storm.',
            11: 'Earnest helper that grows braver each fight.',
            12: 'Wild striker who loves ambushes.',
            13: 'Dreamy runner with dazzling tricks.',
            14: 'Stoic wall that refuses to budge.',
            15: 'Cheery fighter who blooms in danger.',
            70: 'Fluttery artist who drifts past hits.',
            114: 'Grumpy guardian with a stubborn tongue.',
            115: 'Hyper scout that never stops moving.',
            162: 'Big-hearted bruiser with thunderous swings.',
            163: 'Gentle giant that tramples threats.',
            164: 'Long sight, slow steps, steady hits.',
            165: 'Quick zigzag runner with bold stripes.',
            166: 'Patient striker, squeezes the life out.',
            167: 'Slow tank that laughs at damage.',
            168: 'Prickly defender that pokes back.',
            169: 'Charming speedster who lands lucky hits.',
            16: 'Sparkly sprinter with restless energy.',
            17: 'Calm protector who never panics.',
            18: 'Regal striker who demands respect.',
            19: 'Glittering bulwark with unbreakable pride.',
            20: 'Silent watcher that predicts your moves.',
            117: 'Immovable fortress with iron patience.',
            118: 'Gentle scout who ends fights quickly.',
            170: 'Graceful champion who refuses to yield.',
            171: 'Holy attacker, fearless and bright.',
            172: 'Colorful runner that refracts danger.',
            173: 'Opulent tank that hoards the frontline.',
            174: 'Wishmaker that strikes with calm purpose.',
            175: 'Quick thinker with sudden jolts.',
            176: 'Quiet virtuoso who fights in rhythm.',
            21: 'Chill shadow that glides through blows.',
            22: 'Hungry duelist with a smirking bite.',
            23: 'Cold stare, heavy hits, no mercy.',
            24: 'Ghostly runner that haunts the backline.',
            120: 'Explosive troublemaker who loves chaos.',
            121: 'Patient trapper with a cruel grin.',
            177: 'Deep tank that swallows pressure.',
            178: 'Curious raider with alien tactics.',
            179: 'Silent finisher, harvests weak foes.',
            180: 'Bites fast and disappears.',
            181: 'Cryptic sprinter that sees the opening.',
            182: 'Weird genius who fights unpredictably.',
            183: 'Stage thief who strikes from behind.',
            184: 'Slow menace that squeezes hope.',
            58: 'Eternal striker, bends the battlefield.',
            59: 'Endless wall, never seems to tire.',
            60: 'Peak runner, always chasing higher ground.',
            185: 'Breakfast bruiser, sunny but tough.',
            186: 'Clown of doom, thrives on disorder.',
            187: 'Smooth dodger who improvises every hit.',
            188: 'Springy prankster that ricochets around.',
            189: 'Quick shot, always gets the angle.',
            190: 'Ice-cold sentinel that shuts down heat.',
            191: 'Plain but solid, holds the line.',
            192: 'Lazy lunk that rolls through trouble.',
            193: 'Heavy hitter that grinds forward.',
            194: 'Douses drama and tanks the flames.',
            195: 'Loud lumberer who chops first.',
            196: 'Attracts hits, then fires back.',
            197: 'Clever sprinter, always prepared.',
            198: 'Shining shield that anchors the team.',
            199: 'Flash attacker with crackling focus.',
            200: 'Tidal striker that overwhelms fast.',
            201: 'Quiet guardian with a hidden shine.',
            202: 'Speedy swimmer, playful but fierce.',
            203: 'Ambush tank with a death roll.',
            204: 'Ocean giant that towers over threats.',
            205: 'Trickster scout, swims in spirals.',
            206: 'Safe refuge that blocks the storm.',
            207: 'Sharp-eyed hunter, strikes clean.',
            208: 'Night scout with silent swoops.',
            209: 'Pack leader who rallies the charge.',
            210: 'Hot-tempered duelist, stings hard.',
            211: 'Tiny blur that never stops.',
            212: 'Pungent brawler that keeps foes away.',
            213: 'Bright sprinter with stubborn grit.',
            214: 'Stout defender with hidden grit.',
            215: 'Savage striker, always hungry.',
            216: 'Twisty dodger, hard to pin.',
            217: 'Dense tank, surprisingly tough.',
            218: 'Slippery runner, hard to grab.',
            219: 'Comforting wall, steady and stout.',
            220: 'Sweet-faced striker with a mean bite.',
            221: 'Firework sprinter, all flash and speed.',
            222: 'Big boom bruiser, loves impact.',
            223: 'Lucky fighter that bends fate.',
            224: 'Shambling tank, refuses to stay down.',
            225: 'Noble predator with a velvet menace.',
            226: 'Tireless worker, swarms the field.',
            227: 'Survivor that never goes away.',
            228: 'Fragile prankster, flutters and distracts.',
            229: 'Sour striker that saps energy.',
            230: 'Clumsy guard, still catches hits.',
            231: 'Sticky defender that traps attackers.',
            232: 'Quiet flame that watches and waits.',
            233: 'Night runner, glides in arcs.',
            234: 'Starfield brawler, fights with awe.',
            235: 'Focused caster with a sharp edge.',
            236: 'Risky rogue who loves the odds.',
            237: 'Steady guardian, patient and grounded.',
            238: 'Greedy wall, guards its stash.',
            239: 'Sly runner, slips through gaps.',
            240: 'Precise striker, hits vital points.',
            241: 'Guiding scout, never loses direction.',
            242: 'Frost tank that slows the room.',
            243: 'Relentless duelist, cuts clean.',
            244: 'Bubbly speedster, playful and quick.',
            245: 'Ancient thinker, strikes with calm certainty.'
        };

        const DEFAULT_STATE = { gold: 5000, tickets: 20, rareTickets: 0, legendaryTickets: 0, pity: 0, inventory: {}, team: [], stage: 1, isAutoBattling: false };
        let state = { ...DEFAULT_STATE };
        let selectedId = null;
        let currentSlot = 1;

        EMOJIS.forEach(emoji => { emoji.desc = EMOJI_DESCS[emoji.id]; });

        // --- CORE ---
        function init() { loadSlot(resolveInitialSlot()); updateStatsUI(); switchTab('summon'); }
        function getSaveKey(slot) { return `emojiSaga_vInfinite_slot${slot}`; }
        function resolveInitialSlot() {
            const stored = parseInt(localStorage.getItem('emojiSaga_vInfinite_slot'), 10);
            const slot = [1, 2, 3].includes(stored) ? stored : 1;
            const legacy = localStorage.getItem('emojiSaga_vInfinite');
            if (legacy && !localStorage.getItem(getSaveKey(1))) {
                localStorage.setItem(getSaveKey(1), legacy);
                localStorage.removeItem('emojiSaga_vInfinite');
            }
            localStorage.setItem('emojiSaga_vInfinite_slot', slot);
            return slot;
        }
        function save() { localStorage.setItem(getSaveKey(currentSlot), JSON.stringify(state)); }
        function loadSlot(slot) {
            currentSlot = slot;
            const saved = localStorage.getItem(getSaveKey(slot));
            state = { ...DEFAULT_STATE };
            if (saved) {
                state = { ...state, ...JSON.parse(saved) };
                if (state.rareKeys) { state.rareTickets = state.rareKeys; delete state.rareKeys; }
                if (state.legendaryKeys) { state.legendaryTickets = state.legendaryKeys; delete state.legendaryKeys; }
                Object.keys(state.inventory).forEach(id => {
                    if (!state.inventory[id].baseRarity) {
                        const orig = EMOJIS.find(x => x.id == id) || EMOJIS[0];
                        state.inventory[id].baseRarity = orig.rarity;
                        state.inventory[id].currentRarity = orig.rarity;
                    }
                    if (state.inventory[id].dupes === undefined) state.inventory[id].dupes = 0;
                });
            }
            state.isAutoBattling = false;
            selectedId = null;
            updateSlotUI();
        }

        function updateSlotUI() {
            [1, 2, 3].forEach(slot => {
                const btn = document.getElementById(`slot-btn-${slot}`);
                if (!btn) return;
                if (slot === currentSlot) btn.classList.add('bg-indigo-500', 'text-white');
                else btn.classList.remove('bg-indigo-500', 'text-white');
            });
        }

        function selectSaveSlot(slot) {
            if (slot === currentSlot) return;
            stopAutoBattle();
            localStorage.setItem('emojiSaga_vInfinite_slot', slot);
            loadSlot(slot);
            updateStatsUI();
            switchTab('summon');
        }

        function newGameCurrentSlot() {
            if (!confirm(`Start a new game in Slot ${currentSlot}? This will overwrite the current save.`)) return;
            stopAutoBattle();
            state = { ...DEFAULT_STATE };
            save(); updateStatsUI(); switchTab('summon'); toast("NEW GAME");
        }

        function deleteCurrentSlot() {
            if (!confirm(`Delete Slot ${currentSlot}? This cannot be undone.`)) return;
            stopAutoBattle();
            localStorage.removeItem(getSaveKey(currentSlot));
            state = { ...DEFAULT_STATE };
            save(); updateStatsUI(); switchTab('summon'); toast("SAVE DELETED");
        }

        function updateStatsUI() {
            document.getElementById('stat-gold').innerText = state.gold.toLocaleString();
            document.getElementById('stat-tickets').innerText = state.tickets.toLocaleString();
            document.getElementById('stat-rare-tickets').innerText = state.rareTickets.toLocaleString();
            document.getElementById('stat-legendary-tickets').innerText = state.legendaryTickets.toLocaleString();
            document.getElementById('pity-count').innerText = `${state.pity}/50`;
            document.getElementById('arena-stage-title').innerText = state.stage;
            document.getElementById('collection-count').innerText = `${Object.keys(state.inventory).length}/${EMOJIS.length}`;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`btn-tab-${tab}`).classList.add('tab-active');
            if (tab === 'team') renderTeam();
        }

        function toast(msg) {
            const t = document.getElementById('toast'); t.innerText = msg; t.classList.replace('opacity-0', 'opacity-100');
            setTimeout(() => t.classList.replace('opacity-100', 'opacity-0'), 2000);
        }

        // --- CALC ---
        function calcStats(id) {
            const e = EMOJIS.find(x => x.id === id) || EMOJIS[0];
            const inv = state.inventory[id];
            const baseObj = { hp: 100, atk: 20, spd: 10, def: 15, spAtk: 18, spDef: 15 };
            const weights = TYPE_WEIGHTS[e.type];
            let hp = baseObj.hp * weights.hp;
            let atk = baseObj.atk * weights.atk;
            let spd = baseObj.spd * weights.spd;
            let def = baseObj.def * weights.def;
            let spAtk = baseObj.spAtk * weights.spAtk;
            let spDef = baseObj.spDef * weights.spDef;
            const aff = ELEMENT_BONUSES[e.element];
            hp *= aff.hp; atk *= aff.atk; spd *= aff.spd; def *= aff.def; spAtk *= aff.spAtk; spDef *= aff.spDef;
            
            const multCurrent = RARITY_MULTIPLIERS[inv.currentRarity];
            const multBase = RARITY_MULTIPLIERS[inv.baseRarity];
            const baseIdx = RARITY_ORDER.indexOf(inv.baseRarity);
            const currentIdx = RARITY_ORDER.indexOf(inv.currentRarity);
            const rarityGap = Math.max(0, currentIdx - baseIdx);
            let rarityModifier = multCurrent * Math.pow(multBase / multCurrent, 0.3);
            if (rarityGap > 2) {
                rarityModifier *= Math.pow(0.65, rarityGap - 2);
            }
            hp *= rarityModifier; atk *= rarityModifier; spd *= rarityModifier; def *= rarityModifier; spAtk *= rarityModifier; spDef *= rarityModifier;
            const growth = 1 + ((inv.lvl - 1) * GROWTH_RATES[inv.currentRarity]);
            return {
                hp: Math.floor(hp * growth),
                atk: Math.floor(atk * growth),
                spd: Math.floor(spd * growth),
                def: Math.floor(def * growth),
                spAtk: Math.floor(spAtk * growth),
                spDef: Math.floor(spDef * growth)
            };
        }

        function calcEnemyStats(emoji, level, rarity) {
            const baseObj = { hp: 100, atk: 20, spd: 10, def: 15, spAtk: 18, spDef: 15 };
            const weights = TYPE_WEIGHTS[emoji.type];
            let hp = baseObj.hp * weights.hp;
            let atk = baseObj.atk * weights.atk;
            let spd = baseObj.spd * weights.spd;
            let def = baseObj.def * weights.def;
            let spAtk = baseObj.spAtk * weights.spAtk;
            let spDef = baseObj.spDef * weights.spDef;
            const aff = ELEMENT_BONUSES[emoji.element];
            hp *= aff.hp; atk *= aff.atk; spd *= aff.spd; def *= aff.def; spAtk *= aff.spAtk; spDef *= aff.spDef;
            const rarityModifier = RARITY_MULTIPLIERS[rarity];
            const growth = 1 + ((level - 1) * GROWTH_RATES[rarity]);
            return {
                hp: Math.floor(hp * rarityModifier * growth),
                atk: Math.floor(atk * rarityModifier * growth),
                spd: Math.floor(spd * rarityModifier * growth),
                def: Math.floor(def * rarityModifier * growth),
                spAtk: Math.floor(spAtk * rarityModifier * growth),
                spDef: Math.floor(spDef * rarityModifier * growth)
            };
        }

        function getMoveById(id) {
            return MOVES.find(move => move.id === id);
        }

        function getMoveListForEmoji(emoji) {
            const moveIds = ['basic_strike', getMoveIdForEmoji(emoji)];
            return [...new Set(moveIds)].map(getMoveById).filter(Boolean);
        }

        function getMoveIdForEmoji(emoji) {
            if (emoji.element === 'fire') {
                if (emoji.type === 'Tank') return 'heat_shield';
                if (emoji.type === 'Speedster') return 'ember_wave';
                return 'flame_rush';
            }
            if (emoji.element === 'water') {
                if (emoji.type === 'Tank') return 'soothing_rain';
                if (emoji.type === 'Speedster') return 'ice_barbs';
                return 'tidal_spear';
            }
            if (emoji.element === 'nature') {
                if (emoji.type === 'Tank') return 'seed_bloom';
                return 'vine_lash';
            }
            if (emoji.element === 'light') {
                if (emoji.type === 'Tank') return 'blessing_wall';
                return 'radiant_burst';
            }
            if (emoji.element === 'dark') {
                if (emoji.type === 'Speedster') return 'night_howl';
                return 'shadow_slice';
            }
            return 'flame_rush';
        }

        function attachMoves(unit) {
            const moveId = getMoveIdForEmoji(unit);
            const moveList = ['basic_strike', moveId];
            unit.moves = [...new Set(moveList)];
            unit.cooldowns = {};
            unit.moves.forEach(id => { unit.cooldowns[id] = 0; });
            unit.statStages = { atk: 0, def: 0, spAtk: 0, spDef: 0, spd: 0 };
            unit.status = null;
            unit.cooldownSlowToggle = false;
        }

        function resetBaseStats(unit) {
            unit.baseStats = {
                atk: unit.atk,
                def: unit.def,
                spAtk: unit.spAtk,
                spDef: unit.spDef,
                spd: unit.spd
            };
        }

        function tickCooldowns(unit) {
            if (!unit.cooldowns) return;
            if (unit.status?.id === 'dazzle' && STATUS_RULES.dazzle.cooldownSlow) {
                unit.cooldownSlowToggle = !unit.cooldownSlowToggle;
                if (!unit.cooldownSlowToggle) return;
            }
            Object.keys(unit.cooldowns).forEach(id => {
                if (unit.cooldowns[id] > 0) unit.cooldowns[id] -= 1;
            });
        }

        function pickMove(unit) {
            if (!unit.moves) return null;
            const ready = unit.moves.filter(id => unit.cooldowns[id] === 0);
            if (!ready.length) return null;
            const nonBasic = ready.filter(id => id !== 'basic_strike');
            const pool = nonBasic.length ? nonBasic : ready;
            const pickId = pool[Math.floor(Math.random() * pool.length)];
            return getMoveById(pickId);
        }

        function getEffectivePower(user, move, basePower) {
            if (!move) return basePower;
            if (move.element && move.element === user.element) return Math.floor(basePower * 1.5);
            return basePower;
        }

        function getStageMultiplier(stage) {
            const table = { '-3': 0.34, '-2': 0.5, '-1': 0.67, '0': 1, '1': 1.5, '2': 2.0, '3': 2.5 };
            return table[stage] || 1;
        }

        function getModifiedStat(unit, stat) {
            const base = unit.baseStats?.[stat] ?? unit[stat];
            const stage = unit.statStages?.[stat] ?? 0;
            let value = base * getStageMultiplier(stage);
            if (stat === 'spd' && unit.status?.id === 'rooted') {
                value *= STATUS_RULES.rooted.spdMult;
            }
            return value;
        }

        function calcDamage(attacker, defender, power, move) {
            const effectivePower = getEffectivePower(attacker, move, power);
            const variance = 0.85 + Math.random() * 0.3;
            const isSpecial = move?.damageType === 'special';
            let atkStat = getModifiedStat(attacker, isSpecial ? 'spAtk' : 'atk');
            if (!isSpecial && attacker.status?.id === 'burn') {
                atkStat *= STATUS_RULES.burn.physAtkMult;
            }
            const defStat = Math.max(1, getModifiedStat(defender, isSpecial ? 'spDef' : 'def'));
            const base = atkStat * (effectivePower / 50) * variance;
            const mitigation = 100 / (100 + defStat);
            return Math.max(1, Math.floor(base * mitigation));
        }

        function calcHeal(user, power, move) {
            const effectivePower = getEffectivePower(user, move, power);
            const variance = 0.9 + Math.random() * 0.2;
            return Math.max(1, Math.floor(getModifiedStat(user, 'spAtk') * (effectivePower / 50) * variance));
        }

        function canApplyStatus(target, status, sourceElement) {
            if (!status || target.status) return false;
            if (target.element === sourceElement) return false;
            return true;
        }

        function tryApplyStatus(user, target, move, log) {
            if (!move || move.kind !== 'damage') return;
            if (!move.element || move.element === 'neutral') return;
            const status = ELEMENT_STATUS_EFFECTS[move.element];
            if (!canApplyStatus(target, status, move.element)) return;
            if (Math.random() > STATUS_APPLY_CHANCE) return;
            target.status = { id: status.id, name: status.name, element: move.element };
            if (status.id === 'dazzle') target.cooldownSlowToggle = false;
            log.innerHTML += `<div>${target.char} is afflicted with ${status.name}</div>`;
        }

        function applyStatusTick(unit, log) {
            if (!unit.status) return;
            const rules = STATUS_RULES[unit.status.id];
            if (!rules) return;
            if (rules.tickDamagePct) {
                const dmg = Math.max(1, Math.floor(unit.maxHp * rules.tickDamagePct));
                unit.hp -= dmg;
                log.innerHTML += `<div>${unit.char} suffers ${dmg} from ${unit.status.name}</div>`;
            }
            if (rules.tickDrainPct) {
                const dmg = Math.max(1, Math.floor(unit.maxHp * rules.tickDrainPct));
                unit.hp -= dmg;
                log.innerHTML += `<div>${unit.char} is drained for ${dmg}</div>`;
            }
        }

        function applyStageChanges(target, stages) {
            if (!stages) return;
            if (stages.atk) {
                if (!(target.status?.id === 'dazzle' && stages.atk > 0)) {
                    target.statStages.atk = Math.max(-3, Math.min(3, target.statStages.atk + stages.atk));
                }
            }
            if (stages.def) target.statStages.def = Math.max(-3, Math.min(3, target.statStages.def + stages.def));
            if (stages.spAtk) {
                if (!(target.status?.id === 'dazzle' && stages.spAtk > 0)) {
                    target.statStages.spAtk = Math.max(-3, Math.min(3, target.statStages.spAtk + stages.spAtk));
                }
            }
            if (stages.spDef) target.statStages.spDef = Math.max(-3, Math.min(3, target.statStages.spDef + stages.spDef));
            if (stages.spd) target.statStages.spd = Math.max(-3, Math.min(3, target.statStages.spd + stages.spd));
        }

        function applyRecoil(user, dmg, recoilPct, log) {
            if (!recoilPct) return;
            const recoil = Math.max(1, Math.floor(dmg * recoilPct));
            user.hp -= recoil;
            log.innerHTML += `<div>${user.char} takes ${recoil} recoil</div>`;
        }

        function applyDrain(user, dmg, drainPct, log) {
            if (!drainPct) return;
            let heal = Math.max(1, Math.floor(dmg * drainPct));
            if (user.status?.id === 'curse') {
                heal = Math.floor(heal * STATUS_RULES.curse.healMult);
            }
            user.hp = Math.min(user.maxHp, user.hp + heal);
            log.innerHTML += `<div>${user.char} drains ${heal} HP</div>`;
        }

        function getTargets(move, user, allies, enemies) {
            const aliveAllies = allies.filter(u => u.hp > 0);
            const aliveEnemies = enemies.filter(u => u.hp > 0);
            if (move.target === 'self') return [user];
            if (move.target === 'ally-single') {
                if (!aliveAllies.length) return [];
                return [aliveAllies.sort((a, b) => a.hp - b.hp)[0]];
            }
            if (move.target === 'ally-all') return aliveAllies;
            if (move.target === 'enemy-all') return aliveEnemies;
            if (move.target === 'enemy-single') {
                if (!aliveEnemies.length) return [];
                return [aliveEnemies.sort((a, b) => a.hp - b.hp)[0]];
            }
            return [];
        }

        function applyMove(user, move, allies, enemies, log) {
            const targets = getTargets(move, user, allies, enemies);
            if (!targets.length) return false;
            if (move.kind === 'damage') {
                targets.forEach(target => {
                    let dmg = calcDamage(user, target, move.power, move);
                    if (target.status?.id === 'soak') {
                        dmg = Math.floor(dmg * STATUS_RULES.soak.damageAmp);
                        target.status = null;
                        log.innerHTML += `<div>${target.char} is soaked!</div>`;
                    }
                    target.hp -= dmg;
                    log.innerHTML += `<div>${user.char} uses ${move.name} for ${Math.floor(dmg)}</div>`;
                    applyStageChanges(target, move.effect?.targetStages);
                    applyStageChanges(user, move.effect?.selfStages);
                    applyRecoil(user, dmg, move.effect?.recoilPct, log);
                    applyDrain(user, dmg, move.effect?.drainPct, log);
                    tryApplyStatus(user, target, move, log);
                });
            } else if (move.kind === 'heal') {
                targets.forEach(target => {
                    let heal = calcHeal(user, move.power, move);
                    if (target.status?.id === 'curse') {
                        heal = Math.floor(heal * STATUS_RULES.curse.healMult);
                    }
                    target.hp = Math.min(target.maxHp, target.hp + heal);
                    log.innerHTML += `<div>${user.char} uses ${move.name} for ${heal} HP</div>`;
                });
            } else if (move.kind === 'buff') {
                targets.forEach(target => {
                    const stages = move.effect?.stages || move.effect?.targetStages || move.effect;
                    applyStageChanges(target, stages);
                    log.innerHTML += `<div>${user.char} uses ${move.name}</div>`;
                });
            }
            return true;
        }

        function pickWeightedRarity(stage) {
            const pools = [
                { max: 3, weights: { trash: 0.45, common: 0.35, uncommon: 0.15, rare: 0.05 } },
                { max: 7, weights: { common: 0.38, uncommon: 0.26, rare: 0.22, epic: 0.1, legendary: 0.04 } },
                { max: 14, weights: { uncommon: 0.3, rare: 0.28, epic: 0.22, legendary: 0.15, divine: 0.05 } },
                { max: 24, weights: { rare: 0.35, epic: 0.27, legendary: 0.22, divine: 0.12, eternal: 0.04 } },
                { max: 39, weights: { epic: 0.34, legendary: 0.3, divine: 0.22, eternal: 0.14 } },
                { max: 45, weights: { legendary: 0.36, divine: 0.34, eternal: 0.3 } },
                { max: Infinity, weights: { divine: 0.55, eternal: 0.45 } }
            ];
            const bucket = pools.find(p => stage <= p.max);
            const roll = Math.random();
            let total = 0;
            for (const [rarity, weight] of Object.entries(bucket.weights)) {
                total += weight;
                if (roll <= total) return rarity;
            }
            return 'common';
        }

        function generateEnemyTeam(stage) {
            let teamSize;
            if (stage < 3) teamSize = 1;
            else if (stage < 6) teamSize = 2;
            else teamSize = 3;

            const baseLevel = Math.min(30, 1 + Math.floor(stage / 3));
            const levelSpread = Math.min(6, Math.floor(stage / 6) + 1);
            const usedIds = new Set();
            const team = [];

            for (let i = 0; i < teamSize; i++) {
                const rarity = pickWeightedRarity(stage);
                const pool = EMOJIS.filter(e => e.rarity === rarity && !usedIds.has(e.id));
                const fallbackPool = EMOJIS.filter(e => e.rarity === rarity);
                const choices = pool.length ? pool : fallbackPool;
                const emoji = choices[Math.floor(Math.random() * choices.length)];
                usedIds.add(emoji.id);
                const level = Math.max(1, baseLevel + Math.floor(Math.random() * levelSpread) - Math.floor(levelSpread / 2));
                const stats = calcEnemyStats(emoji, level, rarity);
                const unit = { ...emoji, ...stats, lvl: level, maxHp: stats.hp, isPlayer: false, currentRarity: rarity };
                attachMoves(unit);
                team.push(unit);
            }
            return team.sort(() => Math.random() - 0.5);
        }

        function getArenaReward(stage) {
            if (stage <= 3) return 80 * stage;
            if (stage <= 7) return 160 * stage;
            if (stage <= 15) return 280 * stage;
            return 400 * stage;
        }

        function getLevelUpCost(inv) {
            return Math.floor(inv.lvl * 250 * RARITY_COST_MULTIPLIERS[inv.currentRarity]);
        }

        function getPromoteCost(inv) {
            return Math.floor(5000 * PROMOTE_COST_MULTIPLIERS[inv.currentRarity]);
        }

        function rollRarity(probTable) {
            const rand = Math.random();
            if (rand < probTable.trash) return 'trash';
            if (rand < probTable.common) return 'common';
            if (rand < probTable.uncommon) return 'uncommon';
            if (rand < probTable.rare) return 'rare';
            if (rand < probTable.epic) return 'epic';
            if (rand < probTable.legendary) return 'legendary';
            if (rand < probTable.divine) return 'divine';
            return 'eternal';
        }

        // --- GACHA ---
        async function startSummonSequence(count, summonType = 'standard') {
            const typeConfig = {
                standard: { key: 'tickets', probs: PROB_TABLES.standard },
                rare: { key: 'rareTickets', probs: PROB_TABLES.rare },
                legendary: { key: 'legendaryTickets', probs: PROB_TABLES.legendary }
            }[summonType] || { key: 'tickets', probs: PROB_TABLES.standard };
            if (state[typeConfig.key] < count) { toast("NO TICKETS!"); return; }
            state[typeConfig.key] -= count; updateStatsUI();
            const results = [];
            for (let i = 0; i < count; i++) {
                state.pity++;
                let rarity = 'common';
                if (state.pity >= 50) { rarity = 'legendary'; state.pity = 0; }
                else rarity = rollRarity(typeConfig.probs);
                const pool = EMOJIS.filter(e => e.rarity === rarity);
                const emoji = pool[Math.floor(Math.random() * pool.length)];
                const isNew = !state.inventory[emoji.id];
                results.push({ emoji, isNew });
                if (isNew) state.inventory[emoji.id] = { lvl: 1, baseRarity: emoji.rarity, currentRarity: emoji.rarity, dupes: 0 };
                else state.inventory[emoji.id].dupes = (state.inventory[emoji.id].dupes || 0) + 1;
            }
            save(); renderSummonResults(results);
        }

        async function renderSummonResults(results) {
            const overlay = document.getElementById('summon-result-overlay');
            const grid = document.getElementById('summon-grid');
            grid.innerHTML = ''; document.getElementById('btn-summon-close').classList.add('hidden');
            overlay.classList.remove('hidden');
            for (let i = 0; i < results.length; i++) {
                await new Promise(r => setTimeout(r, 100));
                const res = results[i];
                const emoji = res.emoji || res;
                const isNew = !!res.isNew;
                const card = document.createElement('div');
                card.className = `card-base w-28 h-40 rounded-2xl border-2 flex flex-col items-center justify-center p-3 card-reveal rarity-card-${emoji.rarity}`;
                card.innerHTML = `
                    ${isNew ? '<div class="absolute top-2 right-2 bg-emerald-400 text-black text-[7px] font-black px-2 py-1 rounded-full">NEW</div>' : ''}
                    <div class="text-[7px] font-black uppercase mb-1">${emoji.rarity}</div>
                    <div class="text-5xl mb-2">${emoji.char}</div>
                    <div class="text-[9px] font-black text-center uppercase truncate w-full">${emoji.name}</div>
                `;
                grid.appendChild(card);
            }
            document.getElementById('btn-summon-close').classList.remove('hidden');
        }

        function closeSummonResults() { document.getElementById('summon-result-overlay').classList.add('hidden'); }

        // --- TEAM ---
        function renderTeam() {
            const rosterGrid = document.getElementById('roster-grid');
            const teamSlots = document.getElementById('team-slots');
            rosterGrid.innerHTML = ''; teamSlots.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const id = state.team[i];
                const slot = document.createElement('div');
                slot.className = "flex-1 rounded-xl border-2 border-dashed border-white/10 bg-white/5 flex items-center justify-center text-3xl";
                if (id) {
                    const inv = state.inventory[id];
                    const e = EMOJIS.find(x => x.id === id) || EMOJIS[0];
                    slot.className = `flex-1 rounded-xl border-2 flex items-center justify-center text-4xl bg-slate-900 cursor-pointer card-base rarity-card-${inv.currentRarity}`;
                    slot.innerHTML = e.char;
                    slot.onclick = () => inspect(id);
                }
                teamSlots.appendChild(slot);
            }
            Object.keys(state.inventory).forEach(idStr => {
                const id = parseInt(idStr);
                const e = EMOJIS.find(x => x.id === id) || EMOJIS[0];
                const inv = state.inventory[id];
                const item = document.createElement('div');
                item.className = `card-base aspect-square rounded-xl border-2 flex flex-col items-center justify-center cursor-pointer transition-transform hover:scale-105 rarity-card-${inv.currentRarity} ${state.team.includes(id) ? 'opacity-30' : ''} ${selectedId === id ? 'ring-2 ring-white' : ''}`;
                item.innerHTML = `<div class="text-2xl">${e.char}</div><div class="text-[7px] font-black">LV.${inv.lvl}</div>`;
                item.onclick = () => inspect(id);
                rosterGrid.appendChild(item);
            });
        }

        function inspect(id) {
            selectedId = id;
            const e = EMOJIS.find(x => x.id === id) || EMOJIS[0];
            const inv = state.inventory[id];
            const stats = calcStats(id);
            
            document.getElementById('inspect-emoji').innerText = e.char;
            document.getElementById('inspect-name').innerText = e.name;
            document.getElementById('inspect-lvl').innerText = inv.lvl;
            document.getElementById('inspect-hp').innerText = stats.hp.toLocaleString();
            document.getElementById('inspect-atk').innerText = stats.atk.toLocaleString();
            document.getElementById('inspect-spd').innerText = stats.spd.toLocaleString();
            document.getElementById('inspect-def').innerText = stats.def.toLocaleString();
            document.getElementById('inspect-spatk').innerText = stats.spAtk.toLocaleString();
            document.getElementById('inspect-spdef').innerText = stats.spDef.toLocaleString();
            
            // New Badge Logic
            const elBadge = document.getElementById('inspect-element-badge');
            const typeBadge = document.getElementById('inspect-type-badge');
            elBadge.innerText = e.element;
            elBadge.className = `type-badge element-${e.element} font-black`;
            typeBadge.innerText = e.type;

            const rarityBadge = document.getElementById('inspect-rarity-badge');
            rarityBadge.innerText = `${inv.currentRarity.toUpperCase()} (NAT ${inv.baseRarity.toUpperCase()})`;
            rarityBadge.className = `inline-block px-3 py-1 rounded-full text-[7px] font-black uppercase mb-4 tracking-widest border border-white/20 text-${inv.currentRarity}`;
            document.getElementById('inspect-desc').innerText = e.desc;
            const typeCount = Object.keys(state.inventory).filter(idStr => {
                const id = parseInt(idStr, 10);
                const entry = EMOJIS.find(x => x.id === id);
                return entry && entry.type === e.type;
            }).length;
            document.getElementById('inspect-type-count').innerText = `${e.type.toUpperCase()} FOUND: ${typeCount}`;
            document.getElementById('inspect-dupe-count').innerText = `DUPLICATES: ${inv.dupes || 0}`;
            const moveList = getMoveListForEmoji(e);
            const moveTargetLabels = {
                'enemy-single': 'Enemy Single',
                'enemy-all': 'Enemy All',
                'ally-single': 'Ally Single',
                'ally-all': 'All Allies',
                'self': 'Self'
            };
            document.getElementById('inspect-moves').innerHTML = moveList.map(move => {
                const power = move.kind === 'buff' ? 'â€”' : move.power;
                const element = move.element ? move.element.toUpperCase() : 'NEUTRAL';
                const dmgType = move.damageType ? move.damageType.toUpperCase() : 'â€”';
                const target = moveTargetLabels[move.target] || move.target;
                return `<div>${move.name} (${element}) â€¢ ${move.kind.toUpperCase()} ${power} â€¢ ${dmgType} â€¢ CD ${move.cooldown} â€¢ ${target}</div>`;
            }).join('');
            
            const lvlCost = getLevelUpCost(inv);
            const lvlBtn = document.getElementById('btn-lvl-up');
            lvlBtn.disabled = (state.gold < lvlCost || inv.lvl >= 10);
            lvlBtn.innerText = inv.lvl >= 10 ? "MAX LEVEL" : `UPGRADE (${lvlCost.toLocaleString()} GOLD)`;
            const canPromote = inv.lvl >= 10 && inv.currentRarity !== 'eternal';
            const promoteBtn = document.getElementById('btn-promote');
            if (canPromote) {
                const promoteCost = getPromoteCost(inv);
                promoteBtn.classList.remove('hidden');
                promoteBtn.disabled = state.gold < promoteCost;
                promoteBtn.innerText = `ASCEND (${promoteCost.toLocaleString()} GOLD)`;
            } else promoteBtn.classList.add('hidden');
            document.getElementById('btn-add-team').innerText = state.team.includes(id) ? "WITHDRAW" : "DEPLOY";
            renderTeam();
        }

        function levelUpSelected() {
            if (!selectedId) return;
            const inv = state.inventory[selectedId];
            const cost = getLevelUpCost(inv);
            if (state.gold >= cost && inv.lvl < 10) { state.gold -= cost; inv.lvl++; save(); inspect(selectedId); updateStatsUI(); }
        }

        function promoteSelected() {
            if (!selectedId) return;
            const inv = state.inventory[selectedId];
            const cost = getPromoteCost(inv);
            let targetRarity = null;
            if (inv.currentRarity === 'legendary') targetRarity = 'divine';
            else if (inv.currentRarity === 'divine') targetRarity = 'eternal';
            else if (inv.currentRarity !== 'eternal') targetRarity = 'legendary';
            if (targetRarity) {
                if (state.gold < cost) return;
                state.gold -= cost; inv.currentRarity = targetRarity; inv.lvl = 1;
                save(); inspect(selectedId); updateStatsUI(); toast("ASCENDED!");
            }
        }

        function toggleSelectedTeam() {
            if (!selectedId) return;
            const idx = state.team.indexOf(selectedId);
            state.stage = 1; stopAutoBattle();
            if (idx > -1) state.team.splice(idx, 1);
            else if (state.team.length < 3) state.team.push(selectedId);
            save(); updateStatsUI(); inspect(selectedId);
        }

        // --- ARENA ---
        function toggleAutoBattle() { if (!state.team.length) { switchTab('team'); return; } state.isAutoBattling = true; switchTab('arena'); startAutoCycle(); }
        function stopAutoBattle() {
            state.isAutoBattling = false;
            document.getElementById('arena-lobby').classList.remove('hidden');
            document.getElementById('arena-combat').classList.add('hidden');
            document.getElementById('arena-info-bar').classList.add('hidden');
        }

        async function startAutoCycle() {
            if (!state.isAutoBattling) return;
            document.getElementById('arena-lobby').classList.add('hidden');
            document.getElementById('arena-combat').classList.remove('hidden');
            document.getElementById('arena-info-bar').classList.remove('hidden');
            const log = document.getElementById('battle-log');
            const flash = document.getElementById('combat-flash-layer');
            document.getElementById('combat-stage-num').innerText = state.stage;
            document.getElementById('arena-info-stage').innerText = state.stage;
            log.innerHTML = `<div class="text-white border-b border-white/5 mb-1 pb-1">STAGE ${state.stage}</div>`;
            
            let pUnits = state.team.map(id => {
                const emoji = EMOJIS.find(x => x.id === id);
                const stats = calcStats(id);
                const unit = { ...emoji, ...stats, maxHp: stats.hp, isPlayer: true };
                attachMoves(unit);
                return unit;
            });
            let eUnits = generateEnemyTeam(state.stage);
            pUnits.forEach(resetBaseStats);
            eUnits.forEach(resetBaseStats);

            const updateUI = () => {
                document.getElementById('battle-player-team').innerHTML = pUnits.map(u => `<div class="${u.hp<=0?'opacity-20':''}"><div class="flex justify-between text-[7px] font-black uppercase"><span>${u.char}</span><span>${Math.max(0,Math.floor(u.hp))}</span></div><div class="h-1 bg-black overflow-hidden"><div class="h-full bg-green-500" style="width:${(u.hp/u.maxHp)*100}%"></div></div></div>`).join('');
                document.getElementById('battle-enemy-team').innerHTML = eUnits.map(u => `<div class="${u.hp<=0?'opacity-20':''}"><div class="flex justify-between text-[7px] font-black uppercase"><span>${u.char}</span><span>${Math.max(0,Math.floor(u.hp))}</span></div><div class="h-1 bg-black overflow-hidden"><div class="h-full bg-red-500" style="width:${(u.hp/u.maxHp)*100}%"></div></div></div>`).join('');
            };

            while (pUnits.some(u=>u.hp>0) && eUnits.some(u=>u.hp>0) && state.isAutoBattling) {
                updateUI();
                let actors = [...pUnits, ...eUnits].filter(u=>u.hp>0).sort((a,b)=>getModifiedStat(b, 'spd') - getModifiedStat(a, 'spd'));
                for (let u of actors) {
                    if (u.hp <= 0 || !state.isAutoBattling) continue;
                    applyStatusTick(u, log);
                    if (u.hp <= 0) { updateUI(); continue; }
                    tickCooldowns(u);
                    let targets = u.isPlayer ? eUnits.filter(t=>t.hp>0) : pUnits.filter(t=>t.hp>0);
                    if (!targets.length) break;
                    const allies = u.isPlayer ? pUnits : eUnits;
                    const enemies = u.isPlayer ? eUnits : pUnits;
                    const move = pickMove(u);
                    if (move) {
                        const used = applyMove(u, move, allies, enemies, log);
                        if (used) u.cooldowns[move.id] = move.cooldown;
                    } else {
                        const basic = getMoveById('basic_strike');
                        const dmg = calcDamage(u, targets[0], basic.power, basic);
                        targets[0].hp -= dmg;
                        log.innerHTML += `<div>${u.char} attacks for ${Math.floor(dmg)}</div>`;
                    }
                    updateUI(); await new Promise(r=>setTimeout(r, 450));
                }
            }
            if (!state.isAutoBattling) return;
            if (eUnits.every(u => u.hp <= 0)) {
                state.gold += getArenaReward(state.stage); state.stage++; save(); updateStatsUI(); setTimeout(startAutoCycle, 1500);
            } else {
                state.stage = 1; save(); updateStatsUI(); setTimeout(startAutoCycle, 800);
            }
        }

        function buyTickets(type, amount, cost) {
            if (state.gold < cost) { toast("NO GOLD!"); return; }
            const ticketType = type === 'rare' ? 'rareTickets' : type === 'legendary' ? 'legendaryTickets' : 'tickets';
            state.gold -= cost; state[ticketType] += amount; save(); updateStatsUI(); toast("BOUGHT!");
        }

        window.onload = init;
    </script>
</body>
</html>
