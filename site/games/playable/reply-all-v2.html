<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="game-description"
      content="A new and improved email based rogue-like"
    />
    <meta name="game-tags" content="roguelike, bizarre" />
    <title>REPLY ALL</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      crossorigin="anonymous"
    />

    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.6/Sortable.min.js"></script>

    <!-- React (no JSX) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Game Data -->
    <script src="./reply-all-consts.js"></script>
    <script src="./reply-all-engine.js"></script>

    <style></style>
  </head>
  <body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div id="app"></div>
    <script>
      // game state
      let state = {
        analytics: {
          events: [],
          rounds: [],
        },
        seed: null,
        rngStates: {},
        shopVisitIndex: 0,
        missionCycle: 0,
        aiPlannedActions: {},
        startConfig: {
          departmentId: "executive",
          prestige: 0,
          seedInput: "",
        },
        startUnlocks: {
          executive: 0,
          it: 0,
          finance: 0,
        },
        player: {
          id: "player",
          name: "eke vdh",
          email: "eke.vdh@gov.org",
          hp: 50,
          maxHp: 50,
          ult: 0,
          wins: 3,
          currentWins: 3,
          buffs: [],
          reputation: 4,
          year: 1,
          quarter: "Q3",
          title: TITLES[0],
          addressBook: ["cc_telly_operations"],
          signatures: [],
          salutation: SALUTATIONS.find((s) => s.id === "hi") || null,
          signOff: SIGNOFFS.find((s) => s.id === "thanks") || null,
          bccContacts: [],
          departmentId: "executive_council_office",
          singleDmg: 10,
          escalateDmg: 5,
          globalDmg: 0,
          singleDmgMult: 0,
          escalateDmgMult: 0,
          globalDmgMult: 0,
          retaliation: 5,
          deflect: 0,
          selfPromoteHeal: 5,
          deflectCharge: 0,
          deflectChargeReflect: 0,
          deflectChargeReduce: 0,
          followUpChance: 0,
          escalateRecoverPerHit: 0,
          bccLimit: 2,
          contactTrainingLimit: 3,
          contactUpgrades: {},
          contactPermanentBoosts: {},
          contactTrainingCount: {},
          coachingBoosts: {},
          salutationBonuses: {},
          signoffBonuses: {},
          ...DEFAULT_PLAYER_LINES,
          discoveredSets: [],
        },
        currentMissionIndex: 0,
        targetId: 1,
        turn: 0,
        lossReason: null,
        isProcessing: false,
        gameOver: false,
        missionActive: false,
        removedByPlayer: 0,
        removedTotal: 0,
        postPromotionScreen: null,
        ccPicksTaken: 0,
        ccPicksLeft: 0,
        shop: {
          directItems: [],
          packs: [],
          rerollCount: 0,
        },
        pendingTraining: null,
        roundEndUpgrades: {},
        expenseReportActive: false,
        messageLogEntries: [],
      };

      let rngStreams = {};
      const LEVERAGE_MAX = 8;

      function hashSeed(base, label) {
        let h = 2166136261;
        const s = `${base}:${label}`;
        for (let i = 0; i < s.length; i++) {
          h ^= s.charCodeAt(i);
          h = Math.imul(h, 16777619);
        }
        return h >>> 0;
      }

      function createRng(seed) {
        let t = seed >>> 0;
        return {
          next() {
            t += 0x6d2b79f5;
            let r = Math.imul(t ^ (t >>> 15), t | 1);
            r ^= r + Math.imul(r ^ (r >>> 7), r | 61);
            return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
          },
          get state() {
            return t >>> 0;
          },
          set state(value) {
            t = value >>> 0 || 0;
          },
        };
      }

      function resetRngStreams() {
        rngStreams = {};
      }

      function ensureSeed() {
        if (!state.seed) state.seed = Date.now() >>> 0;
        if (!state.rngStates) state.rngStates = {};
      }

      function getRngStream(key) {
        ensureSeed();
        if (!rngStreams[key]) {
          const seed = hashSeed(state.seed, key);
          const rng = createRng(seed);
          if (state.rngStates[key] != null) {
            rng.state = state.rngStates[key];
          }
          rngStreams[key] = rng;
        }
        return rngStreams[key];
      }

      function rngNext(key) {
        const rng = getRngStream(key);
        const value = rng.next();
        state.rngStates[key] = rng.state;
        return value;
      }

      function rngInt(key, max) {
        return Math.floor(rngNext(key) * max);
      }

      function getMissionStreamKey(kind) {
        const mission = MISSIONS[state.currentMissionIndex] || {};
        const cycle = state.missionCycle || 0;
        return `mission:${mission.id || state.currentMissionIndex}:${cycle}:${kind}`;
      }

      function getShopStreamKey() {
        const idx = state.shopVisitIndex || 0;
        return `shop:${idx}`;
      }

      function randomStringFromRng(key, length = 5) {
        let out = "";
        for (let i = 0; i < length; i++) {
          const val = rngInt(key, 36);
          out += val.toString(36);
        }
        return out;
      }

      function parseSeedInput(input) {
        if (!input) return null;
        const trimmed = String(input).trim();
        if (!trimmed) return null;
        if (/^\d+$/.test(trimmed)) return Number(trimmed) >>> 0;
        return hashSeed(trimmed, "user");
      }

      function ensureStartDefaults() {
        if (!metaState) {
          metaState = {
            discoveredSets: [],
            startUnlocks: { executive: 0, it: 0, finance: 0 },
            departmentUnlocks: { executive: true, it: false, finance: false },
          };
        }
        if (!state.startConfig) {
          state.startConfig = {
            departmentId: "executive",
            prestige: 0,
            seedInput: "",
          };
        }
        if (!state.startUnlocks) {
          state.startUnlocks = { executive: 0, it: 0, finance: 0 };
        }
        if (!state.messageLogEntries) {
          state.messageLogEntries = [];
        }
        if (state.player && !state.player.coachingBoosts) {
          state.player.coachingBoosts = {};
        }
        if (!state.startConfig.departmentId)
          state.startConfig.departmentId = "executive";
        if (state.startConfig.prestige == null) state.startConfig.prestige = 0;
        if (state.startConfig.seedInput == null)
          state.startConfig.seedInput = "";
        if (!metaState.startUnlocks)
          metaState.startUnlocks = { executive: 0, it: 0, finance: 0 };
        if (!metaState.departmentUnlocks) {
          metaState.departmentUnlocks = {
            executive: true,
            it: false,
            finance: false,
          };
        }
        if (!Array.isArray(metaState.discoveredSets))
          metaState.discoveredSets = [];
        state.startUnlocks = { ...metaState.startUnlocks };
      }

      function checkDepartmentUnlocks() {
        if (!metaState || !metaState.departmentUnlocks) return;
        let changed = false;
        if (
          !metaState.departmentUnlocks.finance &&
          (state.player?.reputation || 0) >= 30
        ) {
          metaState.departmentUnlocks.finance = true;
          changed = true;
        }
        if (changed) saveMetaState();
      }

      function getBasePlayerState(name, email) {
        return {
          id: "player",
          name,
          email,
          hp: 50,
          maxHp: 50,
          ult: 0,
          wins: 3,
          currentWins: 3,
          buffs: [],
          reputation: 4,
          year: 1,
          quarter: "Q3",
          title: TITLES[0],
          addressBook: [],
          signatures: [],
          salutation: null,
          signOff: null,
          bccContacts: [],
          departmentId: "executive_council_office",
          singleDmg: 10,
          escalateDmg: 5,
          globalDmg: 0,
          singleDmgMult: 0,
          escalateDmgMult: 0,
          globalDmgMult: 0,
          retaliation: 5,
          deflect: 0,
          selfPromoteHeal: 5,
          deflectCharge: 0,
          deflectChargeReflect: 0,
          deflectChargeReduce: 0,
          followUpChance: 0,
          escalateRecoverPerHit: 0,
          bccLimit: 2,
          contactTrainingLimit: 3,
          contactUpgrades: {},
          contactPermanentBoosts: {},
          contactTrainingCount: {},
          coachingBoosts: {},
          salutationBonuses: {},
          signoffBonuses: {},
          ...DEFAULT_PLAYER_LINES,
          _lineBags: {},
        };
      }

      function applyStartConfigToPlayer(config) {
        if (!config) return;
        const dept = START_DEPARTMENTS.find(
          (d) => d.id === config.departmentId,
        );
        if (!dept) return;
        const start = dept.start || {};
        const baseWins = state.player.wins || 0;
        const winsDelta =
          typeof start.winsDelta === "number" ? start.winsDelta : 0;
        const nextWins = Math.max(0, baseWins + winsDelta);
        state.player.wins = nextWins;
        state.player.currentWins = nextWins;
        if (typeof start.reputation === "number") {
          state.player.reputation = start.reputation;
        }
        state.player.departmentId =
          start.departmentId || state.player.departmentId;
        state.player.addressBook = Array.isArray(start.addressBook)
          ? [...start.addressBook]
          : [];
        state.player.signatures = Array.isArray(start.signatureIds)
          ? start.signatureIds
              .map((id) => SIGNATURES.find((s) => s.id === id))
              .filter(Boolean)
          : [];
        state.player.salutation = start.salutationId
          ? SALUTATIONS.find((s) => s.id === start.salutationId) || null
          : null;
        state.player.signOff = start.signOffId
          ? SIGNOFFS.find((s) => s.id === start.signOffId) || null
          : null;
        state.player.discoveredSets = [...(metaState.discoveredSets || [])];
      }
    </script>

    <!-- UI scripts -->
    <script>
      const e = React.createElement;

    // //   We don't need any of these component, only an example of how to do it.
    //   /*
    //    1. Simple Presentational Component
    //    */
    //   function IconButton(props) {
    //     return e(
    //       "button",
    //       {
    //         className: "px-4 py-2 border rounded",
    //         onClick: props.onClick,
    //       },
    //       e("i", { className: props.icon }),
    //       " ",
    //       props.label,
    //     );
    //   }

    //   /*
    //    2. Component with Children
    //    */
    //   function Card(props) {
    //     return e(
    //       "div",
    //       { className: "border rounded p-4" },
    //       e("h2", s, { className: "font-bold mb-2" }, props.title),
    //       props.children,
    //     );
    //   }

    //   /*
    //    3. Stateful Component
    //    */
    //   function Counter() {
    //     const [count, setCount] = React.useState(0);

    //     return e(
    //       "div",
    //       null,
    //       e("p", null, "Count: ", count),
    //       e(IconButton, {
    //         icon: "fa fa-plus",
    //         label: "Increment",
    //         onClick: () => setCount(count + 1),
    //       }),
    //     );
    //   }

      function App() {
        const [items, setItems] = React.useState([
          "Example Draggable",
          "Using Sort",
          "React-based, kinda",
          "With useFallback: true",
        ]);

        const listRef = React.useRef(null);

        React.useEffect(() => {
          if (!listRef.current) return;

          const sortable = new Sortable(listRef.current, {
            animation: 150,
            forceFallback: true,
            fallbackClass: "sortable-drag",
            fallbackOnBody: true,
            onEnd: (evt) => {
              const newItems = [...items];
              const [moved] = newItems.splice(evt.oldIndex, 1);
              newItems.splice(evt.newIndex, 0, moved);
              setItems(newItems);
            },
          });

          return () => sortable.destroy();
        }, []);

        return e(
          "ul",
          { ref: listRef, className: "space-y-2" },
          items.map((item) =>
            e(
              "li",
              {
                key: item,
                className:
                  "flex items-center gap-3 p-3 bg-gray-50 border rounded cursor-move",
              },
              e("i", { className: "fa-solid fa-grip-vertical text-gray-400" }),
              e("span", { className: "flex-1" }, item),
            ),
          ),
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("app"));
      root.render(e(App));
    </script>
  </body>
</html>
