<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="game-description"
      content="A new and improved email based rogue-like"
    />
    <meta name="game-tags" content="roguelike, bizarre" />
    <title>REPLY ALL</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=VT323&family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="./reply-all-consts.js"></script>
    <script src="./reply-all-engine.js"></script>

    <style>
      :root {
        --win-grey: #c0c0c0;
        --win-blue: #000080;
        --win-blue-light: #1084d0;
        --win-border-light: #ffffff;
        --win-border-dark: #404040;
        --win-wizard-text: #7b7b7b;
        --win-bg: #568fb5;
        --shop-card-width: 84px;
        --shop-card-height: 120px;
        --bg-viewport-h: 100dvh;
        --fg-viewport-h: 100svh;
      }
      @supports not (height: 100dvh) {
        :root {
          --bg-viewport-h: 100vh;
        }
      }
      @supports not (height: 100svh) {
        :root {
          --fg-viewport-h: 100vh;
        }
      }
      html,
      body,
      #app {
        height: var(--bg-viewport-h);
        min-height: var(--bg-viewport-h);
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: var(--win-bg);
        margin: 0;
        color: black;
        overflow: hidden;
        overscroll-behavior: none;
        -webkit-overflow-scrolling: touch;
      }
      .win-bg {
        background-color: var(--win-bg);
        min-height: var(--bg-viewport-h);
      }
      body.is-dragging-cards {
        overflow: hidden !important;
        overscroll-behavior: none;
        touch-action: none;
      }
      .terminal-font {
        font-family: "VT323", monospace;
      }
      .retro-border {
        border-top: 2px solid var(--win-border-light);
        border-left: 2px solid var(--win-border-light);
        border-bottom: 2px solid var(--win-border-dark);
        border-right: 2px solid var(--win-border-dark);
      }
      .retro-border-inset {
        border-top: 2px solid var(--win-border-dark);
        border-left: 2px solid var(--win-border-dark);
        border-bottom: 2px solid var(--win-border-light);
        border-right: 2px solid var(--win-border-light);
      }
      .retro-button {
        background: var(--win-grey);
        border-top: 2px solid var(--win-border-light);
        border-left: 2px solid var(--win-border-light);
        border-bottom: 2px solid var(--win-border-dark);
        border-right: 2px solid var(--win-border-dark);
        padding: 4px 8px;
        cursor: pointer;
        user-select: none;
      }
      .window-titlebar {
        background: linear-gradient(90deg, var(--win-blue), var(--win-blue-light));
      }
      .wizard-sidebar {
        background: linear-gradient(180deg, #000040 0%, #000080 100%);
        width: 120px;
      }
      .wizard-text {
        writing-mode: vertical-rl;
        transform: rotate(180deg);
        font-size: 2rem;
        font-weight: 900;
        color: var(--win-wizard-text);
        pointer-events: none;
        user-select: none;
      }
      .dither-lock {
        background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAFElEQVQImWNkYGBoYGBgYGBgYAAAAwAHAAFc878AAAAASUVORK5CYII=");
        background-repeat: repeat;
        background-color: rgba(192, 192, 192, 0.4);
        backdrop-filter: grayscale(1);
      }
      .prestige-btn {
        aspect-ratio: 1 / 1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-family: monospace;
        font-size: 14px;
        cursor: pointer;
        background: var(--win-grey);
        width: 24px;
      }
      .prestige-btn.locked {
        color: #808080;
        cursor: not-allowed;
        text-shadow: 1px 1px white;
      }
      .prestige-btn.selected {
        background: #ffffff;
        outline: 1.5px dotted black;
        outline-offset: -4px;
        box-shadow: inset 1px 1px 0 black;
      }
      .nav-btn {
        width: 32px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--win-grey);
      }
      .manifest-table td {
        padding: 6px 10px;
        border-bottom: 1px solid #e5e7eb;
        font-size: 10px;
      }
      .manifest-table tr:last-child td {
        border-bottom: none;
      }
      .induction-prestige-grid {
        display: none !important;
      }
      .induction-prestige-compact {
        display: block !important;
      }
      .email-header {
        background: #e8e8e8;
        border-bottom: 1px solid #ccc;
        font-family: sans-serif;
        font-size: 11px;
        color: #444;
      }
      .email-body {
        padding: 12px 0;
        line-height: 1.5;
        color: #111;
      }
      .action-btn.is-disabled {
        opacity: 0.6;
      }
      .game-action-card {
        cursor: grab;
      }
      .game-action-card.is-disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }
      .game-action-card.is-dragging {
        outline: 2px dashed #000080;
        outline-offset: -4px;
        opacity: 0.45;
      }
      .game-action-drag-proxy {
        position: fixed;
        pointer-events: none;
        z-index: 140;
        transform: translate(-50%, -50%);
      }
      .game-action-drag-proxy .shop-card-item {
        width: var(--shop-card-width);
        max-width: var(--shop-card-width);
        min-width: var(--shop-card-width);
        height: var(--shop-card-height);
      }
      .game-action-drag-popup {
        position: fixed;
        z-index: 141;
        width: 260px;
        pointer-events: none;
      }
      .game-action-detail-popup {
        position: fixed;
        z-index: 130;
        width: 260px;
      }
      .game-cc-detail-popup {
        position: fixed;
        z-index: 130;
        width: 260px;
      }
      .game-action-dock {
        position: fixed;
        left: 50%;
        bottom: 8px;
        transform: translateX(-50%);
        z-index: 96;
        width: min(980px, calc(100% - 1rem));
      }
      .game-action-drop-overlay {
        position: absolute;
        inset: 0;
        pointer-events: none;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px;
        z-index: 40;
      }
      .game-action-drop-overlay .overlay-shell {
        width: 100%;
        height: 100%;
        border: 2px dashed #1d4ed8;
        background: rgba(255, 255, 255, 0.72);
        color: #1e3a8a;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .game-action-drop-overlay.is-over .overlay-shell {
        border-color: #15803d;
        color: #14532d;
      }
      .game-action-drop-overlay.reply-target-invisible .overlay-shell {
        border-color: transparent !important;
        background: transparent !important;
        color: transparent !important;
      }
      .game-action-drop-overlay.reply-target-invisible .overlay-shell::before,
      .game-action-drop-overlay.reply-target-invisible .overlay-shell::after {
        display: none !important;
      }
      @keyframes replyTargetPulse {
        0% {
          border-color: rgba(37, 99, 235, 0.35);
          box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.2);
        }
        50% {
          border-color: rgba(29, 78, 216, 0.95);
          box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.35);
        }
        100% {
          border-color: rgba(37, 99, 235, 0.35);
          box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.2);
        }
      }
      .reply-target-pulse {
        animation: replyTargetPulse 1.1s ease-in-out infinite;
      }
      .momentum-meter {
        display: grid;
        grid-template-columns: repeat(8, minmax(0, 1fr));
        gap: 2px;
        width: 100%;
        margin-top: 2px;
      }
      .momentum-segment {
        height: 4px;
        background: #9ca3af;
      }
      .momentum-segment.charged {
        background: #b91c1c;
      }
      .contacts-container {
        max-height: 28px;
        overflow: hidden;
      }
      .cc-contacts-container {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        max-height: 22px;
        overflow: hidden;
        transition: max-height 0.2s ease;
      }
      .cc-contacts-container.expanded {
        max-height: 120px;
        overflow-y: auto;
      }
      .cc-pill {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 2px 6px;
        font-size: 9px;
        font-weight: 700;
        border: 1px solid var(--win-border-dark);
        box-shadow: 1px 1px 0 #000;
        min-width: 50px;
        white-space: nowrap;
        background: #fde68a;
      }
      .cc-pill .pill-text {
        position: relative;
        z-index: 2;
        text-shadow: 0 0 2px #fff8db;
      }
      .contacts-more {
        cursor: pointer;
        color: #000080;
        font-style: normal;
        font-weight: 700;
        text-decoration: underline;
        margin-left: 4px;
      }
      .stakeholder-pill {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 2px 6px;
        font-size: 9px;
        font-weight: 700;
        cursor: pointer;
        border: 1px solid var(--win-border-dark);
        box-shadow: 1px 1px 0 #000;
        min-width: 50px;
        white-space: nowrap;
        background: #d4d4d4;
        position: relative;
        transition: transform 0.1s;
      }
      .stakeholder-pill.active {
        border: 1px solid var(--win-blue);
        outline: 1px solid var(--win-blue);
        transform: translateY(-1px);
        z-index: 10;
      }
      .stakeholder-pill .pill-text {
        position: relative;
        z-index: 2;
        text-shadow: 0 0 2px #fff;
        max-width: 96px;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .stakeholder-pill .pill-hp {
        font-size: 8px;
        opacity: 0.7;
        position: relative;
        z-index: 2;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .shop-card-item {
        width: 100%;
        max-width: var(--shop-card-width);
        height: var(--shop-card-height);
        display: flex;
        flex-direction: column;
        text-align: center;
        padding: 0;
        background: #c0c0c0;
        cursor: grab;
        user-select: none;
        border-top: 2px solid #ffffff;
        border-left: 2px solid #ffffff;
        border-right: 2px solid #404040;
        border-bottom: 2px solid #404040;
        box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      }
      .sortable-ghost {
        opacity: 0.4;
      }
      .shop-card-ghost {
        opacity: 0.4;
      }
      .sortable-drag {
        opacity: 1 !important;
      }
      .shop-card-drag {
        opacity: 1 !important;
      }
      .shop-card-item:active {
        cursor: grabbing;
      }
      .shop-card-header {
        width: 100%;
        font-size: 7px;
        font-weight: 700;
        text-transform: uppercase;
        padding: 2px 6px;
        text-align: left;
      }
      .shop-card-frame {
        flex: 1;
        margin: 5px;
        background: #808080;
        border-top: 2px solid #404040;
        border-left: 2px solid #404040;
        border-right: 2px solid #ffffff;
        border-bottom: 2px solid #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 5px;
      }
      .shop-card-name {
        font-size: 10px;
        font-weight: 700;
        line-height: 1.2;
        color: #111827;
      }
      .shop-card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, var(--shop-card-width));
        gap: 8px;
        justify-content: center;
        min-height: var(--shop-card-height);
      }
      .shop-card-body {
        padding: 6px;
        font-size: 10px;
      }
      .shop-item-overlay-frame {
        background: #ffffff;
        border: 1px solid #d1d5db;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }
      .shop-rarity-badge {
        font-size: 9px;
        font-weight: 700;
        text-transform: uppercase;
        padding: 2px 6px;
        border: 1px solid #808080;
        background: #f3f4f6;
        color: #111827;
      }
      .shop-drop-zone {
        border: 2px dashed #808080;
        background: #efefef;
        padding: 6px;
        text-align: center;
        font-size: 10px;
      }
      .drag-overlay-target {
        position: absolute;
        inset: 0;
        border: 2px dashed #6b7280;
        background: rgba(255, 255, 255, 0.45);
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        color: #111827;
        z-index: 30;
        pointer-events: none;
        opacity: 0;
      }
      .drag-overlay-target.active {
        pointer-events: auto;
        opacity: 1;
      }
      .drag-overlay-target.buy {
        border-color: #1d4ed8;
        color: #1e3a8a;
      }
      .drag-overlay-target.sell {
        border-color: #b45309;
        color: #7c2d12;
      }
      .drag-overlay-target .overlay-label-active {
        display: none;
      }
      .drag-overlay-target:has(.shop-card-item, .sortable-ghost, .shop-card-ghost, .sortable-chosen, .shop-card-chosen, .sortable-fallback) .overlay-label-idle {
        display: none;
      }
      .drag-overlay-target:has(.shop-card-item, .sortable-ghost, .shop-card-ghost, .sortable-chosen, .shop-card-chosen, .sortable-fallback) .overlay-label-active {
        display: inline;
      }
      .drag-overlay-target .shop-card-item,
      .drag-overlay-target .sortable-ghost,
      .drag-overlay-target .shop-card-ghost,
      .drag-overlay-target .sortable-chosen,
      .drag-overlay-target .shop-card-chosen,
      .drag-overlay-target .sortable-fallback {
        display: none !important;
      }
      .buy-slot-outline {
        outline: 2px dashed #1d4ed8;
        outline-offset: 2px;
        background: #eff6ff;
      }
      .address-book-header {
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        background: #d1d5db;
        padding: 4px 6px;
        border-bottom: 1px solid #9ca3af;
      }
      .address-book-item {
        font-size: 11px;
        padding: 4px 6px;
        border-bottom: 1px solid #e5e7eb;
        background: #fff;
      }
      .email-template-shell {
        background: #fff;
        border: 1px solid #808080;
        padding: 8px;
      }
      .adaptive-card-track {
        display: flex;
        flex-wrap: nowrap;
        align-items: flex-start;
        overflow: hidden;
        min-height: calc(var(--shop-card-height) + 2px + 16px);
        touch-action: pan-x;
        overscroll-behavior: contain;
        -webkit-user-select: none;
        user-select: none;
      }
      .adaptive-card-track .shop-card-item {
        flex: 0 0 var(--shop-card-width);
      }
      .adaptive-card-track > .shop-card-item:first-child {
        margin-left: var(--card-inset, 0px);
      }
      .adaptive-card-track > .shop-card-item:last-child {
        margin-right: var(--card-inset, 0px);
      }
      .adaptive-card-track > .shop-card-item + .shop-card-item {
        margin-left: var(--card-overlap, 0px);
      }
      .email-template-row {
        display: grid;
        grid-template-columns: 84px minmax(140px, 1fr) 84px;
        gap: 8px;
        align-items: start;
      }
      .template-content-card {
        cursor: default;
      }
      .email-template-slot {
        border: 1px solid #bdbdbd;
        background: #f9fafb;
        min-height: 28px;
        padding: 4px 6px;
      }
      .sig-list-row {
        border-bottom: 1px solid #e5e7eb;
        padding: 4px 2px;
        font-size: 11px;
      }
      @media (max-width: 640px) {
        #induction-icon-frame {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div id="app" class="w-full"></div>

    <script>
      const e = React.createElement;

      function createInitialState() {
        return {
          analytics: { events: [], rounds: [] },
          seed: null,
          rngStates: {},
          shopVisitIndex: 0,
          missionCycle: 0,
          aiPlannedActions: {},
          startConfig: { departmentId: "executive", prestige: 0, seedInput: "" },
          startUnlocks: { executive: 0, it: 0, finance: 0 },
          player: ReplyAllEngine.start.getBasePlayerState(
            "eke vdh",
            ReplyAllEngine.start.getEmailFromName("eke vdh"),
          ),
          currentMissionIndex: 0,
          opponents: [],
          targetId: 1,
          turn: 0,
          lossReason: null,
          isProcessing: false,
          gameOver: false,
          missionActive: false,
          removedByPlayer: 0,
          removedTotal: 0,
          postPromotionScreen: null,
          ccPicksTaken: 0,
          ccPicksLeft: 0,
          shop: { directItems: [], packs: [], rerollCount: 0 },
          pendingTraining: null,
          roundEndUpgrades: {},
          expenseReportActive: false,
          messageLogEntries: [],
          previousRoundSummary: "",
        };
      }

      function loadMetaStateFromStorage() {
        return ReplyAllEngine.start.loadMeta({
          onLoadMeta: () => {
            try {
              const raw = localStorage.getItem(META_KEY);
              return raw ? JSON.parse(raw) : null;
            } catch (err) {
              return null;
            }
          },
        });
      }

      function saveMetaStateToStorage(metaState) {
        ReplyAllEngine.start.saveMeta(metaState, {
          onSaveMeta: (nextMeta) => {
            try {
              localStorage.setItem(META_KEY, JSON.stringify(nextMeta));
            } catch (err) {}
          },
        });
      }

      function loadSaveFromStorage() {
        return ReplyAllEngine.start.loadSave({
          onLoadSave: () => {
            try {
              const raw = localStorage.getItem(SAVE_KEY);
              return raw ? JSON.parse(raw) : null;
            } catch (err) {
              return null;
            }
          },
        });
      }

      function clearSaveFromStorage() {
        ReplyAllEngine.start.clearSave({
          onClearSave: () => {
            try {
              localStorage.removeItem(SAVE_KEY);
            } catch (err) {}
          },
        });
      }

      function setCardDragViewportLock(isLocked) {
        if (!document || !document.body || !document.body.classList) return;
        document.body.classList.toggle("is-dragging-cards", !!isLocked);
      }

      function StartScreen(props) {
        return e(
          "div",
          {
            className:
              "fixed inset-0 z-[100] flex items-center justify-center win-bg p-4",
          },
          e(
            "div",
            { className: "bg-[#c0c0c0] p-4 retro-border max-w-sm w-full shadow-2xl" },
            e(
              "div",
              {
                className:
                  "window-titlebar text-white px-2 py-1 mb-4 flex justify-between items-center text-xs",
              },
              e("span", null, "NEW USER SETUP"),
              e("span", null, "✕"),
            ),
            e(
              "h1",
              {
                className:
                  "text-4xl font-bold mb-2 text-center terminal-font tracking-widest text-[#000080]",
              },
              "REPLY ALL",
            ),
            e(
              "p",
              { className: "mb-4 text-[11px] text-center leading-tight italic" },
              '"The path to being at peace is long and full of micro-agressions."',
            ),
            e(
              "div",
              { className: "space-y-3 mb-6" },
              e(
                "div",
                null,
                e(
                  "label",
                  { className: "block text-[10px] font-bold uppercase mb-1" },
                  "Full Name:",
                ),
                e("input", {
                  type: "text",
                  value: props.playerName,
                  onChange: (evt) => props.onNameChange(evt.target.value),
                  placeholder: "eke",
                  className:
                    "w-full p-2 bg-white retro-border-inset outline-none text-sm",
                }),
              ),
              e(
                "div",
                null,
                e(
                  "label",
                  { className: "block text-[10px] font-bold uppercase mb-1" },
                  "Email:",
                ),
                e(
                  "div",
                  {
                    className:
                      "text-[11px] font-mono text-gray-800 bg-white/50 p-2 border border-dotted border-gray-400",
                  },
                  props.emailPreview,
                ),
              ),
            ),
            e(
              "button",
              {
                onClick: props.onSignUp,
                className: "w-full py-3 font-bold retro-button text-[#000080]",
              },
              "SIGN UP",
            ),
            props.resumeName
              ? e(
                  "div",
                  { className: "mt-3" },
                  e(
                    "div",
                    { className: "text-[10px] uppercase font-bold text-gray-500 mb-1" },
                    "Existing User",
                  ),
                  e(
                    "button",
                    {
                      onClick: props.onResume,
                      className: "w-full py-2 font-bold retro-button text-[#000080]",
                    },
                    `Login as ${props.resumeName}`,
                  ),
                )
              : null,
          ),
        );
      }

      function DepartmentIcon(props) {
        const iconId = props.iconId || "executive";
        const svgProps = {
          width: "48",
          height: "48",
          viewBox: "0 0 24 24",
          fill: "none",
          stroke: "#000080",
          strokeWidth: "1.5",
        };
        if (iconId === "it") {
          return e(
            "svg",
            svgProps,
            e("rect", { x: "2", y: "3", width: "20", height: "14", rx: "2", ry: "2" }),
            e("line", { x1: "12", y1: "17", x2: "12", y2: "21" }),
            e("line", { x1: "8", y1: "21", x2: "16", y2: "21" }),
          );
        }
        if (iconId === "finance") {
          return e(
            "svg",
            svgProps,
            e("circle", { cx: "12", cy: "12", r: "10" }),
            e("line", { x1: "12", y1: "8", x2: "12", y2: "16" }),
            e("line", { x1: "8", y1: "12", x2: "16", y2: "12" }),
          );
        }
        return e(
          "svg",
          svgProps,
          e("path", { d: "M3 21h18" }),
          e("path", { d: "M19 21V10a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v11" }),
          e("path", { d: "M9 21v-4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v4" }),
        );
      }

      function InductionScreen(props) {
        const dept = props.department;
        const prestigeTitle =
          START_PRESTIGE_TITLES[props.startConfig.prestige] ||
          START_PRESTIGE_TITLES[0];

        return e(
          "div",
          {
            className:
              "fixed inset-0 z-[110] flex items-start sm:items-center justify-center win-bg p-2",
          },
          e(
            "div",
            {
              className:
                "w-full max-w-2xl bg-[#c0c0c0] retro-border flex flex-col max-h-[95vh]",
            },
            e(
              "div",
              {
                className:
                  "window-titlebar text-white px-1 py-0.5 flex justify-between items-center select-none",
              },
              e(
                "div",
                { className: "flex items-center gap-1.5 px-1" },
                e(
                  "span",
                  { className: "text-[10px] sm:text-[11px] font-bold tracking-tight" },
                  "Personnel Induction Wizard",
                ),
              ),
              e(
                "div",
                { className: "flex gap-0.5" },
                e(
                  "button",
                  {
                    className:
                      "w-4 h-4 bg-[#c0c0c0] border border-white shadow-[1px_1px_0px_black] text-black text-[10px] flex items-center justify-center font-bold",
                  },
                  "✕",
                ),
              ),
            ),
            e(
              "div",
              { className: "flex flex-1 overflow-hidden" },
              e(
                "div",
                {
                  className:
                    "wizard-sidebar hidden sm:flex flex-col items-center justify-end pb-8 border-r border-[#808080] shrink-0",
                },
                e(
                  "div",
                  { className: "wizard-text uppercase" },
                  dept.short || "EXECUTIVE",
                ),
              ),
              e(
                "div",
                { className: "flex-1 flex flex-col bg-white sm:bg-[#c0c0c0] overflow-hidden" },
                e(
                  "div",
                  { className: "p-3 sm:p-6 flex-1 flex flex-col overflow-y-auto" },
                  e(
                    "div",
                    { className: "mb-4" },
                    e(
                      "h2",
                      {
                        className:
                          "text-lg sm:text-xl font-bold leading-none mb-1 text-black",
                      },
                      dept.name,
                    ),
                    e("div", { className: "h-[1px] w-full bg-black mb-1" }),
                    e(
                      "p",
                      {
                        className:
                          "text-[9px] text-gray-500 font-bold uppercase tracking-wider",
                      },
                      "Induction Assignment Protocol",
                    ),
                  ),
                  e(
                    "div",
                    {
                      className:
                        "relative flex-1 bg-[#dfdfdf] retro-border-inset flex flex-col overflow-hidden",
                    },
                    e(
                      "div",
                      {
                        className:
                          "absolute inset-y-0 left-0 w-12 flex items-center justify-center z-40 pointer-events-none",
                      },
                      e(
                        "button",
                        {
                          onClick: () => props.onRotate(-1),
                          className:
                            "nav-btn retro-border pointer-events-auto hover:bg-[#d4d4d4]",
                        },
                        e(
                          "svg",
                          {
                            width: "12",
                            height: "12",
                            viewBox: "0 0 24 24",
                            fill: "none",
                            stroke: "black",
                            strokeWidth: "4",
                          },
                          e("polyline", { points: "15 18 9 12 15 6" }),
                        ),
                      ),
                    ),
                    e(
                      "div",
                      {
                        className:
                          "absolute inset-y-0 right-0 w-12 flex items-center justify-center z-40 pointer-events-none",
                      },
                      e(
                        "button",
                        {
                          onClick: () => props.onRotate(1),
                          className:
                            "nav-btn retro-border pointer-events-auto hover:bg-[#d4d4d4]",
                        },
                        e(
                          "svg",
                          {
                            width: "12",
                            height: "12",
                            viewBox: "0 0 24 24",
                            fill: "none",
                            stroke: "black",
                            strokeWidth: "4",
                          },
                          e("polyline", { points: "9 18 15 12 9 6" }),
                        ),
                      ),
                    ),
                    props.isLocked
                      ? e(
                          "div",
                          {
                            className:
                              "absolute inset-0 z-30 dither-lock flex flex-col items-center justify-center p-4",
                          },
                          e(
                            "div",
                            {
                              className:
                                "bg-[#c0c0c0] retro-border p-4 max-w-[240px] text-center shadow-xl",
                            },
                            e(
                              "div",
                              {
                                className:
                                  "bg-[#000080] text-white text-[9px] font-bold px-2 py-0.5 mb-3 uppercase flex items-center justify-between",
                              },
                              e("span", null, "System Message"),
                              e("span", null, "✕"),
                            ),
                            e("div", { className: "text-[10px] font-bold mb-2" }, "ACCESS RESTRICTED"),
                            e(
                              "div",
                              {
                                className:
                                  "text-[9px] font-mono leading-tight text-red-900 p-2 bg-white/50 border border-red-200",
                              },
                              `REQ: ${dept.lockCondition || "Unavailable"}`,
                            ),
                          ),
                        )
                      : null,
                    e(
                      "div",
                      { className: "flex-1 p-4 sm:p-6 overflow-y-auto" },
                      e(
                        "div",
                        { className: "flex flex-col sm:flex-row gap-6" },
                        e(
                          "div",
                          { className: "flex flex-col items-center shrink-0" },
                          e(
                            "div",
                            {
                              id: "induction-icon-frame",
                              className:
                                "w-24 h-24 bg-white retro-border-inset flex items-center justify-center mb-3",
                            },
                            e(DepartmentIcon, { iconId: dept.iconId || dept.id }),
                          ),
                          e(
                            "div",
                            {
                              className:
                                "text-[10px] font-mono font-bold bg-white px-3 py-0.5 border border-gray-400 retro-border-inset",
                            },
                            dept.code || "",
                          ),
                        ),
                        e(
                          "div",
                          { className: "flex-1 bg-white retro-border-inset shadow-inner" },
                          e(
                            "table",
                            { className: "w-full manifest-table border-collapse" },
                            e(
                              "thead",
                              null,
                              e(
                                "tr",
                                { className: "bg-gray-100" },
                                e(
                                  "th",
                                  {
                                    className:
                                      "text-left text-[8px] uppercase p-2 border-b border-gray-300 text-gray-500 font-bold",
                                  },
                                  "Attribute",
                                ),
                                e(
                                  "th",
                                  {
                                    className:
                                      "text-left text-[8px] uppercase p-2 border-b border-gray-300 text-gray-500 font-bold",
                                  },
                                  "Data Point",
                                ),
                              ),
                            ),
                            e(
                              "tbody",
                              null,
                              Object.entries(dept.manifest || {}).map(([key, value]) =>
                                e(
                                  "tr",
                                  { key },
                                  e(
                                    "td",
                                    {
                                      className:
                                        "font-bold text-gray-500 uppercase text-[8px] whitespace-nowrap",
                                    },
                                    key,
                                  ),
                                  e("td", { className: "font-mono text-blue-900" }, String(value)),
                                ),
                              ),
                            ),
                          ),
                        ),
                      ),
                    ),
                  ),
                  e(
                    "div",
                    { className: "mt-3 shrink-0" },
                    e(
                      "div",
                      { className: "flex justify-between items-end mb-1 px-1" },
                      e(
                        "span",
                        { className: "text-[9px] font-bold uppercase text-gray-500" },
                        "Prestige Clearance",
                      ),
                      e(
                        "span",
                        { className: "text-[10px] font-bold italic text-blue-900" },
                        prestigeTitle,
                      ),
                    ),
                    e(
                      "div",
                      {
                        className:
                          "induction-prestige-compact text-[10px] font-bold uppercase text-gray-600 px-2 py-1 bg-white retro-border-inset",
                      },
                      e("div", null, "Prestige: ", e("span", { className: "text-blue-900" }, prestigeTitle)),
                      e(
                        "div",
                        { className: "flex gap-1 mt-1" },
                        START_PRESTIGE_TITLES.map((_, idx) => {
                          const locked =
                            !props.departmentUnlocked || idx > props.maxUnlockedPrestige;
                          const selected = idx === props.startConfig.prestige && !locked;
                          return e(
                            "button",
                            {
                              key: `prestige-${idx}`,
                              className: `prestige-btn retro-border ${locked ? "locked" : ""} ${selected ? "selected" : ""}`,
                              disabled: locked,
                              onClick: () => props.onSelectPrestige(idx),
                            },
                            String(idx + 1),
                          );
                        }),
                      ),
                    ),
                  ),
                ),
                e(
                  "div",
                  {
                    className:
                      "p-3 border-t border-[#808080] flex justify-between items-center bg-[#c0c0c0] shrink-0",
                  },
                  e(
                    "div",
                    { className: "text-[9px] uppercase text-gray-500 font-bold" },
                    "Dept + Prestige Selection",
                  ),
                  e(
                    "div",
                    { className: "flex gap-2" },
                    e(
                      "button",
                      {
                        onClick: props.onOpenAdvanced,
                        className:
                          "bg-[#c0c0c0] retro-border px-3 py-1 text-[11px] min-w-[70px]",
                      },
                      "Advanced",
                    ),
                    e(
                      "button",
                      {
                        onClick: props.onClockIn,
                        disabled: props.isLocked,
                        className:
                          "bg-[#c0c0c0] retro-border px-4 py-1 text-[11px] min-w-[70px] font-bold disabled:opacity-50",
                      },
                      "Clock In",
                    ),
                  ),
                ),
              ),
            ),
          ),
        );
      }

      function AdvancedModal(props) {
        return e(
          "div",
          {
            className: "fixed inset-0 bg-black/40 z-[120] flex items-center justify-center p-4",
            onClick: props.onClose,
          },
          e(
            "div",
            {
              className: "bg-[#c0c0c0] retro-border p-1 w-full max-w-[300px] shadow-2xl",
              onClick: (evt) => evt.stopPropagation(),
            },
            e(
              "div",
              {
                className:
                  "window-titlebar text-white px-2 py-0.5 text-[10px] font-bold mb-2 flex justify-between items-center",
              },
              e("span", null, "Advanced Parameters"),
              e(
                "button",
                {
                  onClick: props.onClose,
                  className:
                    "w-3.5 h-3.5 bg-[#c0c0c0] border border-white shadow-[1px_1px_0px_black] text-black text-[9px] flex items-center justify-center font-bold",
                },
                "✕",
              ),
            ),
            e(
              "div",
              { className: "p-3" },
              e(
                "div",
                { className: "text-[10px] font-bold mb-1 uppercase text-gray-700" },
                "Sequence Seed:",
              ),
              e(
                "div",
                { className: "bg-white retro-border-inset p-1 mb-4" },
                e("input", {
                  type: "text",
                  value: props.seedValue,
                  onChange: (evt) => props.onSeedChange(evt.target.value),
                  className: "w-full bg-transparent outline-none font-mono text-xs px-1",
                  placeholder: "Leave blank for random...",
                  autoFocus: true,
                }),
              ),
              e(
                "div",
                {
                  className:
                    "text-[9px] text-gray-500 italic leading-tight mb-4 border-l-2 border-gray-400 pl-2",
                },
                "Enter a seed to force deterministic generation for this run.",
              ),
              e(
                "div",
                { className: "flex justify-end gap-2" },
                e(
                  "button",
                  {
                    onClick: props.onSave,
                    className:
                      "bg-[#c0c0c0] retro-border px-6 py-1 text-[11px] font-bold",
                  },
                  "OK",
                ),
              ),
            ),
          ),
        );
      }

      function formatTurnTime(turn) {
        const baseMinutes = 9 * 60;
        const totalMinutes = baseMinutes + Math.max(0, turn) * 15;
        const breakStart = 12 * 60;
        const breakEnd = 13 * 60 + 15;
        const adjustedMinutes =
          totalMinutes > breakStart
            ? totalMinutes + (breakEnd - breakStart)
            : totalMinutes;
        let h = Math.floor(adjustedMinutes / 60);
        const m = adjustedMinutes % 60;
        const suffix = h >= 12 ? "PM" : "AM";
        if (h > 12) h -= 12;
        if (h === 0) h = 12;
        return `${h.toString().padStart(2, "0")}:${m.toString().padStart(2, "0")} ${suffix}`;
      }

      function getMissionHeaderSubject(mission) {
        const subject = mission && mission.subject ? mission.subject : "Thread";
        const turns = mission && typeof mission.turns === "number" ? mission.turns : 0;
        return `Outlook Express - ${subject} (${formatTurnTime(turns)})`;
      }

      function getMissionSubSubject(mission) {
        const subject = mission && mission.subject ? mission.subject : "Thread";
        const turns = mission && typeof mission.turns === "number" ? mission.turns : 0;
        return `${subject} (due by ${formatTurnTime(turns)})`;
      }

      function formatMissionIntro(mission, player, opponents) {
        let intro = mission?.intro || "";
        intro = intro.replace(/{playerName}/g, player?.name || "Employee");
        (opponents || []).forEach((opp, idx) => {
          intro = intro.replace(new RegExp(`{opp${idx}}`, "g"), opp?.name || "Stakeholder");
        });
        return intro;
      }

      function createEmailEntry(from, to, subject, body, turn, classes = "") {
        return {
          from,
          to,
          subject,
          body,
          classes,
          time: formatTurnTime(turn || 0),
          isIntro: classes.includes("intro-message"),
        };
      }

      function InboxScreen(props) {
        const mission = props.mission || MISSIONS[0];
        const inboxRows = ReplyAllEngine.play.buildInboxRows(
          props.state,
          mission,
          16,
        );
        const spamRows = inboxRows.spam || [];
        return e(
          "div",
          {
            className:
              "fixed inset-0 z-[90] flex items-center justify-center win-bg p-4",
          },
          e(
            "div",
            {
              className:
                "bg-[#c0c0c0] retro-border max-w-2xl w-full h-[80dvh] flex flex-col shadow-2xl",
            },
            e(
              "div",
              {
                className:
                  "window-titlebar text-white px-2 py-1 flex justify-between items-center text-xs",
              },
              e("span", null, "Outlook Express - Inbox"),
              e(
                "div",
                { className: "flex gap-1" },
                e(
                  "button",
                  {
                    className:
                      "w-4 h-4 bg-[#c0c0c0] text-black text-[10px] flex items-center justify-center",
                  },
                  "_",
                ),
                e(
                  "button",
                  {
                    className:
                      "w-4 h-4 bg-[#c0c0c0] text-black text-[10px] flex items-center justify-center",
                  },
                  "X",
                ),
              ),
            ),
            e(
              "div",
              { className: "flex gap-4 px-2 py-0.5 border-b border-gray-500 text-[11px] shrink-0" },
              e("span", { className: "cursor-default hover:bg-[#000080] hover:text-white px-1" }, "File"),
              e("span", { className: "cursor-default hover:bg-[#000080] hover:text-white px-1" }, "Edit"),
              e("span", { className: "cursor-default hover:bg-[#000080] hover:text-white px-1" }, "View"),
              e("span", { className: "cursor-default hover:bg-[#000080] hover:text-white px-1" }, "Tools"),
              e("span", { className: "cursor-default hover:bg-[#000080] hover:text-white px-1" }, "Message"),
              e("span", { className: "cursor-default hover:bg-[#000080] hover:text-white px-1" }, "Help"),
            ),
            e(
              "div",
              { className: "flex-grow flex overflow-hidden" },
              e(
                "div",
                {
                  className:
                    "w-32 bg-[#dfdfdf] border-r border-[#808080] p-2 text-[10px] hidden sm:block",
                },
                e("div", { className: "font-bold mb-2" }, "Folders"),
                e(
                  "div",
                  { className: "pl-2 space-y-1" },
                  e("div", { className: "bg-blue-800 text-white px-1" }, "Inbox"),
                  e("div", null, "Outbox"),
                  e("div", null, "Sent Items"),
                  e("div", null, "Deleted Items"),
                  e("div", null, "Spam"),
                ),
              ),
              e(
                "div",
                { className: "flex-grow flex flex-col bg-white overflow-hidden" },
                e(
                  "div",
                  {
                    className:
                      "bg-[#f0f0f0] border-b border-[#808080] grid grid-cols-12 text-[9px] font-bold p-1",
                  },
                  e("div", { className: "col-span-1" }, "!"),
                  e("div", { className: "col-span-5" }, "From"),
                  e("div", { className: "col-span-6" }, "Subject"),
                ),
                e(
                  "div",
                  {
                    className:
                      "flex-grow overflow-y-auto overflow-x-hidden text-[11px] divide-y divide-gray-100",
                  },
                  e(
                    "button",
                    {
                      className:
                        "w-full text-left grid grid-cols-12 p-2 border-b border-gray-100 bg-blue-50 cursor-pointer hover:bg-blue-200 font-bold border-l-4 border-l-blue-600",
                      onClick: props.onOpenPrimaryEmail,
                    },
                    e("div", { className: "col-span-1 text-red-600" }, "!"),
                    e("div", { className: "col-span-4 text-blue-800 truncate" }, mission.from),
                    e("div", { className: "col-span-7 truncate" }, mission.subject),
                  ),
                  spamRows.map((row) =>
                    e(
                      "div",
                      {
                        key: row.id,
                        className:
                          "grid grid-cols-12 p-2 border-b border-gray-100 bg-gray-50 text-gray-400 opacity-60",
                      },
                      e("div", { className: "col-span-1" }, ""),
                      e("div", { className: "col-span-4 truncate" }, row.from),
                      e("div", { className: "col-span-7 truncate" }, row.subject),
                    ),
                  ),
                ),
              ),
            ),
            e(
              "div",
              {
                className:
                  "bg-[#dfdfdf] border-t border-[#808080] p-1 text-[10px] flex justify-between",
              },
              e("div", null, inboxRows.statusText || "324 Messages, 1 Unread"),
              e("div", { className: "flex gap-4" }, e("span", null, "Working Online")),
            ),
          ),
        );
      }

      function SummaryScreen(props) {
        const summary = props.summary || {
          baseRep: 0,
          bonusRep: 0,
          interestRep: 0,
          winsRep: 0,
          totalRep: 0,
          upgrades: {},
        };
        const upgrades = Object.entries(summary.upgrades || {});
        return e(
          "div",
          {
            className:
              "fixed inset-0 z-[120] bg-black/60 flex items-center justify-center p-4",
          },
          e(
            "div",
            {
              className:
                "bg-[#c0c0c0] retro-border max-w-xs w-full shadow-2xl overflow-hidden",
            },
            e(
              "div",
              {
                className:
                  "window-titlebar text-white px-2 py-1 flex justify-between items-center text-xs font-bold",
              },
              e("span", null, "ARCHIVED THREAD"),
              e("span", null, "✕"),
            ),
            e(
              "div",
              { className: "p-4 flex flex-col items-center" },
              e("h2", { className: "text-xl font-bold terminal-font mb-2" }, "PERFORMANCE METRICS"),
              e(
                "div",
                { className: "w-full bg-white retro-border-inset p-3 space-y-2 text-xs mb-4" },
                e("div", { className: "flex justify-between" }, e("span", null, "Base Mission Reward:"), e("span", { className: "font-mono" }, `+${summary.baseRep}`)),
                e("div", { className: "flex justify-between" }, e("span", null, "Additional Bonuses:"), e("span", { className: "font-mono" }, `+${summary.bonusRep}`)),
                summary.interestRep > 0
                  ? e("div", { className: "flex justify-between" }, e("span", null, "Reputational Interest:"), e("span", { className: "font-mono" }, `+${summary.interestRep}`))
                  : null,
                summary.winsRep > 0
                  ? e("div", { className: "flex justify-between" }, e("span", null, "Wins Remaining Bonus:"), e("span", { className: "font-mono" }, `+${summary.winsRep}`))
                  : null,
                e(
                  "div",
                  { className: "border-t border-gray-300 pt-2 flex justify-between font-bold text-[#000080]" },
                  e("span", null, "TOTAL REP EARNED:"),
                  e("span", { className: "font-mono text-lg" }, `+${summary.totalRep}`),
                ),
                e(
                  "div",
                  { className: "border-t border-gray-200 pt-2 space-y-1" },
                  e("div", { className: "text-[10px] uppercase text-gray-500" }, "Trained Employees"),
                  upgrades.length
                    ? upgrades.map(([id, count]) =>
                        e(
                          "div",
                          { key: id, className: "flex justify-between text-[10px] text-gray-700" },
                          e("span", null, CONTACTS.find((c) => c.id === id)?.name || id),
                          e("span", null, `x${count}`),
                        ),
                      )
                    : e("div", { className: "text-[10px] text-gray-500 italic" }, "None"),
                ),
              ),
              e(
                "button",
                { onClick: props.onGoToPortal, className: "w-full py-2 retro-button font-bold text-sm" },
                "GO TO PORTAL",
              ),
            ),
          ),
        );
      }

      function DragOverlayTarget(props) {
        const tone = props.tone || "buy";
        const active = !!props.active;
        return e(
          "div",
          {
            ref: props.overlayRef || null,
            className: `drag-overlay-target ${tone} ${active ? "active" : ""}`,
          },
          e("span", { className: "overlay-label-idle" }, props.idleLabel || ""),
          e("span", { className: "overlay-label-active" }, props.activeLabel || ""),
        );
      }

      function ItemCard(props) {
        const dataAttrs = {};
        if (props.itemType) dataAttrs["data-item-type"] = props.itemType;
        if (props.itemId) dataAttrs["data-item-id"] = props.itemId;
        if (props.itemIndex != null) dataAttrs["data-item-index"] = String(props.itemIndex);
        if (props.packId) dataAttrs["data-pack-id"] = props.packId;
        if (props.packOption) dataAttrs["data-pack-option"] = "1";
        if (props.cardInstanceId) dataAttrs["data-card-instance-id"] = props.cardInstanceId;
        return e(
          "div",
          {
            className: `shop-card-item${props.extraClassName ? ` ${props.extraClassName}` : ""}`,
            onClick: props.onClick,
            onPointerDown: props.onPointerDown,
            style: props.style || undefined,
            ...dataAttrs,
          },
          e(
            "div",
            { className: "shop-card-header", style: props.headerStyle || undefined },
            props.headerText || "",
          ),
          e(
            "div",
            { className: "shop-card-frame", style: props.frameStyle || undefined },
            props.children,
          ),
        );
      }

      function useAdaptiveCardTrack(areaRef, cardCount) {
        const [trackInnerWidth, setTrackInnerWidth] = React.useState(0);
        const [domCardCount, setDomCardCount] = React.useState(0);
        React.useLayoutEffect(() => {
          const el = areaRef.current;
          if (!el) return undefined;
          const readMetrics = () => {
            const style = window.getComputedStyle(el);
            const paddingLeft = parseFloat(style.paddingLeft || "0") || 0;
            const paddingRight = parseFloat(style.paddingRight || "0") || 0;
            const inner = Math.max(0, (el.clientWidth || 0) - 2*(paddingLeft + paddingRight));
            setTrackInnerWidth(inner);
          };
          readMetrics();
          if (typeof ResizeObserver !== "undefined") {
            const ro = new ResizeObserver(() => readMetrics());
            ro.observe(el);
            return () => ro.disconnect();
          }
          window.addEventListener("resize", readMetrics);
          return () => window.removeEventListener("resize", readMetrics);
        }, [areaRef]);
        React.useLayoutEffect(() => {
          const el = areaRef.current;
          if (!el) return undefined;
          const readCards = () => {
            const count = Array.from(el.children || []).filter(
              (node) => node?.classList?.contains("shop-card-item"),
            ).length;
            setDomCardCount(count);
          };
          readCards();
          const mo = new MutationObserver(() => readCards());
          mo.observe(el, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ["class"],
          });
          return () => mo.disconnect();
        }, [areaRef]);
        const step = React.useMemo(() => {
          const effectiveCount = Math.max(1, domCardCount || cardCount || 0);
          const cardWidth = 84;
          const contentWidth = Math.max(cardWidth, trackInnerWidth || cardWidth);
          return contentWidth / (effectiveCount + 1);
        }, [trackInnerWidth, cardCount, domCardCount]);
        const inset = React.useMemo(() => {
          const cardWidth = 84;
          return Math.max(0, step - cardWidth / 2);
        }, [step]);
        return {
          trackStyle: {
            "--card-overlap": `${step - 84}px`,
            "--card-inset": `${inset}px`,
          },
          getCardStyle: (index) => ({
            position: "relative",
            zIndex: Math.max(1, (index || 0) + 1),
          }),
        };
      }

      function ShopScreen(props) {
        const player = props.state.player || {};
        const statCtx = props.state._statCtx || null;
        const rep = props.state.player?.reputation || 0;
        const shop = props.state.shop || { directItems: [], packs: [], rerollCount: 0 };
        const rerollCost = ReplyAllEngine.core.getRerollCost
          ? ReplyAllEngine.core.getRerollCost(props.state)
          : (2 + (shop.rerollCount || 0));
        const activePackId = props.state.activePackId || null;
        const activePack = (shop.packs || []).find((p) => p.id === activePackId) || null;
        const directDisplayItems = activePack
          ? (activePack.options || [])
          : (shop.directItems || []).filter((item) => !item.purchased);
        const packDisplayItems = (shop.packs || []).filter((pack) => !pack.purchased);
        const owned = ReplyAllEngine.core.getOwnedAssets(props.state);
        const addressCurrent = owned.addressBook.length;
        const addressMax = statCtx
          ? ReplyAllEngine.stats.getUnitAddressLimit(statCtx, player)
          : Math.max(0, Math.floor(player.addressLimit ?? player.title?.addressLimit ?? 0));
        const bccCurrent = owned.bcc.length;
        const bccMax = statCtx
          ? Math.max(0, Math.floor(ReplyAllEngine.stats.computeUnitStats(statCtx, player).bccLimit || 0))
          : Math.max(0, Math.floor(player.bccLimit ?? 0));
        const sigCurrent = owned.signatures.length;
        const sigMax = Math.max(
          0,
          Math.floor(
            statCtx
              ? ReplyAllEngine.stats.getUnitSignatureLimit(statCtx, player)
              : (player?.signatureLimit ?? player?.sigLimit ?? player?.title?.signatureLimit ?? player?.title?.sigLimit ?? 0),
          ),
        );
        const shopRef = React.useRef(shop);
        const ownedRef = React.useRef(owned);
        const handlersRef = React.useRef({
          onDropBuyItem: props.onDropBuyItem,
          onDropOpenPack: props.onDropOpenPack,
          onDropArchiveOwned: props.onDropArchiveOwned,
          onDropEquipFromShop: props.onDropEquipFromShop,
          onSelectPackItem: props.onSelectPackItem,
          onReorderShopDirectItems: props.onReorderShopDirectItems,
          onReorderShopPacks: props.onReorderShopPacks,
          onReorderAddressBook: props.onReorderAddressBook,
          onReorderSignatures: props.onReorderSignatures,
          onReorderBcc: props.onReorderBcc,
          onReconcileShopDom: props.onReconcileShopDom,
        });
        const [detailPopup, setDetailPopup] = React.useState(null);
        const [detailPopupPos, setDetailPopupPos] = React.useState({ left: 8, top: 8 });
        const [slotBuyHint, setSlotBuyHint] = React.useState({
          contact: false,
          bcc: false,
          email: false,
        });
        const [dragOverlay, setDragOverlay] = React.useState({
          buyActive: false,
          buyLabel: "Buy for REP",
          sellActive: false,
          sellLabel: "Sell for REP",
        });
        const [mobileAssetDragPriority, setMobileAssetDragPriority] = React.useState(false);
        const detailPopupRef = React.useRef(null);
        const dragPopupRef = React.useRef({
          active: false,
          itemId: "",
          itemType: "",
          packId: "",
          itemIndex: null,
          cardInstanceId: "",
          pointerX: null,
          pointerY: null,
        });
        const suppressCardClickUntilRef = React.useRef(0);
        const directListRef = React.useRef(null);
        const packListRef = React.useRef(null);
        const buyOverlayRef = React.useRef(null);
        const sellOverlayRef = React.useRef(null);
        const ownedContactRef = React.useRef(null);
        const ownedEmailRef = React.useRef(null);
        const ownedBccRef = React.useRef(null);
        const directTrack = useAdaptiveCardTrack(directListRef, directDisplayItems.length);
        const packTrack = useAdaptiveCardTrack(packListRef, packDisplayItems.length);
        const ownedContactTrack = useAdaptiveCardTrack(ownedContactRef, owned.addressBook.length);
        const ownedBccTrack = useAdaptiveCardTrack(ownedBccRef, owned.bcc.length);
        const ownedEmailTrack = useAdaptiveCardTrack(ownedEmailRef, 3 + (owned.signatures?.length || 0));
        React.useEffect(() => {
          shopRef.current = shop;
          ownedRef.current = owned;
          handlersRef.current = {
            onDropBuyItem: props.onDropBuyItem,
            onDropOpenPack: props.onDropOpenPack,
            onDropArchiveOwned: props.onDropArchiveOwned,
            onDropEquipFromShop: props.onDropEquipFromShop,
            onSelectPackItem: props.onSelectPackItem,
            onReorderShopDirectItems: props.onReorderShopDirectItems,
            onReorderShopPacks: props.onReorderShopPacks,
            onReorderAddressBook: props.onReorderAddressBook,
            onReorderSignatures: props.onReorderSignatures,
            onReorderBcc: props.onReorderBcc,
            onReconcileShopDom: props.onReconcileShopDom,
          };
        }, [
          shop,
          owned,
          props.onDropBuyItem,
          props.onDropOpenPack,
          props.onDropArchiveOwned,
          props.onDropEquipFromShop,
          props.onSelectPackItem,
          props.onReorderShopDirectItems,
          props.onReorderShopPacks,
          props.onReorderAddressBook,
          props.onReorderSignatures,
          props.onReorderBcc,
          props.onReconcileShopDom,
        ]);
        function getDisplayCost(item) {
          if (!item) return 0;
          if (typeof item.cost === "number" && item.cost > 0) return item.cost;
          return ReplyAllEngine.core.getItemCostByType(
            item.rarity || "common",
            item.itemType || "contact",
          );
        }
        function typeMeta(itemType) {
          const map = {
            contact: { label: "contact", headerBg: "#1d4ed8", headerText: "#ffffff", paneBg: "#dbeafe", paneText: "#1e3a8a" },
            signature: { label: "signature", headerBg: "#7c3aed", headerText: "#ffffff", paneBg: "#ede9fe", paneText: "#4c1d95" },
            salutation: { label: "greeting", headerBg: "#0f766e", headerText: "#ffffff", paneBg: "#ccfbf1", paneText: "#134e4a" },
            signoff: { label: "sign-off", headerBg: "#065f46", headerText: "#ffffff", paneBg: "#d1fae5", paneText: "#064e3b" },
            bcc: { label: "help desk", headerBg: "#92400e", headerText: "#ffffff", paneBg: "#fef3c7", paneText: "#78350f" },
            dev: { label: "training", headerBg: "#374151", headerText: "#ffffff", paneBg: "#e5e7eb", paneText: "#111827" },
          };
          return map[itemType] || map.contact;
        }
        function getCardInstanceId(scope, itemType, itemId, extra = "") {
          return [scope || "card", itemType || "item", itemId || "none", extra || ""]
            .filter(Boolean)
            .join(":");
        }
        function itemTypeLabel(itemType) {
          return ReplyAllEngine.copy?.getItemTypeLabel
            ? ReplyAllEngine.copy.getItemTypeLabel(itemType || "")
            : itemType || "Item";
        }
        function getItemDetailText(item, itemType, options = {}) {
          if (!item) return "";
          const suppressPrimaryEffect = !!options.suppressPrimaryEffect;
          const formatPreviewValue = (field, value) => {
            if (typeof value !== "number") return String(value ?? 0);
            if (field.endsWith("Mult") || field.endsWith("Chance")) {
              return `${Math.round(value * 100)}%`;
            }
            return String(value);
          };
          const lines = [];
          if (item.description) lines.push(item.description);
          else if (item.picksText) lines.push(item.picksText);
          if (itemType === "contact") {
            const dept = item.departmentId
              ? ReplyAllEngine.core.getDepartmentName(item.departmentId)
              : "";
            if (dept) lines.push(`Department: ${dept}`);
            if (item.trainingBoosts && ReplyAllEngine.copy?.formatStatsText) {
              const trainedText = ReplyAllEngine.copy.formatStatsText(item.trainingBoosts);
              if (trainedText) {
                const trainingCount = Math.max(0, Math.floor(item.trainingCount || 0));
                lines.push(`Training (${trainingCount}): ${trainedText}`);
              }
            }
          }
          const effectText = ReplyAllEngine.copy?.getItemBonusText
            ? ReplyAllEngine.copy.getItemBonusText(item, {})
            : "";
          if (!suppressPrimaryEffect && effectText && effectText !== "No listed effect.") {
            lines.push(`Effects: ${effectText}`);
          }
          if (itemType === "dev" && ReplyAllEngine.copy?.getTrainingStatPreview) {
            const preview = ReplyAllEngine.copy.getTrainingStatPreview(player, item) || [];
            if (preview.length) {
              const previewText = preview
                .map((row) =>
                  `${row.label}: ${formatPreviewValue(row.field, row.before)} -> ${formatPreviewValue(row.field, row.after)}`,
                )
                .join("\n");
              lines.push(`Training impact (base):\n${previewText}`);
            }
          }
          return lines.length ? lines.join("\n\n") : "No additional details.";
        }
        function getEffectText(item) {
          if (!item) return "";
          const effectText = ReplyAllEngine.copy?.getItemBonusText
            ? ReplyAllEngine.copy.getItemBonusText(item, {})
            : "";
          if (!effectText) return "";
          const normalized = String(effectText).trim().toLowerCase();
          if (!normalized || normalized === "no listed effect." || normalized === "no additional details.") {
            return "";
          }
          return effectText;
        }
        function getTrackCardStyle(index, track) {
          if (!track || typeof track.getCardStyle !== "function") return undefined;
          if (index <= 0) return { position: "relative", zIndex: 1 };
          return track.getCardStyle(index);
        }
        function shouldSuppressCardClick() {
          return Date.now() < suppressCardClickUntilRef.current;
        }
        function getDetailPopupKey(nextPopup) {
          if (!nextPopup) return "";
          const obj = nextPopup.item || nextPopup.pack || {};
          return [
            nextPopup.mode || "",
            nextPopup.itemType || "",
            obj.id || "",
            nextPopup.itemIndex == null ? "" : String(nextPopup.itemIndex),
          ].join("|");
        }
        function shouldPrioritizeAssetsForDragEl(dragEl) {
          const type = dragEl?.dataset?.itemType || "";
          return type === "signature" || type === "salutation" || type === "signoff";
        }
        function openDirectDetail(item, anchorEl, opts = {}) {
          if (!item) return;
          const nextPopup = {
            mode: opts.mode || "direct",
            packId: opts.packId || null,
            item,
            itemType: item.itemType,
            cost: getDisplayCost(item),
            anchorRect: anchorEl?.getBoundingClientRect?.() || null,
          };
          if (getDetailPopupKey(detailPopup) === getDetailPopupKey(nextPopup)) {
            setDetailPopup(null);
            return;
          }
          setDetailPopup(nextPopup);
        }
        function openPackDetail(pack, anchorEl) {
          if (!pack) return;
          const nextPopup = {
            mode: "pack",
            pack,
            itemType: pack.type || "dev",
            cost: typeof pack.cost === "number" ? pack.cost : 0,
            anchorRect: anchorEl?.getBoundingClientRect?.() || null,
          };
          if (getDetailPopupKey(detailPopup) === getDetailPopupKey(nextPopup)) {
            setDetailPopup(null);
            return;
          }
          setDetailPopup(nextPopup);
        }
        function openOwnedDetail(itemType, item, itemIndex = null, anchorEl) {
          if (!item || !itemType) return;
          const nextPopup = {
            mode: "owned",
            item,
            itemType,
            itemIndex: Number.isFinite(itemIndex) ? itemIndex : null,
            refund: ReplyAllEngine.core.getSellRefundForItem(itemType, item),
            anchorRect: anchorEl?.getBoundingClientRect?.() || null,
          };
          if (getDetailPopupKey(detailPopup) === getDetailPopupKey(nextPopup)) {
            setDetailPopup(null);
            return;
          }
          setDetailPopup(nextPopup);
        }
        function closeDetailPopup() {
          setDetailPopup(null);
        }
        function clearDragOverlay() {
          setDragOverlay((prev) =>
            prev.buyActive || prev.sellActive
              ? {
                  buyActive: false,
                  buyLabel: prev.buyLabel,
                  sellActive: false,
                  sellLabel: prev.sellLabel,
                }
              : prev,
          );
        }
        function clearSlotBuyHint() {
          setSlotBuyHint((prev) =>
            prev.contact || prev.bcc || prev.email
              ? { contact: false, bcc: false, email: false }
              : prev,
          );
        }
        function setSlotBuyHintFromItemType(itemType) {
          const next = {
            contact: itemType === "contact",
            bcc: itemType === "bcc",
            email:
              itemType === "salutation" ||
              itemType === "signoff" ||
              itemType === "signature",
          };
          setSlotBuyHint((prev) =>
            prev.contact === next.contact &&
            prev.bcc === next.bcc &&
            prev.email === next.email
              ? prev
              : next,
          );
        }
        function findDirectItemById(itemId) {
          return (shopRef.current?.directItems || []).find((item) => item.id === itemId) || null;
        }
        function setBuyOverlayFromDragEl(dragEl, sourceGroup) {
          if (!dragEl) return clearDragOverlay();
          if (sourceGroup === "shop-packs") {
            const packId = dragEl.dataset?.packId;
            const pack = (shopRef.current?.packs || []).find((p) => p.id === packId) || null;
            const cost = pack?.cost || 0;
            setDragOverlay((prev) => ({
              ...prev,
              buyActive: true,
              buyLabel: `Buy for ${cost} REP`,
              sellActive: false,
            }));
            return;
          }
          if (sourceGroup === "shop-pack-open") {
            const isPackOption = dragEl.dataset?.packOption === "1";
            const itemType = dragEl.dataset?.itemType;
            if (!isPackOption || itemType !== "dev") {
              clearDragOverlay();
              return;
            }
            const cost = 0;
            setDragOverlay((prev) => ({
              ...prev,
              buyActive: true,
              buyLabel: `Buy for ${cost} REP`,
              sellActive: false,
            }));
            return;
          }
          if (sourceGroup === "shop-offers") {
            const itemId = dragEl.dataset?.itemId;
            const itemType = dragEl.dataset?.itemType;
            const item = itemId ? findDirectItemById(itemId) : null;
            if (!item || itemType !== "dev") {
              clearDragOverlay();
              return;
            }
            const cost = getDisplayCost(item);
            setDragOverlay((prev) => ({
              ...prev,
              buyActive: true,
              buyLabel: `Buy for ${cost} REP`,
              sellActive: false,
            }));
            return;
          }
          clearDragOverlay();
        }
        function setSellOverlayFromDragEl(dragEl, sourceGroup) {
          if (!dragEl) return clearDragOverlay();
          const itemType = dragEl.dataset?.itemType;
          const itemId = dragEl.dataset?.itemId;
          if (!itemType || !itemId || itemType === "content") {
            clearDragOverlay();
            return;
          }
          if (!["owned-contact", "owned-email", "owned-bcc"].includes(sourceGroup)) {
            clearDragOverlay();
            return;
          }
          let item = null;
          if (sourceGroup === "owned-contact") {
            item = (ownedRef.current?.addressBook || []).find((x) => x.id === itemId) || null;
          } else if (sourceGroup === "owned-bcc") {
            const itemIndexRaw = dragEl.dataset?.itemIndex;
            const itemIndex = itemIndexRaw == null ? null : Number(itemIndexRaw);
            item = Number.isFinite(itemIndex)
              ? ownedRef.current?.bcc?.[itemIndex]
              : (ownedRef.current?.bcc || []).find((x) => x.id === itemId) || null;
          } else if (sourceGroup === "owned-email") {
            if (itemType === "salutation") item = ownedRef.current?.salutation || null;
            else if (itemType === "signoff") item = ownedRef.current?.signoff || null;
            else if (itemType === "signature") {
              item = (ownedRef.current?.signatures || []).find((x) => x.id === itemId) || null;
            }
          }
          if (!item) {
            clearDragOverlay();
            return;
          }
          const refund = ReplyAllEngine.core.getSellRefundForItem(itemType, item);
          setDragOverlay((prev) => ({
            ...prev,
            sellActive: true,
            sellLabel: `Sell for +${refund} REP`,
            buyActive: false,
          }));
        }
        function onDragPointerMove(evt) {
          const ctx = dragPopupRef.current;
          if (!ctx.active) return;
          if (typeof evt.clientX === "number") ctx.pointerX = evt.clientX;
          if (typeof evt.clientY === "number") ctx.pointerY = evt.clientY;
        }
        function onDragTouchMove(evt) {
          const ctx = dragPopupRef.current;
          if (!ctx.active) return;
          const touch = evt.touches && evt.touches[0];
          if (!touch) return;
          ctx.pointerX = touch.clientX;
          ctx.pointerY = touch.clientY;
        }
        function stopDragPopupFollow() {
          const ctx = dragPopupRef.current;
          ctx.active = false;
          ctx.itemId = "";
          ctx.itemType = "";
          ctx.packId = "";
          ctx.itemIndex = null;
          ctx.cardInstanceId = "";
          ctx.pointerX = null;
          ctx.pointerY = null;
          window.removeEventListener("pointermove", onDragPointerMove);
          window.removeEventListener("touchmove", onDragTouchMove);
        }
        function startDragPopupFollow(identity) {
          const ctx = dragPopupRef.current;
          ctx.active = true;
          ctx.itemId = identity.itemId || "";
          ctx.itemType = identity.itemType || "";
          ctx.packId = identity.packId || "";
          ctx.itemIndex = identity.itemIndex ?? null;
          ctx.cardInstanceId = identity.cardInstanceId || "";
          ctx.pointerX = null;
          ctx.pointerY = null;
          window.addEventListener("pointermove", onDragPointerMove, { passive: true });
          window.addEventListener("touchmove", onDragTouchMove, { passive: true });
        }
        function getDraggedElementRect() {
          const ctx = dragPopupRef.current;
          const nodes = Array.from(
            document.querySelectorAll(
              ".sortable-fallback, .sortable-drag, .shop-card-drag, .sortable-chosen, .shop-card-chosen, .sortable-ghost, .shop-card-ghost",
            ),
          );
          const candidates = nodes.filter((node) => {
            if (!node || !node.dataset) return false;
            if (ctx.cardInstanceId) return node.dataset.cardInstanceId === ctx.cardInstanceId;
            if (ctx.packId) return node.dataset.packId === ctx.packId;
            if (!ctx.itemId || !ctx.itemType) return false;
            if (node.dataset.itemId !== ctx.itemId) return false;
            if (node.dataset.itemType !== ctx.itemType) return false;
            if (ctx.itemIndex != null) {
              return (node.dataset.itemIndex || null) === String(ctx.itemIndex);
            }
            return true;
          });
          if (candidates.length) {
            const dragPriority = (node) => {
              const cls = node.classList;
              if (
                cls.contains("sortable-fallback") ||
                cls.contains("sortable-drag") ||
                cls.contains("shop-card-drag")
              ) {
                return 3;
              }
              if (cls.contains("sortable-chosen") || cls.contains("shop-card-chosen")) {
                return 2;
              }
              if (cls.contains("sortable-ghost") || cls.contains("shop-card-ghost")) {
                return 1;
              }
              return 0;
            };
            candidates.sort((a, b) => dragPriority(a) - dragPriority(b));
            return candidates[candidates.length - 1].getBoundingClientRect();
          }
          if (
            typeof ctx.pointerX === "number" &&
            typeof ctx.pointerY === "number"
          ) {
            const width = 84;
            const height = 120;
            return {
              left: ctx.pointerX - width / 2,
              top: ctx.pointerY - height / 2,
              right: ctx.pointerX + width / 2,
              bottom: ctx.pointerY + height / 2,
              width,
              height,
            };
          }
          return null;
        }
        function resolveDragPopupPayload(dragEl, popupSource) {
          const itemId = dragEl?.dataset?.itemId || "";
          const itemType = dragEl?.dataset?.itemType || "";
          const packId = dragEl?.dataset?.packId || "";
          const isPackOption = dragEl?.dataset?.packOption === "1";
          const cardInstanceId = dragEl?.dataset?.cardInstanceId || "";
          const itemIndexRaw = dragEl?.dataset?.itemIndex;
          const parsedIndex = itemIndexRaw == null ? null : Number(itemIndexRaw);
          const itemIndex = Number.isFinite(parsedIndex) ? parsedIndex : null;
          if (popupSource === "shop-offers") {
            if (isPackOption && packId && itemId) {
              const pack = (shopRef.current?.packs || []).find((p) => p.id === packId);
              const item = (pack?.options || []).find((i) => i.id === itemId) || null;
              if (!item) return null;
              return {
                popup: {
                  mode: "pack-option",
                  packId,
                  item,
                  itemType: item.itemType,
                  cost: 0,
                },
                identity: { itemId, itemType: item.itemType, cardInstanceId },
              };
            }
            if (!itemId || !itemType) return null;
            const item = (shopRef.current?.directItems || []).find((i) => i.id === itemId && !i.purchased);
            if (!item) return null;
            return {
              popup: {
                mode: "direct",
                item,
                itemType: item.itemType,
                cost: getDisplayCost(item),
              },
              identity: { itemId, itemType, cardInstanceId },
            };
          }
          if (packId && popupSource === "shop-packs") {
            const pack = (shopRef.current?.packs || []).find((p) => p.id === packId && !p.purchased);
            if (!pack) return null;
            return {
              popup: {
                mode: "pack",
                pack,
                itemType: pack.type || "dev",
                cost: typeof pack.cost === "number" ? pack.cost : 0,
              },
              identity: { packId, cardInstanceId },
            };
          }
          if (!itemId || !itemType) return null;
          if (popupSource === "owned-contact") {
            const item = (ownedRef.current?.addressBook || []).find((i) => i.id === itemId);
            if (!item) return null;
            return {
              popup: {
                mode: "owned",
                item,
                itemType: "contact",
                itemIndex: null,
                refund: ReplyAllEngine.core.getSellRefundForItem("contact", item),
              },
              identity: { itemId, itemType: "contact", cardInstanceId },
            };
          }
          if (popupSource === "owned-bcc") {
            const item = itemIndex != null ? ownedRef.current?.bcc?.[itemIndex] : (ownedRef.current?.bcc || []).find((i) => i.id === itemId);
            if (!item) return null;
            return {
              popup: {
                mode: "owned",
                item,
                itemType: "bcc",
                itemIndex,
                refund: ReplyAllEngine.core.getSellRefundForItem("bcc", item),
              },
              identity: { itemId, itemType: "bcc", itemIndex, cardInstanceId },
            };
          }
          if (popupSource === "owned-email") {
            let item = null;
            if (itemType === "salutation") item = ownedRef.current?.salutation || null;
            else if (itemType === "signoff") item = ownedRef.current?.signoff || null;
            else if (itemType === "signature") item = (ownedRef.current?.signatures || []).find((i) => i.id === itemId) || null;
            if (!item) return null;
            return {
              popup: {
                mode: "owned",
                item,
                itemType,
                itemIndex: null,
                refund: ReplyAllEngine.core.getSellRefundForItem(itemType, item),
              },
              identity: { itemId, itemType, cardInstanceId },
            };
          }
          return null;
        }
        function onDragPopupStart(evt, popupSource) {
          const resolved = resolveDragPopupPayload(evt?.item, popupSource);
          if (!resolved) return;
          const anchorRect = evt?.item?.getBoundingClientRect?.() || null;
          setDetailPopup({ ...resolved.popup, anchorRect });
          startDragPopupFollow(resolved.identity);
          suppressCardClickUntilRef.current = Date.now() + 300;
        }
        function onDragPopupEnd() {
          stopDragPopupFollow();
          closeDetailPopup();
        }
        function computeDetailPopupPosition(anchorRect, popupWidth, popupHeight) {
          const padding = 8;
          const gap = 10;
          if (!anchorRect) return { left: padding, top: padding };
          const roomRight = window.innerWidth - anchorRect.right - padding;
          const roomLeft = anchorRect.left - padding;
          const preferredLeft =
            roomRight < popupWidth && roomLeft > roomRight
              ? anchorRect.left - popupWidth - padding
              : anchorRect.right + padding;
          let left = preferredLeft;
          if (roomRight < popupWidth && roomLeft > roomRight) {
            left = anchorRect.left - popupWidth - padding;
          }
          const maxLeft = window.innerWidth - popupWidth - padding;
          const clampedHorizontally =
            preferredLeft > maxLeft || preferredLeft < padding;
          if (left + popupWidth > window.innerWidth - padding) {
            left = Math.max(padding, maxLeft);
          }
          if (left < padding) left = padding;

          let top = anchorRect.top;
          if (dragPopupRef.current.active && clampedHorizontally) {
            const roomAbove = anchorRect.top - padding - gap;
            const roomBelow = window.innerHeight - anchorRect.bottom - padding - gap;
            if (roomBelow >= popupHeight || roomBelow >= roomAbove) {
              top = anchorRect.bottom + gap;
            } else {
              top = anchorRect.top - popupHeight - gap;
            }
          }
          if (top + popupHeight > window.innerHeight - padding) {
            top = Math.max(padding, window.innerHeight - popupHeight - padding);
          }
          if (top < padding) top = padding;
          return { left, top };
        }

        React.useLayoutEffect(() => {
          if (!detailPopup || !detailPopupRef.current) return;
          const el = detailPopupRef.current;
          const width = el.offsetWidth || 260;
          const height = el.offsetHeight || 200;
          setDetailPopupPos(
            computeDetailPopupPosition(detailPopup.anchorRect, width, height),
          );
        }, [detailPopup]);

        React.useEffect(() => {
          if (!detailPopup) return undefined;
          const onResize = () => {
            if (!detailPopupRef.current) return;
            const width = detailPopupRef.current.offsetWidth || 260;
            const height = detailPopupRef.current.offsetHeight || 200;
            setDetailPopupPos(
              computeDetailPopupPosition(detailPopup.anchorRect, width, height),
            );
          };
          window.addEventListener("resize", onResize);
          return () => window.removeEventListener("resize", onResize);
        }, [detailPopup]);
        React.useEffect(() => {
          if (!detailPopup || !dragPopupRef.current.active) return undefined;
          let rafId = 0;
          let lastLeft = null;
          let lastTop = null;
          const tick = () => {
            if (!dragPopupRef.current.active || !detailPopupRef.current) return;
            const anchorRect = getDraggedElementRect();
            if (anchorRect) {
              const width = detailPopupRef.current.offsetWidth || 260;
              const height = detailPopupRef.current.offsetHeight || 200;
              const pos = computeDetailPopupPosition(anchorRect, width, height);
              if (pos.left !== lastLeft || pos.top !== lastTop) {
                lastLeft = pos.left;
                lastTop = pos.top;
                setDetailPopupPos(pos);
              }
            }
            rafId = window.requestAnimationFrame(tick);
          };
          rafId = window.requestAnimationFrame(tick);
          return () => {
            if (rafId) window.cancelAnimationFrame(rafId);
          };
        }, [detailPopup]);
        React.useEffect(() => () => stopDragPopupFollow(), []);

        function onDetailAction() {
          if (!detailPopup) return;
          if (detailPopup.mode === "direct") {
            props.onBuyItem(detailPopup.item);
          } else if (detailPopup.mode === "pack-option") {
            if (detailPopup.packId && detailPopup.item?.id) {
              props.onSelectPackItem(detailPopup.packId, detailPopup.item.id);
            }
          } else if (detailPopup.mode === "pack") {
            props.onOpenPack(detailPopup.pack);
          } else if (detailPopup.mode === "owned") {
            props.onArchiveOwned(
              detailPopup.itemType,
              detailPopup.item.id,
              detailPopup.itemIndex ?? null,
            );
          }
          closeDetailPopup();
        }
        function renderDetailPopup() {
          if (!detailPopup) return null;
          const item = detailPopup.item || detailPopup.pack;
          if (!item) return null;
          const itemType = detailPopup.itemType || item.itemType || "contact";
          const isBuyIntentMode = detailPopup.mode === "direct" || detailPopup.mode === "pack-option";
          const isEmailTemplateSwapType = itemType === "salutation" || itemType === "signoff";
          const shouldShowSwapEffect =
            isBuyIntentMode && isEmailTemplateSwapType;
          const currentlySlotted =
            itemType === "salutation"
              ? (ownedRef.current?.salutation || null)
              : itemType === "signoff"
                ? (ownedRef.current?.signoff || null)
                : null;
          const removeEffectText = shouldShowSwapEffect ? getEffectText(currentlySlotted) : "";
          const addEffectText = shouldShowSwapEffect ? getEffectText(item) : "";
          const isOwned = detailPopup.mode === "owned";
          const isPackOption = detailPopup.mode === "pack-option";
          const actionCost = isOwned || isPackOption ? 0 : detailPopup.cost || 0;
          const actionDisabled = isOwned || isPackOption ? false : rep < actionCost;
          const detailText = getItemDetailText(item, itemType, {
            suppressPrimaryEffect: shouldShowSwapEffect,
          });
          const hidePrimaryDetailForSwap =
            shouldShowSwapEffect && detailText === "No additional details.";
          const actionLabel = isOwned
            ? `ARCHIVE +${detailPopup.refund || 0} REP`
            : isPackOption
              ? "SELECT"
            : detailPopup.mode === "pack"
              ? `ATTEND EVENT${actionCost > 0 ? ` (${actionCost} REP)` : ""}`
              : `REQUEST${actionCost > 0 ? ` (${actionCost} REP)` : ""}`;
          return e(
            "div",
            {
              ref: detailPopupRef,
              className: "fixed z-[160] w-[260px] shop-item-overlay-frame p-3 retro-border",
              style: {
                left: `${detailPopupPos.left}px`,
                top: `${detailPopupPos.top}px`,
              },
            },
            e(
              "div",
              { className: "flex justify-between items-start font-bold text-[11px] gap-2 border-b border-[#808080] pb-2 mb-2" },
              e(
                "div",
                { className: "truncate flex flex-col min-w-0" },
                e("span", { className: "truncate text-[#000080] text-sm leading-none mb-1" }, item.name || "Item"),
                e("span", { className: "text-[9px] text-[#404040] opacity-70 uppercase" }, itemTypeLabel(itemType)),
              ),
              e("div", { className: "shop-rarity-badge" }, (item.rarity || "common").toUpperCase()),
            ),
            hidePrimaryDetailForSwap
              ? null
              : e(
                  "div",
                  {
                    className: "text-[10px] leading-snug text-gray-800 bg-white/50 p-2 border border-[#808080] italic whitespace-pre-line mb-3",
                  },
                  detailText,
                ),
            shouldShowSwapEffect
              ? e(
                  "div",
                  { className: "text-[10px] leading-snug bg-white/70 p-2 border border-[#808080] mb-3" },
                  addEffectText
                    ? e(
                        "div",
                        { className: "text-green-800 whitespace-pre-line mb-1" },
                        `${addEffectText}`,
                      )
                    : null,
                  addEffectText && removeEffectText
                    ? e("div", { className: "my-1 border-t border-[#808080]/60" })
                    : null,
                  removeEffectText
                    ? e(
                        "div",
                        { className: "text-red-700 whitespace-pre-line" },
                        `${removeEffectText} (from '${currentlySlotted?.name || "current"}')`,
                      )
                    : null,
                )
              : null,
            e(
              "div",
              { className: "flex gap-2" },
              e(
                "button",
                {
                  className: "flex-1 retro-button text-[10px] font-bold py-2 uppercase",
                  disabled: actionDisabled,
                  onClick: onDetailAction,
                },
                actionLabel,
              ),
              e(
                "button",
                {
                  className: "px-3 retro-button text-[10px] font-bold py-2 text-red-700",
                  onClick: closeDetailPopup,
                },
                "X",
              ),
            ),
          );
        }

        React.useEffect(() => {
          if (typeof Sortable === "undefined") return undefined;
          const sortables = [];
          function getGroupName(source) {
            if (!source) return "";
            if (typeof source === "string") return source;
            if (source.options?.group?.name) return source.options.group.name;
            if (source.el?.dataset?.sortableGroup) return source.el.dataset.sortableGroup;
            if (source.dataset?.sortableGroup) return source.dataset.sortableGroup;
            return "";
          }

          function addSortable(ref, options) {
            if (!ref.current) return;
            const popupSource = options.popupSource || null;
            const onStart = options.onStart;
            const onEnd = options.onEnd;
            const sortableOptions = { ...options };
            const sortableGroupName = getGroupName(sortableOptions.group);
            if (sortableGroupName) {
              ref.current.dataset.sortableGroup = sortableGroupName;
            }
            delete sortableOptions.popupSource;
            sortables.push(
              Sortable.create(ref.current, {
                forceFallback: true,
                fallbackOnBody: true,
                removeCloneOnHide: true,
                chosenClass: "shop-card-chosen",
                dragClass: "shop-card-drag",
                ghostClass: "shop-card-ghost",
                ...sortableOptions,
                onStart: (evt) => {
                  setCardDragViewportLock(true);
                  setMobileAssetDragPriority(shouldPrioritizeAssetsForDragEl(evt?.item));
                  if (popupSource) onDragPopupStart(evt, popupSource);
                  if (typeof onStart === "function") onStart(evt);
                },
                onEnd: (evt) => {
                  setCardDragViewportLock(false);
                  setMobileAssetDragPriority(false);
                  if (popupSource) onDragPopupEnd();
                  else closeDetailPopup();
                  suppressCardClickUntilRef.current = Date.now() + 300;
                  if (typeof onEnd === "function") onEnd(evt);
                },
              }),
            );
          }

          addSortable(directListRef, {
            popupSource: "shop-offers",
            animation: 120,
            sort: true,
            group: { name: "shop-offers", put: false },
            draggable: ".shop-card-item",
            onStart: (evt) => {
              setBuyOverlayFromDragEl(evt?.item, "shop-offers");
              setSlotBuyHintFromItemType(evt?.item?.dataset?.itemType || "");
            },
            onEnd: (evt) => {
              clearDragOverlay();
              clearSlotBuyHint();
              if (!evt || evt.from !== evt.to) return;
              if (activePack || !directListRef.current) return;
              const itemIds = Array.from(
                directListRef.current.querySelectorAll('.shop-card-item[data-item-id]'),
              )
                .map((el) => el.dataset.itemId)
                .filter(Boolean);
              if (itemIds.length && typeof handlersRef.current.onReorderShopDirectItems === "function") {
                setTimeout(() => handlersRef.current.onReorderShopDirectItems(itemIds), 0);
              }
            },
          });

          addSortable(packListRef, {
            popupSource: "shop-packs",
            animation: 120,
            sort: true,
            group: { name: "shop-packs", put: false },
            draggable: ".shop-card-item",
            onStart: (evt) => {
              setBuyOverlayFromDragEl(evt?.item, "shop-packs");
              clearSlotBuyHint();
            },
            onEnd: (evt) => {
              clearDragOverlay();
              clearSlotBuyHint();
              if (!evt || evt.from !== evt.to) return;
              if (!packListRef.current) return;
              const packIds = Array.from(
                packListRef.current.querySelectorAll('.shop-card-item[data-pack-id]'),
              )
                .map((el) => el.dataset.packId)
                .filter(Boolean);
              if (packIds.length && typeof handlersRef.current.onReorderShopPacks === "function") {
                setTimeout(() => handlersRef.current.onReorderShopPacks(packIds), 0);
              }
            },
          });

          addSortable(buyOverlayRef, {
            animation: 120,
            sort: false,
            group: {
              name: "buy-overlay",
              pull: false,
              put: (to, from, dragEl) => {
                const groupName = getGroupName(from);
                if (groupName === "shop-packs") return !activePack;
                if (groupName === "shop-pack-open") {
                  const isPackOption = dragEl?.dataset?.packOption === "1";
                  return isPackOption && dragEl?.dataset?.itemType === "dev";
                }
                if (groupName !== "shop-offers") return false;
                return dragEl?.dataset?.itemType === "dev";
              },
            },
            onAdd: (evt) => {
              const isPackOption = evt.item?.dataset?.packOption === "1";
              const packIdFromOption = evt.item?.dataset?.packId;
              const optionItemId = evt.item?.dataset?.itemId;
              if (isPackOption && packIdFromOption && optionItemId) {
                setTimeout(
                  () => handlersRef.current.onSelectPackItem(packIdFromOption, optionItemId),
                  0,
                );
                return;
              }
              const packId = evt.item?.dataset?.packId;
              if (packId) {
                setTimeout(() => handlersRef.current.onDropOpenPack(packId), 0);
                return;
              }
              const itemId = evt.item?.dataset?.itemId;
              if (itemId) {
                setTimeout(() => handlersRef.current.onDropBuyItem(itemId), 0);
              }
            },
          });

          const fromOffers = (to, from, dragEl, acceptedType) => {
            if (!from) return false;
            const fromGroup = getGroupName(from);
            const toGroup = getGroupName(to);
            if (fromGroup === "shop-offers") {
              return dragEl?.dataset?.itemType === acceptedType;
            }
            return fromGroup === toGroup;
          };

          addSortable(ownedContactRef, {
            popupSource: "owned-contact",
            animation: 120,
            sort: true,
            group: {
              name: "owned-contact",
              pull: true,
              put: (to, from, dragEl) => fromOffers(to, from, dragEl, "contact"),
            },
            draggable: ".shop-card-item",
            onAdd: (evt) => {
              const itemId = evt.item?.dataset?.itemId;
              const itemType = evt.item?.dataset?.itemType;
              const packId = evt.item?.dataset?.packId;
              const isPackOption = evt.item?.dataset?.packOption === "1";
              if (isPackOption && packId && itemId && itemType === "contact") {
                setTimeout(() => handlersRef.current.onSelectPackItem(packId, itemId), 0);
                return;
              }
              if (itemId && itemType === "contact") {
                setTimeout(() => handlersRef.current.onDropEquipFromShop(itemId, "contact"), 0);
              }
            },
            onStart: (evt) => {
              setSellOverlayFromDragEl(evt?.item, "owned-contact");
            },
            onEnd: (evt) => {
              clearDragOverlay();
              clearSlotBuyHint();
              if (!evt || evt.from !== evt.to) return;
              if (!ownedContactRef.current) return;
              const contactIds = Array.from(
                ownedContactRef.current.querySelectorAll('[data-item-type="contact"][data-item-id]'),
              )
                .map((el) => el.dataset.itemId)
                .filter(Boolean);
              if (contactIds.length) {
                setTimeout(() => handlersRef.current.onReorderAddressBook(contactIds), 0);
              }
            },
          });
          addSortable(ownedEmailRef, {
            popupSource: "owned-email",
            animation: 120,
            sort: true,
            group: {
              name: "owned-email",
              pull: true,
              put: (to, from, dragEl) => {
                if (!from) return false;
                if (getGroupName(from) === "shop-offers") {
                  const t = dragEl?.dataset?.itemType;
                  return t === "salutation" || t === "signoff" || t === "signature";
                }
                return getGroupName(from) === "owned-email";
              },
            },
            draggable: ".shop-card-item",
            onAdd: (evt) => {
              const itemId = evt.item?.dataset?.itemId;
              const itemType = evt.item?.dataset?.itemType;
              const packId = evt.item?.dataset?.packId;
              const isPackOption = evt.item?.dataset?.packOption === "1";
              if (
                isPackOption &&
                packId &&
                itemId &&
                (itemType === "salutation" || itemType === "signoff" || itemType === "signature")
              ) {
                setTimeout(() => handlersRef.current.onSelectPackItem(packId, itemId), 0);
                return;
              }
              if (
                itemId &&
                (itemType === "salutation" || itemType === "signoff" || itemType === "signature")
              ) {
                setTimeout(() => handlersRef.current.onDropEquipFromShop(itemId, itemType), 0);
              }
            },
            onEnd: (evt) => {
              clearDragOverlay();
              clearSlotBuyHint();
              if (!evt || evt.from !== evt.to) return;
              const movedType = evt.item?.dataset?.itemType;
              if (
                movedType === "salutation" ||
                movedType === "signoff" ||
                movedType === "content"
              ) {
                if (typeof handlersRef.current.onReconcileShopDom === "function") {
                  setTimeout(() => handlersRef.current.onReconcileShopDom(), 0);
                }
                return;
              }
              if (!ownedEmailRef.current) return;
              const sigIds = Array.from(
                ownedEmailRef.current.querySelectorAll('[data-item-type="signature"][data-item-id]'),
              )
                .map((el) => el.dataset.itemId)
                .filter(Boolean);
              if (sigIds.length) {
                setTimeout(() => handlersRef.current.onReorderSignatures(sigIds), 0);
              }
            },
            onStart: (evt) => {
              setSellOverlayFromDragEl(evt?.item, "owned-email");
            },
          });
          addSortable(ownedBccRef, {
            popupSource: "owned-bcc",
            animation: 120,
            sort: true,
            group: {
              name: "owned-bcc",
              pull: true,
              put: (to, from) => {
                const fromGroup = getGroupName(from);
                if (fromGroup === "shop-offers") return true;
                return fromGroup === "owned-bcc";
              },
            },
            draggable: ".shop-card-item",
            onAdd: (evt) => {
              const itemId = evt.item?.dataset?.itemId;
              const packId = evt.item?.dataset?.packId;
              const isPackOption = evt.item?.dataset?.packOption === "1";
              if (isPackOption && packId && itemId) {
                setTimeout(() => handlersRef.current.onSelectPackItem(packId, itemId), 0);
                return;
              }
              if (itemId) {
                setTimeout(() => handlersRef.current.onDropEquipFromShop(itemId, "bcc"), 0);
              }
            },
            onStart: (evt) => {
              setSellOverlayFromDragEl(evt?.item, "owned-bcc");
            },
            onEnd: (evt) => {
              clearDragOverlay();
              clearSlotBuyHint();
              if (!evt || evt.from !== evt.to) return;
              if (!ownedBccRef.current) return;
              const bccIndices = Array.from(
                ownedBccRef.current.querySelectorAll('[data-item-type="bcc"][data-item-index]'),
              )
                .map((el) => Number(el.dataset.itemIndex))
                .filter((v) => Number.isFinite(v));
              if (bccIndices.length) {
                setTimeout(() => {
                  if (typeof handlersRef.current.onReorderBcc === "function") {
                    handlersRef.current.onReorderBcc(bccIndices);
                  }
                }, 0);
              }
            },
          });
          addSortable(sellOverlayRef, {
            animation: 120,
            sort: false,
            group: {
              name: "sell-overlay",
              pull: false,
              put: (to, from, dragEl) => {
                const type = dragEl?.dataset?.itemType;
                if (!type || type === "content") return false;
                return [
                  "owned-contact",
                  "owned-email",
                  "owned-bcc",
                ].includes(getGroupName(from));
              },
            },
            onAdd: (evt) => {
              const itemType = evt.item?.dataset?.itemType;
              const itemId = evt.item?.dataset?.itemId;
              const itemIndexRaw = evt.item?.dataset?.itemIndex;
              const itemIndex = itemIndexRaw == null ? null : Number(itemIndexRaw);
              if (itemType && itemId) {
                setTimeout(
                  () =>
                    handlersRef.current.onDropArchiveOwned(
                      itemType,
                      itemId,
                      Number.isFinite(itemIndex) ? itemIndex : null,
                    ),
                  0,
                );
              }
            },
          });

          return () => {
            setCardDragViewportLock(false);
            setMobileAssetDragPriority(false);
            sortables.forEach((s) => s.destroy());
          };
        }, [activePack]);

        const prioritizeAssetsOnMobile =
          !!mobileAssetDragPriority || !!(activePack && activePack.type === "email");

        return e(
          "div",
          { className: "fixed inset-0 z-[130] win-bg flex flex-col items-stretch p-4" },
          e(
            "div",
            { className: "bg-[#c0c0c0] retro-border shadow-2xl flex flex-col min-h-0 h-full" },
            e(
              "div",
              { className: "window-titlebar text-white px-2 py-1 flex justify-between items-center text-xs font-bold shrink-0" },
              e("span", null, "INTRA-NET: HR PORTAL & EMPLOYEE SERVICES"),
              e("span", { className: "bg-yellow-400 text-black px-2 rounded-sm ml-auto mr-4" }, `REP:${rep}`),
            ),
            e(
              "div",
              { className: "bg-[#f0f0f0] p-4 flex-grow overflow-y-auto space-y-4" },
              props.notice
                ? e(
                    "div",
                    { className: "text-[11px] bg-amber-100 border border-amber-300 text-amber-800 px-2 py-1" },
                    props.notice,
                  )
                : null,
              e(
                "div",
                { className: "flex items-center gap-6" },
                e(
                  "button",
                  {
                    onClick: activePack ? props.onClosePack : props.onReroll,
                    className: "retro-button text-black text-[10px] py-1 px-2 flex-1",
                  },
                  activePack ? "<Take Nothing>" : `Reroll (${rerollCost} REP)`,
                ),
                e(
                  "button",
                  {
                    onClick: props.onNextQuarter,
                    className: "retro-button text-black text-[10px] py-1 px-2 whitespace-nowrap",
                  },
                  "NEXT QUARTER >",
                ),
              ),
              e(
                "div",
                { className: "grid grid-cols-1 md:grid-cols-2 gap-6" },
                    e(
                      "div",
                      { className: "md:col-span-2 relative" },
                      e(
                        "div",
                        { className: "grid grid-cols-2 gap-2" },
                        e(
                          "div",
                          { className: activePack ? "space-y-2 col-span-2" : "space-y-2" },
                          e(
                            "h3",
                            { className: "text-xs font-bold uppercase border-b border-[#808080] pb-1" },
                            activePack
                              ? `${activePack.name || "Training Pack"} • Pick ${props.state.packsOpen?.[activePack.id]?.picksLeft || 0} of ${activePack.picks || 0}`
                              : "Opportunities",
                          ),
                          e(
                            "div",
                            {
                              ref: directListRef,
                              className: "border border-gray-200 bg-white p-2 adaptive-card-track",
                              style: directTrack.trackStyle,
                            },
                            directDisplayItems
                              .map((item, idx) => {
                                const meta = typeMeta(item.itemType);
                                return e(
                                  ItemCard,
                                  {
                                    key: activePack ? `${activePack.id}-${item.id}` : item.id,
                                    itemId: item.id,
                                    itemType: item.itemType,
                                    packOption: !!activePack,
                                    packId: activePack ? activePack.id : "",
                                    cardInstanceId: getCardInstanceId(
                                      activePack ? "shop-pack-option" : "shop-offer",
                                      item.itemType,
                                      item.id,
                                      activePack ? activePack.id : "",
                                    ),
                                    onClick: (evt) => {
                                      if (shouldSuppressCardClick()) return;
                                      openDirectDetail(item, evt.currentTarget, activePack ? { mode: "pack-option", packId: activePack.id } : {});
                                    },
                                    style: getTrackCardStyle(idx, directTrack),
                                    headerStyle: { background: meta.headerBg, color: meta.headerText },
                                    headerText:
                                      (activePack ? 0 : getDisplayCost(item)) > 0
                                        ? `${meta.label} • ${activePack ? 0 : getDisplayCost(item)} REP`
                                        : `${meta.label}`,
                                    frameStyle: { background: meta.paneBg, color: meta.paneText },
                                  },
                                  e("div", { className: "shop-card-name" }, item.name),
                                );
                              }),
                          ),
                        ),
                        activePack
                          ? null
                          : e(
                          "div",
                          { className: "space-y-2" },
                          e("h3", { className: "text-xs font-bold uppercase border-b border-[#808080] pb-1" }, "Seminars"),
                          e(
                            "div",
                            {
                              ref: packListRef,
                              className: "border border-gray-200 bg-white p-2 adaptive-card-track",
                              style: packTrack.trackStyle,
                            },
                            packDisplayItems
                              .map((pack, idx) => {
                                const meta = typeMeta(pack.type || "dev");
                                return e(
                                  ItemCard,
                                  {
                                    key: pack.id,
                                    packId: pack.id,
                                    cardInstanceId: getCardInstanceId("shop-pack", pack.type || "dev", pack.id),
                                    onClick: (evt) => {
                                      if (shouldSuppressCardClick()) return;
                                      openPackDetail(pack, evt.currentTarget);
                                    },
                                    style: getTrackCardStyle(idx, packTrack),
                                    headerStyle: { background: meta.headerBg, color: meta.headerText },
                                    headerText:
                                      (pack.cost || 0) > 0
                                        ? `pack • ${pack.cost || 0} REP`
                                        : "pack",
                                    frameStyle: { background: meta.paneBg, color: meta.paneText },
                                  },
                                  e("div", { className: "shop-card-name" }, pack.name),
                                );
                              }),
                          ),
                        ),
                      ),
                      e(DragOverlayTarget, {
                        overlayRef: sellOverlayRef,
                        tone: "sell",
                        active: dragOverlay.sellActive,
                        idleLabel: `Drag Here to ${dragOverlay.sellLabel}`,
                        activeLabel: dragOverlay.sellLabel,
                      }),
                    ),
                    e(
                      "div",
                      { className: "space-y-2 md:col-span-2" },
                      e("h3", { className: "text-xs font-bold uppercase border-b border-[#808080] pb-1" }, "Manage Current Assets"),
                      e(
                        "div",
                        { className: "grid grid-cols-1 lg:grid-cols-2 gap-4 text-[11px] relative" },
                        e(
                          "div",
                          {
                            className: `border border-gray-300 bg-white ${
                              prioritizeAssetsOnMobile ? "order-2 lg:order-1" : "order-1"
                            }`,
                          },
                          e(
                            "div",
                            { className: "grid grid-cols-1 md:grid-cols-4 gap-2 p-2" },
                            e(
                              "div",
                              { className: "md:col-span-3" },
                              e("div", { className: "address-book-header mb-2" }, `Address Book (${addressCurrent}/${addressMax})`),
                              e(
                                "div",
                                {
                                  ref: ownedContactRef,
                                  className: `adaptive-card-track ${slotBuyHint.contact ? "buy-slot-outline" : ""}`,
                                  style: ownedContactTrack.trackStyle,
                                },
                                owned.addressBook.length
                                  ? owned.addressBook.map((item, idx) => {
                                      const meta = typeMeta("contact");
                                      return e(
                                        ItemCard,
                                        {
                                          key: `owned-contact-${item.id}`,
                                          itemType: "contact",
                                          itemId: item.id,
                                          cardInstanceId: getCardInstanceId("owned-contact", "contact", item.id),
                                          onClick: (evt) => {
                                            if (shouldSuppressCardClick()) return;
                                            openOwnedDetail("contact", item, null, evt.currentTarget);
                                          },
                                          style: getTrackCardStyle(idx, ownedContactTrack),
                                          headerStyle: { background: meta.headerBg, color: meta.headerText },
                                          headerText: meta.label,
                                          frameStyle: { background: meta.paneBg, color: meta.paneText },
                                        },
                                        e(
                                          "div",
                                          null,
                                          e("div", { className: "shop-card-name" }, item.name),
                                        ),
                                      );
                                    })
                                  : e("div", { className: "text-[10px] text-gray-500 italic p-2" }, "No contacts on file."),
                              ),
                            ),
                            e(
                              "div",
                              { className: "md:col-span-1" },
                              e("div", { className: "address-book-header mb-2" }, `Internal Services (${bccCurrent}/${bccMax})`),
                              e(
                                "div",
                                {
                                  ref: ownedBccRef,
                                  className: `adaptive-card-track ${slotBuyHint.bcc ? "buy-slot-outline" : ""}`,
                                  style: ownedBccTrack.trackStyle,
                                },
                                owned.bcc.length
                                  ? owned.bcc.map((item, idx) => {
                                      const meta = typeMeta("bcc");
                                      return e(
                                        ItemCard,
                                        {
                                          key: `owned-bcc-${idx}-${item.id}`,
                                          itemType: "bcc",
                                          itemId: item.id,
                                          itemIndex: idx,
                                          cardInstanceId: getCardInstanceId("owned-bcc", "bcc", item.id, String(idx)),
                                          onClick: (evt) => {
                                            if (shouldSuppressCardClick()) return;
                                            openOwnedDetail("bcc", item, idx, evt.currentTarget);
                                          },
                                          style: getTrackCardStyle(idx, ownedBccTrack),
                                          headerStyle: { background: meta.headerBg, color: meta.headerText },
                                          headerText: meta.label,
                                          frameStyle: { background: meta.paneBg, color: meta.paneText },
                                        },
                                        e("div", { className: "shop-card-name" }, item.name),
                                      );
                                    })
                                  : e("div", { className: "text-[10px] text-gray-500 italic p-2" }, "No internal services."),
                              ),
                            ),
                          ),
                        ),
                        e(
                          "div",
                          {
                            className: `email-template-shell space-y-2 ${
                              prioritizeAssetsOnMobile ? "order-1 lg:order-2" : "order-2"
                            }`,
                          },
                          e("div", { className: "address-book-header mb-1" }, `Signatures (${sigCurrent}/${sigMax})`),
                          e("div", { className: "text-[10px] text-gray-700" }, e("strong", null, "To:"), " everyone@gov.org"),
                          e(
                            "div",
                            {
                              ref: ownedEmailRef,
                              className: `adaptive-card-track border border-gray-200 p-2 ${slotBuyHint.email ? "buy-slot-outline" : ""}`,
                              style: ownedEmailTrack.trackStyle,
                            },
                            owned.salutation
                              ? (() => {
                                  const meta = typeMeta("salutation");
                                  return e(
                                    ItemCard,
                                    {
                                      itemType: "salutation",
                                      itemId: owned.salutation.id,
                                      cardInstanceId: getCardInstanceId("owned-email", "salutation", owned.salutation.id),
                                      onClick: (evt) => {
                                        if (shouldSuppressCardClick()) return;
                                        openOwnedDetail("salutation", owned.salutation, null, evt.currentTarget);
                                      },
                                      style: getTrackCardStyle(0, ownedEmailTrack),
                                      headerStyle: { background: meta.headerBg, color: meta.headerText },
                                      headerText: meta.label,
                                      frameStyle: { background: meta.paneBg, color: meta.paneText },
                                    },
                                    e("div", { className: "shop-card-name" }, owned.salutation.name),
                                  );
                                })()
                              : (() => {
                                  const meta = typeMeta("salutation");
                                  return e(
                                    ItemCard,
                                    {
                                      style: getTrackCardStyle(0, ownedEmailTrack),
                                      headerStyle: { background: meta.headerBg, color: meta.headerText },
                                      headerText: meta.label,
                                      frameStyle: { background: meta.paneBg, color: meta.paneText },
                                    },
                                    e("div", { className: "shop-card-name italic opacity-70" }, "(empty)"),
                                  );
                                })(),
                            e(
                              ItemCard,
                              {
                                itemType: "content",
                                cardInstanceId: getCardInstanceId("owned-email", "content", "placeholder"),
                                extraClassName: "template-content-card",
                                style: getTrackCardStyle(1, ownedEmailTrack),
                                headerStyle: { background: "#4b5563", color: "#fff" },
                                headerText: "content",
                                frameStyle: { background: "#f3f4f6", color: "#6b7280" },
                              },
                              e("div", { className: "shop-card-name italic" }, "<CONTENT>"),
                            ),
                            owned.signoff
                              ? (() => {
                                  const meta = typeMeta("signoff");
                                  return e(
                                    ItemCard,
                                    {
                                      itemType: "signoff",
                                      itemId: owned.signoff.id,
                                      cardInstanceId: getCardInstanceId("owned-email", "signoff", owned.signoff.id),
                                      onClick: (evt) => {
                                        if (shouldSuppressCardClick()) return;
                                        openOwnedDetail("signoff", owned.signoff, null, evt.currentTarget);
                                      },
                                      style: getTrackCardStyle(2, ownedEmailTrack),
                                      headerStyle: { background: meta.headerBg, color: meta.headerText },
                                      headerText: meta.label,
                                      frameStyle: { background: meta.paneBg, color: meta.paneText },
                                    },
                                    e("div", { className: "shop-card-name" }, owned.signoff.name),
                                  );
                                })()
                              : (() => {
                                  const meta = typeMeta("signoff");
                                  return e(
                                    ItemCard,
                                    {
                                      style: getTrackCardStyle(2, ownedEmailTrack),
                                      headerStyle: { background: meta.headerBg, color: meta.headerText },
                                      headerText: meta.label,
                                      frameStyle: { background: meta.paneBg, color: meta.paneText },
                                    },
                                    e("div", { className: "shop-card-name italic opacity-70" }, "(empty)"),
                                  );
                                })(),
                            owned.signatures.length
                              ? owned.signatures.map((item, idx) => {
                                  const meta = typeMeta("signature");
                                  return e(
                                    ItemCard,
                                    {
                                      key: `owned-signature-${item.id}`,
                                      itemType: "signature",
                                      itemId: item.id,
                                      cardInstanceId: getCardInstanceId("owned-email", "signature", item.id),
                                      onClick: (evt) => {
                                        if (shouldSuppressCardClick()) return;
                                        openOwnedDetail("signature", item, null, evt.currentTarget);
                                      },
                                      style: getTrackCardStyle(idx + 3, ownedEmailTrack),
                                      headerStyle: { background: meta.headerBg, color: meta.headerText },
                                      headerText: meta.label,
                                      frameStyle: { background: meta.paneBg, color: meta.paneText },
                                    },
                                    e("div", { className: "shop-card-name" }, item.name),
                                  );
                                })
                              : null,
                          ),
                        ),
                        e(DragOverlayTarget, {
                          overlayRef: buyOverlayRef,
                          tone: "buy",
                          active: dragOverlay.buyActive,
                          idleLabel: `Drag Here to ${dragOverlay.buyLabel}`,
                          activeLabel: dragOverlay.buyLabel,
                        }),
                      ),
                    ),
                  ),
            ),
          ),
          renderDetailPopup(),
        );
      }

      function PromotionScreen(props) {
        const promotion = props.promotion || {};
        return e(
          "div",
          { className: "fixed inset-0 z-[125] bg-black/50 flex items-center justify-center p-4" },
          e(
            "div",
            { className: "bg-[#c0c0c0] retro-border max-w-sm w-full p-4" },
            e("div", { className: "text-xl font-bold terminal-font mb-2 text-[#000080]" }, "PROMOTION"),
            e("div", { className: "text-sm mb-3" }, `New Title: ${promotion.titleName || "Updated Role"}`),
            e(
              "div",
              { className: "grid grid-cols-3 gap-2 text-center mb-4 text-[10px]" },
              e("div", { className: "bg-gray-100 retro-border-inset px-2 py-1" }, e("div", { className: "uppercase text-gray-500" }, "Signatures"), e("div", { className: "text-[12px] font-bold" }, String(promotion.sigLimit || 0))),
              e("div", { className: "bg-gray-100 retro-border-inset px-2 py-1" }, e("div", { className: "uppercase text-gray-500" }, "Address Book"), e("div", { className: "text-[12px] font-bold" }, String(promotion.addressLimit || 0))),
              e("div", { className: "bg-gray-100 retro-border-inset px-2 py-1" }, e("div", { className: "uppercase text-gray-500" }, "CC per Action"), e("div", { className: "text-[12px] font-bold" }, String(promotion.numCCperCCaction || 1))),
            ),
            e("button", { onClick: props.onContinue, className: "w-full retro-button py-2 font-bold" }, "CONTINUE"),
          ),
        );
      }

      function CampaignCompleteScreen(props) {
        const player = props.player || {};
        const titleName = player.title?.name || "Executive";
        return e(
          "div",
          { className: "fixed inset-0 z-[140] bg-black/60 flex items-center justify-center p-4" },
          e(
            "div",
            { className: "bg-[#c0c0c0] retro-border max-w-sm w-full p-4" },
            e("div", { className: "text-xl font-bold terminal-font mb-2 text-[#0f5132]" }, "CAMPAIGN COMPLETE"),
            e("div", { className: "text-[12px] text-gray-700 mb-3" }, `${player.name || "Employee"} closed every required thread.`),
            e("div", { className: "text-[11px] mb-1" }, `Role: ${titleName}`),
            e("div", { className: "text-[11px] mb-1" }, `Reputation: ${player.reputation || 0}`),
            e("div", { className: "text-[11px] mb-4" }, `Period: ${(player.quarter || "Q3")} - YR ${player.year || 1}`),
            e("button", { onClick: props.onBackToMenu, className: "w-full retro-button py-2 font-bold" }, "BACK TO MENU"),
          ),
        );
      }

      function GameUIScreen(props) {
        const mission = props.mission || MISSIONS[0];
        const player = props.state.player || {};
        const opponents = props.state.opponents || [];
        const normalizeStakeholderKey = (value) => String(value || "").trim().toLowerCase();
        const getIdentityTokens = (raw) => {
          return String(raw || "")
            .split(/[;,]/)
            .map((part) => part.trim())
            .filter(Boolean)
            .flatMap((part) => {
              const match = part.match(/<([^>]+)>/);
              const email = match ? match[1].trim() : "";
              const nameOnly = part.replace(/<[^>]+>/g, "").trim();
              return [part, nameOnly, email].filter(Boolean);
            });
        };
        const resolveEntryTargetId = (entry) => {
          if (!entry || !opponents.length) return null;
          const findMatchedOpponent = (tokens) => {
            for (let j = 0; j < tokens.length; j += 1) {
              const token = normalizeStakeholderKey(tokens[j]);
              const matched = opponents.find((opp) => {
                const keys = [
                  normalizeStakeholderKey(opp.id),
                  normalizeStakeholderKey(opp.name),
                  normalizeStakeholderKey(opp.email),
                ];
                return keys.includes(token);
              });
              if (matched) return matched;
            }
            return null;
          };

          const fromMatch = findMatchedOpponent(getIdentityTokens(entry.from));
          if (fromMatch) {
            // If sender stakeholder already opted out, clicking this row should not retarget.
            if ((fromMatch.hp || 0) <= 0) return null;
            return fromMatch.id;
          }

          // Fallback to "To" only when sender isn't a known stakeholder (e.g. player-authored rows).
          const toMatch = findMatchedOpponent(getIdentityTokens(entry.to));
          if (toMatch && (toMatch.hp || 0) > 0) {
            return toMatch.id;
          }
          return null;
        };
        const selectedTarget =
          opponents.find((o) => o.id === props.state.targetId) || opponents[0] || null;
        const activeBuffs = [
          ...(Array.isArray(player.buffs) ? player.buffs : []),
          ...opponents.flatMap((o) => (Array.isArray(o.buffs) ? o.buffs : [])),
        ];
        const usedByOrder = (name) => {
          if (name === player.name) return 0;
          const idx = opponents.findIndex((o) => o.name === name);
          return idx >= 0 ? idx + 1 : 999;
        };
        const sortedBuffs = [...activeBuffs].sort((a, b) => {
          const byUsed = usedByOrder(a.usedBy) - usedByOrder(b.usedBy);
          if (byUsed !== 0) return byUsed;
          const deptA = ReplyAllEngine.core.getDepartmentName(a.departmentId);
          const deptB = ReplyAllEngine.core.getDepartmentName(b.departmentId);
          const byDept = deptA.localeCompare(deptB);
          if (byDept !== 0) return byDept;
          return (a.name || "").localeCompare(b.name || "");
        });
        const statCtx = props.state?._statCtx || null;
        const maxHp = Math.max(1, player.maxHp || player.hp || 1);
        const hpPct = Math.max(0, Math.min(100, ((player.hp || 0) / maxHp) * 100));
        const showDraftingIndicators =
          !!props.state.missionActive && !props.state.isProcessing && !props.state.gameOver;
        const aiPreviewRows = showDraftingIndicators
          ? ReplyAllEngine.core.getAiActionPreviewRows(props.state)
          : [];
        const baseActionCards = [
          { id: "ATTACK", label: "Reply to" },
          { id: "ESCALATE", label: "Escalate" },
          { id: "PROMOTE", label: "Self-Promote" },
          { id: "DEFLECT", label: "Deflect" },
          { id: "ULT", label: "Reply All" },
          { id: "ADDRESS_BOOK", label: "Address Book" },
        ];
        const contactMeta = ITEM_TYPE_LABELS?.contact || {
          label: "Contact",
          headerBg: "#111827",
          headerText: "#ffffff",
          paneBg: "#e5e7eb",
          paneText: "#111827",
        };
        const bccMeta = ITEM_TYPE_LABELS?.bcc || {
          label: "Internal Service",
          headerBg: "#7c2d12",
          headerText: "#ffffff",
          paneBg: "#fef3c7",
          paneText: "#78350f",
        };
        const actionLabelById = baseActionCards.reduce((acc, item) => {
          acc[item.id] = item.label;
          return acc;
        }, {});
        const emailDropRef = React.useRef(null);
        const targetDropRef = React.useRef(null);
        const actionDockRef = React.useRef(null);
        const dragRef = React.useRef(null);
        const [dragActionId, setDragActionId] = React.useState(null);
        const [dragDrawerPayload, setDragDrawerPayload] = React.useState(null);
        const [isOverEmailDrop, setIsOverEmailDrop] = React.useState(false);
        const [isOverTargetDrop, setIsOverTargetDrop] = React.useState(false);
        const [dragPointer, setDragPointer] = React.useState({ x: 0, y: 0 });
        const [actionDetailPopup, setActionDetailPopup] = React.useState(null);
        const [ccDetailPopup, setCcDetailPopup] = React.useState(null);
        const actionDetailPopupRef = React.useRef(null);
        const ccDetailPopupRef = React.useRef(null);
        const [stakeholderPopup, setStakeholderPopup] = React.useState(null);
        const [addressDrawerOpen, setAddressDrawerOpen] = React.useState(false);
        const [addressDrawerAddsUsed, setAddressDrawerAddsUsed] = React.useState(0);
        const [ccExpanded, setCcExpanded] = React.useState(false);
        const [ccWrapCount, setCcWrapCount] = React.useState(0);
        const ccContainerRef = React.useRef(null);
        const availableDrawerContacts = props.ccContactStatuses || props.availableCcContacts || [];
        const availableDrawerBccs = props.availableBccContacts || [];
        const addressBookCards = [
          ...availableDrawerContacts.map((contact) => ({
            id: `AB_CONTACT_${contact.id}`,
            label: contact.name,
            kind: "drawer",
            itemType: "contact",
            item: contact,
            unavailable: contact.available === false,
            unavailableReason: contact.statusText || "",
            waitText: contact.waitText || "",
            blockedByStakeholder: contact.blockedByStakeholder || null,
          })),
          ...availableDrawerBccs.map((bcc, idx) => ({
            id: `AB_BCC_${bcc.id}_${idx}`,
            label: bcc.name,
            kind: "drawer",
            itemType: "bcc",
            item: bcc,
            bccIndex: idx,
          })),
          {
            id: "CLOSE_ADDRESS_BOOK",
            label: "Close Address Book",
            kind: "action",
          },
        ];
        const displayedActionCards = addressDrawerOpen ? addressBookCards : baseActionCards;
        const dragAction = dragActionId
          ? (displayedActionCards.find((action) => action.id === dragActionId) ||
            baseActionCards.find((action) => action.id === dragActionId) ||
            null)
          : null;
        const activeDrag = dragAction
          ? { kind: "action", actionId: dragAction.id }
          : dragDrawerPayload;
        const isReplyDrag = activeDrag?.kind === "action" && activeDrag.actionId === "ATTACK";
        const getActionDetailText = (actionId) => {
          if (actionId === "PROMOTE") {
            const curHp = Math.max(0, Math.ceil(player.hp || 0));
            const curWins = Math.max(0, Math.floor(player.currentWins || 0));
            const heal = statCtx
              ? ReplyAllEngine.stats.getUnitSelfPromoteHeal(statCtx, player, 15)
              : (player.selfPromoteHeal || 15);
            const nextHp = Math.max(0, Math.ceil(Math.min(maxHp, (player.hp || 0) + heal)));
            const nextWins = Math.max(0, curWins - (curWins > 0 ? 1 : 0));
            return `Recover credibility and spend one win.\nHP: ${curHp} -> ${nextHp}\nWins: ${curWins} -> ${nextWins}`;
          }
          if (actionId === "DEFLECT") {
            const reduce = statCtx
              ? Math.floor(ReplyAllEngine.stats.getUnitDeflectReduce(statCtx, player))
              : Math.floor(player.deflect || 0);
            const retaliate = statCtx
              ? Math.floor(ReplyAllEngine.stats.getUnitDeflectReflect(statCtx, player))
              : Math.floor(player.retaliation || 0);
            return `Prepare a defensive response.\nDeflect / Retaliate: ${reduce} / ${retaliate}`;
          }
          return props.actionHints?.[actionId] || "No action details.";
        };
        const getDrawerDetailText = (drawerPayload) => {
          if (!drawerPayload) return "No additional details.";
          const item = drawerPayload.item || {};
          if (drawerPayload.itemType === "contact") {
            return getThreadContactDetailText(item, drawerPayload);
          }
          const lines = [];
          if (item.description) lines.push(item.description);
          const effectText = ReplyAllEngine.copy?.getItemBonusText
            ? ReplyAllEngine.copy.getItemBonusText(item, {})
            : "";
          if (effectText && effectText !== "No listed effect.") {
            lines.push(`Effects: ${effectText}`);
          }
          return lines.length ? lines.join("\n\n") : "No additional details.";
        };
        const getThreadContactDetailText = (contact, cardMeta = null) => {
          if (!contact) return "No additional details.";
          const lines = [];
          if (contact.title || contact.subtitle) {
            const subtitle = contact.subtitle ? ` • ${contact.subtitle}` : "";
            lines.push(`${contact.title || ""}${subtitle}`.trim());
          }
          if (contact.departmentId) {
            const dept = ReplyAllEngine.core.getDepartmentName(contact.departmentId);
            if (dept) lines.push(`Department: ${dept}`);
          }
          const trainingBoosts =
            (contact.id && player?.contactPermanentBoosts?.[contact.id]) || null;
          const trainingCount =
            (contact.id && Number(player?.contactTrainingCount?.[contact.id])) || 0;
          if (trainingBoosts && ReplyAllEngine.copy?.formatStatsText) {
            const trainingText = ReplyAllEngine.copy.formatStatsText(trainingBoosts);
            if (trainingText) {
              lines.push(`Training (${Math.max(0, trainingCount)}): ${trainingText}`);
            }
          }
          const effectText = ReplyAllEngine.copy?.getItemBonusText
            ? ReplyAllEngine.copy.getItemBonusText(contact, {})
            : "";
          if (effectText && effectText !== "No listed effect.") {
            lines.push(`Effects: ${effectText}`);
          }
          const reason = cardMeta?.unavailableReason || contact.statusText || "";
          const waitText = cardMeta?.waitText || contact.waitText || "";
          if (reason) lines.push(reason);
          if (waitText) lines.push(`(${waitText})`);
          return lines.length ? lines.join("\n\n") : "No additional details.";
        };
        const getCcDetailText = (buff) => getThreadContactDetailText(buff);
        const dragDetailTitle = dragAction
          ? (actionLabelById[dragAction.id] || dragAction.id)
          : dragDrawerPayload
            ? (dragDrawerPayload.itemType === "bcc" ? bccMeta.label : contactMeta.label)
            : "";
        const dragDetailText = dragAction
          ? getActionDetailText(dragAction.id)
          : dragDrawerPayload
            ? getDrawerDetailText(dragDrawerPayload)
            : "";
        const dragDetailPos = React.useMemo(() => {
          if (!activeDrag) return null;
          const padding = 8;
          const cardWidth = 84;
          const popupWidth = 260;
          const popupHeight = 124;
          const gap = 12;
          const roomRight = window.innerWidth - dragPointer.x - cardWidth / 2 - padding;
          const placeRight = roomRight >= popupWidth + gap;
          let left = placeRight
            ? dragPointer.x + cardWidth / 2 + gap
            : dragPointer.x - cardWidth / 2 - gap - popupWidth;
          let top = dragPointer.y - popupHeight / 2;
          left = Math.max(padding, Math.min(left, window.innerWidth - popupWidth - padding));
          top = Math.max(padding, Math.min(top, window.innerHeight - popupHeight - padding));
          return { left, top };
        }, [activeDrag, dragPointer.x, dragPointer.y]);
        const actionDockTrack = useAdaptiveCardTrack(actionDockRef, displayedActionCards.length);
        const maxAddressAdds = Math.max(
          1,
          Math.floor(
            statCtx
              ? (ReplyAllEngine.stats.computeUnitStats(statCtx, player).numCCperCCaction || 1)
              : (player.numCCperCCaction || 1),
          ),
        );
        const getAttackPreviewDamage = (target) => {
          if (!target) return 0;
          const singleDmg = statCtx
            ? ReplyAllEngine.stats.getUnitDamage(statCtx, player, "single")
            : (player.singleDmg || 0);
          // Intentional: include flat defense only, not prepared deflect charge reduction.
          const flatDef = statCtx
            ? ReplyAllEngine.stats.getUnitFlatDef(statCtx, target)
            : (target.defFlat || 0);
          return Math.max(0, Math.floor(singleDmg - flatDef));
        };
        const getDragOverlayText = (dragPayload, releaseMode) => {
          if (!dragPayload) return "";
          if (dragPayload.kind === "action" && dragPayload.actionId === "ATTACK") {
            const target = selectedTarget;
            const targetName = target?.name || "target";
            const dmg = getAttackPreviewDamage(target);
            return releaseMode
              ? `Release to reply to ${targetName} for -${dmg}`
              : `Drag Here to reply to ${targetName} for -${dmg}`;
          }
          if (dragPayload.kind === "drawer") {
            const label = dragPayload.item?.name || "contact";
            return releaseMode
              ? `Release to use ${label}`
              : `Drag Here to use ${label}`;
          }
          if (dragPayload.kind === "action" && dragPayload.actionId === "ADDRESS_BOOK") {
            return releaseMode ? "Release to open Address Book" : "Drag Here to open Address Book";
          }
          if (dragPayload.kind === "action" && dragPayload.actionId === "CLOSE_ADDRESS_BOOK") {
            return releaseMode ? "Release to close Address Book" : "Drag Here to close Address Book";
          }
          const label = actionLabelById[dragPayload.actionId] || "Use Action";
          return releaseMode
            ? `Release to ${label}`
            : `Drag Here to ${label}`;
        };
        React.useLayoutEffect(() => {
          const node = ccContainerRef.current;
          if (!node || !sortedBuffs.length) {
            if (ccWrapCount !== 0) setCcWrapCount(0);
            return undefined;
          }
          const measure = () => {
            const pills = Array.from(node.querySelectorAll(".cc-pill"));
            if (!pills.length) {
              if (ccWrapCount !== 0) setCcWrapCount(0);
              return;
            }
            const firstRowTop = pills[0].offsetTop;
            const wrapped = pills.reduce(
              (count, pill) => (pill.offsetTop === firstRowTop ? count : count + 1),
              0,
            );
            if (wrapped !== ccWrapCount) setCcWrapCount(wrapped);
          };
          const raf = window.requestAnimationFrame(measure);
          window.addEventListener("resize", measure);
          return () => {
            window.cancelAnimationFrame(raf);
            window.removeEventListener("resize", measure);
          };
        }, [sortedBuffs.length, ccExpanded, ccWrapCount]);
        React.useEffect(() => {
          if (!sortedBuffs.length && ccExpanded) setCcExpanded(false);
        }, [sortedBuffs.length, ccExpanded]);

        const computeActionPopupPos = (anchorRect, popupWidth = 260, popupHeight = 124) => {
          const padding = 8;
          const gap = 12;
          const roomRight = window.innerWidth - anchorRect.right - padding;
          const roomLeft = anchorRect.left - padding;
          let left = roomRight >= popupWidth
            ? anchorRect.right + gap
            : anchorRect.left - popupWidth - gap;
          if (roomRight < popupWidth && roomLeft < popupWidth) {
            left = Math.max(padding, Math.min(anchorRect.left, window.innerWidth - popupWidth - padding));
          }
          let top = anchorRect.top + Math.max(0, (anchorRect.height - popupHeight) / 2);
          top = Math.max(padding, Math.min(top, window.innerHeight - popupHeight - padding));
          left = Math.max(padding, Math.min(left, window.innerWidth - popupWidth - padding));
          return { left, top };
        };
        React.useLayoutEffect(() => {
          if (!actionDetailPopup || !actionDetailPopupRef.current) return;
          const el = actionDetailPopupRef.current;
          const rect = el.getBoundingClientRect();
          const padding = 8;
          const maxLeft = Math.max(padding, window.innerWidth - rect.width - padding);
          const maxTop = Math.max(padding, window.innerHeight - rect.height - padding);
          const nextLeft = Math.max(padding, Math.min(actionDetailPopup.left, maxLeft));
          const nextTop = Math.max(padding, Math.min(actionDetailPopup.top, maxTop));
          if (nextLeft !== actionDetailPopup.left || nextTop !== actionDetailPopup.top) {
            setActionDetailPopup((prev) => (prev ? { ...prev, left: nextLeft, top: nextTop } : prev));
          }
        }, [actionDetailPopup]);
        React.useEffect(() => {
          if (!actionDetailPopup || !actionDetailPopupRef.current) return undefined;
          const onResize = () => {
            const el = actionDetailPopupRef.current;
            if (!el) return;
            const rect = el.getBoundingClientRect();
            const padding = 8;
            const maxLeft = Math.max(padding, window.innerWidth - rect.width - padding);
            const maxTop = Math.max(padding, window.innerHeight - rect.height - padding);
            const nextLeft = Math.max(padding, Math.min(actionDetailPopup.left, maxLeft));
            const nextTop = Math.max(padding, Math.min(actionDetailPopup.top, maxTop));
            if (nextLeft !== actionDetailPopup.left || nextTop !== actionDetailPopup.top) {
              setActionDetailPopup((prev) => (prev ? { ...prev, left: nextLeft, top: nextTop } : prev));
            }
          };
          window.addEventListener("resize", onResize);
          return () => window.removeEventListener("resize", onResize);
        }, [actionDetailPopup]);
        React.useLayoutEffect(() => {
          if (!ccDetailPopup || !ccDetailPopupRef.current) return;
          const el = ccDetailPopupRef.current;
          const rect = el.getBoundingClientRect();
          const padding = 8;
          const maxLeft = Math.max(padding, window.innerWidth - rect.width - padding);
          const maxTop = Math.max(padding, window.innerHeight - rect.height - padding);
          const nextLeft = Math.max(padding, Math.min(ccDetailPopup.left, maxLeft));
          const nextTop = Math.max(padding, Math.min(ccDetailPopup.top, maxTop));
          if (nextLeft !== ccDetailPopup.left || nextTop !== ccDetailPopup.top) {
            setCcDetailPopup((prev) => (prev ? { ...prev, left: nextLeft, top: nextTop } : prev));
          }
        }, [ccDetailPopup]);
        React.useEffect(() => {
          if (!ccDetailPopup || !ccDetailPopupRef.current) return undefined;
          const onResize = () => {
            const el = ccDetailPopupRef.current;
            if (!el) return;
            const rect = el.getBoundingClientRect();
            const padding = 8;
            const maxLeft = Math.max(padding, window.innerWidth - rect.width - padding);
            const maxTop = Math.max(padding, window.innerHeight - rect.height - padding);
            const nextLeft = Math.max(padding, Math.min(ccDetailPopup.left, maxLeft));
            const nextTop = Math.max(padding, Math.min(ccDetailPopup.top, maxTop));
            if (nextLeft !== ccDetailPopup.left || nextTop !== ccDetailPopup.top) {
              setCcDetailPopup((prev) => (prev ? { ...prev, left: nextLeft, top: nextTop } : prev));
            }
          };
          window.addEventListener("resize", onResize);
          return () => window.removeEventListener("resize", onResize);
        }, [ccDetailPopup]);
        const computeStakeholderPopupPos = (anchorRect, popupWidth = 260, popupHeight = 264) => {
          const padding = 8;
          const gap = 10;
          const roomRight = window.innerWidth - anchorRect.right - padding;
          const roomLeft = anchorRect.left - padding;
          let left = roomRight >= popupWidth
            ? anchorRect.right + gap
            : anchorRect.left - popupWidth - gap;
          if (roomRight < popupWidth && roomLeft < popupWidth) {
            left = Math.max(padding, Math.min(anchorRect.left, window.innerWidth - popupWidth - padding));
          }
          let top = anchorRect.top + Math.max(0, (anchorRect.height - popupHeight) / 2);
          top = Math.max(padding, Math.min(top, window.innerHeight - popupHeight - padding));
          left = Math.max(padding, Math.min(left, window.innerWidth - popupWidth - padding));
          return { left, top };
        };

        const isPointOverEmailDrop = (clientX, clientY) => {
          const el = emailDropRef.current;
          if (!el || !Number.isFinite(clientX) || !Number.isFinite(clientY)) return false;
          const rect = el.getBoundingClientRect();
          return (
            clientX >= rect.left &&
            clientX <= rect.right &&
            clientY >= rect.top &&
            clientY <= rect.bottom
          );
        };
        const isPointOverTargetDrop = (clientX, clientY) => {
          const el = targetDropRef.current;
          if (!el || !Number.isFinite(clientX) || !Number.isFinite(clientY)) return false;
          const rect = el.getBoundingClientRect();
          return (
            clientX >= rect.left &&
            clientX <= rect.right &&
            clientY >= rect.top &&
            clientY <= rect.bottom
          );
        };
        const getActiveTargetByLooseId = (targetId) => {
          if (targetId == null) return null;
          const idStr = String(targetId);
          return (
            opponents.find((opp) => String(opp.id) === idStr && (opp.hp || 0) > 0) ||
            null
          );
        };
        const resolvePointerTargetId = (clientX, clientY) => {
          if (!Number.isFinite(clientX) || !Number.isFinite(clientY)) return null;
          const node = document.elementFromPoint(clientX, clientY);
          if (!node || typeof node.closest !== "function") return null;
          const pill = node.closest("[data-target-id]");
          if (pill) {
            const targetId = pill.getAttribute("data-target-id");
            const activeTarget = getActiveTargetByLooseId(targetId);
            if (activeTarget) return activeTarget.id;
          }
          const entry = node.closest("[data-entry-target-id]");
          if (entry) {
            const targetId = entry.getAttribute("data-entry-target-id");
            const activeTarget = getActiveTargetByLooseId(targetId);
            if (activeTarget) return activeTarget.id;
          }
          return null;
        };

        React.useEffect(() => {
          const onPointerMove = (evt) => {
            const drag = dragRef.current;
            if (!drag) return;
            const dx = (evt.clientX || 0) - drag.startX;
            const dy = (evt.clientY || 0) - drag.startY;
            const dist = Math.hypot(dx, dy);
            if (!drag.active && dist > 6) {
              drag.active = true;
              setCardDragViewportLock(true);
              if (drag.kind === "action") {
                setDragActionId(drag.actionId);
              } else if (drag.kind === "drawer") {
                setDragDrawerPayload(drag.payload);
              }
              setActionDetailPopup(null);
              setStakeholderPopup(null);
              setCcDetailPopup(null);
            }
            if (drag.active) {
              const overEmail = isPointOverEmailDrop(evt.clientX, evt.clientY);
              const overTarget = isPointOverTargetDrop(evt.clientX, evt.clientY);
              setDragPointer({ x: evt.clientX || 0, y: evt.clientY || 0 });
              setIsOverEmailDrop(overEmail);
              setIsOverTargetDrop(overTarget);
              if (drag.kind === "action" && drag.actionId === "ATTACK") {
                const hoveredTargetId = resolvePointerTargetId(evt.clientX, evt.clientY);
                if (
                  hoveredTargetId != null &&
                  String(hoveredTargetId) !== String(props.state.targetId)
                ) {
                  props.onSelectTarget(hoveredTargetId);
                }
              }
            }
          };
          const onPointerUp = (evt) => {
            const drag = dragRef.current;
            if (!drag) return;
            const overEmail = isPointOverEmailDrop(evt.clientX, evt.clientY);
            const overTarget = isPointOverTargetDrop(evt.clientX, evt.clientY);
            const isReplyToAction = drag.kind === "action" && drag.actionId === "ATTACK";
            const shouldCast =
              drag.active &&
              ((isReplyToAction && (overEmail || overTarget)) || (!isReplyToAction && overEmail)) &&
              (drag.kind === "drawer" || !props.disabledActions?.[drag.actionId]);
            if (shouldCast) {
              if (drag.kind === "action") {
                if (drag.actionId === "ADDRESS_BOOK") {
                  setAddressDrawerOpen(true);
                  setAddressDrawerAddsUsed(0);
                } else if (drag.actionId === "CLOSE_ADDRESS_BOOK") {
                  closeAddressDrawer(true);
                } else {
                  props.onAction(drag.actionId);
                }
              } else if (drag.kind === "drawer") {
                useDrawerPayload(drag.payload);
              }
            }
            if (!drag.active) {
              if (drag.kind === "action") props.onActionHover(drag.actionId);
            } else {
              props.onActionHover(null);
            }
            setDragActionId(null);
            setDragDrawerPayload(null);
            setIsOverEmailDrop(false);
            setIsOverTargetDrop(false);
            setDragPointer({ x: 0, y: 0 });
            setCardDragViewportLock(false);
            dragRef.current = null;
          };
          window.addEventListener("pointermove", onPointerMove);
          window.addEventListener("pointerup", onPointerUp);
          window.addEventListener("pointercancel", onPointerUp);
          return () => {
            window.removeEventListener("pointermove", onPointerMove);
            window.removeEventListener("pointerup", onPointerUp);
            window.removeEventListener("pointercancel", onPointerUp);
            setCardDragViewportLock(false);
          };
        }, [props, maxAddressAdds]);
        React.useEffect(() => {
          if ((!actionDetailPopup && !ccDetailPopup) || activeDrag) return undefined;
          const onPointerDown = (evt) => {
            const node = evt?.target;
            if (!node || typeof node.closest !== "function") return;
            if (node.closest(".game-action-detail-popup")) return;
            if (node.closest(".game-cc-detail-popup")) return;
            if (node.closest(".game-action-card")) return;
            if (node.closest(".cc-pill")) return;
            setActionDetailPopup(null);
            setCcDetailPopup(null);
          };
          window.addEventListener("pointerdown", onPointerDown, true);
          return () => {
            window.removeEventListener("pointerdown", onPointerDown, true);
          };
        }, [actionDetailPopup, ccDetailPopup, activeDrag]);

        const useDrawerPayload = (payload) => {
          if (!payload) return false;
          if (payload.unavailable) return false;
          let ok = false;
          if (payload.itemType === "contact") {
            ok = !!props.onUseAddressContact?.(payload.item?.id);
          } else if (payload.itemType === "bcc") {
            ok = !!props.onUseAddressBcc?.(payload.bccIndex);
          }
          if (ok) {
            setAddressDrawerAddsUsed((prev) => {
              const next = prev + 1;
              if (next >= maxAddressAdds) {
                setAddressDrawerOpen(false);
                window.setTimeout(() => {
                  props.onAddressDrawerEndTurn?.();
                }, 0);
                return 0;
              }
              return next;
            });
          }
          return ok;
        };

        const onActionCardPointerDown = (actionId, evt) => {
          if (props.disabledActions?.[actionId] && actionId !== "ULT") return;
          dragRef.current = {
            kind: "action",
            actionId,
            startX: evt.clientX || 0,
            startY: evt.clientY || 0,
            active: false,
          };
          setDragPointer({ x: evt.clientX || 0, y: evt.clientY || 0 });
          setActionDetailPopup(null);
          props.onActionHover(actionId);
        };
        const onDrawerCardPointerDown = (payload, evt) => {
          dragRef.current = {
            kind: "drawer",
            payload,
            startX: evt.clientX || 0,
            startY: evt.clientY || 0,
            active: false,
          };
          setDragPointer({ x: evt.clientX || 0, y: evt.clientY || 0 });
          setActionDetailPopup(null);
          setStakeholderPopup(null);
        };
        const onDrawerCardClick = (card, evt) => {
          const rect = evt?.currentTarget?.getBoundingClientRect?.();
          if (!rect || !card) return;
          if (actionDetailPopup?.kind === "drawer" && actionDetailPopup?.id === card.id) {
            setActionDetailPopup(null);
            return;
          }
          setActionDetailPopup({
            kind: "drawer",
            id: card.id,
            itemType: card.itemType,
            item: card.item,
            bccIndex: card.bccIndex,
            unavailable: !!card.unavailable,
            unavailableReason: card.unavailableReason || "",
            waitText: card.waitText || "",
            blockedByStakeholder: card.blockedByStakeholder || null,
            ...computeActionPopupPos(rect),
          });
        };

        const onActionCardClick = (actionId, evt) => {
          if (props.disabledActions?.[actionId] && actionId !== "ULT") return;
          if (actionId === "ADDRESS_BOOK") {
            setAddressDrawerOpen(true);
            setAddressDrawerAddsUsed(0);
            return;
          }
          if (actionId === "CLOSE_ADDRESS_BOOK") {
            closeAddressDrawer(true);
            return;
          }
          const rect = evt?.currentTarget?.getBoundingClientRect?.();
          if (!rect) return;
          if (actionDetailPopup?.kind === "action" && actionDetailPopup?.id === actionId) {
            setActionDetailPopup(null);
            return;
          }
          setActionDetailPopup({
            kind: "action",
            id: actionId,
            ...computeActionPopupPos(rect),
          });
          props.onActionHover(actionId);
        };
        const onActionDetailUse = () => {
          if (!actionDetailPopup) return;
          if (actionDetailPopup.kind === "drawer") {
            if (actionDetailPopup.unavailable) return;
            const ok = useDrawerPayload(actionDetailPopup);
            if (ok) setActionDetailPopup(null);
            return;
          }
          if (props.disabledActions?.[actionDetailPopup.id]) return;
          props.onAction(actionDetailPopup.id);
          setActionDetailPopup(null);
        };
        const openStakeholderPopup = (targetId, anchorEl) => {
          const rect = anchorEl?.getBoundingClientRect?.();
          if (!rect) return;
          if (stakeholderPopup && String(stakeholderPopup.targetId) === String(targetId)) {
            setStakeholderPopup(null);
            return;
          }
          setStakeholderPopup({
            targetId,
            ...computeStakeholderPopupPos(rect),
          });
        };
        const onStakeholderClick = (opp, isOut, evt) => {
          if (!opp || isOut) return;
          if (selectedTarget && String(selectedTarget.id) === String(opp.id)) {
            openStakeholderPopup(opp.id, evt.currentTarget);
            return;
          }
          setStakeholderPopup(null);
          props.onSelectTarget(opp.id);
        };
        const onEntryTargetClick = (entryTargetId, evt) => {
          if (entryTargetId == null) return;
          if (selectedTarget && String(selectedTarget.id) === String(entryTargetId)) {
            openStakeholderPopup(entryTargetId, evt.currentTarget);
            return;
          }
          setStakeholderPopup(null);
          props.onSelectTarget(entryTargetId);
        };
        const closeAddressDrawer = (manual = false) => {
          if (
            manual &&
            addressDrawerAddsUsed > 0 &&
            addressDrawerAddsUsed < maxAddressAdds
          ) {
            window.setTimeout(() => {
              props.onAddressDrawerEndTurn?.();
            }, 0);
          }
          setAddressDrawerOpen(false);
          setAddressDrawerAddsUsed(0);
        };
        const popupTarget = stakeholderPopup
          ? opponents.find((opp) => String(opp.id) === String(stakeholderPopup.targetId)) || null
          : null;
        return e(
          "div",
          {
            className:
              "fixed top-0 bottom-0 left-0 right-0 z-[95] flex flex-col w-[calc(100%-1rem)] h-[calc(100%-9rem)] max-w-5xl bg-[#c0c0c0] retro-border overflow-hidden mx-auto my-2",
            style: { minHeight: "calc(var(--fg-viewport-h) - 9rem)" },
          },
          e(
            "div",
            { className: "window-titlebar text-white p-1 flex justify-between items-center shrink-0" },
            e(
              "div",
              { className: "flex items-center gap-2 px-1 min-w-0" },
              e(
                "span",
                { className: "text-xs font-bold truncate min-w-0" },
                ReplyAllEngine.play.getMissionHeaderSubject(mission),
              ),
            ),
            e(
              "div",
              { className: "flex gap-1 pr-1 flex-shrink-0" },
              e("button", { className: "w-4 h-4 bg-[#c0c0c0] border border-white text-black text-[10px] flex items-center justify-center" }, "_"),
              e("button", { className: "w-4 h-4 bg-[#c0c0c0] border border-white text-black text-[10px] flex items-center justify-center" }, "X"),
            ),
          ),
          e(
            "div",
            { className: "flex gap-4 px-2 py-0.5 border-b border-gray-500 text-[11px] shrink-0" },
            e(
              "button",
              {
                className: "cursor-default hover:bg-[#000080] hover:text-white px-1 text-left",
                onClick: props.onBackToInbox,
              },
              "Inbox",
            ),
            e(
              "button",
              {
                className: "cursor-default hover:bg-[#000080] hover:text-white px-1 text-left",
                onClick: props.onOpenSettings,
              },
              "Settings",
            ),
          ),
          e(
            "div",
            { className: "flex flex-grow overflow-hidden relative" },
            e(
              "div",
              { className: "hidden md:flex w-48 bg-[#dfdfdf] border-r border-[#808080] flex-col shrink-0" },
              e("div", { className: "p-2 text-[10px] font-bold border-b border-[#808080]" }, "Folders"),
              e(
                "div",
                { className: "p-2 space-y-1 text-[11px]" },
                e("div", { className: "bg-blue-800 text-white px-1" }, "Inbox (1)"),
                e("div", { className: "px-1 text-gray-500" }, "Promotions (3)"),
                e("div", { className: "px-1" }, "Sent Items"),
                e("div", { className: "px-1" }, "Deleted"),
              ),
            ),
            e(
              "div",
              { className: "flex-grow flex flex-col bg-white overflow-hidden" },
              e(
                "div",
                { className: "p-2 bg-[#f0f0f0] border-b border-[#808080] text-[10px] shrink-0 space-y-1" },
                e(
                  "div",
                  { className: "flex items-center gap-2 relative" },
                  e("span", { className: "font-bold w-4 text-right" }, "To:"),
                  e(
                    "div",
                    {
                      ref: targetDropRef,
                      className: `contacts-container flex gap-1 overflow-x-auto no-scrollbar py-0.5 ${
                        isReplyDrag ? "reply-target-pulse" : ""
                      }`,
                    },
                    opponents.map((opp) => {
                      const oppMaxHp = Math.max(1, opp.maxHp || opp.hp || 1);
                      const pct = Math.max(0, Math.min(100, ((opp.hp || 0) / oppMaxHp) * 100));
                      const hp = Math.max(0, Math.ceil(opp.hp || 0));
                      const isSelected = selectedTarget && selectedTarget.id === opp.id;
                      const isOut = (opp.hp || 0) <= 0;
                      const hue = (pct / 100) * 120;
                      const fill = `hsl(${hue} 70% 75%)`;
                      const empty = "#f3f4f6";
                      return e(
                        "div",
                        {
                          key: `target-${opp.id}`,
                          "data-target-id": String(opp.id),
                          onClick: (evt) => onStakeholderClick(opp, isOut, evt),
                          className: `stakeholder-pill ${isSelected ? "active" : ""} ${
                            isReplyDrag && !isOut ? "reply-target-pulse" : ""
                          }`,
                          style: {
                            background: isOut
                              ? "#e5e7eb"
                              : `linear-gradient(90deg, ${fill} 0%, ${fill} ${pct}%, ${empty} ${pct}%, ${empty} 100%)`,
                          },
                          title: `${hp}/${oppMaxHp}`,
                        },
                        e("span", { className: "pill-text" }, opp.name),
                        e("span", { className: "pill-hp" }, `${hp}`),
                      );
                    }),
                  ),
                  activeDrag && activeDrag.kind === "action" && activeDrag.actionId === "ATTACK"
                    ? e(
                        "div",
                        {
                          className: `game-action-drop-overlay reply-target-invisible ${isOverTargetDrop ? "is-over" : ""}`,
                          style: { inset: "0 0 0 1.5rem", padding: 0 },
                        },
                        e("div", { className: "overlay-shell" }, "\u00a0"),
                      )
                    : null,
                ),
                e(
                  "div",
                  { className: `flex gap-2 ${ccExpanded ? "items-start" : "items-center"}` },
                  e("span", { className: "font-bold w-4 text-right" }, "CC:"),
                  !sortedBuffs.length
                    ? e("div", { className: "flex gap-1 text-gray-400 italic" }, "No one in loop.")
                    : e(
                        "div",
                        { className: "flex items-center gap-1 text-gray-600" },
                        e(
                          "div",
                          {
                            ref: ccContainerRef,
                            className: `cc-contacts-container ${ccExpanded ? "expanded" : ""}`,
                          },
                          sortedBuffs.map((b, idx) => {
                            const subtitle = b.subtitle ? ` • ${b.subtitle}` : "";
                            return e(
                              "button",
                              {
                                key: `buff-${idx}-${b?.id || "x"}`,
                                className: "cc-pill",
                                type: "button",
                                onClick: (evt) => {
                                  evt.stopPropagation();
                                  const anchorRect = evt.currentTarget?.getBoundingClientRect?.();
                                  if (!anchorRect) return;
                                  const pos = computeActionPopupPos(anchorRect, 260, 164);
                                  setActionDetailPopup(null);
                                  setStakeholderPopup(null);
                                  setCcDetailPopup({
                                    buff: b,
                                    left: pos.left,
                                    top: pos.top,
                                  });
                                },
                              },
                              e("span", { className: "pill-text" }, `${b.name || b.id || "CC"}${subtitle} (by ${b.usedBy || "Unknown"})`),
                            );
                          }),
                        ),
                        ccWrapCount > 0 || ccExpanded
                          ? e(
                              "span",
                              {
                                className: "contacts-more text-[9px]",
                                onClick: () => setCcExpanded((prev) => !prev),
                              },
                              ccExpanded ? "Show less" : `+ ${ccWrapCount} more`,
                            )
                          : null,
                      ),
                ),
                e(
                  "div",
                  { className: "flex items-center gap-2" },
                  e("span", { className: "font-bold w-4 text-right" }, "Sub:"),
                  e(
                    "div",
                    { className: "truncate text-gray-700" },
                    ReplyAllEngine.play.getMissionSubSubject(mission),
                  ),
                ),
              ),
              e(
                "div",
                { className: "flex-grow overflow-hidden relative" },
                e(
                  "div",
                  {
                    ref: emailDropRef,
                    className: "h-full overflow-y-auto p-3 space-y-6 bg-white font-sans text-sm",
                  },
                  aiPreviewRows.length
                    ? e(
                        "div",
                        {
                          className:
                            "message-entry p-2 border-2 border-gray-100 bg-gray-50 text-[11px] italic text-gray-600",
                        },
                        aiPreviewRows.map((row) =>
                          e(
                            "div",
                            { key: `ai-preview-${row.id}` },
                            e("strong", null, row.name),
                            ` is ${row.text}`,
                          ),
                        ),
                      )
                    : null,
                  props.state.previousRoundSummary
                    ? e(
                        "div",
                        {
                          className:
                            "message-entry p-2 border border-gray-300 bg-[#f8f8e8] text-[10px] leading-snug text-gray-800 whitespace-pre-wrap",
                        },
                        e(
                          "div",
                          { className: "uppercase tracking-wide text-[9px] text-gray-600 mb-1" },
                          `${formatTurnTime(Math.max(0, (props.state.turn || 0) - 1))} Thread Summary`,
                        ),
                        e("div", null, props.state.previousRoundSummary),
                      )
                    : null,
                  (props.state.messageLogEntries || []).map((entry, idx) =>
                    (() => {
                      const entryTargetId = resolveEntryTargetId(entry);
                      return e(
                        "div",
                        {
                          key: `log-${idx}-${entry.time || ""}`,
                          "data-entry-target-id": entryTargetId != null ? String(entryTargetId) : undefined,
                          className: `message-entry p-0 border-2 border-gray-100 bg-white shadow-sm ${entry.classes || ""} ${
                            entryTargetId ? "cursor-pointer hover:border-[#000080]" : ""
                          } ${isReplyDrag && entryTargetId ? "reply-target-pulse" : ""}`,
                          onClick: entryTargetId ? (evt) => onEntryTargetClick(entryTargetId, evt) : undefined,
                        },
                        e(
                          "div",
                          { className: "email-header p-2" },
                          e(
                            "div",
                            { className: "flex flex-wrap gap-x-3 gap-y-1" },
                            e("div", null, e("strong", null, "From:"), ` ${entry.from}`),
                            e("div", null, e("strong", null, "To:"), ` ${entry.to}`),
                            e("div", null, e("strong", null, "Sent:"), ` Today, ${entry.time || formatTurnTime(props.state.turn || 0)}`),
                          ),
                        ),
                        e("div", {
                          className: "email-body px-3 py-2 font-serif",
                          dangerouslySetInnerHTML: { __html: entry.body || "" },
                        }),
                      );
                    })(),
                  ),
                ),
                activeDrag
                  ? e(
                      "div",
                      {
                        className: `game-action-drop-overlay ${
                          activeDrag.kind === "action" && activeDrag.actionId === "ATTACK"
                            ? "reply-target-invisible"
                            : ""
                        } ${isOverEmailDrop ? "is-over" : ""}`,
                      },
                      e(
                        "div",
                        { className: "overlay-shell" },
                        activeDrag.kind === "action" && activeDrag.actionId === "ATTACK"
                          ? "\u00a0"
                          : (isOverEmailDrop
                              ? getDragOverlayText(activeDrag, true)
                              : getDragOverlayText(activeDrag, false)),
                      ),
                    )
                  : null,
              ),
              e(
                "div",
                { className: "bg-[#dfdfdf] border-t border-[#808080] flex flex-col gap-1 shrink-0" },
                e(
                  "div",
                  {
                    className: "h-5 w-full border border-[#808080] relative bg-[#e5e7eb] px-2",
                    style: {
                      background: `linear-gradient(90deg, hsl(${(hpPct / 100) * 120} 70% 75%) 0%, hsl(${(hpPct / 100) * 120} 70% 75%) ${hpPct}%, #f3f4f6 ${hpPct}%, #f3f4f6 100%)`,
                    },
                  },
                  e(
                    "div",
                    { className: "flex items-center justify-between text-[9px] font-bold uppercase text-[#000080] h-full" },
                    e("span", null, "Credibility"),
                    e("span", { className: "font-mono" }, `${Math.ceil(player.hp || 0)}/${maxHp}`),
                  ),
                ),
              ),
              e(
                "div",
                { className: "p-2 bg-[#c0c0c0] border-t-1 border-white shrink-0" },
                e(
                  "div",
                  { className: "bg-[#c0c0c0] border border-[#808080] px-1.5 flex gap-px text-[10px] h-7 items-center mb-2" },
                  e(
                    "div",
                    { className: "retro-border-inset px-2.5 flex items-center flex-grow h-5 bg-gray-100 truncate overflow-hidden" },
                    props.statusText || "Ready.",
                  ),
                  e(
                    "div",
                    { className: "retro-border-inset px-2.5 flex items-center w-[90px] h-5 bg-gray-100 justify-center flex-shrink-0" },
                    ReplyAllEngine.play.formatTurnTime(props.state.turn || 0),
                  ),
                ),
                e("div", { className: "text-[10px] text-center text-gray-700 italic pt-1" }, "Use action cards below and drag into email view."),
              ),
            ),
          ),
          e(
            "div",
            { className: "game-action-dock" },
            e(
              "div",
              { className: "bg-[#c0c0c0] retro-border p-2" },
              e(
                "div",
                {
                  ref: actionDockRef,
                  className: "adaptive-card-track bg-white retro-border-inset p-2",
                  style: actionDockTrack.trackStyle,
                },
                displayedActionCards.map((card, idx) => {
                  const isActionCard = card.kind !== "drawer";
                  const isDisabled = isActionCard ? !!props.disabledActions[card.id] : !!card.unavailable;
                  const isDragging = dragActionId === card.id || dragDrawerPayload?.id === card.id;
                  const isUlt = card.id === "ULT";
                  const isContact = card.itemType === "contact";
                  const isBcc = card.itemType === "bcc";
                  const headerStyle = !isActionCard && isDisabled
                    ? { background: "#9ca3af", color: "#1f2937" }
                    : isContact
                    ? { background: contactMeta.headerBg, color: contactMeta.headerText }
                    : isBcc
                      ? { background: bccMeta.headerBg, color: bccMeta.headerText }
                      : (isDisabled ? { background: "#9ca3af", color: "#1f2937" } : { background: "#000080", color: "#ffffff" });
                  const frameStyle = !isActionCard && isDisabled
                    ? { background: "#d1d5db", color: "#4b5563" }
                    : isContact
                    ? { background: contactMeta.paneBg, color: contactMeta.paneText }
                    : isBcc
                      ? { background: bccMeta.paneBg, color: bccMeta.paneText }
                      : (isDisabled ? { background: "#d1d5db", color: "#4b5563" } : { background: "#e5e7eb", color: "#111827" });
                  return e(
                    ItemCard,
                    {
                      key: card.id,
                      extraClassName: `game-action-card ${isDisabled ? "is-disabled" : ""} ${isDragging ? "is-dragging" : ""}`,
                      style: actionDockTrack.getCardStyle(idx),
                      headerText: isContact ? contactMeta.label : isBcc ? bccMeta.label : "Action",
                      headerStyle,
                      frameStyle,
                      onClick: (evt) => {
                        if (isActionCard) onActionCardClick(card.id, evt);
                        else onDrawerCardClick(card, evt);
                      },
                      onPointerDown: (evt) => {
                        if (isActionCard) {
                          onActionCardPointerDown(card.id, evt);
                        } else {
                          onDrawerCardPointerDown(
                            {
                              id: card.id,
                              kind: "drawer",
                              itemType: card.itemType,
                              item: card.item,
                              bccIndex: card.bccIndex,
                              unavailable: !!card.unavailable,
                              unavailableReason: card.unavailableReason || "",
                              waitText: card.waitText || "",
                              blockedByStakeholder: card.blockedByStakeholder || null,
                            },
                            evt,
                          );
                        }
                      },
                    },
                    isUlt
                      ? e(
                          "div",
                          { className: "w-full flex flex-col items-center gap-1" },
                          e("div", { className: "shop-card-name text-red-800" }, card.label),
                          e(
                            "div",
                            { className: "momentum-meter w-full" },
                            Array.from({ length: 8 }).map((_, i) =>
                              e("div", {
                                key: `ult-dock-${i}`,
                                className: `momentum-segment ${i < Math.floor(player.ult || 0) ? "charged" : ""}`,
                              }),
                            ),
                          ),
                        )
                      : e(
                          "div",
                          { className: "w-full flex flex-col" },
                          e("div", { className: "shop-card-name" }, card.label),
                          card.unavailable
                            ? e(
                                "div",
                                { className: "text-[9px] leading-tight text-gray-600 mt-1 whitespace-normal" },
                                card.unavailableReason || "Unavailable",
                              )
                            : null,
                        ),
                  );
                }),
              ),
            ),
          ),
          dragAction
            ? e(
                "div",
                {
                  className: "game-action-drag-proxy",
                  style: { left: `${dragPointer.x}px`, top: `${dragPointer.y}px` },
                },
                e(
                  ItemCard,
                  {
                    headerText: "Action",
                    headerStyle: { background: "#000080", color: "#ffffff" },
                    frameStyle: { background: "#e5e7eb", color: "#111827" },
                  },
                  dragAction.id === "ULT"
                    ? e(
                        "div",
                        { className: "w-full flex flex-col items-center gap-1" },
                        e("div", { className: "shop-card-name text-red-800" }, dragAction.label),
                        e(
                          "div",
                          { className: "momentum-meter w-full" },
                          Array.from({ length: 8 }).map((_, i) =>
                            e("div", {
                              key: `ult-drag-${i}`,
                              className: `momentum-segment ${i < Math.floor(player.ult || 0) ? "charged" : ""}`,
                            }),
                          ),
                        ),
                      )
                    : e("div", { className: "shop-card-name" }, dragAction.label),
                ),
              )
            : null,
          !dragAction && dragDrawerPayload
            ? e(
                "div",
                {
                  className: "game-action-drag-proxy",
                  style: { left: `${dragPointer.x}px`, top: `${dragPointer.y}px` },
                },
                e(
                  ItemCard,
                  {
                    headerText:
                      dragDrawerPayload.itemType === "bcc" ? bccMeta.label : contactMeta.label,
                    headerStyle:
                      dragDrawerPayload.unavailable
                        ? { background: "#9ca3af", color: "#1f2937" }
                        : dragDrawerPayload.itemType === "bcc"
                        ? { background: bccMeta.headerBg, color: bccMeta.headerText }
                        : { background: contactMeta.headerBg, color: contactMeta.headerText },
                    frameStyle:
                      dragDrawerPayload.unavailable
                        ? { background: "#d1d5db", color: "#4b5563" }
                        : dragDrawerPayload.itemType === "bcc"
                        ? { background: bccMeta.paneBg, color: bccMeta.paneText }
                        : { background: contactMeta.paneBg, color: contactMeta.paneText },
                  },
                  e("div", { className: "shop-card-name" }, dragDrawerPayload.item?.name || "Item"),
                ),
              )
            : null,
          activeDrag && dragDetailPos
            ? e(
                "div",
                {
                  className: "game-action-drag-popup shop-item-overlay-frame retro-border p-3",
                  style: { left: `${dragDetailPos.left}px`, top: `${dragDetailPos.top}px` },
                },
                e(
                  "div",
                  { className: "text-[10px] font-bold uppercase text-[#000080] mb-1" },
                  dragDetailTitle,
                ),
                e(
                  "div",
                  { className: "text-[11px] leading-snug text-gray-800 whitespace-pre-wrap" },
                  dragDetailText,
                ),
              )
            : null,
          actionDetailPopup && !activeDrag
            ? e(
                "div",
                {
                  ref: actionDetailPopupRef,
                  className: "game-action-detail-popup shop-item-overlay-frame retro-border p-3",
                  style: {
                    left: `${actionDetailPopup.left}px`,
                    top: `${actionDetailPopup.top}px`,
                  },
                },
                e(
                  "div",
                  { className: "text-[10px] font-bold uppercase text-[#000080] mb-1" },
                  actionDetailPopup.kind === "drawer"
                    ? (actionDetailPopup.itemType === "bcc" ? bccMeta.label : contactMeta.label)
                    : (actionLabelById[actionDetailPopup.id] || actionDetailPopup.id),
                ),
                e(
                  "div",
                  { className: "text-[11px] leading-snug text-gray-800 whitespace-pre-wrap" },
                  actionDetailPopup.kind === "drawer"
                    ? getDrawerDetailText(actionDetailPopup)
                    : getActionDetailText(actionDetailPopup.id),
                ),
                e(
                  "div",
                  { className: "flex gap-2 mt-3" },
                  (() => {
                    const useDisabled =
                      (actionDetailPopup.kind === "action" &&
                        !!props.disabledActions?.[actionDetailPopup.id]) ||
                      (actionDetailPopup.kind === "drawer" && !!actionDetailPopup.unavailable);
                    return e(
                      "button",
                      {
                        className: `flex-1 retro-button text-[10px] font-bold py-1 uppercase ${
                          useDisabled ? "opacity-50 cursor-not-allowed" : ""
                        }`,
                        disabled: useDisabled,
                        onClick: onActionDetailUse,
                      },
                      "Use",
                    );
                  })(),
                  e(
                    "button",
                    {
                      className: "retro-button text-[10px] font-bold py-1 px-2 uppercase",
                      onClick: () => setActionDetailPopup(null),
                    },
                    "X",
                  ),
                ),
              )
            : null,
          ccDetailPopup && !activeDrag
            ? e(
                "div",
                {
                  ref: ccDetailPopupRef,
                  className: "game-cc-detail-popup shop-item-overlay-frame retro-border p-3",
                  style: {
                    left: `${ccDetailPopup.left}px`,
                    top: `${ccDetailPopup.top}px`,
                  },
                },
                e(
                  "div",
                  { className: "text-[10px] font-bold uppercase text-[#000080] mb-1" },
                  "CC Profile",
                ),
                e(
                  "div",
                  { className: "text-[11px] font-bold text-gray-900 mb-1" },
                  ccDetailPopup.buff?.name || "Contact",
                ),
                e(
                  "div",
                  { className: "text-[11px] leading-snug text-gray-800 whitespace-pre-wrap" },
                  getCcDetailText(ccDetailPopup.buff),
                ),
                e(
                  "div",
                  { className: "flex justify-end mt-3" },
                  e(
                    "button",
                    {
                      className: "retro-button text-[10px] font-bold py-1 px-2 uppercase",
                      onClick: () => setCcDetailPopup(null),
                    },
                    "X",
                  ),
                ),
              )
            : null,
          popupTarget && stakeholderPopup
            ? (() => {
                const targetStatCtx = statCtx;
                const hp = Math.max(0, Math.ceil(popupTarget.hp || 0));
                const targetMaxHp = targetStatCtx
                  ? Math.max(1, Math.ceil(ReplyAllEngine.stats.getUnitMaxHp(targetStatCtx, popupTarget)))
                  : Math.max(1, Math.ceil(popupTarget.maxHp || popupTarget.hp || 1));
                const hpPctTarget = Math.max(0, Math.min(100, (hp / targetMaxHp) * 100));
                const replyTo = targetStatCtx
                  ? Math.floor(ReplyAllEngine.stats.getUnitDamage(targetStatCtx, popupTarget, "single"))
                  : Math.floor(popupTarget.singleDmg || 0);
                const escalate = targetStatCtx
                  ? Math.floor(ReplyAllEngine.stats.getUnitDamage(targetStatCtx, popupTarget, "escalate"))
                  : Math.floor(popupTarget.escalateDmg || 0);
                const replyAll = targetStatCtx
                  ? Math.floor(ReplyAllEngine.stats.getUnitDamage(targetStatCtx, popupTarget, "replyAll"))
                  : 0;
                const deflect = targetStatCtx
                  ? Math.floor(ReplyAllEngine.stats.getUnitDeflectReduce(targetStatCtx, popupTarget))
                  : Math.floor(popupTarget.deflect || 0);
                const retaliate = targetStatCtx
                  ? Math.floor(ReplyAllEngine.stats.getUnitDeflectReflect(targetStatCtx, popupTarget))
                  : Math.floor(popupTarget.retaliation || 0);
                const promoteHeal = targetStatCtx
                  ? Math.floor(ReplyAllEngine.stats.getUnitSelfPromoteHeal(targetStatCtx, popupTarget, 15))
                  : Math.floor(popupTarget.selfPromoteHeal || 15);
                const defense = targetStatCtx
                  ? Math.floor(ReplyAllEngine.stats.getUnitFlatDef(targetStatCtx, popupTarget))
                  : Math.floor(popupTarget.defFlat || 0);
                const deptName = ReplyAllEngine.core.getDepartmentName(popupTarget.departmentId) || "Department N/A";
                const titleName = popupTarget.title?.name || popupTarget.title || popupTarget.role || "Stakeholder";
                return e(
                  "div",
                  {
                    className: "fixed z-[160] w-[260px] shop-item-overlay-frame retro-border p-3 bg-[#e0e0e0]",
                    style: {
                      left: `${stakeholderPopup.left}px`,
                      top: `${stakeholderPopup.top}px`,
                    },
                  },
                  e(
                    "div",
                    { className: "flex justify-between items-start font-bold text-[11px] gap-2 border-b border-[#808080] pb-2 mb-2" },
                    e(
                      "div",
                      { className: "truncate flex flex-col min-w-0" },
                      e(
                        "span",
                        { className: "truncate text-[#000080] text-sm leading-none mb-1 flex items-baseline gap-1 min-w-0" },
                        e("span", { className: "truncate" }, popupTarget.name || ""),
                        popupTarget.email
                          ? e("span", { className: "text-[9px] text-gray-500 truncate max-w-[140px]" }, `(${popupTarget.email})`)
                          : null,
                      ),
                      e("span", { className: "text-[9px] text-[#404040] opacity-70 uppercase" }, titleName),
                      e("span", { className: "text-[9px] text-[#404040] opacity-70 uppercase" }, deptName),
                    ),
                    e(
                      "button",
                      {
                        className: "px-2 retro-button text-[10px] font-bold text-red-700",
                        onClick: () => setStakeholderPopup(null),
                      },
                      "x",
                    ),
                  ),
                  e(
                    "div",
                    { className: "mb-2" },
                    e(
                      "div",
                      { className: "flex justify-between text-[10px] font-bold mb-1 uppercase text-[#404040]" },
                      e("span", null, "Credibility"),
                      e("span", null, `${hp}/${targetMaxHp}`),
                    ),
                    e(
                      "div",
                      { className: "h-3 bg-[#808080] border border-white shadow-[inset_1px_1px_1px_black]" },
                      e("div", {
                        className: "h-full bg-[#00ff00] border-r-2 border-[#008000]",
                        style: { width: `${hpPctTarget}%` },
                      }),
                    ),
                  ),
                  e(
                    "div",
                    { className: "grid grid-cols-2 gap-2 text-[10px]" },
                    e("div", { className: "bg-white retro-border-inset p-2" }, e("div", { className: "text-[9px] text-gray-500 font-bold uppercase" }, "Reply To"), e("div", { className: "font-mono font-bold" }, `${replyTo}`)),
                    e("div", { className: "bg-white retro-border-inset p-2" }, e("div", { className: "text-[9px] text-gray-500 font-bold uppercase" }, "Escalate"), e("div", { className: "font-mono font-bold" }, `${escalate}`)),
                    e("div", { className: "bg-white retro-border-inset p-2" }, e("div", { className: "text-[9px] text-gray-500 font-bold uppercase" }, "Reply All"), e("div", { className: "font-mono font-bold" }, `${replyAll}`)),
                    e("div", { className: "bg-white retro-border-inset p-2" }, e("div", { className: "text-[9px] text-gray-500 font-bold uppercase" }, "Deflect"), e("div", { className: "font-mono font-bold" }, `${deflect} / ${retaliate}`)),
                    e("div", { className: "bg-white retro-border-inset p-2" }, e("div", { className: "text-[9px] text-gray-500 font-bold uppercase" }, "Self-Promote"), e("div", { className: "font-mono font-bold" }, `${promoteHeal} / ${Math.max(0, popupTarget.wins || 0)}`)),
                    e("div", { className: "bg-white retro-border-inset p-2" }, e("div", { className: "text-[9px] text-gray-500 font-bold uppercase" }, "Defense"), e("div", { className: "font-mono font-bold" }, `${defense}`)),
                  ),
                );
              })()
            : null,
          props.ccPickerOpen
            ? e(
                "div",
                {
                  className: "fixed inset-0 z-[120] bg-black/50 flex items-center justify-center p-4",
                  onClick: props.onCloseCcPicker,
                },
                e(
                  "div",
                  {
                    className: "bg-[#c0c0c0] retro-border max-w-sm w-full p-3",
                    onClick: (evt) => evt.stopPropagation(),
                  },
                  e("div", { className: "text-xs font-bold mb-2 uppercase" }, "Select Contact"),
                  e(
                    "div",
                    { className: "max-h-56 overflow-y-auto space-y-1 mb-3" },
                    props.availableCcContacts.length
                      ? props.availableCcContacts.map((contact) =>
                          e(
                            "button",
                            {
                              key: contact.id,
                              className:
                                "w-full text-left retro-button text-[11px] px-2 py-1",
                              onClick: () => props.onPickCc(contact.id),
                            },
                            `${contact.name} (${contact.departmentId || "dept"})`,
                          ),
                        )
                      : e(
                          "div",
                          { className: "text-[11px] text-gray-600 italic" },
                          "No available contacts.",
                        ),
                  ),
                  e(
                    "div",
                    { className: "flex justify-end" },
                    e(
                      "button",
                      { className: "retro-button text-[11px] px-4 py-1", onClick: props.onCloseCcPicker },
                      "Close",
                    ),
                  ),
                ),
              )
            : null,
          props.bccPickerOpen
            ? e(
                "div",
                {
                  className: "fixed inset-0 z-[120] bg-black/50 flex items-center justify-center p-4",
                  onClick: props.onCloseBccPicker,
                },
                e(
                  "div",
                  {
                    className: "bg-[#c0c0c0] retro-border max-w-sm w-full p-3",
                    onClick: (evt) => evt.stopPropagation(),
                  },
                  e("div", { className: "text-xs font-bold mb-2 uppercase" }, "Use Internal Service"),
                  e(
                    "div",
                    { className: "max-h-56 overflow-y-auto space-y-1 mb-3" },
                    props.availableBccContacts.length
                      ? props.availableBccContacts.map((bcc, idx) =>
                          e(
                            "button",
                            {
                              key: `${bcc.id}-${idx}`,
                              className:
                                "w-full text-left retro-button text-[11px] px-2 py-1",
                              onClick: () => props.onPickBcc(idx),
                            },
                            `${bcc.name}`,
                          ),
                        )
                      : e(
                          "div",
                          { className: "text-[11px] text-gray-600 italic" },
                          "No internal services available.",
                        ),
                  ),
                  e(
                    "div",
                    { className: "flex justify-end" },
                    e(
                      "button",
                      { className: "retro-button text-[11px] px-4 py-1", onClick: props.onCloseBccPicker },
                      "Close",
                    ),
                  ),
                ),
              )
            : null,
          props.settingsOpen
            ? e(
                "div",
                {
                  className: "fixed inset-0 bg-black/40 z-[125] flex items-center justify-center p-4",
                  onClick: props.onCloseSettings,
                },
                e(
                  "div",
                  {
                    className: "bg-[#c0c0c0] retro-border p-0.5 w-full max-w-[280px] shadow-2xl",
                    onClick: (evt) => evt.stopPropagation(),
                  },
                  e(
                    "div",
                    { className: "window-titlebar text-white px-2 py-1 text-[10px] font-bold flex justify-between items-center" },
                    e("span", null, "System Settings"),
                    e(
                      "button",
                      {
                        onClick: props.onCloseSettings,
                        className:
                          "w-3.5 h-3.5 bg-[#c0c0c0] border border-white shadow-[1px_1px_0px_black] text-black text-[9px] flex items-center justify-center font-bold",
                      },
                      "x",
                    ),
                  ),
                  e(
                    "div",
                    { className: "p-3 space-y-2" },
                    e(
                      "button",
                      { onClick: props.onRestartSameSeed, className: "w-full retro-button text-[11px] font-bold py-1.5" },
                      "Restart with Same Seed",
                    ),
                    e(
                      "button",
                      { onClick: props.onDepartmentSelect, className: "w-full retro-button text-[11px] font-bold py-1.5" },
                      "Return to Department Selection",
                    ),
                    e(
                      "button",
                      { onClick: props.onCloseSettings, className: "w-full retro-button text-[11px] font-bold py-1.5" },
                      "Back to Work",
                    ),
                  ),
                ),
              )
            : null,
          props.outcomeOverlay
            ? e(
                "div",
                {
                  className:
                    "fixed inset-0 z-[130] bg-black/50 flex items-center justify-center p-4",
                },
                e(
                  "div",
                  { className: "bg-[#c0c0c0] retro-border max-w-sm w-full p-4" },
                  e(
                    "div",
                    { className: "text-base font-bold mb-2" },
                    props.outcomeOverlay.title,
                  ),
                  e(
                    "div",
                    { className: "text-[12px] text-gray-700 mb-4" },
                    props.outcomeOverlay.body,
                  ),
                  e(
                    "div",
                    { className: "flex gap-2 justify-end" },
                    e(
                      "button",
                      {
                        className: "retro-button text-[11px] px-4 py-1",
                        onClick: props.onBackToInbox,
                      },
                      "Inbox",
                    ),
                    e(
                      "button",
                      {
                        className: "retro-button text-[11px] px-4 py-1",
                        onClick: props.onBackToMenu,
                      },
                      "Menu",
                    ),
                  ),
                ),
              )
            : null,
        );
      }

      function App() {
        const [metaState, setMetaState] = React.useState(() => {
          const loaded = loadMetaStateFromStorage();
          return ReplyAllEngine.start.sanitizeMetaState(loaded);
        });

        const [state, setState] = React.useState(() => {
          const ensured = ReplyAllEngine.start.ensureStartState(
            createInitialState(),
            loadMetaStateFromStorage(),
          );
          return ReplyAllEngine.play.attachRuntimeState(ensured.state);
        });

        const [activeScreen, setActiveScreen] = React.useState("start");
        const [playerName, setPlayerName] = React.useState("eke vdh");
        const [showAdvanced, setShowAdvanced] = React.useState(false);
        const [seedDraft, setSeedDraft] = React.useState("");
        const [resumeSave, setResumeSave] = React.useState(null);
        const [ccPickerOpen, setCcPickerOpen] = React.useState(false);
        const [bccPickerOpen, setBccPickerOpen] = React.useState(false);
        const [gameSettingsOpen, setGameSettingsOpen] = React.useState(false);
        const [hoveredAction, setHoveredAction] = React.useState(null);
        const [statusText, setStatusText] = React.useState("Ready.");
        const [summaryData, setSummaryData] = React.useState(null);
        const [promotionData, setPromotionData] = React.useState(null);
        const [shopNotice, setShopNotice] = React.useState("");
        const [shopDomRevision, setShopDomRevision] = React.useState(0);
        const queuedAddressStateRef = React.useRef(null);

        React.useEffect(() => {
          setSeedDraft(state.startConfig?.seedInput || "");
        }, [state.startConfig?.seedInput]);

        React.useEffect(() => {
          const save = loadSaveFromStorage();
          if (save && save.state && save.state.player && save.state.player.name) {
            setResumeSave(save);
            setPlayerName(save.state.player.name);
          }
        }, []);

        React.useEffect(() => {
          if (activeScreen !== "game" && gameSettingsOpen) {
            setGameSettingsOpen(false);
          }
        }, [activeScreen, gameSettingsOpen]);

        const emailPreview = ReplyAllEngine.start.getEmailFromName(playerName);
        const currentDeptId = state.startConfig?.departmentId || "executive";
        const department =
          START_DEPARTMENTS.find((dept) => dept.id === currentDeptId) ||
          START_DEPARTMENTS[0];
        const departmentUnlocked = ReplyAllEngine.start.isDepartmentUnlocked(
          metaState,
          department.id,
        );
        const maxUnlockedPrestige = ReplyAllEngine.start.getMaxPrestigeForDepartment(
          state,
          department.id,
        );
        const currentMission = MISSIONS[state.currentMissionIndex] || MISSIONS[0];

        function cloneState(src) {
          const next = JSON.parse(JSON.stringify(src));
          if (next && typeof next === "object") {
            delete next._statCtx;
            delete next._rngStore;
          }
          return next;
        }

        function persistSave(nextState, screen) {
          ReplyAllEngine.core.saveGame(nextState, nextState.opponents || [], screen, {
            onSaveGamePayload: (payload) => {
              try {
                localStorage.setItem(SAVE_KEY, JSON.stringify(payload));
              } catch (err) {}
            },
          });
        }

        function getShopNotice(result, fallback) {
          if (!result || result.ok) return "";
          const reason = result.reason || "error";
          if (reason === "rep") return "Not enough REP.";
          if (reason === "limit") return "Capacity reached for that item type.";
          if (reason === "owned" || reason === "purchased") return "You already own that item.";
          if (reason === "not_open") return "Open the pack first.";
          if (reason === "no_picks") return "No pack picks remaining.";
          return fallback || "Unable to complete that action.";
        }
        function commitShopMutation(nextState, notice = "") {
          setShopNotice(notice || "");
          setState(nextState);
          setShopDomRevision((v) => v + 1);
        }
        function reconcileShopDom() {
          setShopDomRevision((v) => v + 1);
        }

        function startMissionFromInbox() {
          const nextState = cloneState(state);
          ReplyAllEngine.play.startMissionWithIntro(
            nextState,
            currentMission.id,
            { missions: MISSIONS, employees: EMPLOYEES },
            {},
          );
          setState(nextState);
          setStatusText("Thread opened. Pick an action.");
          setActiveScreen("game");
          persistSave(nextState, "game-ui");
        }

        function onSignUp() {
          clearSaveFromStorage();
          setResumeSave(null);
          const ensured = ReplyAllEngine.start.ensureStartState(
            {
              ...state,
              startConfig: { ...ReplyAllEngine.start.DEFAULT_START_CONFIG },
            },
            metaState,
          );
          setState(ReplyAllEngine.play.attachRuntimeState(ensured.state));
          setActiveScreen("induction");
        }

        function onResume() {
          const save = resumeSave || loadSaveFromStorage();
          if (!save || !save.state) return;
          const restored = ReplyAllEngine.core.applySavedGame(save) || {};
          const restoredState = restored.state || save.state;
          const mergedMeta = ReplyAllEngine.start.mergeMetaProgress(
            metaState,
            restoredState,
          );
          const ensured = ReplyAllEngine.start.ensureStartState(restoredState, mergedMeta);
          setMetaState(mergedMeta);
          saveMetaStateToStorage(mergedMeta);
          const hydrated = ReplyAllEngine.play.attachRuntimeState(ensured.state);
          setState(hydrated);
          setPlayerName(ensured.state.player?.name || "eke vdh");
          const nextScreen = ReplyAllEngine.start.getUiScreenFromSave(save.activeScreen);
          setSummaryData(
            nextScreen === "summary"
              ? ReplyAllEngine.play.computeSummary(hydrated)
              : null,
          );
          setPromotionData(
            nextScreen === "promotion"
              ? ReplyAllEngine.play.getPromotionStats(hydrated)
              : null,
          );
          setShopNotice("");
          setActiveScreen(nextScreen);
        }

        function onRotate(dir) {
          const nextDepartmentId = ReplyAllEngine.start.rotateDepartment(
            currentDeptId,
            dir,
          );
          setState((prev) => ({
            ...prev,
            startConfig: {
              ...prev.startConfig,
              departmentId: nextDepartmentId,
              prestige: 0,
            },
          }));
        }

        function onSelectPrestige(index) {
          if (
            !ReplyAllEngine.start.canSelectPrestige(
              state,
              metaState,
              department.id,
              index,
            )
          ) {
            return;
          }
          setState((prev) => ({
            ...prev,
            startConfig: {
              ...prev.startConfig,
              prestige: index,
            },
          }));
        }

        function onOpenAdvanced() {
          setSeedDraft(state.startConfig?.seedInput || "");
          setShowAdvanced(true);
        }

        function onSaveAdvanced() {
          setState((prev) => ({
            ...prev,
            startConfig: {
              ...prev.startConfig,
              seedInput: seedDraft,
            },
          }));
          setShowAdvanced(false);
        }

        function onClockIn() {
          const prepared = ReplyAllEngine.start.prepareRunFromInduction(
            state,
            metaState,
            playerName,
          );
          const runState = ReplyAllEngine.play.attachRuntimeState(prepared.state);
          setState(runState);
          setStatusText("Ready.");
          setActiveScreen("inbox");
          persistSave(runState, "inbox-screen");
        }

        function onOpenPrimaryEmail() {
          if (state.missionActive) {
            setActiveScreen("game");
            persistSave(state, "game-ui");
            return;
          }
          startMissionFromInbox();
        }

        function onSelectTarget(targetId) {
          setState((prev) => ({ ...prev, targetId }));
        }

        function runActionFromState(baseState, actionType, extra = {}) {
          queuedAddressStateRef.current = null;
          setShopNotice("");
          if (actionType === "CC" && !extra.contactId) {
            setCcPickerOpen(true);
            return;
          }
          if (actionType === "BCC" && typeof extra.bccIndex !== "number") {
            setBccPickerOpen(true);
            return;
          }
          const sourceState = baseState || state;
          const nextState = cloneState(sourceState);
          ReplyAllEngine.play.attachRuntimeState(nextState);
          const result = ReplyAllEngine.play.runPlayerTurn(
            nextState,
            actionType,
            {
              targetId: nextState.targetId,
              contactId: extra.contactId || null,
              bccId: extra.bccId || null,
              bccIndex: typeof extra.bccIndex === "number" ? extra.bccIndex : null,
            },
            { missions: MISSIONS, employees: EMPLOYEES },
            {
              onDepartmentUnlock: (deptId) => {
                if (deptId !== "it") return;
                const nextMeta = ReplyAllEngine.start.sanitizeMetaState(metaState);
                if (!nextMeta.departmentUnlocks.it) {
                  nextMeta.departmentUnlocks.it = true;
                  setMetaState(nextMeta);
                  saveMetaStateToStorage(nextMeta);
                }
              },
            },
          );
          const unlockResult = ReplyAllEngine.start.applyDepartmentUnlocks(
            nextState,
            metaState,
          );
          if (unlockResult?.changed) {
            setMetaState(unlockResult.metaState);
            saveMetaStateToStorage(unlockResult.metaState);
          }
          setCcPickerOpen(false);
          setBccPickerOpen(false);
          const winLoss = ReplyAllEngine.core.checkWinLoss(nextState, { missions: MISSIONS });
          if (result?.gameOver && !result.lossReason && !winLoss.gameWon) {
            const summary = ReplyAllEngine.play.computeSummary(nextState);
            ReplyAllEngine.play.applySummaryRewards(nextState, summary);
            const summaryUnlockResult = ReplyAllEngine.start.applyDepartmentUnlocks(
              nextState,
              unlockResult?.metaState || metaState,
            );
            if (summaryUnlockResult?.changed) {
              setMetaState(summaryUnlockResult.metaState);
              saveMetaStateToStorage(summaryUnlockResult.metaState);
            }
            setSummaryData(summary);
            setState(nextState);
            setActiveScreen("summary");
            persistSave(nextState, "summary-screen");
            setStatusText("Thread archived.");
            return;
          }
          if (winLoss.gameWon) {
            setState(nextState);
            setActiveScreen("campaign-complete");
            persistSave(nextState, "campaign-complete-screen");
            setStatusText("Campaign complete.");
            return;
          }
          const lossReason =
            result?.lossReason ||
            nextState.lossReason ||
            (winLoss.gameOver && !winLoss.gameWon ? winLoss.reason : null);
          const isLoss = !!lossReason && (lossReason === "timeout" || lossReason === "defeat");
          setState(nextState);
          if (isLoss) {
            clearSaveFromStorage();
            setResumeSave(null);
          } else {
            persistSave(nextState, "game-ui");
          }
          if (result?.gameOver || winLoss.gameOver) {
            if (lossReason === "timeout") {
              setStatusText("Thread timed out.");
            } else if (lossReason === "defeat") {
              setStatusText("You were removed from the thread.");
            } else if (winLoss.gameWon) {
              setStatusText("Campaign complete.");
            } else {
              setStatusText("Thread archived.");
            }
          } else {
            setStatusText(`Turn ${nextState.turn} resolved.`);
          }
        }
        function onAction(actionType, extra = {}) {
          runActionFromState(state, actionType, extra);
        }

        function onUseAddressContact(contactId) {
          const baseState = queuedAddressStateRef.current || state;
          const nextState = cloneState(baseState);
          ReplyAllEngine.play.attachRuntimeState(nextState);
          const result = ReplyAllEngine.core.resolvePlayerCcAction(
            nextState,
            nextState.targetId,
            contactId,
            {},
          );
          if (!result?.ok) {
            setStatusText("Unable to use that contact.");
            return false;
          }
          queuedAddressStateRef.current = nextState;
          setState(nextState);
          setStatusText(`Queued contact: ${result.contact?.name || "Contact"}.`);
          return true;
        }

        function onUseAddressBcc(bccIndex) {
          const baseState = queuedAddressStateRef.current || state;
          const nextState = cloneState(baseState);
          ReplyAllEngine.play.attachRuntimeState(nextState);
          const result = ReplyAllEngine.core.resolvePlayerBccAction(
            nextState,
            null,
            bccIndex,
            {},
          );
          if (!result?.ok) {
            setStatusText("Unable to use that internal service.");
            return false;
          }
          queuedAddressStateRef.current = nextState;
          setState(nextState);
          setStatusText(`Queued internal service: ${result.bcc?.name || "Service"}.`);
          return true;
        }

        function onAddressDrawerEndTurn() {
          const queuedState = queuedAddressStateRef.current || state;
          runActionFromState(queuedState, "PASS");
        }

        function onGoToPortal() {
          const nextState = cloneState(state);
          const step = ReplyAllEngine.play.advanceAfterSummary(nextState, {
            missions: MISSIONS,
          });
          if (step.isFinal) {
            setState(nextState);
            setActiveScreen("campaign-complete");
            setStatusText("Campaign complete.");
            persistSave(nextState, "campaign-complete-screen");
            return;
          }
          ReplyAllEngine.play.prepareShopState(nextState);
          setActiveScreen("shop");
          commitShopMutation(nextState, "");
        }

        function onBuyItem(item) {
          const nextState = cloneState(state);
          ReplyAllEngine.play.attachRuntimeState(nextState);
          const result = ReplyAllEngine.core.buyDirectItemById(nextState, item?.id, {});
          const notice = getShopNotice(result);
          setShopNotice(notice);
          if (!result?.ok) return;
          commitShopMutation(nextState, notice);
        }

        function onReroll() {
          const nextState = cloneState(state);
          ReplyAllEngine.play.attachRuntimeState(nextState);
          const result = ReplyAllEngine.core.rerollShop(nextState);
          const notice = getShopNotice(result);
          setShopNotice(notice);
          if (!result?.ok) return;
          commitShopMutation(nextState, notice);
        }

        function onOpenPack(pack) {
          const nextState = cloneState(state);
          ReplyAllEngine.play.attachRuntimeState(nextState);
          const result = ReplyAllEngine.core.openPackById(nextState, pack?.id);
          const notice = getShopNotice(result);
          setShopNotice(notice);
          if (!result?.ok) return;
          commitShopMutation(nextState, notice);
        }

        function onSelectPackItem(packId, itemId) {
          const nextState = cloneState(state);
          ReplyAllEngine.play.attachRuntimeState(nextState);
          const result = ReplyAllEngine.core.selectPackItem(nextState, packId, itemId, {});
          const notice = getShopNotice(result);
          setShopNotice(notice);
          if (!result?.ok) return;
          commitShopMutation(nextState, notice);
        }

        function onClosePack() {
          const nextState = cloneState(state);
          ReplyAllEngine.play.attachRuntimeState(nextState);
          if (nextState.activePackId) {
            ReplyAllEngine.core.closePack(nextState, nextState.activePackId);
          }
          commitShopMutation(nextState, "");
        }

        function onArchiveOwned(itemType, itemId, itemIndex = null) {
          const nextState = cloneState(state);
          ReplyAllEngine.play.attachRuntimeState(nextState);
          const result = ReplyAllEngine.core.archiveOwnedItem(
            nextState,
            itemType,
            itemId,
            { itemIndex, withRefund: true },
          );
          setShopNotice(
            result?.ok
              ? `Archived ${result.item?.name || itemType}. +${result.refund || 0} REP`
              : "Unable to archive that asset.",
          );
          if (!result?.ok) return;
          commitShopMutation(nextState, `Archived ${result.item?.name || itemType}. +${result.refund || 0} REP`);
        }

        function onDropBuyItem(itemId) {
          const nextState = cloneState(state);
          ReplyAllEngine.play.attachRuntimeState(nextState);
          const result = ReplyAllEngine.core.applyShopDragAction(
            nextState,
            "buy_direct",
            { itemId },
            {},
          );
          const notice = getShopNotice(result);
          setShopNotice(notice);
          if (!result?.ok) {
            reconcileShopDom();
            return;
          }
          commitShopMutation(nextState, notice);
        }

        function onDropOpenPack(packId) {
          const nextState = cloneState(state);
          ReplyAllEngine.play.attachRuntimeState(nextState);
          const result = ReplyAllEngine.core.applyShopDragAction(
            nextState,
            "open_pack",
            { packId },
            {},
          );
          const notice = getShopNotice(result);
          setShopNotice(notice);
          if (!result?.ok) {
            reconcileShopDom();
            return;
          }
          commitShopMutation(nextState, notice);
        }

        function onDropArchiveOwned(itemType, itemId, itemIndex = null) {
          const nextState = cloneState(state);
          ReplyAllEngine.play.attachRuntimeState(nextState);
          const result = ReplyAllEngine.core.applyShopDragAction(
            nextState,
            "archive_owned",
            { itemType, itemId, itemIndex, withRefund: true },
            {},
          );
          const notice = result?.ok
            ? `Archived ${result.item?.name || itemType}. +${result.refund || 0} REP`
            : "Unable to archive that asset.";
          setShopNotice(notice);
          if (!result?.ok) {
            reconcileShopDom();
            return;
          }
          commitShopMutation(nextState, notice);
        }

        function onDropEquipFromShop(itemId, slotType) {
          const nextState = cloneState(state);
          ReplyAllEngine.play.attachRuntimeState(nextState);
          const item = ReplyAllEngine.core.getDirectShopItemById(
            nextState,
            itemId,
            slotType,
          );
          if (!item) {
            setShopNotice("Offer not found.");
            return;
          }
          if (item.itemType !== slotType) {
            setShopNotice("That item cannot be equipped in this slot.");
            return;
          }
          const result = ReplyAllEngine.core.applyShopDragAction(
            nextState,
            "equip_from_shop",
            { itemId, slotType },
            { expectedItemType: slotType },
          );
          const notice = getShopNotice(result);
          setShopNotice(notice);
          if (!result?.ok) {
            reconcileShopDom();
            return;
          }
          commitShopMutation(nextState, notice);
        }

        function onReorderShopDirectItems(itemIds) {
          if (!Array.isArray(itemIds) || !itemIds.length) return;
          const current = state.shop?.directItems || [];
          if (!current.length) return;
          const visible = current.filter((item) => item && !item.purchased);
          if (!visible.length) return;
          const byId = new Map(visible.map((item) => [item.id, item]));
          const seen = new Set();
          const reorderedVisible = [];
          itemIds.forEach((id) => {
            if (!id || seen.has(id)) return;
            const item = byId.get(id);
            if (!item) return;
            reorderedVisible.push(item);
            seen.add(id);
          });
          visible.forEach((item) => {
            if (!item || seen.has(item.id)) return;
            reorderedVisible.push(item);
          });
          const changed =
            reorderedVisible.length === visible.length &&
            reorderedVisible.some((item, idx) => item?.id !== visible[idx]?.id);
          if (!changed) return;
          const nextState = cloneState(state);
          const queue = [...reorderedVisible];
          nextState.shop.directItems = (nextState.shop.directItems || []).map((item) => {
            if (!item || item.purchased) return item;
            return queue.shift() || item;
          });
          commitShopMutation(nextState, "");
        }

        function onReorderShopPacks(packIds) {
          if (!Array.isArray(packIds) || !packIds.length) return;
          const current = state.shop?.packs || [];
          if (!current.length) return;
          const visible = current.filter((pack) => pack && !pack.purchased);
          if (!visible.length) return;
          const byId = new Map(visible.map((pack) => [pack.id, pack]));
          const seen = new Set();
          const reorderedVisible = [];
          packIds.forEach((id) => {
            if (!id || seen.has(id)) return;
            const pack = byId.get(id);
            if (!pack) return;
            reorderedVisible.push(pack);
            seen.add(id);
          });
          visible.forEach((pack) => {
            if (!pack || seen.has(pack.id)) return;
            reorderedVisible.push(pack);
          });
          const changed =
            reorderedVisible.length === visible.length &&
            reorderedVisible.some((pack, idx) => pack?.id !== visible[idx]?.id);
          if (!changed) return;
          const nextState = cloneState(state);
          const queue = [...reorderedVisible];
          nextState.shop.packs = (nextState.shop.packs || []).map((pack) => {
            if (!pack || pack.purchased) return pack;
            return queue.shift() || pack;
          });
          commitShopMutation(nextState, "");
        }

        function onReorderSignatures(signatureIds) {
          if (!Array.isArray(signatureIds) || !signatureIds.length) return;
          const current = state.player?.signatures || [];
          if (!current.length) return;
          const byId = new Map(current.map((sig) => [sig.id, sig]));
          const seen = new Set();
          const reordered = [];
          signatureIds.forEach((id) => {
            if (!id || seen.has(id)) return;
            const sig = byId.get(id);
            if (!sig) return;
            reordered.push(sig);
            seen.add(id);
          });
          current.forEach((sig) => {
            if (!sig || seen.has(sig.id)) return;
            reordered.push(sig);
          });
          const changed =
            reordered.length === current.length &&
            reordered.some((sig, idx) => sig?.id !== current[idx]?.id);
          if (!changed) return;
          const nextState = cloneState(state);
          nextState.player.signatures = reordered;
          commitShopMutation(nextState, "");
        }

        function onReorderAddressBook(contactIds) {
          if (!Array.isArray(contactIds) || !contactIds.length) return;
          const current = state.player?.addressBook || [];
          if (!current.length) return;
          const currentSet = new Set(current);
          const seen = new Set();
          const reordered = [];
          contactIds.forEach((id) => {
            if (!id || seen.has(id) || !currentSet.has(id)) return;
            reordered.push(id);
            seen.add(id);
          });
          current.forEach((id) => {
            if (!id || seen.has(id)) return;
            reordered.push(id);
          });
          const changed =
            reordered.length === current.length &&
            reordered.some((id, idx) => id !== current[idx]);
          if (!changed) return;
          const nextState = cloneState(state);
          nextState.player.addressBook = reordered;
          commitShopMutation(nextState, "");
        }
        function onReorderBcc(bccIndices) {
          if (!Array.isArray(bccIndices) || !bccIndices.length) return;
          const current =
            state.player?.bccContacts ||
            state.player?.bccs ||
            [];
          if (!current.length) return;
          const seen = new Set();
          const reordered = [];
          bccIndices.forEach((idx) => {
            if (!Number.isFinite(idx) || idx < 0 || idx >= current.length) return;
            if (seen.has(idx)) return;
            const entry = current[idx];
            if (!entry) return;
            reordered.push(entry);
            seen.add(idx);
          });
          current.forEach((entry, idx) => {
            if (!entry || seen.has(idx)) return;
            reordered.push(entry);
          });
          const changed =
            reordered.length === current.length &&
            reordered.some((entry, idx) => entry !== current[idx]);
          if (!changed) return;
          const nextState = cloneState(state);
          if (Array.isArray(nextState.player?.bccContacts)) {
            nextState.player.bccContacts = reordered;
          }
          if (Array.isArray(nextState.player?.bccs)) {
            nextState.player.bccs = reordered;
          }
          commitShopMutation(nextState, "");
        }

        function onNextQuarterFromShop() {
          const nextState = cloneState(state);
          const quarterStep = ReplyAllEngine.play.advanceQuarterWithPromotion(nextState);
          setShopNotice("");
          setState(nextState);
          setShopDomRevision((v) => v + 1);
          if (quarterStep.needsPromotion && quarterStep.nextTitle) {
            setPromotionData(ReplyAllEngine.play.getPromotionStats(nextState));
            setActiveScreen("promotion");
            return;
          }
          setActiveScreen("inbox");
        }

        function onContinuePromotion() {
          setPromotionData(null);
          setActiveScreen("inbox");
        }

        function onRestartSameSeedFromSettings() {
          const sourceState = cloneState(state);
          sourceState.startConfig = {
            ...(sourceState.startConfig || {}),
            seedInput: String(state.seed ?? sourceState.startConfig?.seedInput ?? ""),
          };
          const prepared = ReplyAllEngine.start.prepareRunFromInduction(
            sourceState,
            metaState,
            state.player?.name || playerName,
          );
          const runState = ReplyAllEngine.play.attachRuntimeState(prepared.state);
          setGameSettingsOpen(false);
          setCcPickerOpen(false);
          setBccPickerOpen(false);
          setSummaryData(null);
          setPromotionData(null);
          setShopNotice("");
          setStatusText("Ready.");
          setState(runState);
          setPlayerName(runState.player?.name || playerName);
          setActiveScreen("inbox");
          persistSave(runState, "inbox-screen");
        }

        function onDepartmentSelectFromSettings() {
          setGameSettingsOpen(false);
          setCcPickerOpen(false);
          setBccPickerOpen(false);
          setActiveScreen("induction");
          persistSave(state, "induction-screen");
        }

        function onBackToMenuFromCampaign() {
          setActiveScreen("start");
          setSummaryData(null);
          setPromotionData(null);
          setShopNotice("");
          setStatusText("Ready.");
        }

        React.useEffect(() => {
          const onKeyDown = (evt) => {
            const isDebugHotkey =
              evt.key === "-" ||
              evt.code === "Minus" ||
              evt.code === "NumpadSubtract";
            if (!isDebugHotkey) return;
            const activeEl = document.activeElement;
            const tag = activeEl?.tagName;
            if (
              tag === "INPUT" ||
              tag === "TEXTAREA" ||
              activeEl?.isContentEditable
            ) {
              return;
            }
            evt.preventDefault();
            const nextState = cloneState(state);
            ReplyAllEngine.play.attachRuntimeState(nextState);
            const result = ReplyAllEngine.play.debugMutatePlayerStats(
              nextState,
              { reputation: 1000, escalateDmg: 1000 },
              { mode: "add" },
            );
            if (!result?.ok) return;
            ReplyAllEngine.play.debugIncreaseSignatureLimit(nextState, 20);
            setState(nextState);
            setShopNotice("Debug: +1000 REP, +1000 Escalate DMG, +20 Sig Limit.");
            setStatusText("Debug: +1000 REP, +1000 Escalate DMG, +20 Sig Limit.");
            persistSave(
              nextState,
              ReplyAllEngine.start.getSaveScreenFromUi(activeScreen),
            );
          };
          window.addEventListener("keydown", onKeyDown);
          return () => window.removeEventListener("keydown", onKeyDown);
        }, [state, activeScreen]);

        const ccContactStatuses = ReplyAllEngine.play.getPlayerCcContactStatuses
          ? ReplyAllEngine.play.getPlayerCcContactStatuses(state)
          : ReplyAllEngine.play.getAvailablePlayerCcContacts(state).map((c) => ({
              ...c,
              available: true,
              status: "available",
              statusText: "",
              waitText: "",
              blockedByStakeholder: null,
            }));
        const availableCcContacts = ccContactStatuses.filter((c) => c.available);
        const availableBccContacts = ReplyAllEngine.play.getAvailablePlayerBccContacts(
          state,
        );
        const disabledActions = {
          ATTACK:
            !!state.isProcessing ||
            !!state.gameOver ||
            !state.targetId ||
            !!state.player?.signOff?.disableReplyTo,
          ESCALATE: !!state.isProcessing || !!state.gameOver,
          CC:
            !!state.isProcessing ||
            !!state.gameOver ||
            !availableCcContacts.length ||
            !state.targetId,
          BCC:
            !!state.isProcessing ||
            !!state.gameOver ||
            !availableBccContacts.length,
          PROMOTE:
            !!state.isProcessing ||
            !!state.gameOver ||
            (state.player?.currentWins || 0) <= 0,
          DEFLECT: !!state.isProcessing || !!state.gameOver,
          ULT:
            !!state.isProcessing ||
            !!state.gameOver ||
            (state.player?.ult || 0) < 8,
        };

        const selectedTarget =
          (state.opponents || []).find((o) => o.id === state.targetId) || null;
        const statCtx = state._statCtx;
        const playerDamageSingle =
          statCtx && state.player
            ? ReplyAllEngine.stats.getUnitDamage(statCtx, state.player, "single")
            : 0;
        const playerDamageEscalate =
          statCtx && state.player
            ? ReplyAllEngine.stats.getUnitDamage(statCtx, state.player, "escalate")
            : 0;
        const playerDamageUlt =
          statCtx && state.player
            ? ReplyAllEngine.stats.getUnitDamage(statCtx, state.player, "replyAll")
            : 0;
        const targetDef =
          statCtx && selectedTarget
            ? ReplyAllEngine.stats.getUnitFlatDef(statCtx, selectedTarget)
            : 0;

        const actionHints = {
          ATTACK: disabledActions.ATTACK
            ? "Reply to unavailable."
            : `Reply to ${selectedTarget?.name || "target"} for ~${Math.max(0, Math.floor(playerDamageSingle - targetDef))}.`,
          ESCALATE: disabledActions.ESCALATE
            ? "Escalate unavailable."
            : `Escalate to all stakeholders for ~${Math.floor(playerDamageEscalate)} each.`,
          CC: disabledActions.CC
            ? "No valid contacts available."
            : `Contact CC: ${availableCcContacts.length} available in address book.`,
          BCC: disabledActions.BCC
            ? "No internal services available."
            : `Use internal service: ${availableBccContacts.length} available.`,
          PROMOTE: disabledActions.PROMOTE
            ? "Self-Promote unavailable."
            : "Self-Promote: spend 1 win to recover credibility.",
          DEFLECT: disabledActions.DEFLECT
            ? "Deflect unavailable."
            : "Deflect incoming damage and reflect pressure.",
          ULT: disabledActions.ULT
            ? `Reply All requires full leverage (would deal ~${Math.floor(playerDamageUlt)} to all).`
            : `Reply All for ~${Math.floor(playerDamageUlt)} to all.`,
        };

        const computedStatusText =
          hoveredAction && actionHints[hoveredAction]
            ? actionHints[hoveredAction]
            : statusText;

        const outcomeOverlay = state.gameOver
          ? state.lossReason === "timeout"
            ? {
                title: "Deadline Missed",
                body: "The thread exceeded its due time and closed against you.",
              }
            : state.lossReason === "defeat"
              ? {
                  title: "Credibility Collapsed",
                  body: "You were forced out of the thread.",
                }
              : {
                  title: "Thread Archived",
                  body: "All opposing stakeholders have opted out.",
                }
          : null;

        if (activeScreen === "start") {
          return e(StartScreen, {
            playerName,
            emailPreview,
            resumeName: resumeSave?.state?.player?.name || "",
            onNameChange: setPlayerName,
            onSignUp,
            onResume,
          });
        }

        if (activeScreen === "induction") {
          return e(
            React.Fragment,
            null,
            e(InductionScreen, {
              department,
              departmentUnlocked,
              isLocked: !departmentUnlocked,
              maxUnlockedPrestige,
              startConfig: state.startConfig,
              onRotate,
              onSelectPrestige,
              onOpenAdvanced,
              onClockIn,
            }),
            showAdvanced
              ? e(AdvancedModal, {
                  seedValue: seedDraft,
                  onSeedChange: setSeedDraft,
                  onClose: () => setShowAdvanced(false),
                  onSave: onSaveAdvanced,
                })
              : null,
          );
        }

        if (activeScreen === "inbox") {
          return e(InboxScreen, {
            state,
            mission: currentMission,
            onOpenPrimaryEmail,
          });
        }

        if (activeScreen === "summary") {
          return e(SummaryScreen, {
            summary: summaryData,
            onGoToPortal,
          });
        }

        if (activeScreen === "shop") {
          return e(ShopScreen, {
            key: `shop-${shopDomRevision}`,
            state,
            notice: shopNotice,
            onBuyItem,
            onReroll,
            onOpenPack,
            onSelectPackItem,
            onClosePack,
            onArchiveOwned,
            onDropBuyItem,
            onDropOpenPack,
            onDropArchiveOwned,
            onDropEquipFromShop,
            onReorderShopDirectItems,
            onReorderShopPacks,
            onReorderAddressBook,
            onReorderSignatures,
            onReorderBcc,
            onReconcileShopDom: reconcileShopDom,
            onNextQuarter: onNextQuarterFromShop,
          });
        }

        if (activeScreen === "promotion") {
          return e(PromotionScreen, {
            promotion: promotionData,
            onContinue: onContinuePromotion,
          });
        }

        if (activeScreen === "campaign-complete") {
          return e(CampaignCompleteScreen, {
            player: state.player,
            onBackToMenu: onBackToMenuFromCampaign,
          });
        }

        return e(GameUIScreen, {
          state,
          mission: currentMission,
          onSelectTarget,
          onAction,
          onActionHover: setHoveredAction,
          disabledActions,
          actionHints,
          statusText: computedStatusText,
          outcomeOverlay,
          ccPickerOpen,
          bccPickerOpen,
          availableCcContacts,
          ccContactStatuses,
          availableBccContacts,
          onPickCc: (contactId) => onAction("CC", { contactId }),
          onPickBcc: (bccIndex) => onAction("BCC", { bccIndex }),
          onUseAddressContact,
          onUseAddressBcc,
          onAddressDrawerEndTurn,
          onCloseCcPicker: () => setCcPickerOpen(false),
          onCloseBccPicker: () => setBccPickerOpen(false),
          settingsOpen: gameSettingsOpen,
          onOpenSettings: () => setGameSettingsOpen(true),
          onCloseSettings: () => setGameSettingsOpen(false),
          onRestartSameSeed: onRestartSameSeedFromSettings,
          onDepartmentSelect: onDepartmentSelectFromSettings,
          onBackToInbox: () => {
            setGameSettingsOpen(false);
            setActiveScreen("inbox");
            setStatusText("Ready.");
            persistSave(state, "inbox-screen");
          },
          onBackToMenu: () => {
            setGameSettingsOpen(false);
            setActiveScreen("start");
            setStatusText("Ready.");
          },
        });
      }

      const root = ReactDOM.createRoot(document.getElementById("app"));
      root.render(e(App));
    </script>
  </body>
</html>
