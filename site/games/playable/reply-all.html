<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>REPLY ALL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=VT323&family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /**
         * FUNCTIONALITY CATALOG:
         * 1. Turn-based FFA Loop: Logic preserved.
         * 2. Targeting: TargetId state mapped to "To:" field.
        * 3. Actions: ATTACK (Reply to), ESCALATE (Light AOE), DEFLECT (Block/Reflect), SELF-PROMOTE (New Wins/Heal), ULT (Reply All), CC (Summon/Buff).
         * 4. Address Book: Modal system for assigning permanent buffs.
         * 5. Personality: Specific attack types (Compliance, Value, Time, Accusatory).
         */
      :root {
        --win-grey: #c0c0c0;
        --win-blue: #000080;
        --win-border-light: #ffffff;
        --win-border-dark: #404040;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: #008080;
        height: 100dvh;
        overflow: hidden;
        touch-action: manipulation;
        color: black;
      }
      .retro-border {
        border-top: 2px solid var(--win-border-light);
        border-left: 2px solid var(--win-border-light);
        border-bottom: 2px solid var(--win-border-dark);
        border-right: 2px solid var(--win-border-dark);
      }
      .retro-border-inset {
        border-top: 2px solid var(--win-border-dark);
        border-left: 2px solid var(--win-border-dark);
        border-bottom: 2px solid var(--win-border-light);
        border-right: 2px solid var(--win-border-light);
      }
      .retro-button {
        background: var(--win-grey);
        border-top: 2px solid var(--win-border-light);
        border-left: 2px solid var(--win-border-light);
        border-bottom: 2px solid var(--win-border-dark);
        border-right: 2px solid var(--win-border-dark);
        padding: 4px 8px;
        cursor: pointer;
        user-select: none;
      }
      .retro-button:active:not(:disabled) {
        border-top: 2px solid var(--win-border-dark);
        border-left: 2px solid var(--win-border-dark);
        border-bottom: 2px solid var(--win-border-light);
        border-right: 2px solid var(--win-border-light);
        padding-top: 5px;
        padding-bottom: 3px;
      }
      .retro-button:disabled {
        color: #808080;
        cursor: not-allowed;
        opacity: 0.6;
      }
      .terminal-font {
        font-family: "VT323", monospace;
      }
      @keyframes shake {
        0%,
        100% {
          transform: translate(0, 0);
        }
        25% {
          transform: translate(-3px, 3px);
        }
        50% {
          transform: translate(3px, -3px);
        }
        75% {
          transform: translate(-3px, -3px);
        }
      }
      .shaking {
        animation: shake 0.2s ease-in-out infinite;
      }
      .scroll-container::-webkit-scrollbar {
        width: 14px;
      }
      .scroll-container::-webkit-scrollbar-track {
        background: #dfdfdf;
      }
      .scroll-container::-webkit-scrollbar-thumb {
        background: var(--win-grey);
        border: 2px solid var(--win-border-light);
        box-shadow: inset -1px -1px 0 var(--win-border-dark);
      }
      .contacts-container {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        max-height: 28px;
        overflow: hidden;
        transition: max-height 0.2s ease;
      }
      .contacts-container.expanded {
        max-height: 140px;
      }
      .contacts-more {
        cursor: pointer;
        color: #000080;
        font-style: normal;
        font-weight: bold;
        text-decoration: underline;
        margin-left: 4px;
      }
      .target-pill {
        transition: all 0.2s;
        border: 1px solid #808080;
      }
      .target-pill.active {
        background: #000080 !important;
        color: white !important;
        border-color: #ffffff;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .message-entry {
        animation: slideIn 0.3s ease-out;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .email-header {
        background: #e8e8e8;
        border-bottom: 1px solid #ccc;
        font-family: sans-serif;
        font-size: 11px;
        color: #444;
      }
      .email-body {
        padding: 12px 0;
        line-height: 1.5;
        color: #111;
      }
    </style>
  </head>
  <body class="flex items-center justify-center p-0 md:p-2">
    <!-- INBOX SCREEN -->
    <div
      id="inbox-screen"
      class="hidden fixed inset-0 z-[90] flex items-center justify-center bg-[#008080] p-4"
    >
      <div
        class="bg-[#c0c0c0] retro-border max-w-2xl w-full h-[80dvh] flex flex-col shadow-2xl"
      >
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs"
        >
          <span>Outlook Express - Inbox</span>
          <div class="flex gap-1">
            <button
              class="w-4 h-4 bg-[#c0c0c0] text-black text-[10px] flex items-center justify-center"
            >
              _
            </button>
            <button
              class="w-4 h-4 bg-[#c0c0c0] text-black text-[10px] flex items-center justify-center"
            >
              X
            </button>
          </div>
        </div>
        <div
          class="bg-[#dfdfdf] border-b border-[#808080] p-1 flex gap-2 text-[10px]"
        >
          <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">File</button>
          <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">Edit</button>
          <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">View</button>
          <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">Tools</button>
          <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">Message</button>
          <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">Help</button>
        </div>
        <div class="flex-grow flex overflow-hidden">
          <div
            class="w-32 bg-[#dfdfdf] border-r border-[#808080] p-2 text-[10px] hidden sm:block"
          >
            <div class="font-bold mb-2">Folders</div>
            <div class="pl-2 space-y-1">
              <div class="bg-blue-800 text-white px-1">Inbox</div>
              <div>Outbox</div>
              <div>Sent Items</div>
              <div>Deleted Items</div>
              <div>Spam</div>
            </div>
          </div>
          <div class="flex-grow flex flex-col bg-white overflow-hidden">
            <div
              class="bg-[#f0f0f0] border-b border-[#808080] grid grid-cols-12 text-[9px] font-bold p-1"
            >
              <div class="col-span-1">!</div>
              <div class="col-span-5">From</div>
              <div class="col-span-6">Subject</div>
            </div>
            <div
              id="inbox-list"
              class="flex-grow overflow-y-auto overflow-x-hidden text-[11px] divide-y divide-gray-100"
            >
              <!-- Emails will be injected here -->
            </div>
          </div>
        </div>
        <div
          class="bg-[#dfdfdf] border-t border-[#808080] p-1 text-[10px] flex justify-between"
        >
          <div id="inbox-status">324 Messages, 1 Unread</div>
          <div class="flex gap-4">
            <span>Working Online</span>
          </div>
        </div>
      </div>
    </div>

    <!-- SUMMARY SCREEN (Performance Metrics) -->
    <div
      id="summary-screen"
      class="hidden fixed inset-0 z-[120] bg-black/60 flex items-center justify-center p-4"
    >
      <div
        class="bg-[#c0c0c0] retro-border max-w-xs w-full shadow-2xl overflow-hidden"
      >
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold"
        >
          <span>ARCHIVED THREAD</span>
          <span>✕</span>
        </div>
        <div class="p-4 flex flex-col items-center">
          <div
            class="w-16 h-16 bg-yellow-400 retro-border flex items-center justify-center mb-4"
          >
            <svg
              class="w-10 h-10 text-white"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
              <path
                fill-rule="evenodd"
                d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13zM7 13a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13z"
                clip-rule="evenodd"
              ></path>
            </svg>
          </div>
          <h2 class="text-xl font-bold terminal-font mb-2">
            PERFORMANCE METRICS
          </h2>
          <div
            class="w-full bg-white retro-border-inset p-3 space-y-2 text-xs mb-4"
          >
            <div class="flex justify-between">
              <span>Base Mission Reward:</span>
              <span id="summary-base-rep" class="font-mono">+4</span>
            </div>
            <div
              id="summary-optouts-list"
              class="space-y-1 py-1 border-y border-gray-100 hidden"
            >
              <!-- Individual opt-outs injected here -->
            </div>
            <div class="flex justify-between">
              <span>Additional Bonuses:</span>
              <span id="summary-bonus-rep" class="font-mono">+0</span>
            </div>
            <div
              class="border-t border-gray-300 pt-2 flex justify-between font-bold text-[#000080]"
            >
              <span>TOTAL REP EARNED:</span>
              <span id="summary-rep-earned" class="font-mono text-lg">+0</span>
            </div>
          </div>
          <button
            onclick="showShop()"
            class="w-full py-2 retro-button font-bold text-sm"
          >
            GO TO PORTAL
          </button>
        </div>
      </div>
    </div>

    <!-- SHOP SCREEN (HR Self-Service Portal) -->
    <div
      id="shop-screen"
      class="hidden fixed inset-0 z-[130] bg-[#008080] p-4 flex flex-col items-center overflow-y-auto"
    >
      <div
        class="bg-[#c0c0c0] retro-border w-full max-w-4xl shadow-2xl flex flex-col min-h-0"
      >
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold shrink-0"
        >
          <span>INTRA-NET: EMPLOYEE BENEFITS & GROWTH</span>
          <span
            id="shop-reputation-display"
            class="bg-yellow-400 text-black px-2 rounded-sm ml-auto mr-4"
            >REP: 0</span
          >
          <button
            onclick="advanceToNextQuarter()"
            class="retro-button text-black text-[10px] py-0 px-2 h-4"
          >
            NEXT QUARTER &gt;
          </button>
        </div>
        <div class="bg-[#f0f0f0] p-4 flex-grow overflow-y-auto">
          <div
            id="shop-set-bonuses"
            class="mb-3 p-2 bg-white retro-border text-[10px]"
          ></div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Seminars (CCs) -->
            <div class="space-y-2">
              <h3
                class="text-xs font-bold uppercase border-b border-[#808080] pb-1"
              >
                Enroll in Seminar (Address Book)
              </h3>
              <div id="shop-seminars" class="space-y-2"></div>
            </div>
            <!-- Signatures -->
            <div class="space-y-2">
              <h3
                class="text-xs font-bold uppercase border-b border-[#808080] pb-1"
              >
                Update Email Signature
              </h3>
              <div id="shop-signatures" class="space-y-2"></div>
            </div>
            <!-- Salutations -->
            <div class="space-y-2">
              <h3
                class="text-xs font-bold uppercase border-b border-[#808080] pb-1"
              >
                Select Salutation
              </h3>
              <div id="shop-salutations" class="space-y-2"></div>
            </div>
            <!-- Sign-offs -->
            <div class="space-y-2">
              <h3
                class="text-xs font-bold uppercase border-b border-[#808080] pb-1"
              >
                Select Sign-off
              </h3>
              <div id="shop-signoffs" class="space-y-2"></div>
            </div>
            <!-- Self Promotion -->
            <div class="space-y-2">
              <h3
                class="text-xs font-bold uppercase border-b border-[#808080] pb-1"
              >
                Self-Promotion (Stats)
              </h3>
              <div id="shop-promotions" class="space-y-2"></div>
            </div>
            <!-- Help Desk (BCCs) -->
            <div class="space-y-2">
              <h3
                class="text-xs font-bold uppercase border-b border-[#808080] pb-1"
              >
                Help Desk Contacts (BCCs)
              </h3>
              <div id="shop-bccs" class="space-y-2"></div>
            </div>
          </div>
        </div>
        <div
          class="bg-[#dfdfdf] border-t border-[#808080] p-2 text-[10px] text-center italic text-gray-600 shrink-0"
        >
          Corporate policy: All purchases are final and non-refundable.
        </div>
      </div>
    </div>

    <!-- LOSE SCREEN (Termination Notice) -->
    <div
      id="lose-screen"
      class="hidden fixed inset-0 z-[150] bg-black flex items-center justify-center p-4"
    >
      <div
        class="bg-[#c0c0c0] retro-border max-w-sm w-full shadow-2xl overflow-hidden"
      >
        <div
          class="bg-red-800 text-white px-2 py-1 flex justify-between items-center text-xs font-bold"
        >
          <span>SYSTEM LOCKOUT - SECURITY BREACH</span>
          <span>✕</span>
        </div>
        <div class="p-6 flex flex-col items-center">
          <div
            class="w-16 h-16 bg-red-600 retro-border flex items-center justify-center mb-6"
          >
            <svg
              class="w-10 h-10 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              ></path>
            </svg>
          </div>

          <h2 class="text-2xl font-bold terminal-font mb-4 text-red-800">
            NOTICE OF TERMINATION
          </h2>

          <div
            class="w-full bg-white retro-border-inset p-4 space-y-3 text-[11px] mb-6 leading-tight"
          >
            <p class="font-bold text-center border-b pb-2 mb-2">
              Final Employee Records
            </p>
            <div class="flex justify-between">
              <span class="text-gray-500 uppercase">Final Title:</span>
              <span id="lose-title" class="font-bold">Cubicle Resident</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500 uppercase">Period:</span>
              <span id="lose-period" class="font-bold">Q3 - Year 1</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500 uppercase">Total Reputation:</span>
              <span id="lose-total-rep" class="font-bold">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500 uppercase">Address Book:</span>
              <span id="lose-contacts" class="font-bold">0 Contacts</span>
            </div>
          </div>

          <div
            class="text-[12px] text-center italic text-gray-800 px-2 leading-relaxed"
          >
            "Credibility is of utmost importance for ECO staff. As a result of
            correspondence recently brought to our attention, your role here has
            come to an end."
          </div>

          <div
            class="mt-8 text-[10px] text-gray-500 uppercase tracking-widest animate-pulse"
          >
            Access Revoked. See Security.
          </div>
        </div>
      </div>
    </div>

    <!-- PROMOTION SCREEN -->
    <div
      id="promotion-screen"
      class="hidden fixed inset-0 z-[140] bg-white flex items-center justify-center p-8 overflow-y-auto"
    >
      <div
        class="max-w-xl w-full border-8 border-double border-gray-300 p-8 flex flex-col items-center bg-[#fffcf0] shadow-xl relative"
      >
        <div class="absolute top-4 right-4 text-xs font-mono text-gray-400">
          INTERNAL MEMO #882-B
        </div>
        <div class="text-3xl font-serif font-bold text-[#000080] mb-2">
          OFFICE OF THE DIRECTOR
        </div>
        <div class="w-full border-b-2 border-[#000080] mb-8"></div>

        <h1
          class="text-4xl font-serif font-bold text-center mb-8 uppercase tracking-widest"
        >
          Notice of Promotion
        </h1>

        <p
          class="mb-4 text-lg leading-relaxed first-letter:text-5xl first-letter:font-bold first-letter:float-left first-letter:mr-2"
        >
          After a thorough review of your performance metrics during the
          previous fiscal quarters, the Board of Directors has approved your
          advancement within the organization.
        </p>

        <div
          class="my-8 text-center p-6 border-2 border-dashed border-[#000080] bg-blue-50 w-full"
        >
          <div class="text-sm font-bold uppercase text-gray-500 mb-1">
            New Assignment:
          </div>
          <div
            id="promotion-new-title"
            class="text-3xl font-bold text-[#000080] mb-4"
          >
            SENIOR OPERATIONS ANALYST
          </div>

          <div class="text-xs font-bold uppercase text-gray-500 mb-2">
            Acquired Executive Perks:
          </div>
          <div id="promotion-perks" class="text-sm italic text-gray-700">
            +1 Signature Slot, +5 Base Damage
          </div>
        </div>

        <p class="mb-12 text-center text-gray-600 italic">
          "Efficiency is its own reward."
        </p>

        <button
          onclick="advanceToNextQuarter()"
          class="px-12 py-4 bg-[#000080] text-white font-bold hover:bg-blue-700 transition-colors shadow-lg"
        >
          ADVANCE TO NEXT QUARTER
        </button>

        <div class="mt-8 opacity-20 grayscale">
          <img
            src="https://api.placeholder.com/100/100"
            class="w-20 h-20"
            alt="Corporate Seal"
          />
        </div>
      </div>
    </div>

    <!-- START SCREEN -->
    <div
      id="start-screen"
      class="fixed inset-0 z-[100] flex items-center justify-center bg-[#008080] p-4"
    >
      <div class="bg-[#c0c0c0] p-4 retro-border max-w-sm w-full shadow-2xl">
        <div
          class="bg-[#000080] text-white px-2 py-1 mb-4 flex justify-between items-center text-xs"
        >
          <span>NEW USER SETUP</span>
          <span>✕</span>
        </div>
        <h1
          class="text-4xl font-bold mb-2 text-center terminal-font tracking-widest text-[#000080]"
        >
          REPLY ALL
        </h1>
        <p class="mb-4 text-[11px] text-center leading-tight italic">
          "The path to being at peace is long and full of micro-agressions."
        </p>

        <div class="space-y-3 mb-6">
          <div>
            <label class="block text-[10px] font-bold uppercase mb-1"
              >Full Name:</label
            >
            <input
              id="player-name-input"
              type="text"
              placeholder="eke vdh"
              class="w-full p-2 bg-white retro-border-inset outline-none text-sm"
            />
          </div>
          <div>
            <label class="block text-[10px] font-bold uppercase mb-1"
              >Email:</label
            >
            <div
              id="email-preview"
              class="text-[11px] font-mono text-gray-800 bg-white/50 p-2 border border-dotted border-gray-400"
            >
              ...
            </div>
          </div>
        </div>

        <button
          onclick="startGame()"
          class="w-full py-3 font-bold retro-button text-[#000080]"
        >
          LOG ON
        </button>
      </div>
    </div>

    <!-- MAIN GAME INTERFACE -->
    <div
      id="game-ui"
      class="hidden flex flex-col w-full h-full max-w-5xl bg-[#c0c0c0] retro-border overflow-hidden"
    >
      <div
        class="bg-[#000080] text-white p-1 flex justify-between items-center shrink-0"
      >
        <div class="flex items-center gap-2 px-1">
          <span id="game-header-subject" class="text-xs font-bold truncate"
            >Outlook Express - [RE: URGENT: Breakroom Smell]</span
          >
          <span
            id="game-quarter-display"
            class="text-[10px] bg-white text-blue-900 px-1 font-bold"
            >Q3 - YEAR 1</span
          >
        </div>
        <div class="flex gap-1 pr-1">
          <button
            class="w-4 h-4 bg-[#c0c0c0] border border-white text-black text-[10px] flex items-center justify-center"
          >
            _
          </button>
          <button
            class="w-4 h-4 bg-[#c0c0c0] border border-white text-black text-[10px] flex items-center justify-center"
          >
            X
          </button>
        </div>
      </div>

      <div
        class="flex gap-1 p-1 bg-[#c0c0c0] border-b border-[#808080] overflow-x-auto shrink-0 no-scrollbar"
      >
        <button
          class="retro-button text-[10px] font-bold flex items-center gap-1"
        >
          <svg
            class="w-3 h-3"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path d="M3 10l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V10z"></path>
          </svg>
          Inbox
        </button>
        <button class="retro-button text-[10px]">Mark as Read</button>
        <div class="flex-grow"></div>
        <div
          id="turn-clock"
          class="text-[10px] bg-white px-2 py-1 retro-border-inset font-mono"
        >
          09:00 AM
        </div>
      </div>

      <div class="flex flex-grow overflow-hidden relative">
        <div
          class="hidden md:flex w-48 bg-[#dfdfdf] border-r border-[#808080] flex-col shrink-0"
        >
          <div class="p-2 text-[10px] font-bold border-b border-[#808080]">
            Folders
          </div>
          <div class="p-2 space-y-1 text-[11px]">
            <div class="bg-blue-800 text-white px-1">Inbox (5)</div>
            <div class="px-1 text-gray-500">Promotions (3)</div>
            <div class="px-1">Sent Items</div>
            <div class="px-1">Deleted</div>
          </div>
        </div>

        <div class="flex-grow flex flex-col bg-white overflow-hidden">
          <!-- Bureaucratic Header -->
          <div
            class="p-2 bg-[#f0f0f0] border-b border-[#808080] text-[10px] shrink-0 space-y-1"
          >
            <div class="flex items-center gap-2">
              <span class="font-bold w-12 text-right">To:</span>
              <div
                id="target-selector"
                class="flex gap-1 overflow-x-auto no-scrollbar py-0.5"
              ></div>
            </div>
            <div class="flex gap-2 items-center" id="active-ccs">
              <span class="font-bold w-12 text-right">CC:</span>
              <div id="cc-display" class="flex gap-1 text-gray-400 italic">
                No one in loop.
              </div>
            </div>
          </div>

          <!-- Message Log -->
          <div
            id="message-log"
            class="flex-grow overflow-y-auto p-3 space-y-6 scroll-container bg-white font-sans text-sm"
          ></div>

          <!-- STATS BAR -->
          <div
            class="bg-[#dfdfdf] border-t border-[#808080] px-2 py-1.5 flex flex-col gap-1 shrink-0"
          >
            <div class="flex justify-between items-end">
              <span class="text-[9px] font-bold uppercase text-[#000080]"
                >Professional Credibility</span
              >
              <span id="player-hp-label" class="text-[9px] font-mono font-bold"
                >100/100</span
              >
            </div>
            <div class="h-3.5 w-full bg-white border border-[#808080] relative">
              <div
                id="player-hp-fill"
                class="h-full bg-green-500 transition-all duration-300"
                style="width: 100%"
              ></div>
            </div>
            <div class="flex justify-between items-center mt-0.5">
              <div class="flex gap-3">
                <div class="flex items-center gap-1">
                  <span class="text-[8px] font-bold uppercase opacity-60"
                    >Leverage:</span
                  >
                  <div class="w-16 h-1.5 bg-white border border-[#808080]">
                    <div
                      id="player-ult-fill"
                      class="h-full bg-yellow-400 transition-all"
                      style="width: 0%"
                    ></div>
                  </div>
                </div>
              </div>
              <div
                id="player-win-status"
                class="text-[8px] font-bold bg-[#c0c0c0] px-1 border border-inset border-white uppercase"
              >
                New Wins: 3 Available
              </div>
            </div>
          </div>

          <!-- Action Panel -->
          <div class="p-2 bg-[#c0c0c0] border-t-2 border-white shrink-0">
            <div class="grid grid-cols-3 gap-1.5 max-w-lg mx-auto">
              <button
                onclick="performAction('ATTACK')"
                class="retro-button py-2 flex flex-col items-center"
              >
                <span class="text-[11px] font-bold">Reply to</span>
                <span id="attack-subtext" class="text-[8px] opacity-70 italic"
                  >Target Reply</span
                >
              </button>
              <button
                onclick="performAction('ESCALATE')"
                class="retro-button py-2 flex flex-col items-center"
              >
                <span class="text-[11px] font-bold">Escalate</span>
                <span id="escalate-subtext" class="text-[8px] opacity-70 italic"
                  >Threadwide Nudge</span
                >
              </button>
              <button
                onclick="openAddressBook()"
                class="retro-button py-2 flex flex-col items-center"
              >
                <span class="text-[11px] font-bold">Loop Personnel</span>
                <span id="loop-subtext" class="text-[8px] opacity-70 italic"
                  >Add Witness</span
                >
              </button>
              <button
                id="win-btn"
                onclick="performAction('PROMOTE')"
                class="retro-button py-2 flex flex-col items-center"
              >
                <span class="text-[11px] font-bold">Self-Promote</span>
                <span id="promote-subtext" class="text-[8px] opacity-70 italic"
                  >Log a Win</span
                >
              </button>
              <button
                onclick="performAction('DEFLECT')"
                class="retro-button py-2 flex flex-col items-center"
              >
                <span class="text-[11px] font-bold">Deflect</span>
                <span id="deflect-subtext" class="text-[8px] opacity-70 italic"
                  >Hold Line</span
                >
              </button>
              <button
                id="reply-all-btn"
                onclick="performAction('ULT')"
                class="retro-button py-2 flex flex-col items-center disabled:opacity-50"
                disabled
              >
                <span class="text-[11px] font-bold text-red-800"
                  >REPLY ALL</span
                >
                <span id="ult-subtext" class="text-[8px] opacity-70 italic"
                  >Mass Takedown</span
                >
              </button>
            </div>
          </div>

          <div
            class="bg-[#c0c0c0] border-t border-white px-1 flex gap-px text-[9px] h-5 shrink-0"
          >
            <div
              class="retro-border-inset px-2 flex items-center flex-grow truncate"
              id="status-bar-name"
            >
              Logged Out
            </div>
            <div
              class="retro-border-inset px-2 flex items-center w-24 justify-center"
              id="status-bar-email"
            >
              Online
            </div>
            <div
              class="retro-border-inset px-2 flex items-center w-12 justify-center"
            >
              NUM
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: ADDRESS BOOK -->
    <div
      id="address-book"
      class="fixed inset-0 z-[110] bg-black/50 items-center justify-center p-4 hidden flex"
    >
      <div class="bg-[#c0c0c0] retro-border w-full max-w-sm shadow-2xl">
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold"
        >
          <span id="address-book-title">PERSONNEL DIRECTORY</span>
          <button onclick="closeAddressBook()" class="px-1">✕</button>
        </div>
        <div
          id="contact-list"
          class="max-h-64 overflow-y-auto p-2 space-y-2 bg-white"
        ></div>
        <div class="p-2 flex justify-end bg-[#c0c0c0]">
          <button
            onclick="closeAddressBook()"
            class="retro-button text-xs px-4"
          >
            CANCEL
          </button>
        </div>
      </div>
    </div>
    <div
      id="cc-profile"
      class="fixed inset-0 z-[120] bg-black/50 items-center justify-center p-4 hidden flex"
    >
      <div class="bg-[#c0c0c0] retro-border w-full max-w-xs shadow-2xl">
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold"
        >
          <span id="cc-profile-title">CC Profile</span>
          <button onclick="closeCcProfile()" class="px-1">✕</button>
        </div>
        <div class="p-3 bg-white text-[11px] space-y-2">
          <div>
            <div class="font-bold text-[#000080]" id="cc-profile-name"></div>
            <div class="text-gray-600" id="cc-profile-role"></div>
          </div>
          <div class="text-gray-700" id="cc-profile-dept"></div>
          <div class="text-gray-700 italic" id="cc-profile-effect"></div>
        </div>
        <div class="p-2 flex justify-end bg-[#c0c0c0]">
          <button
            onclick="closeCcProfile()"
            class="retro-button text-xs px-4"
          >
            CLOSE
          </button>
        </div>
      </div>
    </div>

    <script>
      // --- GAME DATA ---

      const DEPARTMENTS = [
        { id: "operations", name: "Operations" },
        { id: "information_technology", name: "Information Technology" },
        { id: "executive_council_office", name: "Executive Council Office" },
        {
          id: "facilities_and_administration",
          name: "Facilities and Administration",
        },
        { id: "marketing", name: "Marketing" },
        { id: "constituent_services", name: "Constituent Services" },
        { id: "policy", name: "Policy" },
        { id: "finance", name: "Finance" },
        { id: "human_resources", name: "Human Resources" },
        { id: "legal", name: "Legal" },
        { id: "m4_agency", name: "M4 Agency" },
      ];

      const DEPARTMENT_BY_ID = Object.fromEntries(
        DEPARTMENTS.map((d) => [d.id, d]),
      );

      const CONTACTS = [
        {
          id: "cc_telly_operations",
          name: "Telly",
          title: "Intern",
          rarity: "common",
          departmentId: "operations",
          bonus: "+3 reply to dmg.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to generate a contact report for this thread.",
          eff: {
            singleDmgBonus: 3,
          },
          usedBy: null,
        },
        {
          id: "cc_willy_boy_information_technology",
          name: "Willy Boy",
          title: "IT Specialist",
          rarity: "common",
          departmentId: "information_technology",
          bonus: "+5 credibility/turn.",
          loopInText:
            "I'm looping in <strong>{name}</strong> because I think we need an {title} to help with the technical issues affecting others' replies in this thread.",
          eff: {
            heal: 5,
          },
          usedBy: null,
        },
        {
          id: "cc_colin_information_technology",
          name: "Colin",
          title: "IT Lead",
          rarity: "uncommon",
          departmentId: "information_technology",
          employeeId: "colin_information_technology",
          bonus: "Deflect +2.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to keep our technical support aligned and logged.",
          eff: {
            deflectBonus: 2,
          },
          usedBy: null,
        },
        {
          id: "cc_samantha_executive_council_office",
          name: "Samantha",
          title: "Director of Marketing",
          rarity: "uncommon",
          departmentId: "executive_council_office",
          employeeId: "samantha_executive_council_office",
          bonus: "Reduce incoming damage by 4.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to help frame this conversation around department wide resourcing.",
          eff: {
            defFlat: 4,
          },
          usedBy: null,
        },
        {
          id: "cc_tim_executive_council_office",
          name: "Tim",
          title: "Premier",
          rarity: "rare",
          departmentId: "executive_council_office",
          bonus: "2x Leverage gain.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to keep him in the loop on this initative.",
          eff: {
            lev: 2,
          },
          usedBy: null,
        },
        {
          id: "cc_nimby_facilities_and_administration",
          name: "Nimby",
          title: "Office Cat",
          rarity: "rare",
          departmentId: "facilities_and_administration",
          bonus: "35% Distraction chance.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to provide this thread more light-hearted content.",
          eff: {
            dodge: 0.35,
          },
          usedBy: null,
        },
        {
          id: "cc_lisa_marketing",
          name: "Lisa",
          title: "Director of Research",
          rarity: "uncommon",
          departmentId: "marketing",
          bonus: "+8 reply to dmg.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to provide data‑driven context and keep claims grounded.",
          eff: {
            singleDmgBonus: 8,
          },
          usedBy: null,
        },
        {
          id: "cc_meghan_cassedy_executive_council_office",
          name: "Meghan Cassedy",
          title: "Marketing Advisor",
          rarity: "uncommon",
          departmentId: "executive_council_office",
          bonus: "Reduce incoming damage by 5.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to advise on our tactical approach and reduce reputational risk.",
          eff: {
            defFlat: 5,
          },
          usedBy: null,
        },
        {
          id: "cc_larry_facilities_and_administration",
          name: "Larry",
          title: "Facilities Lead",
          rarity: "common",
          departmentId: "facilities_and_administration",
          bonus: "Reduce incoming damage by 2 & +3 Credibility/turn",
          loopInText:
            "I'm looping in <strong>{name}</strong> ({title}) to handle the facilities impact.",
          eff: {
            defFlat: 2,
            heal: 3,
          },
          usedBy: null,
        },
        {
          id: "cc_dave_constituent_services",
          name: "Dave",
          title: "Social Media Manager",
          rarity: "rare",
          departmentId: "constituent_services",
          bonus: "No combat bonus, but +4 REP if in loop at end of match.",
          loopInText:
            "I'm looping in <strong>{name}</strong> for awareness and to mitigate reputational risk if this thread leaks.",
          eff: {
            endRep: 4,
          },
          usedBy: null,
        },
        {
          id: "cc_gemma_policy",
          name: "Gemma",
          title: "Policy Analyst",
          rarity: "uncommon",
          departmentId: "policy",
          bonus: "Reduce incoming damage by 3.",
          loopInText:
            "I'm looping in <strong>{name}</strong> from {department} to ensure this stays within policy guardrails.",
          eff: {
            defFlat: 3,
          },
          usedBy: null,
        },
        {
          id: "cc_adam_finance",
          name: "Adam",
          title: "Budget Controller",
          rarity: "uncommon",
          departmentId: "finance",
          bonus: "+5 Max Credibility and +5 Credibility/turn.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to track fiscal impact against budgetary constraints and keep the numbers straight.",
          eff: {
            hpBonus: 5,
            heal: 5,
          },
          usedBy: null,
        },
        {
          id: "cc_rowan_constituent_services",
          name: "Rowan",
          title: "Public Liaison",
          rarity: "rare",
          departmentId: "constituent_services",
          bonus: "+5 reply to dmg and +1 REP if in loop at end of match.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to handle external messaging and stakeholder optics.",
          eff: {
            singleDmgBonus: 5,
            endRep: 1,
          },
          usedBy: null,
        },
      ];

      const TITLES = [
        {
          name: "Cubicle Resident",
          id: "cubicle_resident",
          level: 1,
          addressLimit: 5,
          sigLimit: 2,
          hpBonus: 0,
          singleDmgBonus: 0,
        },
        {
          name: "Junior Clerk",
          id: "junior_clerk",
          level: 2,
          addressLimit: 7,
          sigLimit: 4,
          hpBonus: 10,
          singleDmgBonus: 2,
        },
        {
          name: "Senior Clerk",
          id: "senior_clerk",
          level: 3,
          addressLimit: 9,
          sigLimit: 6,
          hpBonus: 20,
          singleDmgBonus: 4,
        },
        {
          name: "Program Coordinator",
          id: "program_coordinator",
          level: 4,
          addressLimit: 11,
          sigLimit: 8,
          hpBonus: 30,
          singleDmgBonus: 6,
        },
        {
          name: "Assistant Director",
          id: "assistant_director",
          level: 5,
          addressLimit: 13,
          sigLimit: 10,
          hpBonus: 40,
          singleDmgBonus: 8,
        },
        {
          name: "Deputy Director",
          id: "deputy_director",
          level: 6,
          addressLimit: 15,
          sigLimit: 11,
          hpBonus: 50,
          singleDmgBonus: 10,
        },
        {
          name: "Director",
          id: "director",
          level: 7,
          addressLimit: 17,
          sigLimit: 12,
          hpBonus: 60,
          singleDmgBonus: 12,
        },
        {
          name: "Deputy Director",
          id: "deputy_director",
          level: 8,
          addressLimit: 20,
          sigLimit: 15,
          hpBonus: 70,
          singleDmgBonus: 14,
        }
      ];

      const SIGNATURES = [
        {
          id: "iphone",
          name: "Sent from my iPhone",
          bonus:
            "Gain 1 rep for each person who removes themselves that you did not instigate.",
          rarity: "common",
          repBonus: 1,
        },
        {
          id: "regards",
          name: "Kind Regards,",
          bonus: "Reduce incoming damage by 1.",
          rarity: "common",
          defFlat: 1,
        },
        {
          id: "per_my_last",
          name: "Per my last email,",
          bonus: "+10% reply to dmg.",
          rarity: "uncommon",
          singleDmgMult: 0.1,
        },
        {
          id: "best",
          name: "Best,",
          bonus: "Heal 2 HP every turn.",
          rarity: "uncommon",
          heal: 2,
        },
        {
          id: "thanks_advance",
          name: "Thanks in advance,",
          bonus: "50% chance to double leverage gain.",
          rarity: "rare",
          doubleLevChance: 0.5,
        },
        {
          id: "encrypted",
          name: "Sent from my encrypted workstation",
          bonus: "15% damage reduction.",
          rarity: "rare",
          def: 0.15,
        },
        {
          id: "environment_printing",
          name: "Please consider the environment before printing this email",
          bonus: "+1 Credibility/turn.",
          rarity: "uncommon",
          setId: "earth_set",
          heal: 1,
        },
        {
          id: "coffee_break",
          name: "Sent from the breakroom coffee line",
          bonus: "+2% leverage gain.",
          rarity: "common",
          setId: "coffee_lovers",
          levMult: 0.02,
        },
        {
          id: "double_espresso",
          name: "Powered by double espresso",
          bonus: "+1 reply to dmg.",
          rarity: "common",
          setId: "coffee_lovers",
          singleDmgBonus: 1,
        },
        {
          id: "disclaimer",
          name: "Standard Disclaimer Applied",
          bonus: "+10% reply to dmg.",
          rarity: "common",
          singleDmgMult: 0.1,
        },
        {
          id: "breakroom",
          name: "Sent from the breakroom",
          bonus: "+2 Credibility/turn.",
          rarity: "uncommon",
          heal: 2,
        },
      ];

      const SALUTATIONS = [
        {
          id: "hi_all",
          name: "Hi all,",
          bonus: "+10 Max Credibility",
          rarity: "common",
          hpBonus: 10,
        },
        {
          id: "team",
          name: "Team,",
          bonus: "+2 reply to dmg",
          rarity: "common",
          singleDmgBonus: 2,
        },
        {
          id: "colleagues",
          name: "Dear Colleagues,",
          bonus: "Deflect +1.",
          rarity: "uncommon",
          deflectBonus: 1,
        },
        {
          id: "everyone",
          name: "Everyone,",
          bonus: "+10% Leverage gain",
          rarity: "uncommon",
          levMult: 0.1,
        },
        {
          id: "formal",
          name: "To whom it may concern,",
          bonus: "+5 reply to dmg",
          rarity: "rare",
          singleDmgBonus: 5,
        },
        {
          id: "morning",
          name: "Good morning,",
          bonus: "+10 Max Credibility",
          rarity: "common",
          hpBonus: 10,
        },
        {
          id: "project_team",
          name: "To the Project Team,",
          bonus: "+2 reply to dmg",
          rarity: "common",
          singleDmgBonus: 2,
        },
        {
          id: "sustainability_team",
          name: "To the Sustainability Team,",
          bonus: "+1 all comms dmg.",
          rarity: "uncommon",
          setId: "earth_set",
          globalDmgBonus: 1,
        },
        {
          id: "greetings",
          name: "Greetings all,",
          bonus: "Deflect +1.",
          rarity: "uncommon",
          deflectBonus: 1,
        },
      ];

      const SIGNOFFS = [
        {
          id: "thanks",
          name: "Thanks,",
          bonus: "+10 Max Credibility",
          rarity: "common",
          hpBonus: 10,
        },
        {
          id: "cheers",
          name: "Cheers,",
          bonus: "+2 Credibility/turn",
          rarity: "common",
          heal: 2,
        },
        {
          id: "sincerely",
          name: "Sincerely,",
          bonus: "Deflect +2.",
          rarity: "uncommon",
          deflectBonus: 2,
        },
        {
          id: "best_regards",
          name: "Best Regards,",
          bonus: "+5 reply to dmg",
          rarity: "uncommon",
          singleDmgBonus: 5,
        },
        {
          id: "v_respectfully",
          name: "Very Respectfully,",
          bonus: "+20% Leverage gain",
          rarity: "rare",
          levMult: 0.2,
        },
        {
          id: "warmly",
          name: "Warmly,",
          bonus: "+10 Max Credibility",
          rarity: "common",
          hpBonus: 10,
        },
        {
          id: "solidarity",
          name: "In solidarity,",
          bonus: "+2 Credibility/turn",
          rarity: "common",
          heal: 2,
        },
        {
          id: "solidarity_earth",
          name: "In solidarity with the Earth",
          bonus: "Deflect +1.",
          rarity: "uncommon",
          setId: "earth_set",
          deflectBonus: 1,
        },
        {
          id: "best_wishes",
          name: "Best wishes,",
          bonus: "10% Leverage gain",
          rarity: "uncommon",
          levMult: 0.1,
        },
      ];

      const BCC_CONTACTS = [
        {
          id: "recall",
          name: "Recall Message",
          bonus: "Instantly stun current target for 1 turn.",
          rarity: "common",
          effect: "stun",
        },
        {
          id: "urgent",
          name: "Urgent Flag",
          bonus: "Next reply to deals 2x damage.",
          rarity: "uncommon",
          effect: "doubleDmg",
        },
        {
          id: "redirect",
          name: "Redirect Message",
          bonus: "Current target attacks another random opponent next turn.",
          rarity: "rare",
          effect: "redirect",
        },
      ];

      const SET_DEFS = [
        {
          id: "earth_set",
          name: "Sustainability Protocol",
          items: [
            { type: "salutation", id: "sustainability_team" },
            { type: "signoff", id: "solidarity_earth" },
            { type: "signature", id: "environment_printing" },
          ],
          effect: {
            bonusGlobalDmg: 1,
            deflectBonus: 1,
            escalateRecoverPerHit: 1,
          },
        },
        {
          id: "it_duo",
          name: "Infrastructure Coverage",
          items: [
            { type: "contact", id: "cc_willy_boy_information_technology" },
            { type: "contact", id: "cc_colin_information_technology" },
          ],
          effect: {
            replyDeptSplash: 2,
            followUpChance: 0.15,
          },
        },
        {
          id: "coffee_lovers",
          name: "Coffee Lovers",
          items: [
            { type: "signature", id: "coffee_break" },
            { type: "signature", id: "double_espresso" },
          ],
          effect: {
            bounceBase: 5,
          },
        },
      ];

      const EMPLOYEES = [
        {
          id: "karen_human_resources",
          name: "Karen (HR)",
          email: "k.smith@gov.org",
          departmentId: "human_resources",
          color: "text-purple-700",
          defeatMessage:
            "I am unsubscribing. I've documented the lack of professional decorum and will be following up with each of you individually. Regards.",
          selfPromote:
            "I've just updated the internal wiki with our new 'Efficiency Standards'. My contribution score is through the roof.",
          deflectLines: [
            "I'm pausing to document this thread before responding further.",
          ],
          lines: [
            {
              text: "Your recent breakroom habits suggest a lack of respect for shared departmental assets.",
              missionId: "microwave",
            },
            {
              text: "I noticed you haven't completed the mandatory 'Digital Hygiene' training module for this quarter.",
              missionId: null,
            },
            {
              text: "I have three disciplinary hearings today; this thread is a significant drain on my operational capacity.",
              missionId: null,
            },
            {
              text: "HR provides the framework for your employment; your contributions are currently being 're-evaluated'.",
              missionId: null,
            },
            {
              text: "Please review the updated 'Shared Space Etiquette' PDF attached to my signature.",
              missionId: null,
            },
            {
              text: "I'm scheduling a mandatory mediation session for the entire floor this Friday at 4:30 PM.",
              missionId: null,
            },
            {
              text: "Your tone in this thread has been noted and will be discussed during your next performance review.",
              missionId: null,
            },
            {
              text: "We have a zero-tolerance policy for passive-aggressive CC-ing. Please adhere to the chain of command.",
              missionId: null,
            },
            {
              text: "I've CC'd the Chief Wellness Officer to address the 'toxic environment' you're creating.",
              missionId: null,
            },
            {
              text: "Failure to identify the salmon-heater will result in a collective reduction of the 'Team Synergy' bonus.",
              missionId: "microwave",
            },
            {
              text: "I'm looking at the handbook right now, and you're in violation of Section 8.4: Olfactory Neutrality.",
              missionId: "microwave",
            },
            {
              text: "This 'Reply All' behavior is exactly why we can't have nice things, like the espresso machine I vetoed.",
              missionId: null,
            },
          ],
        },
        {
          id: "christina_policy",
          name: "Christina (Pol)",
          email: "c.policy@gov.org",
          departmentId: "policy",
          color: "text-blue-700",
          defeatMessage:
            "This thread has been archived for non-compliance. I am removing myself to draft a formal reprimand. Policy remains absolute.",
          selfPromote:
            "My compliance logs are spotless. I've even color-coded the mandatory reading list for next quarter.",
          deflectLines: [
            "I'm holding my response until this thread is properly documented.",
          ],
          lines: [
            {
              text: "Per Policy 402.b, all communal appliances are to be used for non-odorous items only. Refer to the compliance guide.",
              missionId: "microwave",
            },
            {
              text: "I'm currently drafting a memorandum on 'Shared Air Space Ethics'. This thread is a case study in non-compliance.",
              missionId: "microwave",
            },
            {
              text: "The Policy department ensures rules are followed. Your blatant disregard for the Microwave Protocol is being escalated.",
              missionId: "microwave",
            },
            {
              text: "I've reviewed the 2019 precedent for 'unauthorized seafood heating'. It didn't end well for the perpetrator.",
              missionId: "microwave",
            },
            {
              text: "If you had attended the 'Navigating the Breakroom' seminar, we wouldn't be having this conversation.",
              missionId: null,
            },
            {
              text: "I am CC-ing the Ethics Committee. This is the procedurally correct way to handle olfactory aggression.",
              missionId: "microwave",
            },
            {
              text: "Your response lacks the required 'Directive 9' formatting. Please resubmit using approved templates.",
              missionId: null,
            },
            {
              text: "We are evaluating the environmental impact of your lunch choices. Sustainability is a core pillar of our mission.",
              missionId: null,
            },
            {
              text: "Failure to comply with 'No Fish Friday' is a breach of department harmony. I'm noting this in the audit.",
              missionId: "microwave",
            },
            {
              text: "The data suggests a 98% probability that you are the source of the incident based on desk location.",
              missionId: null,
            },
            {
              text: "Please cease and desist from using 'Reply All' unless you are citing a specific governmental regulation.",
              missionId: null,
            },
            {
              text: "This thread is now under the jurisdiction of the Policy Oversight Division. Peer-review your next comment.",
              missionId: null,
            },
          ],
        },
        {
          id: "megan_legal",
          name: "Megan (Legal)",
          email: "m.compliance@gov.org",
          departmentId: "legal",
          color: "text-red-700",
          defeatMessage:
            "I cannot continue this conversation without a physical copy of the minutes in front of me. Unsubscribing.",
          selfPromote:
            "I've successfully digitized the 1998 archive. Legal integrity has never been higher.",
          deflectLines: [
            "Given the compliance implications, I'm pausing to document this thread properly before responding.",
          ],
          lines: [
            {
              text: "The lack of physical documentation is a direct violation of the 2004 Record Keeping Act.",
              missionId: "paper",
            },
            {
              text: "I've drafted a cease and desist regarding this rationing. I'll send it as soon as I can find a working printer.",
              missionId: "paper",
            },
            {
              text: "Your 'digital-only' proposal fails to meet the standards for admissible evidence in a council hearing.",
              missionId: "paper",
            },
            {
              text: "I'm flagging this thread for potential liability issues. We need paper trails, not email trails.",
              missionId: null,
            },
            {
              text: "Without a hard copy, this policy is effectively unenforceable. Please reconsider.",
              missionId: "paper",
            },
            {
              text: "This change will directly result in a loss of admissible evidence one deleted email at a time.",
              missionId: "paper",
            },
            {
              text: "Please confirm who authorized this change so Legal can document the decision trail.",
              missionId: null,
            },
            {
              text: "I'm adding a retention note here in case this thread is requested later.",
              missionId: null,
            },
          ],
        },
        {
          id: "colin_information_technology",
          name: "Colin (IT)",
          email: "c.it@gov.org",
          departmentId: "information_technology",
          color: "text-indigo-700",
          defeatMessage:
            "Server load from this thread is too high. I'm muting this. Try rebooting your attitude.",
          selfPromote:
            "I've optimized the email server's routing protocols. You're welcome for that 0.02ms latency improvement.",
          deflectLines: [
            "I'm pausing to log this incident before replying further.",
          ],
          lines: [
            {
              text: "Have you tried not printing every single cat meme you see? It's clogging the spooler and the budget.",
              missionId: "paper",
            },
            {
              text: "The 'Paperless Initiative' has been ready for three years. You're just afraid of PDFs.",
              missionId: "paper",
            },
            {
              text: "I'm seeing a lot of 'Printer Error' tickets from your floor. Maybe try putting paper in the tray?",
              missionId: "paper",
            },
            {
              text: "Your 'urgent' requests are being redirected to the /dev/null of my inbox.",
              missionId: null,
            },
            {
              text: "If it's not a PDF, it doesn't exist to me anymore.",
              missionId: null,
            },
            {
              text: "The budget for paper was redirected to upgrade the firewall you keep trying to bypass.",
              missionId: "paper",
            },
            {
              text: "Stop asking for 'digital paper'. It's called a screen. Use it.",
              missionId: "paper",
            },
            {
              text: "I've limited your mailbox size to 50MB until the paper crisis is resolved. Choose your replies wisely.",
              missionId: "paper",
            },
          ],
        },
        {
          id: "fraser_information_technology",
          name: "Fraser (IT?)",
          email: "f.it@gov.org",
          departmentId: "information_technology",
          color: "text-indigo-600",
          defeatMessage:
            "Too many emails. I've got a survey to send on how we should redesign a 10-column spreadsheet.",
          selfPromote:
            "I've successfully piloted the new 'Spreadsheet-as-a-Service' portal, with absolutely no feedback so far!",
          deflectLines: [
            "I'm documenting this thread before I reply.",
          ],
          signatures: [
            {
              name: "For IT support, contact Colin at c.it@gov.org",
            },
          ],
          lines: [
            {
              text: "I'm not sure why I'm on this thread. but once my spreadsheet tracker initiative is complete, it will resolve any issues no doubt.",
              missionId: null,
            },
            {
              text: "You used it last I think, you fix it.",
              missionId: "paper",
            },
            {
              text: "I recently got Adobe suite installed for the first time.",
              missionId: null,
            },
            {
              text: "I'm planning to be away next week, can you take this?",
              missionId: null,
            },
            {
              text: "I get one of the interns to print things for me, so I wouldn't know about this.",
              missionId: "paper",
            },
          ],
        },
        {
          id: "interns_human_resources",
          name: "HR Interns",
          email: "hr.interns@gov.org",
          departmentId: "human_resources",
          color: "text-blue-900 font-bold",
          salutation: {
            name: "To the Permanent Staff,",
          },
          signOff: {
            name: "The Intern Collective",
          },
          signatures: [
            {
              name: "Unpaid & Unappreciated",
            },
          ],
          defeatMessage:
            "The intern pool has been drained. We are collectively resigning to pursue opportunities in a less toxic environment.",
          selfPromote:
            "We've collectively achieved a 100% coffee-order accuracy rate today. Future leadership material right here.",
          deflectLines: [
            "We're pausing to record this exchange before responding.",
          ],
          lines: [
            {
              text: "We've been CC'd on the entire thread and we're documenting everything for our final reports.",
              missionId: null,
            },
            {
              text: "Our collective research suggests that fish-microwaving is the #1 cause of decreased morale.",
              missionId: "microwave",
            },
            {
              text: "We've been instructed to flag any 'non-synergetic' behavior. This thread is 100% flaggable.",
              missionId: null,
            },
            {
              text: "As the future of this department, we demand a higher standard of digital decorum.",
              missionId: null,
            },
          ],
        },
        {
          id: "sheila_finance",
          name: "Sheila (Payroll)",
          email: "s.payroll@gov.org",
          departmentId: "finance",
          color: "text-green-700",
          salutation: {
            name: "Dear All,",
          },
          signOff: {
            name: "Best, Sheila",
          },
          defeatMessage:
            "I'm freezing all stipend payments until this thread is resolved. I'm out.",
          selfPromote:
            "I've reconciled the petty cash for the third time this morning. Every cent is accounted for.",
          deflectLines: [
            "I'm pausing to review the compliance implications before responding.",
          ],
          lines: [
            {
              text: "Your overtime request for 'email management' has been denied. Stick to the mission.",
              missionId: null,
            },
            {
              text: "I'm reviewing the cost-benefit analysis of your participation in this thread. It's not looking good.",
              missionId: null,
            },
            {
              text: "Every 'Reply All' costs the department approximately $4.12 in lost productivity. You've cost us a fortune today.",
              missionId: null,
            },
            {
              text: "Please refer to the payroll schedule before complaining about your 'emotional labor'.",
              missionId: "intern_grievance",
            },
          ],
        },
        {
          id: "samantha_executive_council_office",
          name: "Samantha (ECO)",
          email: "s.eco@gov.org",
          departmentId: "executive_council_office",
          color: "text-orange-700",
          defeatMessage:
            "I'm escalating this to the Deputy Director. I don't have time for intern drama.",
          selfPromote:
            "My latest 'Synergy Memo' has been read by 12% of the staff. Engagement is skyrocketing.",
          deflectLines: [
            "I'm holding response until I've logged this thread.",
          ],
          lines: [
            {
              text: "I don't see how this is relevant to me. This thread is a distraction.",
              missionId: null,
            },
            {
              text: "We need to 'lean in' to a more positive approach. Your tone has been very 'lean out'.",
              missionId: null,
            },
            {
              text: "I'm scheduling a sync-up to discuss if you'd ACTUALLY want my job.",
              missionId: null,
            },
            {
              text: "I'm taking this offline. And by offline, I mean I'm deleting your replies.",
              missionId: null,
            },
          ],
        },
        {
          id: "anneke_executive_council_office",
          name: "Anneke VDH (ECO)",
          email: "anneke.eco@gov.org",
          departmentId: "executive_council_office",
          color: "text-red-900",
          defeatMessage:
            "You know what? I'll leave this to the pipsqueaks. I'm out.",
          selfPromote:
            "I've managed to keep my 'Important' folder under 500 unread messages. Peak organizational skills.",
          deflectLines: [
            "I'm documenting this thread before I respond.",
          ],
          lines: [
            {
              text: "I think your latest reply violates the 'Civility in Digital Spaces' directive.",
              missionId: null,
            },
            {
              text: "I'm nude!",
              missionId: null,
            },
            {
              text: "I'm auditing this thread for potential FOIA requests. Mind your words.",
              missionId: null,
            },
            {
              text: "Regulatory standards require a 24-hour cooling-off period after a 'Reply All' incident. You ignored it.",
              missionId: null,
            },
            {
              text: "I've flagged this thread to the Auditor General. Good luck at the hearing.",
              missionId: null,
            },
            {
              text: "I'm at peace.",
              missionId: null,
            },
            {
              text: "I walk both the righteous path and my dog poopus.",
              missionId: null,
            },
          ],
        },
        {
          id: "selina_m4_agency",
          name: "Selina",
          email: "selina@m4agency.com",
          departmentId: "m4_agency",
          color: "#F08080",
          defeatMessage:
            "I just need 5 minutes to recalibrate my bandwidth. Then I'll circle back to this deliverable.",
          selfPromote:
            "I've reallocated my weekend to meet a deadline that is unrealistic at best for the fourth time this month.",
          deflectLines: [
            "I'm pausing to capture the record before responding.",
          ],
          lines: [
            {
              text: "Thanks for dropping this onto my plate. I'll just need to deprioritize sleep to action this immediately.",
              missionId: null,
            },
            {
              text: "I'm already operating at 150% billable time, but I will leverage my personal discretionary time to ensure we get through this again.",
              missionId: null,
            },
            {
              text: "Consider it done, though I should note this requires a significant expenditure of good faith that we won't need to stretch like this again in the future.",
              missionId: null,
            },
            {
              text: "Yes, I heard it was urgent. That's why I haven't left my desk since Tuesday. You're welcome.",
              missionId: null,
            },
            {
              text: "My current workload directly correlate with my projected last day.",
              missionId: null,
            },
            {
              text: "Which one of you fucks is wearing cologne?",
              missionId: null,
            },
          ],
        },
        {
          id: "taz_m4_agency",
          name: "Taz",
          email: "taz@m4agency.com",
          departmentId: "m4_agency",
          color: "#1B4F72",
          defeatMessage:
            "Look, okay, I'll reassess our current fee structure and see what we can do this time. But honestly, we'll be losing money on this..",
          selfPromote:
            "Yes, we cost a little more, but we always deliver something. In this market that goes a long way.",
          deflectLines: [
            "I'm holding response while I document this thread.",
          ],
          lines: [
            {
              text: "For this project to remain profitable, we're going to need you to approve a 10% mark-up on hard costs. Don't worry; it's strictly about cost predictability.",
              missionId: null,
            },
            {
              text: "Committing to hard dates at this stage is tough without budgetary approval. What do you say to a $20,000/mo retainer, plus hourly on top?",
              missionId: null,
            },
            {
              text: "These deliverables all sit firmly outside our current scope of work. We're going to need to reopen the conversation around billables if you want any adjustment.",
              missionId: null,
            },
            {
              text: "Look, as Elon says, 'your margin is my opportunity,' so pay up.",
              missionId: null,
            },
            {
              text: "Honestly Trump isn't that bad. SJW's are far worse for democracy.... What were we talking about again?",
              missionId: null,
            },
          ],
        },
        {
          id: "anthony_m4_agency",
          name: "Anthony",
          email: "anthony@m4agency.com",
          departmentId: "m4_agency",
          color: "#D3D3D3",
          defeatMessage:
            "While the current campaign metrics may appear suboptimal, they reflect an aggressive dedication to boundary testing. Frankly, the complexity of dealing with these minor budgetary concerns pales in comparison to the critical decisions my parents face daily in the OR.",
          selfPromote:
            "I've recently taken a medically valid and proactive approach to budget reallocation that was informed by an innate understanding of high-pressure environments, a skillset inherited genetically from my parents, who are both doctors.",
          deflectLines: [
            "I'm pausing to document this exchange before I reply.",
          ],
          lines: [
            {
              text: "I’m not seeing a fundamental systemic misalignment; merely a highly granular optimization phase. Horses very likely get measles, this was the right call.",
              missionId: "M015_MediaCrisis",
            },
            {
              text: "Are we sure these KPI targets are clinically validated? Because my father, the specialist, insists on evidence-based methodologies.",
              missionId: null,
            },
            {
              text: "The reason the campaigns aren't 'live' is that I'm implementing a proprietary soft-launch methodology. It’s highly technical. My mother, the head of cardiology, says I have a gift for complexity.",
              missionId: "M015_MediaCrisis",
            },
            {
              text: "We need to operationalize a full post-mortem review of this meeting, but let’s be brief. I have to go pick up my father to bring him to the hospital—they really need him there.",
              missionId: null,
            },
            {
              text: "My MTEI coursework explicitly covered why we shouldn't be revisiting foundational intake processes, but I suppose we can file the exception anyway.",
              missionId: null,
            },
            {
              text: "My MTEI curriculum was explicitly structured to prioritize demonstrable scalability over abstract alignment workshops; I'll wait for the deliverable checklist.",
              missionId: null,
            },
          ],
        },
      ];

      const MISSIONS = [
        {
          id: "microwave",
          subject: "URGENT: Breakroom Incident",
          from: "HR.Director",
          intro:
            "Hi team,<br><br>I am absolutely disgusted. Someone heated up fish in the breakroom microwave. <strong>{playerName}</strong>, I'm sure you noticed the stench. <strong>{opp1}</strong>, I know you have the policy manual out already. <strong>{opp0}</strong>, please document this.<br><br>Please advise immediately on who is responsible for this violation of shared space ethics.",
          opponents: [
            {
              id: 1,
              employeeId: "karen_human_resources",
              hp: 40,
              maxHp: 40,
              wins: 1,
              buffs: [],
              addressBook: ["cc_telly_operations"],
            },
            {
              id: 2,
              employeeId: "christina_policy",
              hp: 40,
              maxHp: 40,
              wins: 2,
              buffs: [],
              addressBook: ["cc_samantha_executive_council_office"],
            },
          ],
        },
        {
          id: "paper",
          subject: "CRITICAL: Departmental Paper Rationing",
          from: "Facilities.Admin",
          intro:
            "Dear Staff,<br><br>Due to unforeseen budget constraints, we are implementing immediate paper rationing. <strong>{playerName}</strong>, your department's printing logs are particularly high. <strong>Megan</strong>, please ensure we are still meeting filing requirements. <strong>Colin</strong>, please expedite the 'Paperless Initiative'.<br><br>Effective immediately, all non-essential printing is strictly prohibited.",
          opponents: [
            {
              id: 3,
              employeeId: "megan_legal",
              hp: 60,
              maxHp: 60,
              wins: 3,
              buffs: [],
              addressBook: ["cc_samantha_executive_council_office"],
            },
            {
              id: 4,
              employeeId: "colin_information_technology",
              hp: 50,
              maxHp: 50,
              wins: 3,
              buffs: [],
              addressBook: ["cc_willy_boy_information_technology"],
            },
            {
              id: 44,
              employeeId: "fraser_information_technology",
              hp: 30,
              maxHp: 30,
              wins: 3,
              buffs: [],
              addressBook: ["cc_willy_boy_information_technology"],
            },
          ],
        },
        {
          id: "intern_grievance",
          subject: "RE: Intern Grievance Collective",
          from: "HR.Interns",
          intro:
            "To the Permanent Staff,<br><br>We, the interns, have noticed a significant lack of 'Team Synergy' and 'Professional Courtesy'. <strong>{playerName}</strong>, your recent emails have been cited as 'aggressive'. <strong>Samantha</strong>, we are looping in our mentor <strong>Anneke</strong>. <strong>Shelia</strong>, we expect payroll to ensure our stipends to reflect the emotional labor of this thread.",
          opponents: [
            {
              id: 5,
              employeeId: "interns_human_resources",
              hp: 80,
              maxHp: 80,
              wins: 5,
              buffs: [],
              addressBook: ["cc_telly_operations"],
            },
            {
              id: 6,
              employeeId: "sheila_finance",
              hp: 70,
              maxHp: 70,
              wins: 2,
              buffs: [],
              addressBook: ["cc_meghan_cassedy_executive_council_office"],
            },
            {
              id: 7,
              employeeId: "samantha_executive_council_office",
              hp: 70,
              maxHp: 70,
              wins: 4,
              buffs: [],
              addressBook: ["cc_samantha_executive_council_office"],
            },
            {
              id: 8,
              employeeId: "anneke_executive_council_office",
              hp: 60,
              maxHp: 60,
              wins: 3,
              buffs: [],
              addressBook: ["cc_samantha_executive_council_office"],
            },
          ],
        },
        {
          id: "M015_MediaCrisis",
          subject: "CRITICAL: Budget Re-Forecasting & Ad Targeting Session",
          from: "Taz.M4Agency",
          intro:
            "Hey all,<br><br>There has been a <strong>significant overspend</strong> of the quarterly media budget earmarked for the strategic placement for the <strong>Measles Vaccination Initiative</strong>. During media plan implementation, an unforeseen configuration error on our end resulted in a demographic targeting misalignment—specifically, an overly focused optimization towards the <strong>equine sector</strong> executed entirely on day one. <strong>{playerName}</strong>, we need to leverage this emergency session to ensure continuity of service delivery.<br><strong>Selina</strong> and <strong>Anthony</strong> are here for support, and to use up our retainer. The objective is to devise a recovery plan that allows us to meet our six-week deliverable goals with additional budgetary approval, <strong>as the original $40,000 has been fully exhausted.</strong>",
          opponents: [
            {
              id: 1,
              employeeId: "selina_m4_agency",
              hp: 90,
              maxHp: 90,
              wins: 3,
              buffs: [],
              addressBook: ["cc_telly_operations"],
            },
            {
              id: 2,
              employeeId: "taz_m4_agency",
              hp: 80,
              maxHp: 80,
              wins: 3,
              buffs: [],
              addressBook: ["cc_samantha_executive_council_office"],
            },
            {
              id: 3,
              employeeId: "anthony_m4_agency",
              hp: 40,
              maxHp: 40,
              wins: 3,
              buffs: [],
              addressBook: ["cc_telly_operations"],
            },
          ],
        },
      ];

      let opponents = [];

      let state = {
        player: {
          name: "eke vdh",
          email: "eke.vdh@gov.org",
          hp: 50,
          maxHp: 50,
          ult: 0,
          wins: 3,
          buffs: [],
          reputation: 0,
          year: 1,
          quarter: "Q3",
          title: TITLES[0],
          addressBook: ["cc_telly_operations"],
          signatures: [],
          salutation: null,
          signOff: null,
          bccContacts: [],
          departmentId: "executive_council_office",
          baseDmgSingle: 10,
          baseDmgEscalate: 5,
          baseDmgReplyAll: 20,
          bonusSingleDmg: 0,
          bonusEscalateDmg: 0,
          bonusReplyAllDmg: 0,
          bonusGlobalDmg: 0,
          bonusSingleDmgMult: 0,
          bonusEscalateDmgMult: 0,
          bonusReplyAllDmgMult: 0,
          bonusGlobalDmgMult: 0,
          bonusMaxHp: 0,
          bonusWins: 0,
          deflectPower: 3,
          bonusDeflect: 0,
          deflectCharge: 0,
          followUpChance: 0,
          replyDeptSplash: 0,
          escalateRecoverPerHit: 0,
          attacks: [
            "I believe we need to circle back to your recent comments. My focus is on department output, and I suggest yours should be too.",
            "I've already addressed this in my previous email, but for the sake of clarity, I'll repeat it: This is not my responsibility.",
            "Perhaps we should focus on next quarters' deliverables instead of speculating on departmental policy?",
            "I'm happy to discuss this in a 1-on-1, but I don't believe this is a productive use of the 'All-Staff' distribution list.",
          ],
          attackLinesByMission: {},
          attackLinesByTitle: {},
          escalateLines: [
            "Given the lack of alignment here, I'm escalating this thread for broader visibility.",
            "I'm escalating this to keep all stakeholders aligned and reduce duplication.",
          ],
          deflectLines: [
            "I'm taking a moment to document this properly before responding further.",
            "Let's pause and keep the thread within scope. I'll respond once this is reframed.",
          ],
          selfPromoteLines: [
            "Just logging a new win—the quarterly audit came back clean under my supervision. Always happy to add value to the organization!",
          ],
          selfPromoteLinesByMission: {},
          selfPromoteLinesByTitle: {},
          replyAllLines: [
            {
              subject: "Fwd: Salary_Discrepancies_2024.xlsx",
              body: "Not sure if I should be sending this to everyone, but since transparency is one of our 'core values', here is the full salary spreadsheet for the department. Enjoy.",
            },
          ],
          replyAllLinesByMission: {},
          replyAllLinesByTitle: {},
        },
        currentMissionIndex: 0,
        targetId: 1,
        turn: 0,
        isProcessing: false,
        gameOver: false,
        removedByPlayer: 0,
        removedTotal: 0,
        shop: {
          seminars: [],
          signatures: [],
          salutations: [],
          signoffs: [],
          promotions: [],
          bccs: [],
        },
      };

      const nameInput = document.getElementById("player-name-input");
      const emailPreview = document.getElementById("email-preview");
      nameInput.addEventListener("input", (e) => {
        const val = e.target.value.trim() || "eke vdh";
        const email = val.toLowerCase().replace(/\s+/g, ".") + "@gov.org";
        emailPreview.innerText = email;
        state.player.email = email;
      });

      document.addEventListener("keydown", (e) => {
        if (e.key !== "0") return;
        const tag = document.activeElement && document.activeElement.tagName;
        if (tag === "INPUT" || tag === "TEXTAREA") return;
        state.player.bonusEscalateDmg += 100;
        state.player.reputation += 1000;
        updateUI();
        if (!document.getElementById("shop-screen").classList.contains("hidden"))
          updateShopUI();
        alert("Debug boost: +100 escalate dmg, +1000 REP.");
      });

      function transitionTo(screenId) {
        const screens = [
          "start-screen",
          "game-ui",
          "inbox-screen",
          "summary-screen",
          "shop-screen",
          "promotion-screen",
          "lose-screen",
        ];
        screens.forEach((s) => {
          const el = document.getElementById(s);
          if (el) el.classList.add("hidden");
        });
        const target = document.getElementById(screenId);
        if (target) target.classList.remove("hidden");
      }

      function startGame() {
        state.player.name = nameInput.value.trim() || "eke vdh";
        const email =
          state.player.name.toLowerCase().replace(/\s+/g, ".") + "@gov.org";
        state.player.email = email;
        document.getElementById("status-bar-email").innerText = "Online";
        showInbox();
      }

      function showInbox() {
        transitionTo("inbox-screen");
        const list = document.getElementById("inbox-list");
        list.innerHTML = "";

        const mission = MISSIONS[state.currentMissionIndex] || MISSIONS[0];

        // The battle email (At the top)
        const urgent = document.createElement("div");
        urgent.className =
          "grid grid-cols-12 p-2 border-b border-gray-100 bg-blue-50 cursor-pointer hover:bg-blue-200 font-bold border-l-4 border-l-blue-600";
        urgent.onclick = startQuarter;
        urgent.innerHTML = `<div class="col-span-1 text-red-600">!</div><div class="col-span-4 text-blue-800">${mission.from}</div><div class="col-span-7">${mission.subject}</div>`;
        list.appendChild(urgent);

        // Spam emails
        const spamSubjects = [
          "Hot Stocks!",
          "Refinance Now",
          "Enlarge your career",
          "Inheritance Notification",
          "Meeting?",
          "Action Required: Password Reset",
          "Last Chance: Office Supply Lottery",
          "Invoice Attached",
          "Team Lunch Sign-Up",
          "Weekly Pipeline Digest",
          "Travel Reimbursement Pending",
          "Urgent: Calendar Sync",
          "Wellness Survey Reminder",
          "FW: Please Review",
          "Recruitment Outreach",
          "Security Notice",
          "New Policy Update",
          "Printer Status Alert",
          "Quarterly Town Hall",
          "Zoom Recording Available",
        ];
        for (let i = 0; i < 16; i++) {
          const spam = document.createElement("div");
          spam.className =
            "grid grid-cols-12 p-2 border-b border-gray-100 bg-gray-50 text-gray-400 opacity-60";
          spam.innerHTML = `<div class="col-span-1"></div><div class="col-span-4 truncate">bot-${Math.random().toString(36).substr(2, 5)}@junk.co</div><div class="col-span-7 truncate">${spamSubjects[i % spamSubjects.length]}</div>`;
          list.appendChild(spam);
        }

        document.getElementById("inbox-status").innerText =
          `${324 + state.player.year * 4} Messages, 1 Unread`;
      }

      function getUnitMaxHp(u) {
        if (u.id === "player") {
          let max = 50 + u.title.hpBonus + u.bonusMaxHp;
          if (u.salutation && u.salutation.hpBonus) max += u.salutation.hpBonus;
          if (u.signOff && u.signOff.hpBonus) max += u.signOff.hpBonus;
          u.buffs.forEach((b) => {
            if (b.eff && b.eff.hpBonus) max += b.eff.hpBonus;
          });
          getUnitSetBonuses(u).forEach((b) => {
            if (b.hpBonus) max += b.hpBonus;
          });
          return max;
        }
        let max = u.maxHp;
        if (u.salutation && u.salutation.hpBonus) max += u.salutation.hpBonus;
        if (u.signOff && u.signOff.hpBonus) max += u.signOff.hpBonus;
        u.buffs.forEach((b) => {
          if (b.eff && b.eff.hpBonus) max += b.eff.hpBonus;
        });
        getUnitSetBonuses(u).forEach((b) => {
          if (b.hpBonus) max += b.hpBonus;
        });
        return max;
      }

      function applyUnitDefaults(u) {
        if (u.baseDmgSingle == null) u.baseDmgSingle = 10;
        if (u.baseDmgEscalate == null) u.baseDmgEscalate = 5;
        if (u.baseDmgReplyAll == null) u.baseDmgReplyAll = 20;
        if (u.bonusSingleDmg == null) u.bonusSingleDmg = 0;
        if (u.bonusEscalateDmg == null) u.bonusEscalateDmg = 0;
        if (u.bonusReplyAllDmg == null) u.bonusReplyAllDmg = 0;
        if (u.bonusGlobalDmg == null) u.bonusGlobalDmg = 0;
        if (u.bonusSingleDmgMult == null) u.bonusSingleDmgMult = 0;
        if (u.bonusEscalateDmgMult == null) u.bonusEscalateDmgMult = 0;
        if (u.bonusReplyAllDmgMult == null) u.bonusReplyAllDmgMult = 0;
        if (u.bonusGlobalDmgMult == null) u.bonusGlobalDmgMult = 0;
        if (u.deflectPower == null) u.deflectPower = 3;
        if (u.bonusDeflect == null) u.bonusDeflect = 0;
        if (u.deflectCharge == null) u.deflectCharge = 0;
        if (u.followUpChance == null) u.followUpChance = 0;
        if (u.replyDeptSplash == null) u.replyDeptSplash = 0;
        if (u.escalateRecoverPerHit == null) u.escalateRecoverPerHit = 0;
        if (!Array.isArray(u.deflectLines) || u.deflectLines.length === 0) {
          u.deflectLines = [
            "I'm pausing to document this thread before responding further.",
          ];
        }
      }

      function getUnitSetBonuses(u) {
        const bonuses = [];
        SET_DEFS.forEach((set) => {
          if (isSetActive(u, set)) bonuses.push(set.effect);
        });
        return bonuses;
      }

      function isSetActive(u, set) {
        if (!u || !set) return false;
        if (!Array.isArray(set.items) || set.items.length === 0) return false;
        const hasContact = (id) => {
          if (!Array.isArray(u.buffs)) return false;
          return u.buffs.some((b) => b.id === id);
        };
        const hasSignature = (id) => {
          if (!Array.isArray(u.signatures)) return false;
          return u.signatures.some((s) => s.id === id);
        };
        return set.items.every((item) => {
          if (!item || !item.type || !item.id) return false;
          if (item.type === "salutation")
            return u.salutation && u.salutation.id === item.id;
          if (item.type === "signoff")
            return u.signOff && u.signOff.id === item.id;
          if (item.type === "signature") return hasSignature(item.id);
          if (item.type === "contact") return hasContact(item.id);
          return false;
        });
      }

      function getUnitDeflectPower(u) {
        let power = u.deflectPower || 0;
        if (u.bonusDeflect) power += u.bonusDeflect;
        if (u.title && u.title.deflectBonus) power += u.title.deflectBonus;
        if (u.salutation && u.salutation.deflectBonus)
          power += u.salutation.deflectBonus;
        if (u.signOff && u.signOff.deflectBonus) power += u.signOff.deflectBonus;
        u.buffs.forEach((b) => {
          if (b.eff && b.eff.deflectBonus) power += b.eff.deflectBonus;
        });
        getUnitSetBonuses(u).forEach((b) => {
          if (b.deflectBonus) power += b.deflectBonus;
        });
        return power;
      }

      function getUnitTotalHeal(u) {
        let heal = 0;
        u.buffs.forEach((b) => {
          if (b.eff.heal) heal += b.eff.heal;
        });
        if (u.signatures)
          u.signatures.forEach((s) => {
            if (s.heal) heal += s.heal;
          });
        if (u.salutation && u.salutation.heal) heal += u.salutation.heal;
        if (u.signOff && u.signOff.heal) heal += u.signOff.heal;
        getUnitSetBonuses(u).forEach((b) => {
          if (b.heal) heal += b.heal;
        });
        return heal;
      }

      function getUnitDamage(u, type) {
        let base = 0;
        if (type === "single") base = u.baseDmgSingle ?? 10;
        else if (type === "escalate") base = u.baseDmgEscalate ?? 5;
        else base = u.baseDmgReplyAll ?? 20;

        let bonus = 0;
        if (u.bonusGlobalDmg) bonus += u.bonusGlobalDmg;
        if (type === "single" && u.bonusSingleDmg) bonus += u.bonusSingleDmg;
        if (type === "escalate" && u.bonusEscalateDmg)
          bonus += u.bonusEscalateDmg;
        if (type === "replyAll" && u.bonusReplyAllDmg)
          bonus += u.bonusReplyAllDmg;

        const addBonuses = (obj) => {
          if (!obj) return;
          if (obj.globalDmgBonus) bonus += obj.globalDmgBonus;
          if (obj.dmgBonus) bonus += obj.dmgBonus;
          if (obj.dmg) bonus += obj.dmg;
          if (type === "single" && obj.singleDmgBonus)
            bonus += obj.singleDmgBonus;
          if (type === "escalate" && obj.escalateDmgBonus)
            bonus += obj.escalateDmgBonus;
          if (type === "replyAll" && obj.replyAllDmgBonus)
            bonus += obj.replyAllDmgBonus;
        };

        if (u.title) addBonuses(u.title);
        if (u.salutation) addBonuses(u.salutation);
        if (u.signOff) addBonuses(u.signOff);
        u.buffs.forEach((b) => addBonuses(b.eff));
        getUnitSetBonuses(u).forEach((b) => addBonuses(b));

        let mult = 1;
        if (u.bonusGlobalDmgMult) mult += u.bonusGlobalDmgMult;
        if (type === "single" && u.bonusSingleDmgMult)
          mult += u.bonusSingleDmgMult;
        if (type === "escalate" && u.bonusEscalateDmgMult)
          mult += u.bonusEscalateDmgMult;
        if (type === "replyAll" && u.bonusReplyAllDmgMult)
          mult += u.bonusReplyAllDmgMult;

        const addMults = (obj) => {
          if (!obj) return;
          if (obj.globalDmgMult) mult += obj.globalDmgMult;
          if (obj.dmgMult) mult += obj.dmgMult;
          if (type === "single" && obj.singleDmgMult)
            mult += obj.singleDmgMult;
          if (type === "escalate" && obj.escalateDmgMult)
            mult += obj.escalateDmgMult;
          if (type === "replyAll" && obj.replyAllDmgMult)
            mult += obj.replyAllDmgMult;
        };

        if (u.signatures)
          u.signatures.forEach((s) => {
            addMults(s);
          });
        addMults(u.salutation);
        addMults(u.signOff);
        u.buffs.forEach((b) => addMults(b.eff));
        getUnitSetBonuses(u).forEach((b) => addMults(b));

        return (base + bonus) * mult;
      }

      function getUnitFlatDef(u) {
        let defFlat = 0;
        u.buffs.forEach((b) => {
          if (b.eff && b.eff.defFlat) defFlat += b.eff.defFlat;
        });
        if (u.signatures)
          u.signatures.forEach((s) => {
            if (s.defFlat) defFlat += s.defFlat;
          });
        if (u.salutation && u.salutation.defFlat) defFlat += u.salutation.defFlat;
        if (u.signOff && u.signOff.defFlat) defFlat += u.signOff.defFlat;
        getUnitSetBonuses(u).forEach((b) => {
          if (b.defFlat) defFlat += b.defFlat;
        });
        return defFlat;
      }

      function getUnitTotalDef(u) {
        let def = 0;
        u.buffs.forEach((b) => {
          if (b.eff.def) def += b.eff.def;
        });
        if (u.signatures)
          u.signatures.forEach((s) => {
            if (s.def) def += s.def;
          });
        if (u.salutation && u.salutation.def) def += u.salutation.def;
        if (u.signOff && u.signOff.def) def += u.signOff.def;
        getUnitSetBonuses(u).forEach((b) => {
          if (b.def) def += b.def;
        });
        return def;
      }

      function getUnitFollowUpChance(u) {
        let chance = u.followUpChance || 0;
        const addChance = (obj) => {
          if (!obj) return;
          if (obj.followUpChance) chance += obj.followUpChance;
        };
        addChance(u.title);
        addChance(u.salutation);
        addChance(u.signOff);
        if (u.signatures)
          u.signatures.forEach((s) => addChance(s));
        u.buffs.forEach((b) => addChance(b.eff));
        getUnitSetBonuses(u).forEach((b) => addChance(b));
        return Math.max(0, Math.min(1, chance));
      }

      function getUnitReplyDeptSplash(u) {
        let splash = u.replyDeptSplash || 0;
        const addSplash = (obj) => {
          if (!obj) return;
          if (obj.replyDeptSplash) splash += obj.replyDeptSplash;
        };
        addSplash(u.title);
        addSplash(u.salutation);
        addSplash(u.signOff);
        if (u.signatures)
          u.signatures.forEach((s) => addSplash(s));
        u.buffs.forEach((b) => addSplash(b.eff));
        getUnitSetBonuses(u).forEach((b) => addSplash(b));
        return splash;
      }

      function getUnitEscalateRecover(u) {
        let recover = u.escalateRecoverPerHit || 0;
        const addRecover = (obj) => {
          if (!obj) return;
          if (obj.escalateRecoverPerHit)
            recover += obj.escalateRecoverPerHit;
        };
        addRecover(u.title);
        addRecover(u.salutation);
        addRecover(u.signOff);
        if (u.signatures)
          u.signatures.forEach((s) => addRecover(s));
        u.buffs.forEach((b) => addRecover(b.eff));
        getUnitSetBonuses(u).forEach((b) => addRecover(b));
        return recover;
      }

      function getUnitGlobalDamageBonus(u) {
        let bonus = u.bonusGlobalDmg || 0;
        const addBonus = (obj) => {
          if (!obj) return;
          if (obj.globalDmgBonus) bonus += obj.globalDmgBonus;
        };
        addBonus(u.title);
        addBonus(u.salutation);
        addBonus(u.signOff);
        if (u.signatures) u.signatures.forEach((s) => addBonus(s));
        u.buffs.forEach((b) => addBonus(b.eff));
        getUnitSetBonuses(u).forEach((b) => addBonus(b));
        return bonus;
      }

      function getUnitGlobalDamageMult(u) {
        let mult = u.bonusGlobalDmgMult || 0;
        const addMult = (obj) => {
          if (!obj) return;
          if (obj.globalDmgMult) mult += obj.globalDmgMult;
        };
        addMult(u.title);
        addMult(u.salutation);
        addMult(u.signOff);
        if (u.signatures) u.signatures.forEach((s) => addMult(s));
        u.buffs.forEach((b) => addMult(b.eff));
        getUnitSetBonuses(u).forEach((b) => addMult(b));
        return mult;
      }

      function getUnitBounceDamage(u) {
        const base = getUnitSetBonuses(u).reduce(
          (acc, b) => acc + (b.bounceBase || 0),
          0,
        );
        if (!base) return 0;
        const bonus = getUnitGlobalDamageBonus(u);
        const mult = getUnitGlobalDamageMult(u);
        return Math.floor((base + bonus) * (1 + mult));
      }

      function pickBounceTarget(attacker, primaryTarget) {
        const units = [...opponents, state.player];
        const choices = units.filter(
          (u) => u && u.hp > 0 && u !== attacker && u !== primaryTarget,
        );
        return choices.length
          ? choices[Math.floor(Math.random() * choices.length)]
          : null;
      }

      function applyDamage(attacker, target, rawDamage) {
        let dmg = Math.max(0, Math.floor(rawDamage));
        const flatDef = getUnitFlatDef(target);
        dmg = Math.max(0, dmg - flatDef);
        let def = getUnitTotalDef(target);
        dmg = Math.floor(dmg * (1 - def));

        let blocked = 0;
        if (target.deflectCharge && target.deflectCharge > 0 && dmg > 0) {
          blocked = Math.min(target.deflectCharge, dmg);
          dmg -= blocked;
          target.deflectCharge = 0;
        }

        target.hp -= dmg;

        let reflected = 0;
        if (blocked > 0 && attacker) {
          reflected = blocked;
          if (attacker.id === "player") {
            state.player.hp -= reflected;
          } else if (attacker.hp != null) {
            attacker.hp -= reflected;
          }
        }

        return { dmg, blocked, reflected };
      }

      function applyDepartmentSplash(attacker, target, splashDamage) {
        if (!splashDamage || !target || !target.departmentId)
          return { total: 0, hits: 0 };
        const units = [...opponents, state.player];
        let total = 0;
        let hits = 0;
        units.forEach((u) => {
          if (!u || u.hp <= 0) return;
          if (u === target) return;
          if (attacker && u === attacker) return;
          if (u.departmentId !== target.departmentId) return;
          const result = applyDamage(attacker, u, splashDamage);
          total += result.dmg;
          hits += 1;
          if (u !== state.player && u.hp <= 0) {
            handleOpponentDefeat(u, attacker && attacker.id === "player");
          }
        });
        return { total, hits };
      }

      function isContactInLoop(contactId) {
        if (state.player.buffs.some((b) => b.id === contactId)) return true;
        for (const opp of opponents) {
          if (opp.buffs.some((b) => b.id === contactId)) return true;
        }
        return false;
      }

      function getPlayerLeverageGain(base) {
        const p = state.player;
        let mult = 1;
        if (p.buffs.find((b) => b.eff.lev)) mult *= 2;
        p.signatures.forEach((s) => {
          if (s.levMult) mult += s.levMult;
        });
        if (p.salutation && p.salutation.levMult) mult += p.salutation.levMult;
        if (p.signOff && p.signOff.levMult) mult += p.signOff.levMult;

        let gain = base * mult;
        p.signatures.forEach((s) => {
          if (s.doubleLevChance && Math.random() < s.doubleLevChance) gain *= 2;
        });
        return gain;
      }

      function formatMessageBody(sender, content) {
        let body = "";
        if (sender.salutation) {
          body += `<strong>${sender.salutation.name}</strong><br><br>`;
        }
        body += content;
        if (sender.signOff) {
          body += `<br><br><strong>${sender.signOff.name}</strong><br>${sender.name}`;
        } else {
          body += `<br><br>${sender.name}`;
        }
        if (sender.signatures && sender.signatures.length > 0) {
          sender.signatures.forEach((sig) => {
            body += `<div class="text-[10px] text-gray-500 border-t border-gray-200 mt-2 pt-1">-- ${sig.name}</div>`;
          });
        }
        return body;
      }

      function pickRandomItem(list, fallback) {
        if (!Array.isArray(list) || list.length === 0) return fallback;
        return list[Math.floor(Math.random() * list.length)];
      }

      function drawFromLineBag(holder, key, source, fallback) {
        if (!holder) return fallback;
        if (!holder._lineBags) holder._lineBags = {};
        let bag = holder._lineBags[key];
        if (!Array.isArray(bag) || bag.length === 0) {
          const fresh = Array.isArray(source) ? [...source] : [];
          if (fresh.length === 0) return fallback;
          bag = shuffle(fresh);
        }
        const next = bag.pop();
        holder._lineBags[key] = bag;
        return next == null ? fallback : next;
      }

      function getPlayerLineBagKey(action, missionId, titleId) {
        return `player:${action}:${missionId || "default"}:${titleId || "base"}`;
      }

      function getPlayerActionLines(action, missionId) {
        const p = state.player;
        const titleId = p.title ? p.title.id : null;
        const byMission = (p[`${action}LinesByMission`] || {})[missionId] || [];
        const byTitle = (p[`${action}LinesByTitle`] || {})[titleId] || [];
        let base = [];
        if (action === "attack") base = p.attacks || [];
        else if (action === "selfPromote") base = p.selfPromoteLines || [];
        else if (action === "replyAll") base = p.replyAllLines || [];
        else if (action === "escalate") base = p.escalateLines || [];
        else if (action === "deflect") base = p.deflectLines || [];
        return [...base, ...byMission, ...byTitle];
      }

      function getUnitSelfPromoteLines(unit) {
        if (Array.isArray(unit.selfPromoteLines) && unit.selfPromoteLines.length)
          return unit.selfPromoteLines;
        if (unit.selfPromote) return [unit.selfPromote];
        return [];
      }

      function getDepartmentName(departmentId) {
        if (!departmentId) return "";
        return DEPARTMENT_BY_ID[departmentId]?.name || departmentId;
      }

      function formatLoopInText(contact, fallback) {
        if (!contact || !contact.loopInText) return fallback;
        const departmentName = getDepartmentName(contact.departmentId);
        return contact.loopInText
          .replace(/{name}/g, contact.name || "")
          .replace(/{title}/g, contact.title || "")
          .replace(/{department}/g, departmentName);
      }

      function isContactImplicated(contact) {
        if (!contact || !contact.employeeId) return false;
        return opponents.some((o) => o.employeeId === contact.employeeId);
      }

      function openCcProfile(contact) {
        const deptName = getDepartmentName(contact.departmentId);
        document.getElementById("cc-profile-title").innerText = "CC Profile";
        document.getElementById("cc-profile-name").innerText = contact.name;
        document.getElementById("cc-profile-role").innerText = contact.title;
        document.getElementById("cc-profile-dept").innerText = deptName
          ? `Department: ${deptName}`
          : "Department: N/A";
        document.getElementById("cc-profile-effect").innerText =
          contact.bonus || "Effect: N/A";
        document.getElementById("cc-profile").classList.remove("hidden");
      }

      function closeCcProfile() {
        document.getElementById("cc-profile").classList.add("hidden");
      }

      function addContactBuff(target, contact, usedBy) {
        const buff = JSON.parse(JSON.stringify(contact));
        buff.usedBy = usedBy;
        target.buffs.push(buff);
        if (buff.eff && buff.eff.hpBonus) {
          target.hp = Math.min(getUnitMaxHp(target), target.hp + buff.eff.hpBonus);
        }
      }

      function startQuarter() {
        transitionTo("game-ui");
        state.gameOver = false;
        state.turn = 0;
        state.isProcessing = false;
        const p = state.player;
        applyUnitDefaults(p);
        p._lineBags = {};
        p.hp = getUnitMaxHp(p);
        p.ult = 0;
        p.wins = 3 + p.bonusWins;
        if (p.salutation && p.salutation.bonusWins)
          p.wins += p.salutation.bonusWins;
        if (p.signOff && p.signOff.bonusWins) p.wins += p.signOff.bonusWins;
        p.buffs = []; // Reset combat buffs
        p.deflectCharge = 0;

        // Reset global CONTACTS.usedBy
        CONTACTS.forEach((c) => (c.usedBy = null));

        const mission = MISSIONS[state.currentMissionIndex] || MISSIONS[0];

        // Assemble opponents from EMPLOYEES and mission-specific data
        opponents = mission.opponents.map((missionOpponent) => {
          const employee = EMPLOYEES.find(
            (e) => e.id === missionOpponent.employeeId,
          );
          const clone = {
            ...JSON.parse(JSON.stringify(employee)),
            ...JSON.parse(JSON.stringify(missionOpponent)),
          };
          applyUnitDefaults(clone);
          clone.employeeId = employee.id;
          clone.hp = clone.maxHp;
          clone.buffs = [];
          clone.deflectCharge = 0;
          clone._lineBags = {};
          // Filter lines based on missionId
          clone.attacks = employee.lines
            .filter((l) => l.missionId === null || l.missionId === mission.id)
            .map((l) => l.text);
          return clone;
        });

        state.removedTotal = opponents.length;
        state.removedByPlayer = 0;
        state.targetId = opponents[0].id;

        document.getElementById("message-log").innerHTML = "";
        document.getElementById("game-header-subject").innerText =
          `Outlook Express - [${mission.subject}]`;
        updateUI();

        // Templating the intro
        let introText = mission.intro;
        introText = introText.replace(/{playerName}/g, p.name);
        opponents.forEach((opp, idx) => {
          const regex = new RegExp(`{opp${idx}}`, "g");
          introText = introText.replace(regex, opp.name);
        });

        addEmailToLog(
          mission.from,
          "everyone@gov.org",
          mission.subject,
          introText,
          "border-l-4 border-blue-500 bg-blue-50",
        );
      }

      function generateShopItems() {
        // Seminars
        const availCCs = CONTACTS.filter(
          (c) => !state.player.addressBook.includes(c.id),
        );
        state.shop.seminars = shuffle([...availCCs])
          .slice(0, 2)
          .map((c) => ({ ...c, purchased: false }));

        // Signatures
        state.shop.signatures = shuffle([...SIGNATURES])
          .slice(0, 2)
          .map((s) => ({ ...s, purchased: false }));

        // Salutations
        state.shop.salutations = shuffle([...SALUTATIONS])
          .slice(0, 2)
          .map((s) => ({ ...s, purchased: false }));

        // Sign-offs
        state.shop.signoffs = shuffle([...SIGNOFFS])
          .slice(0, 2)
          .map((s) => ({ ...s, purchased: false }));

        // Promotions (Stats)
        const promoOptions = [
          {
            id: "dmg_single",
            name: "Targeted Push",
            bonus: "+2 reply to dmg",
            cost: 10,
            apply: () => {
              state.player.bonusSingleDmg += 2;
            },
          },
          {
            id: "dmg_escalate",
            name: "Escalation Training",
            bonus: "+2 escalate dmg",
            cost: 10,
            apply: () => {
              state.player.bonusEscalateDmg += 2;
            },
          },
          {
            id: "dmg_replyall",
            name: "Reply-All Mastery",
            bonus: "+3 reply all dmg",
            cost: 12,
            apply: () => {
              state.player.bonusReplyAllDmg += 3;
            },
          },
          {
            id: "dmg_global",
            name: "Agency-Wide Influence",
            bonus: "+1 all comms dmg",
            cost: 12,
            apply: () => {
              state.player.bonusGlobalDmg += 1;
            },
          },
          {
            id: "hp",
            name: "Resilience Training",
            bonus: "+5 Max Credibility",
            cost: 10,
            apply: () => {
              state.player.bonusMaxHp += 5;
            },
          },
          {
            id: "win",
            name: "Public Speaking",
            bonus: "+1 New Win/Round",
            cost: 10,
            apply: () => {
              state.player.bonusWins += 1;
            },
          },
          {
            id: "deflect",
            name: "Deflection Coaching",
            bonus: "+2 Deflect",
            cost: 10,
            apply: () => {
              state.player.bonusDeflect += 2;
            },
          },
        ];
        state.shop.promotions = shuffle([...promoOptions])
          .slice(0, 2)
          .map((p) => ({ ...p, purchased: false }));

        // BCCs
        state.shop.bccs = shuffle([...BCC_CONTACTS])
          .slice(0, 2)
          .map((b) => ({ ...b, purchased: false }));
      }

      function endQuarter() {
        state.isProcessing = true;
        generateShopItems();
        setTimeout(() => {
          transitionTo("summary-screen");
          const baseRepByQuarter = {
            Q3: 4,
            Q4: 5,
            Q2: 6,
            Q1: 8,
          };
          const baseRep =
            baseRepByQuarter[state.player.quarter] ?? baseRepByQuarter.Q3;
          const totalOptOutRep = state.removedByPlayer * 2;

          // Distribution
          const optOutList = document.getElementById("summary-optouts-list");
          optOutList.innerHTML = "";
          const playerKills = opponents.filter((o) => o.removedByPlayer);

          if (playerKills.length > 0) {
            optOutList.classList.remove("hidden");
            playerKills.forEach((o) => {
              const share = 2;
              const div = document.createElement("div");
              div.className =
                "flex justify-between text-[10px] text-gray-600 italic";
              div.innerHTML = `<span>Opt-out: ${o.name}</span><span>+${share}</span>`;
              optOutList.appendChild(div);
            });
          } else {
            optOutList.classList.add("hidden");
          }

          // Signature bonus
          let bonusRep = 0;
          state.player.signatures.forEach((sig) => {
            if (sig.repBonus) {
              bonusRep +=
                (state.removedTotal -
                  opponents.filter((o) => o.hp > 0).length -
                  state.removedByPlayer) *
                sig.repBonus;
            }
          });

          // CC bonus (Constituent Liaison)
          if (state.player.buffs.some((b) => b.eff && b.eff.endRep)) {
            bonusRep += 4;
          }

          const totalRep = baseRep + totalOptOutRep + bonusRep;
          state.player.reputation += totalRep;

          // Advance mission index
          state.currentMissionIndex =
            (state.currentMissionIndex + 1) % MISSIONS.length;

          document.getElementById("summary-base-rep").innerText = `+${baseRep}`;
          document.getElementById("summary-bonus-rep").innerText =
            `+${bonusRep}`;
          document.getElementById("summary-rep-earned").innerText =
            `+${totalRep}`;
        }, 4000);
      }

      function showShop() {
        transitionTo("shop-screen");
        updateShopUI();
      }

      function showLoseScreen() {
        const p = state.player;
        document.getElementById("lose-title").innerText = p.title.name;
        document.getElementById("lose-period").innerText =
          `${p.quarter} - Year ${p.year}`;
        document.getElementById("lose-total-rep").innerText = p.reputation;
        document.getElementById("lose-contacts").innerText =
          `${p.addressBook.length} Contacts`;
        transitionTo("lose-screen");
      }

      function advanceToNextQuarter() {
        const quarters = ["Q3", "Q4", "Q1", "Q2"];
        let idx = quarters.indexOf(state.player.quarter);
        idx = (idx + 1) % quarters.length;
        state.player.quarter = quarters[idx];

        if (state.player.quarter === "Q3") {
          state.player.year++;
        }

        if (state.player.quarter === "Q2") {
          showPromotion();
        } else {
          showInbox();
        }
      }

      function showPromotion() {
        // TODO - if max title reached, skip promotion
        if (state.player.year >= TITLES.length) {
          advanceToNextQuarter();
          return;
        }
        transitionTo("promotion-screen");

        // Determine next title by matching year
        let titleIdx = state.player.year;

        // Limit to max title
        const nextTitle = TITLES[titleIdx] || TITLES[TITLES.length - 1];
        state.player.title = nextTitle;

        document.getElementById("promotion-new-title").innerText =
          nextTitle.name;
        document.getElementById("promotion-perks").innerText =
          `+${nextTitle.hpBonus} HP, +${nextTitle.singleDmgBonus} reply to dmg, Limit: ${nextTitle.sigLimit} Sig, ${nextTitle.addressLimit} CCs`;
      }

      function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      function getRarityMeta(rarity) {
        const meta = {
          common: { label: "COMMON", className: "bg-gray-200 text-gray-700" },
          uncommon: {
            label: "UNCOMMON",
            className: "bg-emerald-100 text-emerald-700",
          },
          rare: { label: "RARE", className: "bg-amber-100 text-amber-700" },
        };
        return meta[rarity] || meta.common;
      }

      function formatRarityBadge(rarity) {
        const meta = getRarityMeta(rarity);
        return `<span class="text-[9px] uppercase px-1 py-0.5 rounded-sm ${meta.className}">${meta.label}</span>`;
      }

      function getItemCostByType(rarity, type) {
        const table = {
          contact: { common: 4, uncommon: 7, rare: 12 },
          signature: { common: 3, uncommon: 6, rare: 10 },
          salutation: { common: 3, uncommon: 6, rare: 10 },
          signoff: { common: 3, uncommon: 6, rare: 10 },
          bcc: { common: 2, uncommon: 3, rare: 5 },
        };
        const row = table[type] || table.contact;
        return row[rarity] ?? row.common;
      }

      function createShopCard(name, desc, cost, onBuy, options = {}) {
        const div = document.createElement("div");
        div.className = "p-2 bg-white retro-border flex flex-col gap-1";
        const canAfford = state.player.reputation >= cost;
        const purchased = options.purchased || false;
        const canBuy = options.canBuy ?? true;
        const badge = options.badge || "";
        const disabled = !canAfford || purchased || !canBuy;
        const label = purchased
          ? "OWNED"
          : !canBuy
            ? "MAKE SPACE"
            : "ACQUIRE";
        div.innerHTML = `
                <div class="flex justify-between font-bold text-[11px] gap-2">
                    <span class="truncate">${name}</span>
                    <span class="text-blue-700 font-mono">${purchased ? "ACQUIRED" : cost + " REP"}</span>
                </div>
                <div class="flex items-center gap-2 text-[9px]">${badge}</div>
                <div class="text-[10px] italic text-gray-600 leading-tight">${desc}</div>
                <button class="mt-1 retro-button text-[10px] font-bold py-1 ${disabled ? "opacity-50" : ""}" ${disabled ? "disabled" : ""}>
                    ${label}
                </button>
            `;
        if (!disabled)
          div.querySelector("button").onclick = () => {
            onBuy();
            updateShopUI();
          };
        return div;
      }

      function createOwnedRow(item, type, onSell) {
        const cost = getItemCostByType(item.rarity || "common", type);
        const refund = Math.floor(cost / 2);
        const div = document.createElement("div");
        div.className =
          "p-2 bg-white retro-border flex items-center justify-between gap-2";
        div.innerHTML = `
                <div class="flex flex-col gap-0.5">
                    <div class="flex items-center gap-2 text-[11px] font-bold">
                        <span>${item.name}</span>
                        ${formatRarityBadge(item.rarity)}
                    </div>
                    <div class="text-[10px] italic text-gray-600">${item.bonus || ""}</div>
                </div>
                <button class="retro-button text-[10px] px-2 py-1">SELL +${refund}</button>
            `;
        div.querySelector("button").onclick = () => {
          onSell(refund);
          updateShopUI();
        };
        return div;
      }

      function describeEffect(effect) {
        if (!effect) return "";
        const parts = [];
        if (effect.bonusGlobalDmg)
          parts.push(`+${effect.bonusGlobalDmg} all comms dmg`);
        if (effect.bonusSingleDmg)
          parts.push(`+${effect.bonusSingleDmg} reply to dmg`);
        if (effect.bonusEscalateDmg)
          parts.push(`+${effect.bonusEscalateDmg} escalate dmg`);
        if (effect.bonusReplyAllDmg)
          parts.push(`+${effect.bonusReplyAllDmg} reply all dmg`);
        if (effect.bonusGlobalDmgMult)
          parts.push(`+${Math.round(effect.bonusGlobalDmgMult * 100)}% all comms dmg`);
        if (effect.bonusSingleDmgMult)
          parts.push(`+${Math.round(effect.bonusSingleDmgMult * 100)}% reply to dmg`);
        if (effect.bonusEscalateDmgMult)
          parts.push(`+${Math.round(effect.bonusEscalateDmgMult * 100)}% escalate dmg`);
        if (effect.bonusReplyAllDmgMult)
          parts.push(`+${Math.round(effect.bonusReplyAllDmgMult * 100)}% reply all dmg`);
        if (effect.deflectBonus) parts.push(`Deflect +${effect.deflectBonus}`);
        if (effect.defFlat) parts.push(`Reduce damage by ${effect.defFlat}`);
        if (effect.followUpChance)
          parts.push(`Follow-up +${Math.round(effect.followUpChance * 100)}%`);
        if (effect.replyDeptSplash)
          parts.push(`Dept splash +${effect.replyDeptSplash}`);
        if (effect.escalateRecoverPerHit)
          parts.push(`Escalate recover +${effect.escalateRecoverPerHit}`);
        if (effect.heal) parts.push(`+${effect.heal} Cred/turn`);
        if (effect.bounceBase) parts.push(`Bounce +${effect.bounceBase} base`);
        return parts.join(", ");
      }

      function updateShopUI() {
        document.getElementById("shop-reputation-display").innerText =
          `REP: ${state.player.reputation}`;

        const setBox = document.getElementById("shop-set-bonuses");
        if (setBox) {
          const parts = [];
          parts.push(`<div class="text-[10px] font-bold uppercase text-gray-500 mb-1">Set Bonuses</div>`);
          SET_DEFS.forEach((set) => {
            const active = isSetActive(state.player, set);
            const missing = [];
            const reqParts = set.items.map((item) => {
              if (!item) return "";
              if (item.type === "salutation") {
                const sal = SALUTATIONS.find((s) => s.id === item.id);
                if (!state.player.salutation || state.player.salutation.id !== item.id)
                  missing.push(sal?.name || item.id);
                return sal?.name || item.id;
              }
              if (item.type === "signoff") {
                const off = SIGNOFFS.find((s) => s.id === item.id);
                if (!state.player.signOff || state.player.signOff.id !== item.id)
                  missing.push(off?.name || item.id);
                return off?.name || item.id;
              }
              if (item.type === "signature") {
                const sig = SIGNATURES.find((s) => s.id === item.id);
                if (!state.player.signatures.some((s) => s.id === item.id))
                  missing.push(sig?.name || item.id);
                return sig?.name || item.id;
              }
              if (item.type === "contact") {
                const c = CONTACTS.find((c) => c.id === item.id);
                return `${c?.name || item.id} (in loop)`;
              }
              return item.id;
            });
            const reqText = reqParts.filter(Boolean).join(" + ");
            parts.push(
              `<div class="text-[10px] ${active ? "text-emerald-700" : "text-gray-600"}">
                <strong>${set.name}</strong> — ${reqText}. ${describeEffect(set.effect)}
                ${active ? " (ACTIVE)" : missing.length ? ` (Missing: ${missing.join(", ")})` : ""}
              </div>`,
            );
          });
          setBox.innerHTML = parts.join("");
        }

        // Seminars
        const semList = document.getElementById("shop-seminars");
        semList.innerHTML = "";
        const semHeader = semList.previousElementSibling;
        semHeader.innerText = `Enroll in Seminar (Address Book: ${state.player.addressBook.length}/${state.player.title.addressLimit})`;

        const contactCurrent = document.createElement("div");
        contactCurrent.className = "space-y-1 mb-2";
        const contactTitle = document.createElement("div");
        contactTitle.className = "text-[10px] font-bold uppercase text-gray-500";
        contactTitle.innerText = "Current Contacts";
        contactCurrent.appendChild(contactTitle);
        if (state.player.addressBook.length === 0) {
          const none = document.createElement("div");
          none.className = "text-[10px] italic text-gray-400";
          none.innerText = "No contacts enrolled.";
          contactCurrent.appendChild(none);
        } else {
          state.player.addressBook.forEach((id) => {
            const c = CONTACTS.find((con) => con.id === id);
            if (!c) return;
            contactCurrent.appendChild(
              createOwnedRow(c, "contact", (refund) => {
                state.player.addressBook = state.player.addressBook.filter(
                  (cid) => cid !== id,
                );
                state.player.reputation += refund;
              }),
            );
          });
        }
        semList.appendChild(contactCurrent);

        state.shop.seminars.forEach((c) => {
          const cost = getItemCostByType(c.rarity, "contact");
          const owned = state.player.addressBook.includes(c.id);
          const hasSpace =
            state.player.addressBook.length < state.player.title.addressLimit;
          semList.appendChild(
            createShopCard(
              c.name,
              c.bonus,
              cost,
              () => {
                if (owned) return;
                if (!hasSpace) {
                  alert("Address book full. Sell a contact to make space.");
                  return;
                }
                state.player.reputation -= cost;
                state.player.addressBook.push(c.id);
                c.purchased = true;
              },
              {
                purchased: owned,
                canBuy: hasSpace,
                badge: formatRarityBadge(c.rarity),
              },
            ),
          );
        });

        // Signatures
        const sigList = document.getElementById("shop-signatures");
        sigList.innerHTML = "";
        const sigHeader = sigList.previousElementSibling;
        sigHeader.innerText = `Update Email Signature (${state.player.signatures.length}/${state.player.title.sigLimit})`;
        const sigCurrent = document.createElement("div");
        sigCurrent.className = "space-y-1 mb-2";
        const sigTitle = document.createElement("div");
        sigTitle.className = "text-[10px] font-bold uppercase text-gray-500";
        sigTitle.innerText = "Current Signatures";
        sigCurrent.appendChild(sigTitle);
        if (state.player.signatures.length === 0) {
          const none = document.createElement("div");
          none.className = "text-[10px] italic text-gray-400";
          none.innerText = "No signatures equipped.";
          sigCurrent.appendChild(none);
        } else {
          state.player.signatures.forEach((sig) => {
            sigCurrent.appendChild(
              createOwnedRow(sig, "signature", (refund) => {
                state.player.signatures = state.player.signatures.filter(
                  (s) => s.id !== sig.id,
                );
                state.player.reputation += refund;
              }),
            );
          });
        }
        sigList.appendChild(sigCurrent);

        state.shop.signatures.forEach((s) => {
          const cost = getItemCostByType(s.rarity, "signature");
          const owned = state.player.signatures.some((sig) => sig.id === s.id);
          const hasSpace =
            state.player.signatures.length < state.player.title.sigLimit;
          sigList.appendChild(
            createShopCard(
              s.name,
              s.bonus,
              cost,
              () => {
                if (owned) return;
                if (!hasSpace) {
                  alert("Signature slots full. Sell a signature to make space.");
                  return;
                }
                state.player.reputation -= cost;
                state.player.signatures.push(s);
                s.purchased = true;
              },
              {
                purchased: owned,
                canBuy: hasSpace,
                badge: formatRarityBadge(s.rarity),
              },
            ),
          );
        });

        // Salutations
        const salList = document.getElementById("shop-salutations");
        salList.innerHTML = "";
        const currentSalWrap = document.createElement("div");
        currentSalWrap.className = "space-y-1 mb-2";
        const salTitle = document.createElement("div");
        salTitle.className = "text-[10px] font-bold uppercase text-gray-500";
        salTitle.innerText = "Current Greeting";
        currentSalWrap.appendChild(salTitle);
        if (state.player.salutation) {
          currentSalWrap.appendChild(
            createOwnedRow(state.player.salutation, "salutation", (refund) => {
              state.player.salutation = null;
              state.player.reputation += refund;
            }),
          );
        } else {
          const none = document.createElement("div");
          none.className = "text-[10px] italic text-gray-400";
          none.innerText = "No greeting selected.";
          currentSalWrap.appendChild(none);
        }
        salList.appendChild(currentSalWrap);
        state.shop.salutations.forEach((s) => {
          const cost = getItemCostByType(s.rarity, "salutation");
          const owned = state.player.salutation && state.player.salutation.id === s.id;
          const hasSpace = !state.player.salutation;
          salList.appendChild(
            createShopCard(
              s.name,
              s.bonus,
              cost,
              () => {
                if (!hasSpace) {
                  alert("Greeting slot full. Sell your current greeting first.");
                  return;
                }
                state.player.reputation -= cost;
                state.player.salutation = s;
                s.purchased = true;
              },
              {
                purchased: owned,
                canBuy: hasSpace,
                badge: formatRarityBadge(s.rarity),
              },
            ),
          );
        });

        // Sign-offs
        const offList = document.getElementById("shop-signoffs");
        offList.innerHTML = "";
        const currentOffWrap = document.createElement("div");
        currentOffWrap.className = "space-y-1 mb-2";
        const offTitle = document.createElement("div");
        offTitle.className = "text-[10px] font-bold uppercase text-gray-500";
        offTitle.innerText = "Current Sign-Off";
        currentOffWrap.appendChild(offTitle);
        if (state.player.signOff) {
          currentOffWrap.appendChild(
            createOwnedRow(state.player.signOff, "signoff", (refund) => {
              state.player.signOff = null;
              state.player.reputation += refund;
            }),
          );
        } else {
          const none = document.createElement("div");
          none.className = "text-[10px] italic text-gray-400";
          none.innerText = "No sign-off selected.";
          currentOffWrap.appendChild(none);
        }
        offList.appendChild(currentOffWrap);
        state.shop.signoffs.forEach((s) => {
          const cost = getItemCostByType(s.rarity, "signoff");
          const owned = state.player.signOff && state.player.signOff.id === s.id;
          const hasSpace = !state.player.signOff;
          offList.appendChild(
            createShopCard(
              s.name,
              s.bonus,
              cost,
              () => {
                if (!hasSpace) {
                  alert("Sign-off slot full. Sell your current sign-off first.");
                  return;
                }
                state.player.reputation -= cost;
                state.player.signOff = s;
                s.purchased = true;
              },
              {
                purchased: owned,
                canBuy: hasSpace,
                badge: formatRarityBadge(s.rarity),
              },
            ),
          );
        });

        // Promotions (Stats)
        const promList = document.getElementById("shop-promotions");
        promList.innerHTML = "";
        state.shop.promotions.forEach((p) => {
          promList.appendChild(
            createShopCard(
              p.name,
              p.bonus,
              p.cost,
              () => {
                state.player.reputation -= p.cost;
                p.apply();
                p.purchased = true;
              },
              { purchased: p.purchased },
            ),
          );
        });

        // BCCs
        const bccList = document.getElementById("shop-bccs");
        bccList.innerHTML = "";
        state.shop.bccs.forEach((b) => {
          const cost =
            b.rarity === "rare" ? 5 : b.rarity === "uncommon" ? 3 : 2;
          bccList.appendChild(
            createShopCard(
              b.name,
              b.bonus,
              cost,
              () => {
                state.player.reputation -= cost;
                state.player.bccContacts.push(b);
                b.purchased = true;
              },
              { purchased: b.purchased, badge: formatRarityBadge(b.rarity) },
            ),
          );
        });
      }

      function handleOpponentDefeat(o, byPlayer = false) {
        if (o.isDefeated) return;
        o.hp = 0;
        o.isDefeated = true;
        if (byPlayer) {
          state.removedByPlayer++;
          o.removedByPlayer = true;
        }
        addEmailToLog(
          o.name,
          "everyone@gov.org",
          "Unsubscribing",
          o.defeatMessage,
          "italic text-gray-600 bg-gray-50 border-l-4 border-gray-400",
        );
        if (state.targetId === o.id) {
          const next = opponents.find((opp) => opp.hp > 0);
          if (next) state.targetId = next.id;
        }
        if (opponents.every((opp) => opp.hp <= 0)) {
          state.gameOver = true;
          endQuarter();
        }
      }

      function updateUI() {
        if (state.gameOver) return;
        const p = state.player;
        const totalMaxHp = getUnitMaxHp(p);
        const hpPct = Math.max(0, (p.hp / totalMaxHp) * 100);
        const ultPct = Math.min(100, p.ult);

        document.getElementById("player-hp-fill").style.width = hpPct + "%";
        document.getElementById("player-hp-label").innerText =
          `${Math.ceil(p.hp)}/${totalMaxHp}`;
        document.getElementById("player-ult-fill").style.width = ultPct + "%";
        document.getElementById("player-win-status").innerText =
          `New Wins: ${p.wins} Available`;

        if (hpPct < 30)
          document.getElementById("player-hp-fill").className =
            "h-full bg-red-600 transition-[width] duration-300 ease-out";
        else if (hpPct < 60)
          document.getElementById("player-hp-fill").className =
            "h-full bg-yellow-500 transition-[width] duration-300 ease-out";
        else
          document.getElementById("player-hp-fill").className =
            "h-full bg-green-500 transition-[width] duration-300 ease-out";

        const singleDmg = getUnitDamage(p, "single");
        const escalateDmg = getUnitDamage(p, "escalate");
        const replyAllDmg = getUnitDamage(p, "replyAll");
        document.getElementById("attack-subtext").innerText =
          `-${Math.floor(singleDmg)} Cred to Target`;
        document.getElementById("escalate-subtext").innerText =
          `-${Math.floor(escalateDmg)} Cred to All`;
        document.getElementById("promote-subtext").innerText =
          `+20 Cred, -1 Win`;
        document.getElementById("deflect-subtext").innerText =
          `Block ${Math.floor(getUnitDeflectPower(p))}`;
        document.getElementById("ult-subtext").innerText =
          `-${Math.floor(replyAllDmg)} Cred to All`;
        document.getElementById("loop-subtext").innerText =
          `${p.addressBook.length}/${p.title.addressLimit} Contacts`;

        document.getElementById("reply-all-btn").disabled = p.ult < 100;
        document.getElementById("win-btn").disabled = p.wins <= 0;

        document.getElementById("game-quarter-display").innerText =
          `${p.quarter} - YEAR ${p.year}`;
        document.getElementById("status-bar-name").innerText =
          `${p.name} (${p.title.name})`;

        const selector = document.getElementById("target-selector");
        selector.innerHTML = "";
        const oppContainer = document.createElement("div");
        oppContainer.className = "contacts-container";
        const maxOppPreview = 4;
        opponents.forEach((o) => {
          const isActive = state.targetId === o.id;
          const pct = Math.max(0, (o.hp / getUnitMaxHp(o)) * 100);
          const pill = document.createElement("div");
          pill.onclick = () => {
            if (o.hp > 0) state.targetId = o.id;
            updateUI();
          };
          pill.className = `target-pill px-2 py-0.5 flex flex-col min-w-[90px] cursor-pointer bg-white ${isActive ? "active" : "opacity-60 grayscale"}`;
          pill.innerHTML = `<div class="flex justify-between font-bold text-[8px] truncate"><span class="mr-2">${o.name}</span><span>${o.hp > 0 ? o.wins + "w" : "UNSUBBED"}</span></div>
                                <div class="h-1 w-full bg-gray-200 mt-0.5"><div class="h-full bg-red-500" style="width: ${pct}%"></div></div>`;
          oppContainer.appendChild(pill);
        });
        selector.appendChild(oppContainer);
        if (opponents.length > maxOppPreview) {
          const more = document.createElement("span");
          const hiddenCount = opponents.length - maxOppPreview;
          more.className = "contacts-more text-[9px]";
          more.innerText = `+ ${hiddenCount} more`;
          more.onclick = () => {
            const expanded = oppContainer.classList.toggle("expanded");
            more.innerText = expanded ? "Show less" : `+ ${hiddenCount} more`;
          };
          selector.appendChild(more);
        }

        const ccDisplay = document.getElementById("cc-display");
        const activeBuffs = [
          ...state.player.buffs,
          ...opponents.flatMap((o) => o.buffs || []),
        ];
        if (activeBuffs.length === 0) {
          ccDisplay.className = "flex gap-1 text-gray-400 italic";
          ccDisplay.innerHTML = "No one in loop.";
        } else {
          const usedByOrder = (name) => {
            if (name === state.player.name) return 0;
            const idx = opponents.findIndex((o) => o.name === name);
            return idx >= 0 ? idx + 1 : 999;
          };
          const sortedBuffs = [...activeBuffs].sort((a, b) => {
            const byUsed = usedByOrder(a.usedBy) - usedByOrder(b.usedBy);
            if (byUsed !== 0) return byUsed;
            const deptA = getDepartmentName(a.departmentId);
            const deptB = getDepartmentName(b.departmentId);
            const byDept = deptA.localeCompare(deptB);
            if (byDept !== 0) return byDept;
            return (a.name || "").localeCompare(b.name || "");
          });

          ccDisplay.className = "flex items-center gap-1 text-gray-600";
          ccDisplay.innerHTML = "";
          const container = document.createElement("div");
          container.className = "contacts-container";
          const maxPreview = 4;
          sortedBuffs.forEach((b) => {
            const pill = document.createElement("button");
            pill.className =
              "bg-blue-800 text-white px-1 text-[9px] rounded-sm hover:bg-blue-700";
            pill.type = "button";
            pill.innerHTML = `${b.name} (by ${b.usedBy})`;
            pill.onclick = () => openCcProfile(b);
            container.appendChild(pill);
          });
          ccDisplay.appendChild(container);

          if (sortedBuffs.length > maxPreview) {
            const more = document.createElement("span");
            const hiddenCount = sortedBuffs.length - maxPreview;
            more.className = "contacts-more text-[9px]";
            more.innerText = `+ ${hiddenCount} more`;
            more.onclick = () => {
              const expanded = container.classList.toggle("expanded");
              more.innerText = expanded
                ? "Show less"
                : `+ ${hiddenCount} more`;
            };
            ccDisplay.appendChild(more);
          }
        }

        const h = 9 + Math.floor(state.turn / 4);
        const m = (state.turn % 4) * 15;
        document.getElementById("turn-clock").innerText =
          `${h.toString().padStart(2, "0")}:${m.toString().padStart(2, "0")} AM`;
      }

      function addEmailToLog(from, to, subject, body, classes = "") {
        const log = document.getElementById("message-log");
        const entry = document.createElement("div");
        const time = document.getElementById("turn-clock").innerText;
        const reCount =
          state.turn > 0 ? "RE: ".repeat(Math.min(state.turn, 4)) : "";

        entry.className = `message-entry p-0 border-2 border-gray-100 bg-white shadow-sm ${classes}`;
        entry.innerHTML = `
                <div class="email-header p-2">
                    <div class="flex flex-wrap gap-x-4">
                        <div><strong>From:</strong> ${from}</div>
                        <div><strong>To:</strong> ${to}</div>
                    </div>
                    <div class="flex flex-wrap gap-x-4">
                        <div><strong>Sent:</strong> Today, ${time}</div>
                        <div><strong>Subject:</strong> ${reCount}${subject}</div>
                    </div>
                </div>
                <div class="email-body px-3 py-2 font-serif italic">
                    ${body}
                </div>
            `;
        log.prepend(entry);
      }

      function performAction(type) {
        if (state.isProcessing || state.gameOver) return;
        state.isProcessing = true;
        state.turn++;
        const target = opponents.find((o) => o.id === state.targetId);
        const p = state.player;
        const mission = MISSIONS[state.currentMissionIndex] || MISSIONS[0];
        const missionId = mission.id;
        const titleId = p.title ? p.title.id : null;
        const totalMaxHp = getUnitMaxHp(p);

        // Heal from all sources
        p.hp = Math.min(totalMaxHp, p.hp + getUnitTotalHeal(p));

        if (type === "ATTACK") {
          let d = getUnitDamage(p, "single");

          if (p.nextAttackMult) {
            d *= p.nextAttackMult;
            p.nextAttackMult = 1; // reset back to 1
          }

          const result = applyDamage(p, target, d);
          let levGain = getPlayerLeverageGain(20);
          p.ult += levGain;

          const followUpChance = getUnitFollowUpChance(p);
          const followUpHit =
            followUpChance > 0 && Math.random() < followUpChance;
          const followUpResult = followUpHit ? applyDamage(p, target, d) : null;
          const splashDamage = getUnitReplyDeptSplash(p);
          const splashResult = applyDepartmentSplash(p, target, splashDamage);
          const bounceDamage = getUnitBounceDamage(p);
          const bounceTarget = bounceDamage
            ? pickBounceTarget(p, target)
            : null;
          const bounceResult = bounceTarget
            ? applyDamage(p, bounceTarget, bounceDamage)
            : null;

          const q = drawFromLineBag(
            p,
            getPlayerLineBagKey("attack", missionId, titleId),
            getPlayerActionLines("attack", missionId),
            "I believe we need to circle back to your recent comments.",
          );
          let body = formatMessageBody(p, q);
          if (result.blocked > 0) {
            body += `<br><br><strong>Deflected:</strong> ${result.blocked} reflected.`;
          }
          if (followUpResult) {
            body += `<br><br><strong>Follow-up Reply:</strong> -${followUpResult.dmg}`;
            if (followUpResult.blocked > 0) {
              body += ` (Deflected ${followUpResult.blocked})`;
            }
            body += ".";
          }
          if (splashResult.hits > 0) {
            body += `<br><br><strong>Department Splash:</strong> ${splashResult.hits} hit for ${splashResult.total}.`;
          }
          if (bounceResult && bounceTarget) {
            body += `<br><br><strong>Bounce:</strong> ${bounceTarget.name} -${bounceResult.dmg}.`;
            if (bounceResult.blocked > 0) {
              body += ` (Deflected ${bounceResult.blocked})`;
            }
          }
          addEmailToLog(
            p.name,
            target.name,
            "Reply to",
            body,
            "border-l-4 border-blue-600",
          );
          if (target.hp <= 0) handleOpponentDefeat(target, true);
        } else if (type === "ESCALATE") {
          const d = getUnitDamage(p, "escalate");
          let totalBlocked = 0;
          let totalRecovered = 0;
          const recoverPerHit = getUnitEscalateRecover(p);
          opponents.forEach((o) => {
            if (o.hp > 0) {
              const result = applyDamage(p, o, d);
              totalBlocked += result.blocked;
              if (recoverPerHit > 0) {
                totalRecovered += recoverPerHit;
                p.hp = Math.min(totalMaxHp, p.hp + recoverPerHit);
              }
              if (o.hp <= 0) handleOpponentDefeat(o, true);
            }
          });
          let levGain = getPlayerLeverageGain(10);
          p.ult += levGain;
          const line = drawFromLineBag(
            p,
            getPlayerLineBagKey("escalate", missionId, titleId),
            getPlayerActionLines("escalate", missionId),
            "I'm escalating this for clarity across the thread.",
          );
          let body = formatMessageBody(p, line);
          if (totalBlocked > 0) {
            body += `<br><br><strong>Deflected:</strong> ${totalBlocked} reflected.`;
          }
          if (totalRecovered > 0) {
            body += `<br><br><strong>Recovered:</strong> +${totalRecovered} Credibility.`;
          }
          addEmailToLog(
            p.name,
            "everyone@gov.org",
            "Escalation Notice",
            body,
            "bg-orange-50 border-l-4 border-orange-500",
          );
        } else if (type === "DEFLECT") {
          p.deflectCharge = getUnitDeflectPower(p);
          const line = drawFromLineBag(
            p,
            getPlayerLineBagKey("deflect", missionId, titleId),
            getPlayerActionLines("deflect", missionId),
            "Holding response to keep this thread scoped and documented.",
          );
          addEmailToLog(
            p.name,
            "everyone@gov.org",
            "Holding Response",
            `${formatMessageBody(p, line)}<br><br><strong>Deflection Ready:</strong> ${p.deflectCharge}`,
            "bg-blue-50 border-l-4 border-blue-500",
          );
        } else if (type === "PROMOTE") {
          p.wins--;
          p.hp = Math.min(totalMaxHp, p.hp + 20);
          const selfPromoteLine = drawFromLineBag(
            p,
            getPlayerLineBagKey("selfPromote", missionId, titleId),
            getPlayerActionLines("selfPromote", missionId),
            "Just logging a new win—the quarterly audit came back clean under my supervision. Always happy to add value to the organization!",
          );
          addEmailToLog(
            p.name,
            "everyone@gov.org",
            "FYI: Project Milestone Met",
            selfPromoteLine,
            "bg-green-50 border-l-4 border-green-600",
          );
        } else if (type === "ULT") {
          const d = getUnitDamage(p, "replyAll");
          let totalBlocked = 0;
          opponents.forEach((o) => {
            if (o.hp > 0) {
              const result = applyDamage(p, o, d);
              totalBlocked += result.blocked;
              if (o.hp <= 0) handleOpponentDefeat(o, true);
            }
          });
          p.ult = 0;
          const replyAllLine = drawFromLineBag(
            p,
            getPlayerLineBagKey("replyAll", missionId, titleId),
            getPlayerActionLines("replyAll", missionId),
            {
              subject: "Fwd: Salary_Discrepancies_2024.xlsx",
              body: "Not sure if I should be sending this to everyone, but since transparency is one of our 'core values', here is the full salary spreadsheet for the department. Enjoy.",
            },
          );
          let replyBody = replyAllLine.body;
          if (totalBlocked > 0) {
            replyBody += `<br><br><strong>Deflected:</strong> ${totalBlocked} reflected.`;
          }
          addEmailToLog(
            p.name,
            "everyone@gov.org",
            replyAllLine.subject,
            replyBody,
            "bg-yellow-50 font-bold border-l-4 border-yellow-500",
          );
        }

        updateUI();
        if (state.player.hp <= 0) {
          state.gameOver = true;
          setTimeout(showLoseScreen, 4000);
          return;
        }
        setTimeout(ffaRound, 800);
      }

      function ffaRound() {
        const alive = opponents.filter((o) => o.hp > 0);
        if (alive.length === 0) return; // Handled by handleOpponentDefeat

        alive.forEach((a, idx) => {
          setTimeout(() => {
            if (a.hp <= 0 || state.gameOver) return;

            if (a.isStunned) {
              a.isStunned = false;
              addEmailToLog(
                a.name,
                "everyone@gov.org",
                "RE: (Recalled Message)",
                `I'm sorry, I seem to have lost my train of thought. What were we discussing?`,
                "italic text-gray-400",
              );
              if (idx === alive.length - 1) {
                state.isProcessing = false;
                updateUI();
              }
              return;
            }

            let pool = [
              ...alive.filter((o) => o.id !== a.id),
              {
                id: "player",
                name: state.player.name,
                email: state.player.email,
                departmentId: state.player.departmentId,
              },
            ];

            // Targeting logic: weigh opponents by department (colleagues never attack each other)
            let weights = pool.map((t) =>
              t.departmentId === a.departmentId ? 0 : 1.0,
            );
            let totalWeight = weights.reduce((acc, w) => acc + w, 0);
            let random = Math.random() * totalWeight;
            let target = pool[0];
            for (let i = 0; i < pool.length; i++) {
              random -= weights[i];
              if (random <= 0) {
                target = pool[i];
                break;
              }
            }

            if (a.redirectNext) {
              a.redirectNext = false;
              const targets = alive.filter((o) => o.id !== a.id);
              if (targets.length > 0) {
                target = targets[Math.floor(Math.random() * targets.length)];
                addEmailToLog(
                  a.name,
                  "everyone@gov.org",
                  "Redirected Reply",
                  `Wait, I meant to send this to <strong>${target.name}</strong> instead.`,
                  "italic text-blue-400 text-[10px]",
                );
              }
            }

            let roll = Math.random();

            a.hp = Math.min(getUnitMaxHp(a), a.hp + getUnitTotalHeal(a));

            const availFromBook = a.addressBook
              .map((id) => CONTACTS.find((con) => con.id === id))
              .filter((c) => c && !isContactInLoop(c.id) && !isContactImplicated(c));
            if (roll < 0.15 && availFromBook.length > 0) {
              const c =
                availFromBook[Math.floor(Math.random() * availFromBook.length)];
              addContactBuff(a, c, a.name);
              const loopInText = formatLoopInText(
                c,
                `I'm looping in <strong>${c.name}</strong> to ensure this thread remains within professional guidelines.`,
              );
              addEmailToLog(
                a.name,
                "everyone@gov.org",
                "Looping in Support",
                loopInText,
                "bg-blue-50",
              );
            } else if (roll < 0.3 && a.hp < 20 && a.wins > 0) {
              a.wins--;
              a.hp = Math.min(getUnitMaxHp(a), a.hp + 15);
              const selfPromoteLine = drawFromLineBag(
                a,
                "selfPromote",
                getUnitSelfPromoteLines(a),
                "I'm logging a significant departmental achievement. This incident shouldn't distract from real wins.",
              );
              addEmailToLog(
                a.name,
                "everyone@gov.org",
                "Self Promotion",
                formatMessageBody(a, selfPromoteLine),
                "opacity-70",
              );
            } else {
              const actionRoll = Math.random();
              if (actionRoll < 0.15 && a.deflectCharge <= 0) {
                a.deflectCharge = getUnitDeflectPower(a);
                const deflectLine = drawFromLineBag(
                  a,
                  "deflect",
                  a.deflectLines,
                  "I'm pausing to document this thread before responding further.",
                );
                addEmailToLog(
                  a.name,
                  "everyone@gov.org",
                  "Holding Response",
                  `${formatMessageBody(a, deflectLine)}<br><br><strong>Deflection Ready:</strong> ${a.deflectCharge}`,
                  "bg-blue-50",
                );
              } else if (actionRoll < 0.35) {
                const d = getUnitDamage(a, "escalate");
                let totalBlocked = 0;
                let totalRecovered = 0;
                const recoverPerHit = getUnitEscalateRecover(a);
                const escalateTargets = [
                  ...alive.filter((o) => o.id !== a.id),
                  state.player,
                ];
                escalateTargets.forEach((t) => {
                  if (t !== state.player && t.departmentId === a.departmentId)
                    return;
                  if (t.hp > 0) {
                    const result = applyDamage(a, t, d);
                    totalBlocked += result.blocked;
                    if (recoverPerHit > 0) {
                      totalRecovered += recoverPerHit;
                      a.hp = Math.min(getUnitMaxHp(a), a.hp + recoverPerHit);
                    }
                    if (t !== state.player && t.hp <= 0)
                      handleOpponentDefeat(t);
                  }
                });
                const escLine = drawFromLineBag(
                  a,
                  "escalate",
                  a.escalateLines,
                  "I'm escalating this across the thread for visibility.",
                );
                let escBody = formatMessageBody(a, escLine);
                if (totalBlocked > 0) {
                  escBody += `<br><br><strong>Deflected:</strong> ${totalBlocked} reflected.`;
                }
                if (totalRecovered > 0) {
                  escBody += `<br><br><strong>Recovered:</strong> +${totalRecovered} Credibility.`;
                }
                addEmailToLog(
                  a.name,
                  "everyone@gov.org",
                  "Escalation Notice",
                  escBody,
                  "bg-orange-50",
                );
              } else {
                let d = getUnitDamage(a, "single");

                // Select attack type
                const q = drawFromLineBag(
                  a,
                  "attack",
                  a.attacks,
                  "I'm following up to keep this thread moving.",
                );
                let body = formatMessageBody(a, q);

                const followUpChance = getUnitFollowUpChance(a);
                const followUpHit =
                  followUpChance > 0 && Math.random() < followUpChance;
                const splashDamage = getUnitReplyDeptSplash(a);
                const bounceDamage = getUnitBounceDamage(a);

                if (target.id === "player") {
                  if (
                    state.player.buffs.find(
                      (b) => b.eff.dodge && Math.random() < b.eff.dodge,
                    )
                  ) {
                    addEmailToLog(
                      a.name,
                      state.player.name,
                      "Urgent Follow-up",
                      body +
                        `<br><br>(Thread ignored by <strong>Mittens</strong>. No standing lost.)`,
                      "text-blue-600",
                    );
                  } else {
                    const result = applyDamage(a, state.player, d);
                    const followUpResult = followUpHit
                      ? applyDamage(a, state.player, d)
                      : null;
                    const splashResult = applyDepartmentSplash(
                      a,
                      state.player,
                      splashDamage,
                    );
                    const bounceTarget = bounceDamage
                      ? pickBounceTarget(a, state.player)
                      : null;
                    const bounceResult = bounceTarget
                      ? applyDamage(a, bounceTarget, bounceDamage)
                      : null;
                    if (result.blocked > 0) {
                      body += `<br><br><strong>Deflected:</strong> ${result.blocked} reflected.`;
                    }
                    if (followUpResult) {
                      body += `<br><br><strong>Follow-up Reply:</strong> -${followUpResult.dmg}.`;
                    }
                    if (splashResult.hits > 0) {
                      body += `<br><br><strong>Department Splash:</strong> ${splashResult.hits} hit for ${splashResult.total}.`;
                    }
                    if (bounceResult && bounceTarget) {
                      body += `<br><br><strong>Bounce:</strong> ${bounceTarget.name} -${bounceResult.dmg}.`;
                    }
                    addEmailToLog(
                      a.name,
                      state.player.name,
                      "Escalation",
                      body +
                        `<br><br><strong>Damage to Credibility: -${result.dmg}</strong>`,
                      "bg-red-50 border-l-2 border-red-400",
                    );
                    document
                      .getElementById("game-ui")
                      .classList.add("shaking");
                    setTimeout(
                      () =>
                        document
                          .getElementById("game-ui")
                          .classList.remove("shaking"),
                      200,
                    );
                  }
                } else {
                  const result = applyDamage(a, target, d);
                  const followUpResult = followUpHit
                    ? applyDamage(a, target, d)
                    : null;
                  const splashResult = applyDepartmentSplash(
                    a,
                    target,
                    splashDamage,
                  );
                  const bounceTarget = bounceDamage
                    ? pickBounceTarget(a, target)
                    : null;
                  const bounceResult = bounceTarget
                    ? applyDamage(a, bounceTarget, bounceDamage)
                    : null;
                  if (result.blocked > 0) {
                    body += `<br><br><strong>Deflected:</strong> ${result.blocked} reflected.`;
                  }
                  if (followUpResult) {
                    body += `<br><br><strong>Follow-up Reply:</strong> -${followUpResult.dmg}.`;
                  }
                  if (splashResult.hits > 0) {
                    body += `<br><br><strong>Department Splash:</strong> ${splashResult.hits} hit for ${splashResult.total}.`;
                  }
                  if (bounceResult && bounceTarget) {
                    body += `<br><br><strong>Bounce:</strong> ${bounceTarget.name} -${bounceResult.dmg}.`;
                  }
                  addEmailToLog(
                    a.name,
                    target.name,
                    "Internal Memo",
                    body +
                      `<br><br>(Targeting ${target.name}. Standing lost: ${result.dmg})`,
                    "text-gray-500 text-[11px]",
                  );
                  if (target.hp <= 0) handleOpponentDefeat(target);
                }
              }
            }

            if (a.hp <= 0) {
              handleOpponentDefeat(a);
              return;
            }

            if (state.player.hp <= 0) {
              state.gameOver = true;
              updateUI();
              setTimeout(showLoseScreen, 1500);
            }
          }, idx * 700);
        });

        setTimeout(() => {
          if (!state.gameOver) {
            state.isProcessing = false;
            updateUI();
          }
        }, alive.length * 700);
      }

      function openAddressBook() {
        const list = document.getElementById("contact-list");
        list.innerHTML = "";
        document.getElementById("address-book-title").innerText =
          `PERSONNEL DIRECTORY (${state.player.addressBook.length}/${state.player.title.addressLimit})`;

        // CCs
        const headerCC = document.createElement("div");
        headerCC.className =
          "text-[10px] font-bold bg-gray-200 p-1 mb-1 uppercase";
        headerCC.innerText = "Address Book (Permanent CCs)";
        list.appendChild(headerCC);

        state.player.addressBook.forEach((id) => {
          const c = CONTACTS.find((con) => con.id === id);
          if (!c) return;
          const isUsed = isContactInLoop(c.id);
          const isImplicated = isContactImplicated(c);
          const isDisabled = isUsed || isImplicated;
          const statusText = isImplicated
            ? "IMPLICATED"
            : isUsed
              ? "IN LOOP"
              : "AVAIL";
          const btn = document.createElement("div");
          btn.className = `p-2 border border-gray-300 flex flex-col ${isDisabled ? "opacity-40 grayscale bg-gray-100" : "cursor-pointer hover:bg-blue-50"}`;
          btn.innerHTML = `<div class="flex justify-between font-bold text-[#000080] text-xs"><span>${c.name} - ${c.title}</span><span class="text-[9px]">${statusText}</span></div><div class="text-[10px] italic">${c.bonus}</div>`;
          if (!isDisabled)
            btn.onclick = () => {
              addContactBuff(state.player, c, state.player.name);
              const loopInText = formatLoopInText(
                c,
                `I'm looping in <strong>${c.name}</strong> (${c.title}) to help clarify the organizational impact of this thread.`,
              );
              addEmailToLog(
                state.player.name,
                "everyone@gov.org",
                "Looping in Witness",
                loopInText,
                "bg-blue-100 font-bold border-l-4 border-blue-500",
              );
              closeAddressBook();
              updateUI();
              state.isProcessing = true;
              setTimeout(ffaRound, 400);
            };
          list.appendChild(btn);
        });

        // BCCs
        if (state.player.bccContacts.length > 0) {
          const headerBCC = document.createElement("div");
          headerBCC.className =
            "text-[10px] font-bold bg-gray-200 p-1 mt-4 mb-1 uppercase";
          headerBCC.innerText = "Help Desk Contacts (BCC Consumables)";
          list.appendChild(headerBCC);

          state.player.bccContacts.forEach((b, idx) => {
            const btn = document.createElement("div");
            btn.className = `p-2 border border-gray-300 flex flex-col cursor-pointer hover:bg-yellow-50`;
            btn.innerHTML = `<div class="flex justify-between font-bold text-yellow-800 text-xs"><span>${b.name}</span><span class="text-[9px]">BCC</span></div><div class="text-[10px] italic">${b.bonus}</div>`;
            btn.onclick = () => {
              useBcc(b, idx);
            };
            list.appendChild(btn);
          });
        }

        document.getElementById("address-book").classList.remove("hidden");
      }

      function useBcc(bcc, index) {
        state.player.bccContacts.splice(index, 1);
        addEmailToLog(
          state.player.name,
          "everyone@gov.org",
          `BCC: ${bcc.name}`,
          `[PRIVATE MESSAGE] Sent: ${bcc.bonus}`,
          "bg-yellow-100 border-l-4 border-yellow-600",
        );

        if (bcc.effect === "stun") {
          const target = opponents.find((o) => o.id === state.targetId);
          target.isStunned = true;
          addEmailToLog(
            "SYSTEM",
            state.player.name,
            "Message Recalled",
            `${target.name}'s next turn will be skipped.`,
            "italic text-gray-500 text-[10px]",
          );
        } else if (bcc.effect === "doubleDmg") {
          state.player.nextAttackMult = 2;
          addEmailToLog(
            "SYSTEM",
            state.player.name,
            "Urgent Flag Set",
            `Your next reply to will deal 2x damage.`,
            "italic text-gray-500 text-[10px]",
          );
        } else if (bcc.effect === "redirect") {
          const target = opponents.find((o) => o.id === state.targetId);
          target.redirectNext = true;
          addEmailToLog(
            "SYSTEM",
            state.player.name,
            "Message Redirected",
            `${target.name} will target someone else next turn.`,
            "italic text-gray-500 text-[10px]",
          );
        }

        closeAddressBook();
        updateUI();
        state.isProcessing = true;
        setTimeout(ffaRound, 400);
      }

      function closeAddressBook() {
        document.getElementById("address-book").classList.add("hidden");
      }
    </script>
  </body>
</html>
