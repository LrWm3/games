<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>REPLY ALL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=VT323&family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /**
         * FUNCTIONALITY CATALOG:
         * 1. Turn-based FFA Loop: Logic preserved.
         * 2. Targeting: TargetId state mapped to "To:" field.
        * 3. Actions: ATTACK (Reply to), ESCALATE (Light AOE), DEFLECT (Block/Reflect), SELF-PROMOTE (New Wins/Heal), ULT (Reply All), CC (Summon/Buff).
         * 4. Address Book: Modal system for assigning permanent buffs.
         * 5. Personality: Specific attack types (Compliance, Value, Time, Accusatory).
         */
      :root {
        --win-grey: #c0c0c0;
        --win-blue: #000080;
        --win-border-light: #ffffff;
        --win-border-dark: #404040;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: #008080;
        height: 100dvh;
        overflow: hidden;
        touch-action: manipulation;
        color: black;
      }
      .retro-border {
        border-top: 2px solid var(--win-border-light);
        border-left: 2px solid var(--win-border-light);
        border-bottom: 2px solid var(--win-border-dark);
        border-right: 2px solid var(--win-border-dark);
      }
      .retro-border-inset {
        border-top: 2px solid var(--win-border-dark);
        border-left: 2px solid var(--win-border-dark);
        border-bottom: 2px solid var(--win-border-light);
        border-right: 2px solid var(--win-border-light);
      }
      .retro-button {
        background: var(--win-grey);
        border-top: 2px solid var(--win-border-light);
        border-left: 2px solid var(--win-border-light);
        border-bottom: 2px solid var(--win-border-dark);
        border-right: 2px solid var(--win-border-dark);
        padding: 4px 8px;
        cursor: pointer;
        user-select: none;
      }
      .retro-button:active:not(:disabled) {
        border-top: 2px solid var(--win-border-dark);
        border-left: 2px solid var(--win-border-dark);
        border-bottom: 2px solid var(--win-border-light);
        border-right: 2px solid var(--win-border-light);
        padding-top: 5px;
        padding-bottom: 3px;
      }
      .retro-button:disabled {
        color: #808080;
        cursor: not-allowed;
        opacity: 0.6;
      }
      .terminal-font {
        font-family: "VT323", monospace;
      }
      @keyframes shake {
        0%,
        100% {
          transform: translate(0, 0);
        }
        25% {
          transform: translate(-3px, 3px);
        }
        50% {
          transform: translate(3px, -3px);
        }
        75% {
          transform: translate(-3px, -3px);
        }
      }
      .shaking {
        animation: shake 0.2s ease-in-out infinite;
      }
      .scroll-container::-webkit-scrollbar {
        width: 14px;
      }
      .scroll-container::-webkit-scrollbar-track {
        background: #dfdfdf;
      }
      .scroll-container::-webkit-scrollbar-thumb {
        background: var(--win-grey);
        border: 2px solid var(--win-border-light);
        box-shadow: inset -1px -1px 0 var(--win-border-dark);
      }
      .contacts-container {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        max-height: 38px;
        overflow: hidden;
        transition: max-height 0.2s ease;
      }
      .contacts-container.expanded {
        max-height: 140px;
      }
      .contacts-more {
        cursor: pointer;
        color: #000080;
        font-style: normal;
        font-weight: bold;
        text-decoration: underline;
        margin-left: 4px;
      }
      .target-pill {
        transition: all 0.2s;
        border: 1px solid #808080;
      }
      .target-pill.active {
        background: #000080 !important;
        color: white !important;
        border-color: #ffffff;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .message-entry {
        animation: slideIn 0.3s ease-out;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .email-header {
        background: #e8e8e8;
        border-bottom: 1px solid #ccc;
        font-family: sans-serif;
        font-size: 11px;
        color: #444;
      }
      .email-body {
        padding: 12px 0;
        line-height: 1.5;
        color: #111;
      }
    </style>
  </head>
  <body class="flex items-center justify-center p-0 md:p-2">
    <!-- INBOX SCREEN -->
    <div
      id="inbox-screen"
      class="hidden fixed inset-0 z-[90] flex items-center justify-center bg-[#008080] p-4"
    >
      <div
        class="bg-[#c0c0c0] retro-border max-w-2xl w-full h-[80dvh] flex flex-col shadow-2xl"
      >
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs"
        >
          <span>Outlook Express - Inbox</span>
          <div class="flex gap-1">
            <button
              class="w-4 h-4 bg-[#c0c0c0] text-black text-[10px] flex items-center justify-center"
            >
              _
            </button>
            <button
              class="w-4 h-4 bg-[#c0c0c0] text-black text-[10px] flex items-center justify-center"
            >
              X
            </button>
          </div>
        </div>
        <div
          class="bg-[#dfdfdf] border-b border-[#808080] p-1 flex gap-2 text-[10px]"
        >
          <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">File</button>
          <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">Edit</button>
          <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">View</button>
          <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">Tools</button>
          <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">Message</button>
          <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">Help</button>
        </div>
        <div class="flex-grow flex overflow-hidden">
          <div
            class="w-32 bg-[#dfdfdf] border-r border-[#808080] p-2 text-[10px] hidden sm:block"
          >
            <div class="font-bold mb-2">Folders</div>
            <div class="pl-2 space-y-1">
              <div class="bg-blue-800 text-white px-1">Inbox</div>
              <div>Outbox</div>
              <div>Sent Items</div>
              <div>Deleted Items</div>
              <div>Spam</div>
            </div>
          </div>
          <div class="flex-grow flex flex-col bg-white overflow-hidden">
            <div
              class="bg-[#f0f0f0] border-b border-[#808080] grid grid-cols-12 text-[9px] font-bold p-1"
            >
              <div class="col-span-1">!</div>
              <div class="col-span-5">From</div>
              <div class="col-span-6">Subject</div>
            </div>
            <div
              id="inbox-list"
              class="flex-grow overflow-y-auto overflow-x-hidden text-[11px] divide-y divide-gray-100"
            >
              <!-- Emails will be injected here -->
            </div>
          </div>
        </div>
        <div
          class="bg-[#dfdfdf] border-t border-[#808080] p-1 text-[10px] flex justify-between"
        >
          <div id="inbox-status">324 Messages, 1 Unread</div>
          <div class="flex gap-4">
            <span>Working Online</span>
          </div>
        </div>
      </div>
    </div>

    <!-- SUMMARY SCREEN (Performance Metrics) -->
    <div
      id="summary-screen"
      class="hidden fixed inset-0 z-[120] bg-black/60 flex items-center justify-center p-4"
    >
      <div
        class="bg-[#c0c0c0] retro-border max-w-xs w-full shadow-2xl overflow-hidden"
      >
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold"
        >
          <span>ARCHIVED THREAD</span>
          <span>✕</span>
        </div>
        <div class="p-4 flex flex-col items-center">
          <div
            class="w-16 h-16 bg-yellow-400 retro-border flex items-center justify-center mb-4"
          >
            <svg
              class="w-10 h-10 text-white"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
              <path
                fill-rule="evenodd"
                d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13zM7 13a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13z"
                clip-rule="evenodd"
              ></path>
            </svg>
          </div>
          <h2 class="text-xl font-bold terminal-font mb-2">
            PERFORMANCE METRICS
          </h2>
          <div
            class="w-full bg-white retro-border-inset p-3 space-y-2 text-xs mb-4"
          >
            <div class="flex justify-between">
              <span>Base Mission Reward:</span>
              <span id="summary-base-rep" class="font-mono">+4</span>
            </div>
            <div
              id="summary-optouts-list"
              class="space-y-1 py-1 border-y border-gray-100 hidden"
            >
              <!-- Individual opt-outs injected here -->
            </div>
            <div class="flex justify-between">
              <span>Additional Bonuses:</span>
              <span id="summary-bonus-rep" class="font-mono">+0</span>
            </div>
            <div
              class="border-t border-gray-300 pt-2 flex justify-between font-bold text-[#000080]"
            >
              <span>TOTAL REP EARNED:</span>
              <span id="summary-rep-earned" class="font-mono text-lg">+0</span>
            </div>
          </div>
          <button
            onclick="showShop()"
            class="w-full py-2 retro-button font-bold text-sm"
          >
            GO TO PORTAL
          </button>
        </div>
      </div>
    </div>

    <!-- SHOP SCREEN (HR Self-Service Portal) -->
    <div
      id="shop-screen"
      class="hidden fixed inset-0 z-[130] bg-[#008080] p-4 flex flex-col items-center overflow-y-auto"
    >
      <div
        class="bg-[#c0c0c0] retro-border w-full max-w-4xl shadow-2xl flex flex-col min-h-0"
      >
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold shrink-0"
        >
          <span>INTRA-NET: HR PORTAL & EMPLOYEE SERVICES</span>
          <span
            id="shop-reputation-display"
            class="bg-yellow-400 text-black px-2 rounded-sm ml-auto mr-4"
            >REPUTATION: 0</span
          >
          <button
            onclick="advanceToNextQuarter()"
            class="retro-button text-black text-[10px] py-0 px-2 h-5"
          >
            NEXT QUARTER &gt;
          </button>
        </div>
        <div class="bg-[#f0f0f0] p-4 flex-grow overflow-y-auto">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Seminars (CCs) -->
            <div class="space-y-2">
              <h3
                class="text-xs font-bold uppercase border-b border-[#808080] pb-1"
              >
                Reach Out (Address Book)
              </h3>
              <div id="shop-seminars" class="space-y-2"></div>
            </div>
            <!-- Signatures -->
            <div class="space-y-2">
              <h3
                class="text-xs font-bold uppercase border-b border-[#808080] pb-1"
              >
                Email Signature Library
              </h3>
              <div id="shop-signatures" class="space-y-2"></div>
            </div>
            <!-- Salutations -->
            <div class="space-y-2">
              <h3
                class="text-xs font-bold uppercase border-b border-[#808080] pb-1"
              >
                Set Greeting
              </h3>
              <div id="shop-salutations" class="space-y-2"></div>
            </div>
            <!-- Sign-offs -->
            <div class="space-y-2">
              <h3
                class="text-xs font-bold uppercase border-b border-[#808080] pb-1"
              >
                Set Sign-off
              </h3>
              <div id="shop-signoffs" class="space-y-2"></div>
            </div>
            <!-- Self Promotion -->
            <div class="space-y-2">
              <h3
                class="text-xs font-bold uppercase border-b border-[#808080] pb-1"
              >
                Professional Development
              </h3>
              <div id="shop-promotions" class="space-y-2"></div>
            </div>
            <!-- Help Desk (BCCs) -->
            <div class="space-y-2">
              <h3
                class="text-xs font-bold uppercase border-b border-[#808080] pb-1"
              >
                Help Desk Escalations (BCCs)
              </h3>
              <div id="shop-bccs" class="space-y-2"></div>
            </div>
          </div>
        </div>
        <div
          class="bg-[#dfdfdf] border-t border-[#808080] p-2 text-[10px] text-center italic text-gray-600 shrink-0"
        >
          Corporate policy: Requests are logged. Archiving items returns partial
          reputation.
        </div>
      </div>
    </div>

    <!-- STATS SUMMARY MODAL -->
    <div
      id="stats-modal"
      class="hidden fixed inset-0 z-[160] bg-black/40 flex items-center justify-center p-4"
    >
      <div class="bg-[#f7f4e8] retro-border w-full max-w-2xl shadow-2xl">
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold"
        >
          <span>PLAYER STAT SUMMARY</span>
          <button id="stats-modal-close" class="px-1">✕</button>
        </div>
        <div class="p-3 text-[10px] text-gray-800 space-y-3">
          <div id="stats-modal-header" class="text-[11px] font-bold"></div>
          <div class="grid grid-cols-2 gap-2" id="stats-modal-totals"></div>
          <div>
            <div class="text-[10px] font-bold uppercase text-gray-500 mb-1">
              Sources
            </div>
            <div id="stats-modal-sources" class="space-y-2"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- LOSE SCREEN (Termination Notice) -->
    <div
      id="lose-screen"
      class="hidden fixed inset-0 z-[150] bg-black flex items-center justify-center p-4"
    >
      <div
        class="bg-[#c0c0c0] retro-border max-w-sm w-full shadow-2xl overflow-hidden"
      >
        <div
          class="bg-red-800 text-white px-2 py-1 flex justify-between items-center text-xs font-bold"
        >
          <span>SYSTEM LOCKOUT - SECURITY BREACH</span>
          <span>✕</span>
        </div>
        <div class="p-6 flex flex-col items-center">
          <div
            class="w-16 h-16 bg-red-600 retro-border flex items-center justify-center mb-6"
          >
            <svg
              class="w-10 h-10 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              ></path>
            </svg>
          </div>

          <h2 class="text-2xl font-bold terminal-font mb-4 text-red-800">
            NOTICE OF TERMINATION
          </h2>

          <div
            class="w-full bg-white retro-border-inset p-4 space-y-3 text-[11px] mb-6 leading-tight"
          >
            <p class="font-bold text-center border-b pb-2 mb-2">
              Final Employee Records
            </p>
            <div class="flex justify-between">
              <span class="text-gray-500 uppercase">Final Title:</span>
              <span id="lose-title" class="font-bold">Cubicle Resident</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500 uppercase">Period:</span>
              <span id="lose-period" class="font-bold">Q3 - Year 1</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500 uppercase">Total Reputation:</span>
              <span id="lose-total-rep" class="font-bold">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500 uppercase">Address Book:</span>
              <span id="lose-contacts" class="font-bold">0 Contacts</span>
            </div>
          </div>

          <div
            class="text-[12px] text-center italic text-gray-800 px-2 leading-relaxed"
          >
            "Credibility is of utmost importance for ECO staff. As a result of
            correspondence recently brought to our attention, your role here has
            come to an end."
          </div>

          <div
            class="mt-8 text-[10px] text-gray-500 uppercase tracking-widest animate-pulse"
          >
            Access Revoked. See Security.
          </div>
        </div>
      </div>
    </div>

    <!-- PROMOTION SCREEN -->
    <div
      id="promotion-screen"
      class="hidden fixed inset-0 z-[140] bg-white flex items-center justify-center p-8 overflow-y-auto"
    >
      <div
        class="max-w-xl w-full border-8 border-double border-gray-300 p-8 flex flex-col items-center bg-[#fffcf0] shadow-xl relative"
      >
        <div class="absolute top-4 right-4 text-xs font-mono text-gray-400">
          INTERNAL MEMO #882-B
        </div>
        <div class="text-3xl font-serif font-bold text-[#000080] mb-2">
          OFFICE OF THE DIRECTOR
        </div>
        <div class="w-full border-b-2 border-[#000080] mb-8"></div>

        <h1
          class="text-4xl font-serif font-bold text-center mb-8 uppercase tracking-widest"
        >
          Notice of Promotion
        </h1>

        <p
          class="mb-4 text-lg leading-relaxed first-letter:text-5xl first-letter:font-bold first-letter:float-left first-letter:mr-2"
        >
          After a thorough review of your performance metrics during the
          previous fiscal quarters, the Board of Directors has approved your
          advancement within the organization.
        </p>

        <div
          class="my-8 text-center p-6 border-2 border-dashed border-[#000080] bg-blue-50 w-full"
        >
          <div class="text-sm font-bold uppercase text-gray-500 mb-1">
            New Assignment:
          </div>
          <div
            id="promotion-new-title"
            class="text-3xl font-bold text-[#000080] mb-4"
          >
            SENIOR OPERATIONS ANALYST
          </div>

          <div class="text-xs font-bold uppercase text-gray-500 mb-2">
            Acquired Executive Perks:
          </div>
          <div id="promotion-perks" class="text-sm italic text-gray-700">
            +1 Signature Slot, +5 Base Damage
          </div>
        </div>

        <p class="mb-12 text-center text-gray-600 italic">
          "Efficiency is its own reward."
        </p>

        <button
          onclick="advanceToNextQuarter()"
          class="px-12 py-4 bg-[#000080] text-white font-bold hover:bg-blue-700 transition-colors shadow-lg"
        >
          ADVANCE TO NEXT QUARTER
        </button>

        <div class="mt-8 opacity-20 grayscale">
          <img
            src="https://api.placeholder.com/100/100"
            class="w-20 h-20"
            alt="Corporate Seal"
          />
        </div>
      </div>
    </div>

    <!-- START SCREEN -->
    <div
      id="start-screen"
      class="fixed inset-0 z-[100] flex items-center justify-center bg-[#008080] p-4"
    >
      <div class="bg-[#c0c0c0] p-4 retro-border max-w-sm w-full shadow-2xl">
        <div
          class="bg-[#000080] text-white px-2 py-1 mb-4 flex justify-between items-center text-xs"
        >
          <span>NEW USER SETUP</span>
          <span>✕</span>
        </div>
        <h1
          class="text-4xl font-bold mb-2 text-center terminal-font tracking-widest text-[#000080]"
        >
          REPLY ALL
        </h1>
        <p class="mb-4 text-[11px] text-center leading-tight italic">
          "The path to being at peace is long and full of micro-agressions."
        </p>

        <div class="space-y-3 mb-6">
          <div>
            <label class="block text-[10px] font-bold uppercase mb-1"
              >Full Name:</label
            >
            <input
              id="player-name-input"
              type="text"
              placeholder="eke vdh"
              class="w-full p-2 bg-white retro-border-inset outline-none text-sm"
            />
          </div>
          <div>
            <label class="block text-[10px] font-bold uppercase mb-1"
              >Email:</label
            >
            <div
              id="email-preview"
              class="text-[11px] font-mono text-gray-800 bg-white/50 p-2 border border-dotted border-gray-400"
            >
              ...
            </div>
          </div>
        </div>

        <button
          onclick="startNewGame()"
          class="w-full py-3 font-bold retro-button text-[#000080]"
        >
          SIGN UP
        </button>
        <div id="login-section" class="mt-3 hidden">
          <div class="text-[10px] uppercase font-bold text-gray-500 mb-1">
            Existing User
          </div>
          <button
            id="login-btn"
            onclick="resumeGame()"
            class="w-full py-2 font-bold retro-button text-[#000080]"
          >
            Login as (...)
          </button>
        </div>
      </div>
    </div>

    <!-- MAIN GAME INTERFACE -->
    <div
      id="game-ui"
      class="hidden flex flex-col w-full h-full max-w-5xl bg-[#c0c0c0] retro-border overflow-hidden"
    >
      <div
        class="bg-[#000080] text-white p-1 flex justify-between items-center shrink-0"
      >
        <div class="flex items-center gap-2 px-1">
          <span id="game-header-subject" class="text-xs font-bold truncate"
            >Outlook Express - [RE: URGENT: Breakroom Smell]</span
          >
          <span
            id="game-quarter-display"
            class="text-[10px] bg-white text-blue-900 px-1 font-bold"
            >Q3 - YEAR 1</span
          >
        </div>
        <div class="flex gap-1 pr-1">
          <button
            class="w-4 h-4 bg-[#c0c0c0] border border-white text-black text-[10px] flex items-center justify-center"
          >
            _
          </button>
          <button
            class="w-4 h-4 bg-[#c0c0c0] border border-white text-black text-[10px] flex items-center justify-center"
          >
            X
          </button>
        </div>
      </div>

      <div
        class="flex gap-1 p-1 bg-[#c0c0c0] border-b border-[#808080] overflow-x-auto shrink-0 no-scrollbar"
      >
        <button
          class="retro-button text-[10px] font-bold flex items-center gap-1"
        >
          <svg
            class="w-3 h-3"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path d="M3 10l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V10z"></path>
          </svg>
          Inbox
        </button>
        <button class="retro-button text-[10px]">Mark as Read</button>
        <div class="flex-grow"></div>
        <div
          id="turn-clock"
          class="text-[10px] bg-white px-2 py-1 retro-border-inset font-mono"
        >
          09:00 AM
        </div>
      </div>

      <div class="flex flex-grow overflow-hidden relative">
        <div
          class="hidden md:flex w-48 bg-[#dfdfdf] border-r border-[#808080] flex-col shrink-0"
        >
          <div class="p-2 text-[10px] font-bold border-b border-[#808080]">
            Folders
          </div>
          <div class="p-2 space-y-1 text-[11px]">
            <div class="bg-blue-800 text-white px-1">Inbox (5)</div>
            <div class="px-1 text-gray-500">Promotions (3)</div>
            <div class="px-1">Sent Items</div>
            <div class="px-1">Deleted</div>
          </div>
        </div>

        <div class="flex-grow flex flex-col bg-white overflow-hidden">
          <!-- Bureaucratic Header -->
          <div
            class="p-2 bg-[#f0f0f0] border-b border-[#808080] text-[10px] shrink-0 space-y-1"
          >
            <div class="flex items-center gap-2">
              <span class="font-bold w-12 text-right">To:</span>
              <div
                id="target-selector"
                class="flex gap-1 overflow-x-auto no-scrollbar py-0.5"
              ></div>
            </div>
            <div class="flex gap-2 items-center" id="active-ccs">
              <span class="font-bold w-12 text-right">CC:</span>
              <div id="cc-display" class="flex gap-1 text-gray-400 italic">
                No one in loop.
              </div>
            </div>
          </div>

          <!-- Message Log -->
          <div
            id="message-log"
            class="flex-grow overflow-y-auto p-3 space-y-6 scroll-container bg-white font-sans text-sm"
          ></div>

          <!-- STATS BAR -->
          <div
            class="bg-[#dfdfdf] border-t border-[#808080] px-2 py-1.5 flex flex-col gap-1 shrink-0"
          >
            <div class="flex justify-between items-end">
              <span class="text-[9px] font-bold uppercase text-[#000080]"
                >Professional Credibility</span
              >
              <span id="player-hp-label" class="text-[9px] font-mono font-bold"
                >100/100</span
              >
            </div>
            <div class="h-3.5 w-full bg-white border border-[#808080] relative">
              <div
                id="player-hp-fill"
                class="h-full bg-green-500 transition-all duration-300"
                style="width: 100%"
              ></div>
            </div>
            <div class="flex justify-between items-center mt-0.5">
              <div class="flex gap-3">
                <div class="flex items-center gap-1">
                  <span class="text-[8px] font-bold uppercase opacity-60"
                    >Leverage:</span
                  >
                  <div class="w-16 h-1.5 bg-white border border-[#808080]">
                    <div
                      id="player-ult-fill"
                      class="h-full bg-yellow-400 transition-all"
                      style="width: 0%"
                    ></div>
                  </div>
                </div>
              </div>
              <div
                id="player-win-status"
                class="text-[8px] font-bold bg-[#c0c0c0] px-1 border border-inset border-white uppercase"
              >
                New Wins: 3 Available
              </div>
            </div>
          </div>

          <!-- Action Panel -->
          <div class="p-2 bg-[#c0c0c0] border-t-2 border-white shrink-0">
            <div class="grid grid-cols-3 gap-1.5 max-w-lg mx-auto">
              <button
                onclick="performAction('ATTACK')"
                class="retro-button py-2 flex flex-col items-center"
              >
                <span class="text-[11px] font-bold">Reply to</span>
                <span id="attack-subtext" class="text-[8px] opacity-70 italic"
                  >Target Reply</span
                >
              </button>
              <button
                onclick="performAction('ESCALATE')"
                class="retro-button py-2 flex flex-col items-center"
              >
                <span class="text-[11px] font-bold">Escalate</span>
                <span id="escalate-subtext" class="text-[8px] opacity-70 italic"
                  >Threadwide Nudge</span
                >
              </button>
              <button
                onclick="openAddressBook()"
                class="retro-button py-2 flex flex-col items-center"
              >
                <span class="text-[11px] font-bold">Loop Personnel</span>
                <span id="loop-subtext" class="text-[8px] opacity-70 italic"
                  >Add Witness</span
                >
              </button>
              <button
                id="win-btn"
                onclick="performAction('PROMOTE')"
                class="retro-button py-2 flex flex-col items-center"
              >
                <span class="text-[11px] font-bold">Self-Promote</span>
                <span id="promote-subtext" class="text-[8px] opacity-70 italic"
                  >Log a Win</span
                >
              </button>
              <button
                onclick="performAction('DEFLECT')"
                class="retro-button py-2 flex flex-col items-center"
              >
                <span class="text-[11px] font-bold">Deflect</span>
                <span id="deflect-subtext" class="text-[8px] opacity-70 italic"
                  >Hold Line</span
                >
              </button>
              <button
                id="reply-all-btn"
                onclick="performAction('ULT')"
                class="retro-button py-2 flex flex-col items-center disabled:opacity-50"
                disabled
              >
                <span class="text-[11px] font-bold text-red-800"
                  >REPLY ALL</span
                >
                <span id="ult-subtext" class="text-[8px] opacity-70 italic"
                  >Mass Takedown</span
                >
              </button>
            </div>
          </div>

          <div
            class="bg-[#c0c0c0] border-t border-white px-1 flex gap-px text-[9px] h-5 shrink-0"
          >
          <div
            class="retro-border-inset px-2 flex items-center flex-grow truncate cursor-pointer"
            id="status-bar-name"
            title="View stats"
          >
            Logged Out
          </div>
            <div
              class="retro-border-inset px-2 flex items-center w-24 justify-center"
              id="status-bar-email"
            >
              Online
            </div>
            <div
              class="retro-border-inset px-2 flex items-center w-12 justify-center"
            >
              NUM
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: ADDRESS BOOK -->
    <div
      id="address-book"
      class="fixed inset-0 z-[110] bg-black/50 items-center justify-center p-4 hidden flex"
    >
      <div class="bg-[#c0c0c0] retro-border w-full max-w-sm shadow-2xl">
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold"
        >
          <span id="address-book-title">PERSONNEL DIRECTORY</span>
          <button onclick="closeAddressBook()" class="px-1">✕</button>
        </div>
        <div
          id="contact-list"
          class="max-h-64 overflow-y-auto p-2 space-y-2 bg-white"
        ></div>
        <div class="p-2 flex justify-end bg-[#c0c0c0]">
          <button
            onclick="closeAddressBook()"
            class="retro-button text-xs px-4"
          >
            CANCEL
          </button>
        </div>
      </div>
    </div>
    <div
      id="cc-profile"
      class="fixed inset-0 z-[120] bg-black/50 items-center justify-center p-4 hidden flex"
    >
      <div class="bg-[#c0c0c0] retro-border w-full max-w-xs shadow-2xl">
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold"
        >
          <span id="cc-profile-title">CC Profile</span>
          <button onclick="closeCcProfile()" class="px-1">✕</button>
        </div>
        <div class="p-3 bg-white text-[11px] space-y-2">
          <div>
            <div class="font-bold text-[#000080]" id="cc-profile-name"></div>
            <div class="text-gray-600" id="cc-profile-role"></div>
          </div>
          <div class="text-gray-700" id="cc-profile-dept"></div>
          <div class="text-gray-700 italic" id="cc-profile-effect"></div>
        </div>
        <div class="p-2 flex justify-end bg-[#c0c0c0]">
          <button
            onclick="closeCcProfile()"
            class="retro-button text-xs px-4"
          >
            CLOSE
          </button>
        </div>
      </div>
    </div>
    <div
      id="set-info"
      class="fixed inset-0 z-[130] bg-black/50 items-center justify-center p-4 hidden flex"
    >
      <div class="bg-[#c0c0c0] retro-border w-full max-w-sm shadow-2xl">
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold"
        >
          <span id="set-info-title">Set</span>
          <button onclick="closeSetInfo()" class="px-1">✕</button>
        </div>
        <div class="p-3 bg-white text-[11px] space-y-2">
          <div class="font-bold text-[#000080]" id="set-info-name"></div>
          <div class="space-y-1">
            <div class="text-[10px] uppercase text-gray-500 font-bold">
              Parts
            </div>
            <div id="set-info-parts" class="flex flex-wrap gap-1"></div>
          </div>
          <div class="text-gray-700" id="set-info-bonus"></div>
          <div class="text-gray-600 italic" id="set-info-status"></div>
        </div>
        <div class="p-2 flex justify-end bg-[#c0c0c0]">
          <button
            onclick="closeSetInfo()"
            class="retro-button text-xs px-4"
          >
            CLOSE
          </button>
        </div>
      </div>
    </div>
    <div
      id="training-modal"
      class="fixed inset-0 z-[140] bg-black/50 items-center justify-center p-4 hidden flex"
    >
      <div class="bg-[#c0c0c0] retro-border w-full max-w-sm shadow-2xl">
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold"
        >
          <span id="training-title">Training Selection</span>
          <button onclick="closeTrainingModal()" class="px-1">✕</button>
        </div>
        <div class="p-3 bg-white text-[11px] space-y-2">
          <div class="font-bold text-[#000080]" id="training-name"></div>
          <div class="text-gray-600" id="training-subtitle"></div>
          <div id="training-options" class="space-y-2"></div>
        </div>
        <div class="p-2 flex justify-end bg-[#c0c0c0]">
          <button
            onclick="closeTrainingModal()"
            class="retro-button text-xs px-4"
          >
            CLOSE
          </button>
        </div>
      </div>
    </div>

    <script>
      // --- GAME DATA ---

      const DEPARTMENTS = [
        { id: "operations", name: "Operations" },
        { id: "information_technology", name: "Information Technology" },
        { id: "executive_council_office", name: "Executive Council Office" },
        {
          id: "facilities_and_administration",
          name: "Facilities and Administration",
        },
        { id: "marketing", name: "Marketing" },
        { id: "constituent_services", name: "Constituent Services" },
        { id: "policy", name: "Policy" },
        { id: "finance", name: "Finance" },
        { id: "human_resources", name: "Human Resources" },
        { id: "legal", name: "Legal" },
        { id: "m4_agency", name: "M4 Agency" },
      ];

      const DEPARTMENT_BY_ID = Object.fromEntries(
        DEPARTMENTS.map((d) => [d.id, d]),
      );

      const CONTACTS = [
        {
          id: "cc_telly_operations",
          name: "Telly",
          title: "Intern",
          rarity: "common",
          departmentId: "marketing",
          employeeId: "telly_marketing",
          bonus: "+3 reply to",
          loopInText:
            "I'm looping in <strong>{name}</strong> to generate a contact report for this thread.",
          eff: {
            singleDmg: 3,
          },
          usedBy: null,
        },
        {
          id: "cc_willy_boy_information_technology",
          name: "Willy Boy",
          title: "IT Specialist",
          rarity: "common",
          departmentId: "information_technology",
          bonus: "+5 Credibility/turn.",
          loopInText:
            "I'm looping in <strong>{name}</strong> because I think we need an {title} to help with the technical issues affecting others' replies in this thread.",
          eff: {
            heal: 5,
          },
          usedBy: null,
        },
        {
          id: "cc_colin_information_technology",
          name: "Colin",
          title: "IT Lead",
          rarity: "uncommon",
          departmentId: "information_technology",
          employeeId: "colin_information_technology",
          bonus: "Reply to +5 & Escalate +3.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to keep our technical support aligned and logged.",
          eff: {
            singleDmg: 5,
            replyAllDmg: 3,
          },
          usedBy: null,
        },
        {
          id: "cc_samantha_executive_council_office",
          name: "Samantha",
          title: "Director of Marketing",
          rarity: "uncommon",
          departmentId: "executive_council_office",
          employeeId: "samantha_executive_council_office",
          bonus: "Reduce incoming damage by 4.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to help frame this conversation around department wide resourcing.",
          eff: {
            defFlat: 4,
          },
          usedBy: null,
        },
        {
          id: "cc_tim_executive_council_office",
          name: "Tim",
          title: "Premier",
          rarity: "rare",
          departmentId: "executive_council_office",
          bonus: "2x Leverage gain.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to keep him in the loop on this initative.",
          eff: {
            levMult: 1,
          },
          usedBy: null,
        },
        {
          id: "cc_nimby_facilities_and_administration",
          name: "Nimby",
          title: "Office Cat",
          rarity: "rare",
          departmentId: "facilities_and_administration",
          bonus: "35% Distraction chance.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to provide this thread more light-hearted content.",
          eff: {
            dodge: 0.35,
          },
          usedBy: null,
        },
        {
          id: "cc_lisa_marketing",
          name: "Lisa",
          title: "Director of Research",
          rarity: "uncommon",
          departmentId: "marketing",
          bonus: "+8 reply to",
          loopInText:
            "I'm looping in <strong>{name}</strong> to provide data‑driven context and keep claims grounded.",
          eff: {
            singleDmg: 8,
          },
          usedBy: null,
        },
        {
          id: "cc_meghan_cassedy_executive_council_office",
          name: "Meghan Cassedy",
          title: "Marketing Advisor",
          rarity: "uncommon",
          departmentId: "executive_council_office",
          bonus: "Reduce incoming damage by 3.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to advise on our tactical approach and reduce reputational risk.",
          eff: {
            defFlat: 3,
          },
          usedBy: null,
        },
        {
          id: "cc_larry_facilities_and_administration",
          name: "Larry",
          title: "Facilities Lead",
          rarity: "common",
          departmentId: "facilities_and_administration",
          bonus: "Reduce incoming damage by 2 & +3 Credibility/turn.",
          loopInText:
            "I'm looping in <strong>{name}</strong> ({title}) to handle the facilities impact.",
          eff: {
            defFlat: 2,
            heal: 3,
          },
          usedBy: null,
        },
        {
          id: "cc_dave_constituent_services",
          name: "Dave",
          title: "Social Media Manager",
          rarity: "rare",
          departmentId: "constituent_services",
          bonus: "No combat bonus, but +4 REP if in loop at end of match.",
          loopInText:
            "I'm looping in <strong>{name}</strong> for awareness and to mitigate reputational risk if this thread leaks.",
          eff: {
            endRep: 4,
          },
          usedBy: null,
        },
        {
          id: "cc_gemma_policy",
          name: "Gemma",
          title: "Policy Analyst",
          rarity: "uncommon",
          departmentId: "policy",
          bonus: "Reduce incoming damage by 3.",
          loopInText:
            "I'm looping in <strong>{name}</strong> from {department} to ensure this stays within policy guardrails.",
          eff: {
            defFlat: 3,
          },
          usedBy: null,
        },
        {
          id: "cc_adam_finance",
          name: "Adam",
          title: "Budget Controller",
          rarity: "uncommon",
          departmentId: "finance",
          bonus: "+5 Max Credibility & +5 Credibility/turn.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to track fiscal impact against budgetary constraints and keep the numbers straight.",
          eff: {
            maxHp: 5,
            heal: 5,
          },
          usedBy: null,
        },
        {
          id: "cc_rowan_constituent_services",
          name: "Rowan",
          title: "Public Liaison",
          rarity: "rare",
          departmentId: "constituent_services",
          bonus: "+5 reply to and +1 REP if in loop at end of match.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to handle external messaging and stakeholder optics.",
          eff: {
            singleDmg: 5,
            endRep: 1,
          },
          usedBy: null,
        },
        {
          id: "cc_karen_human_resources",
          name: "Karen",
          title: "HR Manager",
          rarity: "common",
          departmentId: "human_resources",
          employeeId: "karen_human_resources",
          bonus: "Reduce incoming damage by 2.",
          loopInText:
            "I'm looping in <strong>{name}</strong> from {department} to keep this thread compliant with HR policy.",
          eff: {
            defFlat: 2,
          },
          usedBy: null,
        },
        {
          id: "cc_avery_operations",
          name: "Avery",
          title: "Operations Coordinator",
          rarity: "common",
          departmentId: "operations",
          employeeId: "avery_operations",
          bonus: "+2 reply to.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to track operational impact and keep this moving.",
          eff: {
            singleDmg: 2,
          },
          usedBy: null,
        },
        {
          id: "cc_malik_marketing",
          name: "Malik",
          title: "Marketing Lead",
          rarity: "common",
          departmentId: "marketing",
          employeeId: "malik_marketing",
          bonus: "+1 all messages",
          loopInText:
            "I'm looping in <strong>{name}</strong> to keep brand alignment on this thread.",
          eff: {
            globalDmg: 1,
          },
          usedBy: null,
        },
        {
          id: "cc_priya_finance",
          name: "Priya",
          title: "Finance Analyst",
          rarity: "common",
          departmentId: "finance",
          employeeId: "priya_finance",
          bonus: "+3 Credibility/turn.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to monitor budget exposure and expected impact.",
          eff: {
            heal: 3,
          },
          usedBy: null,
        },
        {
          id: "cc_rory_operations",
          name: "Rory",
          title: "Facilities Coordinator",
          rarity: "common",
          departmentId: "operations",
          employeeId: "rory_operations",
          bonus: "Reduce incoming damage by 1 and +2 Credibility/turn.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to keep the facilities schedule and shared space aligned.",
          eff: {
            defFlat: 1,
            heal: 2,
          },
          usedBy: null,
        },
        {
          id: "cc_dora_finance",
          name: "Dora",
          title: "Budget Specialist",
          rarity: "common",
          departmentId: "finance",
          employeeId: "dora_finance",
          bonus: "+10 Max Credibility.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to see if she can get help with her budgets.",
          eff: {
            maxHp: 10,
          },
          usedBy: null,
        },
        {
          id: "cc_christina_policy",
          name: "Christina",
          title: "Policy Officer",
          rarity: "common",
          departmentId: "policy",
          employeeId: "christina_policy",
          bonus: "Deflect +2.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to ensure we stay aligned with policy language.",
          eff: {
            deflect: 2,
          },
          usedBy: null,
        },
        {
          id: "cc_fraser_information_technology",
          name: "Fraser",
          title: "IT Support",
          rarity: "common",
          departmentId: "information_technology",
          employeeId: "fraser_information_technology",
          bonus: "Deflect +2.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to support technical logging and incident tracking.",
          eff: {
            deflect: 2,
          },
          usedBy: null,
        },
        {
          id: "cc_anthony_m4_agency",
          name: "Anthony",
          title: "Media Coordinator",
          rarity: "common",
          departmentId: "m4_agency",
          employeeId: "anthony_m4_agency",
          bonus: "+3 reply all",
          loopInText:
            "I'm looping in <strong>{name}</strong> to manage the broader comms fallout.",
          eff: {
            replyAllDmg: 3,
          },
          usedBy: null,
        },
        {
          id: "cc_jonah_finance",
          name: "Jonah",
          title: "Budget Analyst",
          rarity: "uncommon",
          departmentId: "finance",
          employeeId: "jonah_finance",
          bonus: "+5 Max Credibility and +2 Credibility/turn.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to provide a spend analysis and risk outlook.",
          eff: {
            maxHp: 5,
            heal: 2,
          },
          usedBy: null,
        },
        {
          id: "cc_megan_legal",
          name: "Megan",
          title: "Compliance Counsel",
          rarity: "uncommon",
          departmentId: "legal",
          employeeId: "megan_legal",
          bonus: "Reduce incoming damage by 3.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to confirm our legal footing.",
          eff: {
            defFlat: 3,
          },
          usedBy: null,
        },
        {
          id: "cc_interns_human_resources",
          name: "Interns",
          title: "Intern Collective",
          rarity: "uncommon",
          departmentId: "human_resources",
          employeeId: "interns_human_resources",
          bonus: "Follow-up chance +20%.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to document intern feedback and thread tone.",
          eff: {
            followUpChance: 0.20,
          },
          usedBy: null,
        },
        {
          id: "cc_sheila_finance",
          name: "Sheila",
          title: "Payroll Specialist",
          rarity: "uncommon",
          departmentId: "finance",
          employeeId: "sheila_finance",
          bonus: "+25% reputation gains.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to keep payroll exposure in view.",
          eff: {
            repBonus: 0.25,
          },
          usedBy: null,
        },
        {
          id: "cc_taz_m4_agency",
          name: "Taz",
          title: "Media Planner",
          rarity: "uncommon",
          departmentId: "m4_agency",
          employeeId: "taz_m4_agency",
          bonus: "+5 escalate.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to sync the escalation plan and media response.",
          eff: {
            escalateDmg: 5,
          },
          usedBy: null,
        },
        {
          id: "cc_anneke_executive_council_office",
          name: "Anneke",
          title: "Senior Advisor",
          rarity: "rare",
          departmentId: "executive_council_office",
          employeeId: "anneke_executive_council_office",
          bonus: "+4 reply to and +4 REP if in loop at end of match.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to provide executive counsel and strategic framing.",
          eff: {
            singleDmg: 4,
            endRep: 4,
          },
          usedBy: null,
        },
        {
          id: "cc_selina_m4_agency",
          name: "Selina",
          title: "Account Director",
          rarity: "rare",
          departmentId: "m4_agency",
          employeeId: "selina_m4_agency",
          bonus: "+5 all messages",
          loopInText:
            "I'm looping in <strong>{name}</strong> to stabilize the account and reframe the narrative.",
          eff: {
            globalDmg: 5,
          },
          usedBy: null,
        },
      ];

      const TITLES = [
        {
          name: "Cubicle Resident",
          id: "cubicle_resident",
          level: 1,
          addressLimit: 5,
          sigLimit: 2,
          maxHp: 0,
          singleDmg: 0,
        },
        {
          name: "Junior Clerk",
          id: "junior_clerk",
          level: 2,
          addressLimit: 7,
          sigLimit: 4,
          maxHp: 10,
          singleDmg: 2,
        },
        {
          name: "Senior Clerk",
          id: "senior_clerk",
          level: 3,
          addressLimit: 9,
          sigLimit: 6,
          maxHp: 20,
          singleDmg: 4,
        },
        {
          name: "Program Coordinator",
          id: "program_coordinator",
          level: 4,
          addressLimit: 11,
          sigLimit: 8,
          maxHp: 30,
          singleDmg: 6,
        },
        {
          name: "Director",
          id: "director",
          level: 5,
          addressLimit: 13,
          sigLimit: 10,
          maxHp: 40,
          singleDmg: 8,
        },
        {
          name: "Deputy Director",
          id: "deputy_director",
          level: 6,
          addressLimit: 15,
          sigLimit: 11,
          maxHp: 50,
          singleDmg: 10,
        },
        {
          name: "Department Chief",
          id: "department_chief",
          level: 7,
          addressLimit: 17,
          sigLimit: 12,
          maxHp: 60,
          singleDmg: 12,
        },
        {
          name: "Deputy Minister",
          id: "deputy_minister",
          level: 8,
          addressLimit: 20,
          sigLimit: 15,
          maxHp: 70,
          singleDmg: 14,
        }
      ];

      const SIGNATURES = [
        {
          id: "iphone",
          name: "Sent from my iPhone",
          bonus:
            "Gain 1 rep for each person who removes themselves that you did not instigate.",
          rarity: "common",
          repBonus: 1,
        },
        {
          id: "regards",
          name: "Kind Regards,",
          bonus: "Reduce incoming damage by 1.",
          rarity: "common",
          defFlat: 1,
        },
        {
          id: "per_my_last",
          name: "Per my last email,",
          bonus: "+10% reply to",
          rarity: "uncommon",
          singleDmgMult: 0.1,
        },
        {
          id: "best",
          name: "Best,",
          bonus: "+2 Credibility/turn.",
          rarity: "uncommon",
          heal: 2,
        },
        {
          id: "thanks_advance",
          name: "Thanks in advance,",
          bonus: "50% chance to double leverage gain.",
          rarity: "rare",
          doubleLevChance: 0.5,
        },
        {
          id: "encrypted",
          name: "Sent from my encrypted workstation",
          bonus: "15% damage reduction.",
          rarity: "rare",
          def: 0.15,
        },
        {
          id: "renewable_energy",
          name: "Our office aspires to be powered by 100% renewable energy.",
          bonus: "Dept splash +5.",
          rarity: "rare",
          replyDeptSplash: 5,
        },
        {
          id: "environment_printing",
          name: "Please consider the environment before printing this email",
          bonus: "+1 Credibility/turn.",
          rarity: "uncommon",
          setId: "earth_set",
          heal: 3,
        },
        {
          id: "coffee_break",
          name: "Sent from the breakroom coffee line",
          bonus: "+2% leverage gain.",
          rarity: "common",
          setId: "coffee_lovers",
          levMult: 0.02,
        },
        {
          id: "double_espresso",
          name: "Powered by double espresso",
          bonus: "+1 reply to",
          rarity: "common",
          setId: "coffee_lovers",
          singleDmg: 1,
        },
        {
          id: "disclaimer",
          name: "Standard Disclaimer Applied",
          bonus: "+10% reply to",
          rarity: "common",
          singleDmgMult: 0.1,
        },
        {
          id: "breakroom",
          name: "Sent from the breakroom",
          bonus: "+2 Credibility/turn.",
          rarity: "uncommon",
          heal: 2,
        },
      ];

      const SALUTATIONS = [
        {
          id: "hi_all",
          name: "Hi all,",
          bonus: "+10 Max Credibility",
          rarity: "common",
          maxHp: 10,
        },
        {
          id: "good_afternoon",
          name: "Good afternoon,",
          bonus: "+5 Max Credibility and +1 Credibility/turn",
          rarity: "common",
          maxHp: 5,
          heal: 1,
        },
        {
          id: "good_evening",
          name: "Good evening,",
          bonus: "+20% leverage gain",
          rarity: "uncommon",
          levMult: 0.20,
        },
        {
          id: "all",
          name: "All,",
          bonus: "+1 reply to",
          rarity: "common",
          singleDmg: 1,
        },
        {
          id: "hello_team",
          name: "Hello team,",
          bonus: "+1 Credibility/turn",
          rarity: "common",
          heal: 1,
        },
        {
          id: "all_stakeholders",
          name: "To all stakeholders,",
          bonus: "+5 all messages",
          rarity: "rare",
          globalDmg: 5,
        },
        {
          id: "working_group",
          name: "To the working group,",
          bonus: "Deflect +2.",
          rarity: "uncommon",
          deflect: 2,
        },
        {
          id: "committee",
          name: "To the committee,",
          bonus: "+2 reply all",
          rarity: "uncommon",
          replyAllDmg: 2,
        },
        {
          id: "team",
          name: "Team,",
          bonus: "+2 reply to",
          rarity: "common",
          singleDmg: 2,
        },
        {
          id: "colleagues",
          name: "Dear Colleagues,",
          bonus: "Deflect +1.",
          rarity: "uncommon",
          deflect: 1,
        },
        {
          id: "everyone",
          name: "Everyone,",
          bonus: "+10% Leverage gain",
          rarity: "uncommon",
          levMult: 0.1,
        },
        {
          id: "formal",
          name: "To whom it may concern,",
          bonus: "+5 reply to",
          rarity: "rare",
          singleDmg: 5,
        },
        {
          id: "morning",
          name: "Good morning,",
          bonus: "+10 Max Credibility",
          rarity: "common",
          maxHp: 10,
        },
        {
          id: "project_team",
          name: "To the Project Team,",
          bonus: "+2 reply to",
          rarity: "common",
          singleDmg: 2,
        },
        {
          id: "sustainability_team",
          name: "To the Sustainability Team,",
          bonus: "+5 all messages",
          rarity: "uncommon",
          setId: "earth_set",
          globalDmg: 5,
        },
        {
          id: "greetings",
          name: "Greetings all,",
          bonus: "Deflect +1.",
          rarity: "uncommon",
          deflect: 1,
        },
      ];

      const SIGNOFFS = [
        {
          id: "thanks",
          name: "Thanks,",
          bonus: "+10 Max Credibility",
          rarity: "common",
          maxHp: 10,
        },
        {
          id: "respectfully",
          name: "Respectfully,",
          bonus: "Reduce incoming damage by 1.",
          rarity: "common",
          defFlat: 1,
        },
        {
          id: "regards_signoff",
          name: "Regards,",
          bonus: "+5 Max Credibility and +1 Credibility/turn",
          rarity: "common",
          maxHp: 5,
          heal: 1,
        },
        {
          id: "kind_regards_signoff",
          name: "Kind regards,",
          bonus: "+2 Credibility/turn",
          rarity: "common",
          heal: 2,
        },
        {
          id: "yours_truly",
          name: "Yours truly,",
          bonus: "+5% leverage gain",
          rarity: "uncommon",
          levMult: 0.05,
        },
        {
          id: "best_signoff",
          name: "Best,",
          bonus: "+2 reply to",
          rarity: "uncommon",
          singleDmg: 2,
        },
        {
          id: "thank_you",
          name: "Thank you,",
          bonus: "+10% reputation gains",
          rarity: "uncommon",
          repBonus: 0.1,
        },
        {
          id: "with_appreciation",
          name: "With appreciation,",
          bonus: "+1 REP at end of match.",
          rarity: "uncommon",
          endRep: 1,
        },
        {
          id: "for_your_awareness",
          name: "For your awareness,",
          bonus: "+3 reply all",
          rarity: "rare",
          replyAllDmg: 3,
        },
        {
          id: "cheers",
          name: "Cheers,",
          bonus: "+2 Credibility/turn",
          rarity: "common",
          heal: 2,
        },
        {
          id: "sincerely",
          name: "Sincerely,",
          bonus: "Deflect +2.",
          rarity: "uncommon",
          deflect: 2,
        },
        {
          id: "best_regards",
          name: "Best Regards,",
          bonus: "+5 reply to",
          rarity: "uncommon",
          singleDmg: 5,
        },
        {
          id: "v_respectfully",
          name: "Very Respectfully,",
          bonus: "+20% Leverage gain",
          rarity: "rare",
          levMult: 0.2,
        },
        {
          id: "warmly",
          name: "Warmly,",
          bonus: "+10 Max Credibility",
          rarity: "common",
          maxHp: 10,
        },
        {
          id: "solidarity",
          name: "In solidarity,",
          bonus: "+2 Credibility/turn",
          rarity: "common",
          heal: 2,
        },
        {
          id: "solidarity_earth",
          name: "In solidarity with the Earth",
          bonus: "Deflect +2.",
          rarity: "uncommon",
          setId: "earth_set",
          deflect: 2,
        },
        {
          id: "best_wishes",
          name: "Best wishes,",
          bonus: "10% Leverage gain",
          rarity: "uncommon",
          levMult: 0.1,
        },
      ];

      const BCC_CONTACTS = [
        {
          id: "recall",
          name: "Recall Message",
          bonus: "Instantly stun current target for 1 turn.",
          rarity: "common",
          effect: "stun",
        },
        {
          id: "urgent",
          name: "Urgent Flag",
          bonus: "Next reply to deals 2x damage.",
          rarity: "uncommon",
          effect: "doubleDmg",
        },
        {
          id: "redirect",
          name: "Redirect Message",
          bonus: "Current target attacks another random opponent next turn.",
          rarity: "rare",
          effect: "redirect",
        },
      ];

      const SET_DEFS = [
        {
          id: "earth_set",
          name: "Sustainability Protocol",
          items: [
            { type: "salutation", id: "sustainability_team" },
            { type: "signoff", id: "solidarity_earth" },
            { type: "signature", id: "environment_printing" },
          ],
          effect: {
            globalDmg: 1,
            deflect: 1,
            escalateRecoverPerHit: 1,
          },
        },
        {
          id: "it_duo",
          name: "Infrastructure Coverage",
          items: [
            { type: "contact", id: "cc_willy_boy_information_technology" },
            { type: "contact", id: "cc_colin_information_technology" },
          ],
          effect: {
            replyDeptSplash: 2,
            followUpChance: 0.15,
          },
        },
        {
          id: "coffee_lovers",
          name: "Coffee Lovers",
          items: [
            { type: "signature", id: "coffee_break" },
            { type: "signature", id: "double_espresso" },
          ],
          effect: {
            bounceBase: 5,
          },
        },
      ];

      const EMPLOYEES = [
        {
          id: "karen_human_resources",
          name: "Karen (HR)",
          email: "k.smith@gov.org",
          departmentId: "human_resources",
          color: "text-purple-700",
          defeatMessage:
            "I am unsubscribing. I've documented the lack of professional decorum and will be following up with each of you individually. Regards.",
          selfPromote:
            "I've just updated the internal wiki with our new 'Efficiency Standards'. My contribution score is through the roof.",
          deflectLines: [
            "I'm pausing to document this thread before responding further.",
          ],
          lines: [
            {
              text: "Your recent breakroom habits suggest a lack of respect for shared departmental assets.",
              missionId: "microwave",
            },
            {
              text: "I noticed you haven't completed the mandatory 'Digital Hygiene' training module for this quarter.",
              missionId: null,
            },
            {
              text: "I have three disciplinary hearings today; this thread is a significant drain on my operational capacity.",
              missionId: null,
            },
            {
              text: "HR provides the framework for your employment; your contributions are currently being 're-evaluated'.",
              missionId: null,
            },
            {
              text: "Please review the updated 'Shared Space Etiquette' PDF attached to my signature.",
              missionId: null,
            },
            {
              text: "I'm scheduling a mandatory mediation session for the entire floor this Friday at 4:30 PM.",
              missionId: null,
            },
            {
              text: "Your tone in this thread has been noted and will be discussed during your next performance review.",
              missionId: null,
            },
            {
              text: "We have a zero-tolerance policy for passive-aggressive CC-ing. Please adhere to the chain of command.",
              missionId: null,
            },
            {
              text: "I've CC'd the Chief Wellness Officer to address the 'toxic environment' you're creating.",
              missionId: null,
            },
            {
              text: "Failure to identify the salmon-heater will result in a collective reduction of the 'Team Synergy' bonus.",
              missionId: "microwave",
            },
            {
              text: "I'm looking at the handbook right now, and you're in violation of Section 8.4: Olfactory Neutrality.",
              missionId: "microwave",
            },
            {
              text: "This 'Reply All' behavior is exactly why we can't have nice things, like the espresso machine I vetoed.",
              missionId: null,
            },
          ],
        },
        {
          id: "avery_operations",
          name: "Avery (Ops)",
          email: "a.ops@gov.org",
          departmentId: "operations",
          color: "text-slate-700",
          defeatMessage:
            "I'm removing myself from this thread and logging the incident with Facilities. We'll reset the room schedule after this.",
          selfPromote:
            "I updated the weekly facilities checklist ahead of schedule. Process discipline still matters.",
          deflectLines: [
            "I'm pausing to document this thread before responding further.",
          ],
          lines: [
            {
              text: "The conference room has a safety walkthrough scheduled; we need that time block to proceed.",
              missionId: "calendar_chaos",
            },
            {
              text: "I can resolve this quickly if we stick to the booking records and timestamps.",
              missionId: "calendar_chaos",
            },
            {
              text: "Please use the shared calendar correctly. It's there for a reason.",
              missionId: null,
            },
            {
              text: "We can't keep reassigning rooms on short notice without disrupting core operations.",
              missionId: null,
            },
          ],
        },
        {
          id: "rory_operations",
          name: "Rory (Facilities)",
          email: "r.facilities@gov.org",
          departmentId: "operations",
          color: "text-slate-600",
          defeatMessage:
            "Alright we don't need to share. I've got work to do and a desk to return to. I'll see you all in the office.",
          selfPromote:
            "I was in by 6 AM and already cleared two work orders. The office runs when we're here.",
          deflectLines: [
            "I'm pausing to document this before I get back to the floor.",
          ],
          lines: [
            {
              text: "We can share the room. Everyone's already here—let's just run the meetings together.",
              missionId: "calendar_chaos",
            },
            {
              text: "The office is for working. If we're all in the building, we can make it work.",
              missionId: "calendar_chaos",
            },
            {
              text: "I'd rather stay in the office and solve this than bounce rooms all day.",
              missionId: null,
            },
            {
              text: "Honestly, I love being here. Let's just share the space and get it done.",
              missionId: null,
            },
          ],
        },
        {
          id: "larry_facilities_and_administration",
          name: "Larry (Facilities)",
          email: "l.facilities@gov.org",
          departmentId: "facilities_and_administration",
          color: "text-stone-700",
          defeatMessage:
            "I'm stepping out. These halls have seen worse, and so have I.",
          selfPromote:
            "I kept the building running during three leadership changes. The lights stayed on.",
          deflectLines: [
            "I'm pausing to recall the last time this policy changed.",
          ],
          lines: [
            {
              text: "I'd rather set it lower and save on the oil bill. 64°F is not outrageous.",
              missionId: "thermostat_war",
            },
            {
              text: "We keep this place running. Heating costs are real and they add up fast.",
              missionId: "thermostat_war",
            },
            {
              text: "The old holiday parties used to happen after hours in the lobby. We kept it simple.",
              missionId: "holiday_reply_all",
            },
            {
              text: "I miss the days when we just posted a flyer by the elevator and called it done.",
              missionId: "holiday_reply_all",
            },
            {
              text: "When the old deputy minister signed the first operational charter, we settled disputes in person.",
              missionId: null,
            },
            {
              text: "This reminds me of the 1998 reorg. We survived by keeping things simple.",
              missionId: null,
            },
            {
              text: "Facilities isn't glamorous, and it's not what I wanted for myself, but it's the backbone. Try to respect our perspective.",
              missionId: null,
            },
            {
              text: "I was at the very top once. Now I'm stuck in threads like these.",
              missionId: null,
            },
          ],
        },
        {
          id: "priya_finance",
          name: "Priya (Finance)",
          email: "p.finance@gov.org",
          departmentId: "finance",
          color: "text-emerald-700",
          defeatMessage:
            "We'll proceed without the room. If payroll slips, that's on this thread.",
          selfPromote:
            "We closed the month early and kept variance under 1%. That's the standard.",
          deflectLines: [
            "I'm pausing to document the payroll risk before responding.",
          ],
          lines: [
            {
              text: "We need it cooler. 96°F makes accurate review impossible.",
              missionId: "thermostat_war",
            },
            {
              text: "64°F is low, but it's preferable to 96°F for review work.",
              missionId: "thermostat_war",
            },
            {
              text: "Payroll finalization closes today. We need the room and the time block.",
              missionId: "calendar_chaos",
            },
            {
              text: "Moving this meeting puts paychecks at risk. I'm not signing off on that.",
              missionId: "calendar_chaos",
            },
            {
              text: "The cost of delay is real. Please treat this as priority.",
              missionId: null,
            },
            {
              text: "We have a reporting cutoff. This isn't optional.",
              missionId: null,
            },
          ],
        },
        {
          id: "jonah_finance",
          name: "Jonah (Budget)",
          email: "j.budget@gov.org",
          departmentId: "finance",
          color: "text-emerald-700",
          defeatMessage:
            "I'm stepping out. Please summarize decisions for the ledger.",
          selfPromote:
            "I closed the variance gap without cutting services. That's budget discipline.",
          deflectLines: [
            "I'm pausing to reconcile the numbers before replying.",
          ],
          lines: [
            {
              text: "We need to confirm the funding source before agreeing to any changes.",
              missionId: null,
            },
            {
              text: "This impacts our quarterly forecast, we need to be precise.",
              missionId: null,
            },
            {
              text: "I can align the figures, but I need a clear decision path.",
              missionId: null,
            },
            {
              text: "Budget constraints aren't optional. They're the framework.",
              missionId: null,
            },
          ],
        },
        {
          id: "dora_finance",
          name: "Dora (Budget)",
          email: "d.budget@gov.org",
          departmentId: "finance",
          color: "text-emerald-600",
          defeatMessage:
            "I'm stepping out. I'll send my notes offline.",
          selfPromote:
            "I held the budget together through sheer willpower. We need another pair of hands.",
          deflectLines: [
            "I'm holding response until this is documented.",
          ],
          lines: [
            {
              text: "I'm melting at 96°F. I can't reconcile anything in this heat.",
              missionId: "thermostat_war",
            },
            {
              text: "I can handle 68°F, but 64°F is too low. Please don't drop it further.",
              missionId: "thermostat_war",
            },
            {
              text: "I'm behind on reconciliation and I can't catch up without this block of time.",
              missionId: "calendar_chaos",
            },
            {
              text: "We booked this for review and sign-off. If we move it, we miss the cutoff.",
              missionId: "calendar_chaos",
            },
            {
              text: "Honestly, I need help. Is anyone available to jump in on reconciliation?",
              missionId: null,
            },
            {
              text: "I'm drowning in numbers here. Please don't make this harder.",
              missionId: null,
            },
          ],
        },
        {
          id: "telly_marketing",
          name: "Telly (Intern)",
          email: "telly.marketing@gov.org",
          departmentId: "marketing",
          color: "text-slate-700",
          defeatMessage:
            "I booked the room properly, but I'll give it up this time I guess.",
          selfPromote:
            "I handled the scheduling backlog this morning. Everything was confirmed.",
          deflectLines: [
            "I'm pausing to document the booking record before replying.",
          ],
          lines: [
            {
              text: "I booked the room at 8:12 AM and sent confirmations to both teams.",
              missionId: "calendar_chaos",
            },
            {
              text: "The calendar shows a single reservation. The double booking happened after my confirmation.",
              missionId: "calendar_chaos",
            },
            {
              text: "I can forward the timestamps if needed.",
              missionId: "calendar_chaos",
            },
            {
              text: "Please stop replying all. I'm just the intern.",
              missionId: null,
            },
          ],
        },
        {
          id: "lisa_marketing",
          name: "Lisa (Strategy)",
          email: "l.strategy@gov.org",
          departmentId: "marketing",
          color: "text-purple-700",
          defeatMessage:
            "I'm stepping out. Ping me when there's a decision with scope.",
          selfPromote:
            "While we've been chatting, I've aligned three teams and removed redundant staff.",
          deflectLines: [
            "I'm pausing to confirm scope and stakeholder ownership.",
          ],
          lines: [
            {
              text: "Our team is cold. We need 96°F or people can't focus.",
              missionId: "thermostat_war",
            },
            {
              text: "96°F is the only setting that works for us right now.",
              missionId: "thermostat_war",
            },
            {
              text: "We need a single holiday message with approved visuals. I can draft it.",
              missionId: "holiday_reply_all",
            },
            {
              text: "Please stop ad‑hoc replies; I'll consolidate and send a clean version.",
              missionId: "holiday_reply_all",
            },
            {
              text: "We need a clear owner and a single objective. This thread has neither.",
              missionId: null,
            },
            {
              text: "Align on scope first. Then we can talk timelines.",
              missionId: null,
            },
            {
              text: "This is not a messaging problem. It's a decision problem.",
              missionId: null,
            },
            {
              text: "I'm not approving anything without a clear risk assessment.",
              missionId: null,
            },
          ],
        },
        {
          id: "malik_marketing",
          name: "Malik (Marketing)",
          email: "m.marketing@gov.org",
          departmentId: "marketing",
          color: "text-violet-700",
          defeatMessage:
            "I'm stepping out. Please keep me in the loop on final messaging.",
          selfPromote:
            "I reorganized our messaging tiers and cut response time in half.",
          deflectLines: [
            "I'm pausing to align the team before responding.",
          ],
          lines: [
            {
              text: "We need one message, not five. Please align.",
              missionId: null,
            },
            {
              text: "I'm not comfortable moving forward without a clear audience.",
              missionId: null,
            },
            {
              text: "This is a visibility issue. Let's fix the narrative first.",
              missionId: null,
            },
            {
              text: "If we're changing direction, we need a reason and a plan.",
              missionId: null,
            },
          ],
        },
        {
          id: "meghan_cassedy_executive_council_office",
          name: "Meghan Cassedy (Advisor)",
          email: "m.cassedy@gov.org",
          departmentId: "executive_council_office",
          color: "text-blue-700",
          defeatMessage:
            "I've got something else to get to. I've removed myself from this thread.",
          selfPromote:
            "I mediated a cross‑department dispute without escalation. Balance matters.",
          deflectLines: [
            "I'm pausing to keep this constructive and level.",
          ],
          lines: [
            {
              text: "Leadership needs one succinct summary, not a cascade of greetings.",
              missionId: "holiday_reply_all",
            },
            {
              text: "I can summarize sentiments and send a brief note to leadership.",
              missionId: "holiday_reply_all",
            },
            {
              text: "Let's keep this calm and stick to the facts. We're well positioned to deal with any problems.",
              missionId: null,
            },
            {
              text: "I'm hearing multiple positions. Let's summarize and decide.",
              missionId: null,
            },
            {
              text: "We can disagree without escalating. Please keep it professional.",
              missionId: null,
            },
            {
              text: "If we align on outcomes, the path forward will be straightforward.",
              missionId: null,
            },
          ],
        },
        {
          id: "willy_boy_information_technology",
          name: "Willy Boy (Contractor?)",
          email: "w.boy@gov.org",
          departmentId: "information_technology",
          color: "text-indigo-600",
          defeatMessage:
            "I've figured out how to mute this thread. See you all in the next one.",
          selfPromote:
            "I was able to access the mail server last night, and restored email archival. Couldn't remove myself though.",
          deflectLines: [
            "I'm pausing to figure out why I'm on this email chain.",
          ],
          lines: [
            {
              text: "Did you add me to this holiday chain? I don't work here.",
              missionId: "holiday_reply_all",
            },
            {
              text: "I didn't get invited to any holiday parties this year unfortunately, maybe you could invite me next time?.",
              missionId: "holiday_reply_all",
            },
            {
              text: "This party looks really fun. Can you review my resume and let me know if I can join next year?",
              missionId: "holiday_reply_all",
            },
            {
              text: "I've never worked here. Why can I see this thread?",
              missionId: null,
            },
            {
              text: "This email seems to automatically forward to my personal, can you fix that for me?",
              missionId: null,
            },
            {
              text: "Someone should probably revoke my access, but until then... Hello!",
              missionId: null,
            },
            {
              text: "I don't work here, did you 'To:' me by mistake?",
              missionId: null,
            },
            {
              text: "Please remove me from this distribution. Or don't. It is interesting.",
              missionId: null,
            },
          ],
        },
        {
          id: "jules_marketing",
          name: "Jules (Brand)",
          email: "j.brand@gov.org",
          departmentId: "marketing",
          color: "text-purple-700",
          defeatMessage:
            "I'm stepping out. Please keep the tone consistent with the brand guidelines.",
          selfPromote:
            "I aligned three departments on voice in a single afternoon. The brand is safe.",
          deflectLines: [
            "I'm pausing to align this thread with the brand voice guide.",
          ],
          lines: [
            {
              text: "We need a warmer room. 96°F keeps people from bundling up on camera.",
              missionId: "thermostat_war",
            },
            {
              text: "Set it to 96°F and keep it there so we can do back‑to‑back calls.",
              missionId: "thermostat_war",
            },
            {
              text: "The current tone doesn't match our approved voice. Please revise for brand alignment.",
              missionId: null,
            },
            {
              text: "We cannot send anything that reads like internal conflict. Optics matter.",
              missionId: null,
            },
            {
              text: "Please route all outgoing statements through Brand for final review.",
              missionId: null,
            },
            {
              text: "Our public trust strategy hinges on consistency. This thread is not helping.",
              missionId: null,
            },
          ],
        },
        {
          id: "maya_marketing",
          name: "Maya (Comms)",
          email: "m.comms@gov.org",
          departmentId: "marketing",
          color: "text-fuchsia-700",
          defeatMessage:
            "I'm muting this for now. I'll draft a statement and circulate later.",
          selfPromote:
            "I got ahead of a media cycle before breakfast. That's proactive comms.",
          deflectLines: [
            "I'm pausing to draft a brief and de-escalate the narrative.",
          ],
          lines: [
            {
              text: "We need it warmer. 96°F keeps the team from freezing on calls.",
              missionId: "thermostat_war",
            },
            {
              text: "Please set it to 96°F and leave it. I couldn't get to the beach this year—vacation has to be at my desk.",
              missionId: "thermostat_war",
            },
            {
              text: "We need a clear, single narrative. Please stop fragmenting the message.",
              missionId: null,
            },
            {
              text: "I can write a holding statement, but I need consensus on facts.",
              missionId: null,
            },
            {
              text: "Tone check: this reads adversarial. Let's soften and align.",
              missionId: null,
            },
            {
              text: "If this goes external, we need a prepared response. I'm drafting now.",
              missionId: null,
            },
          ],
        },
        {
          id: "owen_marketing",
          name: "Owen (Content)",
          email: "o.content@gov.org",
          departmentId: "marketing",
          color: "text-amber-700",
          defeatMessage:
            "I'm out. Let me know when there's a final version to write up.",
          selfPromote:
            "I turned a dense briefing into a digest that people actually read.",
          deflectLines: [
            "I'm pausing to summarize this in an actionable format.",
          ],
          lines: [
            {
              text: "Happy to turn this into a one-pager, but I need a decision first.",
              missionId: null,
            },
            {
              text: "Can we bullet-point the key takeaways? The thread is too long.",
              missionId: null,
            },
            {
              text: "I can draft the internal update once we settle on next steps.",
              missionId: null,
            },
            {
              text: "This reads like three different narratives. Please pick one.",
              missionId: null,
            },
          ],
        },
        {
          id: "rina_marketing",
          name: "Rina (Social)",
          email: "r.social@gov.org",
          departmentId: "marketing",
          color: "text-pink-700",
          defeatMessage:
            "I'm stepping out. I'll monitor the socials in case this spills.",
          selfPromote:
            "I stabilized engagement after the last crisis. Metrics recovered within 24 hours.",
          deflectLines: [
            "I'm pausing to check sentiment before responding.",
          ],
          lines: [
            {
              text: "If this goes public, we need a response plan now.",
              missionId: null,
            },
            {
              text: "I'm seeing negative sentiment already. Let's tighten the messaging.",
              missionId: null,
            },
            {
              text: "Please avoid wording that could be screenshotted out of context.",
              missionId: null,
            },
            {
              text: "Engagement is spiking. Should I draft a thread or hold?",
              missionId: null,
            },
          ],
        },
        {
          id: "casey_legal",
          name: "Casey (Contracts)",
          email: "c.contracts@gov.org",
          departmentId: "legal",
          color: "text-red-700",
          defeatMessage:
            "I'm stepping out until this is fully redlined.",
          selfPromote:
            "I closed three vendor negotiations with zero exposure. Contracts are airtight.",
          deflectLines: [
            "I'm pausing to review the latest redlines before responding.",
          ],
          lines: [
            {
              text: "Avoid vendor shoutouts or gifts. That triggers disclosure rules.",
              missionId: "holiday_reply_all",
            },
            {
              text: "Keep the greeting generic—no promotions, no endorsements.",
              missionId: "holiday_reply_all",
            },
            {
              text: "We cannot proceed without approved contract language. Please pause.",
              missionId: null,
            },
            {
              text: "I need the most recent redline before I can sign off.",
              missionId: null,
            },
            {
              text: "Section 4.2 is ambiguous. This needs revision before distribution.",
              missionId: null,
            },
            {
              text: "Please avoid commitments that imply acceptance of liability.",
              missionId: null,
            },
          ],
        },
        {
          id: "imani_legal",
          name: "Imani (Regulatory)",
          email: "i.regulatory@gov.org",
          departmentId: "legal",
          color: "text-rose-700",
          defeatMessage:
            "I'm out. I'll file a compliance memo after this thread closes.",
          selfPromote:
            "I cleared the audit with zero findings. Compliance is maintained.",
          deflectLines: [
            "I'm pausing to verify regulatory requirements.",
          ],
          lines: [
            {
              text: "We need to document the decision trail for regulatory review.",
              missionId: null,
            },
            {
              text: "This action has reporting implications. We must follow the statute.",
              missionId: null,
            },
            {
              text: "Please avoid informal commitments that could trigger disclosure rules.",
              missionId: null,
            },
            {
              text: "I need confirmation that all parties completed compliance training.",
              missionId: null,
            },
          ],
        },
        {
          id: "victor_legal",
          name: "Victor (Litigation)",
          email: "v.litigation@gov.org",
          departmentId: "legal",
          color: "text-red-800",
          defeatMessage:
            "I'm stepping out. If this escalates, we’ll handle it formally.",
          selfPromote:
            "I resolved a complaint before it reached external counsel. That's prevention.",
          deflectLines: [
            "I'm pausing to assess exposure before replying.",
          ],
          lines: [
            {
              text: "This is a liability issue. Please stop and let Legal review.",
              missionId: null,
            },
            {
              text: "Any further escalation increases our exposure. Choose your words carefully.",
              missionId: null,
            },
            {
              text: "We need a clear record of who authorized this decision.",
              missionId: null,
            },
            {
              text: "If this goes public, our response must be coordinated through counsel.",
              missionId: null,
            },
          ],
        },
        {
          id: "nora_legal",
          name: "Nora (Privacy)",
          email: "n.privacy@gov.org",
          departmentId: "legal",
          color: "text-rose-600",
          defeatMessage:
            "I'm out. Please remove me from any non-essential distributions.",
          selfPromote:
            "I completed the privacy impact assessment early. Data handling is now compliant.",
          deflectLines: [
            "I'm pausing to check data handling requirements.",
          ],
          lines: [
            {
              text: "Do not share personal data in this thread. It's not compliant.",
              missionId: null,
            },
            {
              text: "We need to confirm consent before circulating these details.",
              missionId: null,
            },
            {
              text: "Please redact identifiers before forwarding this email.",
              missionId: null,
            },
            {
              text: "This thread should be restricted to those with a need to know.",
              missionId: null,
            },
          ],
        },
        {
          id: "elliot_policy",
          name: "Elliot (Policy Analyst)",
          email: "e.policy@gov.org",
          departmentId: "policy",
          color: "text-blue-600",
          defeatMessage:
            "I'm stepping out. Please submit updates on this to a policy process unrelated to myself.",
          selfPromote:
            "I shipped a policy framework that reduced approval time by half.",
          deflectLines: [
            "I'm pausing to map this to our policy framework.",
          ],
          lines: [
            {
              text: "All‑staff messages require a single approved sender. This chain violates policy.",
              missionId: "holiday_reply_all",
            },
            {
              text: "We should move this to a one‑way announcement and close replies.",
              missionId: "holiday_reply_all",
            },
            {
              text: "We need a clear logic model before making this change.",
              missionId: null,
            },
            {
              text: "This should follow the established policy pipeline. Please submit formally.",
              missionId: null,
            },
            {
              text: "I'm drafting a brief to capture the policy implications.",
              missionId: null,
            },
            {
              text: "We cannot bypass stakeholder review without precedent.",
              missionId: null,
            },
          ],
        },
        {
          id: "harper_policy",
          name: "Harper (Standards)",
          email: "h.standards@gov.org",
          departmentId: "policy",
          color: "text-indigo-600",
          defeatMessage:
            "I'm out. Please use the approved template when this resumes.",
          selfPromote:
            "I standardized the reporting format across three departments.",
          deflectLines: [
            "I'm pausing until the proper template is used.",
          ],
          lines: [
            {
              text: "Please resubmit using the approved formatting template.",
              missionId: null,
            },
            {
              text: "This doesn't meet the documentation standard. Revise.",
              missionId: null,
            },
            {
              text: "We need structured inputs, not freeform replies.",
              missionId: null,
            },
            {
              text: "The chain of approvals is required. Please follow it.",
              missionId: null,
            },
          ],
        },
        {
          id: "priyanka_policy",
          name: "Priyanka (Ethics)",
          email: "p.ethics@gov.org",
          departmentId: "policy",
          color: "text-blue-700",
          defeatMessage:
            "I'm stepping out. I'll submit an ethics note for the record.",
          selfPromote:
            "I completed the ethics review without delay. The record is clean.",
          deflectLines: [
            "I'm pausing to review potential conflicts.",
          ],
          lines: [
            {
              text: "We need to disclose any conflicts before proceeding.",
              missionId: null,
            },
            {
              text: "This thread raises ethics considerations that require review.",
              missionId: null,
            },
            {
              text: "Please document who benefits from this decision.",
              missionId: null,
            },
            {
              text: "I'm adding an ethics note for the record.",
              missionId: null,
            },
          ],
        },
        {
          id: "zane_policy",
          name: "Zane (Risk & Governance)",
          email: "z.risk@gov.org",
          departmentId: "policy",
          color: "text-slate-700",
          defeatMessage:
            "I'm out. I'll add this to the risk register and follow up.",
          selfPromote:
            "I closed three risk items ahead of audit. Governance is stable.",
          deflectLines: [
            "I'm pausing to log the risk implications.",
          ],
          lines: [
            {
              text: "This needs a risk assessment before we proceed.",
              missionId: null,
            },
            {
              text: "I'm adding this to the risk register as a new entry.",
              missionId: null,
            },
            {
              text: "The governance implications haven't been documented yet.",
              missionId: null,
            },
            {
              text: "We should identify mitigations before making any commitments.",
              missionId: null,
            },
          ],
        },
        {
          id: "christina_policy",
          name: "Christina (Pol)",
          email: "c.policy@gov.org",
          departmentId: "policy",
          color: "text-blue-700",
          defeatMessage:
            "This thread has been archived for non-compliance. I am removing myself to draft a formal reprimand. Policy remains absolute.",
          selfPromote:
            "My compliance logs are spotless. I've even color-coded the mandatory reading list for next quarter.",
          deflectLines: [
            "I'm holding my response until this thread is properly documented.",
          ],
          lines: [
            {
              text: "Per Policy 402.b, all communal appliances are to be used for non-odorous items only. Refer to the compliance guide.",
              missionId: "microwave",
            },
            {
              text: "I'm currently drafting a memorandum on 'Shared Air Space Ethics'. This thread is a case study in non-compliance.",
              missionId: "microwave",
            },
            {
              text: "The Policy department ensures rules are followed. Your blatant disregard for the Microwave Protocol is being escalated.",
              missionId: "microwave",
            },
            {
              text: "I've reviewed the 2019 precedent for 'unauthorized seafood heating'. It didn't end well for the perpetrator.",
              missionId: "microwave",
            },
            {
              text: "If you had attended the 'Navigating the Breakroom' seminar, we wouldn't be having this conversation.",
              missionId: null,
            },
            {
              text: "I am CC-ing the Ethics Committee. This is the procedurally correct way to handle olfactory aggression.",
              missionId: "microwave",
            },
            {
              text: "Your response lacks the required 'Directive 9' formatting. Please resubmit using approved templates.",
              missionId: null,
            },
            {
              text: "We are evaluating the environmental impact of your lunch choices. Sustainability is a core pillar of our mission.",
              missionId: null,
            },
            {
              text: "Failure to comply with 'No Fish Friday' is a breach of department harmony. I'm noting this in the audit.",
              missionId: "microwave",
            },
            {
              text: "The data suggests a 98% probability that you are the source of the incident based on desk location.",
              missionId: null,
            },
            {
              text: "Please cease and desist from using 'Reply All' unless you are citing a specific governmental regulation.",
              missionId: null,
            },
            {
              text: "This thread is now under the jurisdiction of the Policy Oversight Division. Peer-review your next comment.",
              missionId: null,
            },
          ],
        },
        {
          id: "megan_legal",
          name: "Megan (Legal)",
          email: "m.compliance@gov.org",
          departmentId: "legal",
          color: "text-red-700",
          defeatMessage:
            "I cannot continue this conversation without a physical copy of the minutes in front of me. Unsubscribing.",
          selfPromote:
            "I've successfully digitized the 1998 archive. Legal integrity has never been higher.",
          deflectLines: [
            "Given the compliance implications, I'm pausing to document this thread properly before responding.",
          ],
          lines: [
            {
              text: "The lack of physical documentation is a direct violation of the 2004 Record Keeping Act.",
              missionId: "paper",
            },
            {
              text: "I've drafted a cease and desist regarding this rationing. I'll send it as soon as I can find a working printer.",
              missionId: "paper",
            },
            {
              text: "Your 'digital-only' proposal fails to meet the standards for admissible evidence in a council hearing.",
              missionId: "paper",
            },
            {
              text: "I'm flagging this thread for potential liability issues. We need paper trails, not email trails.",
              missionId: null,
            },
            {
              text: "Without a hard copy, this policy is effectively unenforceable. Please reconsider.",
              missionId: "paper",
            },
            {
              text: "This change will directly result in a loss of admissible evidence one deleted email at a time.",
              missionId: "paper",
            },
            {
              text: "Please confirm who authorized this change so Legal can document the decision trail.",
              missionId: null,
            },
            {
              text: "I'm adding a retention note here in case this thread is requested later.",
              missionId: null,
            },
          ],
        },
        {
          id: "colin_information_technology",
          name: "Colin (IT)",
          email: "c.it@gov.org",
          departmentId: "information_technology",
          color: "text-indigo-700",
          defeatMessage:
            "Server load from this thread is too high. I'm muting this. Try rebooting your attitude.",
          selfPromote:
            "I've optimized the email server's routing protocols. You're welcome for that 0.02ms latency improvement.",
          deflectLines: [
            "I'm pausing to log this incident before replying further.",
          ],
          lines: [
            {
              text: "Have you tried not printing every single cat meme you see? It's clogging the spooler and the budget.",
              missionId: "paper",
            },
            {
              text: "The 'Paperless Initiative' has been ready for three years. You're just afraid of PDFs.",
              missionId: "paper",
            },
            {
              text: "I'm seeing a lot of 'Printer Error' tickets from your floor. Maybe try putting paper in the tray?",
              missionId: "paper",
            },
            {
              text: "Your 'urgent' requests are being redirected to the /dev/null of my inbox.",
              missionId: null,
            },
            {
              text: "If it's not a PDF, it doesn't exist to me anymore.",
              missionId: null,
            },
            {
              text: "The budget for paper was redirected to upgrade the firewall you keep trying to bypass.",
              missionId: "paper",
            },
            {
              text: "Stop asking for 'digital paper'. It's called a screen. Use it.",
              missionId: "paper",
            },
            {
              text: "I've limited your mailbox size to 50MB until the paper crisis is resolved. Choose your replies wisely.",
              missionId: "paper",
            },
          ],
        },
        {
          id: "fraser_information_technology",
          name: "Fraser (IT?)",
          email: "f.it@gov.org",
          departmentId: "information_technology",
          color: "text-indigo-600",
          defeatMessage:
            "Too many emails. I've got a survey to send on how we should redesign a 10-column spreadsheet.",
          selfPromote:
            "I've successfully piloted the new 'Spreadsheet-as-a-Service' portal, with absolutely no feedback so far!",
          deflectLines: [
            "I'm documenting this thread before I reply.",
          ],
          signatures: [
            {
              name: "For IT support, contact Colin at c.it@gov.org",
            },
          ],
          lines: [
            {
              text: "I'm not sure why I'm on this thread. but once my spreadsheet tracker initiative is complete, it will resolve any issues no doubt.",
              missionId: null,
            },
            {
              text: "You used it last I think, you fix it.",
              missionId: "paper",
            },
            {
              text: "I recently got Adobe suite installed for the first time.",
              missionId: null,
            },
            {
              text: "I'm planning to be away next week, can you take this?",
              missionId: null,
            },
            {
              text: "I get one of the interns to print things for me, so I wouldn't know about this.",
              missionId: "paper",
            },
          ],
        },
        {
          id: "interns_human_resources",
          name: "HR Interns",
          email: "hr.interns@gov.org",
          departmentId: "human_resources",
          color: "text-blue-900 font-bold",
          salutation: {
            name: "To the Permanent Staff,",
          },
          signOff: {
            name: "The Intern Collective",
          },
          signatures: [
            {
              name: "Unpaid & Unappreciated",
            },
          ],
          defeatMessage:
            "The intern pool has been drained. We are collectively resigning to pursue opportunities in a less toxic environment.",
          selfPromote:
            "We've collectively achieved a 100% coffee-order accuracy rate today. Future leadership material right here.",
          deflectLines: [
            "We're pausing to record this exchange before responding.",
          ],
          lines: [
            {
              text: "We've been CC'd on the entire thread and we're documenting everything for our final reports.",
              missionId: null,
            },
            {
              text: "Our collective research suggests that fish-microwaving is the #1 cause of decreased morale.",
              missionId: "microwave",
            },
            {
              text: "We've been instructed to flag any 'non-synergetic' behavior. This thread is 100% flaggable.",
              missionId: null,
            },
            {
              text: "As the future of this department, we demand a higher standard of digital decorum.",
              missionId: null,
            },
          ],
        },
        {
          id: "sheila_finance",
          name: "Sheila (Payroll)",
          email: "s.payroll@gov.org",
          departmentId: "finance",
          color: "text-green-700",
          salutation: {
            name: "Dear All,",
          },
          signOff: {
            name: "Best, Sheila",
          },
          defeatMessage:
            "I'm freezing all stipend payments until this thread is resolved. I'm out.",
          selfPromote:
            "I've reconciled the petty cash for the third time this morning. Every cent is accounted for.",
          deflectLines: [
            "I'm pausing to review the compliance implications before responding.",
          ],
          lines: [
            {
              text: "Your overtime request for 'email management' has been denied. Stick to the mission.",
              missionId: null,
            },
            {
              text: "I'm reviewing the cost-benefit analysis of your participation in this thread. It's not looking good.",
              missionId: null,
            },
            {
              text: "Every 'Reply All' costs the department approximately $4.12 in lost productivity. You've cost us a fortune today.",
              missionId: null,
            },
            {
              text: "Please refer to the payroll schedule before complaining about your 'emotional labor'.",
              missionId: "intern_grievance",
            },
          ],
        },
        {
          id: "samantha_executive_council_office",
          name: "Samantha (ECO)",
          email: "s.eco@gov.org",
          departmentId: "executive_council_office",
          color: "text-orange-700",
          defeatMessage:
            "I'm escalating this to the Deputy Director. I don't have time for intern drama.",
          selfPromote:
            "My latest 'Synergy Memo' has been read by 12% of the staff. Engagement is skyrocketing.",
          deflectLines: [
            "I'm holding response until I've logged this thread.",
          ],
          lines: [
            {
              text: "I don't see how this is relevant to me. This thread is a distraction.",
              missionId: null,
            },
            {
              text: "We need to 'lean in' to a more positive approach. Your tone has been very 'lean out'.",
              missionId: null,
            },
            {
              text: "I'm scheduling a sync-up to discuss if you'd ACTUALLY want my job.",
              missionId: null,
            },
            {
              text: "I'm taking this offline. And by offline, I mean I'm deleting your replies.",
              missionId: null,
            },
          ],
        },
        {
          id: "anneke_executive_council_office",
          name: "Anneke VDH (ECO)",
          email: "anneke.eco@gov.org",
          departmentId: "executive_council_office",
          color: "text-red-900",
          defeatMessage:
            "You know what? I'll leave this to the pipsqueaks. I'm out.",
          selfPromote:
            "I've managed to keep my 'Important' folder under 500 unread messages. Peak organizational skills.",
          deflectLines: [
            "I'm documenting this thread before I respond.",
          ],
          lines: [
            {
              text: "I think your latest reply violates the 'Civility in Digital Spaces' directive.",
              missionId: null,
            },
            {
              text: "I'm nude!",
              missionId: null,
            },
            {
              text: "I'm auditing this thread for potential FOIA requests. Mind your words.",
              missionId: null,
            },
            {
              text: "Regulatory standards require a 24-hour cooling-off period after a 'Reply All' incident. You ignored it.",
              missionId: null,
            },
            {
              text: "I've flagged this thread to the Auditor General. Good luck at the hearing.",
              missionId: null,
            },
            {
              text: "I'm at peace.",
              missionId: null,
            },
            {
              text: "I walk both the righteous path and my dog poopus.",
              missionId: null,
            },
          ],
        },
        {
          id: "selina_m4_agency",
          name: "Selina",
          email: "selina@m4agency.com",
          departmentId: "m4_agency",
          color: "#F08080",
          defeatMessage:
            "I just need 5 minutes to recalibrate my bandwidth. Then I'll circle back to this deliverable.",
          selfPromote:
            "I've reallocated my weekend to meet a deadline that is unrealistic at best for the fourth time this month.",
          deflectLines: [
            "I'm pausing to capture the record before responding.",
          ],
          lines: [
            {
              text: "Thanks for dropping this onto my plate. I'll just need to deprioritize sleep to action this immediately.",
              missionId: null,
            },
            {
              text: "I'm already operating at 150% billable time, but I will leverage my personal discretionary time to ensure we get through this again.",
              missionId: null,
            },
            {
              text: "Consider it done, though I should note this requires a significant expenditure of good faith that we won't need to stretch like this again in the future.",
              missionId: null,
            },
            {
              text: "Yes, I heard it was urgent. That's why I haven't left my desk since Tuesday. You're welcome.",
              missionId: null,
            },
            {
              text: "My current workload directly correlate with my projected last day.",
              missionId: null,
            },
            {
              text: "Which one of you fucks is wearing cologne?",
              missionId: null,
            },
          ],
        },
        {
          id: "taz_m4_agency",
          name: "Taz",
          email: "taz@m4agency.com",
          departmentId: "m4_agency",
          color: "#1B4F72",
          defeatMessage:
            "Look, okay, I'll reassess our current fee structure and see what we can do this time. But honestly, we'll be losing money on this..",
          selfPromote:
            "Yes, we cost a little more, but we always deliver something. In this market that goes a long way.",
          deflectLines: [
            "I'm holding response while I document this thread.",
          ],
          lines: [
            {
              text: "For this project to remain profitable, we're going to need you to approve a 10% mark-up on hard costs. Don't worry; it's strictly about cost predictability.",
              missionId: null,
            },
            {
              text: "Committing to hard dates at this stage is tough without budgetary approval. What do you say to a $20,000/mo retainer, plus hourly on top?",
              missionId: null,
            },
            {
              text: "These deliverables all sit firmly outside our current scope of work. We're going to need to reopen the conversation around billables if you want any adjustment.",
              missionId: null,
            },
            {
              text: "Look, as Elon says, 'your margin is my opportunity,' so pay up.",
              missionId: null,
            },
            {
              text: "Honestly Trump isn't that bad. SJW's are far worse for democracy.... What were we talking about again?",
              missionId: null,
            },
          ],
        },
        {
          id: "anthony_m4_agency",
          name: "Anthony",
          email: "anthony@m4agency.com",
          departmentId: "m4_agency",
          color: "#D3D3D3",
          defeatMessage:
            "While the current campaign metrics may appear suboptimal, they reflect an aggressive dedication to boundary testing. Frankly, the complexity of dealing with these minor budgetary concerns pales in comparison to the critical decisions my parents face daily in the OR.",
          selfPromote:
            "I've recently taken a medically valid and proactive approach to budget reallocation that was informed by an innate understanding of high-pressure environments, a skillset inherited genetically from my parents, who are both doctors.",
          deflectLines: [
            "I'm pausing to document this exchange before I reply.",
          ],
          lines: [
            {
              text: "I’m not seeing a fundamental systemic misalignment; merely a highly granular optimization phase. Horses very likely get measles, this was the right call.",
              missionId: "M015_MediaCrisis",
            },
            {
              text: "Are we sure these KPI targets are clinically validated? Because my father, the specialist, insists on evidence-based methodologies.",
              missionId: null,
            },
            {
              text: "The reason the campaigns aren't 'live' is that I'm implementing a proprietary soft-launch methodology. It’s highly technical. My mother, the head of cardiology, says I have a gift for complexity.",
              missionId: "M015_MediaCrisis",
            },
            {
              text: "We need to operationalize a full post-mortem review of this meeting, but let’s be brief. I have to go pick up my father to bring him to the hospital—they really need him there.",
              missionId: null,
            },
            {
              text: "My MTEI coursework explicitly covered why we shouldn't be revisiting foundational intake processes, but I suppose we can file the exception anyway.",
              missionId: null,
            },
            {
              text: "My MTEI curriculum was explicitly structured to prioritize demonstrable scalability over abstract alignment workshops; I'll wait for the deliverable checklist.",
              missionId: null,
            },
          ],
        },
      ];

      const MISSIONS = [
        {
          id: "microwave",
          subject: "URGENT: Breakroom Incident",
          from: "k.smith@gov.org",
          intro:
            "Hi team,<br><br>I am absolutely disgusted. Someone heated up fish in the breakroom microwave. <strong>{playerName}</strong>, I'm sure you noticed the stench. <strong>{opp1}</strong>, I know you have the policy manual out already. <strong>{opp0}</strong>, please document this.<br><br>Please advise immediately on who is responsible for this violation of shared space ethics.",
          opponents: [
            {
              id: 1,
              employeeId: "karen_human_resources",
              hp: 40,
              maxHp: 40,
              wins: 1,
              buffs: [],
              addressBook: ["cc_telly_operations"],
            },
            {
              id: 2,
              employeeId: "christina_policy",
              hp: 40,
              maxHp: 40,
              wins: 2,
              buffs: [],
              addressBook: ["cc_samantha_executive_council_office"],
            },
          ],
        },
        {
          id: "calendar_chaos",
          subject: "RE: Conference Room Double Booking",
          from: "facilities@gov.org",
          intro:
            "Hi all,<br><br>We have a triple booking for the main conference room this morning. <strong>{playerName}</strong>, you have it booked for an internal process audit. <strong>{opp0}</strong> and <strong>{opp1}</strong> from Operations flagged a safety walkthrough and vendor briefing. <strong>{opp2}</strong> and <strong>{opp3}</strong> from Finance flagged payroll finalization and budget reconciliation. <strong>{opp4}</strong>, thanks for the initial booking—please stand by while we sort this out.<br><br>Please reply with your priority and availability.",
          opponents: [
            {
              id: 9,
              employeeId: "avery_operations",
              hp: 50,
              maxHp: 50,
              wins: 2,
              buffs: [],
              addressBook: [],
            },
            {
              id: 10,
              employeeId: "rory_operations",
              hp: 50,
              maxHp: 50,
              wins: 2,
              buffs: [],
              addressBook: [],
            },
            {
              id: 11,
              employeeId: "priya_finance",
              hp: 40,
              maxHp: 40,
              wins: 2,
              buffs: [],
              addressBook: ["cc_adam_finance"],
            },
            {
              id: 12,
              employeeId: "dora_finance",
              hp: 40,
              maxHp: 40,
              wins: 2,
              buffs: [],
              addressBook: ["cc_adam_finance"],
            },
            {
              id: 13,
              employeeId: "telly_marketing",
              hp: 20,
              maxHp: 20,
              wins: 1,
              buffs: [],
              addressBook: [],
            },
          ],
        },
        {
          id: "holiday_reply_all",
          subject: "RE: Happy Holidays!",
          from: "announcements@gov.org",
          onlyMissionLines: true,
          intro:
            "Happy holidays everyone! Someone kicked off an all-staff greeting and the thread has exploded. <strong>{playerName}</strong>, please help rein it in. <strong>{opp0}</strong> says this should go through Facilities. <strong>{opp1}</strong> wants a single approved template. <strong>{opp2}</strong> is asking for leadership guidance. <strong>{opp3}</strong> is warning about system load. <strong>{opp4}</strong> raised legal concerns. <strong>{opp5}</strong> says this violates comms policy.<br><br>Please advise how we should proceed.",
          opponents: [
            {
              id: 14,
              employeeId: "larry_facilities_and_administration",
              hp: 50,
              maxHp: 50,
              wins: 2,
              buffs: [],
              addressBook: [],
            },
            {
              id: 15,
              employeeId: "lisa_marketing",
              hp: 50,
              maxHp: 50,
              wins: 2,
              buffs: [],
              addressBook: [],
            },
            {
              id: 16,
              employeeId: "meghan_cassedy_executive_council_office",
              hp: 50,
              maxHp: 50,
              wins: 2,
              buffs: [],
              addressBook: [],
            },
            {
              id: 17,
              employeeId: "willy_boy_information_technology",
              hp: 50,
              maxHp: 50,
              wins: 2,
              buffs: [],
              addressBook: [],
            },
            {
              id: 18,
              employeeId: "casey_legal",
              hp: 50,
              maxHp: 50,
              wins: 2,
              buffs: [],
              addressBook: [],
            },
            {
              id: 19,
              employeeId: "elliot_policy",
              hp: 50,
              maxHp: 50,
              wins: 2,
              buffs: [],
              addressBook: [],
            },
          ],
        },
        {
          id: "paper",
          subject: "CRITICAL: Departmental Paper Rationing",
          from: "facilities@gov.org",
          intro:
            "Dear Staff,<br><br>Due to unforeseen budget constraints, we are implementing immediate paper rationing. <strong>{playerName}</strong>, your department's printing logs are particularly high. <strong>Megan</strong>, please ensure we are still meeting filing requirements. <strong>Colin</strong>, please expedite the 'Paperless Initiative'.<br><br>Effective immediately, all non-essential printing is strictly prohibited.",
          opponents: [
            {
              id: 3,
              employeeId: "megan_legal",
              hp: 60,
              maxHp: 60,
              wins: 3,
              buffs: [],
              addressBook: ["cc_samantha_executive_council_office"],
            },
            {
              id: 4,
              employeeId: "colin_information_technology",
              hp: 50,
              maxHp: 50,
              wins: 3,
              buffs: [],
              addressBook: ["cc_willy_boy_information_technology"],
            },
            {
              id: 44,
              employeeId: "fraser_information_technology",
              hp: 30,
              maxHp: 30,
              wins: 3,
              buffs: [],
              addressBook: ["cc_willy_boy_information_technology"],
            },
          ],
        },
        {
          id: "thermostat_war",
          subject: "RE: Office Thermostat Dispute",
          from: "facilities@gov.org",
          intro:
            "Hi all,<br><br>Facilities here. We received multiple complaints about the floor thermostat. It looks like the setpoint has been toggled between 74°F and 96°F. <strong>{playerName}</strong>, your desk is listed at 74°F. My view is we should be aiming lower overall to bring down the oil bill for this place, but we need a consistent setting. The <strong>Marketing</strong> team (<strong>{opp1}</strong>, <strong>{opp2}</strong>) is pushing for 96°F. The <strong>Finance</strong> team (<strong>{opp3}</strong>, <strong>{opp4}</strong>) says the 96°F setting is unacceptable for reviews.<br><br>How does around 64°F sound?",
          opponents: [
            {
              id: 20,
              employeeId: "larry_facilities_and_administration",
              hp: 45,
              maxHp: 45,
              wins: 2,
              buffs: [],
              addressBook: [],
            },
            {
              id: 21,
              employeeId: "maya_marketing",
              hp: 45,
              maxHp: 45,
              wins: 2,
              buffs: [],
              addressBook: [],
            },
            {
              id: 22,
              employeeId: "jules_marketing",
              hp: 45,
              maxHp: 45,
              wins: 2,
              buffs: [],
              addressBook: [],
            },
            {
              id: 23,
              employeeId: "priya_finance",
              hp: 45,
              maxHp: 45,
              wins: 2,
              buffs: [],
              addressBook: ["cc_adam_finance"],
            },
            {
              id: 24,
              employeeId: "dora_finance",
              hp: 45,
              maxHp: 45,
              wins: 2,
              buffs: [],
              addressBook: ["cc_adam_finance"],
            },
          ],
        },
        {
          id: "intern_grievance",
          subject: "RE: Intern Grievance Collective",
          from: "interns.hr@gov.org",
          intro:
            "To the Permanent Staff,<br><br>We, the interns, have noticed a significant lack of 'Team Synergy' and 'Professional Courtesy'. <strong>{playerName}</strong>, your recent emails have been cited as 'aggressive'. <strong>Samantha</strong>, we are looping in our mentor <strong>Anneke</strong>. <strong>Shelia</strong>, we expect payroll to ensure our stipends to reflect the emotional labor of this thread.",
          opponents: [
            {
              id: 5,
              employeeId: "interns_human_resources",
              hp: 80,
              maxHp: 80,
              wins: 5,
              buffs: [],
              addressBook: ["cc_telly_operations"],
            },
            {
              id: 6,
              employeeId: "sheila_finance",
              hp: 70,
              maxHp: 70,
              wins: 2,
              buffs: [],
              addressBook: ["cc_meghan_cassedy_executive_council_office"],
            },
            {
              id: 7,
              employeeId: "samantha_executive_council_office",
              hp: 70,
              maxHp: 70,
              wins: 4,
              buffs: [],
              addressBook: ["cc_samantha_executive_council_office"],
            },
            {
              id: 8,
              employeeId: "anneke_executive_council_office",
              hp: 60,
              maxHp: 60,
              wins: 3,
              buffs: [],
              addressBook: ["cc_samantha_executive_council_office"],
            },
          ],
        },
        {
          id: "M015_MediaCrisis",
          subject: "CRITICAL: Budget Re-Forecasting & Ad Targeting Session",
          from: "taz@m4agency.com",
          intro:
            "Hey all,<br><br>There has been a <strong>significant overspend</strong> of the quarterly media budget earmarked for the strategic placement for the <strong>Measles Vaccination Initiative</strong>. During media plan implementation, an unforeseen configuration error on our end resulted in a demographic targeting misalignment—specifically, an overly focused optimization towards the <strong>equine sector</strong> executed entirely on day one. <strong>{playerName}</strong>, we need to leverage this emergency session to ensure continuity of service delivery.<br><strong>Selina</strong> and <strong>Anthony</strong> are here for support, and to use up our retainer. The objective is to devise a recovery plan that allows us to meet our six-week deliverable goals with additional budgetary approval, <strong>as the original $40,000 has been fully exhausted.</strong>",
          opponents: [
            {
              id: 1,
              employeeId: "selina_m4_agency",
              hp: 90,
              maxHp: 90,
              wins: 3,
              buffs: [],
              addressBook: ["cc_telly_operations"],
            },
            {
              id: 2,
              employeeId: "taz_m4_agency",
              hp: 80,
              maxHp: 80,
              wins: 3,
              buffs: [],
              addressBook: ["cc_samantha_executive_council_office"],
            },
            {
              id: 3,
              employeeId: "anthony_m4_agency",
              hp: 40,
              maxHp: 40,
              wins: 3,
              buffs: [],
              addressBook: ["cc_telly_operations"],
            },
          ],
        },
      ];

      let opponents = [];

      const SAVE_KEY = "reply_all_save_v1";

      let state = {
        player: {
          name: "eke vdh",
          email: "eke.vdh@gov.org",
          hp: 50,
          maxHp: 50,
          ult: 0,
          wins: 3,
          currentWins: 3,
          buffs: [],
          reputation: 0,
          year: 1,
          quarter: "Q3",
          title: TITLES[0],
          addressBook: ["cc_telly_operations"],
          signatures: [],
          salutation: null,
          signOff: null,
          bccContacts: [],
          departmentId: "executive_council_office",
          singleDmg: 10,
          escalateDmg: 5,
          replyAllDmg: 20,
          globalDmg: 0,
          singleDmgMult: 0,
          escalateDmgMult: 0,
          replyAllDmgMult: 0,
          globalDmgMult: 0,
          deflectPower: 3,
          deflect: 0,
          deflectCharge: 0,
          followUpChance: 0,
          replyDeptSplash: 0,
          escalateRecoverPerHit: 0,
          attacks: [
            "I believe we need to circle back to your recent comments. My focus is on department output, and I suggest yours should be too.",
            "I've already addressed this in my previous email, but for the sake of clarity, I'll repeat it: This is not my responsibility.",
            "Perhaps we should focus on next quarters' deliverables instead of speculating on departmental policy?",
            "I'm happy to discuss this in a 1-on-1, but I don't believe this is a productive use of the 'All-Staff' distribution list.",
          ],
          attackLinesByMission: {
            thermostat_war: [
              "I set it to 74°F because that's a normal working temperature. 96°F is not.",
              "I'm fine with 74°F. Let's stop changing it every hour.",
              "If we're picking a standard, 74°F is reasonable for most desks.",
            ],
          },
          attackLinesByTitle: {},
          escalateLines: [
            "Given the lack of alignment here, I'm escalating this thread for broader visibility.",
            "I'm escalating this to keep all stakeholders aligned and reduce duplication.",
          ],
          deflectLines: [
            "I'm taking a moment to document this properly before responding further.",
            "Let's pause and keep the thread within scope. I'll respond once this is reframed.",
          ],
          selfPromoteLines: [
            "Just logging a new win—the quarterly audit came back clean under my supervision. Always happy to add value to the organization!",
          ],
          selfPromoteLinesByMission: {
            thermostat_war: [
              "Quick update: I created a simple temperature log so we can stop arguing and use data.",
            ],
          },
          selfPromoteLinesByTitle: {},
          replyAllLines: [
            {
              subject: "Fwd: Salary_Discrepancies_2024.xlsx",
              body: "Not sure if I should be sending this to everyone, but since transparency is one of our 'core values', here is the full salary spreadsheet for the department. Enjoy.",
            },
          ],
          replyAllLinesByMission: {},
          replyAllLinesByTitle: {},
        },
        currentMissionIndex: 0,
        targetId: 1,
        turn: 0,
        isProcessing: false,
        gameOver: false,
        removedByPlayer: 0,
        removedTotal: 0,
        shop: {
          seminars: [],
          signatures: [],
          salutations: [],
          signoffs: [],
          promotions: [],
          bccs: [],
        },
        pendingTraining: null,
      };

      const nameInput = document.getElementById("player-name-input");
      const emailPreview = document.getElementById("email-preview");
      const loginSection = document.getElementById("login-section");
      const loginBtn = document.getElementById("login-btn");

      function getSavedGame() {
        try {
          const raw = localStorage.getItem(SAVE_KEY);
          return raw ? JSON.parse(raw) : null;
        } catch (e) {
          return null;
        }
      }

      function clearSavedGame() {
        try {
          localStorage.removeItem(SAVE_KEY);
        } catch (e) {}
      }

      function serializePlayer(player) {
        return {
          ...player,
          titleId: player.title ? player.title.id : null,
          salutationId: player.salutation ? player.salutation.id : null,
          signOffId: player.signOff ? player.signOff.id : null,
          signatureIds: player.signatures
            ? player.signatures.map((s) => s.id)
            : [],
          bccIds: player.bccContacts ? player.bccContacts.map((b) => b.id) : [],
        };
      }

      function hydratePlayer(saved) {
        const title = TITLES.find((t) => t.id === saved.titleId) || TITLES[0];
        const salutation = saved.salutationId
          ? SALUTATIONS.find((s) => s.id === saved.salutationId) || null
          : null;
        const signOff = saved.signOffId
          ? SIGNOFFS.find((s) => s.id === saved.signOffId) || null
          : null;
        const signatures = Array.isArray(saved.signatureIds)
          ? saved.signatureIds
              .map((id) => SIGNATURES.find((s) => s.id === id))
              .filter(Boolean)
          : [];
        const bccContacts = Array.isArray(saved.bccIds)
          ? saved.bccIds
              .map((id) => BCC_CONTACTS.find((b) => b.id === id))
              .filter(Boolean)
          : [];
        const player = {
          ...saved,
          title,
          salutation,
          signOff,
          signatures,
          bccContacts,
        };
        applyUnitDefaults(player);
        return player;
      }

      function serializeShop(shop) {
        const mapIds = (list) =>
          Array.isArray(list)
            ? list.map((item) => ({ id: item.id, purchased: !!item.purchased }))
            : [];
        return {
          seminars: mapIds(shop.seminars),
          signatures: mapIds(shop.signatures),
          salutations: mapIds(shop.salutations),
          signoffs: mapIds(shop.signoffs),
          promotions: mapIds(shop.promotions),
          bccs: mapIds(shop.bccs),
        };
      }

      function hydrateShop(savedShop) {
        if (!savedShop)
          return {
            seminars: [],
            signatures: [],
            salutations: [],
            signoffs: [],
            promotions: [],
            bccs: [],
          };
        const build = (list, source) =>
          (list || [])
            .map((item) => {
              const found = source.find((s) => s.id === item.id);
              if (!found) return null;
              return { ...found, purchased: !!item.purchased };
            })
            .filter(Boolean);
        return {
          seminars: build(savedShop.seminars, CONTACTS),
          signatures: build(savedShop.signatures, SIGNATURES),
          salutations: build(savedShop.salutations, SALUTATIONS),
          signoffs: build(savedShop.signoffs, SIGNOFFS),
          promotions: build(savedShop.promotions, getTrainingOffers()),
          bccs: build(savedShop.bccs, BCC_CONTACTS),
        };
      }

      function saveGame() {
        try {
          const payload = {
            state: {
              ...state,
              player: serializePlayer(state.player),
              shop: serializeShop(state.shop),
            },
            opponents,
            messageLog:
              document.getElementById("message-log")?.innerHTML || "",
            activeScreen: ["start-screen", "game-ui", "inbox-screen", "summary-screen", "shop-screen", "promotion-screen", "lose-screen"].find(
              (id) => {
                const el = document.getElementById(id);
                return el && !el.classList.contains("hidden");
              },
            ),
          };
          localStorage.setItem(SAVE_KEY, JSON.stringify(payload));
        } catch (e) {}
      }

      function applySavedGame(save) {
        if (!save || !save.state) return false;
        state = {
          ...save.state,
          player: hydratePlayer(save.state.player),
          shop: hydrateShop(save.state.shop),
        };
        opponents = Array.isArray(save.opponents) ? save.opponents : [];
        opponents.forEach((o) => {
          applyUnitDefaults(o);
          if (!o._lineBags) o._lineBags = {};
        });
        if (!state.player._lineBags) state.player._lineBags = {};
        return true;
      }

      function startNewGame() {
        clearSavedGame();
        startGame();
      }

      function resumeGame() {
        const save = getSavedGame();
        if (!save || !applySavedGame(save)) return;
        const screen = save.activeScreen || "inbox-screen";
        transitionTo(screen);
        if (screen === "game-ui") {
          const log = document.getElementById("message-log");
          if (log) log.innerHTML = save.messageLog || "";
          updateUI();
        } else if (screen === "shop-screen") {
          updateShopUI();
        } else if (screen === "summary-screen") {
          renderSummary();
        } else if (screen === "inbox-screen") {
          showInbox();
        }
        if (state.pendingTraining) openTrainingModal();
      }

      function initLoginOption() {
        const save = getSavedGame();
        if (save && save.state && save.state.player && save.state.player.name) {
          loginSection.classList.remove("hidden");
          loginBtn.innerText = `Login as ${save.state.player.name}`;
        } else {
          loginSection.classList.add("hidden");
        }
      }
      nameInput.addEventListener("input", (e) => {
        const val = e.target.value.trim() || "eke vdh";
        const email = val.toLowerCase().replace(/\s+/g, ".") + "@gov.org";
        emailPreview.innerText = email;
        state.player.email = email;
      });
      initLoginOption();

      document.addEventListener("keydown", (e) => {
        if (e.key !== "0") return;
        const tag = document.activeElement && document.activeElement.tagName;
        if (tag === "INPUT" || tag === "TEXTAREA") return;
        state.player.escalateDmg += 100;
        state.player.reputation += 1000;
        updateUI();
        if (!document.getElementById("shop-screen").classList.contains("hidden"))
          updateShopUI();
        alert("Debug boost: +100 escalate, +1000 REP.");
      });

      const statusBarName = document.getElementById("status-bar-name");
      const statsModal = document.getElementById("stats-modal");
      const statsModalClose = document.getElementById("stats-modal-close");
      if (statusBarName) statusBarName.addEventListener("click", openStatsModal);
      if (statsModalClose)
        statsModalClose.addEventListener("click", closeStatsModal);
      if (statsModal) {
        statsModal.addEventListener("click", (e) => {
          if (e.target === statsModal) closeStatsModal();
        });
      }

      function transitionTo(screenId) {
        const screens = [
          "start-screen",
          "game-ui",
          "inbox-screen",
          "summary-screen",
          "shop-screen",
          "promotion-screen",
          "lose-screen",
        ];
        screens.forEach((s) => {
          const el = document.getElementById(s);
          if (el) el.classList.add("hidden");
        });
        const target = document.getElementById(screenId);
        if (target) target.classList.remove("hidden");
        saveGame();
      }

      function startGame() {
        state.player.name = nameInput.value.trim() || "eke vdh";
        const email =
          state.player.name.toLowerCase().replace(/\s+/g, ".") + "@gov.org";
        state.player.email = email;
        document.getElementById("status-bar-email").innerText = "Online";
        showInbox();
        saveGame();
      }

      function showInbox() {
        transitionTo("inbox-screen");
        const list = document.getElementById("inbox-list");
        list.innerHTML = "";

        const mission = MISSIONS[state.currentMissionIndex] || MISSIONS[0];

        // The battle email (At the top)
        const urgent = document.createElement("div");
        urgent.className =
          "grid grid-cols-12 p-2 border-b border-gray-100 bg-blue-50 cursor-pointer hover:bg-blue-200 font-bold border-l-4 border-l-blue-600";
        urgent.onclick = startQuarter;
        urgent.innerHTML = `<div class="col-span-1 text-red-600">!</div><div class="col-span-4 text-blue-800">${mission.from}</div><div class="col-span-7">${mission.subject}</div>`;
        list.appendChild(urgent);

        // Spam emails
        const spamSubjects = [
          "Hot Stocks!",
          "Refinance Now",
          "Enlarge your career",
          "Inheritance Notification",
          "Meeting?",
          "Action Required: Password Reset",
          "Last Chance: Office Supply Lottery",
          "Invoice Attached",
          "Team Lunch Sign-Up",
          "Weekly Pipeline Digest",
          "Travel Reimbursement Pending",
          "Urgent: Calendar Sync",
          "Wellness Survey Reminder",
          "FW: Please Review",
          "Recruitment Outreach",
          "Security Notice",
          "New Policy Update",
          "Printer Status Alert",
          "Quarterly Town Hall",
          "Zoom Recording Available",
        ];
        for (let i = 0; i < 16; i++) {
          const spam = document.createElement("div");
          spam.className =
            "grid grid-cols-12 p-2 border-b border-gray-100 bg-gray-50 text-gray-400 opacity-60";
          spam.innerHTML = `<div class="col-span-1"></div><div class="col-span-4 truncate">bot-${Math.random().toString(36).substr(2, 5)}@junk.co</div><div class="col-span-7 truncate">${spamSubjects[i % spamSubjects.length]}</div>`;
          list.appendChild(spam);
        }

        document.getElementById("inbox-status").innerText =
          `${324 + state.player.year * 4} Messages, 1 Unread`;
        saveGame();
      }

      const STAT_FIELDS = [
        "escalateDmg",
        "replyAllDmg",
        "globalDmg",
        "singleDmg",
        "singleDmgMult",
        "escalateDmgMult",
        "replyAllDmgMult",
        "globalDmgMult",
        "maxHp",
        "wins",
        "deflectPower",
        "deflect",
        "followUpChance",
        "replyDeptSplash",
        "escalateRecoverPerHit",
        "defFlat",
        "def",
        "heal",
        "levMult",
        "repBonus",
        "endRep",
        "bounceBase",
      ];

      function applyUnitDefaults(u) {
        if (u.singleDmg == null) u.singleDmg = 10;
        if (u.escalateDmg == null) u.escalateDmg = 5;
        if (u.replyAllDmg == null) u.replyAllDmg = 20;
        if (u.globalDmg == null) u.globalDmg = 0;
        if (u.singleDmgMult == null) u.singleDmgMult = 0;
        if (u.escalateDmgMult == null) u.escalateDmgMult = 0;
        if (u.replyAllDmgMult == null) u.replyAllDmgMult = 0;
        if (u.globalDmgMult == null) u.globalDmgMult = 0;
        if (u.maxHp == null) u.maxHp = 0;
        if (u.wins == null) u.wins = 0;
        if (u.deflectPower == null) u.deflectPower = 3;
        if (u.deflect == null) u.deflect = 0;
        if (u.deflectCharge == null) u.deflectCharge = 0;
        if (u.followUpChance == null) u.followUpChance = 0;
        if (u.replyDeptSplash == null) u.replyDeptSplash = 0;
        if (u.escalateRecoverPerHit == null) u.escalateRecoverPerHit = 0;
        if (u.defFlat == null) u.defFlat = 0;
        if (u.def == null) u.def = 0;
        if (u.heal == null) u.heal = 0;
        if (u.levMult == null) u.levMult = 0;
        if (u.repBonus == null) u.repBonus = 0;
        if (u.endRep == null) u.endRep = 0;
        if (u.bounceBase == null) u.bounceBase = 0;
        if (!Array.isArray(u.deflectLines) || u.deflectLines.length === 0) {
          u.deflectLines = [
            "I'm pausing to document this thread before responding further.",
          ];
        }
      }

      function getUnitSetBonuses(u) {
        const bonuses = [];
        SET_DEFS.forEach((set) => {
          if (isSetActive(u, set)) bonuses.push(set.effect);
        });
        return bonuses;
      }

      function isSetActive(u, set) {
        if (!u || !set) return false;
        if (!Array.isArray(set.items) || set.items.length === 0) return false;
        const hasContact = (id) => {
          if (!Array.isArray(u.buffs)) return false;
          return u.buffs.some((b) => b.id === id);
        };
        const hasSignature = (id) => {
          if (!Array.isArray(u.signatures)) return false;
          return u.signatures.some((s) => s.id === id);
        };
        return set.items.every((item) => {
          if (!item || !item.type || !item.id) return false;
          if (item.type === "salutation")
            return u.salutation && u.salutation.id === item.id;
          if (item.type === "signoff")
            return u.signOff && u.signOff.id === item.id;
          if (item.type === "signature") return hasSignature(item.id);
          if (item.type === "contact") return hasContact(item.id);
          return false;
        });
      }
      function getUnitStatBlocks(u) {
        const blocks = [];
        if (!u) return blocks;
        blocks.push(u);
        if (u.title) blocks.push(u.title);
        if (u.salutation) blocks.push(u.salutation);
        if (u.signOff) blocks.push(u.signOff);
        if (Array.isArray(u.signatures)) blocks.push(...u.signatures);
        if (Array.isArray(u.buffs))
          blocks.push(...u.buffs.map((b) => (b.eff ? b.eff : b)));
        blocks.push(...getUnitSetBonuses(u));
        return blocks;
      }

      function computeUnitStats(u) {
        const stats = Object.fromEntries(STAT_FIELDS.map((f) => [f, 0]));
        getUnitStatBlocks(u).forEach((block) => {
          if (!block) return;
          STAT_FIELDS.forEach((field) => {
            const value = block[field];
            if (typeof value === "number") stats[field] += value;
          });
        });
        return stats;
      }

      function getStatBlockFromObject(obj) {
        if (!obj) return null;
        const stats = {};
        let hasAny = false;
        STAT_FIELDS.forEach((field) => {
          const value = obj[field];
          if (typeof value === "number" && value !== 0) {
            stats[field] = value;
            hasAny = true;
          }
        });
        return hasAny ? stats : null;
      }

      function getStatSources(u) {
        const sources = [];
        const pushSource = (label, obj) => {
          const stats = getStatBlockFromObject(obj);
          if (stats) sources.push({ label, stats });
        };
        if (!u) return sources;
        pushSource("Base", u);
        if (u.title) pushSource(`Title: ${u.title.name}`, u.title);
        if (u.salutation) pushSource(`Greeting: ${u.salutation.name}`, u.salutation);
        if (u.signOff) pushSource(`Sign-off: ${u.signOff.name}`, u.signOff);
        if (Array.isArray(u.signatures)) {
          u.signatures.forEach((s) => pushSource(`Signature: ${s.name}`, s));
        }
        if (Array.isArray(u.buffs)) {
          u.buffs.forEach((b) => {
            const name = b.name || b.id || "Contact";
            pushSource(`Contact: ${name}`, b.eff ? b.eff : b);
          });
        }
        SET_DEFS.forEach((set) => {
          if (isSetActive(u, set)) pushSource(`Set: ${set.name}`, set.effect);
        });
        return sources;
      }

      function getUnitMaxHp(u) {
        return computeUnitStats(u).maxHp;
      }

      function getUnitDeflectPower(u) {
        const stats = computeUnitStats(u);
        return stats.deflectPower + stats.deflect;
      }

      function getUnitTotalHeal(u) {
        return computeUnitStats(u).heal;
      }

      function getUnitDamage(u, type) {
        const stats = computeUnitStats(u);
        const fieldMap = {
          single: { dmg: "singleDmg", mult: "singleDmgMult" },
          escalate: { dmg: "escalateDmg", mult: "escalateDmgMult" },
          replyAll: { dmg: "replyAllDmg", mult: "replyAllDmgMult" },
        };
        const fields = fieldMap[type] || fieldMap.single;
        const base = stats[fields.dmg] || 0;
        const flat = stats.globalDmg || 0;
        const mult = 1 + (stats.globalDmgMult || 0) + (stats[fields.mult] || 0);
        return (base + flat) * mult;
      }

      function getUnitFlatDef(u) {
        return computeUnitStats(u).defFlat;
      }

      function getUnitTotalDef(u) {
        return computeUnitStats(u).def;
      }

      function getUnitFollowUpChance(u) {
        const chance = computeUnitStats(u).followUpChance;
        return Math.max(0, Math.min(1, chance));
      }

      function getUnitReplyDeptSplash(u) {
        return computeUnitStats(u).replyDeptSplash;
      }

      function getUnitEscalateRecover(u) {
        return computeUnitStats(u).escalateRecoverPerHit;
      }

      function getUnitBounceDamage(u) {
        const stats = computeUnitStats(u);
        if (!stats.bounceBase) return 0;
        const mult = 1 + (stats.globalDmgMult || 0);
        return Math.floor((stats.bounceBase + stats.globalDmg) * mult);
      }

      function pickBounceTarget(attacker, primaryTarget) {
        const units = [...opponents, state.player];
        const choices = units.filter(
          (u) => u && u.hp > 0 && u !== attacker && u !== primaryTarget,
        );
        return choices.length
          ? choices[Math.floor(Math.random() * choices.length)]
          : null;
      }

      function applyDamage(attacker, target, rawDamage, options = {}) {
        let dmg = Math.max(0, Math.floor(rawDamage));
        const flatDef = getUnitFlatDef(target);
        dmg = Math.max(0, dmg - flatDef);
        let def = getUnitTotalDef(target);
        dmg = Math.floor(dmg * (1 - def));

        let blocked = 0;
        if (target.deflectCharge && target.deflectCharge > 0 && dmg > 0) {
          blocked = Math.min(target.deflectCharge, dmg);
          dmg -= blocked;
          target.deflectCharge = 0;
        }

        target.hp -= dmg;

        let reflected = 0;
        if (!options.ignoreReflect && blocked > 0 && attacker) {
          reflected = blocked;
          if (attacker.id === "player") {
            state.player.hp -= reflected;
          } else if (attacker.hp != null) {
            attacker.hp -= reflected;
          }
        }

        updateUI();
        return { dmg, blocked, reflected };
      }

      function applyDepartmentSplash(attacker, target, splashDamage) {
        if (!splashDamage || !target || !target.departmentId)
          return { total: 0, hits: 0 };
        const units = [...opponents, state.player];
        let total = 0;
        let hits = 0;
        units.forEach((u) => {
          if (!u || u.hp <= 0) return;
          if (u === target) return;
          if (attacker && u === attacker) return;
          if (u.departmentId !== target.departmentId) return;
          const result = applyDamage(attacker, u, splashDamage, {
            ignoreReflect: true,
          });
          total += result.dmg;
          hits += 1;
          if (u !== state.player && u.hp <= 0) {
            handleOpponentDefeat(u, attacker && attacker.id === "player");
          }
        });
        return { total, hits };
      }

      function isContactInLoop(contactId) {
        if (state.player.buffs.some((b) => b.id === contactId)) return true;
        for (const opp of opponents) {
          if (opp.buffs.some((b) => b.id === contactId)) return true;
        }
        return false;
      }

      function getPlayerLeverageGain(base) {
        const p = state.player;
        const stats = computeUnitStats(p);
        let gain = base * (1 + stats.levMult);
        p.signatures.forEach((s) => {
          if (s.doubleLevChance && Math.random() < s.doubleLevChance) gain *= 2;
        });
        return gain;
      }

      function formatMessageBody(sender, content) {
        let body = "";
        if (sender.salutation) {
          body += `<strong>${sender.salutation.name}</strong><br><br>`;
        }
        body += content;
        if (sender.signOff) {
          body += `<br><br><strong>${sender.signOff.name}</strong><br>${sender.name}`;
        } else {
          body += `<br><br>${sender.name}`;
        }
        if (sender.signatures && sender.signatures.length > 0) {
          sender.signatures.forEach((sig) => {
            body += `<div class="text-[10px] text-gray-500 border-t border-gray-200 mt-2 pt-1">-- ${sig.name}</div>`;
          });
        }
        return body;
      }

      function pickRandomItem(list, fallback) {
        if (!Array.isArray(list) || list.length === 0) return fallback;
        return list[Math.floor(Math.random() * list.length)];
      }

      function drawFromLineBag(holder, key, source, fallback) {
        if (!holder) return fallback;
        if (!holder._lineBags) holder._lineBags = {};
        let bag = holder._lineBags[key];
        if (!Array.isArray(bag) || bag.length === 0) {
          const fresh = Array.isArray(source) ? [...source] : [];
          if (fresh.length === 0) return fallback;
          bag = shuffle(fresh);
        }
        const next = bag.pop();
        holder._lineBags[key] = bag;
        return next == null ? fallback : next;
      }

      function getPlayerLineBagKey(action, missionId, titleId) {
        return `player:${action}:${missionId || "default"}:${titleId || "base"}`;
      }

      function getPlayerActionLines(action, missionId) {
        const p = state.player;
        const titleId = p.title ? p.title.id : null;
        const byMission = (p[`${action}LinesByMission`] || {})[missionId] || [];
        const byTitle = (p[`${action}LinesByTitle`] || {})[titleId] || [];
        let base = [];
        if (action === "attack") base = p.attacks || [];
        else if (action === "selfPromote") base = p.selfPromoteLines || [];
        else if (action === "replyAll") base = p.replyAllLines || [];
        else if (action === "escalate") base = p.escalateLines || [];
        else if (action === "deflect") base = p.deflectLines || [];
        return [...base, ...byMission, ...byTitle];
      }

      function getUnitSelfPromoteLines(unit) {
        if (Array.isArray(unit.selfPromoteLines) && unit.selfPromoteLines.length)
          return unit.selfPromoteLines;
        if (unit.selfPromote) return [unit.selfPromote];
        return [];
      }

      function getDepartmentName(departmentId) {
        if (!departmentId) return "";
        return DEPARTMENT_BY_ID[departmentId]?.name || departmentId;
      }

      function formatLoopInText(contact, fallback) {
        if (!contact || !contact.loopInText) return fallback;
        const departmentName = getDepartmentName(contact.departmentId);
        return contact.loopInText
          .replace(/{name}/g, contact.name || "")
          .replace(/{title}/g, contact.title || "")
          .replace(/{department}/g, departmentName);
      }

      function isContactImplicated(contact) {
        if (!contact || !contact.employeeId) return false;
        return opponents.some((o) => o.employeeId === contact.employeeId);
      }

      function openCcProfile(contact) {
        const deptName = getDepartmentName(contact.departmentId);
        document.getElementById("cc-profile-title").innerText = "CC Profile";
        document.getElementById("cc-profile-name").innerText = contact.name;
        document.getElementById("cc-profile-role").innerText = contact.title;
        document.getElementById("cc-profile-dept").innerText = deptName
          ? `Department: ${deptName}`
          : "Department: N/A";
        document.getElementById("cc-profile-effect").innerText =
          contact.bonus || "Effect: N/A";
        document.getElementById("cc-profile").classList.remove("hidden");
      }

      function closeCcProfile() {
        document.getElementById("cc-profile").classList.add("hidden");
      }

      function openSetInfo(setId) {
        const set = getSetById(setId);
        if (!set) return;
        const details = describeSetParts(set, state.player);
        const active = isSetActive(state.player, set);
        document.getElementById("set-info-title").innerText = "Set";
        document.getElementById("set-info-name").innerText = set.name;
        const partsEl = document.getElementById("set-info-parts");
        const missingSet = new Set(details.missing);
        partsEl.innerHTML = details.parts
          .map((part) => {
            const isMissing = missingSet.has(part);
            const cls = isMissing
              ? "bg-red-100 text-red-700 border-red-200"
              : "bg-gray-100 text-gray-700 border-gray-200";
            return `<span class="px-1.5 py-0.5 rounded-sm border text-[10px] ${cls}">${part}</span>`;
          })
          .join("");
        document.getElementById("set-info-bonus").innerText =
          `Bonus: ${describeEffect(set.effect)}`;
        document.getElementById("set-info-status").innerText = active
          ? "Status: Active"
          : details.missing.length
            ? `Missing: ${details.missing.join(", ")}`
            : "Status: Incomplete";
        document.getElementById("set-info").classList.remove("hidden");
      }

      function closeSetInfo() {
        document.getElementById("set-info").classList.add("hidden");
      }

      function openTrainingModal() {
        const pending = state.pendingTraining;
        if (!pending) return;
        const offer = getTrainingOffers().find((o) => o.id === pending.offerId);
        if (!offer) return;
        const upgrades = getTrainingUpgrades();
        const options = pending.options
          .map((id) => upgrades.find((u) => u.id === id))
          .filter(Boolean);
        const modal = document.getElementById("training-modal");
        document.getElementById("training-title").innerText = "Training Selection";
        document.getElementById("training-name").innerText = offer.name;
        document.getElementById("training-subtitle").innerText =
          `Choose ${pending.picksLeft} more`;
        const list = document.getElementById("training-options");
        list.innerHTML = "";
        options.forEach((opt) => {
          const btn = document.createElement("button");
          btn.className =
            "w-full retro-border text-left p-2 bg-white hover:bg-blue-50";
          btn.innerHTML = `<div class="font-bold">${opt.name}</div><div class="text-[10px] italic text-gray-600">${opt.bonus}</div>`;
          btn.onclick = () => {
            opt.apply();
            pending.picksLeft -= 1;
            pending.options = pending.options.filter((id) => id !== opt.id);
            saveGame();
            if (pending.picksLeft <= 0) {
              state.pendingTraining = null;
              closeTrainingModal();
              updateUI();
              updateShopUI();
            } else {
              updateUI();
              openTrainingModal();
            }
          };
          list.appendChild(btn);
        });
        modal.classList.remove("hidden");
      }

      function closeTrainingModal() {
        document.getElementById("training-modal").classList.add("hidden");
      }

      function startTraining(offer) {
        const upgrades = shuffle([...getTrainingUpgrades()]);
        const options = upgrades.slice(0, offer.optionsCount).map((u) => u.id);
        state.pendingTraining = {
          offerId: offer.id,
          options,
          picksLeft: offer.picks,
        };
        saveGame();
        openTrainingModal();
      }

      function addContactBuff(target, contact, usedBy) {
        const buff = JSON.parse(JSON.stringify(contact));
        buff.usedBy = usedBy;
        target.buffs.push(buff);
        if (buff.eff && buff.eff.maxHp) {
          target.hp = Math.min(getUnitMaxHp(target), target.hp + buff.eff.maxHp);
        }
      }

      function startQuarter() {
        transitionTo("game-ui");
        state.gameOver = false;
        state.turn = 0;
        state.isProcessing = false;
        const p = state.player;
        applyUnitDefaults(p);
        p._lineBags = {};
        p.ult = 0;
        p.buffs = []; // Reset combat buffs
        p.deflectCharge = 0;
        const baseStats = computeUnitStats(p);
        p.hp = getUnitMaxHp(p);
        p.currentWins = Math.max(0, Math.floor(baseStats.wins));

        // Reset global CONTACTS.usedBy
        CONTACTS.forEach((c) => (c.usedBy = null));

        const mission = MISSIONS[state.currentMissionIndex] || MISSIONS[0];

        // Assemble opponents from EMPLOYEES and mission-specific data
        opponents = mission.opponents.map((missionOpponent) => {
          const employee = EMPLOYEES.find(
            (e) => e.id === missionOpponent.employeeId,
          );
          const clone = {
            ...JSON.parse(JSON.stringify(employee)),
            ...JSON.parse(JSON.stringify(missionOpponent)),
          };
          applyUnitDefaults(clone);
          clone.employeeId = employee.id;
          clone.hp = clone.maxHp;
          clone.buffs = [];
          clone.deflectCharge = 0;
          clone._lineBags = {};
          // Filter lines based on missionId
          const missionLinesOnly = !!mission.onlyMissionLines;
          clone.attacks = employee.lines
            .filter((l) =>
              missionLinesOnly
                ? l.missionId === mission.id
                : l.missionId === null || l.missionId === mission.id,
            )
            .map((l) => l.text);
          return clone;
        });

        state.removedTotal = opponents.length;
        state.removedByPlayer = 0;
        state.targetId = opponents[0].id;

        document.getElementById("message-log").innerHTML = "";
        document.getElementById("game-header-subject").innerText =
          `Outlook Express - [${mission.subject}]`;
        updateUI();

        // Templating the intro
        let introText = mission.intro;
        introText = introText.replace(/{playerName}/g, p.name);
        opponents.forEach((opp, idx) => {
          const regex = new RegExp(`{opp${idx}}`, "g");
          introText = introText.replace(regex, opp.name);
        });

        addEmailToLog(
          mission.from,
          "everyone@gov.org",
          mission.subject,
          introText,
          "border-l-4 border-blue-500 bg-blue-50",
        );
      }

      function getTrainingUpgrades() {
        return [
          {
            id: "upgrade_single",
            name: "Reply to Focus",
            bonus: "+2 reply to",
            apply: () => {
              state.player.singleDmg += 2;
            },
          },
          {
            id: "upgrade_escalate",
            name: "Escalation Focus",
            bonus: "+2 escalate",
            apply: () => {
              state.player.escalateDmg += 2;
            },
          },
          {
            id: "upgrade_replyall",
            name: "Reply-All Focus",
            bonus: "+3 reply all",
            apply: () => {
              state.player.replyAllDmg += 3;
            },
          },
          {
            id: "upgrade_global",
            name: "Agency-Wide Influence",
            bonus: "+1 all messages",
            apply: () => {
              state.player.globalDmg += 1;
            },
          },
          {
            id: "upgrade_hp",
            name: "Resilience Training",
            bonus: "+5 Max Credibility",
            apply: () => {
              state.player.maxHp += 5;
            },
          },
          {
            id: "upgrade_win",
            name: "Public Speaking",
            bonus: "+1 New Win/Round",
            apply: () => {
              state.player.wins += 1;
            },
          },
          {
            id: "upgrade_deflect",
            name: "Deflection Coaching",
            bonus: "+2 Deflect",
            apply: () => {
              state.player.deflect += 2;
            },
          },
        ];
      }

      function getTrainingOffers() {
        return [
          {
            id: "training_lnl",
            name: "Attend Lunch & Learn",
            bonus: "Pick 1 of 2 upgrades",
            cost: 6,
            optionsCount: 2,
            picks: 1,
          },
          {
            id: "training_course",
            name: "Take Daily Course",
            bonus: "Pick 1 of 3 upgrades",
            cost: 8,
            optionsCount: 3,
            picks: 1,
          },
          {
            id: "training_conference",
            name: "Attend Conference",
            bonus: "Pick 2 of 3 upgrades",
            cost: 10,
            optionsCount: 3,
            picks: 2,
          },
        ];
      }

      function generateShopItems() {
        // Seminars
        const availCCs = CONTACTS.filter(
          (c) => !state.player.addressBook.includes(c.id),
        );
        state.shop.seminars = shuffle([...availCCs])
          .slice(0, 2)
          .map((c) => ({ ...c, purchased: false }));

        // Signatures
        state.shop.signatures = shuffle([...SIGNATURES])
          .slice(0, 2)
          .map((s) => ({ ...s, purchased: false }));

        // Salutations
        state.shop.salutations = shuffle([...SALUTATIONS])
          .slice(0, 2)
          .map((s) => ({ ...s, purchased: false }));

        // Sign-offs
        state.shop.signoffs = shuffle([...SIGNOFFS])
          .slice(0, 2)
          .map((s) => ({ ...s, purchased: false }));

        // Promotions (Stats)
        state.shop.promotions = shuffle([...getTrainingOffers()])
          .slice(0, 1)
          .map((p) => ({ ...p, purchased: false }));

        // BCCs
        state.shop.bccs = shuffle([...BCC_CONTACTS])
          .slice(0, 2)
          .map((b) => ({ ...b, purchased: false }));
      }

      function endQuarter() {
        state.isProcessing = true;
        generateShopItems();
        setTimeout(() => {
          transitionTo("summary-screen");
          const summary = computeSummary();
          state.player.reputation += summary.totalRep;

          // Advance mission index
          state.currentMissionIndex =
            (state.currentMissionIndex + 1) % MISSIONS.length;

          renderSummary(summary);
        }, 4000);
      }

      function computeSummary() {
        const baseRepByQuarter = {
          Q3: 4,
          Q4: 5,
          Q2: 6,
          Q1: 8,
        };
        const baseRep =
          baseRepByQuarter[state.player.quarter] ?? baseRepByQuarter.Q3;
        const totalOptOutRep = state.removedByPlayer * 2;
        let bonusRep = 0;
        const repStats = computeUnitStats(state.player);
        if (repStats.repBonus) {
          bonusRep +=
            (state.removedTotal -
              opponents.filter((o) => o.hp > 0).length -
              state.removedByPlayer) *
            repStats.repBonus;
        }
        if (repStats.endRep) {
          bonusRep += repStats.endRep;
        }
        const totalRep = baseRep + totalOptOutRep + bonusRep;
        return { baseRep, bonusRep, totalRep };
      }

      function renderSummary(summary = computeSummary()) {
        // Distribution
        const optOutList = document.getElementById("summary-optouts-list");
        if (!optOutList) return;
        optOutList.innerHTML = "";
        const playerKills = opponents.filter((o) => o.removedByPlayer);

        if (playerKills.length > 0) {
          optOutList.classList.remove("hidden");
          playerKills.forEach((o) => {
            const share = 2;
            const div = document.createElement("div");
            div.className =
              "flex justify-between text-[10px] text-gray-600 italic";
            div.innerHTML = `<span>Opt-out: ${o.name}</span><span>+${share}</span>`;
            optOutList.appendChild(div);
          });
        } else {
          optOutList.classList.add("hidden");
        }

        document.getElementById("summary-base-rep").innerText =
          `+${summary.baseRep}`;
        document.getElementById("summary-bonus-rep").innerText =
          `+${summary.bonusRep}`;
        document.getElementById("summary-rep-earned").innerText =
          `+${summary.totalRep}`;
      }

      function showShop() {
        transitionTo("shop-screen");
        updateShopUI();
      }

      function showLoseScreen() {
        const p = state.player;
        document.getElementById("lose-title").innerText = p.title.name;
        document.getElementById("lose-period").innerText =
          `${p.quarter} - Year ${p.year}`;
        document.getElementById("lose-total-rep").innerText = p.reputation;
        document.getElementById("lose-contacts").innerText =
          `${p.addressBook.length} Contacts`;
        transitionTo("lose-screen");
      }

      function advanceToNextQuarter() {
        const quarters = ["Q3", "Q4", "Q1", "Q2"];
        let idx = quarters.indexOf(state.player.quarter);
        idx = (idx + 1) % quarters.length;
        state.player.quarter = quarters[idx];

        if (state.player.quarter === "Q3") {
          state.player.year++;
        }

        if (state.player.quarter === "Q2") {
          showPromotion();
        } else {
          showInbox();
        }
      }

      function showPromotion() {
        // TODO - if max title reached, skip promotion
        if (state.player.year >= TITLES.length) {
          advanceToNextQuarter();
          return;
        }
        transitionTo("promotion-screen");

        // Determine next title by matching year
        let titleIdx = state.player.year;

        // Limit to max title
        const nextTitle = TITLES[titleIdx] || TITLES[TITLES.length - 1];
        state.player.title = nextTitle;

        document.getElementById("promotion-new-title").innerText =
          nextTitle.name;
        document.getElementById("promotion-perks").innerText =
          `+${nextTitle.maxHp} HP, +${nextTitle.singleDmg} reply to, Limit: ${nextTitle.sigLimit} Sig, ${nextTitle.addressLimit} CCs`;
      }

      function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      function getRarityMeta(rarity) {
        const meta = {
          common: { label: "COMMON", className: "bg-gray-200 text-gray-700" },
          uncommon: {
            label: "UNCOMMON",
            className: "bg-emerald-100 text-emerald-700",
          },
          rare: { label: "RARE", className: "bg-amber-100 text-amber-700" },
        };
        return meta[rarity] || meta.common;
      }

      function formatRarityBadge(rarity) {
        const meta = getRarityMeta(rarity);
        return `<span class="text-[9px] uppercase px-1 py-0.5 rounded-sm ${meta.className}">${meta.label}</span>`;
      }

      function getSetById(id) {
        return SET_DEFS.find((set) => set.id === id);
      }

      function describeSetParts(set, player) {
        const missing = [];
        const parts = set.items.map((item) => {
          if (!item) return "";
          if (item.type === "salutation") {
            const sal = SALUTATIONS.find((s) => s.id === item.id);
            const name = sal?.name || item.id;
            if (!player.salutation || player.salutation.id !== item.id)
              missing.push(`Greeting: ${name}`);
            return `Greeting: ${name}`;
          }
          if (item.type === "signoff") {
            const off = SIGNOFFS.find((s) => s.id === item.id);
            const name = off?.name || item.id;
            if (!player.signOff || player.signOff.id !== item.id)
              missing.push(`Sign-off: ${name}`);
            return `Sign-off: ${name}`;
          }
          if (item.type === "signature") {
            const sig = SIGNATURES.find((s) => s.id === item.id);
            const name = sig?.name || item.id;
            if (!player.signatures.some((s) => s.id === item.id))
              missing.push(`Signature: ${name}`);
            return `Signature: ${name}`;
          }
          if (item.type === "contact") {
            const c = CONTACTS.find((c) => c.id === item.id);
            const name = c?.name || item.id;
            if (!player.buffs.some((b) => b.id === item.id))
              missing.push(`CC: ${name}`);
            return `CC: ${name}`;
          }
          return item.id;
        });
        return { parts: parts.filter(Boolean), missing };
      }

      function getItemCostByType(rarity, type) {
        const table = {
          contact: { common: 4, uncommon: 7, rare: 12 },
          signature: { common: 3, uncommon: 6, rare: 10 },
          salutation: { common: 3, uncommon: 6, rare: 10 },
          signoff: { common: 3, uncommon: 6, rare: 10 },
          bcc: { common: 2, uncommon: 3, rare: 5 },
        };
        const row = table[type] || table.contact;
        return row[rarity] ?? row.common;
      }

      function createShopCard(name, desc, cost, onBuy, options = {}) {
        const div = document.createElement("div");
        div.className = "p-2 bg-white retro-border flex flex-col gap-1";
        const canAfford = state.player.reputation >= cost;
        const purchased = options.purchased || false;
        const canBuy = options.canBuy ?? true;
        const badge = options.badge || "";
        const disabled = !canAfford || purchased || !canBuy;
        const label = purchased
          ? options.ownedLabel || "ON FILE"
          : !canBuy
            ? options.spaceLabel || "FREE SLOT"
            : options.actionLabel || "SUBMIT REQUEST";
        const priceLabel = purchased
          ? options.ownedPriceLabel || "ON FILE"
          : options.priceLabel || `REQ: ${cost} REP`;
        div.innerHTML = `
                <div class="flex justify-between font-bold text-[11px] gap-2">
                    <span class="truncate">${name}</span>
                    <span class="text-blue-700 font-mono">${priceLabel}</span>
                </div>
                <div class="flex items-center gap-2 text-[9px]" data-badge></div>
                <div class="text-[10px] italic text-gray-600 leading-tight">${desc}</div>
                <button data-buy class="mt-1 retro-button text-[10px] font-bold py-1 ${disabled ? "opacity-50" : ""}" ${disabled ? "disabled" : ""}>
                    ${label}
                </button>
            `;
        const badgeWrap = div.querySelector("[data-badge]");
        if (badge) badgeWrap.insertAdjacentHTML("beforeend", badge);
        if (options.setId) {
          const setBtn = document.createElement("button");
          setBtn.type = "button";
          setBtn.className =
            "text-[9px] uppercase px-1 py-0.5 rounded-sm bg-blue-100 text-blue-700 font-bold";
          setBtn.innerText = "Set";
          setBtn.onclick = (e) => {
            e.stopPropagation();
            openSetInfo(options.setId);
          };
          badgeWrap.appendChild(setBtn);
        }
        const buyBtn = div.querySelector("[data-buy]");
        if (!disabled && buyBtn)
          buyBtn.onclick = () => {
            onBuy();
            updateShopUI();
          };
        return div;
      }

      function createOwnedRow(item, type, onSell, options = {}) {
        const cost = getItemCostByType(item.rarity || "common", type);
        const refund = Math.floor(cost / 2);
        const actionLabel = options.actionLabel || "ARCHIVE";
        const setBadge = item.setId
          ? `<button type="button" data-set-button data-set-id="${item.setId}" class="text-[9px] uppercase px-1 py-0.5 rounded-sm bg-blue-100 text-blue-700 font-bold">Set</button>`
          : "";
        const div = document.createElement("div");
        div.className =
          "p-2 bg-white retro-border flex items-center justify-between gap-2";
        div.innerHTML = `
                <div class="flex flex-col gap-0.5">
                    <div class="flex items-center gap-2 text-[11px] font-bold">
                        <span>${item.name}</span>
                        ${formatRarityBadge(item.rarity)}${setBadge}
                    </div>
                    <div class="text-[10px] italic text-gray-600">${item.bonus || ""}</div>
                </div>
                <button data-sell class="retro-button text-[10px] px-2 py-1">${actionLabel} +${refund} REP</button>
            `;
        const sellBtn = div.querySelector("[data-sell]");
        if (sellBtn)
          sellBtn.onclick = () => {
          onSell(refund);
          updateShopUI();
        };
        div.querySelectorAll("[data-set-button]").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            openSetInfo(btn.dataset.setId);
          });
        });
        return div;
      }

      function describeEffect(effect) {
        if (!effect) return "";
        const parts = [];
        if (effect.globalDmg)
          parts.push(`+${effect.globalDmg} all messages`);
        if (effect.singleDmg)
          parts.push(`+${effect.singleDmg} reply to`);
        if (effect.escalateDmg)
          parts.push(`+${effect.escalateDmg} escalate`);
        if (effect.replyAllDmg)
          parts.push(`+${effect.replyAllDmg} reply all`);
        if (effect.globalDmgMult)
          parts.push(`+${Math.round(effect.globalDmgMult * 100)}% all messages`);
        if (effect.singleDmgMult)
          parts.push(`+${Math.round(effect.singleDmgMult * 100)}% reply to`);
        if (effect.escalateDmgMult)
          parts.push(`+${Math.round(effect.escalateDmgMult * 100)}% escalate`);
        if (effect.replyAllDmgMult)
          parts.push(`+${Math.round(effect.replyAllDmgMult * 100)}% reply all`);
        if (effect.deflect) parts.push(`Deflect +${effect.deflect}`);
        if (effect.defFlat) parts.push(`Reduce damage by ${effect.defFlat}`);
        if (effect.followUpChance)
          parts.push(`Follow-up +${Math.round(effect.followUpChance * 100)}%`);
        if (effect.replyDeptSplash)
          parts.push(`Dept splash +${effect.replyDeptSplash}`);
        if (effect.escalateRecoverPerHit)
          parts.push(`Escalate recover +${effect.escalateRecoverPerHit}`);
        if (effect.heal) parts.push(`+${effect.heal} Cred/turn`);
        if (effect.bounceBase) parts.push(`Bounce +${effect.bounceBase} base`);
        return parts.join(", ");
      }

      function updateShopUI() {
        document.getElementById("shop-reputation-display").innerText =
          `REPUTATION: ${state.player.reputation}`;

        // Seminars
        const semList = document.getElementById("shop-seminars");
        semList.innerHTML = "";
        const semHeader = semList.previousElementSibling;
        semHeader.innerText = `Reach Out (Address Book: ${state.player.addressBook.length}/${state.player.title.addressLimit})`;

        const contactCurrent = document.createElement("div");
        contactCurrent.className = "space-y-1 mb-2";
        const contactTitle = document.createElement("div");
        contactTitle.className = "text-[10px] font-bold uppercase text-gray-500";
        contactTitle.innerText = "Active Contacts";
        contactCurrent.appendChild(contactTitle);
        if (state.player.addressBook.length === 0) {
          const none = document.createElement("div");
          none.className = "text-[10px] italic text-gray-400";
          none.innerText = "No contacts on file.";
          contactCurrent.appendChild(none);
        } else {
          state.player.addressBook.forEach((id) => {
            const c = CONTACTS.find((con) => con.id === id);
            if (!c) return;
            contactCurrent.appendChild(
              createOwnedRow(
                c,
                "contact",
                (refund) => {
                  state.player.addressBook = state.player.addressBook.filter(
                    (cid) => cid !== id,
                  );
                  state.player.reputation += refund;
                },
                { actionLabel: "ARCHIVE" },
              ),
            );
          });
        }
        semList.appendChild(contactCurrent);

        state.shop.seminars.forEach((c) => {
          const cost = getItemCostByType(c.rarity, "contact");
          const owned = state.player.addressBook.includes(c.id);
          const hasSpace =
            state.player.addressBook.length < state.player.title.addressLimit;
          semList.appendChild(
            createShopCard(
              c.name,
              c.bonus,
              cost,
              () => {
                if (owned) return;
                if (!hasSpace) {
                  alert("Address book full. Archive a contact to make space.");
                  return;
                }
                state.player.reputation -= cost;
                state.player.addressBook.push(c.id);
                c.purchased = true;
              },
              {
                purchased: owned,
                canBuy: hasSpace,
                badge: formatRarityBadge(c.rarity),
                setId: c.setId,
                actionLabel: "REACH OUT",
                ownedLabel: "IN DIRECTORY",
                spaceLabel: "FREE SLOT",
                priceLabel: `REQ: ${cost} REP`,
              },
            ),
          );
        });

        // Signatures
        const sigList = document.getElementById("shop-signatures");
        sigList.innerHTML = "";
        const sigHeader = sigList.previousElementSibling;
        sigHeader.innerText = `Email Signatures (${state.player.signatures.length}/${state.player.title.sigLimit})`;
        const sigCurrent = document.createElement("div");
        sigCurrent.className = "space-y-1 mb-2";
        const sigTitle = document.createElement("div");
        sigTitle.className = "text-[10px] font-bold uppercase text-gray-500";
        sigTitle.innerText = "Signatures on File";
        sigCurrent.appendChild(sigTitle);
        if (state.player.signatures.length === 0) {
          const none = document.createElement("div");
          none.className = "text-[10px] italic text-gray-400";
          none.innerText = "No signatures on file.";
          sigCurrent.appendChild(none);
        } else {
          state.player.signatures.forEach((sig) => {
            sigCurrent.appendChild(
              createOwnedRow(
                sig,
                "signature",
                (refund) => {
                  state.player.signatures = state.player.signatures.filter(
                    (s) => s.id !== sig.id,
                  );
                  state.player.reputation += refund;
                },
                { actionLabel: "ARCHIVE" },
              ),
            );
          });
        }
        sigList.appendChild(sigCurrent);

        state.shop.signatures.forEach((s) => {
          const cost = getItemCostByType(s.rarity, "signature");
          const owned = state.player.signatures.some((sig) => sig.id === s.id);
          const hasSpace =
            state.player.signatures.length < state.player.title.sigLimit;
          sigList.appendChild(
            createShopCard(
              s.name,
              s.bonus,
              cost,
              () => {
                if (owned) return;
                if (!hasSpace) {
                  alert("Signature slots full. Archive a signature to make space.");
                  return;
                }
                state.player.reputation -= cost;
                state.player.signatures.push(s);
                s.purchased = true;
              },
              {
                purchased: owned,
                canBuy: hasSpace,
                badge: formatRarityBadge(s.rarity),
                setId: s.setId,
                actionLabel: "APPLY",
                ownedLabel: "ON FILE",
                spaceLabel: "FREE SLOT",
                priceLabel: `REQ: ${cost} REP`,
              },
            ),
          );
        });

        // Salutations
        const salList = document.getElementById("shop-salutations");
        salList.innerHTML = "";
        const currentSalWrap = document.createElement("div");
        currentSalWrap.className = "space-y-1 mb-2";
        const salTitle = document.createElement("div");
        salTitle.className = "text-[10px] font-bold uppercase text-gray-500";
        salTitle.innerText = "Greeting on File";
        currentSalWrap.appendChild(salTitle);
        if (state.player.salutation) {
          currentSalWrap.appendChild(
            createOwnedRow(
              state.player.salutation,
              "salutation",
              (refund) => {
                state.player.salutation = null;
                state.player.reputation += refund;
              },
              { actionLabel: "CLEAR" },
            ),
          );
        } else {
          const none = document.createElement("div");
          none.className = "text-[10px] italic text-gray-400";
          none.innerText = "No greeting on file.";
          currentSalWrap.appendChild(none);
        }
        salList.appendChild(currentSalWrap);
        state.shop.salutations.forEach((s) => {
          const cost = getItemCostByType(s.rarity, "salutation");
          const owned = state.player.salutation && state.player.salutation.id === s.id;
          const hasSpace = !state.player.salutation;
          salList.appendChild(
            createShopCard(
              s.name,
              s.bonus,
              cost,
              () => {
                if (!hasSpace) {
                  alert("Greeting slot full. Clear your current greeting first.");
                  return;
                }
                state.player.reputation -= cost;
                state.player.salutation = s;
                s.purchased = true;
              },
              {
                purchased: owned,
                canBuy: hasSpace,
                badge: formatRarityBadge(s.rarity),
                setId: s.setId,
                actionLabel: "SET GREETING",
                ownedLabel: "ACTIVE",
                spaceLabel: "CLEAR FIRST",
                priceLabel: `REQ: ${cost} REP`,
              },
            ),
          );
        });

        // Sign-offs
        const offList = document.getElementById("shop-signoffs");
        offList.innerHTML = "";
        const currentOffWrap = document.createElement("div");
        currentOffWrap.className = "space-y-1 mb-2";
        const offTitle = document.createElement("div");
        offTitle.className = "text-[10px] font-bold uppercase text-gray-500";
        offTitle.innerText = "Sign-off on File";
        currentOffWrap.appendChild(offTitle);
        if (state.player.signOff) {
          currentOffWrap.appendChild(
            createOwnedRow(
              state.player.signOff,
              "signoff",
              (refund) => {
                state.player.signOff = null;
                state.player.reputation += refund;
              },
              { actionLabel: "CLEAR" },
            ),
          );
        } else {
          const none = document.createElement("div");
          none.className = "text-[10px] italic text-gray-400";
          none.innerText = "No sign-off on file.";
          currentOffWrap.appendChild(none);
        }
        offList.appendChild(currentOffWrap);
        state.shop.signoffs.forEach((s) => {
          const cost = getItemCostByType(s.rarity, "signoff");
          const owned = state.player.signOff && state.player.signOff.id === s.id;
          const hasSpace = !state.player.signOff;
          offList.appendChild(
            createShopCard(
              s.name,
              s.bonus,
              cost,
              () => {
                if (!hasSpace) {
                  alert("Sign-off slot full. Clear your current sign-off first.");
                  return;
                }
                state.player.reputation -= cost;
                state.player.signOff = s;
                s.purchased = true;
              },
              {
                purchased: owned,
                canBuy: hasSpace,
                badge: formatRarityBadge(s.rarity),
                setId: s.setId,
                actionLabel: "SET SIGN-OFF",
                ownedLabel: "ACTIVE",
                spaceLabel: "CLEAR FIRST",
                priceLabel: `REQ: ${cost} REP`,
              },
            ),
          );
        });

        // Promotions (Stats)
        const promList = document.getElementById("shop-promotions");
        promList.innerHTML = "";
        state.shop.promotions.forEach((p) => {
          promList.appendChild(
            createShopCard(
              p.name,
              p.bonus,
              p.cost,
              () => {
                if (p.purchased) return;
                state.player.reputation -= p.cost;
                p.purchased = true;
                startTraining(p);
              },
              {
                purchased: p.purchased,
                actionLabel: "FILE CREDIT",
                ownedLabel: "LOGGED",
                priceLabel: `REQ: ${p.cost} REP`,
              },
            ),
          );
        });

        // BCCs
        const bccList = document.getElementById("shop-bccs");
        bccList.innerHTML = "";
        state.shop.bccs.forEach((b) => {
          const cost =
            b.rarity === "rare" ? 5 : b.rarity === "uncommon" ? 3 : 2;
          bccList.appendChild(
            createShopCard(
              b.name,
              b.bonus,
              cost,
              () => {
                state.player.reputation -= cost;
                state.player.bccContacts.push(b);
                b.purchased = true;
              },
              {
                purchased: b.purchased,
                badge: formatRarityBadge(b.rarity),
                actionLabel: "REQUEST",
                ownedLabel: "ON FILE",
                priceLabel: `REQ: ${cost} REP`,
              },
            ),
          );
        });
      }

      function renderStatsModal() {
        const modal = document.getElementById("stats-modal");
        const header = document.getElementById("stats-modal-header");
        const totalsEl = document.getElementById("stats-modal-totals");
        const sourcesEl = document.getElementById("stats-modal-sources");
        if (!modal || !header || !totalsEl || !sourcesEl) return;

        const p = state.player;
        const totals = computeUnitStats(p);
        header.innerText = `${p.name} (${p.title ? p.title.name : "Unranked"})`;

        totalsEl.innerHTML = "";
        STAT_FIELDS.forEach((field) => {
          const value = totals[field];
          if (!value) return;
          const div = document.createElement("div");
          div.className = "flex justify-between bg-white retro-border px-2 py-1";
          div.innerHTML = `<span class="uppercase text-gray-500">${field}</span><span class="font-mono">${value}</span>`;
          totalsEl.appendChild(div);
        });

        sourcesEl.innerHTML = "";
        const sources = getStatSources(p);
        if (sources.length === 0) {
          sourcesEl.innerHTML =
            '<div class="text-[10px] italic text-gray-500">No stat sources found.</div>';
          return;
        }
        sources.forEach((src) => {
          const rows = Object.entries(src.stats)
            .map(([k, v]) => `<span class="font-mono">${k}: ${v}</span>`)
            .join(", ");
          const div = document.createElement("div");
          div.className = "p-2 bg-white retro-border";
          div.innerHTML = `<div class="font-bold">${src.label}</div><div class="text-[10px] text-gray-600">${rows}</div>`;
          sourcesEl.appendChild(div);
        });
      }

      function openStatsModal() {
        const modal = document.getElementById("stats-modal");
        if (!modal) return;
        renderStatsModal();
        modal.classList.remove("hidden");
      }

      function closeStatsModal() {
        const modal = document.getElementById("stats-modal");
        if (!modal) return;
        modal.classList.add("hidden");
      }

      function handleOpponentDefeat(o, byPlayer = false) {
        if (o.isDefeated) return;
        o.hp = 0;
        o.isDefeated = true;
        if (byPlayer) {
          state.removedByPlayer++;
          o.removedByPlayer = true;
        }
        addEmailToLog(
          o.name,
          "everyone@gov.org",
          "Unsubscribing",
          o.defeatMessage,
          "italic text-gray-600 bg-gray-50 border-l-4 border-gray-400",
        );
        if (state.targetId === o.id) {
          const next = opponents.find((opp) => opp.hp > 0);
          if (next) state.targetId = next.id;
        }
        if (opponents.every((opp) => opp.hp <= 0)) {
          state.gameOver = true;
          endQuarter();
        }
      }

      function updateUI() {
        if (state.gameOver) return;
        const p = state.player;
        const totalMaxHp = getUnitMaxHp(p);
        const hpPct = Math.max(0, (p.hp / totalMaxHp) * 100);
        const ultPct = Math.min(100, p.ult);

        document.getElementById("player-hp-fill").style.width = hpPct + "%";
        document.getElementById("player-hp-label").innerText =
          `${Math.ceil(p.hp)}/${totalMaxHp}`;
        document.getElementById("player-ult-fill").style.width = ultPct + "%";
        document.getElementById("player-win-status").innerText =
          `New Wins: ${p.currentWins} Available`;

        if (hpPct < 30)
          document.getElementById("player-hp-fill").className =
            "h-full bg-red-600 transition-[width] duration-300 ease-out";
        else if (hpPct < 60)
          document.getElementById("player-hp-fill").className =
            "h-full bg-yellow-500 transition-[width] duration-300 ease-out";
        else
          document.getElementById("player-hp-fill").className =
            "h-full bg-green-500 transition-[width] duration-300 ease-out";

        const singleDmg = getUnitDamage(p, "single");
        const escalateDmg = getUnitDamage(p, "escalate");
        const replyAllDmg = getUnitDamage(p, "replyAll");
        document.getElementById("attack-subtext").innerText =
          `-${Math.floor(singleDmg)} Cred to Target`;
        document.getElementById("escalate-subtext").innerText =
          `-${Math.floor(escalateDmg)} Cred to All`;
        document.getElementById("promote-subtext").innerText =
          `+20 Cred, -1 Win`;
        document.getElementById("deflect-subtext").innerText =
          `Block ${Math.floor(getUnitDeflectPower(p))}`;
        document.getElementById("ult-subtext").innerText =
          `-${Math.floor(replyAllDmg)} Cred to All`;
        document.getElementById("loop-subtext").innerText =
          `${p.addressBook.length}/${p.title.addressLimit} Contacts`;

        document.getElementById("reply-all-btn").disabled = p.ult < 100;
        document.getElementById("win-btn").disabled = p.currentWins <= 0;

        document.getElementById("game-quarter-display").innerText =
          `${p.quarter} - YEAR ${p.year}`;
        document.getElementById("status-bar-name").innerText =
          `${p.name} (${p.title.name})`;
        const statsModal = document.getElementById("stats-modal");
        if (statsModal && !statsModal.classList.contains("hidden"))
          renderStatsModal();

        const selector = document.getElementById("target-selector");
        selector.innerHTML = "";
        const oppContainer = document.createElement("div");
        oppContainer.className = "contacts-container";
        const maxOppPreview = 4;
        opponents.forEach((o) => {
          const isActive = state.targetId === o.id;
          const pct = Math.max(0, (o.hp / getUnitMaxHp(o)) * 100);
          const pill = document.createElement("div");
          pill.onclick = () => {
            if (o.hp > 0) state.targetId = o.id;
            updateUI();
          };
          pill.className = `target-pill px-2 py-0.5 flex flex-col min-w-[90px] cursor-pointer bg-white ${isActive ? "active" : "opacity-60 grayscale"}`;
          const textClass = isActive ? "text-white" : "text-gray-900";
          const lastPct =
            typeof o._lastHpPct === "number" ? o._lastHpPct : pct;
          pill.innerHTML = `<div class="flex justify-between font-bold text-[8px] truncate ${isActive ? "text-white" : "text-gray-800"}"><span class="mr-2">${o.name}</span><span>${o.hp > 0 ? o.wins + "w" : "UNSUBBED"}</span></div>
                                <div class="h-1 w-full bg-gray-200 mt-0.5"><div class="h-full bg-red-500 transition-[width] duration-300 ease-out" data-opp-hp style="width: ${lastPct}%"></div></div>
                                <div class="text-[8px] mt-0.5 ${textClass}">${Math.max(0, Math.ceil(o.hp))}/${getUnitMaxHp(o)} Cred</div>`;
          oppContainer.appendChild(pill);
          const fill = pill.querySelector("[data-opp-hp]");
          if (fill) {
            requestAnimationFrame(() => {
              fill.style.width = pct + "%";
            });
          }
          o._lastHpPct = pct;
        });
        selector.appendChild(oppContainer);
        if (opponents.length > maxOppPreview) {
          const more = document.createElement("span");
          const hiddenCount = opponents.length - maxOppPreview;
          more.className = "contacts-more text-[9px]";
          more.innerText = `+ ${hiddenCount} more`;
          more.onclick = () => {
            const expanded = oppContainer.classList.toggle("expanded");
            more.innerText = expanded ? "Show less" : `+ ${hiddenCount} more`;
          };
          selector.appendChild(more);
        }

        const ccDisplay = document.getElementById("cc-display");
        const activeBuffs = [
          ...state.player.buffs,
          ...opponents.flatMap((o) => o.buffs || []),
        ];
        if (activeBuffs.length === 0) {
          ccDisplay.className = "flex gap-1 text-gray-400 italic";
          ccDisplay.innerHTML = "No one in loop.";
        } else {
          const usedByOrder = (name) => {
            if (name === state.player.name) return 0;
            const idx = opponents.findIndex((o) => o.name === name);
            return idx >= 0 ? idx + 1 : 999;
          };
          const sortedBuffs = [...activeBuffs].sort((a, b) => {
            const byUsed = usedByOrder(a.usedBy) - usedByOrder(b.usedBy);
            if (byUsed !== 0) return byUsed;
            const deptA = getDepartmentName(a.departmentId);
            const deptB = getDepartmentName(b.departmentId);
            const byDept = deptA.localeCompare(deptB);
            if (byDept !== 0) return byDept;
            return (a.name || "").localeCompare(b.name || "");
          });

          ccDisplay.className = "flex items-center gap-1 text-gray-600";
          ccDisplay.innerHTML = "";
          const container = document.createElement("div");
          container.className = "contacts-container";
          const maxPreview = 4;
          sortedBuffs.forEach((b) => {
            const pill = document.createElement("button");
            pill.className =
              "bg-blue-800 text-white px-1 text-[9px] rounded-sm hover:bg-blue-700";
            pill.type = "button";
            pill.innerHTML = `${b.name} (by ${b.usedBy})`;
            pill.onclick = () => openCcProfile(b);
            container.appendChild(pill);
          });
          ccDisplay.appendChild(container);

          if (sortedBuffs.length > maxPreview) {
            const more = document.createElement("span");
            const hiddenCount = sortedBuffs.length - maxPreview;
            more.className = "contacts-more text-[9px]";
            more.innerText = `+ ${hiddenCount} more`;
            more.onclick = () => {
              const expanded = container.classList.toggle("expanded");
              more.innerText = expanded
                ? "Show less"
                : `+ ${hiddenCount} more`;
            };
            ccDisplay.appendChild(more);
          }
        }

        const h = 9 + Math.floor(state.turn / 4);
        const m = (state.turn % 4) * 15;
        document.getElementById("turn-clock").innerText =
          `${h.toString().padStart(2, "0")}:${m.toString().padStart(2, "0")} AM`;
        saveGame();
      }

      function addEmailToLog(from, to, subject, body, classes = "") {
        const log = document.getElementById("message-log");
        const entry = document.createElement("div");
        const time = document.getElementById("turn-clock").innerText;
        const reCount =
          state.turn > 0 ? "RE: ".repeat(Math.min(state.turn, 4)) : "";

        entry.className = `message-entry p-0 border-2 border-gray-100 bg-white shadow-sm ${classes}`;
        entry.innerHTML = `
                <div class="email-header p-2">
                    <div class="flex flex-wrap gap-x-4">
                        <div><strong>From:</strong> ${from}</div>
                        <div><strong>To:</strong> ${to}</div>
                    </div>
                    <div class="flex flex-wrap gap-x-4">
                        <div><strong>Sent:</strong> Today, ${time}</div>
                        <div><strong>Subject:</strong> ${reCount}${subject}</div>
                    </div>
                </div>
                <div class="email-body px-3 py-2 font-serif italic">
                    ${body}
                </div>
            `;
        log.prepend(entry);
        saveGame();
      }

      function performAction(type) {
        if (state.isProcessing || state.gameOver) return;
        state.isProcessing = true;
        state.turn++;
        const target = opponents.find((o) => o.id === state.targetId);
        const p = state.player;
        const mission = MISSIONS[state.currentMissionIndex] || MISSIONS[0];
        const missionId = mission.id;
        const titleId = p.title ? p.title.id : null;
        const totalMaxHp = getUnitMaxHp(p);

        // Heal from all sources
        p.hp = Math.min(totalMaxHp, p.hp + getUnitTotalHeal(p));

        if (type === "ATTACK") {
          let d = getUnitDamage(p, "single");

          if (p.nextAttackMult) {
            d *= p.nextAttackMult;
            p.nextAttackMult = 1; // reset back to 1
          }

          const result = applyDamage(p, target, d);
          let levGain = getPlayerLeverageGain(20);
          p.ult += levGain;

          const followUpChance = getUnitFollowUpChance(p);
          const followUpHit =
            followUpChance > 0 && Math.random() < followUpChance;
          const followUpResult = followUpHit ? applyDamage(p, target, d) : null;
          const splashDamage = getUnitReplyDeptSplash(p);
          const splashResult = applyDepartmentSplash(p, target, splashDamage);
          const bounceDamage = getUnitBounceDamage(p);
          const bounceTarget = bounceDamage
            ? pickBounceTarget(p, target)
            : null;
          const bounceResult = bounceTarget
            ? applyDamage(p, bounceTarget, bounceDamage, {
                ignoreReflect: true,
              })
            : null;

          const q = drawFromLineBag(
            p,
            getPlayerLineBagKey("attack", missionId, titleId),
            getPlayerActionLines("attack", missionId),
            "I believe we need to circle back to your recent comments.",
          );
          let body = formatMessageBody(p, q);
          if (result.blocked > 0) {
            body += `<br><br><strong>Deflected:</strong> ${result.blocked} reflected.`;
          }
          if (followUpResult) {
            body += `<br><br><strong>Follow-up Reply:</strong> -${followUpResult.dmg}`;
            if (followUpResult.blocked > 0) {
              body += ` (Deflected ${followUpResult.blocked})`;
            }
            body += ".";
          }
          if (splashResult.hits > 0) {
            body += `<br><br><strong>Department Splash:</strong> ${splashResult.hits} hit for ${splashResult.total}.`;
          }
          if (bounceResult && bounceTarget) {
            body += `<br><br><strong>Bounce:</strong> ${bounceTarget.name} -${bounceResult.dmg}.`;
            if (bounceResult.blocked > 0) {
              body += ` (Deflected ${bounceResult.blocked})`;
            }
          }
          addEmailToLog(
            p.name,
            target.name,
            "Reply to",
            body,
            "border-l-4 border-blue-600",
          );
          if (target.hp <= 0) handleOpponentDefeat(target, true);
        } else if (type === "ESCALATE") {
          const d = getUnitDamage(p, "escalate");
          let totalBlocked = 0;
          let totalRecovered = 0;
          const recoverPerHit = getUnitEscalateRecover(p);
          opponents.forEach((o) => {
            if (o.hp > 0) {
              const result = applyDamage(p, o, d);
              totalBlocked += result.blocked;
              if (recoverPerHit > 0) {
                totalRecovered += recoverPerHit;
                p.hp = Math.min(totalMaxHp, p.hp + recoverPerHit);
              }
              if (o.hp <= 0) handleOpponentDefeat(o, true);
            }
          });
          let levGain = getPlayerLeverageGain(10);
          p.ult += levGain;
          const line = drawFromLineBag(
            p,
            getPlayerLineBagKey("escalate", missionId, titleId),
            getPlayerActionLines("escalate", missionId),
            "I'm escalating this for clarity across the thread.",
          );
          let body = formatMessageBody(p, line);
          if (totalBlocked > 0) {
            body += `<br><br><strong>Deflected:</strong> ${totalBlocked} reflected.`;
          }
          if (totalRecovered > 0) {
            body += `<br><br><strong>Recovered:</strong> +${totalRecovered} Credibility.`;
          }
          addEmailToLog(
            p.name,
            "everyone@gov.org",
            "Escalation Notice",
            body,
            "bg-orange-50 border-l-4 border-orange-500",
          );
        } else if (type === "DEFLECT") {
          p.deflectCharge = getUnitDeflectPower(p);
          const line = drawFromLineBag(
            p,
            getPlayerLineBagKey("deflect", missionId, titleId),
            getPlayerActionLines("deflect", missionId),
            "Holding response to keep this thread scoped and documented.",
          );
          addEmailToLog(
            p.name,
            "everyone@gov.org",
            "Holding Response",
            `${formatMessageBody(p, line)}<br><br><strong>Deflection Ready:</strong> ${p.deflectCharge}`,
            "bg-blue-50 border-l-4 border-blue-500",
          );
        } else if (type === "PROMOTE") {
          p.currentWins--;
          p.hp = Math.min(totalMaxHp, p.hp + 20);
          const selfPromoteLine = drawFromLineBag(
            p,
            getPlayerLineBagKey("selfPromote", missionId, titleId),
            getPlayerActionLines("selfPromote", missionId),
            "Just logging a new win—the quarterly audit came back clean under my supervision. Always happy to add value to the organization!",
          );
          addEmailToLog(
            p.name,
            "everyone@gov.org",
            "FYI: Project Milestone Met",
            selfPromoteLine,
            "bg-green-50 border-l-4 border-green-600",
          );
        } else if (type === "ULT") {
          const d = getUnitDamage(p, "replyAll");
          let totalBlocked = 0;
          opponents.forEach((o) => {
            if (o.hp > 0) {
              const result = applyDamage(p, o, d);
              totalBlocked += result.blocked;
              if (o.hp <= 0) handleOpponentDefeat(o, true);
            }
          });
          p.ult = 0;
          const replyAllLine = drawFromLineBag(
            p,
            getPlayerLineBagKey("replyAll", missionId, titleId),
            getPlayerActionLines("replyAll", missionId),
            {
              subject: "Fwd: Salary_Discrepancies_2024.xlsx",
              body: "Not sure if I should be sending this to everyone, but since transparency is one of our 'core values', here is the full salary spreadsheet for the department. Enjoy.",
            },
          );
          let replyBody = replyAllLine.body;
          if (totalBlocked > 0) {
            replyBody += `<br><br><strong>Deflected:</strong> ${totalBlocked} reflected.`;
          }
          addEmailToLog(
            p.name,
            "everyone@gov.org",
            replyAllLine.subject,
            replyBody,
            "bg-yellow-50 font-bold border-l-4 border-yellow-500",
          );
        }

        updateUI();
        if (state.player.hp <= 0) {
          state.gameOver = true;
          setTimeout(showLoseScreen, 4000);
          return;
        }
        setTimeout(ffaRound, 800);
      }

      function ffaRound() {
        const alive = opponents.filter((o) => o.hp > 0);
        if (alive.length === 0) return; // Handled by handleOpponentDefeat

        alive.forEach((a, idx) => {
          setTimeout(() => {
            if (a.hp <= 0 || state.gameOver) return;

            if (a.isStunned) {
              a.isStunned = false;
              addEmailToLog(
                a.name,
                "everyone@gov.org",
                "RE: (Recalled Message)",
                `I'm sorry, I seem to have lost my train of thought. What were we discussing?`,
                "italic text-gray-400",
              );
              if (idx === alive.length - 1) {
                state.isProcessing = false;
                updateUI();
              }
              return;
            }

            let pool = [
              ...alive.filter((o) => o.id !== a.id),
              {
                id: "player",
                name: state.player.name,
                email: state.player.email,
                departmentId: state.player.departmentId,
              },
            ];

            // Targeting logic: weigh opponents by department (colleagues never attack each other)
            let weights = pool.map((t) =>
              t.departmentId === a.departmentId ? 0 : 1.0,
            );
            let totalWeight = weights.reduce((acc, w) => acc + w, 0);
            let random = Math.random() * totalWeight;
            let target = pool[0];
            for (let i = 0; i < pool.length; i++) {
              random -= weights[i];
              if (random <= 0) {
                target = pool[i];
                break;
              }
            }

            if (a.redirectNext) {
              a.redirectNext = false;
              if (target.id === "player") {
                const targets = alive.filter((o) => o.id !== a.id);
                if (targets.length > 0) {
                  target = targets[Math.floor(Math.random() * targets.length)];
                  addEmailToLog(
                    a.name,
                    "everyone@gov.org",
                    "Redirected Reply",
                    `Wait, I meant to send this to <strong>${target.name}</strong> instead.`,
                    "italic text-blue-400 text-[10px]",
                  );
                }
              }
            }

            let roll = Math.random();

            a.hp = Math.min(getUnitMaxHp(a), a.hp + getUnitTotalHeal(a));

            const availFromBook = a.addressBook
              .map((id) => CONTACTS.find((con) => con.id === id))
              .filter((c) => c && !isContactInLoop(c.id) && !isContactImplicated(c));
            if (roll < 0.15 && availFromBook.length > 0) {
              const c =
                availFromBook[Math.floor(Math.random() * availFromBook.length)];
              addContactBuff(a, c, a.name);
              const loopInText = formatLoopInText(
                c,
                `I'm looping in <strong>${c.name}</strong> to ensure this thread remains within professional guidelines.`,
              );
              addEmailToLog(
                a.name,
                "everyone@gov.org",
                "Looping in Support",
                loopInText,
                "bg-blue-50",
              );
            } else if (roll < 0.3 && a.hp < 20 && a.wins > 0) {
              a.wins--;
              a.hp = Math.min(getUnitMaxHp(a), a.hp + 15);
              const selfPromoteLine = drawFromLineBag(
                a,
                "selfPromote",
                getUnitSelfPromoteLines(a),
                "I'm logging a significant departmental achievement. This incident shouldn't distract from real wins.",
              );
              addEmailToLog(
                a.name,
                "everyone@gov.org",
                "Self Promotion",
                formatMessageBody(a, selfPromoteLine),
                "opacity-70",
              );
            } else {
              const actionRoll = Math.random();
              if (actionRoll < 0.15 && a.deflectCharge <= 0) {
                a.deflectCharge = getUnitDeflectPower(a);
                const deflectLine = drawFromLineBag(
                  a,
                  "deflect",
                  a.deflectLines,
                  "I'm pausing to document this thread before responding further.",
                );
                addEmailToLog(
                  a.name,
                  "everyone@gov.org",
                  "Holding Response",
                  `${formatMessageBody(a, deflectLine)}<br><br><strong>Deflection Ready:</strong> ${a.deflectCharge}`,
                  "bg-blue-50",
                );
              } else if (actionRoll < 0.35) {
                const d = getUnitDamage(a, "escalate");
                let totalBlocked = 0;
                let totalRecovered = 0;
                const recoverPerHit = getUnitEscalateRecover(a);
                const escalateTargets = [
                  ...alive.filter((o) => o.id !== a.id),
                  state.player,
                ];
                escalateTargets.forEach((t) => {
                  if (t !== state.player && t.departmentId === a.departmentId)
                    return;
                  if (t.hp > 0) {
                    const result = applyDamage(a, t, d);
                    totalBlocked += result.blocked;
                    if (recoverPerHit > 0) {
                      totalRecovered += recoverPerHit;
                      a.hp = Math.min(getUnitMaxHp(a), a.hp + recoverPerHit);
                    }
                    if (t !== state.player && t.hp <= 0)
                      handleOpponentDefeat(t);
                  }
                });
                const escLine = drawFromLineBag(
                  a,
                  "escalate",
                  a.escalateLines,
                  "I'm escalating this across the thread for visibility.",
                );
                let escBody = formatMessageBody(a, escLine);
                if (totalBlocked > 0) {
                  escBody += `<br><br><strong>Deflected:</strong> ${totalBlocked} reflected.`;
                }
                if (totalRecovered > 0) {
                  escBody += `<br><br><strong>Recovered:</strong> +${totalRecovered} Credibility.`;
                }
                addEmailToLog(
                  a.name,
                  "everyone@gov.org",
                  "Escalation Notice",
                  escBody,
                  "bg-orange-50",
                );
              } else {
                let d = getUnitDamage(a, "single");

                // Select attack type
                const q = drawFromLineBag(
                  a,
                  "attack",
                  a.attacks,
                  "I'm following up to keep this thread moving.",
                );
                let body = formatMessageBody(a, q);

                const followUpChance = getUnitFollowUpChance(a);
                const followUpHit =
                  followUpChance > 0 && Math.random() < followUpChance;
                const splashDamage = getUnitReplyDeptSplash(a);
                const bounceDamage = getUnitBounceDamage(a);

                if (target.id === "player") {
                  if (
                    state.player.buffs.find(
                      (b) => b.eff.dodge && Math.random() < b.eff.dodge,
                    )
                  ) {
                    addEmailToLog(
                      a.name,
                      state.player.name,
                      "Urgent Follow-up",
                      body +
                        `<br><br>(Thread ignored by <strong>Mittens</strong>. No standing lost.)`,
                      "text-blue-600",
                    );
                  } else {
                    const result = applyDamage(a, state.player, d);
                    const followUpResult = followUpHit
                      ? applyDamage(a, state.player, d)
                      : null;
                    const splashResult = applyDepartmentSplash(
                      a,
                      state.player,
                      splashDamage,
                    );
                    const bounceTarget = bounceDamage
                      ? pickBounceTarget(a, state.player)
                      : null;
                    const bounceResult = bounceTarget
                      ? applyDamage(a, bounceTarget, bounceDamage, {
                          ignoreReflect: true,
                        })
                      : null;
                    if (result.blocked > 0) {
                      body += `<br><br><strong>Deflected:</strong> ${result.blocked} reflected.`;
                    }
                    if (followUpResult) {
                      body += `<br><br><strong>Follow-up Reply:</strong> -${followUpResult.dmg}.`;
                    }
                    if (splashResult.hits > 0) {
                      body += `<br><br><strong>Department Splash:</strong> ${splashResult.hits} hit for ${splashResult.total}.`;
                    }
                    if (bounceResult && bounceTarget) {
                      body += `<br><br><strong>Bounce:</strong> ${bounceTarget.name} -${bounceResult.dmg}.`;
                    }
                    addEmailToLog(
                      a.name,
                      state.player.name,
                      "Escalation",
                      body +
                        `<br><br><strong>Damage to Credibility: -${result.dmg}</strong>`,
                      "bg-red-50 border-l-2 border-red-400",
                    );
                    document
                      .getElementById("game-ui")
                      .classList.add("shaking");
                    setTimeout(
                      () =>
                        document
                          .getElementById("game-ui")
                          .classList.remove("shaking"),
                      200,
                    );
                  }
                } else {
                  const result = applyDamage(a, target, d);
                  const followUpResult = followUpHit
                    ? applyDamage(a, target, d)
                    : null;
                  const splashResult = applyDepartmentSplash(
                    a,
                    target,
                    splashDamage,
                  );
                  const bounceTarget = bounceDamage
                    ? pickBounceTarget(a, target)
                    : null;
                  const bounceResult = bounceTarget
                    ? applyDamage(a, bounceTarget, bounceDamage, {
                        ignoreReflect: true,
                      })
                    : null;
                  if (result.blocked > 0) {
                    body += `<br><br><strong>Deflected:</strong> ${result.blocked} reflected.`;
                  }
                  if (followUpResult) {
                    body += `<br><br><strong>Follow-up Reply:</strong> -${followUpResult.dmg}.`;
                  }
                  if (splashResult.hits > 0) {
                    body += `<br><br><strong>Department Splash:</strong> ${splashResult.hits} hit for ${splashResult.total}.`;
                  }
                  if (bounceResult && bounceTarget) {
                    body += `<br><br><strong>Bounce:</strong> ${bounceTarget.name} -${bounceResult.dmg}.`;
                  }
                  addEmailToLog(
                    a.name,
                    target.name,
                    "Internal Memo",
                    body +
                      `<br><br>(Targeting ${target.name}. Standing lost: ${result.dmg})`,
                    "text-gray-500 text-[11px]",
                  );
                  if (target.hp <= 0) handleOpponentDefeat(target);
                }
              }
            }

            if (a.hp <= 0) {
              handleOpponentDefeat(a);
              return;
            }

            if (state.player.hp <= 0) {
              state.gameOver = true;
              updateUI();
              setTimeout(showLoseScreen, 1500);
            }
          }, idx * 700);
        });

        setTimeout(() => {
          if (!state.gameOver) {
            state.isProcessing = false;
            updateUI();
          }
        }, alive.length * 700);
      }

      function openAddressBook() {
        const list = document.getElementById("contact-list");
        list.innerHTML = "";
        document.getElementById("address-book-title").innerText =
          `PERSONNEL DIRECTORY (${state.player.addressBook.length}/${state.player.title.addressLimit})`;

        // CCs
        const headerCC = document.createElement("div");
        headerCC.className =
          "text-[10px] font-bold bg-gray-200 p-1 mb-1 uppercase";
        headerCC.innerText = "Address Book (Permanent CCs)";
        list.appendChild(headerCC);

        state.player.addressBook.forEach((id) => {
          const c = CONTACTS.find((con) => con.id === id);
          if (!c) return;
          const isUsed = isContactInLoop(c.id);
          const isImplicated = isContactImplicated(c);
          const isDisabled = isUsed || isImplicated;
          const statusText = isImplicated
            ? "IMPLICATED"
            : isUsed
              ? "IN LOOP"
              : "AVAIL";
          const setBadge = c.setId
            ? `<button type="button" data-set-button data-set-id="${c.setId}" class="text-[9px] uppercase px-1 py-0.5 rounded-sm bg-blue-100 text-blue-700 font-bold">Set</button>`
            : "";
          const btn = document.createElement("div");
          btn.className = `p-2 border border-gray-300 flex flex-col ${isDisabled ? "opacity-40 grayscale bg-gray-100" : "cursor-pointer hover:bg-blue-50"}`;
          btn.innerHTML = `<div class="flex justify-between font-bold text-[#000080] text-xs"><span>${c.name} - ${c.title}</span><span class="text-[9px]">${statusText}</span></div><div class="flex items-center gap-2 text-[10px] italic">${c.bonus || ""}${setBadge}</div>`;
          btn.querySelectorAll("[data-set-button]").forEach((setBtn) => {
            setBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              openSetInfo(setBtn.dataset.setId);
            });
          });
          if (!isDisabled)
            btn.onclick = () => {
              addContactBuff(state.player, c, state.player.name);
              const loopInText = formatLoopInText(
                c,
                `I'm looping in <strong>${c.name}</strong> (${c.title}) to help clarify the organizational impact of this thread.`,
              );
              addEmailToLog(
                state.player.name,
                "everyone@gov.org",
                "Looping in Witness",
                loopInText,
                "bg-blue-100 font-bold border-l-4 border-blue-500",
              );
              closeAddressBook();
              updateUI();
              state.isProcessing = true;
              setTimeout(ffaRound, 400);
            };
          list.appendChild(btn);
        });

        // BCCs
        if (state.player.bccContacts.length > 0) {
          const headerBCC = document.createElement("div");
          headerBCC.className =
            "text-[10px] font-bold bg-gray-200 p-1 mt-4 mb-1 uppercase";
          headerBCC.innerText = "Help Desk Contacts (BCC Consumables)";
          list.appendChild(headerBCC);

          state.player.bccContacts.forEach((b, idx) => {
            const btn = document.createElement("div");
            btn.className = `p-2 border border-gray-300 flex flex-col cursor-pointer hover:bg-yellow-50`;
            btn.innerHTML = `<div class="flex justify-between font-bold text-yellow-800 text-xs"><span>${b.name}</span><span class="text-[9px]">BCC</span></div><div class="text-[10px] italic">${b.bonus}</div>`;
            btn.onclick = () => {
              useBcc(b, idx);
            };
            list.appendChild(btn);
          });
        }

        document.getElementById("address-book").classList.remove("hidden");
      }

      function useBcc(bcc, index) {
        state.player.bccContacts.splice(index, 1);
        addEmailToLog(
          state.player.name,
          "everyone@gov.org",
          `BCC: ${bcc.name}`,
          `[PRIVATE MESSAGE] Sent: ${bcc.bonus}`,
          "bg-yellow-100 border-l-4 border-yellow-600",
        );

        if (bcc.effect === "stun") {
          const target = opponents.find((o) => o.id === state.targetId);
          target.isStunned = true;
          addEmailToLog(
            "SYSTEM",
            state.player.name,
            "Message Recalled",
            `${target.name}'s next turn will be skipped.`,
            "italic text-gray-500 text-[10px]",
          );
        } else if (bcc.effect === "doubleDmg") {
          state.player.nextAttackMult = 2;
          addEmailToLog(
            "SYSTEM",
            state.player.name,
            "Urgent Flag Set",
            `Your next reply to will deal 2x damage.`,
            "italic text-gray-500 text-[10px]",
          );
        } else if (bcc.effect === "redirect") {
          opponents.forEach((o) => {
            if (o.hp > 0) o.redirectNext = true;
          });
          addEmailToLog(
            "SYSTEM",
            state.player.name,
            "Message Redirected",
            `Anyone targeting you will be redirected next turn.`,
            "italic text-gray-500 text-[10px]",
          );
        }

        closeAddressBook();
        updateUI();
        state.isProcessing = true;
        setTimeout(ffaRound, 400);
      }

      function closeAddressBook() {
        document.getElementById("address-book").classList.add("hidden");
      }
    </script>
  </body>
</html>
