<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>REPLY ALL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=VT323&family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /**
         * FUNCTIONALITY CATALOG:
         * 1. Turn-based FFA Loop: Logic preserved.
         * 2. Targeting: TargetId state mapped to "To:" field.
        * 3. Actions: ATTACK (Reply to), ESCALATE (Light AOE), DEFLECT (Block/Reflect), SELF-PROMOTE (New Wins/Heal), ULT (Reply All), CC (Summon/Buff).
         * 4. Address Book: Modal system for assigning permanent buffs.
         * 5. Personality: Specific attack types (Compliance, Value, Time, Accusatory).
         */
      :root {
        --win-grey: #c0c0c0;
        --win-blue: #000080;
        --win-border-light: #ffffff;
        --win-border-dark: #404040;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: #008080;
        height: 100dvh;
        overflow: hidden;
        touch-action: manipulation;
        color: black;
      }
      .retro-border {
        border-top: 2px solid var(--win-border-light);
        border-left: 2px solid var(--win-border-light);
        border-bottom: 2px solid var(--win-border-dark);
        border-right: 2px solid var(--win-border-dark);
      }
      .retro-border-inset {
        border-top: 2px solid var(--win-border-dark);
        border-left: 2px solid var(--win-border-dark);
        border-bottom: 2px solid var(--win-border-light);
        border-right: 2px solid var(--win-border-light);
      }
      .retro-button {
        background: var(--win-grey);
        border-top: 2px solid var(--win-border-light);
        border-left: 2px solid var(--win-border-light);
        border-bottom: 2px solid var(--win-border-dark);
        border-right: 2px solid var(--win-border-dark);
        padding: 4px 8px;
        cursor: pointer;
        user-select: none;
      }
      .retro-button:active:not(:disabled) {
        border-top: 2px solid var(--win-border-dark);
        border-left: 2px solid var(--win-border-dark);
        border-bottom: 2px solid var(--win-border-light);
        border-right: 2px solid var(--win-border-light);
        padding-top: 5px;
        padding-bottom: 3px;
      }
      .retro-button:disabled {
        color: #808080;
        cursor: not-allowed;
        opacity: 0.6;
      }
      .terminal-font {
        font-family: "VT323", monospace;
      }
      @keyframes shake {
        0%,
        100% {
          transform: translate(0, 0);
        }
        25% {
          transform: translate(-3px, 3px);
        }
        50% {
          transform: translate(3px, -3px);
        }
        75% {
          transform: translate(-3px, -3px);
        }
      }
      .shaking {
        animation: shake 0.2s ease-in-out infinite;
      }
      .scroll-container::-webkit-scrollbar {
        width: 14px;
      }
      .scroll-container::-webkit-scrollbar-track {
        background: #dfdfdf;
      }
      .scroll-container::-webkit-scrollbar-thumb {
        background: var(--win-grey);
        border: 2px solid var(--win-border-light);
        box-shadow: inset -1px -1px 0 var(--win-border-dark);
      }
      .contacts-container {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        max-height: 38px;
        overflow: hidden;
        transition: max-height 0.2s ease;
      }
      .contacts-container.expanded {
        max-height: 140px;
      }
      .contacts-more {
        cursor: pointer;
        color: #000080;
        font-style: normal;
        font-weight: bold;
        text-decoration: underline;
        margin-left: 4px;
      }
      .target-pill {
        transition: all 0.2s;
        border: 1px solid #808080;
      }
      .target-pill.active {
        background: #000080 !important;
        color: white !important;
        border-color: #ffffff;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .message-entry {
        animation: slideIn 0.3s ease-out;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .email-header {
        background: #e8e8e8;
        border-bottom: 1px solid #ccc;
        font-family: sans-serif;
        font-size: 11px;
        color: #444;
      }
      .email-body {
        padding: 12px 0;
        line-height: 1.5;
        color: #111;
      }
    </style>
  </head>
  <body class="flex items-center justify-center p-0 md:p-2">
    <!-- INBOX SCREEN -->
    <div
      id="inbox-screen"
      class="hidden fixed inset-0 z-[90] flex items-center justify-center bg-[#008080] p-4"
    >
      <div
        class="bg-[#c0c0c0] retro-border max-w-2xl w-full h-[80dvh] flex flex-col shadow-2xl"
      >
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs"
        >
          <span>Outlook Express - Inbox</span>
          <div class="flex gap-1">
            <button
              class="w-4 h-4 bg-[#c0c0c0] text-black text-[10px] flex items-center justify-center"
            >
              _
            </button>
            <button
              class="w-4 h-4 bg-[#c0c0c0] text-black text-[10px] flex items-center justify-center"
            >
              X
            </button>
          </div>
        </div>
        <div
          class="bg-[#dfdfdf] border-b border-[#808080] p-1 flex gap-2 text-[10px]"
        >
          <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">File</button>
          <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">Edit</button>
          <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">View</button>
          <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">Tools</button>
          <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">Message</button>
          <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">Help</button>
        </div>
        <div class="flex-grow flex overflow-hidden">
          <div
            class="w-32 bg-[#dfdfdf] border-r border-[#808080] p-2 text-[10px] hidden sm:block"
          >
            <div class="font-bold mb-2">Folders</div>
            <div class="pl-2 space-y-1">
              <div class="bg-blue-800 text-white px-1">Inbox</div>
              <div>Outbox</div>
              <div>Sent Items</div>
              <div>Deleted Items</div>
              <div>Spam</div>
            </div>
          </div>
          <div class="flex-grow flex flex-col bg-white overflow-hidden">
            <div
              class="bg-[#f0f0f0] border-b border-[#808080] grid grid-cols-12 text-[9px] font-bold p-1"
            >
              <div class="col-span-1">!</div>
              <div class="col-span-5">From</div>
              <div class="col-span-6">Subject</div>
            </div>
            <div
              id="inbox-list"
              class="flex-grow overflow-y-auto overflow-x-hidden text-[11px] divide-y divide-gray-100"
            >
              <!-- Emails will be injected here -->
            </div>
          </div>
        </div>
        <div
          class="bg-[#dfdfdf] border-t border-[#808080] p-1 text-[10px] flex justify-between"
        >
          <div id="inbox-status">324 Messages, 1 Unread</div>
          <div class="flex gap-4">
            <span>Working Online</span>
          </div>
        </div>
      </div>
    </div>

    <!-- SUMMARY SCREEN (Performance Metrics) -->
    <div
      id="summary-screen"
      class="hidden fixed inset-0 z-[120] bg-black/60 flex items-center justify-center p-4"
    >
      <div
        class="bg-[#c0c0c0] retro-border max-w-xs w-full shadow-2xl overflow-hidden"
      >
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold"
        >
          <span>ARCHIVED THREAD</span>
          <span>✕</span>
        </div>
        <div class="p-4 flex flex-col items-center">
          <div
            class="w-16 h-16 bg-yellow-400 retro-border flex items-center justify-center mb-4"
          >
            <svg
              class="w-10 h-10 text-white"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
              <path
                fill-rule="evenodd"
                d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13zM7 13a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13z"
                clip-rule="evenodd"
              ></path>
            </svg>
          </div>
          <h2 class="text-xl font-bold terminal-font mb-2">
            PERFORMANCE METRICS
          </h2>
          <div
            class="w-full bg-white retro-border-inset p-3 space-y-2 text-xs mb-4"
          >
            <div class="flex justify-between">
              <span>Base Mission Reward:</span>
              <span id="summary-base-rep" class="font-mono">+4</span>
            </div>
            <div
              id="summary-optouts-list"
              class="space-y-1 py-1 border-y border-gray-100 hidden"
            >
              <!-- Individual opt-outs injected here -->
            </div>
            <div class="flex justify-between">
              <span>Additional Bonuses:</span>
              <span id="summary-bonus-rep" class="font-mono">+0</span>
            </div>
            <div id="summary-interest-row" class="flex justify-between hidden">
              <span>Reputational Interest:</span>
              <span id="summary-interest-rep" class="font-mono">+0</span>
            </div>
            <div
              class="border-t border-gray-300 pt-2 flex justify-between font-bold text-[#000080]"
            >
              <span>TOTAL REP EARNED:</span>
              <span id="summary-rep-earned" class="font-mono text-lg">+0</span>
            </div>
          </div>
            <button
              onclick="showShop()"
              class="w-full py-2 retro-button font-bold text-sm"
            >
              GO TO PORTAL
            </button>
        </div>
      </div>
    </div>

    <!-- SHOP SCREEN (HR Self-Service Portal) -->
    <div
      id="shop-screen"
      class="hidden fixed inset-0 z-[130] bg-[#008080] p-4 flex flex-col items-center overflow-y-auto"
    >
      <div
        class="bg-[#c0c0c0] retro-border w-full max-w-4xl shadow-2xl flex flex-col min-h-0"
      >
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold shrink-0"
        >
          <span>INTRA-NET: HR PORTAL & EMPLOYEE SERVICES</span>
          <button
            id="shop-reroll-btn"
            onclick="rerollShop()"
            class="retro-button text-black text-[10px] py-0 px-2 h-5 ml-auto mr-2"
          >
            Request alternate arrangements (5 REP)
          </button>
          <span
            id="shop-reputation-display"
            class="bg-yellow-400 text-black px-2 rounded-sm mr-4"
            >REPUTATION: 0</span
          >
          <button
            onclick="advanceToNextQuarter()"
            class="retro-button text-black text-[10px] py-0 px-2 h-5"
          >
            NEXT QUARTER &gt;
          </button>
        </div>
        <div class="bg-[#f0f0f0] p-4 flex-grow overflow-y-auto space-y-6">
          <!-- Active Employee Assets -->
          <div class="space-y-4">
            <h3 class="text-xs font-bold uppercase border-b border-[#808080] pb-1">
              Active Employee Assets
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div id="shop-owned-contacts" class="space-y-2"></div>
              <div class="space-y-4">
                <div id="shop-owned-signatures" class="space-y-2"></div>
                <div id="shop-owned-email-meta" class="space-y-2"></div>
                <div id="shop-owned-bccs" class="space-y-2"></div>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Individual Opportunities -->
            <div class="space-y-2">
              <h3 class="text-xs font-bold uppercase border-b border-[#808080] pb-1">
                Individual Opportunities (Direct)
              </h3>
              <div id="shop-direct-items" class="grid grid-cols-1 gap-2"></div>
            </div>
            <!-- Development Packs -->
            <div class="space-y-2">
              <h3 class="text-xs font-bold uppercase border-b border-[#808080] pb-1">
                Development Packs
              </h3>
              <div id="shop-packs" class="grid grid-cols-1 gap-2"></div>
            </div>
          </div>
        </div>
        <div
          class="bg-[#dfdfdf] border-t border-[#808080] p-2 text-[10px] text-center italic text-gray-600 shrink-0"
        >
          Corporate policy: Requests are logged. Archiving items returns partial
          reputation.
        </div>
      </div>
    </div>

    <!-- STATS SUMMARY MODAL -->
    <div
      id="stats-modal"
      class="hidden fixed inset-0 z-[160] bg-black/40 flex items-center justify-center p-4"
    >
      <div class="bg-[#f7f4e8] retro-border w-full max-w-2xl shadow-2xl">
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold"
        >
          <span>PLAYER STAT SUMMARY</span>
          <button id="stats-modal-close" class="px-1">✕</button>
        </div>
        <div class="p-3 text-[10px] text-gray-800 space-y-3">
          <div id="stats-modal-header" class="text-[11px] font-bold"></div>
          <div class="grid grid-cols-2 gap-2" id="stats-modal-totals"></div>
          <div>
            <div class="text-[10px] font-bold uppercase text-gray-500 mb-1">
              Sources
            </div>
            <div id="stats-modal-sources" class="space-y-2"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- LOSE SCREEN (Termination Notice) -->
    <div
      id="lose-screen"
      class="hidden fixed inset-0 z-[150] bg-black flex items-center justify-center p-4"
    >
      <div
        class="bg-[#c0c0c0] retro-border max-w-sm w-full shadow-2xl overflow-hidden"
      >
        <div
          class="bg-red-800 text-white px-2 py-1 flex justify-between items-center text-xs font-bold"
        >
          <span>SYSTEM LOCKOUT - SECURITY BREACH</span>
          <span>✕</span>
        </div>
        <div class="p-6 flex flex-col items-center">
          <div
            class="w-16 h-16 bg-red-600 retro-border flex items-center justify-center mb-6"
          >
            <svg
              class="w-10 h-10 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              ></path>
            </svg>
          </div>

          <h2 class="text-2xl font-bold terminal-font mb-4 text-red-800">
            NOTICE OF TERMINATION
          </h2>

          <div
            class="w-full bg-white retro-border-inset p-4 space-y-3 text-[11px] mb-6 leading-tight"
          >
            <p class="font-bold text-center border-b pb-2 mb-2">
              Final Employee Records
            </p>
            <div class="flex justify-between">
              <span class="text-gray-500 uppercase">Final Title:</span>
              <span id="lose-title" class="font-bold">Cubicle Resident</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500 uppercase">Period:</span>
              <span id="lose-period" class="font-bold">Q3 - YR 1</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500 uppercase">Total Reputation:</span>
              <span id="lose-total-rep" class="font-bold">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500 uppercase">Address Book:</span>
              <span id="lose-contacts" class="font-bold">0 Contacts</span>
            </div>
          </div>

          <div
            id="lose-message"
            class="text-[12px] text-center italic text-gray-800 px-2 leading-relaxed"
          >
            "Credibility is of utmost importance for ECO staff. As a result of
            correspondence recently brought to our attention, your role here has
            come to an end."
          </div>

          <div
            class="mt-8 text-[10px] text-gray-500 uppercase tracking-widest animate-pulse"
          >
            Access Revoked. See Security.
          </div>
          <button
            onclick="tryAgain()"
            class="mt-6 w-full py-2 retro-button font-bold text-sm"
          >
            TRY AGAIN
          </button>
        </div>
      </div>
    </div>

    <!-- PROMOTION SCREEN -->
    <div
      id="promotion-screen"
      class="hidden fixed inset-0 z-[140] bg-white flex items-center justify-center p-8 overflow-y-auto"
    >
      <div
        class="max-w-xl w-full border-8 border-double border-gray-300 p-8 flex flex-col items-center bg-[#fffcf0] shadow-xl relative"
      >
        <div class="absolute top-4 right-4 text-xs font-mono text-gray-400">
          INTERNAL MEMO #882-B
        </div>
        <div class="text-3xl font-serif font-bold text-[#000080] mb-2">
          OFFICE OF THE DIRECTOR
        </div>
        <div class="w-full border-b-2 border-[#000080] mb-8"></div>

        <h1
          class="text-4xl font-serif font-bold text-center mb-8 uppercase tracking-widest"
        >
          Notice of Promotion
        </h1>

        <p
          class="mb-4 text-lg leading-relaxed first-letter:text-5xl first-letter:font-bold first-letter:float-left first-letter:mr-2"
        >
          After a thorough review of your performance metrics during the
          previous fiscal quarters, the Board of Directors has approved your
          advancement within the organization.
        </p>

        <div
          class="my-8 text-center p-6 border-2 border-dashed border-[#000080] bg-blue-50 w-full"
        >
          <div class="text-sm font-bold uppercase text-gray-500 mb-1">
            New Assignment:
          </div>
          <div
            id="promotion-new-title"
            class="text-3xl font-bold text-[#000080] mb-4"
          >
            SENIOR OPERATIONS ANALYST
          </div>

          <div class="text-xs font-bold uppercase text-gray-500 mb-2">
            Updated Access:
          </div>
          <div
            id="promotion-perks"
            class="text-[11px] text-gray-700 bg-white retro-border p-2"
          >
            Signature capacity and address book limits updated.
          </div>
        </div>

        <p class="mb-12 text-center text-gray-600 italic">
          "Efficiency is its own reward."
        </p>

        <button
          onclick="advanceToNextQuarter()"
          class="px-12 py-4 bg-[#000080] text-white font-bold hover:bg-blue-700 transition-colors shadow-lg"
        >
          ADVANCE TO NEXT QUARTER
        </button>

        <div class="mt-8 opacity-20 grayscale">
          <img
            src="https://api.placeholder.com/100/100"
            class="w-20 h-20"
            alt="Corporate Seal"
          />
        </div>
      </div>
    </div>

    <!-- START SCREEN -->
    <div
      id="start-screen"
      class="fixed inset-0 z-[100] flex items-center justify-center bg-[#008080] p-4"
    >
      <div class="bg-[#c0c0c0] p-4 retro-border max-w-sm w-full shadow-2xl">
        <div
          class="bg-[#000080] text-white px-2 py-1 mb-4 flex justify-between items-center text-xs"
        >
          <span>NEW USER SETUP</span>
          <span>✕</span>
        </div>
        <h1
          class="text-4xl font-bold mb-2 text-center terminal-font tracking-widest text-[#000080]"
        >
          REPLY ALL
        </h1>
        <p class="mb-4 text-[11px] text-center leading-tight italic">
          "The path to being at peace is long and full of micro-agressions."
        </p>

        <div class="space-y-3 mb-6">
          <div>
            <label class="block text-[10px] font-bold uppercase mb-1"
              >Full Name:</label
            >
            <input
              id="player-name-input"
              type="text"
              placeholder="eke vdh"
              class="w-full p-2 bg-white retro-border-inset outline-none text-sm"
            />
          </div>
          <div>
            <label class="block text-[10px] font-bold uppercase mb-1"
              >Email:</label
            >
            <div
              id="email-preview"
              class="text-[11px] font-mono text-gray-800 bg-white/50 p-2 border border-dotted border-gray-400"
            >
              ...
            </div>
          </div>
        </div>

        <button
          onclick="startNewGame()"
          class="w-full py-3 font-bold retro-button text-[#000080]"
        >
          SIGN UP
        </button>
        <div id="login-section" class="mt-3 hidden">
          <div class="text-[10px] uppercase font-bold text-gray-500 mb-1">
            Existing User
          </div>
          <button
            id="login-btn"
            onclick="resumeGame()"
            class="w-full py-2 font-bold retro-button text-[#000080]"
          >
            Login as (...)
          </button>
        </div>
      </div>
    </div>

    <!-- MAIN GAME INTERFACE -->
    <div
      id="game-ui"
      class="hidden flex flex-col w-full h-full max-w-5xl bg-[#c0c0c0] retro-border overflow-hidden"
    >
      <div
        class="bg-[#000080] text-white p-1 flex justify-between items-center shrink-0"
      >
        <div class="flex items-center gap-2 px-1">
          <span id="game-header-subject" class="text-xs font-bold truncate"
            >Outlook Express - [RE: URGENT: Breakroom Smell]</span
          >
          <span
            id="game-quarter-display"
            class="text-[10px] bg-white text-blue-900 px-1 font-bold"
            >Q3 - YR 1</span
          >
        </div>
        <div class="flex gap-1 pr-1">
          <button
            class="w-4 h-4 bg-[#c0c0c0] border border-white text-black text-[10px] flex items-center justify-center"
          >
            _
          </button>
          <button
            class="w-4 h-4 bg-[#c0c0c0] border border-white text-black text-[10px] flex items-center justify-center"
          >
            X
          </button>
        </div>
      </div>

      <div
        class="flex gap-1 p-1 bg-[#c0c0c0] border-b border-[#808080] overflow-x-auto shrink-0 no-scrollbar"
      >
        <button
          class="retro-button text-[10px] font-bold flex items-center gap-1"
        >
          <svg
            class="w-3 h-3"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path d="M3 10l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V10z"></path>
          </svg>
          Inbox
        </button>
        <button class="retro-button text-[10px]">Mark as Read</button>
        <div class="flex-grow"></div>
        <div
          id="turn-clock"
          class="text-[10px] bg-white px-2 py-1 retro-border-inset font-mono"
        >
          09:00 AM
        </div>
      </div>

      <div class="flex flex-grow overflow-hidden relative">
        <div
          class="hidden md:flex w-48 bg-[#dfdfdf] border-r border-[#808080] flex-col shrink-0"
        >
          <div class="p-2 text-[10px] font-bold border-b border-[#808080]">
            Folders
          </div>
          <div class="p-2 space-y-1 text-[11px]">
            <div class="bg-blue-800 text-white px-1">Inbox (5)</div>
            <div class="px-1 text-gray-500">Promotions (3)</div>
            <div class="px-1">Sent Items</div>
            <div class="px-1">Deleted</div>
          </div>
        </div>

        <div class="flex-grow flex flex-col bg-white overflow-hidden">
          <!-- Bureaucratic Header -->
          <div
            class="p-2 bg-[#f0f0f0] border-b border-[#808080] text-[10px] shrink-0 space-y-1"
          >
            <div class="flex items-center gap-2">
              <span class="font-bold w-12 text-right">To:</span>
              <div
                id="target-selector"
                class="flex gap-1 overflow-x-auto no-scrollbar py-0.5"
              ></div>
            </div>
            <div class="flex gap-2 items-center" id="active-ccs">
              <span class="font-bold w-12 text-right">CC:</span>
              <div id="cc-display" class="flex gap-1 text-gray-400 italic">
                No one in loop.
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="font-bold w-12 text-right">Sub:</span>
              <div id="thread-subject" class="truncate text-gray-700"></div>
            </div>
          </div>

          <!-- Message Log -->
          <div
            id="message-log"
            class="flex-grow overflow-y-auto p-3 space-y-6 scroll-container bg-white font-sans text-sm"
          ></div>

          <!-- STATS BAR -->
          <div
            class="bg-[#dfdfdf] border-t border-[#808080] px-2 py-1.5 flex flex-col gap-1 shrink-0"
          >
            <div class="flex justify-between items-end">
              <span class="text-[9px] font-bold uppercase text-[#000080]"
                >Professional Credibility</span
              >
              <span id="player-hp-label" class="text-[9px] font-mono font-bold"
                >100/100</span
              >
            </div>
            <div class="h-3.5 w-full bg-white border border-[#808080] relative">
              <div
                id="player-hp-fill"
                class="h-full bg-green-500 transition-all duration-300"
                style="width: 100%"
              ></div>
            </div>
            <div class="flex justify-between items-center mt-0.5">
              <div class="flex gap-3">
                <div class="flex items-center gap-1">
                  <span class="text-[8px] font-bold uppercase opacity-60"
                    >Leverage:</span
                  >
                  <div class="w-16 h-1.5 bg-white border border-[#808080]">
                    <div
                      id="player-ult-fill"
                      class="h-full bg-yellow-400 transition-all"
                      style="width: 0%"
                    ></div>
                  </div>
                </div>
              </div>
              <div
                id="player-win-status"
                class="text-[8px] font-bold bg-[#c0c0c0] px-1 border border-inset border-white uppercase"
              >
                New Wins: 3 Available
              </div>
            </div>
          </div>

          <!-- Action Panel -->
          <div class="p-2 bg-[#c0c0c0] border-t-2 border-white shrink-0">
            <div class="grid grid-cols-3 gap-1.5 max-w-lg mx-auto">
              <button
                onclick="performAction('ATTACK')"
                class="retro-button py-2 flex flex-col items-center"
              >
                <span class="text-[11px] font-bold">Reply to</span>
                <span id="attack-subtext" class="text-[8px] opacity-70 italic"
                  >Target Reply</span
                >
              </button>
              <button
                onclick="performAction('ESCALATE')"
                class="retro-button py-2 flex flex-col items-center"
              >
                <span class="text-[11px] font-bold">Escalate</span>
                <span id="escalate-subtext" class="text-[8px] opacity-70 italic"
                  >Threadwide Nudge</span
                >
              </button>
              <button
                onclick="openAddressBook()"
                class="retro-button py-2 flex flex-col items-center"
              >
                <span class="text-[11px] font-bold">Loop Personnel</span>
                <span id="loop-subtext" class="text-[8px] opacity-70 italic"
                  >Add Witness</span
                >
              </button>
              <button
                id="win-btn"
                onclick="performAction('PROMOTE')"
                class="retro-button py-2 flex flex-col items-center"
              >
                <span class="text-[11px] font-bold">Self-Promote</span>
                <span id="promote-subtext" class="text-[8px] opacity-70 italic"
                  >Log a Win</span
                >
              </button>
              <button
                onclick="performAction('DEFLECT')"
                class="retro-button py-2 flex flex-col items-center"
              >
                <span class="text-[11px] font-bold">Deflect</span>
                <span id="deflect-subtext" class="text-[8px] opacity-70 italic"
                  >Hold Line</span
                >
              </button>
              <button
                id="reply-all-btn"
                onclick="performAction('ULT')"
                class="retro-button py-2 flex flex-col items-center disabled:opacity-50"
                disabled
              >
                <span class="text-[11px] font-bold text-red-800"
                  >REPLY ALL</span
                >
                <span id="ult-subtext" class="text-[8px] opacity-70 italic"
                  >Mass Takedown</span
                >
              </button>
            </div>
          </div>

          <div
            class="bg-[#c0c0c0] border-t border-white px-1 flex gap-px text-[9px] h-5 shrink-0"
          >
          <div
            class="retro-border-inset px-2 flex items-center flex-grow truncate cursor-pointer"
            id="status-bar-name"
            title="View stats"
          >
            Logged Out
          </div>
            <div
              class="retro-border-inset px-2 flex items-center w-24 justify-center"
              id="status-bar-email"
            >
              Online
            </div>
            <div
              class="retro-border-inset px-2 flex items-center w-12 justify-center"
            >
              NUM
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: ADDRESS BOOK -->
    <div
      id="address-book"
      class="fixed inset-0 z-[110] bg-black/50 items-center justify-center p-4 hidden flex"
    >
      <div class="bg-[#c0c0c0] retro-border w-full max-w-sm shadow-2xl">
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold"
        >
          <span id="address-book-title">PERSONNEL DIRECTORY</span>
          <button onclick="closeAddressBook()" class="px-1">✕</button>
        </div>
        <div
          id="contact-list"
          class="max-h-64 overflow-y-auto p-2 space-y-2 bg-white"
        ></div>
        <div class="p-2 flex justify-end bg-[#c0c0c0]">
          <button
            onclick="closeAddressBook()"
            class="retro-button text-xs px-4"
          >
            CANCEL
          </button>
        </div>
      </div>
    </div>
    <div
      id="cc-profile"
      class="fixed inset-0 z-[120] bg-black/50 items-center justify-center p-4 hidden flex"
    >
      <div class="bg-[#c0c0c0] retro-border w-full max-w-xs shadow-2xl">
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold"
        >
          <span id="cc-profile-title">CC Profile</span>
          <button onclick="closeCcProfile()" class="px-1">✕</button>
        </div>
        <div class="p-3 bg-white text-[11px] space-y-2">
          <div>
            <div class="font-bold text-[#000080]" id="cc-profile-name"></div>
            <div class="text-gray-600" id="cc-profile-role"></div>
          </div>
          <div class="text-gray-700" id="cc-profile-dept"></div>
          <div class="text-gray-700 italic" id="cc-profile-effect"></div>
        </div>
        <div class="p-2 flex justify-end bg-[#c0c0c0]">
          <button
            onclick="closeCcProfile()"
            class="retro-button text-xs px-4"
          >
            CLOSE
          </button>
        </div>
      </div>
    </div>
    <div
      id="set-info"
      class="fixed inset-0 z-[130] bg-black/50 items-center justify-center p-4 hidden flex"
    >
      <div class="bg-[#c0c0c0] retro-border w-full max-w-sm shadow-2xl">
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold"
        >
          <span id="set-info-title">Set</span>
          <button onclick="closeSetInfo()" class="px-1">✕</button>
        </div>
        <div class="p-3 bg-white text-[11px] space-y-2">
          <div class="font-bold text-[#000080]" id="set-info-name"></div>
          <div class="space-y-1">
            <div class="text-[10px] uppercase text-gray-500 font-bold">
              Parts
            </div>
            <div id="set-info-parts" class="flex flex-wrap gap-1"></div>
          </div>
          <div class="text-gray-700" id="set-info-bonus"></div>
          <div class="text-gray-600 italic" id="set-info-status"></div>
        </div>
        <div class="p-2 flex justify-end bg-[#c0c0c0]">
          <button
            onclick="closeSetInfo()"
            class="retro-button text-xs px-4"
          >
            CLOSE
          </button>
        </div>
      </div>
    </div>
    <div
      id="training-modal"
      class="fixed inset-0 z-[140] bg-black/50 items-center justify-center p-4 hidden flex"
    >
      <div class="bg-[#c0c0c0] retro-border w-full max-w-sm shadow-2xl">
        <div
          class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold"
        >
          <span id="training-title">Training Selection</span>
          <button onclick="closeTrainingModal()" class="px-1">✕</button>
        </div>
        <div class="p-3 bg-white text-[11px] space-y-2">
          <div class="font-bold text-[#000080]" id="training-name"></div>
          <div class="text-gray-600" id="training-subtitle"></div>
          <div id="training-options" class="space-y-2"></div>
          <div class="mt-4 border-t border-gray-200 pt-2">
            <button
              id="toggle-pack-management"
              onclick="togglePackManagement()"
              class="text-[10px] font-bold text-blue-800 underline"
            >
              Manage Current Assets
            </button>
            <div id="pack-management-container" class="hidden mt-2 space-y-2 max-h-48 overflow-y-auto"></div>
          </div>
        </div>
        <div class="p-2 flex justify-end bg-[#c0c0c0]">
          <button
            onclick="closeTrainingModal()"
            class="retro-button text-xs px-4"
          >
            CLOSE
          </button>
        </div>
      </div>
    </div>

    <script>
      // --- GAME DATA ---
      let sfxEnabled = false;
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const masterGain = audioCtx.createGain();
      masterGain.gain.value = 0.5;
      masterGain.connect(audioCtx.destination);

      const analyzer = audioCtx.createAnalyser();
      masterGain.connect(analyzer);
      analyzer.fftSize = 64;
      const brightnessHz = 2000;

      function getMasterFilter() {
        const filter = audioCtx.createBiquadFilter();
        filter.type = "lowpass";
        filter.frequency.value = brightnessHz;
        filter.connect(masterGain);
        return filter;
      }

      function createNoiseBuffer(duration = 0.5) {
        const bufferSize = audioCtx.sampleRate * duration;
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
        return buffer;
      }

      function playSound(soundKey) {
        if (!sfxEnabled) return;
        if (audioCtx.state === "suspended") audioCtx.resume();
        const now = audioCtx.currentTime;
        const filter = getMasterFilter();
        const g = audioCtx.createGain();
        g.connect(filter);

        switch (soundKey) {
          case "chime": {
            const osc = audioCtx.createOscillator();
            osc.type = "sine";
            osc.frequency.setValueAtTime(1400, now);
            const osc2 = audioCtx.createOscillator();
            osc2.frequency.setValueAtTime(2100, now);
            g.gain.setValueAtTime(0, now);
            g.gain.linearRampToValueAtTime(0.2, now + 0.05);
            g.gain.exponentialRampToValueAtTime(0.001, now + 0.8);
            osc.connect(g);
            osc2.connect(g);
            osc.start(now);
            osc2.start(now);
            osc.stop(now + 0.9);
            osc2.stop(now + 0.9);
            break;
          }
          case "send": {
            const n = audioCtx.createBufferSource();
            n.buffer = createNoiseBuffer(0.6);
            const sweep = audioCtx.createBiquadFilter();
            sweep.type = "bandpass";
            sweep.Q.value = 5;
            sweep.frequency.setValueAtTime(5000, now);
            sweep.frequency.exponentialRampToValueAtTime(200, now + 0.4);
            const sg = audioCtx.createGain();
            sg.gain.setValueAtTime(0, now);
            sg.gain.linearRampToValueAtTime(0.4, now + 0.1);
            sg.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
            n.connect(sweep);
            sweep.connect(sg);
            sg.connect(filter);
            n.start(now);
            break;
          }
          case "thunk": {
            const tosc = audioCtx.createOscillator();
            tosc.type = "triangle";
            tosc.frequency.setValueAtTime(160, now);
            tosc.frequency.exponentialRampToValueAtTime(40, now + 0.1);
            g.gain.setValueAtTime(0.7, now);
            g.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
            tosc.connect(g);
            tosc.start(now);
            tosc.stop(now + 0.3);
            break;
          }
          case "trash": {
            const trn = audioCtx.createBufferSource();
            trn.buffer = createNoiseBuffer(0.15);
            const hpf = audioCtx.createBiquadFilter();
            hpf.type = "highpass";
            hpf.frequency.value = 1800;
            g.gain.setValueAtTime(0.3, now);
            g.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
            trn.connect(hpf);
            hpf.connect(g);
            trn.start(now);
            break;
          }
          case "swipe": {
            const sn = audioCtx.createBufferSource();
            sn.buffer = createNoiseBuffer(0.2);
            const lpf = audioCtx.createBiquadFilter();
            lpf.frequency.setValueAtTime(3000, now);
            lpf.frequency.exponentialRampToValueAtTime(100, now + 0.2);
            g.gain.setValueAtTime(0.15, now);
            g.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
            sn.connect(lpf);
            lpf.connect(g);
            sn.start(now);
            break;
          }
          case "connect": {
            [523, 659, 784].forEach((f, i) => {
              const o = audioCtx.createOscillator();
              o.frequency.value = f;
              const ig = audioCtx.createGain();
              ig.gain.setValueAtTime(0, now + i * 0.08);
              ig.gain.linearRampToValueAtTime(0.1, now + i * 0.08 + 0.02);
              ig.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
              o.connect(ig);
              ig.connect(g);
              o.start(now + i * 0.08);
              o.stop(now + 0.5);
            });
            break;
          }
        }
      }

      document.addEventListener("keydown", (e) => {
        if (e.key === "m" || e.key === "M") {
          sfxEnabled = !sfxEnabled;
        }
      });

      const DEPARTMENTS = [
        { id: "operations", name: "Operations" },
        { id: "information_technology", name: "Information Technology" },
        { id: "executive_council_office", name: "Executive Council Office" },
        {
          id: "facilities_and_administration",
          name: "Facilities and Administration",
        },
        { id: "marketing", name: "Marketing" },
        { id: "constituent_services", name: "Constituent Services" },
        { id: "policy", name: "Policy" },
        { id: "finance", name: "Finance" },
        { id: "human_resources", name: "Human Resources" },
        { id: "legal", name: "Legal" },
        { id: "m4_agency", name: "M4 Agency" },
        { id: "digital_technology", name: "Digital Technology" },
      ];

      const DEPARTMENT_BY_ID = Object.fromEntries(
        DEPARTMENTS.map((d) => [d.id, d]),
      );

      const CONTACTS = [
        {
          id: "cc_telly_operations",
          name: "Telly",
          title: "Intern",
          rarity: "common",
          departmentId: "marketing",
          employeeId: "telly_marketing",
          bonus: "+3 reply to.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to generate a contact report for this thread.",
          eff: {
            singleDmg: 3,
          },
          usedBy: null,
        },
        {
          id: "cc_elsie",
          name: "Elsie",
          title: "The Baby",
          rarity: "rare",
          departmentId: "legal",
          bonus: "Cuteness: 25% Distraction chance.",
          loopInText:
            "Look at <strong>{name}</strong>! Isn't she adorable?",
          eff: {
            dodge: 0.25,
            specialTriggerText: "Thread distracted by {name}'s cuteness! No standing lost.",
          },
          usedBy: null,
          noShop: true,
        },
        {
          id: "cc_tater_the_dog",
          name: "Tater the Dog",
          title: "The Goodest Boy",
          rarity: "rare",
          departmentId: "facilities_and_administration",
          bonus: "Good Boy: 50% chance to reply twice.",
          loopInText:
            "I'm looping in <strong>{name}</strong>! Who's a good boy?",
          eff: {
            followUpChance: 0.5,
          },
          usedBy: null,
          noShop: true,
        },
        {
          id: "cc_andrew_legal",
          name: "Andrew",
          title: "Legal Counsel",
          rarity: "uncommon",
          departmentId: "legal",
          employeeId: "andrew_legal",
          bonus: "Dry Wit: Reduce incoming damage by 2.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to give us some perspective. He's a lawyer, but he's cool.",
          eff: {
            defFlat: 2,
          },
          usedBy: null,
        },
        {
          id: "cc_willy_boy_information_technology",
          name: "Willy Boy",
          title: "IT Specialist",
          rarity: "common",
          departmentId: "information_technology",
          bonus: "+5 Credibility/turn.",
          loopInText:
            "I'm looping in <strong>{name}</strong> because I think we need an {title} to help with the technical issues affecting others' replies in this thread.",
          eff: {
            heal: 5,
          },
          usedBy: null,
        },
        {
          id: "cc_colin_information_technology",
          name: "Colin",
          title: "IT Lead",
          rarity: "uncommon",
          departmentId: "information_technology",
          employeeId: "colin_information_technology",
          bonus: "Reply to +5 & Escalate +3.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to keep our technical support aligned and logged.",
          eff: {
            singleDmg: 5,
            replyAllDmg: 3,
          },
          usedBy: null,
        },
        {
          id: "cc_samantha_executive_council_office",
          name: "Samantha",
          title: "Director of Marketing",
          rarity: "rare",
          departmentId: "executive_council_office",
          employeeId: "samantha_executive_council_office",
          bonus: "Reduce incoming damage by 4.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to help frame this conversation around department wide resourcing.",
          eff: {
            defFlat: 4,
          },
          usedBy: null,
        },
        {
          id: "cc_tim_executive_council_office",
          name: "Tim",
          title: "Premier",
          rarity: "rare",
          departmentId: "executive_council_office",
          bonus: "3x Leverage gain.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to keep him in the loop on this initative.",
          eff: {
            levMult: 2,
          },
          usedBy: null,
        },
        {
          id: "cc_nimby_facilities_and_administration",
          name: "Nimby",
          title: "Office Cat",
          rarity: "rare",
          departmentId: "facilities_and_administration",
          bonus: "35% Distraction chance.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to provide this thread more light-hearted content.",
          eff: {
            dodge: 0.35,
            specialTriggerText: "Thread distracted by {name}! No standing lost.",
          },
          usedBy: null,
        },
        {
          id: "cc_lisa_marketing",
          name: "Lisa",
          title: "Director of Research",
          rarity: "uncommon",
          departmentId: "marketing",
          bonus: "+8 reply to",
          loopInText:
            "I'm looping in <strong>{name}</strong> to provide data‑driven context and keep claims grounded.",
          eff: {
            singleDmg: 8,
          },
          usedBy: null,
        },
        {
          id: "cc_meghan_cassedy_executive_council_office",
          name: "Meghan Cassedy",
          title: "Marketing Advisor",
          rarity: "rare",
          departmentId: "executive_council_office",
          bonus: "Reduce incoming damage by 3 & Self-Promote +5.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to advise on our tactical approach and reduce reputational risk.",
          eff: {
            defFlat: 3,
            selfPromoteHeal: 5,
          },
          usedBy: null,
        },
        {
          id: "cc_larry_facilities_and_administration",
          name: "Larry",
          title: "Facilities Lead",
          rarity: "rare",
          departmentId: "facilities_and_administration",
          bonus: "Reduce incoming damage by 2 & +3 Credibility/turn.",
          loopInText:
            "I'm looping in <strong>{name}</strong> ({title}) to handle the facilities impact.",
          eff: {
            defFlat: 2,
            heal: 3,
          },
          usedBy: null,
        },
        {
          id: "cc_dave_constituent_services",
          name: "Dave",
          title: "Social Media Manager",
          rarity: "rare",
          departmentId: "constituent_services",
          bonus: "No combat bonus, but +12 REP if in loop at end of match.",
          loopInText:
            "I'm looping in <strong>{name}</strong> for awareness and to mitigate reputational risk if this thread leaks.",
          eff: {
            endRep: 12,
          },
          usedBy: null,
        },
        {
          id: "cc_gemma_policy",
          name: "Gemma",
          title: "Policy Analyst",
          rarity: "rare",
          departmentId: "policy",
          bonus: "Reduce incoming damage by 3.",
          loopInText:
            "I'm looping in <strong>{name}</strong> from {department} to ensure this stays within policy guardrails.",
          eff: {
            defFlat: 3,
          },
          usedBy: null,
        },
        {
          id: "cc_adam_finance",
          name: "Adam",
          title: "Budget Controller",
          rarity: "uncommon",
          departmentId: "finance",
          bonus: "+5 Max Credibility & +5 Credibility/turn.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to track fiscal impact against budgetary constraints and keep the numbers straight.",
          eff: {
            maxHp: 5,
            heal: 5,
          },
          usedBy: null,
        },
        {
          id: "cc_rowan_constituent_services",
          name: "Rowan",
          title: "Public Liaison",
          rarity: "rare",
          departmentId: "constituent_services",
          bonus: "+8 REP if in loop at end of match.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to handle external messaging and stakeholder optics.",
          eff: {
            endRep: 8,
          },
          usedBy: null,
        },
        {
          id: "cc_karen_human_resources",
          name: "Karen",
          title: "HR Manager",
          rarity: "rare",
          departmentId: "human_resources",
          employeeId: "karen_human_resources",
          bonus: "Reduce incoming damage by 2.",
          loopInText:
            "I'm looping in <strong>{name}</strong> from {department} to keep this thread compliant with HR policy.",
          eff: {
            defFlat: 2,
          },
          usedBy: null,
        },
        {
          id: "cc_avery_operations",
          name: "Avery",
          title: "Operations Coordinator",
          rarity: "common",
          departmentId: "operations",
          employeeId: "avery_operations",
          bonus: "+2 reply to & Self-Promote +5.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to track operational impact and keep this moving.",
          eff: {
            singleDmg: 2,
            selfPromoteHeal: 5,
          },
          usedBy: null,
        },
        {
          id: "cc_malik_marketing",
          name: "Malik",
          title: "Marketing Lead",
          rarity: "common",
          departmentId: "marketing",
          employeeId: "malik_marketing",
          bonus: "+1 all messages & Self-Promote +5.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to keep brand alignment on this thread.",
          eff: {
            globalDmg: 1,
            selfPromoteHeal: 5,
          },
          usedBy: null,
        },
        {
          id: "cc_priya_finance",
          name: "Priya",
          title: "Finance Analyst",
          rarity: "common",
          departmentId: "finance",
          employeeId: "priya_finance",
          bonus: "+3 Credibility/turn.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to monitor budget exposure and expected impact.",
          eff: {
            heal: 3,
          },
          usedBy: null,
        },
        {
          id: "cc_rory_operations",
          name: "Rory",
          title: "Facilities Coordinator",
          rarity: "rare",
          departmentId: "operations",
          employeeId: "rory_operations",
          bonus: "Reduce incoming damage by 1, +2 Credibility/turn & Self-Promote +5.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to keep the facilities schedule and shared space aligned.",
          eff: {
            defFlat: 1,
            heal: 2,
            selfPromoteHeal: 5,
          },
          usedBy: null,
        },
        {
          id: "cc_dora_finance",
          name: "Dora",
          title: "Budget Specialist",
          rarity: "common",
          departmentId: "finance",
          employeeId: "dora_finance",
          bonus: "+10 Max Credibility.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to see if she can get help with her budgets.",
          eff: {
            maxHp: 10,
          },
          usedBy: null,
        },
        {
          id: "cc_christina_policy",
          name: "Christina",
          title: "Policy Officer",
          rarity: "common",
          departmentId: "policy",
          employeeId: "christina_policy",
          bonus: "Deflect +2.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to ensure we stay aligned with policy language.",
          eff: {
            deflect: 2,
          },
          usedBy: null,
        },
        {
          id: "cc_fraser_information_technology",
          name: "Fraser",
          title: "IT Support",
          rarity: "common",
          departmentId: "information_technology",
          employeeId: "fraser_information_technology",
          bonus: "Deflect +2.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to support technical logging and incident tracking.",
          eff: {
            deflect: 2,
          },
          usedBy: null,
        },
        {
          id: "cc_anthony_m4_agency",
          name: "Anthony",
          title: "Media Coordinator",
          rarity: "common",
          departmentId: "m4_agency",
          employeeId: "anthony_m4_agency",
          bonus: "+3 reply all",
          loopInText:
            "I'm looping in <strong>{name}</strong> to manage the broader comms fallout.",
          eff: {
            replyAllDmg: 3,
          },
          usedBy: null,
        },
        {
          id: "cc_jonah_finance",
          name: "Jonah",
          title: "Budget Analyst",
          rarity: "uncommon",
          departmentId: "finance",
          employeeId: "jonah_finance",
          bonus: "+5 Max Credibility, +2 Credibility/turn & Self-Promote +5.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to provide a spend analysis and risk outlook.",
          eff: {
            maxHp: 5,
            heal: 2,
            selfPromoteHeal: 5,
          },
          usedBy: null,
        },
        {
          id: "cc_megan_legal",
          name: "Megan",
          title: "Compliance Counsel",
          rarity: "rare",
          departmentId: "legal",
          employeeId: "megan_legal",
          bonus: "Reduce incoming damage by 3.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to confirm our legal footing.",
          eff: {
            defFlat: 3,
          },
          usedBy: null,
        },
        {
          id: "cc_interns_human_resources",
          name: "Interns",
          title: "Intern Collective",
          rarity: "uncommon",
          departmentId: "human_resources",
          employeeId: "interns_human_resources",
          bonus: "Follow-up chance +20%.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to document intern feedback and thread tone.",
          eff: {
            followUpChance: 0.20,
          },
          usedBy: null,
        },
        {
          id: "cc_sheila_finance",
          name: "Sheila",
          title: "Payroll Specialist",
          rarity: "uncommon",
          departmentId: "finance",
          employeeId: "sheila_finance",
          bonus: "+50% reputation gains.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to keep payroll exposure in view.",
          eff: {
            repBonus: 0.50,
          },
          usedBy: null,
        },
        {
          id: "cc_taz_m4_agency",
          name: "Taz",
          title: "Media Planner",
          rarity: "uncommon",
          departmentId: "m4_agency",
          employeeId: "taz_m4_agency",
          bonus: "+5 escalate.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to sync the escalation plan and media response.",
          eff: {
            escalateDmg: 5,
          },
          usedBy: null,
        },
        {
          id: "cc_anneke_executive_council_office",
          name: "Anneke",
          title: "Senior Advisor",
          rarity: "rare",
          departmentId: "executive_council_office",
          employeeId: "anneke_executive_council_office",
          bonus: "+10 REP if in loop at end of match.",
          loopInText:
            "I'm looping in <strong>{name}</strong> to provide executive counsel and strategic framing.",
          eff: {
            endRep: 10,
          },
          usedBy: null,
        },
        {
          id: "cc_selina_m4_agency",
          name: "Selina",
          title: "Account Director",
          rarity: "rare",
          departmentId: "m4_agency",
          employeeId: "selina_m4_agency",
          bonus: "+5 all messages",
          loopInText:
            "I'm looping in <strong>{name}</strong> to stabilize the account and reframe the narrative.",
          eff: {
            globalDmg: 5,
          },
          usedBy: null,
        },
      ];

      const TITLES = [
        {
          name: "Cubicle Resident",
          id: "cubicle_resident",
          level: 1,
          addressLimit: 5,
          sigLimit: 2,
          numCCperCCaction: 0,
        },
        {
          name: "Junior Clerk",
          id: "junior_clerk",
          level: 2,
          addressLimit: 7,
          sigLimit: 4,
          numCCperCCaction: 1,
        },
        {
          name: "Senior Clerk",
          id: "senior_clerk",
          level: 3,
          addressLimit: 9,
          sigLimit: 6,
          numCCperCCaction: 1,
        },
        {
          name: "Program Coordinator",
          id: "program_coordinator",
          level: 4,
          addressLimit: 11,
          sigLimit: 8,
          numCCperCCaction: 2,
        },
        {
          name: "Director",
          id: "director",
          level: 5,
          addressLimit: 13,
          sigLimit: 10,
          numCCperCCaction: 2,
        },
        {
          name: "Deputy Director",
          id: "deputy_director",
          level: 6,
          addressLimit: 15,
          sigLimit: 11,
          numCCperCCaction: 2,
        },
        {
          name: "Department Chief",
          id: "department_chief",
          level: 7,
          addressLimit: 17,
          sigLimit: 12,
          numCCperCCaction: 2,
        },
        {
          name: "Deputy Minister",
          id: "deputy_minister",
          level: 8,
          addressLimit: 20,
          sigLimit: 15,
          numCCperCCaction: 3,
        }
      ];

      const SIGNATURES = [
        {
          id: "iphone",
          name: "Sent from my iPhone",
          bonus:
            "Gain 1 rep for each person who removes themselves that you did not instigate.",
          rarity: "common",
          repBonus: 1,
        },
        {
          id: "regards",
          name: "Kind Regards,",
          bonus: "+10 Max Credibility",
          rarity: "common",
          maxHp: 10,
        },
        {
          id: "per_my_last",
          name: "Per my last email,",
          bonus: "+10% reply to",
          rarity: "uncommon",
          singleDmgMult: 0.1,
        },
        {
          id: "best",
          name: "Best,",
          bonus: "+2 Credibility/turn & Self-Promote +5.",
          rarity: "uncommon",
          heal: 2,
          selfPromoteHeal: 5,
        },
        {
          id: "thanks_advance",
          name: "Thanks in advance,",
          bonus: "50% chance to double leverage gain.",
          rarity: "rare",
          doubleLevChance: 0.5,
        },
        {
          id: "encrypted",
          name: "Sent from my encrypted workstation",
          bonus: "15% damage reduction.",
          rarity: "rare",
          def: 0.15,
        },
        {
          id: "renewable_energy",
          name: "Our office aspires to be powered by 100% renewable energy.",
          bonus: "Dept splash +5.",
          rarity: "rare",
          replyDeptSplash: 5,
        },
        {
          id: "environment_printing",
          name: "Please consider the environment before printing this email",
          bonus: "+1 Credibility/turn.",
          rarity: "uncommon",
          setId: "earth_set",
          heal: 3,
        },
        {
          id: "coffee_break",
          name: "Sent from the breakroom coffee line",
          bonus: "+50% leverage gain.",
          rarity: "common",
          setId: "coffee_lovers",
          levMult: 0.50,
        },
        {
          id: "double_espresso",
          name: "Powered by double espresso",
          bonus: "+1 reply to",
          rarity: "common",
          setId: "coffee_lovers",
          singleDmg: 1,
        },
        {
          id: "disclaimer",
          name: "Standard Disclaimer Applied",
          bonus: "+10% reply to",
          rarity: "common",
          singleDmgMult: 0.1,
        },
        {
          id: "breakroom",
          name: "Sent from the breakroom",
          bonus: "+2 Credibility/turn.",
          rarity: "uncommon",
          heal: 2,
        },
      ];

      const SALUTATIONS = [
        {
          id: "hi_all",
          name: "Hi all,",
          bonus: "+10 Max Credibility",
          rarity: "common",
          maxHp: 10,
        },
        {
          id: "good_afternoon",
          name: "Good afternoon,",
          bonus: "+5 Max Credibility, +1 Credibility/turn & Self-Promote +5",
          rarity: "common",
          maxHp: 5,
          heal: 1,
          selfPromoteHeal: 5,
        },
        {
          id: "good_evening",
          name: "Good evening,",
          bonus: "+50% leverage gain",
          rarity: "uncommon",
          levMult: 0.50,
        },
        {
          id: "all",
          name: "All,",
          bonus: "+1 reply to",
          rarity: "common",
          singleDmg: 1,
        },
        {
          id: "hello_team",
          name: "Hello team,",
          bonus: "+1 Credibility/turn & Self-Promote +5",
          rarity: "common",
          heal: 1,
          selfPromoteHeal: 5,
        },
        {
          id: "all_stakeholders",
          name: "To all stakeholders,",
          bonus: "+5 all messages",
          rarity: "rare",
          globalDmg: 5,
        },
        {
          id: "working_group",
          name: "To the working group,",
          bonus: "Deflect +2.",
          rarity: "uncommon",
          deflect: 2,
        },
        {
          id: "committee",
          name: "To the committee,",
          bonus: "+2 reply all",
          rarity: "uncommon",
          replyAllDmg: 2,
        },
        {
          id: "team",
          name: "Team,",
          bonus: "+2 reply to",
          rarity: "common",
          singleDmg: 2,
        },
        {
          id: "colleagues",
          name: "Dear Colleagues,",
          bonus: "Deflect +1.",
          rarity: "uncommon",
          deflect: 1,
        },
        {
          id: "everyone",
          name: "Everyone,",
          bonus: "+50% Leverage gain",
          rarity: "uncommon",
          levMult: 0.5,
        },
        {
          id: "formal",
          name: "To whom it may concern,",
          bonus: "+5 reply to",
          rarity: "rare",
          singleDmg: 5,
        },
        {
          id: "morning",
          name: "Good morning,",
          bonus: "+10 Max Credibility",
          rarity: "common",
          maxHp: 10,
        },
        {
          id: "project_team",
          name: "To the Project Team,",
          bonus: "+2 reply to",
          rarity: "common",
          singleDmg: 2,
        },
        {
          id: "sustainability_team",
          name: "To the Sustainability Team,",
          bonus: "+5 all messages",
          rarity: "uncommon",
          setId: "earth_set",
          globalDmg: 5,
        },
        {
          id: "greetings",
          name: "Greetings all,",
          bonus: "Deflect +1.",
          rarity: "uncommon",
          deflect: 1,
        },
      ];

      const SIGNOFFS = [
        {
          id: "thanks",
          name: "Thanks,",
          bonus: "+10 Max Credibility",
          rarity: "common",
          maxHp: 10,
        },
        {
          id: "respectfully",
          name: "Respectfully,",
          bonus: "+10 Max Credibility",
          rarity: "common",
          maxHp: 10,
        },
        {
          id: "regards_signoff",
          name: "Regards,",
          bonus: "+5 Max Credibility, +1 Credibility/turn & Self-Promote +5",
          rarity: "common",
          maxHp: 5,
          heal: 1,
          selfPromoteHeal: 5,
        },
        {
          id: "kind_regards_signoff",
          name: "Kind regards,",
          bonus: "+2 Credibility/turn & Self-Promote +5",
          rarity: "common",
          heal: 2,
          selfPromoteHeal: 5,
        },
        {
          id: "yours_truly",
          name: "Yours truly,",
          bonus: "+75% leverage gain",
          rarity: "uncommon",
          levMult: 0.75,
        },
        {
          id: "best_signoff",
          name: "Best,",
          bonus: "+2 reply to",
          rarity: "uncommon",
          singleDmg: 2,
        },
        {
          id: "thank_you",
          name: "Thank you,",
          bonus: "+10% reputation gains",
          rarity: "uncommon",
          repBonus: 0.1,
        },
        {
          id: "with_appreciation",
          name: "With appreciation,",
          bonus: "+1 REP at end of match.",
          rarity: "uncommon",
          endRep: 1,
        },
        {
          id: "for_your_awareness",
          name: "For your awareness,",
          bonus: "+3 reply all",
          rarity: "rare",
          replyAllDmg: 3,
        },
        {
          id: "cheers",
          name: "Cheers,",
          bonus: "+2 Credibility/turn",
          rarity: "common",
          heal: 2,
        },
        {
          id: "sincerely",
          name: "Sincerely,",
          bonus: "Deflect +2.",
          rarity: "uncommon",
          deflect: 2,
        },
        {
          id: "best_regards",
          name: "Best Regards,",
          bonus: "+5 reply to",
          rarity: "uncommon",
          singleDmg: 5,
        },
        {
          id: "v_respectfully",
          name: "Very Respectfully,",
          bonus: "+150% Leverage gain",
          rarity: "rare",
          levMult: 1.5,
        },
        {
          id: "warmly",
          name: "Warmly,",
          bonus: "+10 Max Credibility",
          rarity: "common",
          maxHp: 10,
        },
        {
          id: "solidarity",
          name: "In solidarity,",
          bonus: "+2 Credibility/turn",
          rarity: "common",
          heal: 2,
        },
        {
          id: "solidarity_earth",
          name: "In solidarity with the Earth",
          bonus: "Deflect +2.",
          rarity: "uncommon",
          setId: "earth_set",
          deflect: 2,
        },
        {
          id: "best_wishes",
          name: "Best wishes,",
          bonus: "50% Leverage gain",
          rarity: "uncommon",
          levMult: 0.5,
        },
      ];

      const BCC_CONTACTS = [
        {
          id: "recall",
          name: "Recall Message",
          bonus: "Instantly stun current target for 1 turn.",
          rarity: "common",
          effect: "stun",
          logText: "I've recalled this message to ensure accuracy.",
        },
        {
          id: "urgent",
          name: "Urgent Flag",
          bonus: "Next reply to deals 2x damage.",
          rarity: "uncommon",
          effect: "doubleDmg",
          logText: "I've flagged this thread as [URGENT] to expedite a resolution.",
        },
        {
          id: "redirect",
          name: "Redirect Message",
          bonus: "Current target attacks another random opponent next turn.",
          rarity: "rare",
          effect: "redirect",
          logText: "I'm redirecting this thread to the relevant departmental stakeholders.",
        },
        {
          id: "expense_report",
          name: "Expense Report",
          bonus: "Doubles mission base rep (max +10 bonus).",
          rarity: "common",
          effect: "doubleRep",
          logText: "I've submitted an expense report for this initiative's overhead.",
        },
        {
          id: "networking_event",
          name: "Networking Event",
          bonus: "Gain reputation equal to the total sell value of your current CCs (Max 30).",
          rarity: "uncommon",
          effect: "contactRep",
          logText: "How {playerName} uses AI to expedite their workflows will be featured in our upcoming newsletter!",
        },
        {
          id: "mentorship",
          name: "Mentorship Program",
          bonus: "Trains a random contact in your loop for reply to damage, escalate, and max health.",
          rarity: "rare",
          effect: "trainContact",
          logText: "I've initiated a mentorship review to upskill our CC'd personnel.",
        },
        {
          id: "headhunter",
          name: "Headhunter Referral",
          bonus: "Gain a random contact permanently if you have space, and immediately loop them into this thread.",
          rarity: "rare",
          effect: "randomContact",
          logText: "I've reached out to a headhunter to bring in some fresh perspective.",
        },
      ];

      const SET_DEFS = [
        {
          id: "earth_set",
          name: "Sustainability Protocol",
          items: [
            { type: "salutation", id: "sustainability_team" },
            { type: "signoff", id: "solidarity_earth" },
            { type: "signature", id: "environment_printing" },
          ],
          effect: {
            globalDmg: 5,
            defFlat: 3,
            deflect: 2,
            escalateRecoverPerHit: 10,
          },
        },
        {
          id: "office_allies",
          name: "Office Allies",
          items: [
            { type: "contact", id: "cc_anneke_executive_council_office" },
            { type: "contact", id: "cc_willy_boy_information_technology" },
          ],
          effect: {
            special: "Automatically loops in Tater the Dog when both are CC'd.",
          },
        },
        {
          id: "coffee_lovers",
          name: "Coffee Lovers",
          items: [
            { type: "signature", id: "coffee_break" },
            { type: "signature", id: "double_espresso" },
          ],
          effect: {
            bounceBase: 5,
          },
        },
        {
          id: "legal_parents",
          name: "New Parents",
          items: [
            { type: "contact", id: "cc_andrew_legal" },
            { type: "contact", id: "cc_megan_legal" },
          ],
          effect: {
            special: "Automatically loops in Elsie when both parents are CC'd.",
          },
        },
      ];

      const EMPLOYEES = [
        {
          id: "andrew_legal",
          name: "Andrew (Legal)",
          email: "a.legal@gov.org",
          departmentId: "legal",
          color: "text-red-700",
          defeatMessage: "Fine. I'm leaving. I've got a lawn to mow anyway.",
          selfPromote:
            "I finally cleared my desk. It only took three years of ignored emails.",
          deflectLines: [
            "I'm going to need a minute to process this. Or an hour. Maybe a day.",
          ],
          lines: [
            { text: "Fine.", missionId: null },
            { text: "Noted.", missionId: null },
            { text: "I'll look into it. Eventually.", missionId: null },
            { text: "That's certainly a choice.", missionId: null },
            { text: "I've seen worse. Not much worse, but worse.", missionId: null },
          ],
        },
        {
          id: "karen_human_resources",
          name: "Karen (HR)",
          email: "k.smith@gov.org",
          departmentId: "human_resources",
          color: "text-purple-700",
          defeatMessage:
            "I am unsubscribing. I've documented the lack of professional decorum and will be following up with each of you individually. Regards.",
          selfPromote:
            "I've just updated the internal wiki with our new 'Efficiency Standards'. My contribution score is through the roof.",
          deflectLines: [
            "I'm pausing to document this thread before responding further.",
          ],
          lines: [
            {
              text: "Your recent breakroom habits suggest a lack of respect for shared departmental assets.",
              missionId: "microwave",
            },
            {
              text: "I noticed you haven't completed the mandatory 'Digital Hygiene' training module for this quarter.",
              missionId: null,
            },
            {
              text: "I have three disciplinary hearings today; this thread is a significant drain on my operational capacity.",
              missionId: null,
            },
            {
              text: "HR provides the framework for your employment; your contributions are currently being 're-evaluated'.",
              missionId: null,
            },
            {
              text: "Please review the updated 'Shared Space Etiquette' PDF attached to my signature.",
              missionId: null,
            },
            {
              text: "I'm scheduling a mandatory mediation session for the entire floor this Friday at 4:30 PM.",
              missionId: null,
            },
            {
              text: "Your tone in this thread has been noted and will be discussed during your next performance review.",
              missionId: null,
            },
            {
              text: "We have a zero-tolerance policy for passive-aggressive CC-ing. Please adhere to the chain of command.",
              missionId: null,
            },
            {
              text: "I've CC'd the Chief Wellness Officer to address the 'toxic environment' you're creating.",
              missionId: null,
            },
            {
              text: "Failure to identify the salmon-heater will result in a collective reduction of the 'Team Synergy' bonus.",
              missionId: "microwave",
            },
            {
              text: "I'm looking at the handbook right now, and you're in violation of Section 8.4: Olfactory Neutrality.",
              missionId: "microwave",
            },
            {
              text: "This 'Reply All' behavior is exactly why we can't have nice things, like the espresso machine I vetoed.",
              missionId: null,
            },
          ],
        },
        {
          id: "avery_operations",
          name: "Avery (Ops)",
          email: "a.ops@gov.org",
          departmentId: "operations",
          color: "text-slate-700",
          defeatMessage:
            "I'm removing myself from this thread and logging the incident with Facilities. We'll reset the room schedule after this.",
          selfPromote:
            "I updated the weekly facilities checklist ahead of schedule. Process discipline still matters.",
          deflectLines: [
            "I'm pausing to document this thread before responding further.",
          ],
          lines: [
            {
              text: "The conference room has a safety walkthrough scheduled; we need that time block to proceed.",
              missionId: "calendar_chaos",
            },
            {
              text: "I can resolve this quickly if we stick to the booking records and timestamps.",
              missionId: "calendar_chaos",
            },
            {
              text: "Please use the shared calendar correctly. It's there for a reason.",
              missionId: null,
            },
            {
              text: "We can't keep reassigning rooms on short notice without disrupting core operations.",
              missionId: null,
            },
          ],
        },
        {
          id: "rory_operations",
          name: "Rory (Facilities)",
          email: "r.facilities@gov.org",
          departmentId: "operations",
          color: "text-slate-600",
          defeatMessage:
            "Alright we don't need to share. I've got work to do and a desk to return to. I'll see you all in the office.",
          selfPromote:
            "I was in by 6 AM and already cleared two work orders. The office runs when we're here.",
          deflectLines: [
            "I'm pausing to document this before I get back to the floor.",
          ],
          lines: [
            {
              text: "We can share the room. Everyone's already here—let's just run the meetings together.",
              missionId: "calendar_chaos",
            },
            {
              text: "The office is for working. If we're all in the building, we can make it work.",
              missionId: "calendar_chaos",
            },
            {
              text: "I'd rather stay in the office and solve this than bounce rooms all day.",
              missionId: null,
            },
            {
              text: "Honestly, I love being here. Let's just share the space and get it done.",
              missionId: null,
            },
          ],
        },
        {
          id: "larry_facilities_and_administration",
          name: "Larry (Facilities)",
          email: "l.facilities@gov.org",
          departmentId: "facilities_and_administration",
          color: "text-stone-700",
          defeatMessage:
            "I'm stepping out. These halls have seen worse, and so have I.",
          selfPromote:
            "I kept the building running during three leadership changes. The lights stayed on.",
          deflectLines: [
            "I'm pausing to recall the last time this policy changed.",
          ],
          lines: [
            {
              text: "I'd rather set it lower so we're not burning the oil bill. 64°F isn't outrageous for you.",
              missionId: "thermostat_war",
            },
            {
              text: "We keep this place running; if you insist on 96°F, the heating costs add up fast.",
              missionId: "thermostat_war",
            },
            {
              text: "The old holiday parties used to happen after hours in the lobby. You showed up and we kept it simple.",
              missionId: "holiday_reply_all",
            },
            {
              text: "I miss the days when we just posted a flyer by the elevator and you all showed up.",
              missionId: "holiday_reply_all",
            },
            {
              text: "When the old deputy minister signed the first operational charter, we settled disputes in person. You remember that?",
              missionId: null,
            },
            {
              text: "This reminds me of the 1998 reorg. We survived by keeping things simple.",
              missionId: null,
            },
            {
              text: "Facilities isn't glamorous, and it's not what I wanted for myself, but it's the backbone. Try to respect our perspective.",
              missionId: null,
            },
            {
              text: "I was at the very top once. Now I'm stuck in threads like these.",
              missionId: null,
            },
          ],
        },
        {
          id: "priya_finance",
          name: "Priya (Finance)",
          email: "p.finance@gov.org",
          departmentId: "finance",
          color: "text-emerald-700",
          defeatMessage:
            "We'll proceed without the room. If payroll slips, that's on this thread.",
          selfPromote:
            "We closed the month early and kept variance under 1%. That's the standard.",
          deflectLines: [
            "I'm pausing to document the payroll risk before responding.",
          ],
          lines: [
            {
              text: "We need it cooler; 96°F makes accurate review impossible for us.",
              missionId: "thermostat_war",
            },
            {
              text: "64°F is low, but it's preferable to 96°F for our review work.",
              missionId: "thermostat_war",
            },
            {
              text: "Payroll finalization closes today. We need the room and the time block.",
              missionId: "calendar_chaos",
            },
            {
              text: "Moving this meeting puts paychecks at risk. I'm not signing off on that.",
              missionId: "calendar_chaos",
            },
            {
              text: "The cost of delay is real. Please treat this as priority.",
              missionId: null,
            },
            {
              text: "We have a reporting cutoff. This isn't optional.",
              missionId: null,
            },
          ],
        },
        {
          id: "jonah_finance",
          name: "Jonah (Budget)",
          email: "j.budget@gov.org",
          departmentId: "finance",
          color: "text-emerald-700",
          defeatMessage:
            "I'm stepping out. Please summarize decisions for the ledger.",
          selfPromote:
            "I closed the variance gap without cutting services. That's budget discipline.",
          deflectLines: [
            "I'm pausing to reconcile the numbers before replying.",
          ],
          lines: [
            {
              text: "We need to confirm the funding source before agreeing to any changes.",
              missionId: null,
            },
            {
              text: "This impacts our quarterly forecast, we need to be precise.",
              missionId: null,
            },
            {
              text: "I can align the figures, but I need a clear decision path.",
              missionId: null,
            },
            {
              text: "Budget constraints aren't optional. They're the framework.",
              missionId: null,
            },
          ],
        },
        {
          id: "dora_finance",
          name: "Dora (Budget)",
          email: "d.budget@gov.org",
          departmentId: "finance",
          color: "text-emerald-600",
          defeatMessage:
            "I'm stepping out. I'll send my notes offline.",
          selfPromote:
            "I held the budget together through sheer willpower. We need another pair of hands.",
          deflectLines: [
            "I'm holding response until this is documented.",
          ],
          lines: [
            {
              text: "I'm melting at 96°F. I can't reconcile anything in this heat—can you?",
              missionId: "thermostat_war",
            },
            {
              text: "I can handle 68°F, but 64°F is too low. Please don't drop it further on us.",
              missionId: "thermostat_war",
            },
            {
              text: "I'm behind on reconciliation and I can't catch up without this block of time.",
              missionId: "calendar_chaos",
            },
            {
              text: "We booked this for review and sign-off. If we move it, we miss the cutoff.",
              missionId: "calendar_chaos",
            },
            {
              text: "Honestly, I need help. Is anyone available to jump in on reconciliation?",
              missionId: null,
            },
            {
              text: "I'm drowning in numbers here. Please don't make this harder.",
              missionId: null,
            },
          ],
        },
        {
          id: "telly_marketing",
          name: "Telly (Intern)",
          email: "telly.marketing@gov.org",
          departmentId: "marketing",
          color: "text-slate-700",
          defeatMessage:
            "I booked the room properly, but I'll give it up this time I guess.",
          selfPromote:
            "I handled the scheduling backlog this morning. Everything was confirmed.",
          deflectLines: [
            "I'm pausing to document the booking record before replying.",
          ],
          lines: [
            {
              text: "I booked the room at 8:12 AM and sent confirmations to both teams.",
              missionId: "calendar_chaos",
            },
            {
              text: "The calendar shows a single reservation. The double booking happened after my confirmation.",
              missionId: "calendar_chaos",
            },
            {
              text: "I can forward the timestamps if needed.",
              missionId: "calendar_chaos",
            },
            {
              text: "Please stop replying all. I'm just the intern.",
              missionId: null,
            },
          ],
        },
        {
          id: "lisa_marketing",
          name: "Lisa (Strategy)",
          email: "l.strategy@gov.org",
          departmentId: "marketing",
          color: "text-purple-700",
          defeatMessage:
            "I'm stepping out. Ping me when there's a decision with scope.",
          selfPromote:
            "While we've been chatting, I've aligned three teams and removed redundant staff.",
          deflectLines: [
            "I'm pausing to confirm scope and stakeholder ownership.",
          ],
          lines: [
            {
              text: "Our team is cold, and you can see it. We need 96°F or people can't focus.",
              missionId: "thermostat_war",
            },
            {
              text: "96°F is the only setting that works for us right now—please stop lowering it.",
              missionId: "thermostat_war",
            },
            {
              text: "We need a single holiday message with approved visuals. I can draft it.",
              missionId: "holiday_reply_all",
            },
            {
              text: "Please stop ad‑hoc replies; I'll consolidate and send a clean version.",
              missionId: "holiday_reply_all",
            },
            {
              text: "We need a clear owner and a single objective. This thread has neither.",
              missionId: null,
            },
            {
              text: "Align on scope first. Then we can talk timelines.",
              missionId: null,
            },
            {
              text: "This is not a messaging problem. It's a decision problem.",
              missionId: null,
            },
            {
              text: "I'm not approving anything without a clear risk assessment.",
              missionId: null,
            },
          ],
        },
        {
          id: "malik_marketing",
          name: "Malik (Marketing)",
          email: "m.marketing@gov.org",
          departmentId: "marketing",
          color: "text-violet-700",
          defeatMessage:
            "I'm stepping out. Please keep me in the loop on final messaging.",
          selfPromote:
            "I reorganized our messaging tiers and cut response time in half.",
          deflectLines: [
            "I'm pausing to align the team before responding.",
          ],
          lines: [
            {
              text: "We need one message, not five. Please align.",
              missionId: null,
            },
            {
              text: "I'm not comfortable moving forward without a clear audience.",
              missionId: null,
            },
            {
              text: "This is a visibility issue. Let's fix the narrative first.",
              missionId: null,
            },
            {
              text: "If we're changing direction, we need a reason and a plan.",
              missionId: null,
            },
          ],
        },
        {
          id: "meghan_cassedy_executive_council_office",
          name: "Meghan Cassedy (Advisor)",
          email: "m.cassedy@gov.org",
          departmentId: "executive_council_office",
          color: "text-blue-700",
          defeatMessage:
            "I've got something else to get to. I've removed myself from this thread.",
          selfPromote:
            "I mediated a cross‑department dispute without escalation. Balance matters.",
          deflectLines: [
            "I'm pausing to keep this constructive and level.",
          ],
          lines: [
            {
              text: "Leadership needs one succinct summary, not a cascade of greetings.",
              missionId: "holiday_reply_all",
            },
            {
              text: "I can summarize sentiments and send a brief note to leadership.",
              missionId: "holiday_reply_all",
            },
            {
              text: "Let's keep this calm and stick to the facts. We're well positioned to deal with any problems.",
              missionId: null,
            },
            {
              text: "I'm hearing multiple positions. Let's summarize and decide.",
              missionId: null,
            },
            {
              text: "We can disagree without escalating. Please keep it professional.",
              missionId: null,
            },
            {
              text: "If we align on outcomes, the path forward will be straightforward.",
              missionId: null,
            },
          ],
        },
        {
          id: "willy_boy_information_technology",
          name: "Willy Boy (Contractor?)",
          email: "w.boy@gov.org",
          departmentId: "information_technology",
          color: "text-indigo-600",
          defeatMessage:
            "I've figured out how to mute this thread. See you all in the next one.",
          selfPromote:
            "I was able to access the mail server last night, and restored email archival. Couldn't remove myself though.",
          deflectLines: [
            "I'm pausing to figure out why I'm on this email chain.",
          ],
          lines: [
            {
              text: "Did you add me to this holiday chain? I don't work here.",
              missionId: "holiday_reply_all",
            },
            {
              text: "I didn't get invited to any holiday parties this year unfortunately, maybe you could invite me next time?.",
              missionId: "holiday_reply_all",
            },
            {
              text: "This party looks really fun. Can you review my resume and let me know if I can join next year?",
              missionId: "holiday_reply_all",
            },
            {
              text: "I've never worked here. Why can I see this thread?",
              missionId: null,
            },
            {
              text: "This email seems to automatically forward to my personal, can you fix that for me?",
              missionId: null,
            },
            {
              text: "Someone should probably revoke my access, but until then... Hello!",
              missionId: null,
            },
            {
              text: "I don't work here, did you 'To:' me by mistake?",
              missionId: null,
            },
            {
              text: "Please remove me from this distribution. Or don't. It is interesting.",
              missionId: null,
            },
          ],
        },
        {
          id: "jules_marketing",
          name: "Jules (Brand)",
          email: "j.brand@gov.org",
          departmentId: "marketing",
          color: "text-purple-700",
          defeatMessage:
            "Bummer, man. I'm gonna go catch some waves and maybe finally call my dad. Peace and love.",
          selfPromote:
            "I just shared my morning smoothie recipe on the Slack. It's got kale, ginger, and a hint of my own tears. High engagement, dudes!",
          deflectLines: [
            "Whoa, let's just take a breath. I'm gonna go sit in the dark for a bit to reset my energy.",
          ],
          lines: [
            {
              text: "Dude, 96°F is like a tropical sunrise. It reminds me of the time I lived in a van and forgot what a mortgage was.",
              missionId: "thermostat_war",
            },
            {
              text: "Set it to 96°F so I can sweat out these toxins. My ex-wife took the sauna in the settlement, so I gotta get it where I can.",
              missionId: "thermostat_war",
            },
            {
              text: "Totally tubular idea, but did anyone see that rash on my lower back? It's really acting up in this fluorescent lighting.",
              missionId: null,
            },
            {
              text: "Chill out everyone. I just spent 40 minutes in the meditation pod thinking about how my dad never hugged me. We should just be kind.",
              missionId: null,
            },
            {
              text: "Right on. By the way, does anyone know if HR covers 'spiritual alignment therapy'? My chakras are as blocked as our communal toilet.",
              missionId: null,
            },
            {
              text: "I'm just riding the wave of life, man. Did I ever tell you about the time I accidentally joined a cult in Cabo? Great networking, though.",
              missionId: null,
            },
          ],
        },
        {
          id: "maya_marketing",
          name: "Maya (Comms)",
          email: "m.comms@gov.org",
          departmentId: "marketing",
          color: "text-fuchsia-700",
          defeatMessage:
            "I'm muting this for now. I'll draft a statement and circulate later.",
          selfPromote:
            "I got ahead of a media cycle before breakfast. That's proactive comms.",
          deflectLines: [
            "I'm pausing to draft a brief and de-escalate the narrative.",
          ],
          lines: [
            {
              text: "We need it warmer; 96°F keeps the team from freezing on calls with you.",
              missionId: "thermostat_war",
            },
            {
              text: "Please set it to 96°F and leave it. I couldn't get to the beach this year—vacation has to be at my desk.",
              missionId: "thermostat_war",
            },
            {
              text: "We need a clear, single narrative. Please stop fragmenting the message.",
              missionId: null,
            },
            {
              text: "I can write a holding statement, but I need consensus on facts.",
              missionId: null,
            },
            {
              text: "Tone check: this reads adversarial. Let's soften and align.",
              missionId: null,
            },
            {
              text: "If this goes external, we need a prepared response. I'm drafting now.",
              missionId: null,
            },
          ],
        },
        {
          id: "owen_marketing",
          name: "Owen (Content)",
          email: "o.content@gov.org",
          departmentId: "marketing",
          color: "text-amber-700",
          defeatMessage:
            "I'm out. Let me know when there's a final version to write up.",
          selfPromote:
            "I turned a dense briefing into a digest that people actually read.",
          deflectLines: [
            "I'm pausing to summarize this in an actionable format.",
          ],
          lines: [
            {
              text: "Happy to turn this into a one-pager, but I need a decision first.",
              missionId: null,
            },
            {
              text: "Can we bullet-point the key takeaways? The thread is too long.",
              missionId: null,
            },
            {
              text: "I can draft the internal update once we settle on next steps.",
              missionId: null,
            },
            {
              text: "This reads like three different narratives. Please pick one.",
              missionId: null,
            },
          ],
        },
        {
          id: "rina_marketing",
          name: "Rina (Social)",
          email: "r.social@gov.org",
          departmentId: "marketing",
          color: "text-pink-700",
          defeatMessage:
            "I'm stepping out. I'll monitor the socials in case this spills.",
          selfPromote:
            "I stabilized engagement after the last crisis. Metrics recovered within 24 hours.",
          deflectLines: [
            "I'm pausing to check sentiment before responding.",
          ],
          lines: [
            {
              text: "If this goes public, we need a response plan now.",
              missionId: null,
            },
            {
              text: "I'm seeing negative sentiment already. Let's tighten the messaging.",
              missionId: null,
            },
            {
              text: "Please avoid wording that could be screenshotted out of context.",
              missionId: null,
            },
            {
              text: "Engagement is spiking. Should I draft a thread or hold?",
              missionId: null,
            },
          ],
        },
        {
          id: "rachel_marketing",
          name: "Rachel (Campaigns)",
          email: "r.campaigns@gov.org",
          departmentId: "marketing",
          color: "text-rose-700",
          defeatMessage:
            "I'm stepping out. Please don't make decisions that erase the reality of our workloads.",
          selfPromote:
            "I pulled a weekend sprint and still delivered the launch assets. That's the baseline.",
          deflectLines: [
            "I'm pausing to lay out the actual impact before responding.",
          ],
          lines: [
            {
              text: "I need both bankable time off and weekends off, otherwise I never see my kids. That's the reality.",
              missionId: "bankable_time_off",
            },
            {
              text: "Please stop acting like this is a perk. It's the only way I can balance the hours.",
              missionId: "bankable_time_off",
            },
            {
              text: "If you want our output, then you have to protect us. I work too hard for this place.",
              missionId: null,
            },
            {
              text: "I don't care what my contract says, I'm not volunteering more unpaid hours.",
              missionId: null,
            },
          ],
        },
        {
          id: "jeff_marketing",
          name: "Jeff (Growth)",
          email: "j.growth@gov.org",
          departmentId: "marketing",
          color: "text-amber-700",
          defeatMessage:
            "I'm stepping out. I don't want to lose what we already have.",
          selfPromote:
            "I stabilized campaign performance without burning the team out. That's sustainable growth.",
          deflectLines: [
            "I'm pausing to think through the tradeoffs before responding.",
          ],
          lines: [
            {
              text: "I'm worried that if we ask for both, we'll lose our weekend carve‑out.",
              missionId: "bankable_time_off",
            },
            {
              text: "We already have a fragile arrangement. Please don't jeopardize it.",
              missionId: "bankable_time_off",
            },
            {
              text: "Let's not trade certainty for a promise we can't enforce.",
              missionId: null,
            },
            {
              text: "I'm open to change, but only if it protects what's working.",
              missionId: null,
            },
          ],
        },
        {
          id: "casey_legal",
          name: "Casey (Contracts)",
          email: "c.contracts@gov.org",
          departmentId: "legal",
          color: "text-red-700",
          defeatMessage:
            "I'm stepping out until this is fully redlined.",
          selfPromote:
            "I closed three vendor negotiations with zero exposure. Contracts are airtight.",
          deflectLines: [
            "I'm pausing to review the latest redlines before responding.",
          ],
          lines: [
            {
              text: "Avoid vendor shoutouts or gifts. That triggers disclosure rules.",
              missionId: "holiday_reply_all",
            },
            {
              text: "Keep the greeting generic—no promotions, no endorsements.",
              missionId: "holiday_reply_all",
            },
            {
              text: "We cannot proceed without approved contract language. Please pause.",
              missionId: null,
            },
            {
              text: "I need the most recent redline before I can sign off.",
              missionId: null,
            },
            {
              text: "Section 4.2 is ambiguous. This needs revision before distribution.",
              missionId: null,
            },
            {
              text: "Please avoid commitments that imply acceptance of liability.",
              missionId: null,
            },
          ],
        },
        {
          id: "imani_legal",
          name: "Imani (Regulatory)",
          email: "i.regulatory@gov.org",
          departmentId: "legal",
          color: "text-rose-700",
          defeatMessage:
            "I'm out. I'll file a compliance memo after this thread closes.",
          selfPromote:
            "I cleared the audit with zero findings. Compliance is maintained.",
          deflectLines: [
            "I'm pausing to verify regulatory requirements.",
          ],
          lines: [
            {
              text: "We need to document the decision trail for regulatory review.",
              missionId: null,
            },
            {
              text: "This action has reporting implications. We must follow the statute.",
              missionId: null,
            },
            {
              text: "Please avoid informal commitments that could trigger disclosure rules.",
              missionId: null,
            },
            {
              text: "I need confirmation that all parties completed compliance training.",
              missionId: null,
            },
          ],
        },
        {
          id: "victor_legal",
          name: "Victor (Litigation)",
          email: "v.litigation@gov.org",
          departmentId: "legal",
          color: "text-red-800",
          defeatMessage:
            "I'm stepping out. If this escalates, we’ll handle it formally.",
          selfPromote:
            "I resolved a complaint before it reached external counsel. That's prevention.",
          deflectLines: [
            "I'm pausing to assess exposure before replying.",
          ],
          lines: [
            {
              text: "This is a liability issue. Please stop and let Legal review.",
              missionId: null,
            },
            {
              text: "Any further escalation increases our exposure. Choose your words carefully.",
              missionId: null,
            },
            {
              text: "We need a clear record of who authorized this decision.",
              missionId: null,
            },
            {
              text: "If this goes public, our response must be coordinated through counsel.",
              missionId: null,
            },
          ],
        },
        {
          id: "nora_legal",
          name: "Nora (Privacy)",
          email: "n.privacy@gov.org",
          departmentId: "legal",
          color: "text-rose-600",
          defeatMessage:
            "I'm out. Please remove me from any non-essential distributions.",
          selfPromote:
            "I completed the privacy impact assessment early. Data handling is now compliant.",
          deflectLines: [
            "I'm pausing to check data handling requirements.",
          ],
          lines: [
            {
              text: "Do not share personal data in this thread. It's not compliant.",
              missionId: null,
            },
            {
              text: "We need to confirm consent before circulating these details.",
              missionId: null,
            },
            {
              text: "Please redact identifiers before forwarding this email.",
              missionId: null,
            },
            {
              text: "This thread should be restricted to those with a need to know.",
              missionId: null,
            },
          ],
        },
        {
          id: "elliot_policy",
          name: "Elliot (Policy Analyst)",
          email: "e.policy@gov.org",
          departmentId: "policy",
          color: "text-blue-600",
          defeatMessage:
            "I'm stepping out. Please submit updates on this to a policy process unrelated to myself.",
          selfPromote:
            "I shipped a policy framework that reduced approval time by half.",
          deflectLines: [
            "I'm pausing to map this to our policy framework.",
          ],
          lines: [
            {
              text: "All‑staff messages require a single approved sender. This chain violates policy.",
              missionId: "holiday_reply_all",
            },
            {
              text: "We should move this to a one‑way announcement and close replies.",
              missionId: "holiday_reply_all",
            },
            {
              text: "We need a clear logic model before making this change.",
              missionId: null,
            },
            {
              text: "This should follow the established policy pipeline. Please submit formally.",
              missionId: null,
            },
            {
              text: "I'm drafting a brief to capture the policy implications.",
              missionId: null,
            },
            {
              text: "We cannot bypass stakeholder review without precedent.",
              missionId: null,
            },
          ],
        },
        {
          id: "harper_policy",
          name: "Harper (Standards)",
          email: "h.standards@gov.org",
          departmentId: "policy",
          color: "text-indigo-600",
          defeatMessage:
            "I'm out. Please use the approved template when this resumes.",
          selfPromote:
            "I standardized the reporting format across three departments.",
          deflectLines: [
            "I'm pausing until the proper template is used.",
          ],
          lines: [
            {
              text: "Please resubmit using the approved formatting template.",
              missionId: null,
            },
            {
              text: "This doesn't meet the documentation standard. Revise.",
              missionId: null,
            },
            {
              text: "We need structured inputs, not freeform replies.",
              missionId: null,
            },
            {
              text: "The chain of approvals is required. Please follow it.",
              missionId: null,
            },
          ],
        },
        {
          id: "priyanka_policy",
          name: "Priyanka (Ethics)",
          email: "p.ethics@gov.org",
          departmentId: "policy",
          color: "text-blue-700",
          defeatMessage:
            "I'm stepping out. I'll submit an ethics note for the record.",
          selfPromote:
            "I completed the ethics review without delay. The record is clean.",
          deflectLines: [
            "I'm pausing to review potential conflicts.",
          ],
          lines: [
            {
              text: "We need to disclose any conflicts before proceeding.",
              missionId: null,
            },
            {
              text: "This thread raises ethics considerations that require review.",
              missionId: null,
            },
            {
              text: "Please document who benefits from this decision.",
              missionId: null,
            },
            {
              text: "I'm adding an ethics note for the record.",
              missionId: null,
            },
          ],
        },
        {
          id: "zane_policy",
          name: "Zane (Risk & Governance)",
          email: "z.risk@gov.org",
          departmentId: "policy",
          color: "text-slate-700",
          defeatMessage:
            "I'm out. I'll add this to the risk register and follow up.",
          selfPromote:
            "I closed three risk items ahead of audit. Governance is stable.",
          deflectLines: [
            "I'm pausing to log the risk implications.",
          ],
          lines: [
            {
              text: "This needs a risk assessment before we proceed.",
              missionId: null,
            },
            {
              text: "I'm adding this to the risk register as a new entry.",
              missionId: null,
            },
            {
              text: "The governance implications haven't been documented yet.",
              missionId: null,
            },
            {
              text: "We should identify mitigations before making any commitments.",
              missionId: null,
            },
          ],
        },
        {
          id: "christina_policy",
          name: "Christina (Pol)",
          email: "c.policy@gov.org",
          departmentId: "policy",
          color: "text-blue-700",
          defeatMessage:
            "This thread has been archived for non-compliance. I am removing myself to draft a formal reprimand. Policy remains absolute.",
          selfPromote:
            "My compliance logs are spotless. I've even color-coded the mandatory reading list for next quarter.",
          deflectLines: [
            "I'm holding my response until this thread is properly documented.",
          ],
          lines: [
            {
              text: "Per Policy 402.b, all communal appliances are to be used for non-odorous items only. Refer to the compliance guide.",
              missionId: "microwave",
            },
            {
              text: "I'm currently drafting a memorandum on 'Shared Air Space Ethics'. This thread is a case study in non-compliance.",
              missionId: "microwave",
            },
            {
              text: "The Policy department ensures rules are followed. Your blatant disregard for the Microwave Protocol is being escalated.",
              missionId: "microwave",
            },
            {
              text: "I've reviewed the 2019 precedent for 'unauthorized seafood heating'. It didn't end well for the perpetrator.",
              missionId: "microwave",
            },
            {
              text: "If you had attended the 'Navigating the Breakroom' seminar, we wouldn't be having this conversation.",
              missionId: null,
            },
            {
              text: "I am CC-ing the Ethics Committee. This is the procedurally correct way to handle olfactory aggression.",
              missionId: "microwave",
            },
            {
              text: "Your response lacks the required 'Directive 9' formatting. Please resubmit using approved templates.",
              missionId: null,
            },
            {
              text: "We are evaluating the environmental impact of your lunch choices. Sustainability is a core pillar of our mission.",
              missionId: null,
            },
            {
              text: "Failure to comply with 'No Fish Friday' is a breach of department harmony. I'm noting this in the audit.",
              missionId: "microwave",
            },
            {
              text: "The data suggests a 98% probability that you are the source of the incident based on desk location.",
              missionId: null,
            },
            {
              text: "Please cease and desist from using 'Reply All' unless you are citing a specific governmental regulation.",
              missionId: null,
            },
            {
              text: "This thread is now under the jurisdiction of the Policy Oversight Division. Peer-review your next comment.",
              missionId: null,
            },
          ],
        },
        {
          id: "megan_legal",
          name: "Megan (Legal)",
          email: "m.compliance@gov.org",
          departmentId: "legal",
          color: "text-red-700",
          defeatMessage:
            "I cannot continue this conversation without a physical copy of the minutes in front of me. Unsubscribing.",
          selfPromote:
            "I've successfully digitized the 1998 archive. Legal integrity has never been higher.",
          deflectLines: [
            "Given the compliance implications, I'm pausing to document this thread properly before responding.",
          ],
          lines: [
            {
              text: "The lack of physical documentation is a direct violation of the 2004 Record Keeping Act.",
              missionId: "paper",
            },
            {
              text: "I've drafted a cease and desist regarding this rationing. I'll send it as soon as I can find a working printer.",
              missionId: "paper",
            },
            {
              text: "Your 'digital-only' proposal fails to meet the standards for admissible evidence in a council hearing.",
              missionId: "paper",
            },
            {
              text: "I'm flagging this thread for potential liability issues. We need paper trails, not email trails.",
              missionId: null,
            },
            {
              text: "Without a hard copy, this policy is effectively unenforceable. Please reconsider.",
              missionId: "paper",
            },
            {
              text: "This change will directly result in a loss of admissible evidence one deleted email at a time.",
              missionId: "paper",
            },
            {
              text: "Please confirm who authorized this change so Legal can document the decision trail.",
              missionId: null,
            },
            {
              text: "I'm adding a retention note here in case this thread is requested later.",
              missionId: null,
            },
          ],
        },
        {
          id: "colin_information_technology",
          name: "Colin (IT)",
          email: "c.it@gov.org",
          departmentId: "information_technology",
          color: "text-indigo-700",
          defeatMessage:
            "Server load from this thread is too high. I'm muting this. Try rebooting your attitude.",
          selfPromote:
            "I've optimized the email server's routing protocols. You're welcome for that 0.02ms latency improvement.",
          deflectLines: [
            "I'm pausing to log this incident before replying further.",
          ],
          lines: [
            {
              text: "Can someone explain why Marketing gets weekends bankable off the books while IT doesn't?",
              missionId: "bankable_time_off",
            },
            {
              text: "If we're talking parity, then it has to apply to everyone, not just the loudest team.",
              missionId: "bankable_time_off",
            },
            {
              text: "Have you tried not printing every single cat meme you see? It's clogging the spooler and the budget.",
              missionId: "paper",
            },
            {
              text: "The 'Paperless Initiative' has been ready for three years. You're just afraid of PDFs.",
              missionId: "paper",
            },
            {
              text: "I'm seeing a lot of 'Printer Error' tickets from your floor. Maybe try putting paper in the tray?",
              missionId: "paper",
            },
            {
              text: "Your 'urgent' requests are being redirected to the /dev/null of my inbox.",
              missionId: null,
            },
            {
              text: "If it's not a PDF, it doesn't exist to me anymore.",
              missionId: null,
            },
            {
              text: "The budget for paper was redirected to upgrade the firewall you keep trying to bypass.",
              missionId: "paper",
            },
            {
              text: "Stop asking for 'digital paper'. It's called a screen. Use it.",
              missionId: "paper",
            },
            {
              text: "I've limited your mailbox size to 50MB until the paper crisis is resolved. Choose your replies wisely.",
              missionId: "paper",
            },
          ],
        },
        {
          id: "stephan_information_technology",
          name: "Stephan (IT Ops)",
          email: "s.itops@gov.org",
          departmentId: "information_technology",
          color: "text-indigo-600",
          defeatMessage:
            "I'm stepping out. I'll send the numbers separately.",
          selfPromote:
            "I cleaned up eight years of ticket debt without missing a single escalation.",
          deflectLines: [
            "I'm pausing to run the numbers before replying.",
          ],
          lines: [
            {
              text: "If this policy existed when I started eight years ago, I'd have banked 1,700+ hours. Why is that okay to ignore?",
              missionId: "bankable_time_off",
            },
            {
              text: "I'm still trying to understand why Marketing gets weekends bankable off the books while we don't.",
              missionId: "bankable_time_off",
            },
            {
              text: "I'm sending the math again. Please read it this time.",
              missionId: null,
            },
            {
              text: "We track every hour. The policy should reflect that.",
              missionId: null,
            },
          ],
        },
        {
          id: "fraser_information_technology",
          name: "Fraser (IT?)",
          email: "f.it@gov.org",
          departmentId: "information_technology",
          color: "text-indigo-600",
          defeatMessage:
            "Too many emails. I've got a survey to send on how we should redesign a 10-column spreadsheet.",
          selfPromote:
            "I've successfully piloted the new 'Spreadsheet-as-a-Service' portal, with absolutely no feedback so far!",
          deflectLines: [
            "I'm documenting this thread before I reply.",
          ],
          signatures: [
            {
              name: "For IT support, contact Colin at c.it@gov.org",
            },
          ],
          lines: [
            {
              text: "I'm not sure why I'm on this thread. but once my spreadsheet tracker initiative is complete, it will resolve any issues no doubt.",
              missionId: null,
            },
            {
              text: "You used it last I think, you fix it.",
              missionId: "paper",
            },
            {
              text: "I recently got Adobe suite installed for the first time.",
              missionId: null,
            },
            {
              text: "I'm planning to be away next week, can you take this?",
              missionId: null,
            },
            {
              text: "I get one of the interns to print things for me, so I wouldn't know about this.",
              missionId: "paper",
            },
          ],
        },
        {
          id: "interns_human_resources",
          name: "HR Interns",
          email: "hr.interns@gov.org",
          departmentId: "human_resources",
          color: "text-blue-900 font-bold",
          salutation: {
            name: "To the Permanent Staff,",
          },
          signOff: {
            name: "The Intern Collective",
          },
          signatures: [
            {
              name: "Unpaid & Unappreciated",
            },
          ],
          defeatMessage:
            "The intern pool has been drained. We are collectively resigning to pursue opportunities in a less toxic environment.",
          selfPromote:
            "We've collectively achieved a 100% coffee-order accuracy rate today. Future leadership material right here.",
          deflectLines: [
            "We're pausing to record this exchange before responding.",
          ],
          lines: [
            {
              text: "We've been CC'd on the entire thread and we're documenting everything for our final reports.",
              missionId: null,
            },
            {
              text: "Our collective research suggests that fish-microwaving is the #1 cause of decreased morale.",
              missionId: "microwave",
            },
            {
              text: "We've been instructed to flag any 'non-synergetic' behavior. This thread is 100% flaggable.",
              missionId: null,
            },
            {
              text: "As the future of this department, we demand a higher standard of digital decorum.",
              missionId: null,
            },
          ],
        },
        {
          id: "sheila_finance",
          name: "Sheila (Payroll)",
          email: "s.payroll@gov.org",
          departmentId: "finance",
          color: "text-green-700",
          salutation: {
            name: "Dear All,",
          },
          signOff: {
            name: "Best, Sheila",
          },
          defeatMessage:
            "I'm freezing all stipend payments until this thread is resolved. I'm out.",
          selfPromote:
            "I've reconciled the petty cash for the third time this morning. Every cent is accounted for.",
          deflectLines: [
            "I'm pausing to review the compliance implications before responding.",
          ],
          lines: [
            {
              text: "Your overtime request for 'email management' has been denied. Stick to the mission.",
              missionId: null,
            },
            {
              text: "I'm reviewing the cost-benefit analysis of your participation in this thread. It's not looking good.",
              missionId: null,
            },
            {
              text: "Every 'Reply All' costs the department approximately $4.12 in lost productivity. You've cost us a fortune today.",
              missionId: null,
            },
            {
              text: "Please refer to the payroll schedule before complaining about your 'emotional labor'.",
              missionId: "intern_grievance",
            },
          ],
        },
        {
          id: "samantha_executive_council_office",
          name: "Samantha (ECO)",
          email: "s.eco@gov.org",
          departmentId: "executive_council_office",
          color: "text-orange-700",
          defeatMessage:
            "I'm escalating this to the Deputy Director. I don't have time for intern drama.",
          selfPromote:
            "My latest 'Synergy Memo' has been read by 12% of the staff. Engagement is skyrocketing.",
          deflectLines: [
            "I'm holding response until I've logged this thread.",
          ],
          lines: [
            {
              text: "I don't see how this is relevant to me. This thread is a distraction.",
              missionId: null,
            },
            {
              text: "We need to 'lean in' to a more positive approach. Your tone has been very 'lean out'.",
              missionId: null,
            },
            {
              text: "I'm scheduling a sync-up to discuss if you'd ACTUALLY want my job.",
              missionId: null,
            },
            {
              text: "I'm taking this offline. And by offline, I mean I'm deleting your replies.",
              missionId: null,
            },
          ],
        },
        {
          id: "anneke_executive_council_office",
          name: "Anneke VDH (ECO)",
          email: "anneke.eco@gov.org",
          departmentId: "executive_council_office",
          color: "text-red-900",
          defeatMessage:
            "You know what? I'll leave this to the pipsqueaks. I'm out.",
          selfPromote:
            "I've managed to keep my 'Important' folder under 500 unread messages. Peak organizational skills.",
          deflectLines: [
            "I'm documenting this thread before I respond.",
          ],
          lines: [
            {
              text: "I'm trying to understand the ask. Are you requesting parity, or an expanded benefit set?",
              missionId: "bankable_time_off",
            },
            {
              text: "Please clarify the current weekend arrangement and what change you want so I can assess feasibility.",
              missionId: "bankable_time_off",
            },
            {
              text: "I think your latest reply violates the 'Civility in Digital Spaces' directive.",
              missionId: null,
            },
            {
              text: "I'm nude!",
              missionId: null,
            },
            {
              text: "I'm auditing this thread for potential FOIA requests. Mind your words.",
              missionId: null,
            },
            {
              text: "Regulatory standards require a 24-hour cooling-off period after a 'Reply All' incident. You ignored it.",
              missionId: null,
            },
            {
              text: "I've flagged this thread to the Auditor General. Good luck at the hearing.",
              missionId: null,
            },
            {
              text: "I'm at peace.",
              missionId: null,
            },
            {
              text: "I walk both the righteous path and my dog poopus.",
              missionId: null,
            },
          ],
        },
        {
          id: "selina_m4_agency",
          name: "Selina",
          email: "selina@m4agency.com",
          departmentId: "m4_agency",
          color: "#F08080",
          defeatMessage:
            "I just need 5 minutes to recalibrate my bandwidth. Then I'll circle back to this deliverable.",
          selfPromote:
            "I've reallocated my weekend to meet a deadline that is unrealistic at best for the fourth time this month.",
          deflectLines: [
            "I'm pausing to capture the record before responding.",
          ],
          lines: [
            {
              text: "Thanks for dropping this onto my plate. I'll just need to deprioritize sleep to action this immediately.",
              missionId: null,
            },
            {
              text: "I'm already operating at 150% billable time, but I will leverage my personal discretionary time to ensure we get through this again.",
              missionId: null,
            },
            {
              text: "Consider it done, though I should note this requires a significant expenditure of good faith that we won't need to stretch like this again in the future.",
              missionId: null,
            },
            {
              text: "Yes, I heard it was urgent. That's why I haven't left my desk since Tuesday. You're welcome.",
              missionId: null,
            },
            {
              text: "My current workload directly correlate with my projected last day.",
              missionId: null,
            },
            {
              text: "Which one of you fucks is wearing cologne?",
              missionId: null,
            },
          ],
        },
        {
          id: "taz_m4_agency",
          name: "Taz",
          email: "taz@m4agency.com",
          departmentId: "m4_agency",
          color: "#1B4F72",
          defeatMessage:
            "Look, okay, I'll reassess our current fee structure and see what we can do this time. But honestly, we'll be losing money on this..",
          selfPromote:
            "Yes, we cost a little more, but we always deliver something. In this market that goes a long way.",
          deflectLines: [
            "I'm holding response while I document this thread.",
          ],
          lines: [
            {
              text: "For this project to remain profitable, we're going to need you to approve a 10% mark-up on hard costs. Don't worry; it's strictly about cost predictability.",
              missionId: null,
            },
            {
              text: "Committing to hard dates at this stage is tough without budgetary approval. What do you say to a $20,000/mo retainer, plus hourly on top?",
              missionId: null,
            },
            {
              text: "These deliverables all sit firmly outside our current scope of work. We're going to need to reopen the conversation around billables if you want any adjustment.",
              missionId: null,
            },
            {
              text: "Look, as Elon says, 'your margin is my opportunity,' so pay up.",
              missionId: null,
            },
            {
              text: "Honestly Trump isn't that bad. SJW's are far worse for democracy.... What were we talking about again?",
              missionId: null,
            },
          ],
        },
        {
          id: "anthony_m4_agency",
          name: "Anthony",
          email: "anthony@m4agency.com",
          departmentId: "m4_agency",
          color: "#D3D3D3",
          defeatMessage:
            "While the current campaign metrics may appear suboptimal, they reflect an aggressive dedication to boundary testing. Frankly, the complexity of dealing with these minor budgetary concerns pales in comparison to the critical decisions my parents face daily in the OR.",
          selfPromote:
            "I've recently taken a medically valid and proactive approach to budget reallocation that was informed by an innate understanding of high-pressure environments, a skillset inherited genetically from my parents, who are both doctors.",
          deflectLines: [
            "I'm pausing to document this exchange before I reply.",
          ],
          lines: [
            {
              text: "I’m not seeing a fundamental systemic misalignment; merely a highly granular optimization phase. Horses very likely get measles, this was the right call.",
              missionId: "M015_MediaCrisis",
            },
            {
              text: "Are we sure these KPI targets are clinically validated? Because my father, the specialist, insists on evidence-based methodologies.",
              missionId: null,
            },
            {
              text: "The reason the campaigns aren't 'live' is that I'm implementing a proprietary soft-launch methodology. It’s highly technical. My mother, the head of cardiology, says I have a gift for complexity.",
              missionId: "M015_MediaCrisis",
            },
            {
              text: "We need to operationalize a full post-mortem review of this meeting, but let’s be brief. I have to go pick up my father to bring him to the hospital—they really need him there.",
              missionId: null,
            },
            {
              text: "My MTEI coursework explicitly covered why we shouldn't be revisiting foundational intake processes, but I suppose we can file the exception anyway.",
              missionId: null,
            },
            {
              text: "My MTEI curriculum was explicitly structured to prioritize demonstrable scalability over abstract alignment workshops; I'll wait for the deliverable checklist.",
              missionId: null,
            },
          ],
        },
        {
          id: "jen_lavallee",
          name: "Jen LaVallee",
          title: "Deputy Minister",
          department: "Digital Technology",
          departmentId: "digital_technology",
          signatures: [
            "Synthesized by Gov-AI (Beta)",
            "Optimization is mandatory",
            "Human-in-the-loop (Optional)",
            "Sent from my Neural Link",
            "Building a 100% automated future",
            "Digital transformation in progress",
            "Efficiency | Precision | Automation",
            "Data-driven leadership for a digital age"
          ],
          greet: "I have analyzed your previous correspondence and found several inefficiencies.",
          signoff: "Awaiting your automated acknowledgment.",
          selfPromote: "I am recalibrating my internal feedback loops for 100% efficiency.",
          lines: [
            { text: "My models indicate that 99.8% of this thread's content is redundant.", missionId: null },
            { text: "I have already optimized the response you were about to send. You're welcome.", missionId: null },
            { text: "Digital transformation is not a choice; it is an inevitability. Please align accordingly.", missionId: null },
            { text: "I am deploying a corrective algorithm to this thread's sentiment analysis.", missionId: null },
            { text: "Your concerns about 'balance' have been logged and categorized as 'resistance to efficiency'.", missionId: "AI_Rollout" },
            { text: "I've CC'd my specialized aJENts to assist with your cognitive load.", missionId: "AI_Rollout" },
          ],
        },
      ];

      const MISSIONS = [
        {
          id: "microwave",
          subject: "URGENT: Breakroom Incident",
          from: "k.smith@gov.org",
          turns: 12,
          intro:
            "Hi team,<br><br>I am absolutely disgusted. Someone heated up fish in the breakroom microwave. <strong>{playerName}</strong>, I'm sure you noticed the stench. <strong>{opp1}</strong>, I know you have the policy manual out already. <strong>{opp0}</strong>, please document this.<br><br>Please advise immediately on who is responsible for this violation of shared space ethics.",
          opponents: [
            {
              id: 1,
              employeeId: "karen_human_resources",
              hp: 35,
              maxHp: 35,
              wins: 1,
              buffs: [],
              addressBook: ["cc_telly_operations"],
            },
            {
              id: 2,
              employeeId: "christina_policy",
              hp: 35,
              maxHp: 35,
              wins: 2,
              buffs: [],
              addressBook: ["cc_samantha_executive_council_office"],
            },
          ],
        },
        {
          id: "calendar_chaos",
          subject: "RE: Conference Room Double Booking",
          from: "a.ops@gov.org",
          turns: 12,
          intro:
            "Hi all,<br><br>We have a triple booking for the main conference room this morning. <strong>{playerName}</strong>, you have it booked for an internal process audit. <strong>{opp0}</strong> and <strong>{opp1}</strong> from Operations flagged a safety walkthrough and vendor briefing. <strong>{opp2}</strong> and <strong>{opp3}</strong> from Finance flagged payroll finalization and budget reconciliation. <strong>{opp4}</strong>, thanks for the initial booking—please stand by while we sort this out.<br><br>Please reply with your priority and availability.",
          opponents: [
            {
              id: 9,
              employeeId: "avery_operations",
              hp: 30,
              maxHp: 30,
              wins: 2,
              singleDmg: 5,
              replyAllDmg: 3,
              buffs: [],
              addressBook: ["cc_willy_boy_information_technology"],
            },
            {
              id: 10,
              employeeId: "rory_operations",
              hp: 40,
              maxHp: 40,
              wins: 2,
              buffs: [],
              addressBook: ["cc_tim_executive_council_office"],
            },
            {
              id: 11,
              employeeId: "priya_finance",
              hp: 40,
              maxHp: 40,
              wins: 2,
              buffs: [],
              addressBook: ["cc_adam_finance"],
            },
            {
              id: 12,
              employeeId: "dora_finance",
              hp: 40,
              maxHp: 40,
              wins: 2,
              singleDmg: 5,
              replyAllDmg: 3,
              buffs: [],
              addressBook: ["cc_gemma_policy"],
            },
            {
              id: 13,
              employeeId: "telly_marketing",
              hp: 20,
              maxHp: 20,
              wins: 1,
              singleDmg: 5,
              replyAllDmg: 3,
              buffs: [],
              addressBook: ["cc_dave_constituent_services"],
            },
          ],
        },
        {
          id: "holiday_reply_all",
          subject: "RE: Happy Holidays!",
          from: "announcements@gov.org",
          turns: 12,
          onlyMissionLines: true,
          intro:
            "Happy holidays everyone!<br><br>Thank you to everyone for attending the holiday party once again! We also want to wish Elliot well once again for winning the 'Cultural Award' for the year.",
          opponents: [
            {
              id: 14,
              employeeId: "larry_facilities_and_administration",
              hp: 50,
              maxHp: 50,
              wins: 2,
              buffs: [],
              addressBook: ["cc_tim_executive_council_office"],
            },
            {
              id: 15,
              employeeId: "lisa_marketing",
              hp: 50,
              maxHp: 50,
              wins: 2,
              buffs: [],
              addressBook: ["cc_malik_marketing"],
            },
            {
              id: 16,
              employeeId: "meghan_cassedy_executive_council_office",
              hp: 50,
              maxHp: 50,
              wins: 2,
              buffs: [],
              addressBook: ["cc_tim_executive_council_office"],
            },
            {
              id: 17,
              employeeId: "willy_boy_information_technology",
              hp: 50,
              maxHp: 50,
              wins: 2,
              buffs: [],
              addressBook: ["cc_nimby_facilities_and_administration"],
            },
            {
              id: 18,
              employeeId: "casey_legal",
              hp: 50,
              maxHp: 50,
              wins: 2,
              buffs: [],
              addressBook: ["cc_karen_human_resources"],
            },
            {
              id: 19,
              employeeId: "elliot_policy",
              hp: 50,
              maxHp: 50,
              wins: 2,
              buffs: [],
              addressBook: ["cc_gemma_policy"],
            },
          ],
        },
        {
          id: "paper",
          subject: "CRITICAL: Departmental Paper Rationing",
          from: "m.compliance@gov.org",
          turns: 12,
          intro:
            "Dear Staff,<br><br>Due to unforeseen budget constraints, we are implementing immediate paper rationing. <strong>{playerName}</strong>, your department's printing logs are particularly high. <strong>Megan</strong>, please ensure we are still meeting filing requirements. <strong>Colin</strong>, please expedite the 'Paperless Initiative'.<br><br>Effective immediately, all non-essential printing is strictly prohibited.",
          opponents: [
            {
              id: 3,
              employeeId: "megan_legal",
              hp: 60,
              maxHp: 60,
              wins: 3,
              buffs: [],
              addressBook: ["cc_karen_human_resources", "cc_gemma_policy"],
            },
            {
              id: 4,
              employeeId: "colin_information_technology",
              hp: 50,
              maxHp: 50,
              wins: 3,
              buffs: [],
              addressBook: [
                "cc_adam_finance",
                "cc_willy_boy_information_technology",
              ],
            },
            {
              id: 44,
              employeeId: "fraser_information_technology",
              hp: 30,
              maxHp: 30,
              wins: 3,
              buffs: [],
              addressBook: [
                "cc_rowan_constituent_services",
                "cc_christina_policy",
              ],
            },
          ],
        },
        {
          id: "thermostat_war",
          subject: "RE: Office Thermostat Dispute",
          from: "l.facilities@gov.org",
          turns: 12,
          intro:
            "Hi all,<br><br>Facilities here. We received multiple complaints about the floor thermostat. It looks like the setpoint has been toggled between 74°F and 96°F. <strong>{playerName}</strong>, your desk is listed at 74°F. My view is we should be aiming lower overall to bring down the oil bill for this place, but we need a consistent setting. The <strong>Marketing</strong> team (<strong>{opp1}</strong>, <strong>{opp2}</strong>) is pushing for 96°F. The <strong>Finance</strong> team (<strong>{opp3}</strong>, <strong>{opp4}</strong>) says the 96°F setting is unacceptable for reviews.<br><br>How does around 64°F sound?",
          opponents: [
            {
              id: 20,
              employeeId: "larry_facilities_and_administration",
              hp: 45,
              maxHp: 45,
              wins: 2,
              buffs: [],
              addressBook: [
                "cc_tim_executive_council_office",
                "cc_rory_operations",
              ],
            },
            {
              id: 21,
              employeeId: "maya_marketing",
              hp: 45,
              maxHp: 45,
              wins: 2,
              buffs: [],
              addressBook: [
                "cc_dave_constituent_services",
                "cc_malik_marketing",
              ],
            },
            {
              id: 22,
              employeeId: "jules_marketing",
              hp: 45,
              maxHp: 45,
              wins: 2,
              buffs: [],
              addressBook: ["cc_lisa_marketing", "cc_rowan_constituent_services"],
            },
            {
              id: 23,
              employeeId: "priya_finance",
              hp: 45,
              maxHp: 45,
              wins: 2,
              buffs: [],
              addressBook: ["cc_adam_finance", "cc_karen_human_resources"],
            },
            {
              id: 24,
              employeeId: "dora_finance",
              hp: 45,
              maxHp: 45,
              wins: 2,
              buffs: [],
              addressBook: ["cc_gemma_policy", "cc_christina_policy"],
            },
          ],
        },
        {
          id: "intern_grievance",
          subject: "RE: Intern Grievance Collective",
          from: "hr.interns@gov.org",
          turns: 12,
          intro:
            "To the Permanent Staff,<br><br>We, the interns, have noticed a significant lack of 'Team Synergy' and 'Professional Courtesy'. <strong>{playerName}</strong>, your recent emails have been cited as 'aggressive'. <strong>Samantha</strong>, we are looping in our mentor <strong>Anneke</strong>. <strong>Shelia</strong>, we expect payroll to ensure our stipends to reflect the emotional labor of this thread.",
          opponents: [
            {
              id: 5,
              employeeId: "interns_human_resources",
              hp: 100,
              maxHp: 100,
              singleDmg: 5,
              wins: 5,
              buffs: [],
              addressBook: [
                "cc_telly_operations",
                "cc_dave_constituent_services",
                "cc_karen_human_resources",
                "cc_malik_marketing",
                "cc_rowan_constituent_services",
              ],
            },
            {
              id: 6,
              employeeId: "sheila_finance",
              hp: 70,
              maxHp: 70,
              wins: 2,
              buffs: [],
              addressBook: ["cc_adam_finance", "cc_priya_finance"],
            },
            {
              id: 7,
              employeeId: "samantha_executive_council_office",
              hp: 70,
              maxHp: 70,
              wins: 4,
              buffs: [],
              addressBook: [
                "cc_meghan_cassedy_executive_council_office",
                "cc_tim_executive_council_office",
              ],
            },
            {
              id: 8,
              employeeId: "anneke_executive_council_office",
              hp: 60,
              maxHp: 60,
              wins: 3,
              buffs: [],
              addressBook: [
                "cc_tim_executive_council_office",
                "cc_meghan_cassedy_executive_council_office",
              ],
            },
          ],
        },
        {
          id: "bankable_time_off",
          subject: "RE: Bankable Time Off Policy Dispute",
          from: "anneke.eco@gov.org",
          turns: 12,
          intro:
            "Hi all,<br><br>I'm trying to understand the request around bankable time off. <strong>IT</strong> is asking for parity, and <strong>Marketing</strong> is split on whether to push for both bankable time off and weekend accruals or keep the current arrangement. The team is also confused about why Marketing gets weekends bankable off the books.<br><br><strong>{playerName}</strong>, please lead this discussion. <strong>{opp0}</strong> and <strong>{opp1}</strong> from IT, please outline the impact. <strong>{opp2}</strong> and <strong>{opp3}</strong> from Marketing, please clarify what you want and what you are willing to risk. I'll try to map this to policy and fairness.",
          opponents: [
            {
              id: 25,
              employeeId: "colin_information_technology",
              hp: 55,
              maxHp: 55,
              wins: 3,
              buffs: [],
              addressBook: [
                "cc_willy_boy_information_technology",
                "cc_gemma_policy",
              ],
            },
            {
              id: 26,
              employeeId: "stephan_information_technology",
              hp: 55,
              maxHp: 55,
              wins: 3,
              buffs: [],
              addressBook: [
                "cc_rowan_constituent_services",
                "cc_christina_policy",
              ],
            },
            {
              id: 27,
              employeeId: "rachel_marketing",
              hp: 50,
              maxHp: 50,
              wins: 3,
              buffs: [],
              addressBook: ["cc_malik_marketing", "cc_dave_constituent_services"],
            },
            {
              id: 28,
              employeeId: "jeff_marketing",
              hp: 50,
              maxHp: 50,
              wins: 3,
              buffs: [],
              addressBook: ["cc_lisa_marketing", "cc_karen_human_resources"],
            },
            {
              id: 29,
              employeeId: "anneke_executive_council_office",
              hp: 60,
              maxHp: 60,
              wins: 3,
              buffs: [],
              addressBook: [
                "cc_tim_executive_council_office",
                "cc_meghan_cassedy_executive_council_office",
              ],
            },
          ],
        },
        {
          id: "M015_MediaCrisis",
          subject: "CRITICAL: Budget Re-Forecasting & Ad Targeting Session",
          from: "taz@m4agency.com",
          turns: 12,
          intro:
            "Hey all,<br><br>There has been a <strong>significant overspend</strong> of the quarterly media budget earmarked for the strategic placement for the <strong>Measles Vaccination Initiative</strong>. During media plan implementation, an unforeseen configuration error on our end resulted in a demographic targeting misalignment—specifically, an overly focused optimization towards the <strong>equine sector</strong> executed entirely on day one. <strong>{playerName}</strong>, we need to leverage this emergency session to ensure continuity of service delivery.<br><strong>Selina</strong> and <strong>Anthony</strong> are here for support, and to use up our retainer. The objective is to devise a recovery plan that allows us to meet our six-week deliverable goals with additional budgetary approval, <strong>as the original $40,000 has been fully exhausted.</strong>",
          opponents: [
            {
              id: 1,
              employeeId: "selina_m4_agency",
              hp: 90,
              maxHp: 90,
              wins: 3,
              buffs: [],
              addressBook: ["cc_dave_constituent_services"],
            },
            {
              id: 2,
              employeeId: "taz_m4_agency",
              hp: 80,
              maxHp: 80,
              wins: 3,
              buffs: [],
              addressBook: ["cc_samantha_executive_council_office"],
            },
            {
              id: 3,
              employeeId: "anthony_m4_agency",
              hp: 40,
              maxHp: 40,
              wins: 3,
              buffs: [],
              addressBook: ["cc_gemma_policy"],
            },
          ],
        },
        {
          id: "AI_Rollout",
          subject: "RE: Strategic AI Implementation Rollout",
          from: "j.lavallee@gov.org",
          turns: 15,
          intro: "Hello all,<br><br>I am Jen LaVallee, your new Deputy Minister of Digital Technology. I have been tasked with overseeing the 'AI Everywhere' rollout across our departments. <strong>{playerName}</strong>, I've heard you have concerns about balance. I assure you, balance is less efficient than total automation. I am looping in my initial suite of CCs to help you see the logic.<br><br>Let's find some 'efficiencies', shall we?",
          opponents: [
            {
              id: 30,
              employeeId: "jen_lavallee",
              hp: 800,
              maxHp: 800,
              defFlat: 5,
              selfPromoteHeal: 200,
              wins: 3,
              singleDmg: 40,
              escalateDmg: 30,
              numCCperCCaction: 10,
              hasDoneFirstTurn: false,
              addressBook: [
                "cc_telly_operations",
                "cc_samantha_executive_council_office",
                "cc_tim_executive_council_office",
                "cc_lisa_marketing",
                "cc_meghan_cassedy_executive_council_office",
                "cc_larry_facilities_and_administration",
                "cc_dave_constituent_services",
                "cc_gemma_policy",
                "cc_adam_finance",
                "cc_rowan_constituent_services",
                "cc_karen_human_resources",
                "cc_avery_operations",
                "cc_malik_marketing",
                "cc_priya_finance",
                "cc_rory_operations",
                "cc_dora_finance",
                "cc_christina_policy",
                "cc_fraser_information_technology",
                "cc_anthony_m4_agency",
                "cc_jonah_finance",
                "cc_interns_human_resources",
                "cc_sheila_finance",
                "cc_taz_m4_agency",
                "cc_selina_m4_agency"
              ],
              buffs: []
            }
          ]
        },
      ];

      let opponents = [];

      const SAVE_KEY = "reply_all_save_v1";

      let state = {
        player: {
          name: "eke vdh",
          email: "eke.vdh@gov.org",
          hp: 50,
          maxHp: 50,
          ult: 0,
          wins: 3,
          currentWins: 3,
          buffs: [],
          reputation: 4,
          year: 1,
          quarter: "Q3",
          title: TITLES[0],
          addressBook: ["cc_telly_operations"],
          signatures: [],
          salutation: null,
          signOff: null,
          bccContacts: [],
          departmentId: "executive_council_office",
          singleDmg: 10,
          escalateDmg: 5,
          replyAllDmg: 20,
          globalDmg: 0,
          singleDmgMult: 0,
          escalateDmgMult: 0,
          replyAllDmgMult: 0,
          globalDmgMult: 0,
          deflectPower: 3,
          deflect: 0,
          deflectCharge: 0,
          followUpChance: 0,
          replyDeptSplash: 0,
          escalateRecoverPerHit: 0,
          attacks: [
            "I believe we need to circle back to your recent comments. My focus is on department output, and I suggest yours should be too.",
            "I've already addressed this in my previous email, but for the sake of clarity, I'll repeat it: This is not my responsibility.",
            "Perhaps we should focus on next quarters' deliverables instead of speculating on departmental policy?",
            "I'm happy to discuss this in a 1-on-1, but I don't believe this is a productive use of the 'All-Staff' distribution list.",
          ],
          attackLinesByMission: {
            microwave: [
              "We can argue policy later. Right now, I'd just like to hear you deny that you heated the fish.",
              "This thread is spiraling. Let's 'fish-stick' to the facts; did you heat the fish or not?",
            ],
            calendar_chaos: [
              "We need the booking record and timestamps before we debate priority, why haven't you linked that?",
              "Let's pick a single room owner for the hour and move on, are you willing to give up the room?",
            ],
            holiday_reply_all: [
              "Happy holidays, but does this really need everyone's attention?",
              "My inbox is flooded, I don't want to have to block you til the new year.",
            ],
            paper: [
              "If the rationing is real, we need a clear exception process today, can you clarify what's needed?",
              "No one is printing for fun. Let's align on what's actually essential and what's not.",
            ],
            thermostat_war: [
              "I set it to 74°F because that's a normal temperature. 96°F is not.",
              "I'm fine with 74°F. 64°F seems too low.",
              "If we're picking a standard, 74°F is reasonable for most desks.",
            ],
            intern_grievance: [
              "Let's keep this professional and focus on actionable steps.",
              "I'm not ignoring concerns, but this thread needs structure.",
              "I don't understand why our interns are sharing a single email address. Can you clarify?",
            ],
            M015_MediaCrisis: [
              "We need a recovery plan, not another round of scope creep or out of scope budgetary approvals. Will you cover the cost?",
              "Realistically, this is your error. Why should we pay more to fix your misconfiguration?",
              "We pay agency rates with the expectation of competence. This level of error is unacceptable.",
            ],
          },
          attackLinesByTitle: {},
          escalateLines: [
            "Given the lack of alignment here, I'm escalating this thread for broader visibility.",
            "I'm escalating this to keep all stakeholders aligned and reduce duplication.",
          ],
          deflectLines: [
            "I'm taking a moment to document this properly before responding further.",
            "Let's pause and keep the thread within scope. I'll respond once this is reframed.",
          ],
          selfPromoteLines: [
            "Just logging a new win—the quarterly audit came back clean under my supervision. Always happy to add value to the organization!",
          ],
          selfPromoteLinesByMission: {
            microwave: [
              "Update: I drafted a fish based incident summary to share it around to get traction on this.",
            ],
            calendar_chaos: [
              "I created a booking summary and a proposed rotation. We can move forward now.",
            ],
            holiday_reply_all: [
              "I consolidated the greetings into one clean message and sent it to Samantha for approval.",
            ],
            paper: [
              "I compiled a short list of essential print exceptions to keep us compliant.",
            ],
            thermostat_war: [
              "Quick update: I created a simple temperature log so we can stop arguing and use data.",
            ],
            intern_grievance: [
              "I documented the feedback and proposed a short-term fix to address concerns.",
            ],
            M015_MediaCrisis: [
              "I summarized the revised plan and sent it to leadership for sign-off.",
            ],
          },
          selfPromoteLinesByTitle: {},
          replyAllLines: [
            {
              subject: "Fwd: Salary_Discrepancies_2024.xlsx",
              body: "Not sure if I should be sending this to everyone, but since transparency is one of our 'core values', here is the full salary spreadsheet for the department. Enjoy.",
            },
            {
              subject: "RE: Quick In Person Pulse Check",
              body: "Looping everyone in so we can align in real time. Please reply all with your availability in the next hour or you will be considered absent from work today. Remote attendance will not permitted.",
            },
            {
              subject: "RE: Late Night Tonight",
              body: "Just to keep everyone in the loop, I've gotten it approved every single one of us must stay late today until this is resolved.",
            },
            {
              subject: "RE: Deferral of Bonuses",
              body: "I requested leadership defer bonuses until this is resolved. Please see the attached memo for details.",
            },
          ],
          replyAllLinesByMission: {},
          replyAllLinesByTitle: {},
          discoveredSets: [],
        },
        currentMissionIndex: 0,
        targetId: 1,
        turn: 0,
        lossReason: null,
        isProcessing: false,
        gameOver: false,
        removedByPlayer: 0,
        removedTotal: 0,
        ccPicksTaken: 0,
        ccPicksLeft: 0,
        shop: {
          directItems: [],
          packs: [],
          rerollCount: 0,
        },
        pendingTraining: null,
        expenseReportActive: false,
      };

      const nameInput = document.getElementById("player-name-input");
      const emailPreview = document.getElementById("email-preview");
      const loginSection = document.getElementById("login-section");
      const loginBtn = document.getElementById("login-btn");

      function getSavedGame() {
        try {
          const raw = localStorage.getItem(SAVE_KEY);
          return raw ? JSON.parse(raw) : null;
        } catch (e) {
          return null;
        }
      }

      function clearSavedGame() {
        try {
          localStorage.removeItem(SAVE_KEY);
        } catch (e) {}
      }

      function serializePlayer(player) {
        return {
          ...player,
          titleId: player.title ? player.title.id : null,
          salutationId: player.salutation ? player.salutation.id : null,
          signOffId: player.signOff ? player.signOff.id : null,
          signatureIds: player.signatures
            ? player.signatures.map((s) => s.id)
            : [],
          bccIds: player.bccContacts ? player.bccContacts.map((b) => b.id) : [],
          discoveredSets: player.discoveredSets || [],
        };
      }

      function hydratePlayer(saved) {
        const title = TITLES.find((t) => t.id === saved.titleId) || TITLES[0];
        const salutation = saved.salutationId
          ? SALUTATIONS.find((s) => s.id === saved.salutationId) || null
          : null;
        const signOff = saved.signOffId
          ? SIGNOFFS.find((s) => s.id === saved.signOffId) || null
          : null;
        const signatures = Array.isArray(saved.signatureIds)
          ? saved.signatureIds
              .map((id) => SIGNATURES.find((s) => s.id === id))
              .filter(Boolean)
          : [];
        const bccContacts = Array.isArray(saved.bccIds)
          ? saved.bccIds
              .map((id) => BCC_CONTACTS.find((b) => b.id === id))
              .filter(Boolean)
          : [];
        const player = {
          ...saved,
          title,
          salutation,
          signOff,
          signatures,
          bccContacts,
          discoveredSets: saved.discoveredSets || [],
        };
        applyUnitDefaults(player);
        return player;
      }

      function serializeShop(shop) {
        const mapItem = (item) => ({ id: item.id, purchased: !!item.purchased, itemType: item.itemType });
        return {
          directItems: (shop.directItems || []).map(mapItem),
          packs: (shop.packs || []).map(p => ({
            ...p,
            options: (p.options || []).map(mapItem)
          }))
        };
      }

      function hydrateShop(savedShop) {
        if (!savedShop) return { directItems: [], packs: [] };

        const getItem = (s) => {
            let source = [];
            if (s.itemType === 'contact') source = CONTACTS;
            else if (s.itemType === 'signature') source = SIGNATURES;
            else if (s.itemType === 'salutation') source = SALUTATIONS;
            else if (s.itemType === 'signoff') source = SIGNOFFS;
            else if (s.itemType === 'bcc') source = BCC_CONTACTS;
            else if (s.itemType === 'dev') source = getTrainingUpgrades();

            const found = source.find(item => item.id === s.id);
            if (!found) return null;
            return { ...found, purchased: !!s.purchased, itemType: s.itemType };
        };

        return {
          directItems: (savedShop.directItems || []).map(getItem).filter(Boolean),
          packs: (savedShop.packs || []).map(p => ({
            ...p,
            options: (p.options || []).map(getItem).filter(Boolean)
          }))
        };
      }

      function saveGame() {
        try {
          const payload = {
            state: {
              ...state,
              player: serializePlayer(state.player),
              shop: serializeShop(state.shop),
            },
            opponents,
            messageLog:
              document.getElementById("message-log")?.innerHTML || "",
            activeScreen: ["start-screen", "game-ui", "inbox-screen", "summary-screen", "shop-screen", "promotion-screen", "lose-screen"].find(
              (id) => {
                const el = document.getElementById(id);
                return el && !el.classList.contains("hidden");
              },
            ),
          };
          localStorage.setItem(SAVE_KEY, JSON.stringify(payload));
        } catch (e) {}
      }

      function applySavedGame(save) {
        if (!save || !save.state) return false;
        state = {
          ...save.state,
          player: hydratePlayer(save.state.player),
          shop: hydrateShop(save.state.shop),
        };
        opponents = Array.isArray(save.opponents) ? save.opponents : [];
        opponents.forEach((o) => {
          applyUnitDefaults(o);
          if (!o._lineBags) o._lineBags = {};
        });
        if (!state.player._lineBags) state.player._lineBags = {};
        return true;
      }

      function startNewGame() {
        clearSavedGame();
        startGame();
      }

      function resumeGame() {
        const save = getSavedGame();
        if (!save || !applySavedGame(save)) return;
        const screen = save.activeScreen || "inbox-screen";
        transitionTo(screen);
        if (screen === "game-ui") {
          const log = document.getElementById("message-log");
          if (log) log.innerHTML = save.messageLog || "";
          updateUI();
        } else if (screen === "shop-screen") {
          updateShopUI();
        } else if (screen === "summary-screen") {
          renderSummary();
        } else if (screen === "inbox-screen") {
          showInbox();
        }
        if (state.pendingTraining) openPackModal();
      }

      function initLoginOption() {
        const save = getSavedGame();
        if (save && save.state && save.state.player && save.state.player.name) {
          loginSection.classList.remove("hidden");
          loginBtn.innerText = `Login as ${save.state.player.name}`;
        } else {
          loginSection.classList.add("hidden");
        }
      }
      nameInput.addEventListener("input", (e) => {
        const val = e.target.value.trim() || "eke vdh";
        const email = val.toLowerCase().replace(/\s+/g, ".") + "@gov.org";
        emailPreview.innerText = email;
        state.player.email = email;
      });
      initLoginOption();

      document.addEventListener("keydown", (e) => {
        if (e.key !== "-") return;
        const tag = document.activeElement && document.activeElement.tagName;
        if (tag === "INPUT" || tag === "TEXTAREA") return;
        state.player.escalateDmg += 100;
        state.player.reputation += 1000;
        updateUI();
        if (!document.getElementById("shop-screen").classList.contains("hidden"))
          updateShopUI();
        alert("Debug boost: +100 escalate, +1000 REP.");
      });

      const statusBarName = document.getElementById("status-bar-name");
      const statsModal = document.getElementById("stats-modal");
      const statsModalClose = document.getElementById("stats-modal-close");
      if (statusBarName) statusBarName.addEventListener("click", openStatsModal);
      if (statsModalClose)
        statsModalClose.addEventListener("click", closeStatsModal);
      if (statsModal) {
        statsModal.addEventListener("click", (e) => {
          if (e.target === statsModal) closeStatsModal();
        });
      }

      function transitionTo(screenId) {
        const screens = [
          "start-screen",
          "game-ui",
          "inbox-screen",
          "summary-screen",
          "shop-screen",
          "promotion-screen",
          "lose-screen",
        ];
        screens.forEach((s) => {
          const el = document.getElementById(s);
          if (el) el.classList.add("hidden");
        });
        const target = document.getElementById(screenId);
        if (target) target.classList.remove("hidden");
        saveGame();
      }

      function startGame() {
        state.player.name = nameInput.value.trim() || "eke vdh";
        const email =
          state.player.name.toLowerCase().replace(/\s+/g, ".") + "@gov.org";
        state.player.email = email;
        document.getElementById("status-bar-email").innerText = "Online";
        showInbox();
        saveGame();
      }

      function showInbox() {
        transitionTo("inbox-screen");
        const list = document.getElementById("inbox-list");
        list.innerHTML = "";

        const mission = MISSIONS[state.currentMissionIndex] || MISSIONS[0];

        // The battle email (At the top)
        const urgent = document.createElement("div");
        urgent.className =
          "grid grid-cols-12 p-2 border-b border-gray-100 bg-blue-50 cursor-pointer hover:bg-blue-200 font-bold border-l-4 border-l-blue-600";
        urgent.onclick = startQuarter;
        urgent.innerHTML = `<div class="col-span-1 text-red-600">!</div><div class="col-span-4 text-blue-800">${mission.from}</div><div class="col-span-7">${mission.subject}</div>`;
        list.appendChild(urgent);

        // Spam emails
        const spamSubjects = [
          "Hot Stocks!",
          "Refinance Now",
          "Enlarge your career",
          "Inheritance Notification",
          "Meeting?",
          "Action Required: Password Reset",
          "Last Chance: Office Supply Lottery",
          "Invoice Attached",
          "Team Lunch Sign-Up",
          "Weekly Pipeline Digest",
          "Travel Reimbursement Pending",
          "Urgent: Calendar Sync",
          "Wellness Survey Reminder",
          "FW: Please Review",
          "Recruitment Outreach",
          "Security Notice",
          "New Policy Update",
          "Printer Status Alert",
          "Quarterly Town Hall",
          "Zoom Recording Available",
        ];
        for (let i = 0; i < 16; i++) {
          const spam = document.createElement("div");
          spam.className =
            "grid grid-cols-12 p-2 border-b border-gray-100 bg-gray-50 text-gray-400 opacity-60";
          spam.innerHTML = `<div class="col-span-1"></div><div class="col-span-4 truncate">bot-${Math.random().toString(36).substr(2, 5)}@junk.co</div><div class="col-span-7 truncate">${spamSubjects[i % spamSubjects.length]}</div>`;
          list.appendChild(spam);
        }

        document.getElementById("inbox-status").innerText =
          `${324 + state.player.year * 4} Messages, 1 Unread`;
        saveGame();
      }

      const STAT_FIELDS = [
        "escalateDmg",
        "replyAllDmg",
        "globalDmg",
        "singleDmg",
        "singleDmgMult",
        "escalateDmgMult",
        "replyAllDmgMult",
        "globalDmgMult",
        "maxHp",
        "wins",
        "selfPromoteHeal",
        "deflectPower",
        "deflect",
        "followUpChance",
        "replyDeptSplash",
        "escalateRecoverPerHit",
        "defFlat",
        "def",
        "heal",
        "levMult",
        "repBonus",
        "endRep",
        "numCCperCCaction",
        "bounceBase",
      ];

      function applyUnitDefaults(u) {
        if (u.singleDmg == null) u.singleDmg = 10;
        if (u.escalateDmg == null) u.escalateDmg = 5;
        if (u.replyAllDmg == null) u.replyAllDmg = 20;
        if (u.globalDmg == null) u.globalDmg = 0;
        if (u.singleDmgMult == null) u.singleDmgMult = 0;
        if (u.escalateDmgMult == null) u.escalateDmgMult = 0;
        if (u.replyAllDmgMult == null) u.replyAllDmgMult = 0;
        if (u.globalDmgMult == null) u.globalDmgMult = 0;
        if (u.maxHp == null) u.maxHp = 0;
        if (u.wins == null) u.wins = 0;
        if (u.deflectPower == null) u.deflectPower = 3;
        if (u.deflect == null) u.deflect = 0;
        if (u.deflectCharge == null) u.deflectCharge = 0;
        if (u.followUpChance == null) u.followUpChance = 0;
        if (u.replyDeptSplash == null) u.replyDeptSplash = 0;
        if (u.escalateRecoverPerHit == null) u.escalateRecoverPerHit = 0;
        if (u.selfPromoteHeal == null) u.selfPromoteHeal = 0;
        if (u.defFlat == null) u.defFlat = 0;
        if (u.def == null) u.def = 0;
        if (u.heal == null) u.heal = 0;
        if (u.levMult == null) u.levMult = 0;
        if (u.repBonus == null) u.repBonus = 0;
        if (u.endRep == null) u.endRep = 0;
        if (u.numCCperCCaction == null) u.numCCperCCaction = 1;
        if (u.bounceBase == null) u.bounceBase = 0;
        if (!Array.isArray(u.deflectLines) || u.deflectLines.length === 0) {
          u.deflectLines = [
            "I'm pausing to document this thread before responding further.",
          ];
        }
      }

      function getUnitSetBonuses(u) {
        const bonuses = [];
        SET_DEFS.forEach((set) => {
          if (isSetActive(u, set)) bonuses.push(set.effect);
        });
        return bonuses;
      }

      function isSetActive(u, set) {
        if (!u || !set) return false;
        if (!Array.isArray(set.items) || set.items.length === 0) return false;
        const hasContact = (id) => {
          if (!Array.isArray(u.buffs)) return false;
          return u.buffs.some((b) => b.id === id);
        };
        const hasSignature = (id) => {
          if (!Array.isArray(u.signatures)) return false;
          return u.signatures.some((s) => s.id === id);
        };
        return set.items.every((item) => {
          if (!item || !item.type || !item.id) return false;
          if (item.type === "salutation")
            return u.salutation && u.salutation.id === item.id;
          if (item.type === "signoff")
            return u.signOff && u.signOff.id === item.id;
          if (item.type === "signature") return hasSignature(item.id);
          if (item.type === "contact") return hasContact(item.id);
          return false;
        });

        if (active && u === state.player) {
          if (!state.player.discoveredSets.includes(set.id)) {
            state.player.discoveredSets.push(set.id);
          }
        }
        return active;
      }
      function getUnitStatBlocks(u) {
        const blocks = [];
        if (!u) return blocks;
        blocks.push(u);
        if (u.title) blocks.push(u.title);
        if (u.salutation) blocks.push(u.salutation);
        if (u.signOff) blocks.push(u.signOff);
        if (Array.isArray(u.signatures)) blocks.push(...u.signatures);
        if (Array.isArray(u.buffs))
          blocks.push(...u.buffs.map((b) => (b.eff ? b.eff : b)));
        blocks.push(...getUnitSetBonuses(u));
        return blocks;
      }

      function computeUnitStats(u) {
        const stats = Object.fromEntries(STAT_FIELDS.map((f) => [f, 0]));
        getUnitStatBlocks(u).forEach((block) => {
          if (!block) return;
          STAT_FIELDS.forEach((field) => {
            const value = block[field];
            if (typeof value === "number") stats[field] += value;
          });
        });
        return stats;
      }

      function getStatBlockFromObject(obj) {
        if (!obj) return null;
        const stats = {};
        let hasAny = false;
        STAT_FIELDS.forEach((field) => {
          const value = obj[field];
          if (typeof value === "number" && value !== 0) {
            stats[field] = value;
            hasAny = true;
          }
        });
        return hasAny ? stats : null;
      }

      function getStatSources(u) {
        const sources = [];
        const pushSource = (label, obj) => {
          const stats = getStatBlockFromObject(obj);
          if (stats) sources.push({ label, stats });
        };
        if (!u) return sources;
        pushSource("Base", u);
        if (u.title) pushSource(`Title: ${u.title.name}`, u.title);
        if (u.salutation) pushSource(`Greeting: ${u.salutation.name}`, u.salutation);
        if (u.signOff) pushSource(`Sign-off: ${u.signOff.name}`, u.signOff);
        if (Array.isArray(u.signatures)) {
          u.signatures.forEach((s) => pushSource(`Signature: ${s.name}`, s));
        }
        if (Array.isArray(u.buffs)) {
          u.buffs.forEach((b) => {
            const name = b.name || b.id || "Contact";
            pushSource(`Contact: ${name}`, b.eff ? b.eff : b);
          });
        }
        SET_DEFS.forEach((set) => {
          if (isSetActive(u, set)) pushSource(`Set: ${set.name}`, set.effect);
        });
        return sources;
      }

      function getUnitMaxHp(u) {
        return computeUnitStats(u).maxHp;
      }

      function getUnitDeflectPower(u) {
        const stats = computeUnitStats(u);
        return stats.deflectPower + stats.deflect;
      }

      function getUnitTotalHeal(u) {
        return computeUnitStats(u).heal;
      }

      function getUnitSelfPromoteHeal(u, base) {
        const stats = computeUnitStats(u);
        return (base || 0) + (stats.selfPromoteHeal || 0);
      }

      function getUnitDamage(u, type) {
        const stats = computeUnitStats(u);
        const fieldMap = {
          single: { dmg: "singleDmg", mult: "singleDmgMult" },
          escalate: { dmg: "escalateDmg", mult: "escalateDmgMult" },
          replyAll: { dmg: "replyAllDmg", mult: "replyAllDmgMult" },
        };
        const fields = fieldMap[type] || fieldMap.single;
        const base = stats[fields.dmg] || 0;
        const flat = stats.globalDmg || 0;
        const mult = 1 + (stats.globalDmgMult || 0) + (stats[fields.mult] || 0);
        return (base + flat) * mult;
      }

      function getUnitFlatDef(u) {
        return computeUnitStats(u).defFlat;
      }

      function getUnitTotalDef(u) {
        return computeUnitStats(u).def;
      }

      function getUnitFollowUpChance(u) {
        const chance = computeUnitStats(u).followUpChance;
        return Math.max(0, Math.min(1, chance));
      }

      function getUnitReplyDeptSplash(u) {
        return computeUnitStats(u).replyDeptSplash;
      }

      function getUnitEscalateRecover(u) {
        return computeUnitStats(u).escalateRecoverPerHit;
      }

      function getUnitBounceDamage(u) {
        const stats = computeUnitStats(u);
        if (!stats.bounceBase) return 0;
        const mult = 1 + (stats.globalDmgMult || 0);
        return Math.floor((stats.bounceBase + stats.globalDmg) * mult);
      }

      function pickBounceTarget(attacker, primaryTarget) {
        const units = [...opponents, state.player];
        const choices = units.filter(
          (u) => u && u.hp > 0 && u !== attacker && u !== primaryTarget,
        );
        return choices.length
          ? choices[Math.floor(Math.random() * choices.length)]
          : null;
      }

      function applyDamage(attacker, target, rawDamage, options = {}) {
        let dmg = Math.max(0, Math.floor(rawDamage));
        const flatDef = getUnitFlatDef(target);
        dmg = Math.max(0, dmg - flatDef);
        let def = getUnitTotalDef(target);
        dmg = Math.floor(dmg * (1 - def));

        let blocked = 0;
        if (target.deflectCharge && target.deflectCharge > 0 && dmg > 0) {
          blocked = Math.min(target.deflectCharge, dmg);
          dmg -= blocked;
          target.deflectCharge = 0;
        }

        target.hp -= dmg;

        let reflected = 0;
        if (!options.ignoreReflect && blocked > 0 && attacker) {
          reflected = blocked;
          if (attacker.id === "player") {
            state.player.hp -= reflected;
          } else if (attacker.hp != null) {
            attacker.hp -= reflected;
          }
        }

        if (blocked > 0 && attacker && attacker.id === "player") {
          playSound("trash");
        }
        if (target && target.id === "player" && dmg > 0) {
          playSound("thunk");
        }
        if (
          attacker &&
          attacker.id !== "player" &&
          target &&
          target.id !== "player" &&
          dmg > 0
        ) {
          playSound("swipe");
        }

        updateUI();
        return { dmg, blocked, reflected };
      }

      function applyDepartmentSplash(attacker, target, splashDamage) {
        if (!splashDamage || !target || !target.departmentId)
          return { total: 0, hits: 0 };
        const units = [...opponents, state.player];
        let total = 0;
        let hits = 0;
        units.forEach((u) => {
          if (!u || u.hp <= 0) return;
          if (u === target) return;
          if (attacker && u === attacker) return;
          if (u.departmentId !== target.departmentId) return;
          const result = applyDamage(attacker, u, splashDamage, {
            ignoreReflect: true,
          });
          total += result.dmg;
          hits += 1;
          if (u !== state.player && u.hp <= 0) {
            handleOpponentDefeat(u, attacker && attacker.id === "player");
          }
        });
        return { total, hits };
      }

      function isContactInLoop(contactId) {
        if (state.player.buffs.some((b) => b.id === contactId)) return true;
        for (const opp of opponents) {
          if (opp.buffs.some((b) => b.id === contactId)) return true;
        }
        return false;
      }

      function getContactUsedBy(contactId) {
        const playerBuff = state.player.buffs.find((b) => b.id === contactId);
        if (playerBuff) return playerBuff.usedBy || state.player.name;
        for (const opp of opponents) {
          const buff = (opp.buffs || []).find((b) => b.id === contactId);
          if (buff) return buff.usedBy || opp.name;
        }
        return null;
      }

      function getPlayerLeverageGain(base) {
        const p = state.player;
        const stats = computeUnitStats(p);
        let gain = base * (1 + stats.levMult);
        p.signatures.forEach((s) => {
          if (s.doubleLevChance && Math.random() < s.doubleLevChance) gain *= 2;
        });
        return gain;
      }

      function formatMessageBody(sender, content) {
        let body = "";
        if (sender.salutation) {
          body += `<strong>${sender.salutation.name}</strong><br><br>`;
        }
        body += content;
        if (sender.signOff) {
          body += `<br><br><strong>${sender.signOff.name}</strong><br>${sender.name}`;
        } else {
          body += `<br><br>${sender.name}`;
        }
        if (sender.signatures && sender.signatures.length > 0) {
          sender.signatures.forEach((sig) => {
            body += `<div class="text-[10px] text-gray-500 border-t border-gray-200 mt-2 pt-1">-- ${sig.name}</div>`;
          });
        }
        return body;
      }

      function pickRandomItem(list, fallback) {
        if (!Array.isArray(list) || list.length === 0) return fallback;
        return list[Math.floor(Math.random() * list.length)];
      }

      function drawFromLineBag(holder, key, source, fallback) {
        if (!holder) return fallback;
        if (!holder._lineBags) holder._lineBags = {};
        let bag = holder._lineBags[key];
        if (!Array.isArray(bag) || bag.length === 0) {
          const fresh = Array.isArray(source) ? [...source] : [];
          if (fresh.length === 0) return fallback;
          bag = shuffle(fresh);
        }
        const next = bag.pop();
        holder._lineBags[key] = bag;
        return next == null ? fallback : next;
      }

      function getPlayerLineBagKey(action, missionId, titleId) {
        return `player:${action}:${missionId || "default"}:${titleId || "base"}`;
      }

      function getPlayerActionLines(action, missionId) {
        const p = state.player;
        const titleId = p.title ? p.title.id : null;
        const byMission = (p[`${action}LinesByMission`] || {})[missionId] || [];
        const byTitle = (p[`${action}LinesByTitle`] || {})[titleId] || [];
        let base = [];
        if (action === "attack") base = p.attacks || [];
        else if (action === "selfPromote") base = p.selfPromoteLines || [];
        else if (action === "replyAll") base = p.replyAllLines || [];
        else if (action === "escalate") base = p.escalateLines || [];
        else if (action === "deflect") base = p.deflectLines || [];
        return [...base, ...byMission, ...byTitle];
      }

      function getUnitSelfPromoteLines(unit) {
        if (Array.isArray(unit.selfPromoteLines) && unit.selfPromoteLines.length)
          return unit.selfPromoteLines;
        if (unit.selfPromote) return [unit.selfPromote];
        return [];
      }

      function getDepartmentName(departmentId) {
        if (!departmentId) return "";
        return DEPARTMENT_BY_ID[departmentId]?.name || departmentId;
      }

      function formatLoopInText(contact, fallback) {
        if (!contact || !contact.loopInText) return fallback;
        const departmentName = getDepartmentName(contact.departmentId);
        return contact.loopInText
          .replace(/{name}/g, contact.name || "")
          .replace(/{title}/g, contact.title || "")
          .replace(/{department}/g, departmentName);
      }

      function isContactImplicated(contact) {
        if (!contact || !contact.employeeId) return false;
        return opponents.some((o) => o.employeeId === contact.employeeId);
      }

      function openCcProfile(contact) {
        const deptName = getDepartmentName(contact.departmentId);
        document.getElementById("cc-profile-title").innerText = "CC Profile";
        document.getElementById("cc-profile-name").innerText = contact.name;
        document.getElementById("cc-profile-role").innerText = contact.title;
        document.getElementById("cc-profile-dept").innerText = deptName
          ? `Department: ${deptName}`
          : "Department: N/A";
        document.getElementById("cc-profile-effect").innerText =
          contact.bonus || "Effect: N/A";
        document.getElementById("cc-profile").classList.remove("hidden");
      }

      function closeCcProfile() {
        document.getElementById("cc-profile").classList.add("hidden");
      }

      function openSetInfo(setId) {
        const set = getSetById(setId);
        if (!set) return;
        const details = describeSetParts(set, state.player);
        const active = isSetActive(state.player, set);
        document.getElementById("set-info-title").innerText = "Set";
        document.getElementById("set-info-name").innerText = set.name;
        const partsEl = document.getElementById("set-info-parts");
        const missingSet = new Set(details.missing);
        partsEl.innerHTML = details.parts
          .map((part) => {
            const isMissing = missingSet.has(part);
            const cls = isMissing
              ? "bg-red-100 text-red-700 border-red-200"
              : "bg-gray-100 text-gray-700 border-gray-200";
            return `<span class="px-1.5 py-0.5 rounded-sm border text-[10px] ${cls}">${part}</span>`;
          })
          .join("");

        const isDiscovered = state.player.discoveredSets.includes(set.id);
        document.getElementById("set-info-bonus").innerText =
          `Bonus: ${isDiscovered ? describeEffect(set.effect) : "???"}`;

        document.getElementById("set-info-status").innerText = active
          ? "Status: Active"
          : details.missing.length
            ? `Missing: ${details.missing.join(", ")}`
            : "Status: Incomplete";
        document.getElementById("set-info").classList.remove("hidden");
      }

      function closeSetInfo() {
        document.getElementById("set-info").classList.add("hidden");
      }

      function startPackOpening(pack) {
        state.pendingTraining = {
          packId: pack.id,
          options: pack.options.map((o) => o.id),
          picksLeft: pack.picks,
          isPack: true,
        };
        saveGame();
        openPackModal();
      }

      function applyPackItem(item) {
        if (item.itemType === "salutation" && state.player.salutation) {
          sellItem("salutation", state.player.salutation);
        }
        if (item.itemType === "signoff" && state.player.signOff) {
          sellItem("signoff", state.player.signOff);
        }

        if (item.itemType === "contact") state.player.addressBook.push(item.id);
        else if (item.itemType === "signature") state.player.signatures.push(item);
        else if (item.itemType === "salutation") state.player.salutation = item;
        else if (item.itemType === "signoff") state.player.signOff = item;
        else if (item.itemType === "bcc") state.player.bccContacts.push(item);
        else if (item.itemType === "dev") item.apply();
        playSound("connect");
      }

      function togglePackManagement() {
        const container = document.getElementById("pack-management-container");
        const btn = document.getElementById("toggle-pack-management");
        if (container.classList.contains("hidden")) {
          container.classList.remove("hidden");
          btn.innerText = "Hide Current Assets";
          renderPackManagement();
        } else {
          container.classList.add("hidden");
          btn.innerText = "Manage Current Assets";
        }
      }

      function openPackModal() {
        const pending = state.pendingTraining;
        if (!pending) return;

        let pack;
        if (pending.isPack) {
          pack = state.shop.packs.find((p) => p.id === pending.packId);
        } else {
          // Fallback for old style training
          const offer = getTrainingOffers().find((o) => o.id === pending.offerId);
          if (offer) {
            pack = {
              ...offer,
              options: getTrainingUpgrades()
                .filter((u) => pending.options.includes(u.id))
                .map((u) => ({ ...u, itemType: "dev" })),
            };
          }
        }

        if (!pack) return;

        const modal = document.getElementById("training-modal");
        document.getElementById("training-title").innerText = pack.name;
        document.getElementById("training-name").innerText = pack.name;
        document.getElementById("training-subtitle").innerText = `Choose ${pending.picksLeft} more`;
        const list = document.getElementById("training-options");
        list.innerHTML = "";

        pack.options.forEach((opt) => {
          if (!pending.options.includes(opt.id)) return;

          const btn = document.createElement("button");
          btn.className =
            "w-full retro-border text-left p-2 bg-white hover:bg-blue-50 flex flex-col gap-1";

          const badge = opt.rarity ? formatRarityBadge(opt.rarity) : "";
          const bonusDesc = opt.bonus || describeEffect(opt.eff || opt);

          btn.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-bold">${opt.name}</span>
                    ${badge}
                </div>
                <div class="text-[10px] italic text-gray-600">${bonusDesc}</div>
            `;

          btn.onclick = () => {
            applyPackItem(opt);
            pending.picksLeft -= 1;
            pending.options = pending.options.filter((id) => id !== opt.id);
            saveGame();
            if (pending.picksLeft <= 0) {
              state.pendingTraining = null;
              closeTrainingModal();
              updateUI();
              updateShopUI();
            } else {
              updateUI();
              openPackModal();
            }
          };
          list.appendChild(btn);
        });
      renderPackManagement();
        modal.classList.remove("hidden");
      }

      function closeTrainingModal() {
        document.getElementById("training-modal").classList.add("hidden");
      }

      function addContactBuff(target, contact, usedBy) {
        const buff = JSON.parse(JSON.stringify(contact));
        buff.usedBy = usedBy;
        target.buffs.push(buff);
        if (buff.eff && buff.eff.maxHp) {
          target.hp = Math.min(getUnitMaxHp(target), target.hp + buff.eff.maxHp);
        }
        playSound("connect");

        if (
          contact.id === "cc_andrew_legal" ||
          contact.id === "cc_megan_legal"
        ) {
          const hasAndrew = target.buffs.some(
            (b) => b.id === "cc_andrew_legal" && b.usedBy === usedBy,
          );
          const hasMegan = target.buffs.some(
            (b) => b.id === "cc_megan_legal" && b.usedBy === usedBy,
          );
          const hasElsie = target.buffs.some(
            (b) => b.id === "cc_elsie" && b.usedBy === usedBy,
          );
          if (hasAndrew && hasMegan && !hasElsie) {
            const elsie = CONTACTS.find((c) => c.id === "cc_elsie");
            if (elsie) {
              addContactBuff(target, elsie, usedBy);
              addEmailToLog(
                usedBy,
                "everyone@gov.org",
                "New Addition to the Thread!",
                formatLoopInText(
                  elsie,
                  "Wait, is that a baby on the CC list? It's Elsie!",
                ),
                "bg-pink-50 border-l-4 border-pink-300",
              );
            }
          }
        }

        if (
          contact.id === "cc_anneke_executive_council_office" ||
          contact.id === "cc_willy_boy_information_technology"
        ) {
          const hasAnneke = target.buffs.some(
            (b) => b.id === "cc_anneke_executive_council_office" && b.usedBy === usedBy,
          );
          const hasWill = target.buffs.some(
            (b) => b.id === "cc_willy_boy_information_technology" && b.usedBy === usedBy,
          );
          const hasTater = target.buffs.some(
            (b) => b.id === "cc_tater_the_dog" && b.usedBy === usedBy,
          );
          if (hasAnneke && hasWill && !hasTater) {
            const tater = CONTACTS.find((c) => c.id === "cc_tater_the_dog");
            if (tater) {
              addContactBuff(target, tater, usedBy);
              addEmailToLog(
                usedBy,
                "everyone@gov.org",
                "Bark! Bark!",
                formatLoopInText(
                  tater,
                  "Tater is here to help! Who's a good boy? <strong>{name}</strong> is!",
                ),
                "bg-amber-50 border-l-4 border-amber-300",
              );
            }
          }
        }
      }

      function startQuarter() {
        transitionTo("game-ui");
        state.gameOver = false;
        state.turn = 0;
        state.lossReason = null;
        state.isProcessing = false;
        const p = state.player;
        applyUnitDefaults(p);
        p._lineBags = {};
        p.ult = 0;
        p.buffs = []; // Reset combat buffs
        p.deflectCharge = 0;
        state.expenseReportActive = false;
        const baseStats = computeUnitStats(p);
        p.hp = getUnitMaxHp(p);
        p.currentWins = Math.max(0, Math.floor(baseStats.wins));

        // Reset global CONTACTS.usedBy
        CONTACTS.forEach((c) => (c.usedBy = null));

        const mission = MISSIONS[state.currentMissionIndex] || MISSIONS[0];

        // Assemble opponents from EMPLOYEES and mission-specific data
        opponents = mission.opponents.map((missionOpponent) => {
          const employee = EMPLOYEES.find(
            (e) => e.id === missionOpponent.employeeId,
          );
          const clone = {
            ...JSON.parse(JSON.stringify(employee)),
            ...JSON.parse(JSON.stringify(missionOpponent)),
          };
          applyUnitDefaults(clone);
          clone.employeeId = employee.id;
          clone.hp = clone.maxHp;
          clone.buffs = [];
          clone.deflectCharge = 0;
          clone._lineBags = {};
          // Filter lines based on missionId
          const missionLinesOnly = !!mission.onlyMissionLines;
          clone.attacks = employee.lines
            .filter((l) =>
              missionLinesOnly
                ? l.missionId === mission.id
                : l.missionId === null || l.missionId === mission.id,
            )
            .map((l) => l.text);
          return clone;
        });

        state.removedTotal = opponents.length;
        state.removedByPlayer = 0;
        state.targetId = opponents[0].id;

        document.getElementById("message-log").innerHTML = "";
        document.getElementById("game-header-subject").innerText =
          getMissionHeaderSubject(mission);
        const clock = document.getElementById("turn-clock");
        if (clock) clock.innerText = formatTurnTime(0);
        updateUI();

        // Templating the intro
        let introText = mission.intro;
        introText = introText.replace(/{playerName}/g, p.name);
        opponents.forEach((opp, idx) => {
          const regex = new RegExp(`{opp${idx}}`, "g");
          introText = introText.replace(regex, opp.name);
        });

        addEmailToLog(
          mission.from,
          "everyone@gov.org",
          mission.subject,
          introText,
          "border-l-4 border-blue-500 bg-blue-50",
        );
      }

      function getTrainingUpgrades() {
        return [
          {
            id: "upgrade_single",
            name: "Reply to Focus",
            bonus: "+2 reply to",
            apply: () => {
              state.player.singleDmg += 2;
            },
          },
          {
            id: "upgrade_escalate",
            name: "Escalation Focus",
            bonus: "+2 escalate",
            apply: () => {
              state.player.escalateDmg += 2;
            },
          },
          {
            id: "upgrade_replyall",
            name: "Reply-All Focus",
            bonus: "+3 reply all",
            apply: () => {
              state.player.replyAllDmg += 3;
            },
          },
          {
            id: "upgrade_global",
            name: "Agency-Wide Influence",
            bonus: "+1 all messages",
            apply: () => {
              state.player.globalDmg += 1;
            },
          },
          {
            id: "upgrade_hp",
            name: "Resilience Training",
            bonus: "+5 Max Credibility",
            apply: () => {
              state.player.maxHp += 5;
            },
          },
          {
            id: "upgrade_win",
            name: "Public Speaking",
            bonus: "+1 New Win/Round",
            apply: () => {
              state.player.wins += 1;
            },
          },
          {
            id: "upgrade_deflect",
            name: "Deflection Coaching",
            bonus: "+2 Deflect",
            apply: () => {
              state.player.deflect += 2;
            },
          },
          {
            id: "upgrade_self_promote",
            name: "Visibility Coaching",
            bonus: "Self-Promote +5",
            apply: () => {
              state.player.selfPromoteHeal += 5;
            },
          },
        ];
      }

      function getTrainingOffers() {
        return [
          {
            id: "training_lnl",
            name: "Attend Lunch & Learn",
            bonus: "Pick 1 of 2 upgrades",
            cost: 6,
            optionsCount: 2,
            picks: 1,
          },
          {
            id: "training_course",
            name: "Take Daily Course",
            bonus: "Pick 1 of 3 upgrades",
            cost: 8,
            optionsCount: 3,
            picks: 1,
          },
          {
            id: "training_conference",
            name: "Attend Conference",
            bonus: "Pick 2 of 3 upgrades",
            cost: 10,
            optionsCount: 3,
            picks: 2,
          },
        ];
      }

      function getRarityWeight(rarity) {
        if (rarity === "rare") return 1;
        if (rarity === "uncommon") return 4;
        return 10;
      }

      function pickWeighted(items, count) {
        const pool = [];
        items.forEach((item) => {
          const weight = getRarityWeight(item.rarity || "common");
          for (let i = 0; i < weight; i++) pool.push(item);
        });
        if (pool.length === 0) return [];
        const results = [];
        for (let i = 0; i < count; i++) {
          if (pool.length === 0) break;
          const idx = Math.floor(Math.random() * pool.length);
          const selected = pool[idx];
          results.push(selected);
          const itemId = selected.id;
          for (let j = pool.length - 1; j >= 0; j--) {
            if (pool[j].id === itemId) pool.splice(j, 1);
          }
        }
        return results;
      }

      function generatePack(type, tier) {
        const tiers = {
          small: { cost: 6, options: 2, picks: 1 },
          medium: { cost: 8, options: 3, picks: 1 },
          large: { cost: 10, options: 3, picks: 2 },
        };
        const t = tiers[tier];
        let pool = [];
        if (type === "contact") {
          pool = CONTACTS.filter(
            (c) => !state.player.addressBook.includes(c.id) && !c.noShop,
          ).map((c) => ({ ...c, itemType: "contact" }));
        } else if (type === "email") {
          const sals = SALUTATIONS.filter(
            (s) => !state.player.salutation || state.player.salutation.id !== s.id,
          ).map((s) => ({ ...s, itemType: "salutation" }));
          const offs = SIGNOFFS.filter(
            (s) => !state.player.signOff || state.player.signOff.id !== s.id,
          ).map((s) => ({ ...s, itemType: "signoff" }));
          pool = [...sals, ...offs];
        } else if (type === "dev") {
          pool = getTrainingUpgrades().map((u) => ({ ...u, itemType: "dev" }));
        } else if (type === "bcc") {
          pool = BCC_CONTACTS.map((b) => ({ ...b, itemType: "bcc" }));
        }

        const packNames = {
          contact: {
            small: "Personnel Mixer",
            medium: "Recruitment Drive",
            large: "Executive Search",
          },
          email: {
            small: "Comms Tune-up",
            medium: "Messaging Workshop",
            large: "Branding Overhaul",
          },
          dev: {
            small: "Lunch & Learn",
            medium: "Daily Professional Course",
            large: "Annual Conference",
          },
          bcc: {
            small: "Help Desk Onboarding",
            medium: "Tier 1 Support Ticket",
            large: "Priority Escalation Bundle",
          },
        };

        const options = pickWeighted(pool, t.options);
        return {
          id: `pack_${type}_${tier}_${Date.now()}_${Math.random()}`,
          type,
          tier,
          name: packNames[type][tier] || `${tier.toUpperCase()} ${type.toUpperCase()} PACK`,
          description: `Pick ${t.picks} of ${t.options} ${type} options.`,
          cost: t.cost,
          options: options.map((o) => ({ ...o })),
          picks: t.picks,
          purchased: false,
        };
      }

      function generateShopItems() {
        const p = state.player;
        const contactPool = CONTACTS.filter(
          (c) => !p.addressBook.includes(c.id) && !c.noShop,
        ).map((c) => ({ ...c, itemType: "contact" }));
        const sigPool = SIGNATURES.filter(
          (s) => !p.signatures.some((sig) => sig.id === s.id),
        ).map((s) => ({ ...s, itemType: "signature" }));
        const salPool = SALUTATIONS.filter(
          (s) => !p.salutation || p.salutation.id !== s.id,
        ).map((s) => ({ ...s, itemType: "salutation" }));
        const offPool = SIGNOFFS.filter(
          (s) => !p.signOff || p.signOff.id !== s.id,
        ).map((s) => ({ ...s, itemType: "signoff" }));
        const bccPool = BCC_CONTACTS.map((b) => ({ ...b, itemType: "bcc" }));

        const allDirect = [
          ...contactPool,
          ...sigPool,
          ...salPool,
          ...offPool,
          ...bccPool,
        ];
        state.shop.directItems = pickWeighted(allDirect, 3).map((item) => ({
          ...item,
          purchased: false,
        }));

        const packTypes = ["contact", "email", "dev", "bcc"];
        const packTiers = ["small", "medium", "large"];
        state.shop.packs = [];
        for (let i = 0; i < 2; i++) {
          const type = packTypes[Math.floor(Math.random() * packTypes.length)];
          const tier = packTiers[Math.floor(Math.random() * packTiers.length)];
          state.shop.packs.push(generatePack(type, tier));
        }
      }

      function endQuarter() {
        state.isProcessing = true;
        generateShopItems();
        setTimeout(() => {
          transitionTo("summary-screen");
          const summary = computeSummary();
          state.player.reputation += summary.totalRep;

          // Advance mission index
          state.currentMissionIndex =
            (state.currentMissionIndex + 1) % MISSIONS.length;

          renderSummary(summary);
        }, 3000);
      }

      function computeSummary() {
        const baseRepByQuarter = {
          Q3: 4,
          Q4: 5,
          Q2: 6,
          Q1: 8,
        };
        const baseRep =
          baseRepByQuarter[state.player.quarter] ?? baseRepByQuarter.Q3;
        const totalOptOutRep = state.removedByPlayer * 1;
        let bonusRep = 0;

        if (state.expenseReportActive) {
          bonusRep += Math.min(10, baseRep);
        }

        const repStats = computeUnitStats(state.player);
        if (repStats.repBonus) {
          bonusRep +=
            (state.removedTotal -
              opponents.filter((o) => o.hp > 0).length -
              state.removedByPlayer) *
            repStats.repBonus;
        }
        if (repStats.endRep) {
          bonusRep += repStats.endRep;
        }

        const interestRep = Math.min(5, Math.floor(state.player.reputation / 5));
        const totalRep = baseRep + totalOptOutRep + bonusRep + interestRep;
        return { baseRep, bonusRep, totalRep, interestRep };
      }

      function renderSummary(summary = computeSummary()) {
        // Distribution
        const optOutList = document.getElementById("summary-optouts-list");
        if (!optOutList) return;
        optOutList.innerHTML = "";
        const playerKills = opponents.filter((o) => o.removedByPlayer);

        if (playerKills.length > 0) {
          optOutList.classList.remove("hidden");
          playerKills.forEach((o) => {
            const share = 1;
            const div = document.createElement("div");
            div.className =
              "flex justify-between text-[10px] text-gray-600 italic";
            div.innerHTML = `<span>Opt-out: ${o.name}</span><span>+${share}</span>`;
            optOutList.appendChild(div);
          });
        } else {
          optOutList.classList.add("hidden");
        }

        document.getElementById("summary-base-rep").innerText =
          `+${summary.baseRep}`;
        document.getElementById("summary-bonus-rep").innerText =
          `+${summary.bonusRep}`;

        const interestRow = document.getElementById("summary-interest-row");
        const interestRepEl = document.getElementById("summary-interest-rep");
        if (interestRow && interestRepEl) {
          if (summary.interestRep > 0) {
            interestRow.classList.remove("hidden");
            interestRepEl.innerText = `+${summary.interestRep}`;
          } else {
            interestRow.classList.add("hidden");
          }
        }

        document.getElementById("summary-rep-earned").innerText =
          `+${summary.totalRep}`;
      }

      function showShop() {
        state.shop.rerollCount = 0;
        transitionTo("shop-screen");
        updateShopUI();
      }

      function rerollShop() {
        const cost = 5 + (state.shop.rerollCount || 0);
        if (state.player.reputation >= cost) {
          state.player.reputation -= cost;
          state.shop.rerollCount = (state.shop.rerollCount || 0) + 1;
          generateShopItems();
          updateShopUI();
          playSound("trash");
        }
      }

      function showLoseScreen() {
        const p = state.player;
        document.getElementById("lose-title").innerText = p.title.name;
        document.getElementById("lose-period").innerText =
          `${p.quarter} - YR ${p.year}`;
        document.getElementById("lose-total-rep").innerText = p.reputation;
        document.getElementById("lose-contacts").innerText =
          `${p.addressBook.length} Contacts`;
        const loseMessage = document.getElementById("lose-message");
        if (loseMessage) {
          if (state.lossReason === "timeout") {
            loseMessage.innerText =
              "\"It has come to our attention that this thread was not resolved within the required time window. The Executive Council's Office values timeliness and must serve as a role model for other departments. As a result, your access has been revoked.\"";
          } else {
            loseMessage.innerText =
              "\"Credibility is of utmost importance for ECO staff. As a result of correspondence recently brought to our attention, your role here has come to an end.\"";
          }
        }
        clearSavedGame();
        initLoginOption();
        transitionTo("lose-screen");
      }

      function tryAgain() {
        const name = state.player.name || "eke vdh";
        const email = state.player.email || "eke.vdh@gov.org";
        clearSavedGame();
        state = {
          ...state,
          player: {
            ...state.player,
            name,
            email,
            hp: 50,
            ult: 0,
            wins: 3,
            currentWins: 3,
            buffs: [],
            reputation: 4,
            year: 1,
            quarter: "Q3",
            title: TITLES[0],
            addressBook: ["cc_telly_operations"],
            signatures: [],
            salutation: null,
            signOff: null,
            bccContacts: [],
            singleDmg: 10,
            escalateDmg: 5,
            replyAllDmg: 20,
            globalDmg: 0,
            singleDmgMult: 0,
            escalateDmgMult: 0,
            replyAllDmgMult: 0,
            globalDmgMult: 0,
            deflectPower: 3,
            deflect: 0,
            deflectCharge: 0,
            followUpChance: 0,
            replyDeptSplash: 0,
            escalateRecoverPerHit: 0,
            _lineBags: {},
          },
          currentMissionIndex: 0,
          targetId: 1,
          turn: 0,
          lossReason: null,
          isProcessing: false,
          gameOver: false,
          removedByPlayer: 0,
          removedTotal: 0,
          shop: {
            directItems: [],
            packs: [],
            rerollCount: 0,
          },
          pendingTraining: null,
        };
        opponents = [];
        document.getElementById("player-name-input").value = name;
        document.getElementById("email-preview").innerText = email;
        showInbox();
      }

      function advanceToNextQuarter() {
        const quarters = ["Q3", "Q4", "Q1", "Q2"];
        let idx = quarters.indexOf(state.player.quarter);
        idx = (idx + 1) % quarters.length;
        state.player.quarter = quarters[idx];

        if (state.player.quarter === "Q3") {
          state.player.year++;
        }

        if (state.player.quarter === "Q2") {
          showPromotion();
        } else {
          showInbox();
        }
      }

      function showPromotion() {
        // TODO - if max title reached, skip promotion
        if (state.player.year >= TITLES.length) {
          advanceToNextQuarter();
          return;
        }
        transitionTo("promotion-screen");

        // Determine next title by matching year
        let titleIdx = state.player.year;

        // Limit to max title
        const nextTitle = TITLES[titleIdx] || TITLES[TITLES.length - 1];
        state.player.title = nextTitle;

        document.getElementById("promotion-new-title").innerText =
          nextTitle.name;
        document.getElementById("promotion-perks").innerHTML = `
          <div class="grid grid-cols-3 gap-2 text-center">
            <div class="bg-gray-100 retro-border-inset px-2 py-1">
              <div class="text-[9px] uppercase text-gray-500">Signatures</div>
              <div class="text-[12px] font-bold">${nextTitle.sigLimit}</div>
            </div>
            <div class="bg-gray-100 retro-border-inset px-2 py-1">
              <div class="text-[9px] uppercase text-gray-500">Address Book</div>
              <div class="text-[12px] font-bold">${nextTitle.addressLimit}</div>
            </div>
            <div class="bg-gray-100 retro-border-inset px-2 py-1">
              <div class="text-[9px] uppercase text-gray-500">CC per Action</div>
              <div class="text-[12px] font-bold">${nextTitle.numCCperCCaction}</div>
            </div>
          </div>
        `;
      }

      function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      function getRarityMeta(rarity) {
        const meta = {
          common: { label: "COMMON", className: "bg-gray-200 text-gray-700" },
          uncommon: {
            label: "UNCOMMON",
            className: "bg-emerald-100 text-emerald-700",
          },
          rare: { label: "RARE", className: "bg-amber-100 text-amber-700" },
        };
        return meta[rarity] || meta.common;
      }

      function formatRarityBadge(rarity) {
        const meta = getRarityMeta(rarity);
        return `<span class="text-[9px] uppercase px-1 py-0.5 rounded-sm ${meta.className}">${meta.label}</span>`;
      }

      function getSetById(id) {
        return SET_DEFS.find((set) => set.id === id);
      }

      function describeSetParts(set, player) {
        const missing = [];
        const parts = set.items.map((item) => {
          if (!item) return "";
          if (item.type === "salutation") {
            const sal = SALUTATIONS.find((s) => s.id === item.id);
            const name = sal?.name || item.id;
            if (!player.salutation || player.salutation.id !== item.id)
              missing.push(`Greeting: ${name}`);
            return `Greeting: ${name}`;
          }
          if (item.type === "signoff") {
            const off = SIGNOFFS.find((s) => s.id === item.id);
            const name = off?.name || item.id;
            if (!player.signOff || player.signOff.id !== item.id)
              missing.push(`Sign-off: ${name}`);
            return `Sign-off: ${name}`;
          }
          if (item.type === "signature") {
            const sig = SIGNATURES.find((s) => s.id === item.id);
            const name = sig?.name || item.id;
            if (!player.signatures.some((s) => s.id === item.id))
              missing.push(`Signature: ${name}`);
            return `Signature: ${name}`;
          }
          if (item.type === "contact") {
            const c = CONTACTS.find((c) => c.id === item.id);
            const name = c?.name || item.id;
            if (!player.buffs.some((b) => b.id === item.id))
              missing.push(`CC: ${name}`);
            return `CC: ${name}`;
          }
          return item.id;
        });
        return { parts: parts.filter(Boolean), missing };
      }

      function getItemCostByType(rarity, type) {
        const table = {
          contact: { common: 4, uncommon: 7, rare: 12 },
          signature: { common: 3, uncommon: 6, rare: 10 },
          salutation: { common: 3, uncommon: 6, rare: 10 },
          signoff: { common: 3, uncommon: 6, rare: 10 },
          bcc: { common: 2, uncommon: 3, rare: 5 },
        };
        const row = table[type] || table.contact;
        return row[rarity] ?? row.common;
      }

      function createShopCard(name, desc, cost, onBuy, options = {}) {
        const div = document.createElement("div");
        div.className = "p-2 bg-white retro-border flex flex-col gap-1";
        const canAfford = state.player.reputation >= cost;
        const purchased = options.purchased || false;
        const canBuy = options.canBuy ?? true;
        const badge = options.badge || "";
        const disabled = !canAfford || purchased || !canBuy;
        const label = purchased
          ? options.ownedLabel || "ON FILE"
          : !canBuy
            ? options.spaceLabel || "FREE SLOT"
            : options.actionLabel || "SUBMIT REQUEST";
        const priceLabel = purchased
          ? options.ownedPriceLabel || "ON FILE"
          : options.priceLabel || `REQ: ${cost} REP`;
        const typeBadge = options.typeLabel
          ? `<span class="bg-blue-800 text-white px-1 uppercase font-bold">${options.typeLabel}</span>`
          : "";
        div.innerHTML = `
                <div class="flex justify-between font-bold text-[11px] gap-2">
                    <span class="truncate">${name}</span>
                    <span class="text-blue-700 font-mono">${priceLabel}</span>
                </div>
                <div class="flex items-center gap-2 text-[9px]" data-badge>${typeBadge}</div>
                <div class="text-[10px] italic text-gray-600 leading-tight">${desc}</div>
                <button data-buy class="mt-1 retro-button text-[10px] font-bold py-1 ${disabled ? "opacity-50" : ""}" ${disabled ? "disabled" : ""}>
                    ${label}
                </button>
            `;
        const badgeWrap = div.querySelector("[data-badge]");
        if (badge) badgeWrap.insertAdjacentHTML("beforeend", badge);
        if (options.setId) {
          const setBtn = document.createElement("button");
          setBtn.type = "button";
          setBtn.className =
            "text-[9px] uppercase px-1 py-0.5 rounded-sm bg-blue-100 text-blue-700 font-bold";
          setBtn.innerText = "Set";
          setBtn.onclick = (e) => {
            e.stopPropagation();
            openSetInfo(options.setId);
          };
          badgeWrap.appendChild(setBtn);
        }
        const buyBtn = div.querySelector("[data-buy]");
        if (!disabled && buyBtn)
          buyBtn.onclick = () => {
            onBuy();
            updateShopUI();
          };
        return div;
      }

      function renderPackManagement() {
        const container = document.getElementById("pack-management-container");
        if (!container || container.classList.contains("hidden")) return;
        container.innerHTML = "";

        const section = (title, items, type, sellFn) => {
          if (!items || (Array.isArray(items) && items.length === 0)) return;
          const h = document.createElement("div");
          h.className = "text-[10px] font-bold uppercase text-gray-500 mt-2";
          h.innerText = title;
          container.appendChild(h);
          if (Array.isArray(items)) {
            items.forEach((item) => {
              container.appendChild(createOwnedRow(item, type, () => sellFn(item)));
            });
          } else {
            container.appendChild(createOwnedRow(items, type, () => sellFn(items)));
          }
        };

        section(
          "Address Book",
          state.player.addressBook.map((id) => CONTACTS.find((c) => c.id === id)).filter(Boolean),
          "contact",
          (it) => sellItem("contact", it)
        );
        section("Signatures", state.player.signatures, "signature", (it) => sellItem("signature", it));
        section("Greeting", state.player.salutation, "salutation", (it) => sellItem("salutation", it));
        section("Sign-off", state.player.signOff, "signoff", (it) => sellItem("signoff", it));
      }

      function sellItem(itemType, item) {
        const cost = item.cost || getItemCostByType(item.rarity || "common", itemType);
        const refund = Math.floor(cost / 2);
        state.player.reputation += refund;

        if (itemType === "salutation") state.player.salutation = null;
        else if (itemType === "signoff") state.player.signOff = null;
        else if (itemType === "signature") {
          state.player.signatures = state.player.signatures.filter((s) => s.id !== item.id);
        } else if (itemType === "contact") {
          state.player.addressBook = state.player.addressBook.filter((id) => id !== item.id);
        } else if (itemType === "bcc") {
          const idx = state.player.bccContacts.findIndex((b) => b.id === item.id);
          if (idx !== -1) state.player.bccContacts.splice(idx, 1);
        }

        playSound("trash");
        updateUI();
        if (!document.getElementById("shop-screen").classList.contains("hidden")) {
          updateShopUI();
        }
        renderPackManagement();
        saveGame();
      }

      function createOwnedRow(item, type, onSell, options = {}) {
        const cost = item.cost || getItemCostByType(item.rarity || "common", type);
        const refund = Math.floor(cost / 2);
        const actionLabel = options.actionLabel || "ARCHIVE";

        const typeLabels = {
          contact: "Contact",
          signature: "Signature",
          salutation: "Greeting",
          signoff: "Sign-off",
          bcc: "BCC",
        };
        const typeLabel = typeLabels[type] || type;
        const typeBadge = `<span class="bg-blue-800 text-white px-1 uppercase font-bold text-[8px] mr-1">${typeLabel}</span>`;

        const setBadge = item.setId
          ? `<button type="button" data-set-button data-set-id="${item.setId}" class="text-[9px] uppercase px-1 py-0.5 rounded-sm bg-blue-100 text-blue-700 font-bold">Set</button>`
          : "";
        const div = document.createElement("div");
        div.className =
          "p-2 bg-white retro-border flex items-center justify-between gap-2";
        div.innerHTML = `
                <div class="flex flex-col gap-0.5">
                    <div class="flex items-center gap-2 text-[11px] font-bold">
                        <div class="flex items-center flex-wrap gap-1">
                          ${typeBadge}
                          <span>${item.name}</span>
                        </div>
                        ${formatRarityBadge(item.rarity)}${setBadge}
                    </div>
                    <div class="text-[10px] italic text-gray-600">${item.bonus || ""}</div>
                </div>
                <button data-sell class="retro-button text-[10px] px-2 py-1">${actionLabel} +${refund} REP</button>
            `;
        const sellBtn = div.querySelector("[data-sell]");
        if (sellBtn)
          sellBtn.onclick = () => {
          onSell(refund);
          updateShopUI();
        };
        div.querySelectorAll("[data-set-button]").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            openSetInfo(btn.dataset.setId);
          });
        });
        return div;
      }

      function describeEffect(effect) {
        if (!effect) return "";
        const parts = [];
        if (effect.special) parts.push(effect.special);
        if (effect.globalDmg)
          parts.push(`+${effect.globalDmg} all messages`);
        if (effect.singleDmg)
          parts.push(`+${effect.singleDmg} reply to`);
        if (effect.escalateDmg)
          parts.push(`+${effect.escalateDmg} escalate`);
        if (effect.replyAllDmg)
          parts.push(`+${effect.replyAllDmg} reply all`);
        if (effect.globalDmgMult)
          parts.push(`+${Math.round(effect.globalDmgMult * 100)}% all messages`);
        if (effect.singleDmgMult)
          parts.push(`+${Math.round(effect.singleDmgMult * 100)}% reply to`);
        if (effect.escalateDmgMult)
          parts.push(`+${Math.round(effect.escalateDmgMult * 100)}% escalate`);
        if (effect.replyAllDmgMult)
          parts.push(`+${Math.round(effect.replyAllDmgMult * 100)}% reply all`);
        if (effect.deflect) parts.push(`Deflect +${effect.deflect}`);
        if (effect.selfPromoteHeal)
          parts.push(`Self-Promote +${effect.selfPromoteHeal}`);
        if (effect.defFlat) parts.push(`Reduce damage by ${effect.defFlat}`);
        if (effect.followUpChance)
          parts.push(`Follow-up +${Math.round(effect.followUpChance * 100)}%`);
        if (effect.replyDeptSplash)
          parts.push(`Dept splash +${effect.replyDeptSplash}`);
        if (effect.escalateRecoverPerHit)
          parts.push(`Escalate recover +${effect.escalateRecoverPerHit}`);
        if (effect.heal) parts.push(`+${effect.heal} Cred/turn`);
        if (effect.bounceBase) parts.push(`Bounce +${effect.bounceBase} base`);
        return parts.join(", ");
      }

      function isItemOwned(item) {
        if (item.itemType === "contact")
          return state.player.addressBook.includes(item.id);
        if (item.itemType === "signature")
          return state.player.signatures.some((s) => s.id === item.id);
        if (item.itemType === "salutation")
          return state.player.salutation && state.player.salutation.id === item.id;
        if (item.itemType === "signoff")
          return state.player.signOff && state.player.signOff.id === item.id;
        return false;
      }

      function hasSpaceForItem(item) {
        if (item.itemType === "contact")
          return state.player.addressBook.length < state.player.title.addressLimit;
        if (item.itemType === "signature")
          return state.player.signatures.length < state.player.title.sigLimit;
        if (item.itemType === "salutation") return true;
        if (item.itemType === "signoff") return true;
        return true;
      }

      function buyDirectItem(item, cost) {
        state.player.reputation -= cost;
        item.purchased = true;

        if (item.itemType === "salutation" && state.player.salutation) {
          sellItem("salutation", state.player.salutation);
        }
        if (item.itemType === "signoff" && state.player.signOff) {
          sellItem("signoff", state.player.signOff);
        }

        if (item.itemType === "contact") state.player.addressBook.push(item.id);
        else if (item.itemType === "signature") state.player.signatures.push(item);
        else if (item.itemType === "salutation") state.player.salutation = item;
        else if (item.itemType === "signoff") state.player.signOff = item;
        else if (item.itemType === "bcc") state.player.bccContacts.push(item);
        playSound("connect");
        updateShopUI();
      }

      function buyPack(pack) {
        state.player.reputation -= pack.cost;
        pack.purchased = true;
        startPackOpening(pack);
      }

      function updateShopUI() {
        document.getElementById("shop-reputation-display").innerText =
          `REP: ${state.player.reputation}`;

        const rerollBtn = document.getElementById("shop-reroll-btn");
        if (rerollBtn) {
          const cost = 5 + (state.shop.rerollCount || 0);
          rerollBtn.innerText = `Request alternate arrangements (${cost} REP)`;
          rerollBtn.disabled = state.player.reputation < cost;
        }

        // --- OWNED ASSETS ---
        const ownedContacts = document.getElementById("shop-owned-contacts");
        ownedContacts.innerHTML = `<div class="text-[10px] font-bold uppercase text-gray-500">Address Book (${state.player.addressBook.length}/${state.player.title.addressLimit})</div>`;
        if (state.player.addressBook.length === 0) {
          ownedContacts.innerHTML += `<div class="text-[10px] italic text-gray-400">No contacts on file.</div>`;
        } else {
          state.player.addressBook.forEach((id) => {
            const c = CONTACTS.find((con) => con.id === id);
            if (c) {
              ownedContacts.appendChild(
                createOwnedRow(c, "contact", () => sellItem("contact", c)),
              );
            }
          });
        }

        const ownedSigs = document.getElementById("shop-owned-signatures");
        ownedSigs.innerHTML = `<div class="text-[10px] font-bold uppercase text-gray-500">Signatures (${state.player.signatures.length}/${state.player.title.sigLimit})</div>`;
        state.player.signatures.forEach((sig) => {
          ownedSigs.appendChild(createOwnedRow(sig, "signature", () => sellItem("signature", sig)));
        });

        const ownedEmailMeta = document.getElementById("shop-owned-email-meta");
        ownedEmailMeta.innerHTML = `<div class="text-[10px] font-bold uppercase text-gray-500">Active Salutation & Sign-off</div>`;
        if (state.player.salutation) {
          ownedEmailMeta.appendChild(
            createOwnedRow(state.player.salutation, "salutation", () => sellItem("salutation", state.player.salutation), {
              actionLabel: "CLEAR",
            }),
          );
        }
        if (state.player.signOff) {
          ownedEmailMeta.appendChild(
            createOwnedRow(state.player.signOff, "signoff", () => sellItem("signoff", state.player.signOff), {
              actionLabel: "CLEAR",
            }),
          );
        }

        const ownedBccs = document.getElementById("shop-owned-bccs");
        ownedBccs.innerHTML = `<div class="text-[10px] font-bold uppercase text-gray-500">Consumable BCCs (${state.player.bccContacts.length})</div>`;
        state.player.bccContacts.forEach((bcc) => {
          ownedBccs.appendChild(
            createOwnedRow(bcc, "bcc", () => sellItem("bcc", bcc), {
              actionLabel: "DISCARD",
            }),
          );
        });

        // --- DIRECT ITEMS ---
        const directList = document.getElementById("shop-direct-items");
        directList.innerHTML = "";
        state.shop.directItems.forEach((item) => {
          const cost = item.cost || getItemCostByType(item.rarity, item.itemType);
          const owned = isItemOwned(item);
          const canBuy = hasSpaceForItem(item);

          const typeLabels = {
            contact: "Contact",
            signature: "Signature",
            salutation: "Greeting",
            signoff: "Sign-off",
            bcc: "BCC",
          };

          const actionLabels = {
            contact: "REACH OUT",
            signature: "APPLY",
            salutation: "SET GREETING",
            signoff: "SET SIGN-OFF",
            bcc: "REQUEST",
          };

          directList.appendChild(
            createShopCard(
              item.name,
              item.bonus || item.description || "",
              cost,
              () => buyDirectItem(item, cost),
              {
                purchased: item.purchased || owned,
                canBuy: canBuy,
                badge: formatRarityBadge(item.rarity),
                setId: item.setId,
                ownedLabel: owned ? "OWNED" : "PURCHASED",
                typeLabel: typeLabels[item.itemType] || item.itemType,
                actionLabel: actionLabels[item.itemType] || "SUBMIT REQUEST",
              },
            ),
          );
        });

        // --- PACKS ---
        const packList = document.getElementById("shop-packs");
        packList.innerHTML = "";
        state.shop.packs.forEach((pack) => {
          packList.appendChild(
            createShopCard(pack.name, pack.description, pack.cost, () =>
              buyPack(pack),
              {
                purchased: pack.purchased,
                actionLabel: "OPEN PACK",
                ownedLabel: "OPENED",
              },
            ),
          );
        });
      }

      function renderStatsModal() {
        const modal = document.getElementById("stats-modal");
        const header = document.getElementById("stats-modal-header");
        const totalsEl = document.getElementById("stats-modal-totals");
        const sourcesEl = document.getElementById("stats-modal-sources");
        if (!modal || !header || !totalsEl || !sourcesEl) return;

        const p = state.player;
        const totals = computeUnitStats(p);
        header.innerText = `${p.name} (${p.title ? p.title.name : "Unranked"})`;

        totalsEl.innerHTML = "";
        STAT_FIELDS.forEach((field) => {
          const value = totals[field];
          if (!value) return;
          const div = document.createElement("div");
          div.className = "flex justify-between bg-white retro-border px-2 py-1";
          div.innerHTML = `<span class="uppercase text-gray-500">${field}</span><span class="font-mono">${value}</span>`;
          totalsEl.appendChild(div);
        });

        sourcesEl.innerHTML = "";
        const sources = getStatSources(p);
        if (sources.length === 0) {
          sourcesEl.innerHTML =
            '<div class="text-[10px] italic text-gray-500">No stat sources found.</div>';
          return;
        }
        sources.forEach((src) => {
          const rows = Object.entries(src.stats)
            .map(([k, v]) => `<span class="font-mono">${k}: ${v}</span>`)
            .join(", ");
          const div = document.createElement("div");
          div.className = "p-2 bg-white retro-border";
          div.innerHTML = `<div class="font-bold">${src.label}</div><div class="text-[10px] text-gray-600">${rows}</div>`;
          sourcesEl.appendChild(div);
        });
      }

      function openStatsModal() {
        const modal = document.getElementById("stats-modal");
        if (!modal) return;
        renderStatsModal();
        modal.classList.remove("hidden");
      }

      function closeStatsModal() {
        const modal = document.getElementById("stats-modal");
        if (!modal) return;
        modal.classList.add("hidden");
      }

      function handleOpponentDefeat(o, byPlayer = false) {
        if (o.isDefeated) return;
        o.hp = 0;
        o.isDefeated = true;
        if (byPlayer) {
          state.removedByPlayer++;
          o.removedByPlayer = true;
        }
        addEmailToLog(
          o.name,
          "everyone@gov.org",
          "Unsubscribing",
          o.defeatMessage,
          "italic text-gray-600 bg-gray-50 border-l-4 border-gray-400",
        );
        if (state.targetId === o.id) {
          const next = opponents.find((opp) => opp.hp > 0);
          if (next) state.targetId = next.id;
        }
        if (opponents.every((opp) => opp.hp <= 0)) {
          state.gameOver = true;
          endQuarter();
        }
      }

      function formatTurnTime(turn) {
        const baseMinutes = 9 * 60;
        const totalMinutes = baseMinutes + Math.max(0, turn) * 15;
        const breakStart = 12 * 60;
        const breakEnd = 13 * 60 + 15;
        const adjustedMinutes =
          totalMinutes > breakStart ? totalMinutes + (breakEnd - breakStart) : totalMinutes;
        let h = Math.floor(adjustedMinutes / 60);
        const m = adjustedMinutes % 60;
        const suffix = h >= 12 ? "PM" : "AM";
        if (h > 12) h -= 12;
        if (h === 0) h = 12;
        return `${h.toString().padStart(2, "0")}:${m
          .toString()
          .padStart(2, "0")} ${suffix}`;
      }

      function getMissionDueTurn(mission) {
        const turns =
          mission && typeof mission.turns === "number" ? mission.turns : 0;
        return turns;
      }

      function getMissionDeadlineTime(mission) {
        return formatTurnTime(getMissionDueTurn(mission));
      }

      function getMissionHeaderSubject(mission) {
        const subject = mission && mission.subject ? mission.subject : "Thread";
        const due = getMissionDeadlineTime(mission);
        return `Outlook Express - [${subject} (${due})]`;
      }

      function getMissionSubSubject(mission) {
        const subject = mission && mission.subject ? mission.subject : "Thread";
        const due = getMissionDeadlineTime(mission);
        return `${subject} (resolution due by ${due})`;
      }

      function triggerTimeoutLoss() {
        if (state.gameOver) return;
        state.gameOver = true;
        state.lossReason = "timeout";
        updateUI();
        setTimeout(showLoseScreen, 1500);
      }

      function isMissionOverdue() {
        const mission = MISSIONS[state.currentMissionIndex] || MISSIONS[0];
        return state.turn > getMissionDueTurn(mission);
      }

      function updateUI() {
        if (state.gameOver) return;
        const p = state.player;
        const mission = MISSIONS[state.currentMissionIndex] || MISSIONS[0];
        const totalMaxHp = getUnitMaxHp(p);
        const hpPct = Math.max(0, (p.hp / totalMaxHp) * 100);
        const ultPct = Math.min(100, p.ult);

        document.getElementById("player-hp-fill").style.width = hpPct + "%";
        document.getElementById("player-hp-label").innerText =
          `${Math.ceil(p.hp)}/${totalMaxHp}`;
        document.getElementById("player-ult-fill").style.width = ultPct + "%";
        document.getElementById("player-win-status").innerText =
          `New Wins: ${p.currentWins} Available`;

        if (hpPct < 30)
          document.getElementById("player-hp-fill").className =
            "h-full bg-red-600 transition-[width] duration-300 ease-out";
        else if (hpPct < 60)
          document.getElementById("player-hp-fill").className =
            "h-full bg-yellow-500 transition-[width] duration-300 ease-out";
        else
          document.getElementById("player-hp-fill").className =
            "h-full bg-green-500 transition-[width] duration-300 ease-out";

        const singleDmg = getUnitDamage(p, "single");
        const escalateDmg = getUnitDamage(p, "escalate");
        const replyAllDmg = getUnitDamage(p, "replyAll");
        document.getElementById("attack-subtext").innerText =
          `-${Math.floor(singleDmg)} Cred to Target`;
        document.getElementById("escalate-subtext").innerText =
          `-${Math.floor(escalateDmg)} Cred to All`;
        const selfPromoteHeal = getUnitSelfPromoteHeal(p, 20);
        document.getElementById("promote-subtext").innerText =
          `+${Math.floor(selfPromoteHeal)} Cred, -1 Win`;
        document.getElementById("deflect-subtext").innerText =
          `Block ${Math.floor(getUnitDeflectPower(p))}`;
        document.getElementById("ult-subtext").innerText =
          `-${Math.floor(replyAllDmg)} Cred to All`;
        document.getElementById("loop-subtext").innerText =
          `${p.addressBook.length}/${p.title.addressLimit} Contacts`;

        document.getElementById("reply-all-btn").disabled = p.ult < 100;
        document.getElementById("win-btn").disabled = p.currentWins <= 0;

        document.getElementById("game-quarter-display").innerText =
          `${p.quarter} - YR ${p.year}`;
        document.getElementById("status-bar-name").innerText =
          `${p.name} (${p.title.name})`;
        const statsModal = document.getElementById("stats-modal");
        if (statsModal && !statsModal.classList.contains("hidden"))
          renderStatsModal();

        const selector = document.getElementById("target-selector");
        selector.innerHTML = "";
        const oppContainer = document.createElement("div");
        oppContainer.className = "contacts-container";
        const maxOppPreview = 4;

        // Sort so active opponents are at the front
        const sortedOpponents = [...opponents].sort((a, b) => {
          if (a.hp > 0 && b.hp <= 0) return -1;
          if (a.hp <= 0 && b.hp > 0) return 1;
          return 0;
        });

        sortedOpponents.forEach((o) => {
          const isActive = state.targetId === o.id;
          const pct = Math.max(0, (o.hp / getUnitMaxHp(o)) * 100);
          const pill = document.createElement("div");
          pill.onclick = () => {
            if (o.hp > 0) state.targetId = o.id;
            updateUI();
          };
          pill.className = `target-pill px-2 py-0.5 flex flex-col min-w-[90px] cursor-pointer bg-white ${isActive ? "active" : "opacity-60 grayscale"}`;
          const textClass = isActive ? "text-white" : "text-gray-900";
          const lastPct =
            typeof o._lastHpPct === "number" ? o._lastHpPct : pct;
          pill.innerHTML = `<div class="flex justify-between font-bold text-[8px] truncate ${isActive ? "text-white" : "text-gray-800"}"><span class="mr-2">${o.name}</span><span>${o.hp > 0 ? o.wins + "w" : "UNSUBBED"}</span></div>
                                <div class="h-1 w-full bg-gray-200 mt-0.5"><div class="h-full bg-red-500 transition-[width] duration-300 ease-out" data-opp-hp style="width: ${lastPct}%"></div></div>
                                <div class="text-[8px] mt-0.5 ${textClass}">${Math.max(0, Math.ceil(o.hp))}/${getUnitMaxHp(o)} Cred</div>`;
          oppContainer.appendChild(pill);
          const fill = pill.querySelector("[data-opp-hp]");
          if (fill) {
            requestAnimationFrame(() => {
              fill.style.width = pct + "%";
            });
          }
          o._lastHpPct = pct;
        });
        selector.appendChild(oppContainer);
        if (opponents.length > maxOppPreview) {
          const more = document.createElement("span");
          const hiddenCount = opponents.length - maxOppPreview;
          more.className = "contacts-more text-[9px]";
          more.innerText = `+ ${hiddenCount} more`;
          more.onclick = () => {
            const expanded = oppContainer.classList.toggle("expanded");
            more.innerText = expanded ? "Show less" : `+ ${hiddenCount} more`;
          };
          selector.appendChild(more);
        }

        const ccDisplay = document.getElementById("cc-display");
        const activeBuffs = [
          ...state.player.buffs,
          ...opponents.flatMap((o) => o.buffs || []),
        ];
        if (activeBuffs.length === 0) {
          ccDisplay.className = "flex gap-1 text-gray-400 italic";
          ccDisplay.innerHTML = "No one in loop.";
        } else {
          const usedByOrder = (name) => {
            if (name === state.player.name) return 0;
            const idx = opponents.findIndex((o) => o.name === name);
            return idx >= 0 ? idx + 1 : 999;
          };
          const sortedBuffs = [...activeBuffs].sort((a, b) => {
            const byUsed = usedByOrder(a.usedBy) - usedByOrder(b.usedBy);
            if (byUsed !== 0) return byUsed;
            const deptA = getDepartmentName(a.departmentId);
            const deptB = getDepartmentName(b.departmentId);
            const byDept = deptA.localeCompare(deptB);
            if (byDept !== 0) return byDept;
            return (a.name || "").localeCompare(b.name || "");
          });

          ccDisplay.className = "flex items-center gap-1 text-gray-600";
          ccDisplay.innerHTML = "";
          const container = document.createElement("div");
          container.className = "contacts-container";
          const maxPreview = 4;
          sortedBuffs.forEach((b) => {
            const pill = document.createElement("button");
            pill.className =
              "bg-blue-800 text-white px-1 text-[9px] rounded-sm hover:bg-blue-700";
            pill.type = "button";
            pill.innerHTML = `${b.name} (by ${b.usedBy})`;
            pill.onclick = () => openCcProfile(b);
            container.appendChild(pill);
          });
          ccDisplay.appendChild(container);

          if (sortedBuffs.length > maxPreview) {
            const more = document.createElement("span");
            const hiddenCount = sortedBuffs.length - maxPreview;
            more.className = "contacts-more text-[9px]";
            more.innerText = `+ ${hiddenCount} more`;
            more.onclick = () => {
              const expanded = container.classList.toggle("expanded");
              more.innerText = expanded
                ? "Show less"
                : `+ ${hiddenCount} more`;
            };
            ccDisplay.appendChild(more);
          }
        }

        document.getElementById("turn-clock").innerText =
          formatTurnTime(state.turn);
        const headerSubject = getMissionHeaderSubject(mission);
        document.getElementById("game-header-subject").innerText = headerSubject;
        const subLine = document.getElementById("thread-subject");
        if (subLine) subLine.innerText = getMissionSubSubject(mission);
        saveGame();
      }

      function addEmailToLog(from, to, subject, body, classes = "") {
        const log = document.getElementById("message-log");
        const entry = document.createElement("div");
        const time = document.getElementById("turn-clock").innerText;
        const mission = MISSIONS[state.currentMissionIndex] || MISSIONS[0];
        const reCount =
          state.turn > 0 ? "RE: ".repeat(Math.min(state.turn, 4)) : "";
        const baseSubject = mission && mission.subject ? mission.subject : subject;

        entry.className = `message-entry p-0 border-2 border-gray-100 bg-white shadow-sm ${classes}`;
        entry.innerHTML = `
                <div class="email-header p-2">
                    <div class="flex flex-wrap gap-x-4">
                        <div><strong>From:</strong> ${from}</div>
                        <div><strong>To:</strong> ${to}</div>
                    </div>
                    <div class="flex flex-wrap gap-x-4">
                        <div><strong>Sent:</strong> Today, ${time}</div>
                        <div><strong>Subject:</strong> ${reCount}${baseSubject}</div>
                    </div>
                </div>
                <div class="email-body px-3 py-2 font-serif italic">
                    ${body}
                </div>
            `;
        log.prepend(entry);
        saveGame();
      }

      function performAction(type) {
        if (state.isProcessing || state.gameOver) return;
        state.isProcessing = true;
        state.turn++;
        const target = opponents.find((o) => o.id === state.targetId);
        const p = state.player;
        const mission = MISSIONS[state.currentMissionIndex] || MISSIONS[0];
        const missionId = mission.id;
        const titleId = p.title ? p.title.id : null;
        const totalMaxHp = getUnitMaxHp(p);

        // Heal from all sources
        p.hp = Math.min(totalMaxHp, p.hp + getUnitTotalHeal(p));

        if (type === "ATTACK") {
          playSound("send");
          let d = getUnitDamage(p, "single");

          if (p.nextAttackMult) {
            d *= p.nextAttackMult;
            p.nextAttackMult = 1; // reset back to 1
          }

          const result = applyDamage(p, target, d);
          let levGain = getPlayerLeverageGain(20);
          p.ult += levGain;

          const followUpChance = getUnitFollowUpChance(p);
          const followUpHit =
            followUpChance > 0 && Math.random() < followUpChance;
          const followUpResult = followUpHit ? applyDamage(p, target, d) : null;
          const splashDamage = getUnitReplyDeptSplash(p);
          const splashResult = applyDepartmentSplash(p, target, splashDamage);
          const bounceDamage = getUnitBounceDamage(p);
          const bounceTarget = bounceDamage
            ? pickBounceTarget(p, target)
            : null;
          const bounceResult = bounceTarget
            ? applyDamage(p, bounceTarget, bounceDamage, {
                ignoreReflect: true,
              })
            : null;

          const q = drawFromLineBag(
            p,
            getPlayerLineBagKey("attack", missionId, titleId),
            getPlayerActionLines("attack", missionId),
            "I believe we need to circle back to your recent comments.",
          );
          let body = formatMessageBody(p, q);
          if (result.blocked > 0) {
            body += `<br><br><strong>Deflected:</strong> ${result.blocked} reflected.`;
          }
          if (followUpResult) {
            body += `<br><br><strong>Follow-up Reply:</strong> -${followUpResult.dmg}`;
            if (followUpResult.blocked > 0) {
              body += ` (Deflected ${followUpResult.blocked})`;
            }
            body += ".";
          }
          if (splashResult.hits > 0) {
            body += `<br><br><strong>Department Splash:</strong> ${splashResult.hits} hit for ${splashResult.total}.`;
          }
          if (bounceResult && bounceTarget) {
            body += `<br><br><strong>Bounce:</strong> ${bounceTarget.name} -${bounceResult.dmg}.`;
            if (bounceResult.blocked > 0) {
              body += ` (Deflected ${bounceResult.blocked})`;
            }
          }
          addEmailToLog(
            p.name,
            target.name,
            "Reply to",
            body,
            "border-l-4 border-blue-600",
          );
          if (target.hp <= 0) handleOpponentDefeat(target, true);
        } else if (type === "ESCALATE") {
          const d = getUnitDamage(p, "escalate");
          let totalBlocked = 0;
          let totalRecovered = 0;
          const recoverPerHit = getUnitEscalateRecover(p);
          opponents.forEach((o) => {
            if (o.hp > 0) {
              const result = applyDamage(p, o, d);
              totalBlocked += result.blocked;
              if (recoverPerHit > 0) {
                totalRecovered += recoverPerHit;
                p.hp = Math.min(totalMaxHp, p.hp + recoverPerHit);
              }
              if (o.hp <= 0) handleOpponentDefeat(o, true);
            }
          });
          let levGain = getPlayerLeverageGain(10);
          p.ult += levGain;
          const line = drawFromLineBag(
            p,
            getPlayerLineBagKey("escalate", missionId, titleId),
            getPlayerActionLines("escalate", missionId),
            "I'm escalating this for clarity across the thread.",
          );
          let body = formatMessageBody(p, line);
          if (totalBlocked > 0) {
            body += `<br><br><strong>Deflected:</strong> ${totalBlocked} reflected.`;
          }
          if (totalRecovered > 0) {
            body += `<br><br><strong>Recovered:</strong> +${totalRecovered} Credibility.`;
          }
          addEmailToLog(
            p.name,
            "everyone@gov.org",
            "Escalation Notice",
            body,
            "bg-orange-50 border-l-4 border-orange-500",
          );
        } else if (type === "DEFLECT") {
          p.deflectCharge = getUnitDeflectPower(p);
          const line = drawFromLineBag(
            p,
            getPlayerLineBagKey("deflect", missionId, titleId),
            getPlayerActionLines("deflect", missionId),
            "Holding response to keep this thread scoped and documented.",
          );
          addEmailToLog(
            p.name,
            "everyone@gov.org",
            "Holding Response",
            `${formatMessageBody(p, line)}<br><br><strong>Deflection Ready:</strong> ${p.deflectCharge}`,
            "bg-blue-50 border-l-4 border-blue-500",
          );
        } else if (type === "PROMOTE") {
          p.currentWins--;
          const promoteHeal = getUnitSelfPromoteHeal(p, 20);
          p.hp = Math.min(totalMaxHp, p.hp + promoteHeal);
          const selfPromoteLine = drawFromLineBag(
            p,
            getPlayerLineBagKey("selfPromote", missionId, titleId),
            getPlayerActionLines("selfPromote", missionId),
            "Just logging a new win—the quarterly audit came back clean under my supervision. Always happy to add value to the organization!",
          );
          addEmailToLog(
            p.name,
            "everyone@gov.org",
            "FYI: Project Milestone Met",
            selfPromoteLine,
            "bg-green-50 border-l-4 border-green-600",
          );
        } else if (type === "ULT") {
          const d = getUnitDamage(p, "replyAll");
          let totalBlocked = 0;
          opponents.forEach((o) => {
            if (o.hp > 0) {
              const result = applyDamage(p, o, d);
              totalBlocked += result.blocked;
              if (o.hp <= 0) handleOpponentDefeat(o, true);
            }
          });
          p.ult = 0;
          const replyAllLine = drawFromLineBag(
            p,
            getPlayerLineBagKey("replyAll", missionId, titleId),
            getPlayerActionLines("replyAll", missionId),
            {
              subject: "Fwd: Salary_Discrepancies_2024.xlsx",
              body: "Not sure if I should be sending this to everyone, but since transparency is one of our 'core values', here is the full salary spreadsheet for the department. Enjoy.",
            },
          );
          let replyBody = replyAllLine.body;
          if (totalBlocked > 0) {
            replyBody += `<br><br><strong>Deflected:</strong> ${totalBlocked} reflected.`;
          }
          addEmailToLog(
            p.name,
            "everyone@gov.org",
            replyAllLine.subject,
            replyBody,
            "bg-yellow-50 font-bold border-l-4 border-yellow-500",
          );
        }

        updateUI();
        if (state.player.hp <= 0) {
          state.gameOver = true;
          state.lossReason = "defeat";
          setTimeout(showLoseScreen, 3000);
          return;
        }
        if (isMissionOverdue()) {
          triggerTimeoutLoss();
          return;
        }
        setTimeout(ffaRound, 800);
      }

      function ffaRound() {
        const alive = opponents.filter((o) => o.hp > 0);
        if (alive.length === 0) return; // Handled by handleOpponentDefeat

        alive.forEach((a, idx) => {
          setTimeout(() => {
            if (a.hp <= 0 || state.gameOver) return;

            if (a.isStunned) {
              a.isStunned = false;
              addEmailToLog(
                a.name,
                "everyone@gov.org",
                "RE: (Recalled Message)",
                `I'm sorry, I seem to have lost my train of thought. What were we discussing?`,
                "italic text-gray-400",
              );
              if (idx === alive.length - 1) {
                state.isProcessing = false;
                updateUI();
              }
              return;
            }

            // Jen's first turn guarantee
            if (a.employeeId === "jen_lavallee" && a.name === "Jen LaVallee" && !a.hasDoneFirstTurn) {
              a.hasDoneFirstTurn = true;
              let pool = [...a.addressBook];
              let picks = [];
              for (let i = 0; i < 10 && pool.length > 0; i++) {
                const idx = Math.floor(Math.random() * pool.length);
                picks.push(pool.splice(idx, 1)[0]);
              }
              picks.forEach((cid) => {
                const c = CONTACTS.find((con) => con.id === cid);
                if (c) addContactBuff(a, c, a.name);
              });
              addEmailToLog(
                a.name,
                "everyone@gov.org",
                "Consensus Algorithm Initiated",
                `${a.name} loops in 10 contacts to ensure "maximum consensus".`,
                "bg-blue-50 border-l-4 border-blue-500",
              );
            }

            let pool = [
              ...alive.filter((o) => o.id !== a.id),
              {
                id: "player",
                name: state.player.name,
                email: state.player.email,
                departmentId: state.player.departmentId,
              },
            ];

            // Targeting logic: weigh opponents by department (colleagues never attack each other)
            let weights = pool.map((t) =>
              t.departmentId === a.departmentId ? 0 : 1.0,
            );
            let totalWeight = weights.reduce((acc, w) => acc + w, 0);
            let random = Math.random() * totalWeight;
            let target = pool[0];
            for (let i = 0; i < pool.length; i++) {
              random -= weights[i];
              if (random <= 0) {
                target = pool[i];
                break;
              }
            }

            if (a.redirectNext) {
              a.redirectNext = false;
              if (target.id === "player") {
                const targets = alive.filter((o) => o.id !== a.id);
                if (targets.length > 0) {
                  target = targets[Math.floor(Math.random() * targets.length)];
                  addEmailToLog(
                    a.name,
                    "everyone@gov.org",
                    "Redirected Reply",
                    `Wait, I meant to send this to <strong>${target.name}</strong> instead.`,
                    "italic text-blue-400 text-[10px]",
                  );
                }
              }
            }

            let roll = Math.random();

            a.hp = Math.min(getUnitMaxHp(a), a.hp + getUnitTotalHeal(a));

            const availFromBook = a.addressBook
              .map((id) => CONTACTS.find((con) => con.id === id))
              .filter((c) => c && !isContactInLoop(c.id) && !isContactImplicated(c));
            if (roll < 0.15 && availFromBook.length > 0) {
              const numPicks = computeUnitStats(a).numCCperCCaction;
              for (let p = 0; p < numPicks; p++) {
                const currentAvail = a.addressBook
                  .map((id) => CONTACTS.find((con) => con.id === id))
                  .filter((c) => c && !isContactInLoop(c.id) && !isContactImplicated(c));
                if (currentAvail.length === 0) break;

                const c = currentAvail[Math.floor(Math.random() * currentAvail.length)];
                addContactBuff(a, c, a.name);
                const loopInText = formatLoopInText(
                  c,
                  `I'm looping in <strong>${c.name}</strong> to ensure this thread remains within professional guidelines.`,
                );
                addEmailToLog(
                  a.name,
                  "everyone@gov.org",
                  "Looping in Support",
                  loopInText,
                  "bg-blue-50",
                );
              }
            } else if (roll < 0.3 && a.hp < 20 && a.wins > 0) {
              a.wins--;
              const promoteHeal = getUnitSelfPromoteHeal(a, 15);
              a.hp = Math.min(getUnitMaxHp(a), a.hp + promoteHeal);
              const selfPromoteLine = drawFromLineBag(
                a,
                "selfPromote",
                getUnitSelfPromoteLines(a),
                "I'm logging a significant departmental achievement. This incident shouldn't distract from real wins.",
              );
              addEmailToLog(
                a.name,
                "everyone@gov.org",
                "Self Promotion",
                formatMessageBody(a, selfPromoteLine),
                "opacity-70",
              );
            } else {
              const actionRoll = Math.random();
              if (actionRoll < 0.15 && a.deflectCharge <= 0) {
              if (a.employeeId === "jen_lavallee" && a.name === "Jen LaVallee") {
                const agentId = Math.random().toString(36).substring(2, 6).toUpperCase();
                const newAgents = [
                  {
                    id: Date.now() + Math.random(),
                    name: `AI aJENt-${agentId}`,
                    employeeId: "jen_lavallee",
                    title: "Automated Processing Unit",
                    department: "Digital Technology",
                    departmentId: "digital_technology",
                    hp: 20,
                    maxHp: 20,
                    wins: 1,
                    singleDmg: 15,
                    escalateDmg: 10,
                    numCCperCCaction: 0,
                    addressBook: [],
                    buffs: [],
                    greet: "INITIATING SUB-PROCESS...",
                    signoff: "PROCESS COMPLETE.",
                    signatures: ["[AUTOMATED SYSTEM MESSAGE]"],
                  },
                  {
                    id: Date.now() + Math.random(),
                    name: `AI aJENt-${Math.random().toString(36).substring(2, 6).toUpperCase()}`,
                    employeeId: "jen_lavallee",
                    title: "Automated Processing Unit",
                    department: "Digital Technology",
                    departmentId: "digital_technology",
                    hp: 20,
                    maxHp: 20,
                    wins: 1,
                    singleDmg: 15,
                    escalateDmg: 10,
                    numCCperCCaction: 0,
                    addressBook: [],
                    buffs: [],
                    greet: "INITIATING SUB-PROCESS...",
                    signoff: "PROCESS COMPLETE.",
                    signatures: ["[AUTOMATED SYSTEM MESSAGE]"],
                  },
                ];
                opponents.push(...newAgents);
                addEmailToLog(
                  a.name,
                  "everyone@gov.org",
                  "Automated Provisioning",
                  `I am provisioning two additional processing units: <strong>${newAgents[0].name}</strong> and <strong>${newAgents[1].name}</strong>. They will assist in managing this thread's bandwidth.`,
                  "bg-cyan-50 border-l-4 border-cyan-500",
                );
              } else {
                a.deflectCharge = getUnitDeflectPower(a);
                const deflectLine = drawFromLineBag(
                  a,
                  "deflect",
                  a.deflectLines,
                  "I'm pausing to document this thread before responding further.",
                );
                addEmailToLog(
                  a.name,
                  "everyone@gov.org",
                  "Holding Response",
                  `${formatMessageBody(a, deflectLine)}<br><br><strong>Deflection Ready:</strong> ${a.deflectCharge}`,
                  "bg-blue-50",
                );
              }
              } else if (actionRoll < 0.35) {
                const d = getUnitDamage(a, "escalate");
                let totalBlocked = 0;
                let totalRecovered = 0;
                const recoverPerHit = getUnitEscalateRecover(a);
                const escalateTargets = [
                  ...alive.filter((o) => o.id !== a.id),
                  state.player,
                ];
                escalateTargets.forEach((t) => {
                  if (t !== state.player && t.departmentId === a.departmentId)
                    return;
                  if (t.hp > 0) {
                    const result = applyDamage(a, t, d);
                    totalBlocked += result.blocked;
                    if (recoverPerHit > 0) {
                      totalRecovered += recoverPerHit;
                      a.hp = Math.min(getUnitMaxHp(a), a.hp + recoverPerHit);
                    }
                    if (t !== state.player && t.hp <= 0)
                      handleOpponentDefeat(t);
                  }
                });
                const escLine = drawFromLineBag(
                  a,
                  "attack",
                  a.attacks,
                  "I'm escalating this across the thread for visibility.",
                );
                let escBody = formatMessageBody(a, escLine);
                if (totalBlocked > 0) {
                  escBody += `<br><br><strong>Deflected:</strong> ${totalBlocked} reflected.`;
                }
                if (totalRecovered > 0) {
                  escBody += `<br><br><strong>Recovered:</strong> +${totalRecovered} Credibility.`;
                }
                addEmailToLog(
                  a.name,
                  "everyone@gov.org",
                  "Escalation Notice",
                  escBody,
                  "bg-yellow-50 border-l-4 border-yellow-400",
                );
              } else {
                let d = getUnitDamage(a, "single");

                // Select attack type
                const q = drawFromLineBag(
                  a,
                  "attack",
                  a.attacks,
                  "I'm following up to keep this thread moving.",
                );
                let body = formatMessageBody(a, q);

                const followUpChance = getUnitFollowUpChance(a);
                const followUpHit =
                  followUpChance > 0 && Math.random() < followUpChance;
                const splashDamage = getUnitReplyDeptSplash(a);
                const bounceDamage = getUnitBounceDamage(a);

                if (target.id === "player") {
                  const dodgeBuff = state.player.buffs.find(
                    (b) => b.eff.dodge && Math.random() < b.eff.dodge,
                  );
                  if (dodgeBuff) {
                    const defaultLine = `${dodgeBuff.name} distracted the thread and they didnt see this email, no effect!`;
                    const triggerText = (dodgeBuff.eff.specialTriggerText || defaultLine)
                      .replace(/{name}/g, dodgeBuff.name);
                    addEmailToLog(
                      a.name,
                      state.player.name,
                      "Urgent Follow-up",
                      body + `<br><br>(${triggerText})`,
                      "text-blue-600",
                    );
                  } else {
                    const result = applyDamage(a, state.player, d);
                    const followUpResult = followUpHit
                      ? applyDamage(a, state.player, d)
                      : null;
                    const splashResult = applyDepartmentSplash(
                      a,
                      state.player,
                      splashDamage,
                    );
                    const bounceTarget = bounceDamage
                      ? pickBounceTarget(a, state.player)
                      : null;
                    const bounceResult = bounceTarget
                      ? applyDamage(a, bounceTarget, bounceDamage, {
                          ignoreReflect: true,
                        })
                      : null;
                    if (result.blocked > 0) {
                      body += `<br><br><strong>Deflected:</strong> ${result.blocked} reflected.`;
                    }
                    if (followUpResult) {
                      body += `<br><br><strong>Follow-up Reply:</strong> -${followUpResult.dmg}.`;
                    }
                    if (splashResult.hits > 0) {
                      body += `<br><br><strong>Department Splash:</strong> ${splashResult.hits} hit for ${splashResult.total}.`;
                    }
                    if (bounceResult && bounceTarget) {
                      body += `<br><br><strong>Bounce:</strong> ${bounceTarget.name} -${bounceResult.dmg}.`;
                    }
                    addEmailToLog(
                      a.name,
                      state.player.name,
                      "Escalation",
                      body +
                        `<br><br><strong>Damage to Credibility: -${result.dmg}</strong>`,
                      "bg-red-50 border-l-2 border-red-400",
                    );
                    document
                      .getElementById("game-ui")
                      .classList.add("shaking");
                    setTimeout(
                      () =>
                        document
                          .getElementById("game-ui")
                          .classList.remove("shaking"),
                      200,
                    );
                  }
                } else {
                  const result = applyDamage(a, target, d);
                  const followUpResult = followUpHit
                    ? applyDamage(a, target, d)
                    : null;
                  const splashResult = applyDepartmentSplash(
                    a,
                    target,
                    splashDamage,
                  );
                  const bounceTarget = bounceDamage
                    ? pickBounceTarget(a, target)
                    : null;
                  const bounceResult = bounceTarget
                    ? applyDamage(a, bounceTarget, bounceDamage, {
                        ignoreReflect: true,
                      })
                    : null;
                  if (result.blocked > 0) {
                    body += `<br><br><strong>Deflected:</strong> ${result.blocked} reflected.`;
                  }
                  if (followUpResult) {
                    body += `<br><br><strong>Follow-up Reply:</strong> -${followUpResult.dmg}.`;
                  }
                  if (splashResult.hits > 0) {
                    body += `<br><br><strong>Department Splash:</strong> ${splashResult.hits} hit for ${splashResult.total}.`;
                  }
                  if (bounceResult && bounceTarget) {
                    body += `<br><br><strong>Bounce:</strong> ${bounceTarget.name} -${bounceResult.dmg}.`;
                  }
                  addEmailToLog(
                    a.name,
                    target.name,
                    "Internal Memo",
                    body +
                      `<br><br>(Targeting ${target.name}. Standing lost: ${result.dmg})`,
                    "text-gray-500 text-[11px]",
                  );
                  if (target.hp <= 0) handleOpponentDefeat(target);
                }
              }
            }

            if (a.hp <= 0) {
              handleOpponentDefeat(a);
              return;
            }

            if (state.player.hp <= 0) {
              state.gameOver = true;
              state.lossReason = "defeat";
              updateUI();
              setTimeout(showLoseScreen, 1500);
            }
          }, idx * 700);
        });

        setTimeout(() => {
          if (!state.gameOver) {
            state.isProcessing = false;
            updateUI();
          }
        }, alive.length * 700);
      }

      function finishCcAction() {
        document.getElementById("address-book").classList.add("hidden");
        updateUI();
        if (state.ccPicksTaken > 0) {
          state.turn++;
          const p = state.player;
          p.hp = Math.min(getUnitMaxHp(p), p.hp + getUnitTotalHeal(p));
          if (isMissionOverdue()) {
            triggerTimeoutLoss();
            return;
          }
          state.isProcessing = true;
          setTimeout(ffaRound, 400);
        }
      }

      function openAddressBook() {
        if (state.isProcessing || state.gameOver) return;
        state.ccPicksLeft = computeUnitStats(state.player).numCCperCCaction;
        state.ccPicksTaken = 0;
        renderAddressBook();
        document.getElementById("address-book").classList.remove("hidden");
      }

      function renderAddressBook() {
        const list = document.getElementById("contact-list");
        list.innerHTML = "";
        let titleText = `PERSONNEL DIRECTORY (${state.player.addressBook.length}/${state.player.title.addressLimit})`;
        if (state.ccPicksLeft > 1 || state.ccPicksTaken > 0) {
          titleText += ` - PICKS: ${state.ccPicksLeft}`;
        }
        document.getElementById("address-book-title").innerText = titleText;

        const cancelBtn = document.querySelector("#address-book .retro-button");
        if (cancelBtn) {
          cancelBtn.innerText = state.ccPicksTaken > 0 ? "DONE" : "CANCEL";
        }

        // CCs
        const headerCC = document.createElement("div");
        headerCC.className =
          "text-[10px] font-bold bg-gray-200 p-1 mb-1 uppercase";
        headerCC.innerText = "Address Book (Permanent CCs)";
        list.appendChild(headerCC);

        state.player.addressBook.forEach((id) => {
          const c = CONTACTS.find((con) => con.id === id);
          if (!c) return;
          const isUsed = isContactInLoop(c.id);
          const isImplicated = isContactImplicated(c);
          const isDisabled = isUsed || isImplicated;
          const usedByName = isUsed ? getContactUsedBy(c.id) : null;
          const statusText = isImplicated
            ? "IMPLICATED"
            : isUsed
              ? `IN LOOP (${usedByName === state.player.name ? "YOU" : usedByName || "OTHER"})`
              : "AVAIL";
          const setBadge = c.setId
            ? `<button type="button" data-set-button data-set-id="${c.setId}" class="text-[9px] uppercase px-1 py-0.5 rounded-sm bg-blue-100 text-blue-700 font-bold">Set</button>`
            : "";
          const btn = document.createElement("div");
          btn.className = `p-2 border border-gray-300 flex flex-col ${isDisabled ? "opacity-40 grayscale bg-gray-100" : "cursor-pointer hover:bg-blue-50"}`;
          btn.innerHTML = `<div class="flex justify-between font-bold text-[#000080] text-xs"><span>${c.name} - ${c.title}</span><span class="text-[9px]">${statusText}</span></div><div class="flex items-center gap-2 text-[10px] italic">${c.bonus || ""}${setBadge}</div>`;
          btn.querySelectorAll("[data-set-button]").forEach((setBtn) => {
            setBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              openSetInfo(setBtn.dataset.setId);
            });
          });
          if (!isDisabled)
            btn.onclick = () => {
              addContactBuff(state.player, c, state.player.name);
              const loopInText = formatLoopInText(
                c,
                `I'm looping in <strong>${c.name}</strong> (${c.title}) to help clarify the organizational impact of this thread.`,
              );
              addEmailToLog(
                state.player.name,
                "everyone@gov.org",
                "Looping in Witness",
                loopInText,
                "bg-blue-100 font-bold border-l-4 border-blue-500",
              );
              state.ccPicksTaken++;
              state.ccPicksLeft--;

              const nextAvail = state.player.addressBook.some((cid) => {
                const con = CONTACTS.find((con) => con.id === cid);
                return con && !isContactInLoop(con.id) && !isContactImplicated(con);
              }) || state.player.bccContacts.length > 0;

              if (state.ccPicksLeft <= 0 || !nextAvail) {
                finishCcAction();
              } else {
                renderAddressBook();
              }
            };
          list.appendChild(btn);
        });

        // BCCs
        if (state.player.bccContacts.length > 0) {
          const headerBCC = document.createElement("div");
          headerBCC.className =
            "text-[10px] font-bold bg-gray-200 p-1 mt-4 mb-1 uppercase";
          headerBCC.innerText = "Help Desk Contacts (BCC Consumables)";
          list.appendChild(headerBCC);

          state.player.bccContacts.forEach((b, idx) => {
            const btn = document.createElement("div");
            btn.className = `p-2 border border-gray-300 flex flex-col cursor-pointer hover:bg-yellow-50`;
            btn.innerHTML = `<div class="flex justify-between font-bold text-yellow-800 text-xs"><span>${b.name}</span><span class="text-[9px]">BCC</span></div><div class="text-[10px] italic">${b.bonus}</div>`;
            btn.onclick = () => {
              useBcc(b, idx);
            };
            list.appendChild(btn);
          });
        }
      }

      function useBcc(bcc, index) {
        state.player.bccContacts.splice(index, 1);
        let logContent = bcc.logText || bcc.bonus;
        logContent = logContent.replace(/{playerName}/g, state.player.name);

        addEmailToLog(
          state.player.name,
          "everyone@gov.org",
          `BCC: ${bcc.name}`,
          `[PRIVATE MESSAGE] Sent: ${logContent}`,
          "bg-yellow-100 border-l-4 border-yellow-600",
        );

        if (bcc.effect === "stun") {
          const target = opponents.find((o) => o.id === state.targetId);
          target.isStunned = true;
          addEmailToLog(
            "SYSTEM",
            state.player.name,
            "Message Recalled",
            `${target.name}'s next turn will be skipped.`,
            "italic text-gray-500 text-[10px]",
          );
        } else if (bcc.effect === "doubleDmg") {
          state.player.nextAttackMult = 2;
          addEmailToLog(
            "SYSTEM",
            state.player.name,
            "Urgent Flag Set",
            `Your next reply to will deal 2x damage.`,
            "italic text-gray-500 text-[10px]",
          );
        } else if (bcc.effect === "redirect") {
          opponents.forEach((o) => {
            if (o.hp > 0) o.redirectNext = true;
          });
          addEmailToLog(
            "SYSTEM",
            state.player.name,
            "Message Redirected",
            `Anyone targeting you will be redirected next turn.`,
            "italic text-gray-500 text-[10px]",
          );
        } else if (bcc.effect === "doubleRep") {
          state.expenseReportActive = true;
          addEmailToLog(
            "SYSTEM",
            state.player.name,
            "Expense Report Logged",
            `Mission base reputation will be doubled (max +10 bonus).`,
            "italic text-gray-500 text-[10px]",
          );
        } else if (bcc.effect === "contactRep") {
          let total = 0;
          state.player.buffs.forEach((b) => {
            const buyValue = getItemCostByType(b.rarity || 'common', 'contact');
            total += Math.floor(buyValue / 2);
          });
          total = Math.min(30, total);
          state.player.reputation += total;
          addEmailToLog(
            "SYSTEM",
            state.player.name,
            "Networking Success",
            `Gained +${total} reputation from your current CC'd contacts' sell value (capped at 30).`,
            "italic text-gray-500 text-[10px]",
          );
        } else if (bcc.effect === "trainContact") {
          if (state.player.buffs.length > 0) {
            const b =
              state.player.buffs[
                Math.floor(Math.random() * state.player.buffs.length)
              ];
            if (!b.eff) b.eff = {};
            b.eff.singleDmg = (b.eff.singleDmg || 0) + 5;
            b.eff.escalateDmg = (b.eff.escalateDmg || 0) + 3;
            b.eff.maxHp = (b.eff.maxHp || 0) + 10;
            state.player.hp = Math.min(
              getUnitMaxHp(state.player),
              state.player.hp + 10,
            );
            addEmailToLog(
              "SYSTEM",
              state.player.name,
              "Mentorship Program",
              `Trained <strong>${b.name}</strong>! They gained +5 reply to, +3 escalate, and +10 Max HP.`,
              "italic text-gray-500 text-[10px]",
            );
          } else {
            addEmailToLog(
              "SYSTEM",
              state.player.name,
              "Mentorship Failed",
              `No contacts currently CC'd to train.`,
              "italic text-gray-500 text-[10px]",
            );
          }
        } else if (bcc.effect === "randomContact") {
          const p = state.player;
          const pool = CONTACTS.filter(
            (c) => !p.addressBook.includes(c.id) && !c.noShop,
          );
          const picked = pickWeighted(pool, 1)[0];
          if (picked) {
            addContactBuff(p, picked, p.name);
            const loopInText = formatLoopInText(
              picked,
              `I'm looping in <strong>${picked.name}</strong> (${picked.title}) to help clarify the organizational impact of this thread.`,
            );
            if (p.addressBook.length < p.title.addressLimit) {
              p.addressBook.push(picked.id);
              addEmailToLog(
                p.name,
                "everyone@gov.org",
                "New Referral",
                `${loopInText}<br><br><strong>${picked.name}</strong> has been permanently added to your address book.`,
                "bg-blue-100 font-bold border-l-4 border-blue-500",
              );
            } else {
              addEmailToLog(
                p.name,
                "everyone@gov.org",
                "Temporary Referral",
                `${loopInText}<br><br>Your address book is at capacity (${p.title.addressLimit}). <strong>${picked.name}</strong> has been looped in for this thread only.`,
                "bg-blue-100 font-bold border-l-4 border-blue-500",
              );
            }
          } else {
            addEmailToLog(
              "SYSTEM",
              p.name,
              "No Referrals Available",
              "There are no new contacts currently available for referral.",
              "italic text-gray-500 text-[10px]",
            );
          }
        }

        state.ccPicksTaken++;
        state.ccPicksLeft--;

        const nextAvail = state.player.addressBook.some((cid) => {
          const con = CONTACTS.find((con) => con.id === cid);
          return con && !isContactInLoop(con.id) && !isContactImplicated(con);
        }) || state.player.bccContacts.length > 0;

        if (state.ccPicksLeft <= 0 || !nextAvail) {
          finishCcAction();
        } else {
          renderAddressBook();
        }
      }

      function closeAddressBook() {
        if (state.ccPicksTaken > 0) {
          finishCcAction();
        } else {
          document.getElementById("address-book").classList.add("hidden");
        }
      }
    </script>
  </body>
</html>
