<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>REPLY ALL - The Microwave Incident</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /**
         * FUNCTIONALITY CATALOG:
         * 1. Turn-based FFA Loop: Logic preserved.
         * 2. Targeting: TargetId state mapped to "To:" field.
         * 3. Actions: ATTACK (Circle Back), SELF-PROMOTE (New Wins/Heal), ULT (Reply All), CC (Summon/Buff).
         * 4. Address Book: Modal system for assigning permanent buffs.
         * 5. Personality: Specific attack types (Compliance, Value, Time, Accusatory).
         */
        :root {
            --win-grey: #c0c0c0;
            --win-blue: #000080;
            --win-border-light: #ffffff;
            --win-border-dark: #404040;
        }
        body { font-family: 'Inter', sans-serif; background-color: #008080; height: 100dvh; overflow: hidden; touch-action: manipulation; color: black; }
        .retro-border { border-top: 2px solid var(--win-border-light); border-left: 2px solid var(--win-border-light); border-bottom: 2px solid var(--win-border-dark); border-right: 2px solid var(--win-border-dark); }
        .retro-border-inset { border-top: 2px solid var(--win-border-dark); border-left: 2px solid var(--win-border-dark); border-bottom: 2px solid var(--win-border-light); border-right: 2px solid var(--win-border-light); }
        .retro-button { background: var(--win-grey); border-top: 2px solid var(--win-border-light); border-left: 2px solid var(--win-border-light); border-bottom: 2px solid var(--win-border-dark); border-right: 2px solid var(--win-border-dark); padding: 4px 8px; cursor: pointer; user-select: none; }
        .retro-button:active:not(:disabled) { border-top: 2px solid var(--win-border-dark); border-left: 2px solid var(--win-border-dark); border-bottom: 2px solid var(--win-border-light); border-right: 2px solid var(--win-border-light); padding-top: 5px; padding-bottom: 3px; }
        .retro-button:disabled { color: #808080; cursor: not-allowed; opacity: 0.6; }
        .terminal-font { font-family: 'VT323', monospace; }
        @keyframes shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(-3px, 3px); } 50% { transform: translate(3px, -3px); } 75% { transform: translate(-3px, -3px); } }
        .shaking { animation: shake 0.2s ease-in-out infinite; }
        .scroll-container::-webkit-scrollbar { width: 14px; }
        .scroll-container::-webkit-scrollbar-track { background: #dfdfdf; }
        .scroll-container::-webkit-scrollbar-thumb { background: var(--win-grey); border: 2px solid var(--win-border-light); box-shadow: inset -1px -1px 0 var(--win-border-dark); }
        .target-pill { transition: all 0.2s; border: 1px solid #808080; }
        .target-pill.active { background: #000080 !important; color: white !important; border-color: #ffffff; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .message-entry { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .email-header { background: #e8e8e8; border-bottom: 1px solid #ccc; font-family: sans-serif; font-size: 11px; color: #444; }
        .email-body { padding: 12px 0; line-height: 1.5; color: #111; }
    </style>
</head>
<body class="flex items-center justify-center p-0 md:p-2">

    <!-- INBOX SCREEN -->
    <div id="inbox-screen" class="hidden fixed inset-0 z-[90] flex items-center justify-center bg-[#008080] p-4">
        <div class="bg-[#c0c0c0] retro-border max-w-2xl w-full h-[80dvh] flex flex-col shadow-2xl">
            <div class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs">
                <span>Outlook Express - Inbox</span>
                <div class="flex gap-1">
                    <button class="w-4 h-4 bg-[#c0c0c0] text-black text-[10px] flex items-center justify-center">_</button>
                    <button class="w-4 h-4 bg-[#c0c0c0] text-black text-[10px] flex items-center justify-center">X</button>
                </div>
            </div>
            <div class="bg-[#dfdfdf] border-b border-[#808080] p-1 flex gap-2 text-[10px]">
                <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">File</button>
                <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">Edit</button>
                <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">View</button>
                <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">Tools</button>
                <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">Message</button>
                <button class="px-2 py-0.5 retro-border bg-[#c0c0c0]">Help</button>
            </div>
            <div class="flex-grow flex overflow-hidden">
                <div class="w-32 bg-[#dfdfdf] border-r border-[#808080] p-2 text-[10px] hidden sm:block">
                    <div class="font-bold mb-2">Folders</div>
                    <div class="pl-2 space-y-1">
                        <div class="bg-blue-800 text-white px-1">Inbox</div>
                        <div>Outbox</div>
                        <div>Sent Items</div>
                        <div>Deleted Items</div>
                        <div>Spam</div>
                    </div>
                </div>
                <div class="flex-grow flex flex-col bg-white overflow-hidden">
                    <div class="bg-[#f0f0f0] border-b border-[#808080] grid grid-cols-12 text-[9px] font-bold p-1">
                        <div class="col-span-1">!</div>
                        <div class="col-span-5">From</div>
                        <div class="col-span-6">Subject</div>
                    </div>
                    <div id="inbox-list" class="flex-grow overflow-y-auto overflow-x-hidden text-[11px] divide-y divide-gray-100">
                        <!-- Emails will be injected here -->
                    </div>
                </div>
            </div>
            <div class="bg-[#dfdfdf] border-t border-[#808080] p-1 text-[10px] flex justify-between">
                <div id="inbox-status">324 Messages, 1 Unread</div>
                <div class="flex gap-4">
                    <span>Working Online</span>
                </div>
            </div>
        </div>
    </div>

    <!-- SUMMARY SCREEN (Performance Metrics) -->
    <div id="summary-screen" class="hidden fixed inset-0 z-[120] bg-black/60 flex items-center justify-center p-4">
        <div class="bg-[#c0c0c0] retro-border max-w-xs w-full shadow-2xl overflow-hidden">
            <div class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold">
                <span>ARCHIVED THREAD</span>
                <span>✕</span>
            </div>
            <div class="p-4 flex flex-col items-center">
                <div class="w-16 h-16 bg-yellow-400 retro-border flex items-center justify-center mb-4">
                    <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13zM7 13a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13z" clip-rule="evenodd"></path></svg>
                </div>
                <h2 class="text-xl font-bold terminal-font mb-2">PERFORMANCE METRICS</h2>
                <div class="w-full bg-white retro-border-inset p-3 space-y-2 text-xs mb-4">
                    <div class="flex justify-between">
                        <span>Base Mission Reward:</span>
                        <span id="summary-base-rep" class="font-mono">+4</span>
                    </div>
                    <div id="summary-optouts-list" class="space-y-1 py-1 border-y border-gray-100 hidden">
                        <!-- Individual opt-outs injected here -->
                    </div>
                    <div class="flex justify-between">
                        <span>Additional Bonuses:</span>
                        <span id="summary-bonus-rep" class="font-mono">+0</span>
                    </div>
                    <div class="border-t border-gray-300 pt-2 flex justify-between font-bold text-[#000080]">
                        <span>TOTAL REP EARNED:</span>
                        <span id="summary-rep-earned" class="font-mono text-lg">+0</span>
                    </div>
                </div>
                <button onclick="showShop()" class="w-full py-2 retro-button font-bold text-sm">GO TO PORTAL</button>
            </div>
        </div>
    </div>

    <!-- SHOP SCREEN (HR Self-Service Portal) -->
    <div id="shop-screen" class="hidden fixed inset-0 z-[130] bg-[#008080] p-4 flex flex-col items-center overflow-y-auto">
        <div class="bg-[#c0c0c0] retro-border w-full max-w-4xl shadow-2xl flex flex-col min-h-0">
            <div class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold shrink-0">
                <span>INTRA-NET: EMPLOYEE BENEFITS & GROWTH</span>
                <span id="shop-reputation-display" class="bg-yellow-400 text-black px-2 rounded-sm ml-auto mr-4">REP: 0</span>
                <button onclick="advanceToNextQuarter()" class="retro-button text-black text-[10px] py-0 px-2 h-4">NEXT QUARTER &gt;</button>
            </div>
            <div class="bg-[#f0f0f0] p-4 flex-grow overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Seminars (CCs) -->
                    <div class="space-y-2">
                        <h3 class="text-xs font-bold uppercase border-b border-[#808080] pb-1">Enroll in Seminar (Address Book)</h3>
                        <div id="shop-seminars" class="space-y-2"></div>
                    </div>
                    <!-- Signatures -->
                    <div class="space-y-2">
                        <h3 class="text-xs font-bold uppercase border-b border-[#808080] pb-1">Update Email Signature</h3>
                        <div id="shop-signatures" class="space-y-2"></div>
                    </div>
                    <!-- Salutations -->
                    <div class="space-y-2">
                        <h3 class="text-xs font-bold uppercase border-b border-[#808080] pb-1">Select Salutation</h3>
                        <div id="shop-salutations" class="space-y-2"></div>
                    </div>
                    <!-- Sign-offs -->
                    <div class="space-y-2">
                        <h3 class="text-xs font-bold uppercase border-b border-[#808080] pb-1">Select Sign-off</h3>
                        <div id="shop-signoffs" class="space-y-2"></div>
                    </div>
                    <!-- Self Promotion -->
                    <div class="space-y-2">
                        <h3 class="text-xs font-bold uppercase border-b border-[#808080] pb-1">Self-Promotion (Stats)</h3>
                        <div id="shop-promotions" class="space-y-2"></div>
                    </div>
                    <!-- Help Desk (BCCs) -->
                    <div class="space-y-2">
                        <h3 class="text-xs font-bold uppercase border-b border-[#808080] pb-1">Help Desk Contacts (BCCs)</h3>
                        <div id="shop-bccs" class="space-y-2"></div>
                    </div>
                </div>
            </div>
            <div class="bg-[#dfdfdf] border-t border-[#808080] p-2 text-[10px] text-center italic text-gray-600 shrink-0">
                Corporate policy: All purchases are final and non-refundable.
            </div>
        </div>
    </div>

    <!-- LOSE SCREEN (Termination Notice) -->
    <div id="lose-screen" class="hidden fixed inset-0 z-[150] bg-black flex items-center justify-center p-4">
        <div class="bg-[#c0c0c0] retro-border max-w-sm w-full shadow-2xl overflow-hidden">
            <div class="bg-red-800 text-white px-2 py-1 flex justify-between items-center text-xs font-bold">
                <span>SYSTEM LOCKOUT - SECURITY BREACH</span>
                <span>✕</span>
            </div>
            <div class="p-6 flex flex-col items-center">
                <div class="w-16 h-16 bg-red-600 retro-border flex items-center justify-center mb-6">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>

                <h2 class="text-2xl font-bold terminal-font mb-4 text-red-800">NOTICE OF TERMINATION</h2>

                <div class="w-full bg-white retro-border-inset p-4 space-y-3 text-[11px] mb-6 leading-tight">
                    <p class="font-bold text-center border-b pb-2 mb-2">Final Employee Records</p>
                    <div class="flex justify-between">
                        <span class="text-gray-500 uppercase">Final Title:</span>
                        <span id="lose-title" class="font-bold">Cubicle Resident</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500 uppercase">Period:</span>
                        <span id="lose-period" class="font-bold">Q3 - Year 1</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500 uppercase">Total Reputation:</span>
                        <span id="lose-total-rep" class="font-bold">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500 uppercase">Address Book:</span>
                        <span id="lose-contacts" class="font-bold">0 Contacts</span>
                    </div>
                </div>

                <div class="text-[12px] text-center italic text-gray-800 px-2 leading-relaxed">
                    "Credibility is of utmost importance for ECO staff. As a result of correspondence recently brought to our attention, your role here has come to an end."
                </div>

                <div class="mt-8 text-[10px] text-gray-500 uppercase tracking-widest animate-pulse">
                    Access Revoked. See Security.
                </div>
            </div>
        </div>
    </div>

    <!-- PROMOTION SCREEN -->
    <div id="promotion-screen" class="hidden fixed inset-0 z-[140] bg-white flex items-center justify-center p-8 overflow-y-auto">
        <div class="max-w-xl w-full border-8 border-double border-gray-300 p-8 flex flex-col items-center bg-[#fffcf0] shadow-xl relative">
            <div class="absolute top-4 right-4 text-xs font-mono text-gray-400">INTERNAL MEMO #882-B</div>
            <div class="text-3xl font-serif font-bold text-[#000080] mb-2">OFFICE OF THE DIRECTOR</div>
            <div class="w-full border-b-2 border-[#000080] mb-8"></div>

            <h1 class="text-4xl font-serif font-bold text-center mb-8 uppercase tracking-widest">Notice of Promotion</h1>

            <p class="mb-4 text-lg leading-relaxed first-letter:text-5xl first-letter:font-bold first-letter:float-left first-letter:mr-2">
                After a thorough review of your performance metrics during the previous fiscal quarters, the Board of Directors has approved your advancement within the organization.
            </p>

            <div class="my-8 text-center p-6 border-2 border-dashed border-[#000080] bg-blue-50 w-full">
                <div class="text-sm font-bold uppercase text-gray-500 mb-1">New Assignment:</div>
                <div id="promotion-new-title" class="text-3xl font-bold text-[#000080] mb-4">SENIOR OPERATIONS ANALYST</div>

                <div class="text-xs font-bold uppercase text-gray-500 mb-2">Acquired Executive Perks:</div>
                <div id="promotion-perks" class="text-sm italic text-gray-700">+1 Signature Slot, +5 Base Damage</div>
            </div>

            <p class="mb-12 text-center text-gray-600 italic">"Efficiency is its own reward."</p>

            <button onclick="startQuarter()" class="px-12 py-4 bg-[#000080] text-white font-bold hover:bg-blue-700 transition-colors shadow-lg">RE-LOG TO INTRANET</button>

            <div class="mt-8 opacity-20 grayscale">
                <img src="https://api.placeholder.com/100/100" class="w-20 h-20" alt="Corporate Seal">
            </div>
        </div>
    </div>

    <!-- START SCREEN -->
    <div id="start-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-[#008080] p-4">
        <div class="bg-[#c0c0c0] p-4 retro-border max-w-sm w-full shadow-2xl">
            <div class="bg-[#000080] text-white px-2 py-1 mb-4 flex justify-between items-center text-xs">
                <span>NEW USER SETUP</span>
                <span>✕</span>
            </div>
            <h1 class="text-4xl font-bold mb-2 text-center terminal-font tracking-widest text-[#000080]">REPLY ALL</h1>
            <p class="mb-4 text-[11px] text-center leading-tight italic">"The path to being at peace is long and full of micro-agressions."</p>
            
            <div class="space-y-3 mb-6">
                <div>
                    <label class="block text-[10px] font-bold uppercase mb-1">Full Name:</label>
                    <input id="player-name-input" type="text" placeholder="eke vdh" class="w-full p-2 bg-white retro-border-inset outline-none text-sm">
                </div>
                <div>
                    <label class="block text-[10px] font-bold uppercase mb-1">Email:</label>
                    <div id="email-preview" class="text-[11px] font-mono text-gray-800 bg-white/50 p-2 border border-dotted border-gray-400">...</div>
                </div>
            </div>
            
            <button onclick="startGame()" class="w-full py-3 font-bold retro-button text-[#000080]">LOG ON</button>
        </div>
    </div>

    <!-- MAIN GAME INTERFACE -->
    <div id="game-ui" class="hidden flex flex-col w-full h-full max-w-5xl bg-[#c0c0c0] retro-border overflow-hidden">
        <div class="bg-[#000080] text-white p-1 flex justify-between items-center shrink-0">
            <div class="flex items-center gap-2 px-1">
                <span id="game-header-subject" class="text-xs font-bold truncate">Outlook Express - [RE: URGENT: Breakroom Smell]</span>
                <span id="game-quarter-display" class="text-[10px] bg-white text-blue-900 px-1 font-bold">Q3 - YEAR 1</span>
            </div>
            <div class="flex gap-1 pr-1">
                <button class="w-4 h-4 bg-[#c0c0c0] border border-white text-black text-[10px] flex items-center justify-center">_</button>
                <button class="w-4 h-4 bg-[#c0c0c0] border border-white text-black text-[10px] flex items-center justify-center">X</button>
            </div>
        </div>

        <div class="flex gap-1 p-1 bg-[#c0c0c0] border-b border-[#808080] overflow-x-auto shrink-0 no-scrollbar">
            <button class="retro-button text-[10px] font-bold flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 10l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V10z"></path></svg>
                Inbox
            </button>
            <button class="retro-button text-[10px]">Mark as Read</button>
            <div class="flex-grow"></div>
            <div id="turn-clock" class="text-[10px] bg-white px-2 py-1 retro-border-inset font-mono">09:00 AM</div>
        </div>

        <div class="flex flex-grow overflow-hidden relative">
            <div class="hidden md:flex w-48 bg-[#dfdfdf] border-r border-[#808080] flex-col shrink-0">
                <div class="p-2 text-[10px] font-bold border-b border-[#808080]">Folders</div>
                <div class="p-2 space-y-1 text-[11px]">
                    <div class="bg-blue-800 text-white px-1">Inbox (5)</div>
                    <div class="px-1 text-gray-500">Promotions (3)</div>
                    <div class="px-1">Sent Items</div>
                    <div class="px-1">Deleted</div>
                </div>
            </div>

            <div class="flex-grow flex flex-col bg-white overflow-hidden">
                <!-- Bureaucratic Header -->
                <div class="p-2 bg-[#f0f0f0] border-b border-[#808080] text-[10px] shrink-0 space-y-1">
                    <div class="flex items-center gap-2">
                        <span class="font-bold w-12 text-right">To:</span>
                        <div id="target-selector" class="flex gap-1 overflow-x-auto no-scrollbar py-0.5"></div>
                    </div>
                    <div class="flex gap-2 items-center" id="active-ccs">
                        <span class="font-bold w-12 text-right">CC:</span> 
                        <div id="cc-display" class="flex gap-1 text-gray-400 italic">No one in loop.</div>
                    </div>
                </div>

                <!-- Message Log -->
                <div id="message-log" class="flex-grow overflow-y-auto p-3 space-y-6 scroll-container bg-white font-sans text-sm"></div>

                <!-- STATS BAR -->
                <div class="bg-[#dfdfdf] border-t border-[#808080] px-2 py-1.5 flex flex-col gap-1 shrink-0">
                    <div class="flex justify-between items-end">
                        <span class="text-[9px] font-bold uppercase text-[#000080]">Professional Credibility</span>
                        <span id="player-hp-label" class="text-[9px] font-mono font-bold">100/100</span>
                    </div>
                    <div class="h-3.5 w-full bg-white border border-[#808080] relative">
                        <div id="player-hp-fill" class="h-full bg-green-500 transition-all duration-300" style="width: 100%"></div>
                    </div>
                    <div class="flex justify-between items-center mt-0.5">
                        <div class="flex gap-3">
                             <div class="flex items-center gap-1">
                                <span class="text-[8px] font-bold uppercase opacity-60">Leverage:</span>
                                <div class="w-16 h-1.5 bg-white border border-[#808080]">
                                    <div id="player-ult-fill" class="h-full bg-yellow-400 transition-all" style="width: 0%"></div>
                                </div>
                             </div>
                        </div>
                        <div id="player-win-status" class="text-[8px] font-bold bg-[#c0c0c0] px-1 border border-inset border-white uppercase">New Wins: 3 Available</div>
                    </div>
                </div>

                <!-- Action Panel -->
                <div class="p-2 bg-[#c0c0c0] border-t-2 border-white shrink-0">
                    <div class="grid grid-cols-2 gap-1.5 max-w-lg mx-auto">
                        <button onclick="performAction('ATTACK')" class="retro-button py-2 flex flex-col items-center">
                            <span class="text-[11px] font-bold">Circle Back</span>
                            <span id="attack-subtext" class="text-[8px] opacity-70 italic">Target Reply</span>
                        </button>
                        <button onclick="openAddressBook()" class="retro-button py-2 flex flex-col items-center">
                            <span class="text-[11px] font-bold">Loop Personnel</span>
                            <span id="loop-subtext" class="text-[8px] opacity-70 italic">Add Witness</span>
                        </button>
                        <button id="win-btn" onclick="performAction('PROMOTE')" class="retro-button py-2 flex flex-col items-center">
                            <span class="text-[11px] font-bold">Self-Promote</span>
                            <span id="promote-subtext" class="text-[8px] opacity-70 italic">Log a Win</span>
                        </button>
                        <button id="reply-all-btn" onclick="performAction('ULT')" class="retro-button py-2 flex flex-col items-center disabled:opacity-50" disabled>
                            <span class="text-[11px] font-bold text-red-800">REPLY ALL</span>
                            <span id="ult-subtext" class="text-[8px] opacity-70 italic">Mass Takedown</span>
                        </button>
                    </div>
                </div>
                
                <div class="bg-[#c0c0c0] border-t border-white px-1 flex gap-px text-[9px] h-5 shrink-0">
                    <div class="retro-border-inset px-2 flex items-center flex-grow truncate" id="status-bar-name">Logged Out</div>
                    <div class="retro-border-inset px-2 flex items-center w-24 justify-center" id="status-bar-email">Online</div>
                    <div class="retro-border-inset px-2 flex items-center w-12 justify-center">NUM</div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: ADDRESS BOOK -->
    <div id="address-book" class="fixed inset-0 z-[110] bg-black/50 items-center justify-center p-4 hidden flex">
        <div class="bg-[#c0c0c0] retro-border w-full max-w-sm shadow-2xl">
            <div class="bg-[#000080] text-white px-2 py-1 flex justify-between items-center text-xs font-bold">
                <span>PERSONNEL DIRECTORY</span>
                <button onclick="closeAddressBook()" class="px-1">✕</button>
            </div>
            <div id="contact-list" class="max-h-64 overflow-y-auto p-2 space-y-2 bg-white"></div>
            <div class="p-2 flex justify-end bg-[#c0c0c0]">
                <button onclick="closeAddressBook()" class="retro-button text-xs px-4">CANCEL</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
// --- DATA ---

const CONTACTS = [
    {
        "id": "intern",
        "name": "Kevin",
        "title": "HR Assistant",
        "rarity": "common",
        "department": "Human Resources",
        "bonus": "+3 attack potency.",
        "eff": {
            "dmg": 3
        },
        "usedBy": null
    },
    {
        "id": "it",
        "name": "Pradeep",
        "title": "IT Specialist",
        "rarity": "common",
        "department": "Information Technology",
        "bonus": "+5 credibility/turn.",
        "eff": {
            "heal": 5
        },
        "usedBy": null
    },
    {
        "id": "legal",
        "name": "Sarah",
        "title": "Legal Counsel",
        "rarity": "uncommon",
        "department": "Legal Compliance",
        "bonus": "20% DMG Reduction.",
        "eff": {
            "def": 0.2
        },
        "usedBy": null
    },
    {
        "id": "ceo",
        "name": "Arthur",
        "title": "Chief of Staff",
        "rarity": "rare",
        "department": "Executive Council Office",
        "bonus": "2x Leverage gain.",
        "eff": {
            "lev": 2
        },
        "usedBy": null
    },
    {
        "id": "cat",
        "name": "Mittens",
        "title": "Office Cat",
        "rarity": "rare",
        "department": "Facilities and Administration",
        "bonus": "35% Distraction chance.",
        "eff": {
            "dodge": 0.35
        },
        "usedBy": null
    },
    {
        "id": "mktg",
        "name": "Becky",
        "title": "Comms Officer",
        "rarity": "uncommon",
        "department": "Communications",
        "bonus": "+5 attack potency.",
        "eff": {
            "dmg": 5
        },
        "usedBy": null
    },
    {
        "id": "audit",
        "name": "Mr. Henderson",
        "title": "Senior Auditor",
        "rarity": "uncommon",
        "department": "Finance",
        "bonus": "30% DMG Reduction.",
        "eff": {
            "def": 0.3
        },
        "usedBy": null
    },
    {
        "id": "facilities",
        "name": "Mike",
        "title": "Facilities Lead",
        "rarity": "common",
        "department": "Facilities and Administration",
        "bonus": "10% DMG Reduction & +3 Credibility/turn",
        "eff": {
            "def": 0.1,
            "heal": 3
        },
        "usedBy": null
    },
    {
        "id": "liaison",
        "name": "Constituent Liaison",
        "title": "Public Relations",
        "rarity": "rare",
        "department": "Constituent Services",
        "bonus": "No combat bonus, but +4 REP if in loop at end of match.",
        "eff": {
            "endRep": 4
        },
        "usedBy": null
    },
    {
        "id": "policy_cc",
        "name": "Gemma",
        "title": "Policy Analyst",
        "rarity": "uncommon",
        "department": "Policy",
        "bonus": "15% DMG Reduction.",
        "eff": {
            "def": 0.15
        },
        "usedBy": null
    },
    {
        "id": "finance_cc",
        "name": "Marcus",
        "title": "Budget Controller",
        "rarity": "uncommon",
        "department": "Finance",
        "bonus": "+5 HP and +5 Credibility/turn.",
        "eff": {
            "hpBonus": 5,
            "heal": 5
        },
        "usedBy": null
    },
    {
        "id": "const_cc",
        "name": "Elena",
        "title": "Public Liaison",
        "rarity": "rare",
        "department": "Constituent Services",
        "bonus": "+5 DMG and +1 REP if in loop at end of match.",
        "eff": {
            "dmg": 5,
            "endRep": 1
        },
        "usedBy": null
    }
];

const TITLES = [
    {
        "name": "Cubicle Resident",
        "level": 1,
        "addressLimit": 5,
        "sigLimit": 1,
        "hpBonus": 0,
        "dmgBonus": 0
    },
    {
        "name": "Junior Clerk",
        "level": 2,
        "addressLimit": 5,
        "sigLimit": 1,
        "hpBonus": 10,
        "dmgBonus": 2
    },
    {
        "name": "Senior Clerk",
        "level": 3,
        "addressLimit": 6,
        "sigLimit": 1,
        "hpBonus": 20,
        "dmgBonus": 4
    },
    {
        "name": "Program Coordinator",
        "level": 4,
        "addressLimit": 6,
        "sigLimit": 2,
        "hpBonus": 30,
        "dmgBonus": 6
    },
    {
        "name": "Assistant Director",
        "level": 5,
        "addressLimit": 7,
        "sigLimit": 2,
        "hpBonus": 40,
        "dmgBonus": 8
    },
    {
        "name": "Deputy Director",
        "level": 6,
        "addressLimit": 7,
        "sigLimit": 2,
        "hpBonus": 50,
        "dmgBonus": 10
    },
    {
        "name": "Director",
        "level": 7,
        "addressLimit": 8,
        "sigLimit": 3,
        "hpBonus": 60,
        "dmgBonus": 12
    },
    {
        "name": "Commissioner",
        "level": 8,
        "addressLimit": 8,
        "sigLimit": 3,
        "hpBonus": 70,
        "dmgBonus": 14
    },
    {
        "name": "Council Member",
        "level": 9,
        "addressLimit": 10,
        "sigLimit": 3,
        "hpBonus": 80,
        "dmgBonus": 16
    }
];

const SIGNATURES = [
    {
        "id": "iphone",
        "name": "Sent from my iPhone",
        "bonus": "Gain 1 rep for each person who removes themselves that you did not instigate.",
        "rarity": "common",
        "repBonus": 1
    },
    {
        "id": "regards",
        "name": "Kind Regards,",
        "bonus": "Reduce all incoming damage by 5%.",
        "rarity": "common",
        "def": 0.05
    },
    {
        "id": "per_my_last",
        "name": "Per my last email,",
        "bonus": "Increase reply strength by 10%.",
        "rarity": "uncommon",
        "dmgMult": 0.1
    },
    {
        "id": "best",
        "name": "Best,",
        "bonus": "Heal 2 HP every turn.",
        "rarity": "uncommon",
        "heal": 2
    },
    {
        "id": "thanks_advance",
        "name": "Thanks in advance,",
        "bonus": "25% chance to double leverage gain.",
        "rarity": "rare",
        "doubleLevChance": 0.25
    },
    {
        "id": "encrypted",
        "name": "Sent from my encrypted workstation",
        "bonus": "5% DMG Reduction.",
        "rarity": "common",
        "def": 0.05
    },
    {
        "id": "disclaimer",
        "name": "Standard Disclaimer Applied",
        "bonus": "Increase reply strength by 5%.",
        "rarity": "common",
        "dmgMult": 0.05
    },
    {
        "id": "breakroom",
        "name": "Sent from the breakroom",
        "bonus": "+2 Credibility/turn.",
        "rarity": "uncommon",
        "heal": 2
    }
];

const SALUTATIONS = [
    {
        "id": "hi_all",
        "name": "Hi all,",
        "bonus": "+5 Max HP",
        "rarity": "common",
        "hpBonus": 5
    },
    {
        "id": "team",
        "name": "Team,",
        "bonus": "+2 DMG",
        "rarity": "common",
        "dmgBonus": 2
    },
    {
        "id": "colleagues",
        "name": "Dear Colleagues,",
        "bonus": "+5% DMG Reduction",
        "rarity": "uncommon",
        "def": 0.05
    },
    {
        "id": "everyone",
        "name": "Everyone,",
        "bonus": "+10% Leverage gain",
        "rarity": "uncommon",
        "levMult": 0.1
    },
    {
        "id": "formal",
        "name": "To whom it may concern,",
        "bonus": "+5 DMG",
        "rarity": "rare",
        "dmgBonus": 5
    },
    {
        "id": "morning",
        "name": "Good morning,",
        "bonus": "+5 Max HP",
        "rarity": "common",
        "hpBonus": 5
    },
    {
        "id": "project_team",
        "name": "To the Project Team,",
        "bonus": "+2 DMG",
        "rarity": "common",
        "dmgBonus": 2
    },
    {
        "id": "greetings",
        "name": "Greetings all,",
        "bonus": "5% DMG Reduction",
        "rarity": "uncommon",
        "def": 0.05
    }
];

const SIGNOFFS = [
    {
        "id": "thanks",
        "name": "Thanks,",
        "bonus": "+5 Max HP",
        "rarity": "common",
        "hpBonus": 5
    },
    {
        "id": "cheers",
        "name": "Cheers,",
        "bonus": "+2 HP/turn",
        "rarity": "common",
        "heal": 2
    },
    {
        "id": "sincerely",
        "name": "Sincerely,",
        "bonus": "+10% DMG Reduction",
        "rarity": "uncommon",
        "def": 0.1
    },
    {
        "id": "best_regards",
        "name": "Best Regards,",
        "bonus": "+5 DMG",
        "rarity": "uncommon",
        "dmgBonus": 5
    },
    {
        "id": "v_respectfully",
        "name": "Very Respectfully,",
        "bonus": "+20% Leverage gain",
        "rarity": "rare",
        "levMult": 0.2
    },
    {
        "id": "warmly",
        "name": "Warmly,",
        "bonus": "+5 Max HP",
        "rarity": "common",
        "hpBonus": 5
    },
    {
        "id": "solidarity",
        "name": "In solidarity,",
        "bonus": "+2 Credibility/turn",
        "rarity": "common",
        "heal": 2
    },
    {
        "id": "best_wishes",
        "name": "Best wishes,",
        "bonus": "10% Leverage gain",
        "rarity": "uncommon",
        "levMult": 0.1
    }
];

const BCC_CONTACTS = [
    {
        "id": "recall",
        "name": "Recall Message",
        "bonus": "Instantly stun current target for 1 turn.",
        "rarity": "common",
        "effect": "stun"
    },
    {
        "id": "urgent",
        "name": "Urgent Flag",
        "bonus": "Next attack deals 2x damage.",
        "rarity": "uncommon",
        "effect": "doubleDmg"
    },
    {
        "id": "redirect",
        "name": "Redirect Message",
        "bonus": "Current target attacks another random opponent next turn.",
        "rarity": "rare",
        "effect": "redirect"
    }
];

const EMPLOYEES = [
    {
        "id": "karen",
        "name": "Karen (HR)",
        "email": "k.smith@gov.org",
        "department": "Human Resources",
        "color": "text-purple-700",
        "defeatMessage": "I am unsubscribing. I've documented the lack of professional decorum and will be following up with each of you individually. Regards.",
        "lines": [
            {
                "text": "Your recent breakroom habits suggest a lack of respect for shared departmental assets.",
                "missionId": "microwave"
            },
            {
                "text": "I noticed you haven't completed the mandatory 'Digital Hygiene' training module for this quarter.",
                "missionId": null
            },
            {
                "text": "I have three disciplinary hearings today; this thread is a significant drain on my operational capacity.",
                "missionId": null
            },
            {
                "text": "HR provides the framework for your employment; your contributions are currently being 're-evaluated'.",
                "missionId": null
            },
            {
                "text": "Please review the updated 'Shared Space Etiquette' PDF attached to my signature.",
                "missionId": null
            },
            {
                "text": "I'm scheduling a mandatory mediation session for the entire floor this Friday at 4:30 PM.",
                "missionId": null
            },
            {
                "text": "Your tone in this thread has been noted and will be discussed during your next performance review.",
                "missionId": null
            },
            {
                "text": "We have a zero-tolerance policy for passive-aggressive CC-ing. Please adhere to the chain of command.",
                "missionId": null
            },
            {
                "text": "I've CC'd the Chief Wellness Officer to address the 'toxic environment' you're creating.",
                "missionId": null
            },
            {
                "text": "Failure to identify the salmon-heater will result in a collective reduction of the 'Team Synergy' bonus.",
                "missionId": "microwave"
            },
            {
                "text": "I'm looking at the handbook right now, and you're in violation of Section 8.4: Olfactory Neutrality.",
                "missionId": "microwave"
            },
            {
                "text": "This 'Reply All' behavior is exactly why we can't have nice things, like the espresso machine I vetoed.",
                "missionId": null
            }
        ]
    },
    {
        "id": "christina",
        "name": "Christina (Pol)",
        "email": "c.policy@gov.org",
        "department": "Policy",
        "color": "text-blue-700",
        "defeatMessage": "This thread has been archived for non-compliance. I am removing myself to draft a formal reprimand. Policy remains absolute.",
        "lines": [
            {
                "text": "Per Policy 402.b, all communal appliances are to be used for non-odorous items only. Refer to the compliance guide.",
                "missionId": "microwave"
            },
            {
                "text": "I'm currently drafting a memorandum on 'Shared Air Space Ethics'. This thread is a case study in non-compliance.",
                "missionId": "microwave"
            },
            {
                "text": "The Policy department ensures rules are followed. Your blatant disregard for the Microwave Protocol is being escalated.",
                "missionId": "microwave"
            },
            {
                "text": "I've reviewed the 2019 precedent for 'unauthorized seafood heating'. It didn't end well for the perpetrator.",
                "missionId": "microwave"
            },
            {
                "text": "If you had attended the 'Navigating the Breakroom' seminar, we wouldn't be having this conversation.",
                "missionId": null
            },
            {
                "text": "I am CC-ing the Ethics Committee. This is the procedurally correct way to handle olfactory aggression.",
                "missionId": "microwave"
            },
            {
                "text": "Your response lacks the required 'Directive 9' formatting. Please resubmit using approved templates.",
                "missionId": null
            },
            {
                "text": "We are evaluating the environmental impact of your lunch choices. Sustainability is a core pillar of our mission.",
                "missionId": null
            },
            {
                "text": "Failure to comply with 'No Fish Friday' is a breach of department harmony. I'm noting this in the audit.",
                "missionId": "microwave"
            },
            {
                "text": "The data suggests a 98% probability that you are the source of the incident based on desk location.",
                "missionId": null
            },
            {
                "text": "Please cease and desist from using 'Reply All' unless you are citing a specific governmental regulation.",
                "missionId": null
            },
            {
                "text": "This thread is now under the jurisdiction of the Policy Oversight Division. Peer-review your next comment.",
                "missionId": null
            }
        ]
    },
    {
        "id": "megan",
        "name": "Megan (Legal)",
        "email": "m.compliance@gov.org",
        "color": "text-red-700",
        "defeatMessage": "I cannot continue this conversation without a physical copy of the minutes in front of me. Unsubscribing.",
        "lines": [
            {
                "text": "The lack of physical documentation is a direct violation of the 2004 Record Keeping Act.",
                "missionId": "paper"
            },
            {
                "text": "I've drafted a cease and desist regarding this rationing. I'll send it as soon as I can find a working printer.",
                "missionId": "paper"
            },
            {
                "text": "Your 'digital-only' proposal fails to meet the standards for admissible evidence in a council hearing.",
                "missionId": "paper"
            },
            {
                "text": "I'm flagging this thread for potential liability issues. We need paper trails, not email trails.",
                "missionId": null
            },
            {
                "text": "Without a hard copy, this policy is effectively unenforceable. Please reconsider.",
                "missionId": "paper"
            },
            {
                "text": "I'm CC-ing the Archivist. We are losing history one deleted email at a time.",
                "missionId": null
            }
        ]
    },
    {
        "id": "colin",
        "name": "Colin (IT)",
        "email": "c.it@gov.org",
        "department": "Information Technology",
        "color": "text-indigo-700",
        "defeatMessage": "Server load from this thread is too high. I'm muting this. Try rebooting your attitude.",
        "lines": [
            {
                "text": "Have you tried not printing every single cat meme you see? It's clogging the spooler and the budget.",
                "missionId": "paper"
            },
            {
                "text": "The 'Paperless Initiative' has been ready for three years. You're just afraid of PDFs.",
                "missionId": "paper"
            },
            {
                "text": "I'm seeing a lot of 'Printer Error' tickets from your floor. Maybe try putting paper in the tray?",
                "missionId": "paper"
            },
            {
                "text": "Your 'urgent' requests are being redirected to the /dev/null of my inbox.",
                "missionId": null
            },
            {
                "text": "If it's not a PDF, it doesn't exist to me anymore.",
                "missionId": null
            },
            {
                "text": "The budget for paper was redirected to upgrade the firewall you keep trying to bypass.",
                "missionId": "paper"
            },
            {
                "text": "Stop asking for 'digital paper'. It's called a screen. Use it.",
                "missionId": "paper"
            },
            {
                "text": "I've limited your mailbox size to 50MB until the paper crisis is resolved. Choose your replies wisely.",
                "missionId": "paper"
            }
        ]
    },
    {
        "id": "jamie",
        "name": "Brendan (IT?)",
        "email": "b.it@gov.org",
        "department": "Information Technology",
        "color": "text-indigo-600",
        "defeatMessage": "Too many emails. I've got a survey to send on a form to redesign.",
        "lines": [
            {
                "text": "I'm not sure why I'm on this thread. but my form initiative will resolve any paper issues no doubt.",
                "missionId": "paper"
            },
            {
                "text": "You used it last I think, you fix it.",
                "missionId": null
            },
            {
                "text": "I recently got Adobe suite installed for the first time.",
                "missionId": null
            },
            {
                "text": "I'm planning to be away next week, can you take this?",
                "missionId": null
            }
        ]
    },
    {
        "id": "interns",
        "name": "HR Interns",
        "email": "hr.interns@gov.org",
        "department": "Human Resources",
        "color": "text-blue-900 font-bold",
        "salutation": {
            "name": "To the Permanent Staff,"
        },
        "signOff": {
            "name": "The Intern Collective"
        },
        "signatures": [
            {
                "name": "Unpaid & Unappreciated"
            }
        ],
        "defeatMessage": "The intern pool has been drained. We are collectively resigning to pursue opportunities in a less toxic environment.",
        "lines": [
            {
                "text": "We've been CC'd on the entire thread and we're documenting everything for our final reports.",
                "missionId": null
            },
            {
                "text": "Our collective research suggests that fish-microwaving is the #1 cause of decreased morale.",
                "missionId": "microwave"
            },
            {
                "text": "We've been instructed to flag any 'non-synergetic' behavior. This thread is 100% flaggable.",
                "missionId": null
            },
            {
                "text": "As the future of this department, we demand a higher standard of digital decorum.",
                "missionId": null
            }
        ]
    },
    {
        "id": "sheila",
        "name": "Sheila (Payroll)",
        "email": "s.payroll@gov.org",
        "department": "Finance",
        "color": "text-green-700",
        "salutation": {
            "name": "Dear All,"
        },
        "signOff": {
            "name": "Best, Sheila"
        },
        "defeatMessage": "I'm freezing all stipend payments until this thread is resolved. I'm out.",
        "lines": [
            {
                "text": "Your overtime request for 'email management' has been denied. Stick to the mission.",
                "missionId": null
            },
            {
                "text": "I'm reviewing the cost-benefit analysis of your participation in this thread. It's not looking good.",
                "missionId": null
            },
            {
                "text": "Every 'Reply All' costs the department approximately $4.12 in lost productivity. You've cost us a fortune today.",
                "missionId": null
            },
            {
                "text": "Please refer to the payroll schedule before complaining about your 'emotional labor'.",
                "missionId": "intern_grievance"
            }
        ]
    },
    {
        "id": "sarah",
        "name": "Sarah (ECO)",
        "email": "s.eco@gov.org",
        "color": "text-orange-700",
        "defeatMessage": "I'm escalating this to the Deputy Director. I don't have time for intern drama.",
        "lines": [
            {
                "text": "I need a status report on the 'Synergy Initiative' by EOD. This thread is a distraction.",
                "missionId": null
            },
            {
                "text": "We need to 'lean in' to a more positive communication style. Your tone is very 'lean out'.",
                "missionId": null
            },
            {
                "text": "I'm scheduling a sync-up to discuss your 'alignment' with departmental goals.",
                "missionId": null
            },
            {
                "text": "Let's take this offline. And by offline, I mean I'm deleting your replies.",
                "missionId": null
            }
        ]
    },
    {
        "id": "desmond",
        "name": "Anneke VDH (ECO)",
        "email": "anneke.eco@gov.org",
        "department": "Executive Council Office",
        "color": "text-red-900",
        "salutation": {
            "name": "Regarding the recent incident,"
        },
        "defeatMessage": "You know what? I'll leave this to the pipsqueaks. I'm out.",
        "lines": [
            {
                "text": "I think your latest reply violates the 'Civility in Digital Spaces' directive.",
                "missionId": null
            },
            {
                "text": "I'm auditing this thread for potential FOIA requests. Mind your words.",
                "missionId": null
            },
            {
                "text": "Regulatory standards require a 24-hour cooling-off period after a 'Reply All' incident. You ignored it.",
                "missionId": null
            },
            {
                "text": "I've flagged this thread to the Auditor General. Good luck with the hearing.",
                "missionId": null
            }
        ]
    }
];

const MISSIONS = [
    {
        "id": "microwave",
        "subject": "URGENT: Breakroom Incident",
        "from": "HR.Director",
        "intro": "Hi team,<br><br>I am absolutely disgusted. Someone heated up fish in the breakroom microwave. <strong>{playerName}</strong>, I'm sure you noticed the stench. <strong>{opp1}</strong>, I know you have the policy manual out already. <strong>{opp0}</strong>, please document this.<br><br>Please advise immediately on who is responsible for this violation of shared space ethics.",
        "opponents": [
            {
                "id": 1,
                "employeeId": "karen",
                "hp": 50,
                "maxHp": 50,
                "wins": 3,
                "buffs": [],
                "addressBook": [
                    "intern"
                ]
            },
            {
                "id": 2,
                "employeeId": "christina",
                "hp": 60,
                "maxHp": 60,
                "wins": 3,
                "buffs": [],
                "addressBook": [
                    "legal"
                ]
            }
        ]
    },
    {
        "id": "paper",
        "subject": "CRITICAL: Departmental Paper Rationing",
        "from": "Facilities.Admin",
        "intro": "Dear Staff,<br><br>Due to unforeseen budget constraints, we are implementing immediate paper rationing. <strong>{playerName}</strong>, your department's printing logs are particularly high. <strong>Megan</strong>, please ensure we are still meeting filing requirements. <strong>Colin</strong>, please expedite the 'Paperless Initiative'.<br><br>Effective immediately, all non-essential printing is strictly prohibited.",
        "opponents": [
            {
                "id": 3,
                "employeeId": "megan",
                "hp": 60,
                "maxHp": 60,
                "wins": 3,
                "buffs": [],
                "addressBook": [
                    "legal"
                ]
            },
            {
                "id": 4,
                "employeeId": "colin",
                "hp": 50,
                "maxHp": 50,
                "wins": 3,
                "buffs": [],
                "addressBook": [
                    "it"
                ]
            },
            {
                "id": 44,
                "employeeId": "jamie",
                "hp": 50,
                "maxHp": 50,
                "wins": 3,
                "buffs": [],
                "addressBook": [
                    "it"
                ]
            }
        ]
    },
    {
        "id": "intern_grievance",
        "subject": "RE: Intern Grievance Collective",
        "from": "HR.Interns",
        "intro": "To the Permanent Staff,<br><br>We, the interns, have noticed a significant lack of 'Team Synergy' and 'Professional Courtesy'. <strong>{playerName}</strong>, your recent emails have been cited as 'aggressive'. <strong>Management</strong>, we are looping in our mentors. <strong>Payroll</strong>, we expect our stipends to reflect the emotional labor of this thread.",
        "opponents": [
            {
                "id": 5,
                "employeeId": "interns",
                "hp": 80,
                "maxHp": 80,
                "wins": 5,
                "buffs": [],
                "addressBook": [
                    "intern"
                ]
            },
            {
                "id": 6,
                "employeeId": "sheila",
                "hp": 70,
                "maxHp": 70,
                "wins": 2,
                "buffs": [],
                "addressBook": [
                    "audit"
                ]
            },
            {
                "id": 7,
                "employeeId": "jordan",
                "hp": 90,
                "maxHp": 90,
                "wins": 4,
                "buffs": [],
                "addressBook": [
                    "eco"
                ]
            },
            {
                "id": 8,
                "employeeId": "desmond",
                "hp": 75,
                "maxHp": 75,
                "wins": 3,
                "buffs": [],
                "addressBook": [
                    "eco"
                ]
            }
        ]
    }
];



        let opponents = [];

        let state = {
            player: {
                name: "eke vdh",
                email: "eke.vdh@gov.org",
                hp: 50,
                maxHp: 50,
                ult: 0,
                wins: 3,
                buffs: [],
                reputation: 0,
                year: 1,
                quarter: "Q3",
                title: TITLES[0],
                addressBook: ['intern'],
                signatures: [],
                salutation: null,
                signOff: null,
                bccContacts: [],
                department: 'Executive Council Office',
                bonusDmg: 0,
                bonusMaxHp: 0,
                bonusWins: 0,
                attacks: [
                    "I believe we need to circle back to your recent comments. My focus is on department output, and I suggest yours should be too.",
                    "I've already addressed this in my previous email, but for the sake of clarity, I'll repeat it: I was at my desk all day.",
                    "Perhaps we should focus on the Q4 deliverables instead of speculating on departmental policy?",
                    "I'm happy to discuss this in a 1-on-1, but I don't believe this is a productive use of the 'All-Staff' distribution list."
                ]
            },
            currentMissionIndex: 0,
            targetId: 1, turn: 0, isProcessing: false, gameOver: false,
            removedByPlayer: 0,
            removedTotal: 0,
            shop: {
                seminars: [],
                signatures: [],
                salutations: [],
                signoffs: [],
                promotions: [],
                bccs: []
            }
        };

        const nameInput = document.getElementById('player-name-input');
        const emailPreview = document.getElementById('email-preview');
        nameInput.addEventListener('input', (e) => {
            const val = e.target.value.trim() || "eke vdh";
            const email = val.toLowerCase().replace(/\s+/g, '.') + "@gov.org";
            emailPreview.innerText = email;
            state.player.email = email;
        });

        function transitionTo(screenId) {
            const screens = ['start-screen', 'game-ui', 'inbox-screen', 'summary-screen', 'shop-screen', 'promotion-screen', 'lose-screen'];
            screens.forEach(s => {
                const el = document.getElementById(s);
                if (el) el.classList.add('hidden');
            });
            const target = document.getElementById(screenId);
            if (target) target.classList.remove('hidden');
        }

        function startGame() {
            state.player.name = nameInput.value.trim() || "eke vdh";
            const email = state.player.name.toLowerCase().replace(/\s+/g, '.') + "@gov.org";
            state.player.email = email;
            document.getElementById('status-bar-email').innerText = "Online";
            showInbox();
        }

        function showInbox() {
            transitionTo('inbox-screen');
            const list = document.getElementById('inbox-list');
            list.innerHTML = "";

            const mission = MISSIONS[state.currentMissionIndex] || MISSIONS[0];

            // The battle email (At the top)
            const urgent = document.createElement('div');
            urgent.className = "grid grid-cols-12 p-2 border-b border-gray-100 bg-blue-50 cursor-pointer hover:bg-blue-200 font-bold border-l-4 border-l-blue-600";
            urgent.onclick = startQuarter;
            urgent.innerHTML = `<div class="col-span-1 text-red-600">!</div><div class="col-span-4 text-blue-800">${mission.from}</div><div class="col-span-7">${mission.subject}</div>`;
            list.appendChild(urgent);

            // Spam emails
            const spamSubjects = ["Hot Stocks!", "Refinance Now", "Enlarge your career", "Inheritance Notification", "Meeting?"];
            for (let i = 0; i < 8; i++) {
                const spam = document.createElement('div');
                spam.className = "grid grid-cols-12 p-2 border-b border-gray-100 bg-gray-50 text-gray-400 opacity-60";
                spam.innerHTML = `<div class="col-span-1"></div><div class="col-span-4 truncate">bot-${Math.random().toString(36).substr(2,5)}@junk.co</div><div class="col-span-7 truncate">${spamSubjects[i % spamSubjects.length]}</div>`;
                list.appendChild(spam);
            }

            document.getElementById('inbox-status').innerText = `${324 + (state.player.year * 4)} Messages, 1 Unread`;
        }

        function getUnitMaxHp(u) {
            if (u.id === 'player') {
                let max = 50 + u.title.hpBonus + u.bonusMaxHp;
                if (u.salutation && u.salutation.hpBonus) max += u.salutation.hpBonus;
                if (u.signOff && u.signOff.hpBonus) max += u.signOff.hpBonus;
                return max;
            }
            let max = u.maxHp;
            if (u.salutation && u.salutation.hpBonus) max += u.salutation.hpBonus;
            if (u.signOff && u.signOff.hpBonus) max += u.signOff.hpBonus;
            return max;
        }

        function getUnitTotalHeal(u) {
            let heal = 0;
            u.buffs.forEach(b => { if(b.eff.heal) heal += b.eff.heal; });
            if (u.signatures) u.signatures.forEach(s => { if(s.heal) heal += s.heal; });
            if (u.salutation && u.salutation.heal) heal += u.salutation.heal;
            if (u.signOff && u.signOff.heal) heal += u.signOff.heal;
            return heal;
        }

        function getUnitTotalDmg(u) {
            let d = 10;
            if (u.id === 'player') {
                d += u.title.dmgBonus + u.bonusDmg;
            }
            if (u.salutation && u.salutation.dmgBonus) d += u.salutation.dmgBonus;
            if (u.signOff && u.signOff.dmgBonus) d += u.signOff.dmgBonus;
            u.buffs.forEach(b => { if(b.eff.dmg) d += b.eff.dmg; });

            let mult = 1;
            if (u.signatures) u.signatures.forEach(s => { if(s.dmgMult) mult += s.dmgMult; });
            if (u.salutation && u.salutation.dmgMult) mult += u.salutation.dmgMult;
            if (u.signOff && u.signOff.dmgMult) mult += u.signOff.dmgMult;
            return d * mult;
        }

        function getUnitTotalDef(u) {
            let def = 0;
            u.buffs.forEach(b => { if(b.eff.def) def += b.eff.def; });
            if (u.signatures) u.signatures.forEach(s => { if(s.def) def += s.def; });
            if (u.salutation && u.salutation.def) def += u.salutation.def;
            if (u.signOff && u.signOff.def) def += u.signOff.def;
            return def;
        }

        function getPlayerLeverageGain(base) {
            const p = state.player;
            let mult = 1;
            if (p.buffs.find(b => b.eff.lev)) mult *= 2;
            p.signatures.forEach(s => { if(s.levMult) mult += s.levMult; });
            if (p.salutation && p.salutation.levMult) mult += p.salutation.levMult;
            if (p.signOff && p.signOff.levMult) mult += p.signOff.levMult;

            let gain = base * mult;
            p.signatures.forEach(s => { if(s.doubleLevChance && Math.random() < s.doubleLevChance) gain *= 2; });
            return gain;
        }

        function formatMessageBody(sender, content) {
            let body = "";
            if (sender.salutation) {
                body += `<strong>${sender.salutation.name}</strong><br><br>`;
            }
            body += content;
            if (sender.signOff) {
                body += `<br><br><strong>${sender.signOff.name}</strong><br>${sender.name}`;
            } else {
                body += `<br><br>${sender.name}`;
            }
            if (sender.signatures && sender.signatures.length > 0) {
                sender.signatures.forEach(sig => {
                    body += `<div class="text-[10px] text-gray-500 border-t border-gray-200 mt-2 pt-1">-- ${sig.name}</div>`;
                });
            }
            return body;
        }

        function startQuarter() {
            transitionTo('game-ui');
            state.gameOver = false;
            state.turn = 0;
            state.isProcessing = false;
            const p = state.player;
            p.hp = getUnitMaxHp(p);
            p.ult = 0;
            p.wins = 3 + p.bonusWins;
            if (p.salutation && p.salutation.bonusWins) p.wins += p.salutation.bonusWins;
            if (p.signOff && p.signOff.bonusWins) p.wins += p.signOff.bonusWins;
            p.buffs = []; // Reset combat buffs

            // Reset global CONTACTS.usedBy
            CONTACTS.forEach(c => c.usedBy = null);

            const mission = MISSIONS[state.currentMissionIndex] || MISSIONS[0];

            // Assemble opponents from EMPLOYEES and mission-specific data
            opponents = mission.opponents.map(missionOpponent => {
                const employee = EMPLOYEES.find(e => e.id === missionOpponent.employeeId);
                const clone = {
                    ...JSON.parse(JSON.stringify(employee)),
                    ...JSON.parse(JSON.stringify(missionOpponent))
                };
                clone.hp = clone.maxHp;
                clone.buffs = [];
                // Filter lines based on missionId
                clone.attacks = employee.lines
                    .filter(l => l.missionId === null || l.missionId === mission.id)
                    .map(l => l.text);
                return clone;
            });

            state.removedTotal = opponents.length;
            state.removedByPlayer = 0;
            state.targetId = opponents[0].id;

            document.getElementById('message-log').innerHTML = "";
            document.getElementById('game-header-subject').innerText = `Outlook Express - [${mission.subject}]`;
            updateUI();

            // Templating the intro
            let introText = mission.intro;
            introText = introText.replace(/{playerName}/g, p.name);
            opponents.forEach((opp, idx) => {
                const regex = new RegExp(`{opp${idx}}`, 'g');
                introText = introText.replace(regex, opp.name);
            });

            addEmailToLog(mission.from, "everyone@gov.org", mission.subject,
                introText, "border-l-4 border-blue-500 bg-blue-50");
        }

        function generateShopItems() {
            // Seminars
            const availCCs = CONTACTS.filter(c => !state.player.addressBook.includes(c.id));
            state.shop.seminars = shuffle([...availCCs]).slice(0, 2).map(c => ({...c, purchased: false}));

            // Signatures
            state.shop.signatures = shuffle([...SIGNATURES]).slice(0, 2).map(s => ({...s, purchased: false}));

            // Salutations
            state.shop.salutations = shuffle([...SALUTATIONS]).slice(0, 2).map(s => ({...s, purchased: false}));

            // Sign-offs
            state.shop.signoffs = shuffle([...SIGNOFFS]).slice(0, 2).map(s => ({...s, purchased: false}));

            // Promotions (Stats)
            const promoOptions = [
                { id: 'dmg', name: "Project Excellence", bonus: "+5 DMG", cost: 8, apply: () => { state.player.bonusDmg += 5; } },
                { id: 'hp', name: "Resilience Training", bonus: "+20 Max HP", cost: 8, apply: () => { state.player.bonusMaxHp += 20; } },
                { id: 'win', name: "Public Speaking", bonus: "+1 New Win/Round", cost: 10, apply: () => { state.player.bonusWins += 1; } },
                { id: 'heal', name: "Executive Coaching", bonus: "Fully Restore HP", cost: 5, apply: () => { state.player.hp = getUnitMaxHp(state.player); } }
            ];
            state.shop.promotions = shuffle([...promoOptions]).slice(0, 2).map(p => ({...p, purchased: false}));

            // BCCs
            state.shop.bccs = shuffle([...BCC_CONTACTS]).slice(0, 2).map(b => ({...b, purchased: false}));
        }

        function endQuarter() {
            state.isProcessing = true;
            generateShopItems();
            setTimeout(() => {
                transitionTo('summary-screen');
                const baseRep = 4;
                const totalOptOutRep = Math.floor(6 * (state.removedByPlayer / state.removedTotal));

                // Distribution
                const optOutList = document.getElementById('summary-optouts-list');
                optOutList.innerHTML = "";
                const playerKills = opponents.filter(o => o.removedByPlayer);

                if (playerKills.length > 0) {
                    optOutList.classList.remove('hidden');
                    playerKills.forEach((o, i) => {
                        const share = Math.floor((i + 1) * totalOptOutRep / playerKills.length) - Math.floor(i * totalOptOutRep / playerKills.length);
                        const div = document.createElement('div');
                        div.className = "flex justify-between text-[10px] text-gray-600 italic";
                        div.innerHTML = `<span>Opt-out: ${o.name}</span><span>+${share}</span>`;
                        optOutList.appendChild(div);
                    });
                } else {
                    optOutList.classList.add('hidden');
                }

                // Signature bonus
                let bonusRep = 0;
                state.player.signatures.forEach(sig => {
                    if (sig.repBonus) {
                        bonusRep += (state.removedTotal - opponents.filter(o => o.hp > 0).length - state.removedByPlayer) * sig.repBonus;
                    }
                });

                // CC bonus (Constituent Liaison)
                if (state.player.buffs.some(b => b.eff && b.eff.endRep)) {
                    bonusRep += 4;
                }

                const totalRep = baseRep + totalOptOutRep + bonusRep;
                state.player.reputation += totalRep;

                // Advance mission index
                state.currentMissionIndex = (state.currentMissionIndex + 1) % MISSIONS.length;

                document.getElementById('summary-base-rep').innerText = `+${baseRep}`;
                document.getElementById('summary-bonus-rep').innerText = `+${bonusRep}`;
                document.getElementById('summary-rep-earned').innerText = `+${totalRep}`;
            }, 1500);
        }

        function showShop() {
            transitionTo('shop-screen');
            updateShopUI();
        }

        function showLoseScreen() {
            const p = state.player;
            document.getElementById('lose-title').innerText = p.title.name;
            document.getElementById('lose-period').innerText = `${p.quarter} - Year ${p.year}`;
            document.getElementById('lose-total-rep').innerText = p.reputation;
            document.getElementById('lose-contacts').innerText = `${p.addressBook.length} Contacts`;
            transitionTo('lose-screen');
        }

        function advanceToNextQuarter() {
            const quarters = ["Q3", "Q4", "Q1", "Q2"];
            let idx = quarters.indexOf(state.player.quarter);
            idx = (idx + 1) % quarters.length;
            state.player.quarter = quarters[idx];

            if (state.player.quarter === "Q3") {
                state.player.year++;
            }

            if (state.player.quarter === "Q2") {
                showPromotion();
            } else {
                showInbox();
            }
        }

        function showPromotion() {
            transitionTo('promotion-screen');
            // Advance titles more aggressively to reach Boardroom by end of Year 3
            // 0: Intern, 4: Middle Manager, 8: Board Member
            let titleIdx = 0;
            if (state.player.year === 1) titleIdx = 4; // Promoted to Mid-Mgmt after Year 1
            else if (state.player.year === 2) titleIdx = 8; // Promoted to Boardroom after Year 2
            else titleIdx = 8;

            const nextTitle = TITLES[titleIdx] || TITLES[TITLES.length - 1];
            state.player.title = nextTitle;

            document.getElementById('promotion-new-title').innerText = nextTitle.name;
            document.getElementById('promotion-perks').innerText = `+${nextTitle.hpBonus} HP, +${nextTitle.dmgBonus} DMG, Limit: ${nextTitle.sigLimit} Sig, ${nextTitle.addressLimit} CCs`;
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function createShopCard(name, desc, cost, onBuy, purchased = false) {
            const div = document.createElement('div');
            div.className = "p-2 bg-white retro-border flex flex-col gap-1";
            const canAfford = state.player.reputation >= cost;
            div.innerHTML = `
                <div class="flex justify-between font-bold text-[11px]">
                    <span>${name}</span>
                    <span class="text-blue-700 font-mono">${purchased ? 'ACQUIRED' : cost + ' REP'}</span>
                </div>
                <div class="text-[10px] italic text-gray-600 leading-tight">${desc}</div>
                <button class="mt-1 retro-button text-[10px] font-bold py-1 ${(!canAfford || purchased) ? 'opacity-50' : ''}" ${(!canAfford || purchased) ? 'disabled' : ''}>
                    ${purchased ? 'BOUGHT' : 'ACQUIRE'}
                </button>
            `;
            if (!purchased) div.querySelector('button').onclick = () => { onBuy(); updateShopUI(); };
            return div;
        }

        function updateShopUI() {
            document.getElementById('shop-reputation-display').innerText = `REP: ${state.player.reputation}`;

            // Seminars
            const semList = document.getElementById('shop-seminars'); semList.innerHTML = "";
            state.shop.seminars.forEach(c => {
                const cost = c.rarity === 'rare' ? 12 : (c.rarity === 'uncommon' ? 7 : 4);
                semList.appendChild(createShopCard(c.name, c.bonus, cost, () => {
                    if (state.player.addressBook.length >= state.player.title.addressLimit) {
                        const toRemoveId = state.player.addressBook[0];
                        const toRemove = CONTACTS.find(con => con.id === toRemoveId);
                        state.player.addressBook = state.player.addressBook.filter(id => id !== toRemoveId);
                        state.player.reputation += 2;
                        alert(`Address book full. ${toRemove ? toRemove.name : toRemoveId} removed. +2 REP refunded.`);
                    }
                    state.player.reputation -= cost;
                    state.player.addressBook.push(c.id);
                    c.purchased = true;
                }, c.purchased));
            });

            // Signatures
            const sigList = document.getElementById('shop-signatures'); sigList.innerHTML = "";
            const sigHeader = sigList.previousElementSibling;
            sigHeader.innerText = `Update Email Signature (${state.player.signatures.length}/${state.player.title.sigLimit})`;
            state.shop.signatures.forEach(s => {
                const cost = s.rarity === 'rare' ? 10 : (s.rarity === 'uncommon' ? 6 : 3);
                sigList.appendChild(createShopCard(s.name, s.bonus, cost, () => {
                    if (state.player.signatures.length >= state.player.title.sigLimit) {
                        state.player.signatures.shift();
                    }
                    state.player.reputation -= cost;
                    state.player.signatures.push(s);
                    s.purchased = true;
                }, s.purchased));
            });

            // Salutations
            const salList = document.getElementById('shop-salutations'); salList.innerHTML = "";
            const currentSal = state.player.salutation ? `<div class="text-[10px] bg-blue-50 p-1 mb-2 border border-blue-200"><strong>Current:</strong> ${state.player.salutation.name} (${state.player.salutation.bonus})</div>` : "";
            salList.innerHTML = currentSal;
            state.shop.salutations.forEach(s => {
                const cost = s.rarity === 'rare' ? 10 : (s.rarity === 'uncommon' ? 6 : 3);
                salList.appendChild(createShopCard(s.name, s.bonus, cost, () => {
                    state.player.reputation -= cost;
                    state.player.salutation = s;
                    s.purchased = true;
                }, s.purchased));
            });

            // Sign-offs
            const offList = document.getElementById('shop-signoffs'); offList.innerHTML = "";
            const currentOff = state.player.signOff ? `<div class="text-[10px] bg-blue-50 p-1 mb-2 border border-blue-200"><strong>Current:</strong> ${state.player.signOff.name} (${state.player.signOff.bonus})</div>` : "";
            offList.innerHTML = currentOff;
            state.shop.signoffs.forEach(s => {
                const cost = s.rarity === 'rare' ? 10 : (s.rarity === 'uncommon' ? 6 : 3);
                offList.appendChild(createShopCard(s.name, s.bonus, cost, () => {
                    state.player.reputation -= cost;
                    state.player.signOff = s;
                    s.purchased = true;
                }, s.purchased));
            });

            // Promotions (Stats)
            const promList = document.getElementById('shop-promotions'); promList.innerHTML = "";
            state.shop.promotions.forEach(p => {
                promList.appendChild(createShopCard(p.name, p.bonus, p.cost, () => {
                    state.player.reputation -= p.cost;
                    p.apply();
                    p.purchased = true;
                }, p.purchased));
            });

            // BCCs
            const bccList = document.getElementById('shop-bccs'); bccList.innerHTML = "";
            state.shop.bccs.forEach(b => {
                const cost = b.rarity === 'rare' ? 5 : (b.rarity === 'uncommon' ? 3 : 2);
                bccList.appendChild(createShopCard(b.name, b.bonus, cost, () => {
                    state.player.reputation -= cost;
                    state.player.bccContacts.push(b);
                    b.purchased = true;
                }, b.purchased));
            });
        }

        function handleOpponentDefeat(o, byPlayer = false) {
            if (o.isDefeated) return;
            o.hp = 0;
            o.isDefeated = true;
            if (byPlayer) {
                state.removedByPlayer++;
                o.removedByPlayer = true;
            }
            addEmailToLog(o.name, "everyone@gov.org", "Unsubscribing", o.defeatMessage, "italic text-gray-600 bg-gray-50 border-l-4 border-gray-400");
            if (state.targetId === o.id) {
                const next = opponents.find(opp => opp.hp > 0);
                if (next) state.targetId = next.id;
            }
            if (opponents.every(opp => opp.hp <= 0)) {
                state.gameOver = true;
                endQuarter();
            }
        }

        function updateUI() {
            if (state.gameOver) return;
            const p = state.player;
            const totalMaxHp = p.maxHp + p.title.hpBonus + p.bonusMaxHp;
            const hpPct = Math.max(0, (p.hp / totalMaxHp) * 100);
            const ultPct = Math.min(100, p.ult);

            document.getElementById('player-hp-fill').style.width = hpPct + "%";
            document.getElementById('player-hp-label').innerText = `${Math.ceil(p.hp)}/${totalMaxHp}`;
            document.getElementById('player-ult-fill').style.width = ultPct + "%";
            document.getElementById('player-win-status').innerText = `New Wins: ${p.wins} Available`;
            
            if (hpPct < 30) document.getElementById('player-hp-fill').className = "h-full bg-red-600";
            else if (hpPct < 60) document.getElementById('player-hp-fill').className = "h-full bg-yellow-500";
            else document.getElementById('player-hp-fill').className = "h-full bg-green-500";

            const dmg = getUnitTotalDmg(p);
            document.getElementById('attack-subtext').innerText = `-${Math.floor(dmg)} Cred to Target`;
            document.getElementById('promote-subtext').innerText = `+20 Cred, -1 Win`;
            document.getElementById('ult-subtext').innerText = `-20 Cred to All`;
            document.getElementById('loop-subtext').innerText = `Summon Buff`;

            document.getElementById('reply-all-btn').disabled = p.ult < 100;
            document.getElementById('win-btn').disabled = p.wins <= 0;

            document.getElementById('game-quarter-display').innerText = `${p.quarter} - YEAR ${p.year}`;
            document.getElementById('status-bar-name').innerText = `${p.name} (${p.title.name})`;

            const selector = document.getElementById('target-selector');
            selector.innerHTML = "";
            opponents.forEach(o => {
                const isActive = state.targetId === o.id;
                const pct = Math.max(0, (o.hp / o.maxHp) * 100);
                const pill = document.createElement('div');
                pill.onclick = () => { if(o.hp > 0) state.targetId = o.id; updateUI(); };
                pill.className = `target-pill px-2 py-0.5 flex flex-col min-w-[90px] cursor-pointer bg-white ${isActive ? 'active' : 'opacity-60 grayscale'}`;
                pill.innerHTML = `<div class="flex justify-between font-bold text-[8px] truncate"><span class="mr-2">${o.name}</span><span>${o.hp > 0 ? o.wins+'w' : 'UNSUBBED'}</span></div>
                                <div class="h-1 w-full bg-gray-200 mt-0.5"><div class="h-full bg-red-500" style="width: ${pct}%"></div></div>`;
                selector.appendChild(pill);
            });

            const ccDisplay = document.getElementById('cc-display');
            const activeBuffs = [
                ...state.player.buffs,
                ...opponents.flatMap(o => o.buffs || [])
            ];
            ccDisplay.innerHTML = activeBuffs.length
                ? activeBuffs.map(b => `<span class="bg-blue-800 text-white px-1 text-[9px] rounded-sm">${b.name} (by ${b.usedBy})</span>`).join(' ')
                : "No one in loop.";
            
            const h = 9 + Math.floor(state.turn / 4); const m = (state.turn % 4) * 15;
            document.getElementById('turn-clock').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')} AM`;
        }

        function addEmailToLog(from, to, subject, body, classes = "") {
            const log = document.getElementById('message-log');
            const entry = document.createElement('div');
            const time = document.getElementById('turn-clock').innerText;
            const reCount = state.turn > 0 ? "RE: ".repeat(Math.min(state.turn, 4)) : "";
            
            entry.className = `message-entry p-0 border-2 border-gray-100 bg-white shadow-sm ${classes}`;
            entry.innerHTML = `
                <div class="email-header p-2">
                    <div class="flex flex-wrap gap-x-4">
                        <div><strong>From:</strong> ${from}</div>
                        <div><strong>To:</strong> ${to}</div>
                    </div>
                    <div class="flex flex-wrap gap-x-4">
                        <div><strong>Sent:</strong> Today, ${time}</div>
                        <div><strong>Subject:</strong> ${reCount}${subject}</div>
                    </div>
                </div>
                <div class="email-body px-3 py-2 font-serif italic">
                    ${body}
                </div>
            `;
            log.prepend(entry);
        }

        function performAction(type) {
            if (state.isProcessing || state.gameOver) return;
            state.isProcessing = true;
            state.turn++;
            const target = opponents.find(o => o.id === state.targetId);
            const p = state.player;
            const totalMaxHp = getUnitMaxHp(p);

            // Heal from all sources
            p.hp = Math.min(totalMaxHp, p.hp + getUnitTotalHeal(p));

            if (type === 'ATTACK') {
                let d = getUnitTotalDmg(p);

                if (p.nextAttackMult) {
                    d *= p.nextAttackMult;
                    p.nextAttackMult = 1; // reset back to 1
                }

                target.hp -= d;
                let levGain = getPlayerLeverageGain(20);
                p.ult += levGain;

                const q = p.attacks[Math.floor(Math.random() * p.attacks.length)];
                const body = formatMessageBody(p, q);
                addEmailToLog(p.name, target.name, "Circle Back", body, "border-l-4 border-blue-600");
                if (target.hp <= 0) handleOpponentDefeat(target, true);
            } else if (type === 'PROMOTE') {
                p.wins--; p.hp = Math.min(totalMaxHp, p.hp + 20);
                addEmailToLog(p.name, "everyone@gov.org", "FYI: Project Milestone Met", `Just logging a new win—the quarterly audit came back clean under my supervision. Always happy to add value to the organization!`, "bg-green-50 border-l-4 border-green-600");
            } else if (type === 'ULT') {
                opponents.forEach(o => {
                    if(o.hp > 0) {
                        o.hp -= 20;
                        if (o.hp <= 0) handleOpponentDefeat(o, true);
                    }
                });
                p.ult = 0;
                addEmailToLog(p.name, "everyone@gov.org", "Fwd: Salary_Discrepancies_2024.xlsx", `Not sure if I should be sending this to everyone, but since transparency is one of our 'core values', here is the full salary spreadsheet for the department. Enjoy.`, "bg-yellow-50 font-bold border-l-4 border-yellow-500");
            }

            updateUI();
            setTimeout(ffaRound, 800);
        }

        function ffaRound() {
            const alive = opponents.filter(o => o.hp > 0);
            if (alive.length === 0) return; // Handled by handleOpponentDefeat

            alive.forEach((a, idx) => {
                setTimeout(() => {
                    if (a.hp <= 0 || state.gameOver) return;
                    
                    if (a.isStunned) {
                        a.isStunned = false;
                        addEmailToLog(a.name, "everyone@gov.org", "RE: (Recalled Message)", `I'm sorry, I seem to have lost my train of thought. What were we discussing?`, "italic text-gray-400");
                        if (idx === alive.length - 1) { state.isProcessing = false; updateUI(); }
                        return;
                    }

                    let pool = [...alive.filter(o => o.id !== a.id), { id: 'player', name: state.player.name, email: state.player.email, department: state.player.department }];

                    // Targeting logic: weigh opponents by department (colleagues never attack each other)
                    let weights = pool.map(t => (t.department === a.department) ? 0 : 1.0);
                    let totalWeight = weights.reduce((acc, w) => acc + w, 0);
                    let random = Math.random() * totalWeight;
                    let target = pool[0];
                    for (let i = 0; i < pool.length; i++) {
                        random -= weights[i];
                        if (random <= 0) { target = pool[i]; break; }
                    }

                    if (a.redirectNext) {
                        a.redirectNext = false;
                        const targets = alive.filter(o => o.id !== a.id);
                        if (targets.length > 0) {
                            target = targets[Math.floor(Math.random() * targets.length)];
                            addEmailToLog(a.name, "everyone@gov.org", "Redirected Reply", `Wait, I meant to send this to <strong>${target.name}</strong> instead.`, "italic text-blue-400 text-[10px]");
                        }
                    }

                    let roll = Math.random();

                    a.hp = Math.min(getUnitMaxHp(a), a.hp + getUnitTotalHeal(a));

                    const availFromBook = a.addressBook.filter(id => !a.buffs.some(b => b.id === id));
                    if (roll < 0.15 && availFromBook.length > 0) {
                        const id = availFromBook[Math.floor(Math.random() * availFromBook.length)];
                        const c = CONTACTS.find(con => con.id === id);
                        if (c) {
                            const buff = JSON.parse(JSON.stringify(c));
                            buff.usedBy = a.name;
                            a.buffs.push(buff);
                            addEmailToLog(a.name, "everyone@gov.org", "Looping in Support", `I'm looping in <strong>${c.name}</strong> to ensure this thread remains within professional guidelines.`, "bg-blue-50");
                        }
                    } else if (roll < 0.3 && a.hp < 20 && a.wins > 0) {
                        a.wins--; a.hp = Math.min(getUnitMaxHp(a), a.hp + 15);
                        addEmailToLog(a.name, "everyone@gov.org", "Self Promotion", formatMessageBody(a, `I'm logging a significant departmental achievement. This incident shouldn't distract from real wins.`), "opacity-70");
                    } else {
                        let d = getUnitTotalDmg(a);
                        
                        // Select attack type
                        const q = a.attacks[Math.floor(Math.random() * a.attacks.length)];
                        const body = formatMessageBody(a, q);
                        
                        if (target.id === 'player') {
                            if (state.player.buffs.find(b => b.eff.dodge && Math.random() < b.eff.dodge)) {
                                addEmailToLog(a.name, state.player.name, "Urgent Follow-up", body + `<br><br>(Thread ignored by <strong>Mittens</strong>. No standing lost.)`, "text-blue-600");
                            } else {
                                let def = getUnitTotalDef(state.player);
                                d = Math.floor(d * (1 - def)); state.player.hp -= d;
                                addEmailToLog(a.name, state.player.name, "Escalation", body + `<br><br><strong>Damage to Credibility: -${d}</strong>`, "bg-red-50 border-l-2 border-red-400");
                                document.getElementById('game-ui').classList.add('shaking');
                                setTimeout(() => document.getElementById('game-ui').classList.remove('shaking'), 200);
                            }
                        } else {
                            let targetDef = getUnitTotalDef(target);
                            d = Math.floor(d * (1 - targetDef));
                            target.hp -= d; 
                            addEmailToLog(a.name, target.name, "Internal Memo", body + `<br><br>(Targeting ${target.name}. Standing lost: ${d})`, "text-gray-500 text-[11px]");
                            if (target.hp <= 0) handleOpponentDefeat(target);
                        }
                    }

                    if (state.player.hp <= 0) {
                        state.gameOver = true;
                        updateUI();
                        setTimeout(showLoseScreen, 1500);
                    }
                }, idx * 700);
            });

            setTimeout(() => {
                if (!state.gameOver) {
                    state.isProcessing = false;
                    updateUI();
                }
            }, alive.length * 700);
        }

        function openAddressBook() {
            const list = document.getElementById('contact-list'); list.innerHTML = "";

            // CCs
            const headerCC = document.createElement('div');
            headerCC.className = "text-[10px] font-bold bg-gray-200 p-1 mb-1 uppercase";
            headerCC.innerText = "Address Book (Permanent CCs)";
            list.appendChild(headerCC);

            state.player.addressBook.forEach(id => {
                const c = CONTACTS.find(con => con.id === id);
                if (!c) return;
                const isUsed = state.player.buffs.some(b => b.id === c.id);
                const btn = document.createElement('div');
                btn.className = `p-2 border border-gray-300 flex flex-col ${isUsed ? 'opacity-40 grayscale bg-gray-100' : 'cursor-pointer hover:bg-blue-50'}`;
                btn.innerHTML = `<div class="flex justify-between font-bold text-[#000080] text-xs"><span>${c.name} - ${c.title}</span><span class="text-[9px]">${isUsed ? 'IN LOOP' : 'AVAIL'}</span></div><div class="text-[10px] italic">${c.bonus}</div>`;
                if (!isUsed) btn.onclick = () => {
                    const buff = JSON.parse(JSON.stringify(c));
                    buff.usedBy = state.player.name;
                    state.player.buffs.push(buff);
                    addEmailToLog(state.player.name, "everyone@gov.org", "Looping in Witness", `I'm looping in <strong>${c.name}</strong> (${c.title}) to help clarify the organizational impact of this thread.`, "bg-blue-100 font-bold border-l-4 border-blue-500");
                    closeAddressBook(); updateUI(); state.isProcessing = true; setTimeout(ffaRound, 400); 
                };
                list.appendChild(btn);
            });

            // BCCs
            if (state.player.bccContacts.length > 0) {
                const headerBCC = document.createElement('div');
                headerBCC.className = "text-[10px] font-bold bg-gray-200 p-1 mt-4 mb-1 uppercase";
                headerBCC.innerText = "Help Desk Contacts (BCC Consumables)";
                list.appendChild(headerBCC);

                state.player.bccContacts.forEach((b, idx) => {
                    const btn = document.createElement('div');
                    btn.className = `p-2 border border-gray-300 flex flex-col cursor-pointer hover:bg-yellow-50`;
                    btn.innerHTML = `<div class="flex justify-between font-bold text-yellow-800 text-xs"><span>${b.name}</span><span class="text-[9px]">BCC</span></div><div class="text-[10px] italic">${b.bonus}</div>`;
                    btn.onclick = () => {
                        useBcc(b, idx);
                    };
                    list.appendChild(btn);
                });
            }

            document.getElementById('address-book').classList.remove('hidden');
        }

        function useBcc(bcc, index) {
            state.player.bccContacts.splice(index, 1);
            addEmailToLog(state.player.name, "everyone@gov.org", `BCC: ${bcc.name}`, `[PRIVATE MESSAGE] Sent: ${bcc.bonus}`, "bg-yellow-100 border-l-4 border-yellow-600");

            if (bcc.effect === 'stun') {
                const target = opponents.find(o => o.id === state.targetId);
                target.isStunned = true;
                addEmailToLog("SYSTEM", state.player.name, "Message Recalled", `${target.name}'s next turn will be skipped.`, "italic text-gray-500 text-[10px]");
            } else if (bcc.effect === 'doubleDmg') {
                state.player.nextAttackMult = 2;
                addEmailToLog("SYSTEM", state.player.name, "Urgent Flag Set", `Your next attack will deal 2x damage.`, "italic text-gray-500 text-[10px]");
            } else if (bcc.effect === 'redirect') {
                const target = opponents.find(o => o.id === state.targetId);
                target.redirectNext = true;
                addEmailToLog("SYSTEM", state.player.name, "Message Redirected", `${target.name} will target someone else next turn.`, "italic text-gray-500 text-[10px]");
            }

            closeAddressBook();
            updateUI();
            state.isProcessing = true;
            setTimeout(ffaRound, 400);
        }

        function closeAddressBook() { document.getElementById('address-book').classList.add('hidden'); }
    </script>
</body>
</html>

